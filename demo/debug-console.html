<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>Debug Console - GeoLeaf</title>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #debug-console-wrapper {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 300px;
            background: #1e1e1e;
            color: #d4d4d4;
            border-top: 2px solid #007acc;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
        }

        #debug-console-header {
            background: #2d2d30;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #3e3e42;
        }

        #debug-console-search {
            flex: 1;
            padding: 4px 8px;
            background: #3c3c3c;
            border: 1px solid #555;
            color: #d4d4d4;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
        }

        #debug-console-search::placeholder {
            color: #858585;
        }

        #debug-console-count {
            color: #858585;
            font-size: 11px;
            white-space: nowrap;
            min-width: 80px;
        }

        #debug-console-clear {
            padding: 4px 12px;
            background: #0e639c;
            border: none;
            color: white;
            border-radius: 3px;
            cursor: pointer;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 11px;
            white-space: nowrap;
        }

        #debug-console-clear:hover {
            background: #1177bb;
        }

        #debug-console-close {
            padding: 4px 12px;
            background: #c42b1c;
            border: none;
            color: white;
            border-radius: 3px;
            cursor: pointer;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 11px;
            white-space: nowrap;
        }

        #debug-console-close:hover {
            background: #e81123;
        }

        #debug-console-logs {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .debug-log-entry {
            padding: 2px 0;
            border-bottom: 1px solid #2d2d30;
            word-wrap: break-word;
            font-size: 11px;
        }

        .debug-log-entry.hidden {
            display: none;
        }

        .debug-log-entry.log { color: #d4d4d4; }
        .debug-log-entry.info { color: #4fc1ff; }
        .debug-log-entry.warn { color: #cca700; }
        .debug-log-entry.error { color: #f48771; }

        .debug-log-highlight {
            background: yellow;
            color: black;
        }

        .debug-log-timestamp {
            color: #6a9955;
            margin-right: 8px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="debug-console-wrapper">
        <div id="debug-console-header">
            <input type="text" id="debug-console-search" placeholder="üîç Filtrer (ex: CACHE-BUST, loadProfile, error)..." />
            <span id="debug-console-count">0 logs</span>
            <button id="debug-console-clear">Effacer</button>
            <button id="debug-console-close">Fermer</button>
        </div>
        <div id="debug-console-logs"></div>
    </div>

    <script>
    (function() {
        // R√©f√©rence au contexte global (parent ou self)
        const targetWindow = window.parent !== window ? window.parent : window;

        // Initialiser DebugConsole si absent
        if (!targetWindow.DebugConsole) {
            targetWindow.DebugConsole = {
                logs: [],
                maxLogs: 10000
            };
        }

        // ============ INTERCEPTER LES LOGS CONSOLE NATIFS ============
        const originalLog = console.log;
        const originalInfo = console.info;
        const originalWarn = console.warn;
        const originalError = console.error;

        function formatTimestamp() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const ms = String(now.getMilliseconds()).padStart(3, '0');
            return `${hours}:${minutes}:${seconds}.${ms}`;
        }

        function captureLog(type, args) {
            const message = Array.from(args).map(arg => {
                if (typeof arg === 'object') {
                    try {
                        return JSON.stringify(arg, null, 2);
                    } catch (e) {
                        return String(arg);
                    }
                }
                return String(arg);
            }).join(' ');

            const timestamp = formatTimestamp();
            const logEntry = {
                type,
                message,
                timestamp,
                time: Date.now()
            };

            targetWindow.DebugConsole.logs.push(logEntry);
            if (targetWindow.DebugConsole.logs.length > targetWindow.DebugConsole.maxLogs) {
                targetWindow.DebugConsole.logs.shift();
            }
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            captureLog('log', args);
        };

        console.info = function(...args) {
            originalInfo.apply(console, args);
            captureLog('info', args);
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            captureLog('warn', args);
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            captureLog('error', args);
        };

        originalInfo.call(console, '[Debug Console] Initialisation - Interception activ√©e');

        // ============ INTERFACE ET RENDU ============
        const logsContainer = document.getElementById('debug-console-logs');
        const searchInput = document.getElementById('debug-console-search');
        const countSpan = document.getElementById('debug-console-count');
        const clearBtn = document.getElementById('debug-console-clear');
        const closeBtn = document.getElementById('debug-console-close');

        if (!logsContainer) {
            originalError.call(console, '[Debug Console] √âl√©ment debug-console-logs introuvable!');
            return;
        }

        originalInfo.call(console, '[Debug Console] UI initialis√©e avec succ√®s');

        let lastLogCount = 0;
        let currentSearchTerm = '';

        function applySearch() {
            const entries = logsContainer.querySelectorAll('.debug-log-entry');
            const searchTerm = currentSearchTerm.toLowerCase();

            let visibleCount = 0;
            entries.forEach(entry => {
                const text = entry.dataset.originalText.toLowerCase();
                if (searchTerm === '' || text.includes(searchTerm)) {
                    entry.classList.remove('hidden');
                    visibleCount++;
                    // Highlight
                    if (searchTerm !== '') {
                        const originalText = entry.dataset.originalText;
                        const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                        entry.innerHTML = originalText.replace(regex, '<span class="debug-log-highlight">$1</span>');
                    } else {
                        entry.innerHTML = entry.dataset.originalText;
                    }
                } else {
                    entry.classList.add('hidden');
                }
            });

            countSpan.textContent = `${visibleCount}/${targetWindow.DebugConsole.logs.length} logs`;
        }

        function renderLogs() {
            // Ne rafra√Æchir que si de nouveaux logs sont arriv√©s
            if (targetWindow.DebugConsole.logs.length === lastLogCount) {
                return;
            }

            lastLogCount = targetWindow.DebugConsole.logs.length;
            logsContainer.innerHTML = '';

            targetWindow.DebugConsole.logs.forEach(log => {
                const entry = document.createElement('div');
                entry.className = `debug-log-entry ${log.type}`;

                // Format avec horodatage
                const timestampSpan = document.createElement('span');
                timestampSpan.className = 'debug-log-timestamp';
                timestampSpan.textContent = log.timestamp;

                entry.appendChild(timestampSpan);
                entry.innerHTML += `[${log.type.toUpperCase()}] ${log.message}`;

                // Sauvegarder le texte complet pour la recherche
                const fullText = `${log.timestamp} [${log.type.toUpperCase()}] ${log.message}`;
                entry.dataset.originalText = fullText;

                logsContainer.appendChild(entry);
            });

            // R√©appliquer la recherche apr√®s avoir ajout√© les nouveaux logs
            applySearch();
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        // Rafra√Æchir l'affichage toutes les 500ms pour capturer les nouveaux logs
        setInterval(renderLogs, 500);

        // Recherche en temps r√©el
        searchInput.addEventListener('input', function(e) {
            currentSearchTerm = e.target.value;
            applySearch();
        });

        // Effacer tous les logs
        clearBtn.addEventListener('click', function() {
            targetWindow.DebugConsole.logs = [];
            lastLogCount = 0;
            logsContainer.innerHTML = '';
            countSpan.textContent = '0 logs';
            originalInfo.call(console, '[Debug Console] Logs effac√©s');
        });

        // Fermer la console
        closeBtn.addEventListener('click', function() {
            document.getElementById('debug-console-wrapper').style.display = 'none';
            originalInfo.call(console, '[Debug Console] Ferm√©e');
        });

        // Affichage initial
        setTimeout(renderLogs, 100);
    })();
    </script>
</body>
</html>
