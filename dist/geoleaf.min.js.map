{"version":3,"file":"geoleaf.min.js","sources":["../src/static/js/geoleaf.log.js","../src/static/js/geoleaf.log.config.js","../src/static/js/geoleaf.security.js","../src/static/js/geoleaf.constants.js","../src/static/js/geoleaf.utils.js","../src/static/js/utils/dom-security.js","../src/static/js/utils/dom-helpers.js","../src/static/js/utils/event-listener-manager.js","../src/static/js/utils/timer-manager.js","../src/static/js/utils/scale-utils.js","../src/static/js/helpers/style-resolver.js","../src/static/js/validators/style-validator-rules.js","../src/static/js/validators/style-validator.js","../src/static/js/geoleaf.core.js","../src/static/js/ui/theme.js","../src/static/js/ui/controls.js","../src/static/js/ui/panel-builder.js","../src/static/js/ui/dom-utils.js","../src/static/js/ui/coordinates-display.js","../src/static/js/ui/branding.js","../src/static/js/ui/content-builder/core.js","../src/static/js/ui/content-builder/templates.js","../src/static/js/ui/content-builder/assemblers.js","../src/static/js/ui/content-builder.js","../src/static/js/ui/components.js","../src/static/js/ui/notifications.js","../src/static/js/ui/event-delegation.js","../src/static/js/ui/filter-state-manager.js","../src/static/js/map/scale-control.js","../src/static/js/ui/filter-control-builder.js","../src/static/js/ui/filter-panel/shared.js","../src/static/js/ui/filter-panel/state-reader.js","../src/static/js/ui/filter-panel/lazy-loader.js","../src/static/js/ui/filter-panel/applier.js","../src/static/js/ui/filter-panel/renderer.js","../src/static/js/ui/filter-panel/proximity.js","../src/static/js/ui/filter-panel/core.js","../src/static/js/ui/filter-panel.js","../src/static/js/geoleaf.ui.js","../src/static/js/data/normalizer.js","../src/static/js/loaders/style-loader.js","../src/static/js/config/loader.js","../src/static/js/config/storage.js","../src/static/js/config/normalization.js","../src/static/js/config/taxonomy.js","../src/static/js/config/profile-v3-loader.js","../src/static/js/config/profile.js","../src/static/js/config/data-converter.js","../src/static/js/config/geoleaf-config/config-core.js","../src/static/js/config/geoleaf-config/config-validation.js","../src/static/js/config/geoleaf-config/config-loaders.js","../src/static/js/config/geoleaf-config/config-accessors.js","../src/static/js/geoleaf.baselayers.js","../src/static/js/geoleaf.filters.js","../src/static/js/poi/shared.js","../src/static/js/poi/normalizers.js","../src/static/js/poi/popup.js","../src/static/js/poi/markers.js","../src/static/js/renderers/abstract-renderer.js","../src/static/js/poi/renderers/field-renderers.js","../src/static/js/poi/renderers/media-renderers.js","../src/static/js/poi/renderers/lightbox-manager.js","../src/static/js/poi/renderers/ui-behaviors.js","../src/static/js/poi/renderers/component-renderers.js","../src/static/js/poi/renderers/section-orchestrator.js","../src/static/js/poi/renderers/links.js","../src/static/js/poi/renderers/core.js","../src/static/js/poi/renderers.js","../src/static/js/poi/sidepanel.js","../src/static/js/poi/core.js","../src/static/js/geoleaf.poi.js","../src/static/js/geojson/shared.js","../src/static/js/geojson/style-resolver.js","../src/static/js/geojson/visibility-manager.js","../src/static/js/geojson/layer-manager/store.js","../src/static/js/geojson/layer-manager/visibility.js","../src/static/js/geojson/layer-manager/style.js","../src/static/js/geojson/layer-manager/integration.js","../src/static/js/geojson/popup-tooltip.js","../src/static/js/geojson/clustering.js","../src/static/js/geojson/layer-config-manager.js","../src/static/js/geojson/feature-validator.js","../src/static/js/geojson/loader/config-helpers.js","../src/static/js/geojson/loader/data.js","../src/static/js/geojson/loader/single-layer.js","../src/static/js/geojson/loader/profile.js","../src/static/js/geojson/core.js","../src/static/js/route/style-resolver.js","../src/static/js/route/popup-builder.js","../src/static/js/route/loaders.js","../src/static/js/route/layer-manager.js","../src/static/js/geoleaf.route.js","../src/static/js/layer-manager/shared.js","../src/static/js/layer-manager/renderer.js","../src/static/js/layer-manager/cache-section.js","../src/static/js/layer-manager/basemap-selector.js","../src/static/js/layer-manager/style-selector.js","../src/static/js/layer-manager/control.js","../src/static/js/geoleaf.layer-manager.js","../src/static/js/legend/legend-generator.js","../src/static/js/legend/legend-renderer.js","../src/static/js/legend/legend-control.js","../src/static/js/geoleaf.legend.js","../src/static/js/labels/label-renderer.js","../src/static/js/labels/label-button-manager.js","../src/static/js/labels/labels.js","../src/static/js/themes/theme-loader.js","../src/static/js/themes/theme-applier/core.js","../src/static/js/themes/theme-applier/visibility.js","../src/static/js/themes/theme-applier/deferred.js","../src/static/js/themes/theme-applier/ui-sync.js","../src/static/js/themes/theme-selector.js","../src/static/js/table/panel.js","../src/static/js/table/renderer.js","../src/static/js/geoleaf.table.js","../src/static/js/api/module-manager.js","../src/static/js/api/initialization-manager.js","../src/static/js/api/namespace-manager.js","../src/static/js/api/factory-manager.js","../src/static/js/api/controller.js","../src/static/js/geoleaf.api.js","../src/app/helpers.js","../src/app/init.js","../src/app/boot.js","../src/bundle-entry.js"],"sourcesContent":["/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    /**\r\n     * GeoLeaf.Log ‚Äî gestion centralis√©e des logs\r\n     *\r\n     * Objectif :\r\n     * - remplacer tous les console.log/console.warn/... du projet\r\n     * - fournir un niveau de verbosit√© configurable via la config JSON\r\n     * - s‚Äôassurer que chaque message poss√®de un pr√©fixe normalis√© [GeoLeaf.X]\r\n     */\r\n\r\n    if (!global.GeoLeaf) global.GeoLeaf = {};\r\n\r\n    const LEVELS = {\r\n        DEBUG: 0,\r\n        INFO: 1,\r\n        WARN: 2,\r\n        ERROR: 3\r\n    };\r\n\r\n    let currentLevel = LEVELS.INFO; // niveau par d√©faut\r\n    let quietMode = false; // mode silencieux pour les logs r√©p√©titifs\r\n    let suppressedMessages = new Set(); // pour √©viter les r√©p√©titions\r\n    let groupedMessageCounts = new Map(); // pour grouper les messages similaires\r\n\r\n    const formatPrefix = (type) => `[GeoLeaf.${type}]`;\r\n\r\n    // D√©tecte si un message est r√©p√©titif ou informatif non critique\r\n    const isRepetitiveMessage = (message) => {\r\n        const patterns = [\r\n            /Chargement du sprite SVG/,\r\n            /Sprite SVG d√©tect√©/,\r\n            /IconsConfig r√©cup√©r√©/,\r\n            /Module.*charg√©/,\r\n            /Module.*initialis√©/,\r\n            /Contr√¥le.*ajout√©/,\r\n            /Bouton.*ajout√©/,\r\n            /Panneau.*cr√©√©/,\r\n            /Section.*remplie/,\r\n            /Profil.*charg√©/,\r\n            /Couche.*charg√©e/,\r\n            /Style.*appliqu√©/,\r\n            /ThemeApplier/,\r\n            /LayerManager/,\r\n            /Storage/,\r\n            /CacheButton/,\r\n            /Renderers\\./,\r\n            /FormRenderer/,\r\n            /ResourceEnumerator/,\r\n            /LayerSelector/,\r\n            /CacheControl/,\r\n            /POI.*DEBUG/,\r\n            /AddForm/\r\n        ];\r\n        return patterns.some(pattern => pattern.test(message));\r\n    };\r\n\r\n    // Messages critiques qui doivent toujours √™tre affich√©s\r\n    const isCriticalMessage = (message) => {\r\n        const criticalPatterns = [\r\n            /ERROR/,\r\n            /WARN/,\r\n            /Failed/,\r\n            /Error/,\r\n            /Exception/,\r\n            /Carte initialis√©e avec succ√®s/,\r\n            /All.*modules loaded/,\r\n            /Mode.*activ√©/\r\n        ];\r\n        return criticalPatterns.some(pattern => pattern.test(message));\r\n    };\r\n\r\n    // G√®re les messages group√©s\r\n    const handleGroupedMessage = (message, args) => {\r\n        const key = message.replace(/\\d+/g, 'X').replace(/[{}:,]/g, ''); // normalise\r\n        const count = (groupedMessageCounts.get(key) || 0) + 1;\r\n        groupedMessageCounts.set(key, count);\r\n\r\n        if (count === 1) {\r\n            return true; // affiche le premier\r\n        } else if (count === 3 && !isCriticalMessage(message)) {\r\n            console.info(`${formatPrefix('INFO')} [Group√©] Message r√©p√©t√© - suite masqu√©e: ${message.substring(0, 60)}...`);\r\n            return false;\r\n        } else if (count > 3) {\r\n            return false; // supprime apr√®s 3 occurrences pour les non-critiques\r\n        }\r\n        return count <= 2; // affiche max 2 fois les messages non critiques\r\n    };\r\n\r\n    const Log = {\r\n        /**\r\n         * D√©finir le niveau de logs global\r\n         * @param {string} level  \"debug\" | \"info\" | \"warn\" | \"error\"\r\n         */\r\n        setLevel(level) {\r\n            const lvl = String(level).toLowerCase();\r\n            switch (lvl) {\r\n                case \"debug\":\r\n                    currentLevel = LEVELS.DEBUG;\r\n                    break;\r\n                case \"info\":\r\n                    currentLevel = LEVELS.INFO;\r\n                    break;\r\n                case \"warn\":\r\n                    currentLevel = LEVELS.WARN;\r\n                    break;\r\n                case \"error\":\r\n                    currentLevel = LEVELS.ERROR;\r\n                    break;\r\n                case \"production\":\r\n                    currentLevel = LEVELS.WARN; // En production, seulement WARN et ERROR\r\n                    quietMode = true;\r\n                    break;\r\n                default:\r\n                    console.warn(`${formatPrefix(\"WARN\")} Niveau de log inconnu :`, level);\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Active/d√©sactive le mode silencieux pour les messages r√©p√©titifs\r\n         */\r\n        setQuietMode(enabled) {\r\n            if (quietMode === enabled) return; // √©viter les r√©p√©titions\r\n            quietMode = enabled;\r\n            if (enabled) {\r\n                console.info(`${formatPrefix(\"INFO\")} Mode silencieux activ√© - logs r√©p√©titifs r√©duits`);\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Affiche un r√©sum√© des messages group√©s\r\n         */\r\n        showSummary() {\r\n            if (groupedMessageCounts.size > 0) {\r\n                console.group(`${formatPrefix(\"INFO\")} R√©sum√© des logs group√©s:`);\r\n                for (const [message, count] of groupedMessageCounts) {\r\n                    if (count > 3) {\r\n                        console.info(`‚Ä¢ ${count}x: ${message.substring(0, 60)}...`);\r\n                    }\r\n                }\r\n                console.groupEnd();\r\n            }\r\n        },\r\n\r\n        debug(...args) {\r\n            if (currentLevel <= LEVELS.DEBUG) {\r\n                const message = args.join(' ');\r\n                if (quietMode && isRepetitiveMessage(message)) {\r\n                    if (!handleGroupedMessage(message, args)) return;\r\n                }\r\n                console.debug(formatPrefix(\"DEBUG\"), ...args);\r\n            }\r\n        },\r\n\r\n        info(...args) {\r\n            if (currentLevel <= LEVELS.INFO) {\r\n                const message = args.join(' ');\r\n\r\n                // En mode silencieux, filtrer plus agressivement\r\n                if (quietMode) {\r\n                    // Toujours afficher les messages critiques\r\n                    if (isCriticalMessage(message)) {\r\n                        console.info(formatPrefix(\"INFO\"), ...args);\r\n                        return;\r\n                    }\r\n\r\n                    // Grouper/masquer les messages r√©p√©titifs\r\n                    if (isRepetitiveMessage(message)) {\r\n                        if (!handleGroupedMessage(message, args)) return;\r\n                    }\r\n                }\r\n\r\n                console.info(formatPrefix(\"INFO\"), ...args);\r\n            }\r\n        },\r\n\r\n        warn(...args) {\r\n            if (currentLevel <= LEVELS.WARN) {\r\n                console.warn(formatPrefix(\"WARN\"), ...args);\r\n            }\r\n        },\r\n\r\n        error(...args) {\r\n            if (currentLevel <= LEVELS.ERROR) {\r\n                console.error(formatPrefix(\"ERROR\"), ...args);\r\n            }\r\n        }\r\n    };\r\n\r\n    global.GeoLeaf.Log = Log;\r\n\r\n})(typeof globalThis !== \"undefined\" ? globalThis : window);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n/**\r\n * Configuration globale des logs pour GeoLeaf\r\n * Applique automatiquement les bonnes configurations de log selon l'environnement\r\n */\r\n\r\n(function() {\r\n    \"use strict\";\r\n\r\n    // Attendre que GeoLeaf.Log soit charg√©\r\n    function configureLogging() {\r\n        if (!window.GeoLeaf || !window.GeoLeaf.Log) {\r\n            setTimeout(configureLogging, 50);\r\n            return;\r\n        }\r\n\r\n        const Log = window.GeoLeaf.Log;\r\n\r\n        // D√©tecter l'environnement\r\n        const isProduction = location.hostname !== 'localhost' && !location.hostname.includes('127.0.0.1') && !location.search.includes('debug=true');\r\n        const isDebug = location.search.includes('debug=true') || location.search.includes('verbose=true');\r\n\r\n        if (isProduction) {\r\n            // Production: seulement warnings et erreurs + mode silencieux\r\n            Log.setLevel('production');\r\n            if (window.GeoLeaf && GeoLeaf.Log && GeoLeaf.Log.info) { GeoLeaf.Log.info(\"üîß [GeoLeaf] Mode production activ√© - logs r√©duits\"); }\r\n        } else if (isDebug) {\r\n            // Debug explicite: tous les logs\r\n            Log.setLevel('debug');\r\n            Log.setQuietMode(false);\r\n            if (window.GeoLeaf && GeoLeaf.Log && GeoLeaf.Log.info) { GeoLeaf.Log.info(\"üîß [GeoLeaf] Mode debug activ√© - tous les logs visibles\"); }\r\n        } else {\r\n            // D√©veloppement: logs informatifs avec mode silencieux pour r√©duire les r√©p√©titions\r\n            Log.setLevel('info');\r\n            Log.setQuietMode(true);\r\n            if (window.GeoLeaf && GeoLeaf.Log && GeoLeaf.Log.info) { GeoLeaf.Log.info(\"üîß [GeoLeaf] Mode d√©veloppement - logs optimis√©s\"); }\r\n        }\r\n\r\n        // Afficher un r√©sum√© apr√®s chargement complet\r\n        setTimeout(() => {\r\n            if (Log.showSummary) {\r\n                Log.showSummary();\r\n            }\r\n\r\n            // Afficher un r√©sum√© de d√©marrage concis\r\n            const endTime = performance.now();\r\n            if (window.GeoLeaf && GeoLeaf.Log && GeoLeaf.Log.info) {\r\n                GeoLeaf.Log.info(\"üéØ [GeoLeaf] D√©marrage termin√©:\", {\r\n                    \"‚è±Ô∏è Temps total\": Math.round(endTime) + \"ms\",\r\n                    \"üì¶ Modules\": \"122 charg√©s\",\r\n                    \"üîá Logs\": isProduction ? \"mode production\" : (isDebug ? \"mode debug\" : \"mode optimis√©\"),\r\n                    \"üí° Conseil\": isDebug ? \"\" : \"Ajoutez ?debug=true pour les logs d√©taill√©s\"\r\n                });\r\n            }\r\n        }, 3000);\r\n    }\r\n\r\n    // D√©marrer la configuration d√®s que possible\r\n    if (document.readyState === 'loading') {\r\n        document.addEventListener('DOMContentLoaded', configureLogging);\r\n    } else {\r\n        configureLogging();\r\n    }\r\n})();\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n/**\r\n * @fileoverview Module de s√©curit√© GeoLeaf\r\n * G√®re l'√©chappement HTML, validation URLs, sanitization\r\n *\r\n * @module GeoLeaf.Security\r\n * @version 2.0.0\r\n * @author GeoLeaf Project\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n\r\n    // Logger (d√©fini par geoleaf.logger-shim.js charg√© en premier)\r\n    const Log = GeoLeaf.Log;\r\n\r\n    /**\r\n     * Module Security - Fonctions de s√©curit√© centralis√©es\r\n     * @namespace\r\n     */\r\n    const Security = {\r\n        /**\r\n         * √âchappe les caract√®res HTML dangereux pour pr√©venir XSS\r\n         * @param {string} str - Cha√Æne √† √©chapper\r\n         * @returns {string} Cha√Æne √©chapp√©e\r\n         * @example\r\n         * Security.escapeHtml('<script>alert(1)</script>')\r\n         * // Returns: '&lt;script&gt;alert(1)&lt;/script&gt;'\r\n         */\r\n        escapeHtml(str) {\r\n            if (str === null || str === undefined) {\r\n                return \"\";\r\n            }\r\n\r\n            if (typeof str !== \"string\") {\r\n                str = String(str);\r\n            }\r\n\r\n            const div = document.createElement(\"div\");\r\n            div.textContent = str;\r\n            // SAFE: innerHTML here gets the escaped version of textContent\r\n            return div.innerHTML;\r\n        },\r\n\r\n        /**\r\n         * √âchappe les attributs HTML pour utilisation dans des attributs\r\n         * @param {string} str - Cha√Æne √† √©chapper\r\n         * @returns {string} Cha√Æne √©chapp√©e\r\n         * @example\r\n         * Security.escapeAttribute('value\"onclick=\"alert(1)')\r\n         * // Returns: 'value&quot;onclick=&quot;alert(1)'\r\n         */\r\n        escapeAttribute(str) {\r\n            if (str === null || str === undefined) {\r\n                return \"\";\r\n            }\r\n\r\n            if (typeof str !== \"string\") {\r\n                str = String(str);\r\n            }\r\n\r\n            return str\r\n                .replace(/&/g, \"&amp;\")\r\n                .replace(/'/g, \"&#39;\")\r\n                .replace(/\"/g, \"&quot;\")\r\n                .replace(/</g, \"&lt;\")\r\n                .replace(/>/g, \"&gt;\");\r\n        },\r\n\r\n        /**\r\n         * Valide une URL strictement avec whitelist de protocoles\r\n         * @param {string} url - URL √† valider\r\n         * @param {string} [baseUrl] - URL de base pour r√©solution relative\r\n         * @returns {string} URL valid√©e\r\n         * @throws {Error} Si URL invalide ou protocole non autoris√©\r\n         * @example\r\n         * Security.validateUrl('https://example.com/data.json')\r\n         * // Returns: 'https://example.com/data.json'\r\n         *\r\n         * Security.validateUrl('javascript:alert(1)')\r\n         * // Throws: Error\r\n         */\r\n        validateUrl(url, baseUrl) {\r\n            if (!url || typeof url !== \"string\") {\r\n                throw new TypeError(\"URL must be a non-empty string\");\r\n            }\r\n\r\n            // Normaliser l'URL\r\n            url = url.trim();\r\n\r\n            const base = baseUrl || global.location.origin;\r\n\r\n            try {\r\n                const parsed = new URL(url, base);\r\n\r\n                // Whitelist de protocoles autoris√©s\r\n                const ALLOWED_PROTOCOLS = [\"http:\", \"https:\", \"data:\"];\r\n\r\n                if (!ALLOWED_PROTOCOLS.includes(parsed.protocol)) {\r\n                    throw new Error(\r\n                        `Protocol \"${parsed.protocol}\" not allowed. ` +\r\n                            `Allowed protocols: ${ALLOWED_PROTOCOLS.join(\", \")}`\r\n                    );\r\n                }\r\n\r\n                // Validation suppl√©mentaire pour data: URLs\r\n                if (parsed.protocol === \"data:\") {\r\n                    // Autoriser uniquement les images\r\n                    const allowedDataTypes = [\r\n                        \"image/png\",\r\n                        \"image/jpeg\",\r\n                        \"image/jpg\",\r\n                        \"image/gif\",\r\n                        \"image/svg+xml\",\r\n                        \"image/webp\",\r\n                    ];\r\n\r\n                    const dataPrefix = url.split(\",\")[0];\r\n                    const mimeMatch = dataPrefix.match(/data:([^;,]+)/);\r\n\r\n                    if (!mimeMatch) {\r\n                        throw new Error(\"Invalid data URL format\");\r\n                    }\r\n\r\n                    const mimeType = mimeMatch[1];\r\n\r\n                    if (!allowedDataTypes.includes(mimeType)) {\r\n                        throw new Error(\r\n                            `Data URL type \"${mimeType}\" not allowed. ` +\r\n                                `Allowed: ${allowedDataTypes.join(\", \")}`\r\n                        );\r\n                    }\r\n                }\r\n\r\n                return parsed.href;\r\n            } catch (e) {\r\n                if (e.message.includes(\"not allowed\")) {\r\n                    throw e;\r\n                }\r\n                throw new Error(`Invalid URL \"${url}\": ${e.message}`);\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Valide des coordonn√©es g√©ographiques\r\n         * @param {number} lat - Latitude\r\n         * @param {number} lng - Longitude\r\n         * @returns {[number, number]} Coordonn√©es valid√©es [lat, lng]\r\n         * @throws {TypeError} Si les coordonn√©es ne sont pas des nombres\r\n         * @throws {RangeError} Si les coordonn√©es sont hors limites\r\n         * @example\r\n         * Security.validateCoordinates(45.5, -73.6)\r\n         * // Returns: [45.5, -73.6]\r\n         *\r\n         * Security.validateCoordinates(999, 0)\r\n         * // Throws: RangeError\r\n         */\r\n        validateCoordinates(lat, lng) {\r\n            if (typeof lat !== \"number\" || typeof lng !== \"number\") {\r\n                throw new TypeError(\r\n                    `Coordinates must be numbers, got lat=${typeof lat}, lng=${typeof lng}`\r\n                );\r\n            }\r\n\r\n            if (!Number.isFinite(lat) || !Number.isFinite(lng)) {\r\n                throw new RangeError(\"Coordinates must be finite numbers (not NaN or Infinity)\");\r\n            }\r\n\r\n            if (lat < -90 || lat > 90) {\r\n                throw new RangeError(`Latitude must be between -90 and 90, got ${lat}`);\r\n            }\r\n\r\n            if (lng < -180 || lng > 180) {\r\n                throw new RangeError(`Longitude must be between -180 and 180, got ${lng}`);\r\n            }\r\n\r\n            return [lat, lng];\r\n        },\r\n\r\n        /**\r\n         * Sanitize un objet de propri√©t√©s POI\r\n         * √âchappe les champs texte et valide les URLs\r\n         * @param {Object} props - Propri√©t√©s √† sanitizer\r\n         * @returns {Object} Propri√©t√©s sanitiz√©es\r\n         * @example\r\n         * Security.sanitizePoiProperties({\r\n         *   label: '<script>alert(1)</script>',\r\n         *   url: 'https://example.com'\r\n         * })\r\n         * // Returns: { label: '&lt;script&gt;...', url: 'https://example.com' }\r\n         */\r\n        sanitizePoiProperties(props) {\r\n            if (!props || typeof props !== \"object\") {\r\n                return {};\r\n            }\r\n\r\n            const sanitized = {};\r\n\r\n            // Champs texte √† √©chapper\r\n            const textFields = [\r\n                \"label\",\r\n                \"name\",\r\n                \"title\",\r\n                \"description\",\r\n                \"desc\",\r\n                \"address\",\r\n                \"phone\",\r\n                \"email\",\r\n                \"category\",\r\n                \"type\",\r\n            ];\r\n\r\n            // Champs URL √† valider\r\n            const urlFields = [\"url\", \"website\", \"image\", \"photo\", \"icon\"];\r\n\r\n            for (const [key, value] of Object.entries(props)) {\r\n                // Ignorer les fonctions et symboles\r\n                if (typeof value === \"function\" || typeof value === \"symbol\") {\r\n                    continue;\r\n                }\r\n\r\n                // Null/undefined = cha√Æne vide\r\n                if (value === null || value === undefined) {\r\n                    sanitized[key] = \"\";\r\n                    continue;\r\n                }\r\n\r\n                // √âchapper les champs texte\r\n                if (textFields.includes(key) && typeof value === \"string\") {\r\n                    sanitized[key] = this.escapeHtml(value);\r\n                }\r\n                // Valider les URLs\r\n                else if (urlFields.includes(key) && typeof value === \"string\") {\r\n                    try {\r\n                        sanitized[key] = this.validateUrl(value);\r\n                    } catch (e) {\r\n                        Log.warn(`[Security] Invalid URL for ${key}: ${e.message}`);\r\n                        sanitized[key] = \"\";\r\n                    }\r\n                }\r\n                // Tableaux : sanitizer r√©cursivement\r\n                else if (Array.isArray(value)) {\r\n                    sanitized[key] = value.map((item) => {\r\n                        if (typeof item === \"object\" && item !== null) {\r\n                            return this.sanitizePoiProperties(item);\r\n                        }\r\n                        if (typeof item === \"string\") {\r\n                            return this.escapeHtml(item);\r\n                        }\r\n                        return item;\r\n                    });\r\n                }\r\n                // Objets : sanitizer r√©cursivement\r\n                else if (typeof value === \"object\" && value !== null) {\r\n                    sanitized[key] = this.sanitizePoiProperties(value);\r\n                }\r\n                // Autres types : conserver tel quel\r\n                else {\r\n                    sanitized[key] = value;\r\n                }\r\n            }\r\n\r\n            return sanitized;\r\n        },\r\n\r\n        /**\r\n         * V√©rifie si une cha√Æne contient du HTML potentiellement dangereux\r\n         * @param {string} str - Cha√Æne √† v√©rifier\r\n         * @returns {boolean} True si contient du HTML dangereux\r\n         * @example\r\n         * Security.containsDangerousHtml('<script>alert(1)</script>')\r\n         * // Returns: true\r\n         */\r\n        containsDangerousHtml(str) {\r\n            if (typeof str !== \"string\") {\r\n                return false;\r\n            }\r\n\r\n            const dangerousPatterns = [\r\n                /<script/i,\r\n                /javascript:/i,\r\n                /on\\w+\\s*=/i, // onclick=, onerror=, etc.\r\n                /<iframe/i,\r\n                /<object/i,\r\n                /<embed/i,\r\n                /<applet/i,\r\n                /<meta/i,\r\n                /<link/i,\r\n                /vbscript:/i,\r\n                /data:text\\/html/i,\r\n            ];\r\n\r\n            return dangerousPatterns.some((pattern) => pattern.test(str));\r\n        },\r\n\r\n        /**\r\n         * Nettoie une cha√Æne de tout HTML (garde uniquement le texte)\r\n         * @param {string} html - HTML √† nettoyer\r\n         * @returns {string} Texte uniquement\r\n         * @example\r\n         * Security.stripHtml('<p>Hello <b>World</b></p>')\r\n         * // Returns: 'Hello World'\r\n         */\r\n        stripHtml(html) {\r\n            if (typeof html !== \"string\") {\r\n                return \"\";\r\n            }\r\n\r\n            // SAFE: Utilisation de DOMParser au lieu de innerHTML pour √©viter l'ex√©cution de scripts\r\n            const parser = new DOMParser();\r\n            const doc = parser.parseFromString(html, 'text/html');\r\n            return doc.body.textContent || doc.body.innerText || \"\";\r\n        },\r\n\r\n        /**\r\n         * Cr√©e un √©l√©ment DOM de mani√®re s√©curis√©e en √©chappant automatiquement le contenu\r\n         * @param {string} tagName - Nom de la balise HTML\r\n         * @param {Object} options - Options de configuration\r\n         * @param {string} [options.className] - Classes CSS\r\n         * @param {string} [options.id] - ID de l'√©l√©ment\r\n         * @param {string} [options.textContent] - Contenu texte (√©chapp√© automatiquement)\r\n         * @param {Object} [options.attributes] - Attributs HTML\r\n         * @param {Array<Element>} [options.children] - √âl√©ments enfants\r\n         * @returns {Element} √âl√©ment DOM cr√©√©\r\n         * @example\r\n         * Security.createSafeElement('div', {\r\n         *     className: 'my-class',\r\n         *     textContent: '<script>alert(1)</script>', // Automatiquement √©chapp√©\r\n         *     children: [otherElement]\r\n         * })\r\n         */\r\n        createSafeElement(tagName, options = {}) {\r\n            const element = document.createElement(tagName);\r\n\r\n            if (options.className) {\r\n                element.className = options.className;\r\n            }\r\n\r\n            if (options.id) {\r\n                element.id = options.id;\r\n            }\r\n\r\n            if (options.textContent) {\r\n                // SAFE: textContent √©chappe automatiquement le HTML\r\n                element.textContent = options.textContent;\r\n            }\r\n\r\n            if (options.attributes) {\r\n                Object.keys(options.attributes).forEach(key => {\r\n                    element.setAttribute(key, this.escapeAttribute(options.attributes[key]));\r\n                });\r\n            }\r\n\r\n            if (options.children && Array.isArray(options.children)) {\r\n                options.children.forEach(child => {\r\n                    if (child instanceof Element) {\r\n                        element.appendChild(child);\r\n                    }\r\n                });\r\n            }\r\n\r\n            return element;\r\n        },\r\n\r\n        /**\r\n         * Parse et valide un contenu SVG de mani√®re s√©curis√©e\r\n         * Utilise DOMParser au lieu de innerHTML pour √©viter l'ex√©cution de scripts\r\n         * @param {string} svgContent - Contenu SVG brut\r\n         * @returns {SVGElement|null} √âl√©ment SVG valid√© ou null si invalide\r\n         * @example\r\n         * Security.sanitizeSvgContent('<svg>...</svg>')\r\n         * // Returns: SVGElement or null\r\n         */\r\n        sanitizeSvgContent(svgContent) {\r\n            if (!svgContent || typeof svgContent !== \"string\") {\r\n                return null;\r\n            }\r\n\r\n            try {\r\n                const parser = new DOMParser();\r\n                const doc = parser.parseFromString(svgContent, \"image/svg+xml\");\r\n\r\n                // V√©rifier les erreurs de parsing\r\n                const parserError = doc.querySelector(\"parsererror\");\r\n                if (parserError) {\r\n                    Log.warn(\"[Security] Erreur parsing SVG:\", parserError.textContent);\r\n                    return null;\r\n                }\r\n\r\n                const svgEl = doc.documentElement;\r\n                if (!svgEl || svgEl.tagName.toLowerCase() !== \"svg\") {\r\n                    Log.warn(\"[Security] Contenu SVG invalide: √©l√©ment racine n'est pas SVG\");\r\n                    return null;\r\n                }\r\n\r\n                // Supprimer les √©l√©ments potentiellement dangereux\r\n                const dangerousElements = [\"script\", \"foreignObject\", \"use[href^='data:']\"];\r\n                dangerousElements.forEach(selector => {\r\n                    const elements = svgEl.querySelectorAll(selector);\r\n                    elements.forEach(el => el.remove());\r\n                });\r\n\r\n                // Supprimer les attributs event handlers (onclick, onerror, etc.)\r\n                const allElements = svgEl.querySelectorAll(\"*\");\r\n                allElements.forEach(el => {\r\n                    Array.from(el.attributes).forEach(attr => {\r\n                        if (attr.name.toLowerCase().startsWith(\"on\")) {\r\n                            el.removeAttribute(attr.name);\r\n                        }\r\n                        // Supprimer les href javascript:\r\n                        if ((attr.name === \"href\" || attr.name === \"xlink:href\") &&\r\n                            attr.value.toLowerCase().trim().startsWith(\"javascript:\")) {\r\n                            el.removeAttribute(attr.name);\r\n                        }\r\n                    });\r\n                });\r\n\r\n                return svgEl;\r\n            } catch (e) {\r\n                Log.warn(\"[Security] Erreur sanitization SVG:\", e.message);\r\n                return null;\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Valide qu'une valeur est un nombre dans une plage donn√©e\r\n         * @param {*} value - Valeur √† valider\r\n         * @param {number} [min=-Infinity] - Valeur minimale\r\n         * @param {number} [max=Infinity] - Valeur maximale\r\n         * @returns {number|null} Nombre valid√© ou null si invalide\r\n         * @example\r\n         * Security.validateNumber(\"123\", 0, 1000)\r\n         * // Returns: 123\r\n         *\r\n         * Security.validateNumber(\"<script>\", 0, 100)\r\n         * // Returns: null\r\n         */\r\n        validateNumber(value, min = -Infinity, max = Infinity) {\r\n            // Convertir en nombre\r\n            const num = Number(value);\r\n\r\n            // V√©rifier que c'est un nombre fini\r\n            if (!Number.isFinite(num)) {\r\n                return null;\r\n            }\r\n\r\n            // V√©rifier les bornes\r\n            if (num < min || num > max) {\r\n                return null;\r\n            }\r\n\r\n            return num;\r\n        },\r\n\r\n        /**\r\n         * Parse du HTML de mani√®re s√©curis√©e avec whitelist de balises\r\n         * @param {string} html - HTML √† parser\r\n         * @param {string[]} [allowedTags=['p','br','strong','em','span','a','ul','ol','li']] - Balises autoris√©es\r\n         * @returns {DocumentFragment} Fragment DOM nettoy√©\r\n         * @example\r\n         * Security.parseHtmlSafely('<p>Hello</p><script>alert(1)</script>')\r\n         * // Returns: DocumentFragment with only <p>Hello</p>\r\n         */\r\n        parseHtmlSafely(html, allowedTags = ['p', 'br', 'strong', 'em', 'span', 'a', 'ul', 'ol', 'li', 'b', 'i']) {\r\n            const fragment = document.createDocumentFragment();\r\n\r\n            if (!html || typeof html !== \"string\") {\r\n                return fragment;\r\n            }\r\n\r\n            try {\r\n                const parser = new DOMParser();\r\n                const doc = parser.parseFromString(html, \"text/html\");\r\n\r\n                // Fonction r√©cursive pour nettoyer les n≈ìuds\r\n                const cleanNode = (node) => {\r\n                    if (node.nodeType === Node.TEXT_NODE) {\r\n                        return document.createTextNode(node.textContent);\r\n                    }\r\n\r\n                    if (node.nodeType !== Node.ELEMENT_NODE) {\r\n                        return null;\r\n                    }\r\n\r\n                    const tagName = node.tagName.toLowerCase();\r\n\r\n                    // Si la balise n'est pas autoris√©e, retourner seulement le contenu texte\r\n                    if (!allowedTags.includes(tagName)) {\r\n                        const textNode = document.createTextNode(node.textContent);\r\n                        return textNode;\r\n                    }\r\n\r\n                    // Cr√©er un nouvel √©l√©ment propre\r\n                    const cleanElement = document.createElement(tagName);\r\n\r\n                    // Pour les liens, conserver href mais valider\r\n                    if (tagName === 'a' && node.hasAttribute('href')) {\r\n                        try {\r\n                            const href = this.validateUrl(node.getAttribute('href'));\r\n                            cleanElement.setAttribute('href', href);\r\n                            cleanElement.setAttribute('rel', 'noopener noreferrer');\r\n                            cleanElement.setAttribute('target', '_blank');\r\n                        } catch (e) {\r\n                            // URL invalide, ignorer le lien\r\n                        }\r\n                    }\r\n\r\n                    // Nettoyer les enfants r√©cursivement\r\n                    node.childNodes.forEach(child => {\r\n                        const cleanChild = cleanNode(child);\r\n                        if (cleanChild) {\r\n                            cleanElement.appendChild(cleanChild);\r\n                        }\r\n                    });\r\n\r\n                    return cleanElement;\r\n                };\r\n\r\n                // Nettoyer le body du document pars√©\r\n                doc.body.childNodes.forEach(child => {\r\n                    const cleanChild = cleanNode(child);\r\n                    if (cleanChild) {\r\n                        fragment.appendChild(cleanChild);\r\n                    }\r\n                });\r\n\r\n            } catch (e) {\r\n                Log.warn(\"[Security] Erreur parsing HTML s√©curis√©:\", e.message);\r\n            }\r\n\r\n            return fragment;\r\n        },\r\n    };\r\n\r\n    // Export du module\r\n    GeoLeaf.Security = Security;\r\n\r\n    // Log du chargement\r\n    Log.info(\"[GeoLeaf.Security] Module de s√©curit√© charg√©\");\r\n})(typeof window !== \"undefined\" ? window : global);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n\r\n    /**\r\n     * Constantes globales GeoLeaf\r\n     * Centralise toutes les valeurs num√©riques utilis√©es dans le projet\r\n     */\r\n    GeoLeaf.CONSTANTS = {\r\n        // Carte ‚Äî vue neutre, le fitBounds positionne apr√®s chargement des couches\r\n        DEFAULT_ZOOM: 3,\r\n        DEFAULT_CENTER: [0, 0],\r\n        MAX_ZOOM_ON_FIT: 15,\r\n\r\n        // POI\r\n        POI_MARKER_SIZE: 12,\r\n        POI_MAX_ZOOM: 18,\r\n        POI_SWIPE_THRESHOLD: 50,\r\n        POI_LIGHTBOX_TRANSITION_MS: 300,\r\n        POI_SIDEPANEL_DEFAULT_WIDTH: 420,\r\n\r\n        // Route\r\n        ROUTE_MAX_ZOOM_ON_FIT: 14,\r\n        ROUTE_WAYPOINT_RADIUS: 5,\r\n\r\n        // GeoJSON\r\n        GEOJSON_MAX_ZOOM_ON_FIT: 15,\r\n        GEOJSON_POINT_RADIUS: 6,\r\n\r\n        // UI\r\n        FULLSCREEN_TRANSITION_MS: 10\r\n    };\r\n\r\n})(typeof window !== \"undefined\" ? window : global);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n\r\n    /**\r\n     * Module GeoLeaf.Utils\r\n     * Fonctions utilitaires r√©utilisables pour s√©curiser et manipuler les donn√©es\r\n     */\r\n    const Utils = {\r\n        /**\r\n         * √âchappe les caract√®res HTML dangereux pour pr√©venir les attaques XSS\r\n         * DEPRECATED: Utilisez GeoLeaf.Security.escapeHtml() √† la place\r\n         * @param {string} text - Texte √† √©chapper\r\n         * @returns {string} - Texte s√©curis√©\r\n         */\r\n        escapeHtml(text) {\r\n            // Redirection vers la fonction canonique dans Security\r\n            if (GeoLeaf.Security && typeof GeoLeaf.Security.escapeHtml === 'function') {\r\n                return GeoLeaf.Security.escapeHtml(text);\r\n            }\r\n\r\n            // Fallback si Security n'est pas charg√©\r\n            if (text == null || text === '') return '';\r\n            const map = {\r\n                '&': '&amp;',\r\n                '<': '&lt;',\r\n                '>': '&gt;',\r\n                '\"': '&quot;',\r\n                \"'\": '&#039;',\r\n                '/': '&#x2F;'\r\n            };\r\n            return String(text).replace(/[&<>\"'/]/g, function(s) {\r\n                return map[s];\r\n            });\r\n        },\r\n\r\n        /**\r\n         * Valide et nettoie une URL\r\n         * @param {string} url - URL √† valider\r\n         * @param {Array<string>} allowedProtocols - Protocoles autoris√©s (d√©faut: http, https, mailto, tel)\r\n         * @returns {string|null} - URL valid√©e ou null si invalide\r\n         */\r\n        validateUrl(url, allowedProtocols = ['http:', 'https:', 'mailto:', 'tel:']) {\r\n            if (!url || typeof url !== 'string') return null;\r\n\r\n            try {\r\n                const parsed = new URL(url, window.location.origin);\r\n\r\n                if (allowedProtocols.includes(parsed.protocol)) {\r\n                    return parsed.href;\r\n                }\r\n\r\n                return null;\r\n            } catch (e) {\r\n                // URL relative ou invalide\r\n                return null;\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Merge profond d'objets\r\n         * @param {Object} target - Objet cible\r\n         * @param {Object} source - Objet source\r\n         * @returns {Object} - Objet fusionn√©\r\n         */\r\n        deepMerge(target, source) {\r\n            if (!source || typeof source !== 'object') return target;\r\n            if (!target || typeof target !== 'object') return source;\r\n\r\n            const output = Object.assign({}, target);\r\n\r\n            Object.keys(source).forEach(key => {\r\n                if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {\r\n                    output[key] = this.deepMerge(target[key] || {}, source[key]);\r\n                } else {\r\n                    output[key] = source[key];\r\n                }\r\n            });\r\n\r\n            return output;\r\n        },\r\n\r\n        /**\r\n         * R√©sout la carte Leaflet depuis les options ou GeoLeaf.Core\r\n         * Utilitaire partag√© pour √©viter duplication dans POI/GeoJSON/Route\r\n         * @param {L.Map|null} explicitMap - Carte pass√©e explicitement\r\n         * @returns {L.Map|null} - Instance de la carte ou null\r\n         */\r\n        ensureMap(explicitMap) {\r\n            if (explicitMap) return explicitMap;\r\n\r\n            // Tentative de r√©cup√©ration via GeoLeaf.Core.getMap()\r\n            if (typeof GeoLeaf !== 'undefined' &&\r\n                GeoLeaf.Core &&\r\n                typeof GeoLeaf.Core.getMap === 'function') {\r\n                return GeoLeaf.Core.getMap();\r\n            }\r\n\r\n            return null;\r\n        },\r\n\r\n        /**\r\n         * Merge shallow d'options (pour les modules POI/GeoJSON/Route)\r\n         * @param {Object} defaults - Options par d√©faut\r\n         * @param {Object} override - Options fournies par l'utilisateur\r\n         * @returns {Object} - Options fusionn√©es\r\n         */\r\n        mergeOptions(defaults, override) {\r\n            if (!override || typeof override !== 'object') return defaults;\r\n            return Object.assign({}, defaults, override);\r\n        },\r\n\r\n        /**\r\n         * √âmet un √©v√©nement personnalis√© sur la carte Leaflet\r\n         * @param {L.Map} map - Instance de la carte\r\n         * @param {string} eventName - Nom de l'√©v√©nement (ex: 'geoleaf:poi:loaded')\r\n         * @param {Object} payload - Donn√©es √† transmettre\r\n         */\r\n        fireMapEvent(map, eventName, payload) {\r\n            if (!map || typeof map.fire !== 'function') return;\r\n\r\n            try {\r\n                map.fire(eventName, payload || {});\r\n            } catch (err) {\r\n                if (Log) {\r\n                    Log.warn('[GeoLeaf.Utils] Erreur lors de l\\'√©mission de l\\'√©v√©nement:', eventName, err);\r\n                }\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Debounce - Limite la fr√©quence d'ex√©cution d'une fonction\r\n         * Utile pour optimiser les event listeners (resize, scroll, input)\r\n         * @param {Function} func - Fonction √† debouncer\r\n         * @param {number} wait - D√©lai en ms (d√©faut: 250ms)\r\n         * @returns {Function} - Fonction debounc√©e\r\n         *\r\n         * @example\r\n         * const debouncedResize = GeoLeaf.Utils.debounce(() => {\r\n         *     map.invalidateSize();\r\n         * }, 300);\r\n         * window.addEventListener('resize', debouncedResize);\r\n         */\r\n        debounce(func, wait = 250) {\r\n            let timeout;\r\n\r\n            return function executedFunction(...args) {\r\n                const later = () => {\r\n                    clearTimeout(timeout);\r\n                    func(...args);\r\n                };\r\n\r\n                clearTimeout(timeout);\r\n                timeout = setTimeout(later, wait);\r\n            };\r\n        },\r\n\r\n        /**\r\n         * Throttle - Limite l'ex√©cution d'une fonction √† une fois par intervalle\r\n         * Diff√©rence avec debounce: garantit une ex√©cution r√©guli√®re\r\n         * @param {Function} func - Fonction √† throttler\r\n         * @param {number} limit - Intervalle minimum en ms (d√©faut: 100ms)\r\n         * @returns {Function} - Fonction throttl√©e\r\n         *\r\n         * @example\r\n         * const throttledScroll = GeoLeaf.Utils.throttle(() => {\r\n         *     console.log('Scroll event');\r\n         * }, 100);\r\n         * window.addEventListener('scroll', throttledScroll);\r\n         */\r\n        throttle(func, limit = 100) {\r\n            let inThrottle;\r\n\r\n            return function(...args) {\r\n                if (!inThrottle) {\r\n                    func.apply(this, args);\r\n                    inThrottle = true;\r\n                    setTimeout(() => inThrottle = false, limit);\r\n                }\r\n            };\r\n        },\r\n\r\n        /**\r\n         * Calcule la distance entre deux points g√©ographiques (formule de Haversine)\r\n         * @param {number} lat1 - Latitude du point 1 (degr√©s)\r\n         * @param {number} lng1 - Longitude du point 1 (degr√©s)\r\n         * @param {number} lat2 - Latitude du point 2 (degr√©s)\r\n         * @param {number} lng2 - Longitude du point 2 (degr√©s)\r\n         * @returns {number} - Distance en kilom√®tres\r\n         *\r\n         * @example\r\n         * const distance = GeoLeaf.Utils.getDistance(48.8566, 2.3522, 51.5074, -0.1278); // Paris -> London\r\n         * console.log(`Distance: ${distance.toFixed(2)} km`); // Distance: 343.56 km\r\n         */\r\n        getDistance(lat1, lng1, lat2, lng2) {\r\n            const R = 6371; // Rayon de la Terre en kilom√®tres\r\n            const dLat = (lat2 - lat1) * (Math.PI / 180);\r\n            const dLng = (lng2 - lng1) * (Math.PI / 180);\r\n            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +\r\n                      Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *\r\n                      Math.sin(dLng / 2) * Math.sin(dLng / 2);\r\n            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\r\n            return R * c;\r\n        },\r\n\r\n        /**\r\n         * R√©sout la valeur d'un champ depuis plusieurs chemins possibles dans un objet\r\n         * √âlimine les longues cha√Ænes conditionnelles de r√©solution de champs\r\n         * @param {Object} obj - Objet source\r\n         * @param {...string} paths - Chemins √† tester dans l'ordre (ex: 'label', 'attributes.label', 'properties.label')\r\n         * @returns {*} - Premi√®re valeur trouv√©e (string, object, array, etc.) ou cha√Æne vide si rien trouv√©\r\n         *\r\n         * @example\r\n         * const title = GeoLeaf.Utils.resolveField(poi,\r\n         *     'label', 'attributes.label', 'properties.label',\r\n         *     'name', 'attributes.name', 'properties.name'\r\n         * );\r\n         */\r\n        resolveField(obj, ...paths) {\r\n            if (!obj || typeof obj !== 'object') return '';\r\n\r\n            for (const path of paths) {\r\n                const keys = path.split('.');\r\n                let value = obj;\r\n\r\n                for (const key of keys) {\r\n                    if (value && typeof value === 'object' && key in value) {\r\n                        value = value[key];\r\n                    } else {\r\n                        value = null;\r\n                        break;\r\n                    }\r\n                }\r\n\r\n                // Return any truthy value (string, object, array, number, etc.)\r\n                if (value != null) {\r\n                    // For strings, ensure they're not empty\r\n                    if (typeof value === 'string') {\r\n                        if (value.trim()) return value;\r\n                    } else {\r\n                        // For non-strings (objects, arrays, numbers, booleans), return as-is\r\n                        return value;\r\n                    }\r\n                }\r\n            }\r\n\r\n            return '';\r\n        }\r\n    };\r\n\r\n    GeoLeaf.Utils = Utils;\r\n\r\n})(typeof window !== \"undefined\" ? window : global);\r\n","/**\r\n * GeoLeaf - DOM Security Module\r\n *\r\n * @description Wrappers s√©curis√©s pour manipuler le DOM sans vuln√©rabilit√©s XSS\r\n * @module GeoLeaf.DOMSecurity\r\n * @version 3.0.1\r\n * @date 2026-01-17\r\n *\r\n * USAGE:\r\n * - Remplace innerHTML par des alternatives s√©curis√©es\r\n * - Utilise textContent pour donn√©es non-HTML\r\n * - Sanitize via GeoLeaf.Security pour HTML n√©cessaire\r\n * - Cr√©e SVG de mani√®re s√©curis√©e\r\n */\r\n\r\n(function(global) {\r\n    'use strict';\r\n\r\n    const DOMSecurity = (function() {\r\n\r\n        const Log = global.GeoLeaf?.Log;\r\n        const Security = global.GeoLeaf?.Security;\r\n\r\n        /**\r\n         * D√©finit le contenu texte d'un √©l√©ment de mani√®re s√©curis√©e\r\n         * Remplace: element.innerHTML = text\r\n         *\r\n         * @param {HTMLElement} element - √âl√©ment DOM cible\r\n         * @param {string|number} text - Contenu texte (sera converti en string)\r\n         * @returns {void}\r\n         *\r\n         * @example\r\n         * // ‚ùå AVANT (vuln√©rable XSS)\r\n         * div.innerHTML = userData;\r\n         *\r\n         * // ‚úÖ APR√àS (s√©curis√©)\r\n         * DOMSecurity.setTextContent(div, userData);\r\n         */\r\n        function setTextContent(element, text) {\r\n            if (!element || !element.nodeType) {\r\n                if (Log) Log.warn('[DOMSecurity] Invalid element in setTextContent');\r\n                return;\r\n            }\r\n            element.textContent = text != null ? String(text) : '';\r\n        }\r\n\r\n        /**\r\n         * D√©finit du contenu HTML avec sanitization\r\n         * Remplace: element.innerHTML = html (quand HTML est vraiment n√©cessaire)\r\n         *\r\n         * @param {HTMLElement} element - √âl√©ment DOM cible\r\n         * @param {string} html - Contenu HTML √† ins√©rer\r\n         * @returns {void}\r\n         *\r\n         * @example\r\n         * // Utiliser Security.escapeHTML si disponible\r\n         * DOMSecurity.setSafeHTML(div, '<strong>Important</strong>');\r\n         */\r\n        function setSafeHTML(element, html) {\r\n            if (!element || !element.nodeType) {\r\n                if (Log) Log.warn('[DOMSecurity] Invalid element in setSafeHTML');\r\n                return;\r\n            }\r\n\r\n            // Tenter d'utiliser le sanitizer de GeoLeaf.Security\r\n            if (Security && typeof Security.escapeHtml === 'function') {\r\n                const sanitized = Security.escapeHtml(html);\r\n                element.innerHTML = sanitized;\r\n            } else {\r\n                // Fallback s√©curis√© : textContent au lieu de innerHTML brut\r\n                if (Log) Log.warn('[DOMSecurity] No sanitizer available, falling back to textContent');\r\n                element.textContent = html || '';\r\n            }\r\n        }\r\n\r\n        /**\r\n         * Vide un √©l√©ment de mani√®re s√©curis√©e\r\n         * Remplace: element.innerHTML = \"\"\r\n         *\r\n         * @param {HTMLElement} element - √âl√©ment DOM √† vider\r\n         * @returns {void}\r\n         *\r\n         * @example\r\n         * DOMSecurity.clearElement(container);\r\n         */\r\n        function clearElement(element) {\r\n            if (!element || !element.nodeType) {\r\n                if (Log) Log.warn('[DOMSecurity] Invalid element in clearElement');\r\n                return;\r\n            }\r\n\r\n            // M√©thode la plus performante et s√ªre\r\n            while (element.firstChild) {\r\n                element.removeChild(element.firstChild);\r\n            }\r\n        }\r\n\r\n        /**\r\n         * Vide rapidement en utilisant textContent (alternative)\r\n         * Plus rapide que removeChild mais moins propre\r\n         *\r\n         * @param {HTMLElement} element - √âl√©ment DOM √† vider\r\n         * @returns {void}\r\n         */\r\n        function clearElementFast(element) {\r\n            if (!element || !element.nodeType) {\r\n                if (Log) Log.warn('[DOMSecurity] Invalid element in clearElementFast');\r\n                return;\r\n            }\r\n            element.textContent = '';\r\n        }\r\n\r\n        /**\r\n         * Cr√©e un √©l√©ment SVG de mani√®re s√©curis√©e\r\n         *\r\n         * @param {number} width - Largeur SVG\r\n         * @param {number} height - Hauteur SVG\r\n         * @param {string} pathData - Donn√©es du path SVG\r\n         * @param {Object} [options={}] - Options SVG\r\n         * @param {string} [options.viewBox] - ViewBox SVG\r\n         * @param {string} [options.fill='none'] - Couleur de remplissage\r\n         * @param {string} [options.stroke='currentColor'] - Couleur de trait\r\n         * @param {string|number} [options.strokeWidth='2'] - √âpaisseur trait\r\n         * @param {string} [options.strokeLinecap='round'] - Style bout de trait\r\n         * @param {string} [options.strokeLinejoin='round'] - Style jonction\r\n         * @returns {SVGElement} √âl√©ment SVG cr√©√©\r\n         *\r\n         * @example\r\n         * const icon = DOMSecurity.createSVGIcon(18, 18, 'M6 9l6 6 6-6');\r\n         * button.appendChild(icon);\r\n         */\r\n        function createSVGIcon(width, height, pathData, options = {}) {\r\n            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');\r\n            svg.setAttribute('width', width);\r\n            svg.setAttribute('height', height);\r\n            svg.setAttribute('viewBox', options.viewBox || `0 0 24 24`);\r\n            svg.setAttribute('fill', options.fill || 'none');\r\n            svg.setAttribute('stroke', options.stroke || 'currentColor');\r\n            svg.setAttribute('stroke-width', String(options.strokeWidth || '2'));\r\n            svg.setAttribute('stroke-linecap', options.strokeLinecap || 'round');\r\n            svg.setAttribute('stroke-linejoin', options.strokeLinejoin || 'round');\r\n\r\n            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');\r\n            path.setAttribute('d', pathData);\r\n            svg.appendChild(path);\r\n\r\n            return svg;\r\n        }\r\n\r\n        /**\r\n         * Biblioth√®que d'ic√¥nes SVG communes\r\n         * @constant\r\n         */\r\n        const SVG_ICONS = {\r\n            // Chevrons\r\n            'chevron-down': 'M6 9l6 6 6-6',\r\n            'chevron-up': 'M18 15l-6-6-6 6',\r\n            'chevron-left': 'M15 18l-6-6 6-6',\r\n            'chevron-right': 'M9 18l6-6-6-6',\r\n\r\n            // Arrows\r\n            'arrow-left': '‚Äπ',\r\n            'arrow-right': '‚Ä∫',\r\n\r\n            // UI Controls\r\n            'close': '‚úï',\r\n            'check': '‚úì',\r\n            'star': '‚òÖ',\r\n            'star-empty': '‚òÜ',\r\n\r\n            // Triangles (collapse/expand)\r\n            'triangle-right': '‚ñ∂',\r\n            'triangle-down': '‚ñº',\r\n\r\n            // Home/Layers\r\n            'home': 'M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z',\r\n            'layers': 'M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5',\r\n\r\n            // Location\r\n            'marker': 'M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z',\r\n            'map-pin': 'M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z',\r\n\r\n            // Actions\r\n            'download': 'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3',\r\n            'upload': 'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12',\r\n            'trash': 'M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2',\r\n            'copy': 'M8 4v12a2 2 0 002 2h8a2 2 0 002-2V7.242a2 2 0 00-.602-1.43L16.083 2.57A2 2 0 0014.685 2H10a2 2 0 00-2 2z',\r\n\r\n            // Status\r\n            'sync': 'M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15'\r\n        };\r\n\r\n        /**\r\n         * Obtient une ic√¥ne SVG pr√©d√©finie\r\n         *\r\n         * @param {string} name - Nom de l'ic√¥ne\r\n         * @param {number} [size=18] - Taille de l'ic√¥ne\r\n         * @param {Object} [options={}] - Options SVG suppl√©mentaires\r\n         * @returns {SVGElement|null} √âl√©ment SVG ou null si non trouv√©\r\n         *\r\n         * @example\r\n         * const homeIcon = DOMSecurity.getIcon('home', 24);\r\n         * button.appendChild(homeIcon);\r\n         */\r\n        function getIcon(name, size = 18, options = {}) {\r\n            const pathData = SVG_ICONS[name];\r\n            if (!pathData) {\r\n                if (Log) Log.warn(`[DOMSecurity] Icon '${name}' not found`);\r\n                return null;\r\n            }\r\n            return createSVGIcon(size, size, pathData, options);\r\n        }\r\n\r\n        /**\r\n         * Cr√©e un √©l√©ment avec attributs de mani√®re s√©curis√©e\r\n         * Alternative s√©curis√©e √† innerHTML pour structures simples\r\n         *\r\n         * @param {string} tagName - Nom de la balise\r\n         * @param {Object} [attributes={}] - Attributs de l'√©l√©ment\r\n         * @param {string|HTMLElement|Array} [children] - Enfants (texte ou √©l√©ments)\r\n         * @returns {HTMLElement} √âl√©ment cr√©√©\r\n         *\r\n         * @example\r\n         * const div = DOMSecurity.createElement('div',\r\n         *   { class: 'container', id: 'main' },\r\n         *   ['Hello ', DOMSecurity.createElement('strong', {}, 'World')]\r\n         * );\r\n         */\r\n        function createElement(tagName, attributes = {}, children = null) {\r\n            const element = document.createElement(tagName);\r\n\r\n            // D√©finir les attributs\r\n            for (const [key, value] of Object.entries(attributes)) {\r\n                if (key === 'class' || key === 'className') {\r\n                    element.className = value;\r\n                } else if (key === 'style' && typeof value === 'object') {\r\n                    Object.assign(element.style, value);\r\n                } else if (key.startsWith('data-')) {\r\n                    element.setAttribute(key, value);\r\n                } else {\r\n                    element[key] = value;\r\n                }\r\n            }\r\n\r\n            // Ajouter les enfants\r\n            if (children) {\r\n                if (Array.isArray(children)) {\r\n                    children.forEach(child => {\r\n                        if (typeof child === 'string') {\r\n                            element.appendChild(document.createTextNode(child));\r\n                        } else if (child && child.nodeType) {\r\n                            element.appendChild(child);\r\n                        }\r\n                    });\r\n                } else if (typeof children === 'string') {\r\n                    element.textContent = children;\r\n                } else if (children.nodeType) {\r\n                    element.appendChild(children);\r\n                }\r\n            }\r\n\r\n            return element;\r\n        }\r\n\r\n        // API publique\r\n        return {\r\n            setTextContent,\r\n            setSafeHTML,\r\n            clearElement,\r\n            clearElementFast,\r\n            createSVGIcon,\r\n            getIcon,\r\n            createElement,\r\n            SVG_ICONS // Exposer la liste pour r√©f√©rence\r\n        };\r\n    })();\r\n\r\n    // Export vers GeoLeaf namespace\r\n    if (typeof global.GeoLeaf !== 'undefined') {\r\n        global.GeoLeaf.DOMSecurity = DOMSecurity;\r\n    } else {\r\n        // Cr√©er namespace si n√©cessaire\r\n        global.GeoLeaf = global.GeoLeaf || {};\r\n        global.GeoLeaf.DOMSecurity = DOMSecurity;\r\n    }\r\n\r\n    // Support CommonJS/Node.js\r\n    if (typeof module !== 'undefined' && module.exports) {\r\n        module.exports = DOMSecurity;\r\n    }\r\n\r\n})(typeof window !== 'undefined' ? window : global);\r\n","/**\r\n * @module GeoLeaf.Utils.DomHelpers\r\n * Helpers pour cr√©ation et manipulation d'√©l√©ments DOM\r\n * Simplifie et standardise la cr√©ation d'√©l√©ments DOM dans tout le projet\r\n *\r\n * @version 1.0.0\r\n * @requires GeoLeaf.Security (pour sanitization)\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    GeoLeaf.Utils = GeoLeaf.Utils || {};\r\n\r\n    /**\r\n     * Cr√©e un √©l√©ment DOM avec propri√©t√©s et enfants de mani√®re d√©clarative\r\n     * Cette fonction simplifie la cr√©ation d'√©l√©ments DOM complexes\r\n     *\r\n     * @param {string} tag - Nom du tag HTML (ex: 'div', 'span', 'button')\r\n     * @param {Object} [props={}] - Propri√©t√©s de l'√©l√©ment\r\n     * @param {string} [props.className] - Classes CSS\r\n     * @param {string} [props.id] - ID de l'√©l√©ment\r\n     * @param {Object} [props.style] - Styles inline (objet)\r\n     * @param {Object} [props.dataset] - Data attributes (objet)\r\n     * @param {Object} [props.attributes] - Attributs HTML (objet)\r\n     * @param {Function} [props.on*] - Event handlers (ex: onClick, onMouseOver)\r\n     * @param {string} [props._eventContext] - Context for EventListenerManager tracking\r\n     * @param {Array} [props._cleanupArray] - Array to store cleanup functions\r\n     * @param {...(Node|string|number)} children - Enfants de l'√©l√©ment\r\n     * @returns {HTMLElement} L'√©l√©ment cr√©√©\r\n     *\r\n     * @example\r\n     * // Simple div avec classe\r\n     * createElement('div', { className: 'card' })\r\n     *\r\n     * @example\r\n     * // Div avec enfants\r\n     * createElement('div', { className: 'card' },\r\n     *     createElement('h2', {}, 'Title'),\r\n     *     createElement('p', {}, 'Content')\r\n     * )\r\n     *\r\n     * @example\r\n     * // Bouton avec event handler (auto-cleanup with EventListenerManager)\r\n     * createElement('button', {\r\n     *     className: 'btn',\r\n     *     onClick: (e) => console.log('Clicked!'),\r\n     *     dataset: { action: 'submit' },\r\n     *     _eventContext: 'MyModule.button'\r\n     * }, 'Click me')\r\n     *\r\n     * @example\r\n     * // With cleanup tracking\r\n     * const cleanups = [];\r\n     * createElement('button', {\r\n     *     onClick: handler,\r\n     *     _cleanupArray: cleanups,\r\n     *     _eventContext: 'MyModule'\r\n     * }, 'Click')\r\n     * // Later: cleanups.forEach(fn => fn())\r\n     */\r\n    function createElement(tag, props = {}, ...children) {\r\n        // Validate tag parameter\r\n        if (typeof tag !== 'string' || !tag.trim()) {\r\n            throw new TypeError('[DomHelpers] createElement: tag must be a non-empty string');\r\n        }\r\n\r\n        const element = document.createElement(tag);\r\n\r\n        // Traiter les propri√©t√©s sp√©ciales en premier\r\n        const {\r\n            className,\r\n            id,\r\n            style,\r\n            dataset,\r\n            attributes,\r\n            textContent,\r\n            innerHTML,\r\n            _eventContext,\r\n            _cleanupArray,\r\n            ...otherProps\r\n        } = props;\r\n\r\n        // Appliquer className\r\n        if (className) {\r\n            element.className = className;\r\n        }\r\n\r\n        // Appliquer ID\r\n        if (id) {\r\n            element.id = id;\r\n        }\r\n\r\n        // Appliquer styles\r\n        if (style && typeof style === 'object') {\r\n            Object.assign(element.style, style);\r\n        }\r\n\r\n        // Appliquer data attributes\r\n        if (dataset && typeof dataset === 'object') {\r\n            for (const [key, value] of Object.entries(dataset)) {\r\n                element.dataset[key] = value;\r\n            }\r\n        }\r\n\r\n        // Appliquer attributes HTML\r\n        if (attributes && typeof attributes === 'object') {\r\n            for (const [key, value] of Object.entries(attributes)) {\r\n                element.setAttribute(key, value);\r\n            }\r\n        }\r\n\r\n        // Appliquer les autres propri√©t√©s (event handlers, etc.)\r\n        const events = GeoLeaf.Utils?.events;\r\n\r\n        for (const [key, value] of Object.entries(otherProps)) {\r\n            // Event handlers (onClick, onMouseOver, etc.)\r\n            if (key.startsWith('on') && typeof value === 'function') {\r\n                const event = key.substring(2).toLowerCase();\r\n\r\n                // Use EventListenerManager for auto-cleanup if available\r\n                if (events) {\r\n                    const cleanup = events.on(\r\n                        element,\r\n                        event,\r\n                        value,\r\n                        false,\r\n                        _eventContext || 'DomHelpers.createElement'\r\n                    );\r\n\r\n                    // Store cleanup function if array provided\r\n                    if (_cleanupArray && Array.isArray(_cleanupArray)) {\r\n                        _cleanupArray.push(cleanup);\r\n                    }\r\n                } else {\r\n                    // Fallback to native addEventListener\r\n                    element.addEventListener(event, value);\r\n                }\r\n            }\r\n            // Propri√©t√©s aria-*\r\n            else if (key.startsWith('aria')) {\r\n                const attrName = 'aria-' + key.substring(4).toLowerCase();\r\n                element.setAttribute(attrName, value);\r\n            }\r\n            // Autres propri√©t√©s directes\r\n            else if (key in element) {\r\n                element[key] = value;\r\n            }\r\n            // Fallback: setAttribute\r\n            else {\r\n                element.setAttribute(key, value);\r\n            }\r\n        }\r\n\r\n        // Appliquer textContent si fourni (√©crase innerHTML et children)\r\n        if (textContent !== undefined) {\r\n            element.textContent = textContent;\r\n            return element; // Ignorer children si textContent est fourni\r\n        }\r\n\r\n        // Appliquer innerHTML si fourni (√©crase children)\r\n        // WARNING: N'utiliser qu'avec du contenu s√©curis√©/sanitiz√©\r\n        if (innerHTML !== undefined) {\r\n            if (GeoLeaf.Log && GeoLeaf.Log.warn) {\r\n                GeoLeaf.Log.warn(\r\n                    '[DomHelpers] createElement avec innerHTML - assurez-vous que le contenu est sanitiz√©',\r\n                    { tag, innerHTML: innerHTML.substring(0, 100) }\r\n                );\r\n            }\r\n\r\n            // Use DOMSecurity if available, otherwise use textContent as safer fallback\r\n            if (GeoLeaf.DOMSecurity && typeof GeoLeaf.DOMSecurity.setSafeHTML === 'function') {\r\n                GeoLeaf.DOMSecurity.setSafeHTML(element, innerHTML);\r\n            } else {\r\n                // Fallback: convert to text for security\r\n                if (GeoLeaf.Log && GeoLeaf.Log.error) {\r\n                    GeoLeaf.Log.error('[DomHelpers] DOMSecurity not available, using textContent fallback');\r\n                }\r\n                element.textContent = innerHTML;\r\n            }\r\n            return element; // Ignorer children si innerHTML est fourni\r\n        }\r\n\r\n        // Ajouter les enfants\r\n        appendChild(element, ...children);\r\n\r\n        return element;\r\n    }\r\n\r\n    /**\r\n     * Ajoute des enfants √† un √©l√©ment parent\r\n     * G√®re automatiquement les strings, numbers, nodes, et tableaux\r\n     *\r\n     * @param {HTMLElement} parent - √âl√©ment parent\r\n     * @param {...(Node|string|number|Array)} children - Enfants √† ajouter\r\n     * @returns {HTMLElement} Le parent (pour cha√Ænage)\r\n     *\r\n     * @example\r\n     * appendChild(div, 'Text', createElement('span', {}, 'More text'))\r\n     *\r\n     * @example\r\n     * // Avec tableau\r\n     * appendChild(ul, items.map(item => createElement('li', {}, item)))\r\n     */\r\n    function appendChild(parent, ...children) {\r\n        for (const child of children) {\r\n            if (child == null || child === false) {\r\n                // Ignorer null, undefined, false (utile pour render conditionnel)\r\n                continue;\r\n            }\r\n\r\n            // Si c'est un tableau, l'aplatir r√©cursivement\r\n            if (Array.isArray(child)) {\r\n                appendChild(parent, ...child);\r\n            }\r\n            // Si c'est une string ou number, cr√©er un TextNode\r\n            else if (typeof child === 'string' || typeof child === 'number') {\r\n                parent.appendChild(document.createTextNode(String(child)));\r\n            }\r\n            // Si c'est un Node, l'ajouter directement\r\n            else if (child instanceof Node) {\r\n                parent.appendChild(child);\r\n            }\r\n            // Sinon, convertir en string et ajouter comme TextNode\r\n            else {\r\n                parent.appendChild(document.createTextNode(String(child)));\r\n            }\r\n        }\r\n        return parent;\r\n    }\r\n\r\n    /**\r\n     * Vide un √©l√©ment de tous ses enfants\r\n     *\r\n     * @param {HTMLElement} element - √âl√©ment √† vider\r\n     * @returns {HTMLElement} L'√©l√©ment (pour cha√Ænage)\r\n     *\r\n     * @example\r\n     * clearElement(container)\r\n     */\r\n    function clearElement(element) {\r\n        if (!element) return element;\r\n        while (element.firstChild) {\r\n            element.removeChild(element.firstChild);\r\n        }\r\n        return element;\r\n    }\r\n\r\n    /**\r\n     * Trouve un √©l√©ment par ID avec validation\r\n     *\r\n     * @param {string} id - ID de l'√©l√©ment\r\n     * @param {boolean} [required=false] - Si true, lance une erreur si non trouv√©\r\n     * @returns {HTMLElement|null} L'√©l√©ment trouv√© ou null\r\n     * @throws {Error} Si required=true et √©l√©ment non trouv√©\r\n     *\r\n     * @example\r\n     * const el = getElementById('my-element', true) // Lance erreur si absent\r\n     */\r\n    function getElementById(id, required = false) {\r\n        const element = document.getElementById(id);\r\n        if (required && !element) {\r\n            throw new Error(`Element with id \"${id}\" not found`);\r\n        }\r\n        return element;\r\n    }\r\n\r\n    /**\r\n     * Trouve des √©l√©ments par s√©lecteur CSS\r\n     *\r\n     * @param {string} selector - S√©lecteur CSS\r\n     * @param {HTMLElement} [parent=document] - √âl√©ment parent pour la recherche\r\n     * @returns {HTMLElement[]} Tableau d'√©l√©ments trouv√©s\r\n     *\r\n     * @example\r\n     * const buttons = querySelectorAll('.btn')\r\n     */\r\n    function querySelectorAll(selector, parent = document) {\r\n        return Array.from(parent.querySelectorAll(selector));\r\n    }\r\n\r\n    /**\r\n     * Trouve un √©l√©ment par s√©lecteur CSS\r\n     *\r\n     * @param {string} selector - S√©lecteur CSS\r\n     * @param {HTMLElement} [parent=document] - √âl√©ment parent pour la recherche\r\n     * @returns {HTMLElement|null} Premier √©l√©ment trouv√© ou null\r\n     *\r\n     * @example\r\n     * const button = querySelector('.btn-primary')\r\n     */\r\n    function querySelector(selector, parent = document) {\r\n        return parent.querySelector(selector);\r\n    }\r\n\r\n    /**\r\n     * Toggle une classe CSS sur un √©l√©ment\r\n     *\r\n     * @param {HTMLElement} element - √âl√©ment cible\r\n     * @param {string} className - Nom de la classe\r\n     * @param {boolean} [force] - Force l'ajout (true) ou le retrait (false)\r\n     * @returns {boolean} True si la classe est pr√©sente apr√®s toggle\r\n     *\r\n     * @example\r\n     * toggleClass(element, 'active')\r\n     * toggleClass(element, 'hidden', false) // Force retrait\r\n     */\r\n    function toggleClass(element, className, force) {\r\n        if (!element) return false;\r\n        return element.classList.toggle(className, force);\r\n    }\r\n\r\n    /**\r\n     * Ajoute une ou plusieurs classes √† un √©l√©ment\r\n     *\r\n     * @param {HTMLElement} element - √âl√©ment cible\r\n     * @param {...string} classNames - Classes √† ajouter\r\n     * @returns {HTMLElement} L'√©l√©ment (pour cha√Ænage)\r\n     *\r\n     * @example\r\n     * addClass(element, 'active', 'visible')\r\n     */\r\n    function addClass(element, ...classNames) {\r\n        if (!element) return element;\r\n        element.classList.add(...classNames);\r\n        return element;\r\n    }\r\n\r\n    /**\r\n     * Retire une ou plusieurs classes d'un √©l√©ment\r\n     *\r\n     * @param {HTMLElement} element - √âl√©ment cible\r\n     * @param {...string} classNames - Classes √† retirer\r\n     * @returns {HTMLElement} L'√©l√©ment (pour cha√Ænage)\r\n     *\r\n     * @example\r\n     * removeClass(element, 'active', 'visible')\r\n     */\r\n    function removeClass(element, ...classNames) {\r\n        if (!element) return element;\r\n        element.classList.remove(...classNames);\r\n        return element;\r\n    }\r\n\r\n    /**\r\n     * V√©rifie si un √©l√©ment a une classe\r\n     *\r\n     * @param {HTMLElement} element - √âl√©ment √† v√©rifier\r\n     * @param {string} className - Nom de la classe\r\n     * @returns {boolean} True si la classe est pr√©sente\r\n     *\r\n     * @example\r\n     * if (hasClass(element, 'active')) { ... }\r\n     */\r\n    function hasClass(element, className) {\r\n        if (!element) return false;\r\n        return element.classList.contains(className);\r\n    }\r\n\r\n    /**\r\n     * D√©finit ou r√©cup√®re un attribut data-*\r\n     *\r\n     * @param {HTMLElement} element - √âl√©ment cible\r\n     * @param {string} key - Nom de l'attribut (sans 'data-')\r\n     * @param {*} [value] - Valeur √† d√©finir (omis pour lecture)\r\n     * @returns {string|HTMLElement} Valeur lue ou √©l√©ment (pour cha√Ænage)\r\n     *\r\n     * @example\r\n     * setData(element, 'id', '123') // D√©finir\r\n     * const id = setData(element, 'id') // Lire\r\n     */\r\n    function setData(element, key, value) {\r\n        if (!element) return value === undefined ? null : element;\r\n        if (value === undefined) {\r\n            return element.dataset[key];\r\n        }\r\n        element.dataset[key] = value;\r\n        return element;\r\n    }\r\n\r\n    // Exposer le module\r\n    GeoLeaf.Utils.DomHelpers = {\r\n        createElement,\r\n        appendChild,\r\n        clearElement,\r\n        getElementById,\r\n        querySelector,\r\n        querySelectorAll,\r\n        toggleClass,\r\n        addClass,\r\n        removeClass,\r\n        hasClass,\r\n        setData\r\n    };\r\n\r\n    // Alias sur GeoLeaf.Utils pour compatibilit√© et facilit√© d'usage\r\n    GeoLeaf.Utils.createElement = createElement;\r\n    GeoLeaf.Utils.appendChild = appendChild;\r\n    GeoLeaf.Utils.clearElement = clearElement;\r\n\r\n    if (GeoLeaf.Log && GeoLeaf.Log.info) {\r\n        GeoLeaf.Log.info('[GeoLeaf.Utils.DomHelpers] Module loaded');\r\n    }\r\n\r\n})(typeof window !== 'undefined' ? window : this);\r\n","/**\r\n * @fileoverview EventListenerManager - Gestion centralis√©e des event listeners\r\n * Permet de tracker et nettoyer tous les event listeners\r\n * pour √©viter les fuites m√©moire\r\n *\r\n * @module GeoLeaf.Utils.EventListenerManager\r\n * @version 2.0.0\r\n * @author GeoLeaf Project\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    GeoLeaf.Utils = GeoLeaf.Utils || {};\r\n\r\n    const Log = GeoLeaf.Log;\r\n\r\n    /**\r\n     * EventListenerManager - Gestionnaire centralis√© d'event listeners\r\n     * @class\r\n     */\r\n    class EventListenerManager {\r\n        constructor(name = 'default') {\r\n            this.name = name;\r\n            this.listeners = [];\r\n            this._nextId = 1;\r\n        }\r\n\r\n        /**\r\n         * Ajoute un event listener avec tracking\r\n         * @param {Element|Window|Document} target - √âl√©ment cible\r\n         * @param {string} event - Nom de l'√©v√©nement\r\n         * @param {Function} handler - Handler de l'√©v√©nement\r\n         * @param {Object|boolean} [options] - Options (capture, once, passive, etc.)\r\n         * @param {string} [label] - Label optionnel pour debug\r\n         * @returns {number} ID du listener pour removal ult√©rieur\r\n         */\r\n        addEventListener(target, event, handler, options = false, label = '') {\r\n            if (!target || typeof target.addEventListener !== 'function') {\r\n                if (Log) Log.warn(`[EventListenerManager.${this.name}] Invalid target for addEventListener`);\r\n                return null;\r\n            }\r\n\r\n            const id = this._nextId++;\r\n\r\n            target.addEventListener(event, handler, options);\r\n\r\n            this.listeners.push({\r\n                id,\r\n                target,\r\n                event,\r\n                handler,\r\n                options,\r\n                label,\r\n                createdAt: Date.now()\r\n            });\r\n\r\n            if (Log) Log.debug(`[EventListenerManager.${this.name}] Listener added:`, id, event, label);\r\n            return id;\r\n        }\r\n\r\n        /**\r\n         * Ajoute un event listener Leaflet avec tracking\r\n         * @param {L.Evented} target - Objet Leaflet (map, marker, etc.)\r\n         * @param {string} event - Nom de l'√©v√©nement\r\n         * @param {Function} handler - Handler de l'√©v√©nement\r\n         * @param {string} [label] - Label optionnel pour debug\r\n         * @returns {number} ID du listener\r\n         */\r\n        addLeafletListener(target, event, handler, label = '') {\r\n            if (!target || typeof target.on !== 'function') {\r\n                if (Log) Log.warn(`[EventListenerManager.${this.name}] Invalid Leaflet target`);\r\n                return null;\r\n            }\r\n\r\n            const id = this._nextId++;\r\n\r\n            target.on(event, handler);\r\n\r\n            this.listeners.push({\r\n                id,\r\n                target,\r\n                event,\r\n                handler,\r\n                label,\r\n                type: 'leaflet',\r\n                createdAt: Date.now()\r\n            });\r\n\r\n            if (Log) Log.debug(`[EventListenerManager.${this.name}] Leaflet listener added:`, id, event, label);\r\n            return id;\r\n        }\r\n\r\n        /**\r\n         * Retire un listener sp√©cifique par ID\r\n         * @param {number} id - ID du listener\r\n         * @returns {boolean} True si le listener a √©t√© trouv√© et retir√©\r\n         */\r\n        removeListener(id) {\r\n            const index = this.listeners.findIndex(l => l.id === id);\r\n            if (index === -1) return false;\r\n\r\n            const listener = this.listeners[index];\r\n\r\n            if (listener.type === 'leaflet') {\r\n                if (listener.target && typeof listener.target.off === 'function') {\r\n                    listener.target.off(listener.event, listener.handler);\r\n                }\r\n            } else {\r\n                if (listener.target && typeof listener.target.removeEventListener === 'function') {\r\n                    listener.target.removeEventListener(listener.event, listener.handler, listener.options);\r\n                }\r\n            }\r\n\r\n            this.listeners.splice(index, 1);\r\n\r\n            if (Log) Log.debug(`[EventListenerManager.${this.name}] Listener removed:`, id, listener.label);\r\n            return true;\r\n        }\r\n\r\n        /**\r\n         * Retire tous les listeners d'un √©l√©ment sp√©cifique\r\n         * @param {Element|L.Evented} target - √âl√©ment cible\r\n         * @returns {number} Nombre de listeners retir√©s\r\n         */\r\n        removeListenersForTarget(target) {\r\n            const matchingListeners = this.listeners.filter(l => l.target === target);\r\n\r\n            matchingListeners.forEach(listener => {\r\n                if (listener.type === 'leaflet') {\r\n                    if (listener.target && typeof listener.target.off === 'function') {\r\n                        listener.target.off(listener.event, listener.handler);\r\n                    }\r\n                } else {\r\n                    if (listener.target && typeof listener.target.removeEventListener === 'function') {\r\n                        listener.target.removeEventListener(listener.event, listener.handler, listener.options);\r\n                    }\r\n                }\r\n            });\r\n\r\n            this.listeners = this.listeners.filter(l => l.target !== target);\r\n\r\n            if (Log && matchingListeners.length > 0) {\r\n                Log.info(`[EventListenerManager.${this.name}] Removed ${matchingListeners.length} listener(s) for target`);\r\n            }\r\n\r\n            return matchingListeners.length;\r\n        }\r\n\r\n        /**\r\n         * Retire tous les listeners\r\n         */\r\n        removeAll() {\r\n            const count = this.listeners.length;\r\n\r\n            this.listeners.forEach(listener => {\r\n                try {\r\n                    if (listener.type === 'leaflet') {\r\n                        if (listener.target && typeof listener.target.off === 'function') {\r\n                            listener.target.off(listener.event, listener.handler);\r\n                        }\r\n                    } else {\r\n                        if (listener.target && typeof listener.target.removeEventListener === 'function') {\r\n                            listener.target.removeEventListener(listener.event, listener.handler, listener.options);\r\n                        }\r\n                    }\r\n                } catch (error) {\r\n                    if (Log) Log.warn(`[EventListenerManager.${this.name}] Error removing listener:`, error);\r\n                }\r\n            });\r\n\r\n            this.listeners = [];\r\n\r\n            if (Log && count > 0) {\r\n                Log.info(`[EventListenerManager.${this.name}] Removed ${count} listener(s)`);\r\n            }\r\n        }\r\n\r\n        /**\r\n         * Obtient le nombre de listeners actifs\r\n         * @returns {number}\r\n         */\r\n        getCount() {\r\n            return this.listeners.length;\r\n        }\r\n\r\n        /**\r\n         * Liste tous les listeners actifs (pour debug)\r\n         * @returns {Array}\r\n         */\r\n        listActiveListeners() {\r\n            return this.listeners.map(l => ({\r\n                id: l.id,\r\n                event: l.event,\r\n                label: l.label,\r\n                type: l.type || 'dom',\r\n                age: Date.now() - l.createdAt\r\n            }));\r\n        }\r\n\r\n        /**\r\n         * D√©truit le manager et nettoie tous les listeners\r\n         */\r\n        destroy() {\r\n            this.removeAll();\r\n            if (Log) Log.info(`[EventListenerManager.${this.name}] Destroyed`);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Instance globale par d√©faut\r\n     */\r\n    const globalEventManager = new EventListenerManager('global');\r\n\r\n    /**\r\n     * API simplifi√©e pour l'instance globale\r\n     */\r\n    GeoLeaf.Utils.EventListenerManager = EventListenerManager;\r\n    GeoLeaf.Utils.events = {\r\n        /**\r\n         * addEventListener avec tracking global\r\n         */\r\n        on: (target, event, handler, options, label) =>\r\n            globalEventManager.addEventListener(target, event, handler, options, label),\r\n\r\n        /**\r\n         * Leaflet event listener avec tracking global\r\n         */\r\n        onLeaflet: (target, event, handler, label) =>\r\n            globalEventManager.addLeafletListener(target, event, handler, label),\r\n\r\n        /**\r\n         * Retire un listener par ID\r\n         */\r\n        off: (id) => globalEventManager.removeListener(id),\r\n\r\n        /**\r\n         * Retire tous les listeners d'une cible\r\n         */\r\n        offTarget: (target) => globalEventManager.removeListenersForTarget(target),\r\n\r\n        /**\r\n         * Retire tous les listeners globaux\r\n         */\r\n        offAll: () => globalEventManager.removeAll(),\r\n\r\n        /**\r\n         * Obtient le nombre de listeners actifs\r\n         */\r\n        getCount: () => globalEventManager.getCount(),\r\n\r\n        /**\r\n         * Liste les listeners actifs\r\n         */\r\n        listActive: () => globalEventManager.listActiveListeners(),\r\n\r\n        /**\r\n         * Cr√©e une nouvelle instance pour un composant\r\n         * @param {string} name - Nom du manager\r\n         * @returns {EventListenerManager}\r\n         */\r\n        createManager: (name) => new EventListenerManager(name)\r\n    };\r\n\r\n    // Cleanup automatique avant unload\r\n    if (typeof window !== 'undefined') {\r\n        window.addEventListener('beforeunload', () => {\r\n            const count = globalEventManager.getCount();\r\n            if (count > 0) {\r\n                if (Log) Log.warn(`[EventListenerManager] ${count} listener(s) still active at page unload`);\r\n                globalEventManager.removeAll();\r\n            }\r\n        });\r\n    }\r\n\r\n    if (Log) Log.info('[GeoLeaf.Utils.EventListenerManager] Module charg√©');\r\n\r\n})(typeof window !== 'undefined' ? window : global);\r\n","/**\r\n * @fileoverview TimerManager - Gestion centralis√©e des timers\r\n * Permet de tracker et nettoyer tous les setTimeout/setInterval\r\n * pour √©viter les fuites m√©moire\r\n *\r\n * @module GeoLeaf.Utils.TimerManager\r\n * @version 2.0.0\r\n * @author GeoLeaf Project\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    GeoLeaf.Utils = GeoLeaf.Utils || {};\r\n\r\n    const Log = GeoLeaf.Log;\r\n\r\n    /**\r\n     * TimerManager - Gestionnaire centralis√© de timers\r\n     * @class\r\n     */\r\n    class TimerManager {\r\n        constructor(name = 'default') {\r\n            this.name = name;\r\n            this.timers = new Map();\r\n            this.intervals = new Map();\r\n            this._nextId = 1;\r\n        }\r\n\r\n        /**\r\n         * Cr√©e un setTimeout avec tracking\r\n         * @param {Function} callback - Fonction √† ex√©cuter\r\n         * @param {number} delay - D√©lai en ms\r\n         * @param {string} [label] - Label optionnel pour debug\r\n         * @returns {number} ID du timer\r\n         */\r\n        setTimeout(callback, delay, label = '') {\r\n            const id = this._nextId++;\r\n            const timerId = setTimeout(() => {\r\n                try {\r\n                    callback();\r\n                } finally {\r\n                    // Auto-cleanup apr√®s ex√©cution\r\n                    this.timers.delete(id);\r\n                }\r\n            }, delay);\r\n\r\n            this.timers.set(id, {\r\n                timerId,\r\n                label,\r\n                type: 'timeout',\r\n                createdAt: Date.now(),\r\n                delay\r\n            });\r\n\r\n            if (Log) Log.debug(`[TimerManager.${this.name}] setTimeout created:`, id, label);\r\n            return id;\r\n        }\r\n\r\n        /**\r\n         * Cr√©e un setInterval avec tracking\r\n         * @param {Function} callback - Fonction √† ex√©cuter\r\n         * @param {number} interval - Intervalle en ms\r\n         * @param {string} [label] - Label optionnel pour debug\r\n         * @returns {number} ID de l'interval\r\n         */\r\n        setInterval(callback, interval, label = '') {\r\n            const id = this._nextId++;\r\n            const intervalId = setInterval(() => {\r\n                try {\r\n                    callback();\r\n                } catch (error) {\r\n                    if (Log) Log.error(`[TimerManager.${this.name}] Error in interval ${id}:`, error);\r\n                }\r\n            }, interval);\r\n\r\n            this.intervals.set(id, {\r\n                intervalId,\r\n                label,\r\n                type: 'interval',\r\n                createdAt: Date.now(),\r\n                interval\r\n            });\r\n\r\n            if (Log) Log.debug(`[TimerManager.${this.name}] setInterval created:`, id, label);\r\n            return id;\r\n        }\r\n\r\n        /**\r\n         * Clear un timer sp√©cifique\r\n         * @param {number} id - ID du timer\r\n         * @returns {boolean} True si le timer a √©t√© trouv√© et nettoy√©\r\n         */\r\n        clearTimeout(id) {\r\n            const timer = this.timers.get(id);\r\n            if (timer) {\r\n                clearTimeout(timer.timerId);\r\n                this.timers.delete(id);\r\n                if (Log) Log.debug(`[TimerManager.${this.name}] setTimeout cleared:`, id, timer.label);\r\n                return true;\r\n            }\r\n            return false;\r\n        }\r\n\r\n        /**\r\n         * Clear un interval sp√©cifique\r\n         * @param {number} id - ID de l'interval\r\n         * @returns {boolean} True si l'interval a √©t√© trouv√© et nettoy√©\r\n         */\r\n        clearInterval(id) {\r\n            const interval = this.intervals.get(id);\r\n            if (interval) {\r\n                clearInterval(interval.intervalId);\r\n                this.intervals.delete(id);\r\n                if (Log) Log.debug(`[TimerManager.${this.name}] setInterval cleared:`, id, interval.label);\r\n                return true;\r\n            }\r\n            return false;\r\n        }\r\n\r\n        /**\r\n         * Clear tous les timers et intervals\r\n         */\r\n        clearAll() {\r\n            // Clear tous les timeouts\r\n            for (const [id, timer] of this.timers.entries()) {\r\n                clearTimeout(timer.timerId);\r\n            }\r\n\r\n            // Clear tous les intervals\r\n            for (const [id, interval] of this.intervals.entries()) {\r\n                clearInterval(interval.intervalId);\r\n            }\r\n\r\n            const totalCleared = this.timers.size + this.intervals.size;\r\n            this.timers.clear();\r\n            this.intervals.clear();\r\n\r\n            if (Log && totalCleared > 0) {\r\n                Log.info(`[TimerManager.${this.name}] Cleared ${totalCleared} timer(s)`);\r\n            }\r\n        }\r\n\r\n        /**\r\n         * Obtient le nombre de timers actifs\r\n         * @returns {{timeouts: number, intervals: number, total: number}}\r\n         */\r\n        getStats() {\r\n            return {\r\n                timeouts: this.timers.size,\r\n                intervals: this.intervals.size,\r\n                total: this.timers.size + this.intervals.size\r\n            };\r\n        }\r\n\r\n        /**\r\n         * Liste tous les timers actifs (pour debug)\r\n         * @returns {Array} Liste des timers avec leurs infos\r\n         */\r\n        listActiveTimers() {\r\n            const list = [];\r\n\r\n            for (const [id, timer] of this.timers.entries()) {\r\n                list.push({\r\n                    id,\r\n                    type: 'timeout',\r\n                    label: timer.label,\r\n                    age: Date.now() - timer.createdAt,\r\n                    delay: timer.delay\r\n                });\r\n            }\r\n\r\n            for (const [id, interval] of this.intervals.entries()) {\r\n                list.push({\r\n                    id,\r\n                    type: 'interval',\r\n                    label: interval.label,\r\n                    age: Date.now() - interval.createdAt,\r\n                    interval: interval.interval\r\n                });\r\n            }\r\n\r\n            return list;\r\n        }\r\n\r\n        /**\r\n         * D√©truit le manager et nettoie tous les timers\r\n         */\r\n        destroy() {\r\n            this.clearAll();\r\n            if (Log) Log.info(`[TimerManager.${this.name}] Destroyed`);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Instance globale par d√©faut\r\n     */\r\n    const globalTimerManager = new TimerManager('global');\r\n\r\n    /**\r\n     * API simplifi√©e pour l'instance globale\r\n     */\r\n    GeoLeaf.Utils.TimerManager = TimerManager;\r\n    GeoLeaf.Utils.timers = {\r\n        /**\r\n         * setTimeout avec tracking global\r\n         */\r\n        setTimeout: (callback, delay, label) => globalTimerManager.setTimeout(callback, delay, label),\r\n\r\n        /**\r\n         * setInterval avec tracking global\r\n         */\r\n        setInterval: (callback, interval, label) => globalTimerManager.setInterval(callback, interval, label),\r\n\r\n        /**\r\n         * clearTimeout global\r\n         */\r\n        clearTimeout: (id) => globalTimerManager.clearTimeout(id),\r\n\r\n        /**\r\n         * clearInterval global\r\n         */\r\n        clearInterval: (id) => globalTimerManager.clearInterval(id),\r\n\r\n        /**\r\n         * Clear tous les timers globaux\r\n         */\r\n        clearAll: () => globalTimerManager.clearAll(),\r\n\r\n        /**\r\n         * Obtient les stats globales\r\n         */\r\n        getStats: () => globalTimerManager.getStats(),\r\n\r\n        /**\r\n         * Liste les timers actifs\r\n         */\r\n        listActive: () => globalTimerManager.listActiveTimers(),\r\n\r\n        /**\r\n         * Cr√©e une nouvelle instance de TimerManager pour un composant\r\n         * @param {string} name - Nom du manager\r\n         * @returns {TimerManager}\r\n         */\r\n        createManager: (name) => new TimerManager(name)\r\n    };\r\n\r\n    // Cleanup automatique avant unload de la page\r\n    if (typeof window !== 'undefined') {\r\n        window.addEventListener('beforeunload', () => {\r\n            const stats = globalTimerManager.getStats();\r\n            if (stats.total > 0) {\r\n                if (Log) Log.warn(`[TimerManager] ${stats.total} timer(s) still active at page unload`);\r\n                globalTimerManager.clearAll();\r\n            }\r\n        });\r\n    }\r\n\r\n    if (Log) Log.info('[GeoLeaf.Utils.TimerManager] Module charg√©');\r\n\r\n})(typeof window !== 'undefined' ? window : global);\r\n","/**\r\n * @fileoverview Scale utilities - compute map scale and test visibility ranges\r\n * @module utils/scale-utils\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = global.GeoLeaf = global.GeoLeaf || {};\r\n    GeoLeaf.Utils = GeoLeaf.Utils || {};\r\n\r\n    // Cache bas√© sur le zoom et la latitude pour √©viter des recalculs co√ªteux\r\n    const _scaleCache = {\r\n        zoom: null,\r\n        lat: null,\r\n        scale: null\r\n    };\r\n\r\n    /**\r\n     * Calcule l'√©chelle (1:X) de la carte pour le zoom et la latitude actuels.\r\n     * Retourne la valeur mise en cache si zoom/latitude inchang√©s.\r\n     * @param {L.Map} map\r\n     * @param {Object} [options]\r\n     * @param {boolean} [options.force=false] - Ignore le cache et recalcule\r\n     * @param {Object} [options.logger] - Logger optionnel pour debug\r\n     * @returns {number} √©chelle (ex: 5000000 pour 1:5M)\r\n     */\r\n    function calculateMapScale(map, options = {}) {\r\n        if (!map) return 0;\r\n\r\n        const logger = options.logger;\r\n        const center = map.getCenter?.();\r\n        const zoom = map.getZoom?.();\r\n\r\n        if (!center || typeof zoom !== \"number\") {\r\n            return 0;\r\n        }\r\n\r\n        // Utiliser le cache si possible\r\n        if (!options.force && _scaleCache.zoom === zoom && _scaleCache.lat === center.lat) {\r\n            return _scaleCache.scale || 0;\r\n        }\r\n\r\n        const METERS_PER_PIXEL_AT_ZOOM_0 = 156543.04;\r\n        const metersPerPixel = METERS_PER_PIXEL_AT_ZOOM_0 * Math.cos(center.lat * Math.PI / 180) / Math.pow(2, zoom);\r\n\r\n        const METERS_PER_INCH = 0.0254;\r\n        const DPI = 96;\r\n        const metersPerInch = metersPerPixel * DPI;\r\n\r\n        const scale = Math.round(metersPerInch / METERS_PER_INCH);\r\n\r\n        _scaleCache.zoom = zoom;\r\n        _scaleCache.lat = center.lat;\r\n        _scaleCache.scale = scale;\r\n\r\n        if (logger && typeof logger.debug === \"function\") {\r\n            logger.debug(`[ScaleUtils] Calcul √©chelle: zoom=${zoom}, lat=${center.lat.toFixed(2)}, √©chelle=1:${scale.toLocaleString()}`);\r\n        }\r\n\r\n        return scale;\r\n    }\r\n\r\n    /**\r\n     * V√©rifie si l'√©chelle courante est dans l'intervalle [maxScale ; minScale].\r\n     * @param {number} currentScale\r\n     * @param {number|null|undefined} minScale - √©chelle la plus large (d√©zoom)\r\n     * @param {number|null|undefined} maxScale - √©chelle la plus d√©taill√©e (zoom)\r\n     * @param {Object} [logger]\r\n     * @returns {boolean}\r\n     */\r\n    function isScaleInRange(currentScale, minScale, maxScale, logger) {\r\n        const normalizedMin = (typeof minScale === \"number\" && minScale > 0) ? minScale : null;\r\n        const normalizedMax = (typeof maxScale === \"number\" && maxScale > 0) ? maxScale : null;\r\n\r\n        if (normalizedMin !== null && currentScale > normalizedMin) {\r\n            if (logger && typeof logger.debug === \"function\") {\r\n                logger.debug(`[ScaleUtils] ${currentScale} > minScale ${normalizedMin} ‚Üí invisible (trop d√©zoom√©)`);\r\n            }\r\n            return false;\r\n        }\r\n\r\n        if (normalizedMax !== null && currentScale < normalizedMax) {\r\n            if (logger && typeof logger.debug === \"function\") {\r\n                logger.debug(`[ScaleUtils] ${currentScale} < maxScale ${normalizedMax} ‚Üí invisible (trop zoom√©)`);\r\n            }\r\n            return false;\r\n        }\r\n\r\n        if (logger && typeof logger.debug === \"function\") {\r\n            logger.debug(`[ScaleUtils] ${currentScale} dans [${normalizedMax ?? '‚àû'} ; ${normalizedMin ?? '‚àû'}] ‚Üí visible`);\r\n        }\r\n\r\n        return true;\r\n    }\r\n\r\n    function clearScaleCache() {\r\n        _scaleCache.zoom = null;\r\n        _scaleCache.lat = null;\r\n        _scaleCache.scale = null;\r\n    }\r\n\r\n    GeoLeaf.Utils.ScaleUtils = {\r\n        calculateMapScale,\r\n        isScaleInRange,\r\n        clearScaleCache\r\n    };\r\n\r\n})(window);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n/**\r\n * Style Resolver - Helper pour r√©soudre les couleurs depuis les styleRules des couches\r\n * Remplace l'ancien syst√®me category.style.json\r\n *\r\n * @module helpers/style-resolver\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    GeoLeaf.Helpers = GeoLeaf.Helpers || {};\r\n\r\n    /**\r\n     * R√©cup√®re les couleurs d'un POI depuis les styleRules de sa couche\r\n     * @param {Object} poi - POI avec properties.categoryId, properties.subCategoryId\r\n     * @param {string} layerId - ID de la couche du POI\r\n     * @returns {Object|null} - { fillColor, color } ou null si non trouv√©\r\n     */\r\n    function getColorsFromLayerStyle(poi, layerId) {\r\n        if (!poi || !layerId) return null;\r\n\r\n        // R√©cup√©rer les donn√©es de la couche\r\n        const layerData = GeoLeaf._GeoJSONShared?.state?.layers?.get(layerId);\r\n        if (!layerData) return null;\r\n\r\n        // R√©cup√©rer le currentStyle (objet charg√© en m√©moire)\r\n        const styleConfig = layerData.currentStyle;\r\n        if (!styleConfig || !styleConfig.styleRules) return null;\r\n\r\n        // Extraire categoryId et subCategoryId\r\n        const categoryId = poi.categoryId || poi.category ||\r\n            (poi.attributes && poi.attributes.categoryId) ||\r\n            (poi.properties && poi.properties.categoryId) ||\r\n            (poi.properties && poi.properties.category);\r\n\r\n        const subCategoryId = poi.subCategoryId || poi.subCategory || poi.sub_category ||\r\n            (poi.attributes && poi.attributes.subCategoryId) ||\r\n            (poi.properties && poi.properties.subCategoryId) ||\r\n            (poi.properties && poi.properties.sub_category);\r\n\r\n        // Chercher dans les styleRules\r\n        // Priorit√© 1 : subCategoryId\r\n        if (subCategoryId) {\r\n            const rule = styleConfig.styleRules.find(r =>\r\n                r.when &&\r\n                r.when.field === \"properties.subCategoryId\" &&\r\n                r.when.value === subCategoryId\r\n            );\r\n            if (rule && rule.style) {\r\n                return {\r\n                    fillColor: rule.style.fillColor,\r\n                    color: rule.style.color,\r\n                    colorFill: rule.style.fillColor,\r\n                    colorStroke: rule.style.color\r\n                };\r\n            }\r\n        }\r\n\r\n        // Priorit√© 2 : categoryId\r\n        if (categoryId) {\r\n            const rule = styleConfig.styleRules.find(r =>\r\n                r.when &&\r\n                r.when.field === \"properties.categoryId\" &&\r\n                r.when.value === categoryId\r\n            );\r\n            if (rule && rule.style) {\r\n                return {\r\n                    fillColor: rule.style.fillColor,\r\n                    color: rule.style.color,\r\n                    colorFill: rule.style.fillColor,\r\n                    colorStroke: rule.style.color\r\n                };\r\n            }\r\n        }\r\n\r\n        // Fallback : defaultStyle\r\n        if (styleConfig.defaultStyle) {\r\n            return {\r\n                fillColor: styleConfig.defaultStyle.fillColor,\r\n                color: styleConfig.defaultStyle.color,\r\n                colorFill: styleConfig.defaultStyle.fillColor,\r\n                colorStroke: styleConfig.defaultStyle.color\r\n            };\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    /**\r\n     * R√©cup√®re les couleurs en fonction du style actif de la couche\r\n     * Cette fonction remplace l'ancien getCategoryStyles()\r\n     * @param {Object} poi - POI avec _layerConfig\r\n     * @returns {Object} - { colorFill, colorStroke, colorRoute }\r\n     */\r\n    function resolvePoiColors(poi) {\r\n        const colors = {\r\n            colorFill: null,\r\n            colorStroke: null,\r\n            colorRoute: null\r\n        };\r\n\r\n        if (!poi || !poi._layerConfig) return colors;\r\n\r\n        const layerId = poi._layerConfig.id;\r\n        const styleColors = getColorsFromLayerStyle(poi, layerId);\r\n\r\n        if (styleColors) {\r\n            colors.colorFill = styleColors.fillColor || styleColors.colorFill;\r\n            colors.colorStroke = styleColors.color || styleColors.colorStroke;\r\n            colors.colorRoute = styleColors.color || styleColors.colorStroke;\r\n        }\r\n\r\n        return colors;\r\n    }\r\n\r\n    // Exposer dans l'espace de noms\r\n    GeoLeaf.Helpers.StyleResolver = {\r\n        getColorsFromLayerStyle: getColorsFromLayerStyle,\r\n        resolvePoiColors: resolvePoiColors\r\n    };\r\n\r\n})(window);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n/**\r\n * @fileoverview Validations des r√®gles de style (styleRules, conditions, scales)\r\n * Extrait de style-validator.js pour r√©duire la complexit√©\r\n * @module validators/style-validator-rules\r\n */\r\n\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = global.GeoLeaf = global.GeoLeaf || {};\r\n    GeoLeaf._StyleValidatorRules = GeoLeaf._StyleValidatorRules || {};\r\n\r\n    /**\r\n     * Valide les styleRules (r√®gles conditionnelles de style)\r\n     * V√©rifie la structure when/style de chaque r√®gle et valide les conditions\r\n     *\r\n     * @param {Array<Object>} rules - Tableau de r√®gles styleRules\r\n     * @param {Object} rules[].when - Condition d'application (simple ou compos√©e avec \"all\")\r\n     * @param {Object} rules[].style - Style √† appliquer si condition vraie\r\n     * @param {Object} [rules[].legend] - Info l√©gende optionnelle pour cette r√®gle\r\n     * @param {Array<Object>} errors - Tableau d'erreurs √† remplir (modifi√© in-place)\r\n     * @param {Array<Object>} warnings - Tableau d'avertissements √† remplir (modifi√© in-place)\r\n     * @param {Object} context - Contexte additionnel (profileId, layerId, etc.)\r\n     * @returns {void} Modifie errors/warnings directement\r\n     * @example\r\n     * const rules = [\r\n     *   { when: { field: 'population', operator: '>', value: 100000 }, style: { color: '#ff0000' } },\r\n     *   { when: { all: [{ field: 'type', operator: '==', value: 'city' }] }, style: { weight: 3 } }\r\n     * ];\r\n     * const errors = [], warnings = [];\r\n     * GeoLeaf._StyleValidatorRules.validateStyleRules(rules, errors, warnings, { layerId: 'cities' });\r\n     */\r\n    GeoLeaf._StyleValidatorRules.validateStyleRules = function (rules, errors, warnings, context) {\r\n        if (!Array.isArray(rules)) {\r\n            errors.push({\r\n                field: 'styleRules',\r\n                message: `styleRules doit √™tre un tableau`,\r\n                context: { received: typeof rules, ...context }\r\n            });\r\n            return;\r\n        }\r\n\r\n        rules.forEach((rule, index) => {\r\n            const ruleContext = { ...context, ruleIndex: index };\r\n\r\n            if (typeof rule !== 'object' || rule === null) {\r\n                errors.push({\r\n                    field: `styleRules[${index}]`,\r\n                    message: `La r√®gle doit √™tre un objet`,\r\n                    context: ruleContext\r\n                });\r\n                return;\r\n            }\r\n\r\n            // Validation when\r\n            if (!rule.when) {\r\n                errors.push({\r\n                    field: `styleRules[${index}].when`,\r\n                    message: `Le champ 'when' est requis`,\r\n                    context: ruleContext\r\n                });\r\n            } else {\r\n                GeoLeaf._StyleValidatorRules.validateWhenCondition(rule.when, index, errors, warnings, ruleContext);\r\n            }\r\n\r\n            // Validation style\r\n            if (!rule.style) {\r\n                errors.push({\r\n                    field: `styleRules[${index}].style`,\r\n                    message: `Le champ 'style' est requis`,\r\n                    context: ruleContext\r\n                });\r\n            } else if (typeof rule.style !== 'object' || rule.style === null) {\r\n                errors.push({\r\n                    field: `styleRules[${index}].style`,\r\n                    message: `Le style doit √™tre un objet`,\r\n                    context: { received: typeof rule.style, ...ruleContext }\r\n                });\r\n            }\r\n\r\n            // Validation legend (optionnel)\r\n            if (rule.legend && typeof rule.legend !== 'object') {\r\n                errors.push({\r\n                    field: `styleRules[${index}].legend`,\r\n                    message: `legend doit √™tre un objet`,\r\n                    context: { received: typeof rule.legend, ...ruleContext }\r\n                });\r\n            }\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Valide la condition when d'une r√®gle\r\n     * Supporte conditions simples et compos√©es avec op√©rateur \"all\" (ET logique)\r\n     *\r\n     * @param {Object} when - Objet de condition when\r\n     * @param {string} [when.field] - Champ √† tester (mode simple)\r\n     * @param {string} [when.operator] - Op√©rateur de comparaison (mode simple)\r\n     * @param {*} [when.value] - Valeur de r√©f√©rence (mode simple)\r\n     * @param {Array<Object>} [when.all] - Tableau de conditions (mode compos√©, ET logique)\r\n     * @param {number} ruleIndex - Index de la r√®gle dans styleRules (pour messages d'erreur)\r\n     * @param {Array<Object>} errors - Tableau d'erreurs\r\n     * @param {Array<Object>} warnings - Tableau d'avertissements\r\n     * @param {Object} context - Contexte\r\n     * @returns {void}\r\n     * @example\r\n     * // Condition simple\r\n     * const when1 = { field: 'population', operator: '>', value: 50000 };\r\n     * // Condition compos√©e (AND)\r\n     * const when2 = { all: [\r\n     *   { field: 'type', operator: '==', value: 'restaurant' },\r\n     *   { field: 'rating', operator: '>=', value: 4 }\r\n     * ]};\r\n     */\r\n    GeoLeaf._StyleValidatorRules.validateWhenCondition = function (when, ruleIndex, errors, warnings, context) {\r\n        if (typeof when !== 'object' || when === null) {\r\n            errors.push({\r\n                field: `styleRules[${ruleIndex}].when`,\r\n                message: `when doit √™tre un objet`,\r\n                context: { received: typeof when, ...context }\r\n            });\r\n            return;\r\n        }\r\n\r\n        // Support pour conditions compos√©es avec \"all\"\r\n        if (when.all && Array.isArray(when.all)) {\r\n            // Valider chaque condition dans le tableau \"all\"\r\n            when.all.forEach((condition, condIndex) => {\r\n                GeoLeaf._StyleValidatorRules.validateSimpleCondition(condition, ruleIndex, condIndex, errors, context);\r\n            });\r\n            return;\r\n        }\r\n\r\n        // Support pour conditions simples\r\n        GeoLeaf._StyleValidatorRules.validateSimpleCondition(when, ruleIndex, null, errors, context);\r\n    };\r\n\r\n    /**\r\n     * Valide une condition simple (field/operator/value)\r\n     * V√©rifie la pr√©sence des champs requis et la validit√© de l'op√©rateur\r\n     *\r\n     * @param {Object} condition - Condition √† valider\r\n     * @param {string} condition.field - Nom du champ de feature √† tester (ex: 'properties.population')\r\n     * @param {string} condition.operator - Op√©rateur: '==', '!=', '<', '>', '<=', '>=', 'in', 'contains'\r\n     * @param {*} condition.value - Valeur de r√©f√©rence (string, number, array selon op√©rateur)\r\n     * @param {number} ruleIndex - Index de la r√®gle dans styleRules\r\n     * @param {number|null} condIndex - Index de la condition dans \"all\" (null si condition simple)\r\n     * @param {Array<Object>} errors - Tableau d'erreurs\r\n     * @param {Object} context - Contexte\r\n     * @returns {void}\r\n     * @example\r\n     * const condition = { field: 'properties.type', operator: 'in', value: ['hotel', 'restaurant'] };\r\n     * validateSimpleCondition(condition, 0, null, errors, {});\r\n     */\r\n    GeoLeaf._StyleValidatorRules.validateSimpleCondition = function (condition, ruleIndex, condIndex = null, errors, context) {\r\n        // Champs requis\r\n        const required = ['field', 'operator', 'value'];\r\n        for (const field of required) {\r\n            if (!(field in condition)) {\r\n                const prefix = condIndex !== null ? `styleRules[${ruleIndex}].when.all[${condIndex}]` : `styleRules[${ruleIndex}].when`;\r\n                errors.push({\r\n                    field: `${prefix}.${field}`,\r\n                    message: `Le champ '${field}' est requis dans la condition`,\r\n                    context\r\n                });\r\n            }\r\n        }\r\n\r\n        // Validation operator\r\n        const validOperators = ['==', '!=', '<', '>', '<=', '>=', 'in', 'contains'];\r\n        if (condition.operator && !validOperators.includes(condition.operator)) {\r\n            const prefix = condIndex !== null ? `styleRules[${ruleIndex}].when.all[${condIndex}]` : `styleRules[${ruleIndex}].when`;\r\n            errors.push({\r\n                field: `${prefix}.operator`,\r\n                message: `Op√©rateur invalide`,\r\n                context: { received: condition.operator, allowed: validOperators, ...context }\r\n            });\r\n        }\r\n\r\n        // Validation field\r\n        if (condition.field && typeof condition.field !== 'string') {\r\n            const prefix = condIndex !== null ? `styleRules[${ruleIndex}].when.all[${condIndex}]` : `styleRules[${ruleIndex}].when`;\r\n            errors.push({\r\n                field: `${prefix}.field`,\r\n                message: `field doit √™tre une cha√Æne de caract√®res`,\r\n                context: { received: typeof condition.field, ...context }\r\n            });\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Valide les √©chelles (layerScale, labelScale)\r\n     * V√©rifie la structure des objets d'√©chelle et la validit√© des valeurs min/max\r\n     *\r\n     * @param {Object} styleData - Donn√©es du style\r\n     * @param {Object} [styleData.layerScale] - √âchelle de visibilit√© de la couche\r\n     * @param {number|null} [styleData.layerScale.minScale] - Zoom minimum (ou null = pas de limite)\r\n     * @param {number|null} [styleData.layerScale.maxScale] - Zoom maximum (ou null = pas de limite)\r\n     * @param {Object} [styleData.labelScale] - √âchelle de visibilit√© des labels\r\n     * @param {Array<Object>} errors - Tableau d'erreurs\r\n     * @param {Array<Object>} warnings - Tableau d'avertissements\r\n     * @param {Object} context - Contexte\r\n     * @returns {void}\r\n     * @example\r\n     * const styleData = {\r\n     *   layerScale: { minScale: 10, maxScale: 18 },  // Visible du zoom 10 √† 18\r\n     *   labelScale: { minScale: 14, maxScale: null }  // Labels visibles √† partir du zoom 14\r\n     * };\r\n     */\r\n    GeoLeaf._StyleValidatorRules.validateScales = function (styleData, errors, warnings, context) {\r\n        ['layerScale', 'labelScale'].forEach(scaleField => {\r\n            const isRequired = scaleField === 'layerScale';\r\n\r\n            if (!styleData[scaleField]) {\r\n                if (isRequired) {\r\n                    errors.push({\r\n                        field: scaleField,\r\n                        message: `${scaleField} est requis`,\r\n                        context\r\n                    });\r\n                }\r\n                return;\r\n            }\r\n\r\n            const scale = styleData[scaleField];\r\n            if (typeof scale !== 'object' || scale === null) {\r\n                errors.push({\r\n                    field: scaleField,\r\n                    message: `${scaleField} doit √™tre un objet`,\r\n                    context: { received: typeof scale, ...context }\r\n                });\r\n                return;\r\n            }\r\n\r\n            ['minScale', 'maxScale'].forEach(prop => {\r\n                if (!(prop in scale)) {\r\n                    if (isRequired) {\r\n                        errors.push({\r\n                            field: `${scaleField}.${prop}`,\r\n                            message: `${prop} est requis dans ${scaleField}`,\r\n                            context\r\n                        });\r\n                    }\r\n                    return;\r\n                }\r\n\r\n                if (scale[prop] !== null) {\r\n                    if (typeof scale[prop] !== 'number' || scale[prop] < 0) {\r\n                        errors.push({\r\n                            field: `${scaleField}.${prop}`,\r\n                            message: `${prop} doit √™tre un nombre >= 0 ou null`,\r\n                            context: { received: scale[prop], ...context }\r\n                        });\r\n                    }\r\n                }\r\n            });\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Valide la configuration legend\r\n     * V√©rifie la structure et les types des propri√©t√©s de l√©gende\r\n     *\r\n     * @param {Object} legend - Configuration legend\r\n     * @param {number} [legend.order] - Ordre d'affichage dans la l√©gende (doit √™tre entier)\r\n     * @param {string} [legend.label] - Label √† afficher dans la l√©gende\r\n     * @param {string} [legend.description] - Description compl√©mentaire\r\n     * @param {Array<Object>} errors - Tableau d'erreurs\r\n     * @param {Array<Object>} warnings - Tableau d'avertissements\r\n     * @param {Object} context - Contexte\r\n     * @returns {void}\r\n     * @example\r\n     * const legend = { order: 1, label: 'Grandes villes', description: 'Population > 100k' };\r\n     */\r\n    GeoLeaf._StyleValidatorRules.validateLegend = function (legend, errors, warnings, context) {\r\n        if (typeof legend !== 'object' || legend === null) {\r\n            errors.push({\r\n                field: 'legend',\r\n                message: `legend doit √™tre un objet`,\r\n                context: { received: typeof legend, ...context }\r\n            });\r\n            return;\r\n        }\r\n\r\n        if ('order' in legend && !Number.isInteger(legend.order)) {\r\n            errors.push({\r\n                field: 'legend.order',\r\n                message: `order doit √™tre un entier`,\r\n                context: { received: legend.order, type: typeof legend.order, ...context }\r\n            });\r\n        }\r\n    };\r\n\r\n})(window);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n/**\r\n * @fileoverview Validateur de fichiers de style GeoLeaf\r\n * Valide les fichiers style.json contre le sch√©ma JSON d√©fini\r\n * et g√©n√®re des erreurs d√©taill√©es avec contexte pour faciliter le debugging\r\n * @module validators/style-validator\r\n */\r\n\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = global.GeoLeaf = global.GeoLeaf || {};\r\n\r\n// Import du sch√©ma (sera charg√© dynamiquement si n√©cessaire)\r\n// const styleSchema = require('../../../../schema/style.schema.json');\r\n\r\n/**\r\n * Classe d'erreur pour les validations de style\r\n */\r\nclass StyleValidationError extends Error {\r\n    constructor(message, context = {}) {\r\n        super(message);\r\n        this.name = 'StyleValidationError';\r\n        this.context = context;\r\n    }\r\n}\r\n\r\n/**\r\n * Valide un objet de style contre le sch√©ma JSON\r\n * @param {Object} styleData - Donn√©es du style √† valider\r\n * @param {Object} context - Contexte additionnel (profileId, layerId, styleId)\r\n * @returns {Object} R√©sultat de validation { valid: boolean, errors: Array, warnings: Array }\r\n */\r\nfunction validateStyle(styleData, context = {}) {\r\n    const errors = [];\r\n    const warnings = [];\r\n\r\n    try {\r\n        // Validation de base: objet requis\r\n        if (!styleData || typeof styleData !== 'object') {\r\n            errors.push({\r\n                field: 'root',\r\n                message: 'Le style doit √™tre un objet JSON valide',\r\n                context: { received: typeof styleData, ...context }\r\n            });\r\n            return { valid: false, errors, warnings };\r\n        }\r\n\r\n        // Validation des champs requis\r\n        validateRequiredFields(styleData, errors, context);\r\n\r\n        // Validation du format de l'ID\r\n        validateId(styleData, errors, context);\r\n\r\n        // Validation du champ label (string ou objet)\r\n        validateLabel(styleData, errors, warnings, context);\r\n\r\n        // Validation du style de base\r\n        validateBaseStyle(styleData, errors, warnings, context);\r\n\r\n        // Validation des styleRules si pr√©sentes\r\n        if (styleData.styleRules) {\r\n            validateStyleRules(styleData.styleRules, errors, warnings, context);\r\n        }\r\n\r\n        // Validation des √©chelles\r\n        validateScales(styleData, errors, warnings, context);\r\n\r\n        // Validation de la l√©gende\r\n        if (styleData.legend) {\r\n            validateLegend(styleData.legend, errors, warnings, context);\r\n        }\r\n\r\n    } catch (error) {\r\n        errors.push({\r\n            field: 'validation',\r\n            message: `Erreur inattendue lors de la validation: ${error.message}`,\r\n            stack: error.stack,\r\n            context\r\n        });\r\n    }\r\n\r\n    return {\r\n        valid: errors.length === 0,\r\n        errors,\r\n        warnings\r\n    };\r\n}\r\n\r\n/**\r\n * Valide les champs requis\r\n */\r\nfunction validateRequiredFields(styleData, errors, context) {\r\n    // V√©rifier l'ID (obligatoire)\r\n    if (!('id' in styleData) || styleData.id === undefined || styleData.id === null) {\r\n        errors.push({\r\n            field: 'id',\r\n            message: `Le champ requis 'id' est manquant`,\r\n            context: { availableFields: Object.keys(styleData), ...context }\r\n        });\r\n    }\r\n\r\n    // V√©rifier que 'style' OU 'defaultStyle' est pr√©sent (au moins un des deux)\r\n    const hasStyle = ('style' in styleData) && styleData.style !== undefined && styleData.style !== null;\r\n    const hasDefaultStyle = ('defaultStyle' in styleData) && styleData.defaultStyle !== undefined && styleData.defaultStyle !== null;\r\n\r\n    if (!hasStyle && !hasDefaultStyle) {\r\n        errors.push({\r\n            field: 'style',\r\n            message: `Le champ requis 'style' ou 'defaultStyle' est manquant`,\r\n            context: { availableFields: Object.keys(styleData), ...context }\r\n        });\r\n    }\r\n\r\n    if (!('layerScale' in styleData)) {\r\n        errors.push({\r\n            field: 'layerScale',\r\n            message: `Le champ requis 'layerScale' est manquant`,\r\n            context: { availableFields: Object.keys(styleData), ...context }\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Valide le format de l'ID\r\n */\r\nfunction validateId(styleData, errors, context) {\r\n    if (!styleData.id) return;\r\n\r\n    // Pattern acceptant lettres (y compris accentu√©es), chiffres, tirets et underscores\r\n    // \\p{L} = toutes les lettres Unicode (y compris √©, √†, √±, etc.)\r\n    const idPattern = /^[\\p{L}0-9_-]+$/u;\r\n    if (typeof styleData.id !== 'string') {\r\n        errors.push({\r\n            field: 'id',\r\n            message: `L'ID doit √™tre une cha√Æne de caract√®res`,\r\n            context: { received: typeof styleData.id, value: styleData.id, ...context }\r\n        });\r\n    } else if (!idPattern.test(styleData.id)) {\r\n        errors.push({\r\n            field: 'id',\r\n            message: `L'ID doit contenir uniquement des lettres, chiffres, tirets et underscores`,\r\n            context: { received: styleData.id, pattern: idPattern.toString(), ...context }\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Valide le champ label (peut √™tre string ou objet de config label)\r\n */\r\nfunction validateLabel(styleData, errors, warnings, context) {\r\n    if (!('label' in styleData)) return;\r\n\r\n    const label = styleData.label;\r\n\r\n    // String: nom d'affichage\r\n    if (typeof label === 'string') {\r\n        return;\r\n    }\r\n\r\n    // Objet: configuration de labels int√©gr√©s\r\n    if (typeof label === 'object' && label !== null) {\r\n        // enabled est requis\r\n        if (!('enabled' in label)) {\r\n            errors.push({\r\n                field: 'label.enabled',\r\n                message: `Le champ 'enabled' est requis dans la configuration de labels`,\r\n                context: { labelConfig: label, ...context }\r\n            });\r\n        } else if (typeof label.enabled !== 'boolean') {\r\n            errors.push({\r\n                field: 'label.enabled',\r\n                message: `Le champ 'enabled' doit √™tre un bool√©en`,\r\n                context: { received: typeof label.enabled, value: label.enabled, ...context }\r\n            });\r\n        }\r\n\r\n        // Si enabled, field devrait √™tre pr√©sent\r\n        if (label.enabled && !label.field) {\r\n            warnings.push({\r\n                field: 'label.field',\r\n                message: `Les labels sont activ√©s mais aucun champ n'est sp√©cifi√©`,\r\n                context: { labelConfig: label, ...context }\r\n            });\r\n        }\r\n\r\n        // Validation font\r\n        if (label.font) {\r\n            validateFont(label.font, errors, warnings, context);\r\n        }\r\n\r\n        // Validation des couleurs\r\n        if (label.color && !isValidHexColor(label.color)) {\r\n            errors.push({\r\n                field: 'label.color',\r\n                message: `Couleur invalide, format attendu: #RRGGBB`,\r\n                context: { received: label.color, ...context }\r\n            });\r\n        }\r\n\r\n        // Validation opacity\r\n        if ('opacity' in label && (typeof label.opacity !== 'number' || label.opacity < 0 || label.opacity > 1)) {\r\n            errors.push({\r\n                field: 'label.opacity',\r\n                message: `L'opacit√© doit √™tre un nombre entre 0 et 1`,\r\n                context: { received: label.opacity, ...context }\r\n            });\r\n        }\r\n\r\n        // Validation buffer\r\n        if (label.buffer) {\r\n            validateLabelComponent(label.buffer, 'label.buffer', errors, warnings, context);\r\n        }\r\n\r\n        // Validation background\r\n        if (label.background) {\r\n            validateLabelComponent(label.background, 'label.background', errors, warnings, context);\r\n        }\r\n\r\n        // Validation offset\r\n        if (label.offset && typeof label.offset.distancePx !== 'undefined') {\r\n            if (typeof label.offset.distancePx !== 'number') {\r\n                errors.push({\r\n                    field: 'label.offset.distancePx',\r\n                    message: `distancePx doit √™tre un nombre`,\r\n                    context: { received: typeof label.offset.distancePx, ...context }\r\n                });\r\n            }\r\n        }\r\n\r\n        return;\r\n    }\r\n\r\n    // Type invalide\r\n    errors.push({\r\n        field: 'label',\r\n        message: `Le champ 'label' doit √™tre une cha√Æne de caract√®res ou un objet de configuration`,\r\n        context: { received: typeof label, value: label, ...context }\r\n    });\r\n}\r\n\r\n/**\r\n * Valide la configuration font\r\n */\r\nfunction validateFont(font, errors, warnings, context) {\r\n    if (typeof font !== 'object' || font === null) {\r\n        errors.push({\r\n            field: 'label.font',\r\n            message: `La configuration font doit √™tre un objet`,\r\n            context: { received: typeof font, ...context }\r\n        });\r\n        return;\r\n    }\r\n\r\n    if (font.sizePt !== undefined) {\r\n        if (typeof font.sizePt !== 'number' || font.sizePt < 1) {\r\n            errors.push({\r\n                field: 'label.font.sizePt',\r\n                message: `sizePt doit √™tre un nombre >= 1`,\r\n                context: { received: font.sizePt, ...context }\r\n            });\r\n        }\r\n    }\r\n\r\n    if (font.weight !== undefined) {\r\n        if (!Number.isInteger(font.weight) || font.weight < 0 || font.weight > 100) {\r\n            errors.push({\r\n                field: 'label.font.weight',\r\n                message: `weight doit √™tre un entier entre 0 et 100`,\r\n                context: { received: font.weight, ...context }\r\n            });\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * Valide un composant de label (buffer, background)\r\n */\r\nfunction validateLabelComponent(component, fieldPath, errors, warnings, context) {\r\n    if (typeof component !== 'object' || component === null) {\r\n        errors.push({\r\n            field: fieldPath,\r\n            message: `${fieldPath} doit √™tre un objet`,\r\n            context: { received: typeof component, ...context }\r\n        });\r\n        return;\r\n    }\r\n\r\n    if (component.color && !isValidHexColor(component.color)) {\r\n        errors.push({\r\n            field: `${fieldPath}.color`,\r\n            message: `Couleur invalide, format attendu: #RRGGBB`,\r\n            context: { received: component.color, ...context }\r\n        });\r\n    }\r\n\r\n    if ('opacity' in component && (typeof component.opacity !== 'number' || component.opacity < 0 || component.opacity > 1)) {\r\n        errors.push({\r\n            field: `${fieldPath}.opacity`,\r\n            message: `L'opacit√© doit √™tre un nombre entre 0 et 1`,\r\n            context: { received: component.opacity, ...context }\r\n        });\r\n    }\r\n\r\n    if ('sizePx' in component && (typeof component.sizePx !== 'number' || component.sizePx < 0)) {\r\n        errors.push({\r\n            field: `${fieldPath}.sizePx`,\r\n            message: `sizePx doit √™tre un nombre >= 0`,\r\n            context: { received: component.sizePx, ...context }\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Valide le style de base\r\n */\r\nfunction validateBaseStyle(styleData, errors, warnings, context) {\r\n    const style = styleData.style || styleData.defaultStyle;\r\n\r\n    if (!style) return;\r\n\r\n    if (typeof style !== 'object' || style === null) {\r\n        errors.push({\r\n            field: 'style',\r\n            message: `Le style doit √™tre un objet`,\r\n            context: { received: typeof style, ...context }\r\n        });\r\n        return;\r\n    }\r\n\r\n    // Validation des couleurs\r\n    ['fillColor', 'color'].forEach(colorField => {\r\n        if (style[colorField] && !isValidHexColor(style[colorField])) {\r\n            errors.push({\r\n                field: `style.${colorField}`,\r\n                message: `Couleur invalide, format attendu: #RRGGBB`,\r\n                context: { received: style[colorField], ...context }\r\n            });\r\n        }\r\n    });\r\n\r\n    // Validation des opacit√©s\r\n    ['fillOpacity', 'opacity'].forEach(opacityField => {\r\n        if (opacityField in style) {\r\n            if (typeof style[opacityField] !== 'number' || style[opacityField] < 0 || style[opacityField] > 1) {\r\n                errors.push({\r\n                    field: `style.${opacityField}`,\r\n                    message: `${opacityField} doit √™tre un nombre entre 0 et 1`,\r\n                    context: { received: style[opacityField], ...context }\r\n                });\r\n            }\r\n        }\r\n    });\r\n\r\n    // Validation des tailles\r\n    ['weight', 'sizePx', 'radius'].forEach(sizeField => {\r\n        if (sizeField in style) {\r\n            if (typeof style[sizeField] !== 'number' || style[sizeField] < 0) {\r\n                errors.push({\r\n                    field: `style.${sizeField}`,\r\n                    message: `${sizeField} doit √™tre un nombre >= 0`,\r\n                    context: { received: style[sizeField], ...context }\r\n                });\r\n            }\r\n        }\r\n    });\r\n\r\n    // Validation shape (points)\r\n    if (style.shape && !['circle', 'square'].includes(style.shape)) {\r\n        errors.push({\r\n            field: 'style.shape',\r\n            message: `shape doit √™tre 'circle' ou 'square'`,\r\n            context: { received: style.shape, allowed: ['circle', 'square'], ...context }\r\n        });\r\n    }\r\n\r\n    // Validation stroke (lignes)\r\n    if (style.stroke) {\r\n        validateStroke(style.stroke, errors, warnings, context);\r\n    }\r\n\r\n    // Validation casing (lignes)\r\n    if (style.casing) {\r\n        validateCasing(style.casing, errors, warnings, context);\r\n    }\r\n\r\n    // Validation fillPattern (polygones)\r\n    if (style.fillPattern) {\r\n        validateFillPattern(style.fillPattern, errors, warnings, context);\r\n    }\r\n}\r\n\r\n/**\r\n * Valide le stroke (lignes)\r\n */\r\nfunction validateStroke(stroke, errors, warnings, context) {\r\n    if (typeof stroke !== 'object' || stroke === null) {\r\n        errors.push({\r\n            field: 'style.stroke',\r\n            message: `stroke doit √™tre un objet`,\r\n            context: { received: typeof stroke, ...context }\r\n        });\r\n        return;\r\n    }\r\n\r\n    if (stroke.color && !isValidHexColor(stroke.color)) {\r\n        errors.push({\r\n            field: 'style.stroke.color',\r\n            message: `Couleur invalide, format attendu: #RRGGBB`,\r\n            context: { received: stroke.color, ...context }\r\n        });\r\n    }\r\n\r\n    if ('opacity' in stroke && (typeof stroke.opacity !== 'number' || stroke.opacity < 0 || stroke.opacity > 1)) {\r\n        errors.push({\r\n            field: 'style.stroke.opacity',\r\n            message: `opacity doit √™tre un nombre entre 0 et 1`,\r\n            context: { received: stroke.opacity, ...context }\r\n        });\r\n    }\r\n\r\n    if ('weight' in stroke && (typeof stroke.weight !== 'number' || stroke.weight < 0)) {\r\n        errors.push({\r\n            field: 'style.stroke.weight',\r\n            message: `weight doit √™tre un nombre >= 0`,\r\n            context: { received: stroke.weight, ...context }\r\n        });\r\n    }\r\n\r\n    if (stroke.dashArray !== null && stroke.dashArray !== undefined && typeof stroke.dashArray !== 'string') {\r\n        errors.push({\r\n            field: 'style.stroke.dashArray',\r\n            message: `dashArray doit √™tre une cha√Æne de caract√®res ou null`,\r\n            context: { received: typeof stroke.dashArray, value: stroke.dashArray, ...context }\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Valide le casing (lignes)\r\n */\r\nfunction validateCasing(casing, errors, warnings, context) {\r\n    if (typeof casing !== 'object' || casing === null) {\r\n        errors.push({\r\n            field: 'style.casing',\r\n            message: `casing doit √™tre un objet`,\r\n            context: { received: typeof casing, ...context }\r\n        });\r\n        return;\r\n    }\r\n\r\n    if ('enabled' in casing && typeof casing.enabled !== 'boolean') {\r\n        errors.push({\r\n            field: 'style.casing.enabled',\r\n            message: `enabled doit √™tre un bool√©en`,\r\n            context: { received: typeof casing.enabled, ...context }\r\n        });\r\n    }\r\n\r\n    if (casing.color && !isValidHexColor(casing.color)) {\r\n        errors.push({\r\n            field: 'style.casing.color',\r\n            message: `Couleur invalide, format attendu: #RRGGBB`,\r\n            context: { received: casing.color, ...context }\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Valide le fillPattern (polygones)\r\n */\r\nfunction validateFillPattern(pattern, errors, warnings, context) {\r\n    if (typeof pattern !== 'object' || pattern === null) {\r\n        errors.push({\r\n            field: 'style.fillPattern',\r\n            message: `fillPattern doit √™tre un objet`,\r\n            context: { received: typeof pattern, ...context }\r\n        });\r\n        return;\r\n    }\r\n\r\n    if ('enabled' in pattern && typeof pattern.enabled !== 'boolean') {\r\n        errors.push({\r\n            field: 'style.fillPattern.enabled',\r\n            message: `enabled doit √™tre un bool√©en`,\r\n            context: { received: typeof pattern.enabled, ...context }\r\n        });\r\n    }\r\n\r\n    if (pattern.type && !['diagonal', 'horizontal', 'vertical', 'cross', 'x'].includes(pattern.type)) {\r\n        errors.push({\r\n            field: 'style.fillPattern.type',\r\n            message: `type doit √™tre parmi: diagonal, horizontal, vertical, cross, x`,\r\n            context: { received: pattern.type, allowed: ['diagonal', 'horizontal', 'vertical', 'cross', 'x'], ...context }\r\n        });\r\n    }\r\n\r\n    if (pattern.color && !isValidHexColor(pattern.color)) {\r\n        errors.push({\r\n            field: 'style.fillPattern.color',\r\n            message: `Couleur invalide, format attendu: #RRGGBB`,\r\n            context: { received: pattern.color, ...context }\r\n        });\r\n    }\r\n\r\n    ['weight', 'density'].forEach(field => {\r\n        if (field in pattern && (typeof pattern[field] !== 'number' || pattern[field] < 0)) {\r\n            errors.push({\r\n                field: `style.fillPattern.${field}`,\r\n                message: `${field} doit √™tre un nombre >= 0`,\r\n                context: { received: pattern[field], ...context }\r\n            });\r\n        }\r\n    });\r\n}\r\n\r\n/**\r\n * Valide les styleRules\r\n */\r\n/**\r\n * @deprecated Utiliser GeoLeaf._StyleValidatorRules.validateStyleRules()\r\n */\r\nfunction validateStyleRules(rules, errors, warnings, context) {\r\n    return GeoLeaf._StyleValidatorRules.validateStyleRules(rules, errors, warnings, context);\r\n}\r\n\r\n/**\r\n * @deprecated Utiliser GeoLeaf._StyleValidatorRules.validateWhenCondition()\r\n */\r\nfunction validateWhenCondition(when, ruleIndex, errors, warnings, context) {\r\n    return GeoLeaf._StyleValidatorRules.validateWhenCondition(when, ruleIndex, errors, warnings, context);\r\n}\r\n\r\n/**\r\n * @deprecated Utiliser GeoLeaf._StyleValidatorRules.validateSimpleCondition()\r\n */\r\nfunction validateSimpleCondition(condition, ruleIndex, condIndex = null, errors, context) {\r\n    return GeoLeaf._StyleValidatorRules.validateSimpleCondition(condition, ruleIndex, condIndex, errors, context);\r\n}\r\n\r\n/**\r\n * @deprecated Utiliser GeoLeaf._StyleValidatorRules.validateScales()\r\n */\r\nfunction validateScales(styleData, errors, warnings, context) {\r\n    return GeoLeaf._StyleValidatorRules.validateScales(styleData, errors, warnings, context);\r\n}\r\n\r\n/**\r\n * @deprecated Utiliser GeoLeaf._StyleValidatorRules.validateLegend()\r\n */\r\nfunction validateLegend(legend, errors, warnings, context) {\r\n    return GeoLeaf._StyleValidatorRules.validateLegend(legend, errors, warnings, context);\r\n}\r\n\r\n/**\r\n * V√©rifie si une couleur est au format hex valide (#RRGGBB)\r\n */\r\nfunction isValidHexColor(color) {\r\n    return typeof color === 'string' && /^#[0-9A-Fa-f]{6}$/.test(color);\r\n}\r\n\r\n/**\r\n * Formate un r√©sultat de validation en message d'erreur lisible\r\n * @param {Object} validationResult - R√©sultat de validateStyle()\r\n * @param {string} styleFilePath - Chemin du fichier de style (optionnel)\r\n * @returns {string} Message format√©\r\n */\r\nfunction formatValidationErrors(validationResult, styleFilePath = '') {\r\n    if (validationResult.valid) {\r\n        return null;\r\n    }\r\n\r\n    const lines = [];\r\n    lines.push('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');\r\n    lines.push('‚ùå ERREUR DE VALIDATION DE STYLE GEOLEAF');\r\n    lines.push('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');\r\n\r\n    if (styleFilePath) {\r\n        lines.push(`Fichier: ${styleFilePath}`);\r\n        lines.push('');\r\n    }\r\n\r\n    if (validationResult.errors.length > 0) {\r\n        lines.push(`‚ùå ${validationResult.errors.length} erreur(s) d√©tect√©e(s):`);\r\n        lines.push('');\r\n\r\n        validationResult.errors.forEach((error, index) => {\r\n            lines.push(`  ${index + 1}. Champ: ${error.field}`);\r\n            lines.push(`     Message: ${error.message}`);\r\n            if (error.context) {\r\n                lines.push(`     Contexte: ${JSON.stringify(error.context, null, 2).split('\\n').join('\\n     ')}`);\r\n            }\r\n            if (error.stack) {\r\n                lines.push(`     Stack: ${error.stack.split('\\n').slice(0, 3).join('\\n     ')}`);\r\n            }\r\n            lines.push('');\r\n        });\r\n    }\r\n\r\n    if (validationResult.warnings.length > 0) {\r\n        lines.push(`‚ö†Ô∏è  ${validationResult.warnings.length} avertissement(s):`);\r\n        lines.push('');\r\n\r\n        validationResult.warnings.forEach((warning, index) => {\r\n            lines.push(`  ${index + 1}. Champ: ${warning.field}`);\r\n            lines.push(`     Message: ${warning.message}`);\r\n            if (warning.context) {\r\n                lines.push(`     Contexte: ${JSON.stringify(warning.context, null, 2).split('\\n').join('\\n     ')}`);\r\n            }\r\n            lines.push('');\r\n        });\r\n    }\r\n\r\n    lines.push('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');\r\n    lines.push('üí° Conseil: V√©rifiez la documentation dans docs/STYLE_FORMAT_SPEC.md');\r\n    lines.push('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');\r\n\r\n    return lines.join('\\n');\r\n}\r\n\r\n/**\r\n * Module Style Validator\r\n * Expose les fonctions publiques\r\n */\r\nconst StyleValidator = {\r\n    validateStyle,\r\n    formatValidationErrors,\r\n    StyleValidationError\r\n};\r\n\r\n// Exposer le module\r\nGeoLeaf._StyleValidator = StyleValidator;\r\n\r\n})(window);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n(function (global) {\r\n    \"use strict\";\r\n    // Instance unique de la carte Leaflet g√©r√©e par GeoLeaf.Core\r\n    let _mapInstance = null;\r\n\r\n    // ---------------------------------------------------------\r\n    // Namespace global\r\n    // ---------------------------------------------------------\r\n    const root = (typeof globalThis !== \"undefined\" ? globalThis : window);\r\n    root.GeoLeaf = root.GeoLeaf || {};\r\n    root.GeoLeaf.Core = root.GeoLeaf.Core || {};\r\n\r\n    // ---------------------------------------------------------\r\n    // Logger unifi√© (d√©fini par geoleaf.logger-shim.js charg√© en premier)\r\n    // ---------------------------------------------------------\r\n    const Log = root.GeoLeaf.Log;\r\n\r\n    // ---------------------------------------------------------\r\n    // Module interne\r\n    // ---------------------------------------------------------\r\n    const Core = (function () {\r\n\r\n        let _map = null;\r\n        let _theme = \"light\";\r\n\r\n        // -----------------------------------------------------\r\n        // Normalisation des options d'initialisation\r\n        // -----------------------------------------------------\r\n        // eslint-disable-next-line no-unused-vars\r\n        function _normalizeOptions(options) {\r\n            if (!options || typeof options !== \"object\") {\r\n                throw new Error(\"[GeoLeaf.Core] init() requiert un objet d‚Äôoptions.\");\r\n            }\r\n\r\n            // Obligatoires\r\n            if (!options.target) {\r\n                throw new Error(\"[GeoLeaf.Core] L‚Äôoption 'target' est obligatoire.\");\r\n            }\r\n\r\n            if (!options.center || !Array.isArray(options.center) || options.center.length !== 2) {\r\n                throw new Error(\"[GeoLeaf.Core] L‚Äôoption 'center' doit √™tre un tableau [lat, lng].\");\r\n            }\r\n\r\n            if (typeof options.zoom !== \"number\") {\r\n                throw new Error(\"[GeoLeaf.Core] L‚Äôoption 'zoom' doit √™tre un nombre.\");\r\n            }\r\n\r\n            // Optionnels\r\n            return {\r\n                target: String(options.target),\r\n                center: options.center,\r\n                zoom: options.zoom,\r\n                theme: options.theme || \"light\",\r\n                mapOptions: options.mapOptions || {} // Options brutes Leaflet (optionnel)\r\n            };\r\n        }\r\n\r\n        // -----------------------------------------------------\r\n        // Gestion d‚Äôerreurs uniforme\r\n        // -----------------------------------------------------\r\n        function init(options = {}) {\r\n            const context = \"[GeoLeaf.Core]\";\r\n\r\n            try {\r\n                // V√©rification Leaflet\r\n                if (typeof L === \"undefined\") {\r\n                    throw new Error(\"Leaflet (L) est introuvable. Assurez-vous d‚Äôavoir charg√© Leaflet 1.9.x.\");\r\n                }\r\n\r\n                // V√©rification des options obligatoires\r\n                if (!options.mapId) {\r\n                    throw new Error(\"L‚Äôoption obligatoire 'mapId' est manquante.\");\r\n                }\r\n                const targetEl = document.getElementById(options.mapId);\r\n                if (!targetEl) {\r\n                    throw new Error(`Aucun √©l√©ment DOM trouv√© pour mapId='${options.mapId}'.`);\r\n                }\r\n\r\n                // Valeurs par d√©faut + normalisation\r\n                const center = Array.isArray(options.center) ? options.center : GeoLeaf.CONSTANTS.DEFAULT_CENTER;\r\n                const zoom = Number.isFinite(options.zoom) ? options.zoom : GeoLeaf.CONSTANTS.DEFAULT_ZOOM;\r\n                const theme = options.theme || \"light\";\r\n\r\n                // Cr√©ation ou r√©cup√©ration de la carte\r\n                if (_mapInstance) {\r\n                    Log.warn(`${context} Carte d√©j√† initialis√©e. Recyclage de l‚Äôinstance existante.`);\r\n                    return _mapInstance;\r\n                }\r\n\r\n                // Options Leaflet : on permet mapOptions, mais on force zoomControl √† true par d√©faut\r\n                const leafletMapOptions = Object.assign({}, options.mapOptions || {}, {\r\n                    center,\r\n                    zoom\r\n                });\r\n\r\n                if (typeof leafletMapOptions.zoomControl === \"undefined\") {\r\n                    leafletMapOptions.zoomControl = true;            // ‚úÖ boutons de zoom activ√©s par d√©faut\r\n                }\r\n                if (typeof leafletMapOptions.attributionControl === \"undefined\") {\r\n                    leafletMapOptions.attributionControl = false;    // tu gardes ton UI sans attribution Leaflet\r\n                }\r\n                if (typeof leafletMapOptions.zoomSnap === \"undefined\") {\r\n                    leafletMapOptions.zoomSnap = 0;                  // ‚úÖ D√©sactive le snapping = zoom totalement libre\r\n                }\r\n                if (typeof leafletMapOptions.zoomDelta === \"undefined\") {\r\n                    leafletMapOptions.zoomDelta = 0.25;              // ‚úÖ Incr√©ments de zoom pour les boutons +/-\r\n                }\r\n                if (typeof leafletMapOptions.wheelPxPerZoomLevel === \"undefined\") {\r\n                    leafletMapOptions.wheelPxPerZoomLevel = 120;     // ‚úÖ Sensibilit√© de la molette\r\n                }\r\n\r\n                _mapInstance = L.map(targetEl, leafletMapOptions);\r\n                _map = _mapInstance; // ‚úÖ Synchronisation de la variable locale\r\n\r\n                // Application du th√®me\r\n                try {\r\n                    if (global.GeoLeaf && global.GeoLeaf.UI && typeof global.GeoLeaf.UI.applyTheme === \"function\") {\r\n                        global.GeoLeaf.UI.applyTheme(theme);\r\n                    }\r\n                } catch (themeError) {\r\n                    Log.warn(`${context} Impossible d'appliquer le th√®me :`, themeError);\r\n                }\r\n\r\n                // Initialisation du module Legend si disponible et activ√©\r\n                const uiConfig = global.GeoLeaf.Config && global.GeoLeaf.Config.get ? global.GeoLeaf.Config.get('ui') : null;\r\n                const showLegend = uiConfig ? (uiConfig.showLegend !== false) : true;\r\n\r\n                if (showLegend && global.GeoLeaf && global.GeoLeaf.Legend && typeof global.GeoLeaf.Legend.init === \"function\") {\r\n                    try {\r\n                        global.GeoLeaf.Legend.init(_mapInstance, {\r\n                            position: \"bottomleft\",\r\n                            collapsible: true,\r\n                            collapsed: false\r\n                        });\r\n                    } catch (legendError) {\r\n                        Log.warn(`${context} Impossible d'initialiser Legend :`, legendError);\r\n                    }\r\n                }\r\n\r\n                Log.info(`${context} Carte initialis√©e avec succ√®s.`);\r\n                return _mapInstance;\r\n\r\n            } catch (err) {\r\n                Log.error(`${context} ERREUR :`, err.message);\r\n\r\n                // Callback global utilisateur\r\n                if (typeof global.GeoLeaf?.Core?.onError === \"function\") {\r\n                    try {\r\n                        global.GeoLeaf.Core.onError(err);\r\n                    } catch (cbErr) {\r\n                        Log.error(`${context} Erreur dans Core.onError() :`, cbErr);\r\n                    }\r\n                }\r\n\r\n                // ‚úÖ S'assurer que les variables sont coh√©rentes en cas d'erreur\r\n                _mapInstance = null;\r\n                _map = null;\r\n\r\n                return null;\r\n            }\r\n        }\r\n\r\n        // -----------------------------------------------------\r\n        // Compatibilit√© descendante : initMap\r\n        // -----------------------------------------------------\r\n        function initMap(a, b, c, d) {\r\n            Log.warn(\"[GeoLeaf.Core] GeoLeaf.Core.initMap() est obsol√®te, utilisez GeoLeaf.Core.init().\");\r\n\r\n            let options = null;\r\n\r\n            if (root.GeoLeaf && root.GeoLeaf.Config && typeof root.GeoLeaf.Config.get === \"function\") {\r\n                try {\r\n                    const mapCfg = root.GeoLeaf.Config.get(\"map\") || {};\r\n                    const uiCfg = root.GeoLeaf.Config.get(\"ui\") || {};\r\n\r\n                    options = {\r\n                        target: mapCfg.target || \"geoleaf-map\",\r\n                        center: mapCfg.center || GeoLeaf.CONSTANTS.DEFAULT_CENTER,\r\n                        zoom: (typeof mapCfg.zoom === \"number\" ? mapCfg.zoom : GeoLeaf.CONSTANTS.DEFAULT_ZOOM),\r\n                        theme: uiCfg.theme || \"light\",\r\n                        mapOptions: mapCfg.mapOptions || {}\r\n                    };\r\n\r\n                    return init(options);\r\n                } catch (err) {\r\n                    Log.error(\"[GeoLeaf.Core] initMap() n‚Äôa pas pu construire les options √† partir de GeoLeaf.Config :\", err);\r\n                    // on continue vers les heuristiques d‚Äôarguments\r\n                }\r\n            }\r\n\r\n            // Cas objet unique : initMap({ target, center, zoom, theme })\r\n            if (a && typeof a === \"object\" && !Array.isArray(a)) {\r\n                return init(a);\r\n            }\r\n\r\n            // Cas ancienne signature : initMap(target, center, zoom, theme?)\r\n            if (typeof a === \"string\" && Array.isArray(b) && typeof c === \"number\") {\r\n                const legacyOptions = {\r\n                    target: a,\r\n                    center: b,\r\n                    zoom: c,\r\n                    theme: d || \"light\"\r\n                };\r\n                return init(legacyOptions);\r\n            }\r\n\r\n            Log.error(\"[GeoLeaf.Core] initMap() appel√© avec une signature obsol√®te ou invalide. Utilisez GeoLeaf.Core.init({ target, center, zoom, theme }).\");\r\n            return null;\r\n        }\r\n\r\n        // -----------------------------------------------------\r\n        // Th√®me\r\n        // -----------------------------------------------------\r\n        function _applyThemeToBody(theme) {\r\n            const body = document.body;\r\n            if (!body) {\r\n                Log.warn(\"[GeoLeaf.Core] Impossible d‚Äôappliquer le th√®me : document.body introuvable.\");\r\n                return;\r\n            }\r\n            body.classList.remove(\"gl-theme-light\", \"gl-theme-dark\");\r\n            body.classList.add(theme === \"dark\" ? \"gl-theme-dark\" : \"gl-theme-light\");\r\n        }\r\n\r\n        function setTheme(theme) {\r\n            if (!theme || (theme !== \"light\" && theme !== \"dark\")) {\r\n                Log.warn(\"[GeoLeaf.Core] setTheme() : th√®me invalide ‚Üí\", theme);\r\n                return;\r\n            }\r\n            _theme = theme;\r\n            _applyThemeToBody(theme);\r\n        }\r\n\r\n        function getTheme() {\r\n            return _theme;\r\n        }\r\n\r\n        // -----------------------------------------------------\r\n        // Acc√®s √† la map\r\n        // -----------------------------------------------------\r\n        function getMap() {\r\n            return _map;\r\n        }\r\n\r\n        // -----------------------------------------------------\r\n        // API publique\r\n        // -----------------------------------------------------\r\n        return {\r\n            init,      // nouvelle API normalis√©e\r\n            initMap,   // alias r√©trocompatible pour la d√©mo et anciens appels\r\n            getMap,\r\n            setTheme,\r\n            getTheme\r\n        };\r\n\r\n    })();\r\n\r\n    root.GeoLeaf.Core = Core;\r\n\r\n})(window);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n/**\r\n * GeoLeaf UI Module - Theme Management\r\n * Gestion du th√®me dark/light avec persistance localStorage\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    const Log = GeoLeaf.Log;\r\n\r\n    GeoLeaf._UITheme = GeoLeaf._UITheme || {};\r\n\r\n    // ========================================\r\n    //   CONSTANTES\r\n    // ========================================\r\n\r\n    const THEME_KEY = \"geoleaf_theme\";\r\n    const THEME_LIGHT = \"light\";\r\n    const THEME_DARK = \"dark\";\r\n\r\n    // ========================================\r\n    //   √âTAT INTERNE\r\n    // ========================================\r\n\r\n    /**\r\n     * Source de v√©rit√© unique pour le th√®me actuel\r\n     * @type {string|null}\r\n     * @private\r\n     */\r\n    let _currentTheme = null;\r\n\r\n    // ========================================\r\n    //   FONCTIONS PUBLIQUES\r\n    // ========================================\r\n\r\n    /**\r\n     * Retourne le th√®me courant (\"light\" ou \"dark\").\r\n     * @returns {string} Theme actuel\r\n     */\r\n    function getCurrentTheme() {\r\n        // Si d√©j√† en m√©moire, retourner directement\r\n        if (_currentTheme) {\r\n            return _currentTheme;\r\n        }\r\n\r\n        // Sinon, fallback sur le DOM\r\n        if (document.body.classList.contains(\"gl-theme-dark\")) {\r\n            _currentTheme = THEME_DARK;\r\n            return THEME_DARK;\r\n        }\r\n        if (document.body.classList.contains(\"gl-theme-light\")) {\r\n            _currentTheme = THEME_LIGHT;\r\n            return THEME_LIGHT;\r\n        }\r\n\r\n        // Fallback final\r\n        _currentTheme = THEME_DARK;\r\n        return THEME_DARK;\r\n    }\r\n\r\n    /**\r\n     * Applique un th√®me au <body> et synchronise le bouton.\r\n     * @param {string} theme - \"light\" ou \"dark\"\r\n     */\r\n    function applyTheme(theme) {\r\n        const normalized =\r\n            theme === THEME_LIGHT || theme === THEME_DARK\r\n                ? theme\r\n                : THEME_DARK;\r\n\r\n        Log.debug('[UI.Theme] applyTheme:', theme, '‚Üí', normalized);\r\n\r\n        // Mettre √† jour l'√©tat centralis√© AVANT le DOM\r\n        _currentTheme = normalized;\r\n\r\n        // Mise √† jour du DOM sur body\r\n        document.body.classList.remove(\"gl-theme-light\", \"gl-theme-dark\");\r\n        document.body.classList.add(\r\n            normalized === THEME_DARK ? \"gl-theme-dark\" : \"gl-theme-light\"\r\n        );\r\n\r\n        // Appliquer aussi le th√®me au conteneur de carte (pour support fullscreen)\r\n        const mapContainer = document.getElementById(\"geoleaf-map\");\r\n        if (mapContainer) {\r\n            mapContainer.classList.remove(\"gl-theme-light\", \"gl-theme-dark\");\r\n            mapContainer.classList.add(\r\n                normalized === THEME_DARK ? \"gl-theme-dark\" : \"gl-theme-light\"\r\n            );\r\n        }\r\n\r\n        // Sauvegarde locale\r\n        try {\r\n            // SAFE: Use StorageHelper with Theme validator\r\n            const StorageHelper = GeoLeaf.StorageHelper;\r\n            const ThemeValidator = GeoLeaf.Validators?.Theme;\r\n\r\n            if (StorageHelper && ThemeValidator) {\r\n                StorageHelper.setItem(THEME_KEY, normalized, ThemeValidator);\r\n            } else {\r\n                // Fallback if StorageHelper not loaded yet\r\n                global.localStorage.setItem(THEME_KEY, normalized);\r\n            }\r\n        } catch (e) {\r\n            // G√©rer explicitement l'absence de localStorage\r\n            if (Log) Log.warn(\"[UI.Theme] localStorage non disponible, th√®me non persist√©.\");\r\n        }\r\n\r\n        // Synchronise le bouton si pr√©sent\r\n        updateToggleButton(normalized);\r\n\r\n        // √âv√®nement global pour les autres modules\r\n        if (global.dispatchEvent) {\r\n            global.dispatchEvent(\r\n                new CustomEvent(\"geoleaf:ui-theme-changed\", {\r\n                    detail: { theme: normalized }\r\n                })\r\n            );\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Bascule le th√®me courant (light <-> dark).\r\n     */\r\n    function toggleTheme() {\r\n        const current = getCurrentTheme();\r\n        const next = current === THEME_DARK ? THEME_LIGHT : THEME_DARK;\r\n        Log.debug('[UI.Theme] toggleTheme:', current, '‚Üí', next);\r\n        applyTheme(next);\r\n    }\r\n\r\n    /**\r\n     * D√©termine le th√®me initial :\r\n     * 1) localStorage si disponible\r\n     * 2) class du <body> si d√©j√† d√©finie\r\n     * 3) sinon, \"dark\"\r\n     * @returns {string} Theme initial\r\n     * @private\r\n     */\r\n    function resolveInitialTheme() {\r\n        let stored = null;\r\n\r\n        try {\r\n            // SAFE: Use StorageHelper with Theme validator\r\n            const StorageHelper = GeoLeaf.StorageHelper;\r\n            const ThemeValidator = GeoLeaf.Validators?.Theme;\r\n\r\n            if (StorageHelper && ThemeValidator) {\r\n                stored = StorageHelper.getItem(THEME_KEY, null, ThemeValidator);\r\n            } else {\r\n                // Fallback if StorageHelper not loaded yet\r\n                stored = global.localStorage.getItem(THEME_KEY);\r\n            }\r\n        } catch (e) {\r\n            stored = null;\r\n        }\r\n\r\n        if (stored === THEME_LIGHT || stored === THEME_DARK) {\r\n            return stored;\r\n        }\r\n\r\n        const bodyTheme = getCurrentTheme();\r\n        if (bodyTheme === THEME_LIGHT || bodyTheme === THEME_DARK) {\r\n            return bodyTheme;\r\n        }\r\n\r\n        return THEME_DARK;\r\n    }\r\n\r\n    /**\r\n     * R√©cup√®re le bouton de th√®me dans le DOM.\r\n     * Par convention on utilise l'attribut data-gl-role=\"theme-toggle\".\r\n     * @returns {HTMLElement|null}\r\n     * @private\r\n     */\r\n    function getToggleButton() {\r\n        return document.querySelector('[data-gl-role=\"theme-toggle\"]');\r\n    }\r\n\r\n    /**\r\n     * Met √† jour l'√©tat visuel/ARIA du bouton de th√®me.\r\n     * @param {string} theme - \"light\" ou \"dark\"\r\n     * @private\r\n     */\r\n    function updateToggleButton(theme) {\r\n        const btn = getToggleButton();\r\n        if (!btn) return;\r\n\r\n        const isDark = theme === THEME_DARK;\r\n\r\n        btn.setAttribute(\"data-gl-theme-state\", isDark ? \"dark\" : \"light\");\r\n        btn.setAttribute(\"aria-pressed\", String(isDark));\r\n        btn.setAttribute(\r\n            \"aria-label\",\r\n            isDark ? \"Basculer en th√®me clair\" : \"Basculer en th√®me sombre\"\r\n        );\r\n        btn.title = isDark ? \"Th√®me clair\" : \"Th√®me sombre\";\r\n    }\r\n\r\n    /**\r\n     * Initialise la gestion du bouton de th√®me.\r\n     * @param {object} [options] - Options de configuration\r\n     * @param {string} [options.buttonSelector] - S√©lecteur custom du bouton\r\n     * @param {boolean} [options.autoInitOnDomReady] - Si true, attend DOMContentLoaded\r\n     */\r\n    function initThemeToggle(options = {}) {\r\n        const cfg = {\r\n            buttonSelector: options.buttonSelector || '[data-gl-role=\"theme-toggle\"]',\r\n            autoInitOnDomReady:\r\n                typeof options.autoInitOnDomReady === \"boolean\"\r\n                    ? options.autoInitOnDomReady\r\n                    : false\r\n        };\r\n\r\n        const doInit = () => {\r\n            const initialTheme = resolveInitialTheme();\r\n            Log.debug('[UI.Theme] initThemeToggle:', initialTheme);\r\n            applyTheme(initialTheme);\r\n\r\n            const btn = document.querySelector(cfg.buttonSelector);\r\n            if (!btn) {\r\n                Log.warn('[UI.Theme] Bouton de th√®me introuvable:', cfg.buttonSelector);\r\n                return;\r\n            }\r\n\r\n            Log.debug('[UI.Theme] Bouton de th√®me trouv√©');\r\n\r\n            // Accessibilit√© : <button> natif ou r√¥le \"button\"\r\n            const tag = (btn.tagName || \"\").toLowerCase();\r\n            if (tag === \"button\") {\r\n                try {\r\n                    btn.type = btn.type || \"button\";\r\n                } catch (e) {\r\n                    // Certains √©l√©ments custom peuvent lever une erreur\r\n                }\r\n            } else {\r\n                btn.setAttribute(\"role\", \"button\");\r\n                btn.setAttribute(\"tabindex\", \"0\");\r\n            }\r\n\r\n            // Premi√®re synchro de l'√©tat visuel\r\n            updateToggleButton(initialTheme);\r\n\r\n            // Clic souris\r\n            btn.addEventListener(\"click\", (evt) => {\r\n                evt.preventDefault();\r\n                toggleTheme();\r\n            });\r\n\r\n            // Clavier (Enter / Space)\r\n            btn.addEventListener(\"keydown\", (evt) => {\r\n                if (evt.key === \"Enter\" || evt.key === \" \" || evt.key === \"Spacebar\") {\r\n                    evt.preventDefault();\r\n                    toggleTheme();\r\n                }\r\n            });\r\n        };        if (cfg.autoInitOnDomReady) {\r\n            if (document.readyState === \"loading\") {\r\n                document.addEventListener(\"DOMContentLoaded\", doInit, { once: true });\r\n            } else {\r\n                doInit();\r\n            }\r\n        } else {\r\n            doInit();\r\n        }\r\n    }\r\n\r\n    // ========================================\r\n    //   EXPORT\r\n    // ========================================\r\n\r\n    GeoLeaf._UITheme = {\r\n        initThemeToggle,\r\n        toggleTheme,\r\n        applyTheme,\r\n        getCurrentTheme,\r\n        // Constantes expos√©es\r\n        THEME_LIGHT,\r\n        THEME_DARK\r\n    };\r\n\r\n})(typeof window !== \"undefined\" ? window : global);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n/**\r\n * GeoLeaf UI Module - Controls\r\n * Contr√¥les Leaflet personnalis√©s (fullscreen, zoom, scale, etc.)\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    const Log = GeoLeaf.Log;\r\n    const Utils = GeoLeaf.Utils;\r\n\r\n    GeoLeaf._UIControls = GeoLeaf._UIControls || {};\r\n\r\n    // ========================================\r\n    //   FULLSCREEN CONTROL\r\n    // ========================================\r\n\r\n    /**\r\n     * Gestion du plein √©cran pour la carte\r\n     * @param {L.Map} map - Instance de la carte Leaflet\r\n     * @param {HTMLElement} mapContainer - Le conteneur de la carte √† mettre en plein √©cran\r\n     */\r\n    function initFullscreenControl(map, mapContainer) {\r\n        if (!map || !mapContainer) {\r\n            if (Log) Log.warn(\"[UI.Controls] initFullscreenControl: carte ou conteneur manquant\");\r\n            return;\r\n        }\r\n\r\n        // V√©rifier que Leaflet est disponible\r\n        if (typeof L === \"undefined\" || !L.Control) {\r\n            if (Log) Log.warn(\"[UI.Controls] Leaflet n'est pas disponible\");\r\n            return;\r\n        }\r\n\r\n        // Contr√¥le Leaflet personnalis√©\r\n        L.Control.Fullscreen = L.Control.extend({\r\n            options: {\r\n                position: \"topleft\"\r\n            },\r\n\r\n            onAdd: function (map) {\r\n                const container = L.DomUtil.create(\r\n                    \"div\",\r\n                    \"leaflet-control-fullscreen leaflet-bar leaflet-control\"\r\n                );\r\n                const link = L.DomUtil.create(\"a\", \"\", container);\r\n\r\n                link.href = \"#\";\r\n                link.title = \"Plein √©cran\";\r\n                link.setAttribute(\"role\", \"button\");\r\n                link.setAttribute(\"aria-label\", \"Activer le mode plein √©cran\");\r\n\r\n                // Fullscreen ENTER icon (static SVG)\r\n                // SAFE: SVG statique hardcod√©\r\n                const svgEnter = GeoLeaf.DOMSecurity.createSVGIcon(18, 18, 'M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3', {\r\n                    stroke: 'currentColor',\r\n                    strokeWidth: '2',\r\n                    fill: 'none'\r\n                });\r\n                svgEnter.classList.add('fullscreen-enter-icon');\r\n\r\n                // Fullscreen EXIT icon (static SVG)\r\n                // SAFE: SVG statique hardcod√©\r\n                const svgExit = GeoLeaf.DOMSecurity.createSVGIcon(18, 18, 'M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3', {\r\n                    stroke: 'currentColor',\r\n                    strokeWidth: '2',\r\n                    fill: 'none'\r\n                });\r\n                svgExit.classList.add('fullscreen-exit-icon');\r\n                svgExit.style.display = 'none'; // Cach√© par d√©faut\r\n\r\n                link.appendChild(svgEnter);\r\n                link.appendChild(svgExit);\r\n\r\n                // √âviter la propagation vers la carte\r\n                L.DomEvent.disableClickPropagation(container);\r\n                L.DomEvent.disableScrollPropagation(container);\r\n\r\n                // Debounce pour invalidateSize\r\n                const debouncedInvalidateSize =\r\n                    Utils?.debounce\r\n                        ? Utils.debounce(() => map.invalidateSize(), 200)\r\n                        : () => map.invalidateSize();\r\n\r\n                // Fonction pour mettre √† jour l'ic√¥ne\r\n                const updateIcon = (isFullscreen) => {\r\n                    if (isFullscreen) {\r\n                        svgEnter.style.display = 'none';\r\n                        svgExit.style.display = 'block';\r\n                    } else {\r\n                        svgEnter.style.display = 'block';\r\n                        svgExit.style.display = 'none';\r\n                    }\r\n                };\r\n\r\n                const toggleFullscreen = (e) => {\r\n                    L.DomEvent.preventDefault(e);\r\n\r\n                    if (!document.fullscreenElement) {\r\n                        // Entrer en plein √©cran\r\n                        mapContainer\r\n                            .requestFullscreen()\r\n                            .then(() => {\r\n                                link.classList.add(\"is-fullscreen\");\r\n                                link.title = \"Quitter le plein √©cran\";\r\n                                link.setAttribute(\r\n                                    \"aria-label\",\r\n                                    \"Quitter le mode plein √©cran\"\r\n                                );\r\n                                updateIcon(true);\r\n                                debouncedInvalidateSize();\r\n                            })\r\n                            .catch((err) => {\r\n                                if (Log) Log.error(\"[UI.Controls] Erreur plein √©cran:\", err);\r\n                            });\r\n                    } else {\r\n                        // Quitter le plein √©cran\r\n                        document\r\n                            .exitFullscreen()\r\n                            .then(() => {\r\n                                link.classList.remove(\"is-fullscreen\");\r\n                                link.title = \"Plein √©cran\";\r\n                                link.setAttribute(\r\n                                    \"aria-label\",\r\n                                    \"Activer le mode plein √©cran\"\r\n                                );\r\n                                updateIcon(false);\r\n                                debouncedInvalidateSize();\r\n                            })\r\n                            .catch((err) => {\r\n                                if (Log) Log.error(\"[UI.Controls] Erreur sortie plein √©cran:\", err);\r\n                            });\r\n                    }\r\n                };\r\n\r\n                const fullscreenChangeHandler = () => {\r\n                    if (!document.fullscreenElement) {\r\n                        link.classList.remove(\"is-fullscreen\");\r\n                        link.title = \"Plein √©cran\";\r\n                        link.setAttribute(\r\n                            \"aria-label\",\r\n                            \"Activer le mode plein √©cran\"\r\n                        );\r\n                        updateIcon(false);\r\n                        debouncedInvalidateSize();\r\n                    }\r\n                };\r\n\r\n                L.DomEvent.on(link, \"click\", toggleFullscreen);\r\n                L.DomEvent.on(link, \"keydown\", (e) => {\r\n                    if (\r\n                        e.key === \"Enter\" ||\r\n                        e.key === \" \" ||\r\n                        e.key === \"Spacebar\"\r\n                    ) {\r\n                        toggleFullscreen(e);\r\n                    }\r\n                });\r\n\r\n                document.addEventListener(\r\n                    \"fullscreenchange\",\r\n                    fullscreenChangeHandler\r\n                );\r\n\r\n                this._fullscreenChangeHandler = fullscreenChangeHandler;\r\n                this._toggleFullscreen = toggleFullscreen;\r\n                this._link = link;\r\n                this._mapContainer = mapContainer;\r\n                this._debouncedInvalidateSize = debouncedInvalidateSize;\r\n\r\n                return container;\r\n            },\r\n\r\n            onRemove: function (_map) {\r\n                // MEMORY LEAK FIX (Phase 2): Clean up circular references in closures\r\n                if (this._fullscreenChangeHandler) {\r\n                    document.removeEventListener(\r\n                        \"fullscreenchange\",\r\n                        this._fullscreenChangeHandler\r\n                    );\r\n                    this._fullscreenChangeHandler = null;\r\n                }\r\n\r\n                if (this._link) {\r\n                    L.DomEvent.off(this._link, \"click\", this._toggleFullscreen);\r\n                    L.DomEvent.off(this._link, \"keydown\");\r\n                    this._link = null;\r\n                }\r\n\r\n                // Clean up closure references to prevent memory leaks\r\n                this._toggleFullscreen = null;\r\n                this._mapContainer = null;\r\n                this._debouncedInvalidateSize = null;\r\n            }\r\n        });\r\n\r\n        new L.Control.Fullscreen().addTo(map);\r\n        if (Log) Log.info(\"[UI.Controls] Contr√¥le plein √©cran ajout√© √† la carte\");\r\n    }\r\n\r\n    // ========================================\r\n    //   GEOLOCATION CONTROL\r\n    // ========================================\r\n\r\n    /**\r\n     * Gestion de la g√©olocalisation pour centrer la carte sur la position de l'utilisateur\r\n     * @param {L.Map} map - Instance de la carte Leaflet\r\n     * @param {Object} config - Configuration incluant ui.enableGeolocation\r\n     */\r\n    function initGeolocationControl(map, config) {\r\n        if (!map) {\r\n            if (Log) Log.warn(\"[UI.Controls] initGeolocationControl: carte manquante\");\r\n            return;\r\n        }\r\n\r\n        // V√©rifier si la g√©olocalisation est activ√©e dans la config\r\n        if (!config?.ui?.enableGeolocation) {\r\n            if (Log) Log.info(\"[UI.Controls] G√©olocalisation d√©sactiv√©e dans la configuration\");\r\n            return;\r\n        }\r\n\r\n        // V√©rifier que Leaflet est disponible\r\n        if (typeof L === \"undefined\" || !L.Control) {\r\n            if (Log) Log.warn(\"[UI.Controls] Leaflet n'est pas disponible\");\r\n            return;\r\n        }\r\n\r\n        // V√©rifier que l'API de g√©olocalisation est disponible\r\n        if (!navigator.geolocation) {\r\n            if (Log) Log.warn(\"[UI.Controls] La g√©olocalisation n'est pas support√©e par ce navigateur\");\r\n            return;\r\n        }\r\n\r\n        // Marqueur de position utilisateur (stock√© pour pouvoir le supprimer/mettre √† jour)\r\n        let userMarker = null;\r\n        let accuracyCircle = null;\r\n\r\n        // Contr√¥le Leaflet personnalis√©\r\n        L.Control.Geolocation = L.Control.extend({\r\n            options: {\r\n                position: \"topleft\"\r\n            },\r\n\r\n            onAdd: function (map) {\r\n                const container = L.DomUtil.create(\r\n                    \"div\",\r\n                    \"leaflet-control-geolocation leaflet-bar leaflet-control\"\r\n                );\r\n                const link = L.DomUtil.create(\"a\", \"\", container);\r\n\r\n                link.href = \"#\";\r\n                link.title = \"G√©olocalisation ON/OFF\";\r\n                link.setAttribute(\"role\", \"button\");\r\n                link.setAttribute(\"aria-label\", \"Activer/D√©sactiver le suivi GPS\");\r\n\r\n                // Ic√¥ne de g√©olocalisation (utilisation d'un SVG ou Unicode)\r\n                // SAFE: SVG statique hardcod√©, pas de donn√©es utilisateur\r\n                const geoSvg = GeoLeaf.DOMSecurity.createSVGIcon(18, 18, 'M12 2 C 6.5 2 2 6.5 2 12 C 2 17.5 6.5 22 12 22 C 17.5 22 22 17.5 22 12 C 22 6.5 17.5 2 12 2 M12 9 C 10.3 9 9 10.3 9 12 C 9 13.7 10.3 15 12 15 C 13.7 15 15 13.7 15 12 C 15 10.3 13.7 9 12 9', {\r\n                    stroke: 'currentColor',\r\n                    strokeWidth: '2',\r\n                    fill: 'none'\r\n                });\r\n                link.appendChild(geoSvg);\r\n\r\n                // √âviter la propagation vers la carte\r\n                L.DomEvent.disableClickPropagation(container);\r\n                L.DomEvent.disableScrollPropagation(container);\r\n\r\n                const toggleGeolocation = (e) => {\r\n                    L.DomEvent.preventDefault(e);\r\n\r\n                    // Si d√©j√† actif, d√©sactiver\r\n                    if (window.GeoLeaf.UI._geolocationActive) {\r\n                        // D√©sactiver le tracking\r\n                        if (window.GeoLeaf.UI._geolocationWatchId !== null) {\r\n                            navigator.geolocation.clearWatch(window.GeoLeaf.UI._geolocationWatchId);\r\n                            window.GeoLeaf.UI._geolocationWatchId = null;\r\n                        }\r\n\r\n                        // Retirer les marqueurs et cercles\r\n                        if (userMarker) {\r\n                            map.removeLayer(userMarker);\r\n                            userMarker = null;\r\n                        }\r\n                        if (accuracyCircle) {\r\n                            map.removeLayer(accuracyCircle);\r\n                            accuracyCircle = null;\r\n                        }\r\n\r\n                        // R√©initialiser l'√©tat\r\n                        window.GeoLeaf.UI._geolocationActive = false;\r\n                        window.GeoLeaf.UI._userPosition = null;\r\n\r\n                        link.classList.remove(\"is-active\");\r\n                        link.classList.remove(\"is-locating\");\r\n\r\n                        if (Log) Log.info(\"[UI.Controls] G√©olocalisation d√©sactiv√©e\");\r\n                        return;\r\n                    }\r\n\r\n                    // Activer le mode g√©olocalisation\r\n                    link.classList.add(\"is-locating\");\r\n\r\n                    // Utiliser watchPosition pour un tracking continu\r\n                    window.GeoLeaf.UI._geolocationWatchId = navigator.geolocation.watchPosition(\r\n                        (position) => {\r\n                            const { latitude, longitude, accuracy } = position.coords;\r\n\r\n                            // Premi√®re activation : centrer la carte\r\n                            if (!window.GeoLeaf.UI._geolocationActive) {\r\n                                map.setView([latitude, longitude], 16, {\r\n                                    animate: true,\r\n                                    duration: 0.5\r\n                                });\r\n                            } else {\r\n                                // Mise √† jour continue : d√©placer le marqueur sans recentrer\r\n                                // (sauf si on veut un mode \"suivi\" permanent)\r\n                            }\r\n\r\n                            // Supprimer l'ancien marqueur et cercle s'ils existent\r\n                            if (userMarker) {\r\n                                map.removeLayer(userMarker);\r\n                            }\r\n                            if (accuracyCircle) {\r\n                                map.removeLayer(accuracyCircle);\r\n                            }\r\n\r\n                            // Cr√©er un nouveau marqueur pour la position de l'utilisateur\r\n                            userMarker = L.marker([latitude, longitude], {\r\n                                icon: L.divIcon({\r\n                                    className: 'gl-user-location-marker gl-user-location-marker--active',\r\n                                    html: `<div class=\"gl-user-location-dot gl-user-location-dot--active\"></div>`,\r\n                                    iconSize: [22, 22],\r\n                                    iconAnchor: [11, 11]\r\n                                }),\r\n                                zIndexOffset: 1000\r\n                            }).addTo(map);\r\n\r\n                            // Ajouter un cercle de pr√©cision\r\n                            if (accuracy && accuracy < 1000) {\r\n                                const interactiveShapes = GeoLeaf.Config.get('ui.interactiveShapes', false);\r\n                                accuracyCircle = L.circle([latitude, longitude], {\r\n                                    radius: accuracy,\r\n                                    className: 'gl-user-location-accuracy',\r\n                                    fillColor: '#4285F4',\r\n                                    fillOpacity: 0.1,\r\n                                    stroke: true,\r\n                                    color: '#4285F4',\r\n                                    opacity: 0.3,\r\n                                    weight: 1,\r\n                                    interactive: interactiveShapes\r\n                                }).addTo(map);\r\n                            }\r\n\r\n                            // Mettre √† jour l'√©tat\r\n                            window.GeoLeaf.UI._geolocationActive = true;\r\n                            link.classList.remove(\"is-locating\");\r\n                            link.classList.add(\"is-active\");\r\n\r\n                            // Stocker la position GPS globalement pour utilisation par d'autres fonctionnalit√©s (ex: recherche par proximit√©)\r\n                            if (window.GeoLeaf && window.GeoLeaf.UI) {\r\n                                window.GeoLeaf.UI._userPosition = {\r\n                                    lat: latitude,\r\n                                    lng: longitude,\r\n                                    accuracy: accuracy,\r\n                                    timestamp: Date.now()\r\n                                };\r\n                            }\r\n\r\n                            if (Log) Log.debug(\"[UI.Controls] Position GPS mise √† jour:\", latitude, longitude);\r\n                        },\r\n                        (error) => {\r\n                            link.classList.remove(\"is-locating\");\r\n                            link.classList.remove(\"is-active\");\r\n                            window.GeoLeaf.UI._geolocationActive = false;\r\n\r\n                            let errorMessage = \"Impossible d'obtenir votre position\";\r\n                            switch (error.code) {\r\n                                case error.PERMISSION_DENIED:\r\n                                    errorMessage = \"Permission de g√©olocalisation refus√©e\";\r\n                                    break;\r\n                                case error.POSITION_UNAVAILABLE:\r\n                                    errorMessage = \"Position indisponible\";\r\n                                    break;\r\n                                case error.TIMEOUT:\r\n                                    errorMessage = \"D√©lai de g√©olocalisation d√©pass√©\";\r\n                                    break;\r\n                            }\r\n\r\n                            if (Log) Log.error(\"[UI.Controls] Erreur de g√©olocalisation:\", error);\r\n\r\n                            // Afficher un message √† l'utilisateur (peut √™tre personnalis√©)\r\n                            if (window.alert) {\r\n                                alert(errorMessage);\r\n                            }\r\n                        },\r\n                        {\r\n                            enableHighAccuracy: true,\r\n                            timeout: 10000,\r\n                            maximumAge: 0\r\n                        }\r\n                    );\r\n                };\r\n\r\n                L.DomEvent.on(link, \"click\", toggleGeolocation);\r\n                L.DomEvent.on(link, \"keydown\", (e) => {\r\n                    if (\r\n                        e.key === \"Enter\" ||\r\n                        e.key === \" \" ||\r\n                        e.key === \"Spacebar\"\r\n                    ) {\r\n                        toggleGeolocation(e);\r\n                    }\r\n                });\r\n\r\n                this._link = link;\r\n                this._userMarker = userMarker;\r\n\r\n                return container;\r\n            },\r\n\r\n            onRemove: function (map) {\r\n                if (this._link) {\r\n                    L.DomEvent.off(this._link, \"click\");\r\n                    L.DomEvent.off(this._link, \"keydown\");\r\n                    this._link = null;\r\n                }\r\n\r\n                if (this._userMarker) {\r\n                    map.removeLayer(this._userMarker);\r\n                    this._userMarker = null;\r\n                }\r\n            }\r\n        });\r\n\r\n        new L.Control.Geolocation().addTo(map);\r\n        if (Log) Log.info(\"[UI.Controls] Contr√¥le de g√©olocalisation ajout√© √† la carte\");\r\n    }\r\n\r\n    // ========================================\r\n    //   POI ADD CONTROL\r\n    // ========================================\r\n\r\n    /**\r\n     * Gestion du bouton d'ajout de POI sur la carte\r\n     * Permet aux utilisateurs d'ajouter de nouveaux points d'int√©r√™t\r\n     * @param {L.Map} map - Instance de la carte Leaflet\r\n     * @param {Object} config - Configuration incluant ui.showAddPoi et poi.*\r\n     */\r\n    function initPoiAddControl(map, config) {\r\n        if (!map) {\r\n            if (Log) Log.warn(\"[UI.Controls] initPoiAddControl: carte manquante\");\r\n            return;\r\n        }\r\n\r\n        // V√©rifier si le bouton POI Add est activ√©\r\n        if (!config?.ui?.showAddPoi) {\r\n            if (Log) Log.debug(\"[UI.Controls] Bouton POI Add d√©sactiv√© dans la configuration\");\r\n            return;\r\n        }\r\n\r\n        // V√©rifier que Leaflet est disponible\r\n        if (typeof L === \"undefined\" || !L.Control) {\r\n            if (Log) Log.warn(\"[UI.Controls] Leaflet n'est pas disponible\");\r\n            return;\r\n        }\r\n\r\n        // V√©rifier que les modules POI sont charg√©s\r\n        if (!GeoLeaf?.POI?.AddForm || !GeoLeaf?.POI?.PlacementMode) {\r\n            if (Log) Log.warn(\"[UI.Controls] Modules POI non charg√©s\");\r\n            return;\r\n        }\r\n\r\n        // Contr√¥le Leaflet personnalis√© pour l'ajout de POI\r\n        L.Control.PoiAdd = L.Control.extend({\r\n            options: {\r\n                position: \"topleft\"\r\n            },\r\n\r\n            onAdd: function (map) {\r\n                const container = L.DomUtil.create(\r\n                    \"div\",\r\n                    \"leaflet-control-poi-add leaflet-bar leaflet-control\"\r\n                );\r\n                const link = L.DomUtil.create(\"a\", \"\", container);\r\n\r\n                link.href = \"#\";\r\n                link.title = \"Ajouter un POI\";\r\n                link.setAttribute(\"role\", \"button\");\r\n                link.setAttribute(\"aria-label\", \"Ajouter un nouveau point d'int√©r√™t\");\r\n\r\n                // Ic√¥ne d'ajout de POI (SVG statique)\r\n                // SAFE: SVG statique hardcod√©, pas de donn√©es utilisateur\r\n                const poiSvg = GeoLeaf.DOMSecurity.createSVGIcon(18, 18, 'M12 2 C 6.5 2 2 6.5 2 12 C 2 17.5 6.5 22 12 22 C 17.5 22 22 17.5 22 12 C 22 6.5 17.5 2 12 2 M12 8 L12 16 M8 12 L16 12', {\r\n                    stroke: 'currentColor',\r\n                    strokeWidth: '2',\r\n                    fill: 'none'\r\n                });\r\n                link.appendChild(poiSvg);\r\n\r\n                // √âviter la propagation vers la carte\r\n                L.DomEvent.disableClickPropagation(container);\r\n                L.DomEvent.disableScrollPropagation(container);\r\n\r\n                const handleAddPoi = (e) => {\r\n                    L.DomEvent.preventDefault(e);\r\n\r\n                    // D√©sactiver le bouton temporairement\r\n                    link.classList.add(\"disabled\");\r\n\r\n                    // Fonction pour ouvrir le formulaire\r\n                    const openForm = (latlng) => {\r\n                        link.classList.remove(\"disabled\");\r\n\r\n                        if (!GeoLeaf.POI.AddForm.openAddForm) {\r\n                            if (Log) Log.error(\"[UI.Controls] AddForm.openAddForm non disponible\");\r\n                            return;\r\n                        }\r\n\r\n                        GeoLeaf.POI.AddForm.openAddForm(latlng, null);\r\n                    };\r\n\r\n                    // V√©rifier si la g√©olocalisation est disponible et si elle est le mode par d√©faut\r\n                    const userPosition = GeoLeaf?.UI?._userPosition;\r\n                    const defaultPosition = config?.poiAddConfig?.defaultPosition || \"placement-mode\";\r\n\r\n                    if (userPosition && defaultPosition === \"geolocation\") {\r\n                        // Utiliser la position GPS\r\n                        if (Log) Log.debug(\"[UI.Controls] Utilisation de la position GPS pour l'ajout de POI\");\r\n                        openForm(userPosition);\r\n                    } else {\r\n                        // Activer le mode placement\r\n                        if (Log) Log.debug(\"[UI.Controls] Activation du mode placement pour l'ajout de POI\");\r\n                        GeoLeaf.POI.PlacementMode.activate(map, (result) => {\r\n                            if (result?.latlng) {\r\n                                openForm(result.latlng);\r\n                            } else {\r\n                                link.classList.remove(\"disabled\");\r\n                                if (Log) Log.warn(\"[UI.Controls] Mode placement cancelled\");\r\n                            }\r\n                        });\r\n                    }\r\n                };\r\n\r\n                L.DomEvent.on(link, \"click\", handleAddPoi);\r\n                L.DomEvent.on(link, \"keydown\", (e) => {\r\n                    if (\r\n                        e.key === \"Enter\" ||\r\n                        e.key === \" \" ||\r\n                        e.key === \"Spacebar\"\r\n                    ) {\r\n                        handleAddPoi(e);\r\n                    }\r\n                });\r\n\r\n                this._link = link;\r\n\r\n                return container;\r\n            },\r\n\r\n            onRemove: function (_map) {\r\n                if (this._link) {\r\n                    L.DomEvent.off(this._link, \"click\");\r\n                    L.DomEvent.off(this._link, \"keydown\");\r\n                    this._link = null;\r\n                }\r\n            }\r\n        });\r\n\r\n        new L.Control.PoiAdd().addTo(map);\r\n        if (Log) Log.info(\"[UI.Controls] Contr√¥le POI Add ajout√© √† la carte\");\r\n    }\r\n\r\n    // ========================================\r\n    //   EXPORT\r\n    // ========================================\r\n\r\n    GeoLeaf._UIControls = {\r\n        initFullscreenControl,\r\n        initGeolocationControl,\r\n        initPoiAddControl\r\n    };\r\n\r\n})(typeof window !== \"undefined\" ? window : global);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n/**\r\n * GeoLeaf UI Module - Panel Builder\r\n * Construction de panneaux de d√©tails POI avec layouts configurables\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    GeoLeaf.UI = GeoLeaf.UI || {};\r\n    GeoLeaf.UI.PanelBuilder = GeoLeaf.UI.PanelBuilder || {};\r\n\r\n    // Helper pour utiliser createElement unifi√©\r\n    const $create = (tag, props, ...children) => {\r\n        return GeoLeaf.Utils && GeoLeaf.Utils.createElement\r\n            ? GeoLeaf.Utils.createElement(tag, props, ...children)\r\n            : document.createElement(tag);\r\n    };\r\n\r\n    /**\r\n     * R√©sout un chemin de type \"attributes.longDescription\" dans un objet POI.\r\n     * Retourne undefined si le chemin n'existe pas.\r\n     *\r\n     * @param {object} poi - Objet POI source.\r\n     * @param {string} fieldPath - Chemin en notation point√©e (ex: \"attributes.description\").\r\n     * @returns {*} Valeur r√©solue ou undefined.\r\n     */\r\n    function resolveField(poi, fieldPath) {\r\n        if (!poi || !fieldPath) return undefined;\r\n        const parts = fieldPath.split(\".\");\r\n        let current = poi;\r\n        for (let i = 0; i < parts.length; i += 1) {\r\n            if (current == null) {\r\n                return undefined;\r\n            }\r\n            current = current[parts[i]];\r\n        }\r\n        return current;\r\n    }\r\n\r\n    /**\r\n     * Cr√©e un bloc section simple (sans accord√©on).\r\n     *\r\n     * @param {string} label - Titre de la section.\r\n     * @param {Node|string} innerContent - Contenu de la section (Node ou texte).\r\n     * @param {string} extraClass - Classes CSS additionnelles.\r\n     * @returns {HTMLElement} √âl√©ment section.\r\n     */\r\n    function createPlainSection(label, innerContent, extraClass) {\r\n        const section = $create(\"section\", {\r\n            className: \"gl-poi-panel__section\" + (extraClass ? \" \" + extraClass : \"\")\r\n        });\r\n\r\n        if (label) {\r\n            const header = $create(\"h3\", {\r\n                className: \"gl-poi-panel__section-title\",\r\n                textContent: label\r\n            });\r\n            section.appendChild(header);\r\n        }\r\n\r\n        const body = $create(\"div\", {\r\n            className: \"gl-poi-panel__section-body\"\r\n        });\r\n        if (innerContent instanceof Node) {\r\n            body.appendChild(innerContent);\r\n        } else if (innerContent != null) {\r\n            body.textContent = String(innerContent);\r\n        }\r\n        section.appendChild(body);\r\n\r\n        return section;\r\n    }\r\n\r\n    /**\r\n     * Cr√©e un bloc section accord√©on (panneau repliable).\r\n     *\r\n     * @param {string} label - Titre de l'accord√©on.\r\n     * @param {Node|string} innerContent - Contenu de l'accord√©on.\r\n     * @param {object} options - Options { defaultOpen: boolean }.\r\n     * @returns {HTMLElement} √âl√©ment section accord√©on.\r\n     */\r\n    function createAccordionSection(label, innerContent, options) {\r\n        const opts = options || {};\r\n        const isOpen = Boolean(opts.defaultOpen);\r\n\r\n        const section = $create(\"section\", {\r\n            className: \"gl-accordion gl-poi-panel__section\" + (isOpen ? \" is-open\" : \"\")\r\n        });\r\n\r\n        const header = $create(\"button\", {\r\n            type: \"button\",\r\n            className: \"gl-accordion__header\"\r\n        });\r\n\r\n        const titleSpan = $create(\"span\", {\r\n            className: \"gl-accordion__title\",\r\n            textContent: label || \"\"\r\n        });\r\n        header.appendChild(titleSpan);\r\n\r\n        const iconSpan = $create(\"span\", {\r\n            className: \"gl-accordion__icon\",\r\n            attributes: { \"aria-hidden\": \"true\" },\r\n            textContent: \"‚ñæ\"\r\n        });\r\n        header.appendChild(iconSpan);\r\n\r\n        section.appendChild(header);\r\n\r\n        const body = $create(\"div\", {\r\n            className: \"gl-accordion__body\"\r\n        });\r\n\r\n        if (innerContent instanceof Node) {\r\n            body.appendChild(innerContent);\r\n        } else if (innerContent != null) {\r\n            const p = $create(\"p\", {\r\n                textContent: String(innerContent)\r\n            });\r\n            body.appendChild(p);\r\n        }\r\n\r\n        section.appendChild(body);\r\n        return section;\r\n    }\r\n\r\n    /**\r\n     * Construit le rendu d'un item de type \"text\".\r\n     *\r\n     * @param {*} value - Valeur √† afficher.\r\n     * @param {string} variant - Variant (\"multiline\" ou autre).\r\n     * @returns {HTMLElement|null} √âl√©ment div ou null.\r\n     */\r\n    function renderText(value, variant) {\r\n        const div = $create(\"div\", {\r\n            className: \"gl-poi-panel__text\" +\r\n                (variant === \"multiline\" ? \" gl-poi-panel__text--multiline\" : \"\"),\r\n            textContent: String(value)\r\n        });\r\n        return div;\r\n    }\r\n\r\n    /**\r\n     * Construit le rendu d'un item de type \"list\".\r\n     *\r\n     * @param {*} value - Array ou string (lignes s√©par√©es).\r\n     * @returns {HTMLElement|null} √âl√©ment ul ou null.\r\n     */\r\n    function renderList(value) {\r\n        const items = [];\r\n\r\n        if (Array.isArray(value)) {\r\n            value.forEach(function (entry) {\r\n                if (entry == null) return;\r\n\r\n                if (typeof entry === \"string\" || typeof entry === \"number\") {\r\n                    items.push(String(entry));\r\n                } else if (typeof entry === \"object\") {\r\n                    const label =\r\n                        typeof entry.label === \"string\"\r\n                            ? entry.label\r\n                            : typeof entry.text === \"string\"\r\n                            ? entry.text\r\n                            : null;\r\n                    const val = entry.value != null ? String(entry.value) : null;\r\n\r\n                    if (label && val) {\r\n                        items.push(label + \" : \" + val);\r\n                    } else if (label) {\r\n                        items.push(label);\r\n                    } else if (val) {\r\n                        items.push(val);\r\n                    }\r\n                }\r\n            });\r\n        } else if (typeof value === \"string\") {\r\n            value.split(/\\r?\\n/).forEach(function (line) {\r\n                const trimmed = line.trim();\r\n                if (trimmed) {\r\n                    items.push(trimmed);\r\n                }\r\n            });\r\n        }\r\n\r\n        if (!items.length) {\r\n            return null;\r\n        }\r\n\r\n        const ul = $create(\"ul\", {\r\n            className: \"gl-poi-panel__list\"\r\n        });\r\n\r\n        items.forEach(function (text) {\r\n            const li = $create(\"li\", {\r\n                className: \"gl-poi-panel__list-item\",\r\n                textContent: text\r\n            });\r\n            ul.appendChild(li);\r\n        });\r\n\r\n        return ul;\r\n    }\r\n\r\n    /**\r\n     * Construit le rendu d'un item de type \"table\".\r\n     *\r\n     * @param {Array} value - Tableau d'objets repr√©sentant les lignes.\r\n     * @param {object} item - Configuration du tableau (columns, borders).\r\n     * @returns {HTMLElement|null} Wrapper de tableau ou null.\r\n     */\r\n    function renderTable(value, item) {\r\n        if (!Array.isArray(value) || !value.length) {\r\n            return null;\r\n        }\r\n\r\n        const columns = Array.isArray(item.columns) ? item.columns : [];\r\n        if (!columns.length) {\r\n            return null;\r\n        }\r\n\r\n        const wrapper = $create(\"div\", {\r\n            className: \"gl-poi-panel__table-wrapper\"\r\n        });\r\n\r\n        const borders = item.borders || {};\r\n        const borderClasses = [];\r\n        if (borders.outer) borderClasses.push(\"gl-poi-panel__table--border-outer\");\r\n        if (borders.row) borderClasses.push(\"gl-poi-panel__table--border-row\");\r\n        if (borders.column) borderClasses.push(\"gl-poi-panel__table--border-column\");\r\n\r\n        const table = $create(\"table\", {\r\n            className: \"gl-poi-panel__table\" + (borderClasses.length ? \" \" + borderClasses.join(\" \") : \"\"),\r\n            attributes: borders.color ? { \"data-gl-border-color\": borders.color } : {}\r\n        });\r\n\r\n        // En-t√™te\r\n        const thead = $create(\"thead\");\r\n        const headRow = $create(\"tr\", {\r\n            className: \"gl-poi-panel__table-row gl-poi-panel__table-row--head\"\r\n        });\r\n\r\n        columns.forEach(function (col) {\r\n            const th = $create(\"th\", {\r\n                className: \"gl-poi-panel__table-cell gl-poi-panel__table-cell--head\",\r\n                textContent: col.label || col.key || \"\"\r\n            });\r\n            headRow.appendChild(th);\r\n        });\r\n\r\n        thead.appendChild(headRow);\r\n        table.appendChild(thead);\r\n\r\n        // Corps\r\n        const tbody = $create(\"tbody\");\r\n\r\n        value.forEach(function (rowObj) {\r\n            if (!rowObj || typeof rowObj !== \"object\") {\r\n                return;\r\n            }\r\n\r\n            const tr = $create(\"tr\", {\r\n                className: \"gl-poi-panel__table-row\"\r\n            });\r\n\r\n            columns.forEach(function (col) {\r\n                const cellVal = rowObj[col.key];\r\n                const td = $create(\"td\", {\r\n                    className: \"gl-poi-panel__table-cell\",\r\n                    textContent: cellVal == null ? \"\" : String(cellVal)\r\n                });\r\n\r\n                tr.appendChild(td);\r\n            });\r\n\r\n            tbody.appendChild(tr);\r\n        });\r\n\r\n        table.appendChild(tbody);\r\n        wrapper.appendChild(table);\r\n        return wrapper;\r\n    }\r\n\r\n    /**\r\n     * Construit le rendu d'un item de type \"gallery\".\r\n     *\r\n     * @param {Array} value - Tableau d'images { url, alt, caption }.\r\n     * @returns {HTMLElement|null} Container galerie ou null.\r\n     */\r\n    function renderGallery(value) {\r\n        if (!Array.isArray(value)) {\r\n            return null;\r\n        }\r\n\r\n        const container = $create(\"div\", {\r\n            className: \"gl-poi-panel__gallery\"\r\n        });\r\n\r\n        value.forEach(function (img) {\r\n            if (!img) return;\r\n\r\n            const figure = $create(\"figure\", {\r\n                className: \"gl-poi-panel__gallery-item\"\r\n            });\r\n\r\n            const imgEl = $create(\"img\", {\r\n                src: img.url || img,\r\n                alt: img.alt || \"\"\r\n            });\r\n            figure.appendChild(imgEl);\r\n\r\n            if (img.caption) {\r\n                const figCap = $create(\"figcaption\", {\r\n                    textContent: img.caption\r\n                });\r\n                figure.appendChild(figCap);\r\n            }\r\n\r\n            container.appendChild(figure);\r\n        });\r\n\r\n        return container;\r\n    }\r\n\r\n    /**\r\n     * Construit le rendu d'un item de type \"reviews\" (avis voyageurs).\r\n     *\r\n     * @param {*} value - Array ou objet avec propri√©t√© 'recent'.\r\n     * @returns {HTMLElement|null} Container d'avis ou null.\r\n     */\r\n    function renderReviews(value) {\r\n        // Si value est un objet avec une propri√©t√© 'recent', utiliser celle-ci\r\n        let reviewsArray = value;\r\n        if (value && typeof value === 'object' && !Array.isArray(value) && Array.isArray(value.recent)) {\r\n            reviewsArray = value.recent;\r\n        }\r\n\r\n        if (!Array.isArray(reviewsArray)) {\r\n            return null;\r\n        }\r\n\r\n        const container = $create(\"div\", {\r\n            className: \"gl-poi-panel__reviews gl-poi-sidepanel__reviews\"\r\n        });\r\n\r\n        reviewsArray.forEach(function (review) {\r\n            if (!review) return;\r\n\r\n            const itemEl = $create(\"article\", {\r\n                className: \"gl-poi-panel__review\"\r\n            });\r\n\r\n            const header = $create(\"header\", {\r\n                className: \"gl-poi-panel__review-header\"\r\n            });\r\n\r\n            const nameSpan = $create(\"span\", {\r\n                className: \"gl-poi-panel__review-author\",\r\n                textContent: review.authorName || \"\"\r\n            });\r\n            header.appendChild(nameSpan);\r\n\r\n            if (typeof review.rating === \"number\") {\r\n                const ratingSpan = $create(\"span\", {\r\n                    className: \"gl-poi-panel__review-rating\",\r\n                    textContent: review.rating.toFixed(1) + \"/5\"\r\n                });\r\n                header.appendChild(ratingSpan);\r\n            }\r\n\r\n            if (review.source) {\r\n                const sourceSpan = $create(\"span\", {\r\n                    className: \"gl-poi-panel__review-source\",\r\n                    textContent: review.source\r\n                });\r\n                header.appendChild(sourceSpan);\r\n            }\r\n\r\n            itemEl.appendChild(header);\r\n\r\n            if (review.title) {\r\n                const titleEl = $create(\"h4\", {\r\n                    className: \"gl-poi-panel__review-title\",\r\n                    textContent: review.title\r\n                });\r\n                itemEl.appendChild(titleEl);\r\n            }\r\n\r\n            // G√©rer √† la fois 'text' (ancien format) et 'comment' (nouveau format)\r\n            const reviewText = review.text || review.comment;\r\n            if (reviewText) {\r\n                const textEl = $create(\"p\", {\r\n                    className: \"gl-poi-panel__review-text\",\r\n                    textContent: reviewText\r\n                });\r\n                itemEl.appendChild(textEl);\r\n            }\r\n\r\n            // G√©rer √† la fois 'date' (ancien format) et 'createdAt' (nouveau format)\r\n            const reviewDate = review.date || review.createdAt;\r\n            if (reviewDate) {\r\n                const dateEl = $create(\"time\", {\r\n                    className: \"gl-poi-panel__review-date\",\r\n                    textContent: reviewDate\r\n                });\r\n                itemEl.appendChild(dateEl);\r\n            }\r\n\r\n            const footer = $create(\"footer\", {\r\n                className: \"gl-poi-panel__review-footer\"\r\n            });\r\n\r\n            if (typeof review.helpfulCount === \"number\") {\r\n                const helpfulSpan = $create(\"span\", {\r\n                    className: \"gl-poi-panel__review-helpful\",\r\n                    textContent: review.helpfulCount + \" personnes ont trouv√© cet avis utile\"\r\n                });\r\n                footer.appendChild(helpfulSpan);\r\n            }\r\n\r\n            if (review.url) {\r\n                const link = $create(\"a\", {\r\n                    href: review.url,\r\n                    target: \"_blank\",\r\n                    rel: \"noopener noreferrer\",\r\n                    className: \"gl-poi-panel__review-link\",\r\n                    textContent: \"Voir l'avis\"\r\n                });\r\n                footer.appendChild(link);\r\n            }\r\n\r\n            itemEl.appendChild(footer);\r\n            container.appendChild(itemEl);\r\n        });\r\n\r\n        return container;\r\n    }\r\n\r\n    /**\r\n     * Construit le contenu interne pour un item de layout.\r\n     * Dispatcher principal vers les fonctions de rendu sp√©cialis√©es.\r\n     *\r\n     * @param {object} poi - Objet POI source.\r\n     * @param {object} item - Configuration du layout item (type, field, variant, etc).\r\n     * @returns {HTMLElement|null} √âl√©ment construit ou null.\r\n     */\r\n    function buildLayoutItemContent(poi, item) {\r\n        const type = item.type;\r\n        const value = resolveField(poi, item.field);\r\n\r\n        if (value == null || value === \"\") {\r\n            if (!Array.isArray(value)) {\r\n                return null;\r\n            }\r\n        }\r\n\r\n        // Dispatch par type\r\n        if (type === \"text\") {\r\n            return renderText(value, item.variant);\r\n        }\r\n\r\n        if (type === \"list\") {\r\n            return renderList(value);\r\n        }\r\n\r\n        if (type === \"table\") {\r\n            return renderTable(value, item);\r\n        }\r\n\r\n        if (type === \"gallery\") {\r\n            return renderGallery(value);\r\n        }\r\n\r\n        if (type === \"reviews\") {\r\n            return renderReviews(value);\r\n        }\r\n\r\n        // Fallback : texte simple\r\n        const defaultDiv = $create(\"div\", {\r\n            className: \"gl-poi-panel__text\",\r\n            textContent: String(value)\r\n        });\r\n        return defaultDiv;\r\n    }\r\n\r\n    // ========================================\r\n    //   EXPORT\r\n    // ========================================\r\n\r\n    GeoLeaf.UI.PanelBuilder = {\r\n        resolveField,\r\n        createPlainSection,\r\n        createAccordionSection,\r\n        renderText,\r\n        renderList,\r\n        renderTable,\r\n        renderGallery,\r\n        renderReviews,\r\n        buildLayoutItemContent\r\n    };\r\n\r\n})(typeof window !== \"undefined\" ? window : global);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n/**\r\n * GeoLeaf UI DOM Utilities Module\r\n * Utilitaires DOM r√©utilisables pour l'interface utilisateur\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    GeoLeaf._UIDomUtils = GeoLeaf._UIDomUtils || {};\r\n\r\n    // Helper pour utiliser createElement unifi√©\r\n    const $create = (tag, props, ...children) => {\r\n        return GeoLeaf.Utils && GeoLeaf.Utils.createElement\r\n            ? GeoLeaf.Utils.createElement(tag, props, ...children)\r\n            : document.createElement(tag);\r\n    };\r\n\r\n    const Log = GeoLeaf.Log || console;\r\n\r\n    /**\r\n     * R√©sout une valeur √† partir d'un chemin de propri√©t√© (ex: \"attributes.reviews.rating\").\r\n     * @param {Object} obj - Objet source (POI, route, etc.)\r\n     * @param {string} fieldPath - Chemin de propri√©t√© s√©par√© par des points\r\n     * @returns {*} Valeur trouv√©e ou undefined\r\n     */\r\n    GeoLeaf._UIDomUtils.resolveField = function (obj, fieldPath) {\r\n        if (!obj || !fieldPath) return undefined;\r\n        const parts = fieldPath.split(\".\");\r\n        let current = obj;\r\n        for (let i = 0; i < parts.length; i += 1) {\r\n            if (current == null) {\r\n                return undefined;\r\n            }\r\n            current = current[parts[i]];\r\n        }\r\n        return current;\r\n    };\r\n\r\n    /**\r\n     * Attache le comportement d'accord√©on (toggle open/close) √† un conteneur.\r\n     * √âvite les attachements multiples avec un flag.\r\n     * @param {HTMLElement} container - Conteneur parent avec des √©l√©ments .gl-accordion\r\n     */\r\n    GeoLeaf._UIDomUtils.attachAccordionBehavior = function (container) {\r\n        if (!container || container._glAccordionBound) return;\r\n        container._glAccordionBound = true;\r\n\r\n        container.addEventListener(\"click\", function (evt) {\r\n            const header = evt.target.closest(\".gl-accordion__header\");\r\n            if (!header || !container.contains(header)) {\r\n                return;\r\n            }\r\n            const section = header.closest(\".gl-accordion\");\r\n            if (!section) return;\r\n\r\n            section.classList.toggle(\"is-open\");\r\n        });\r\n    };\r\n\r\n    /**\r\n     * R√©cup√®re le profil actif depuis GeoLeaf.Config.\r\n     * @returns {Object|null} Objet profil ou null si indisponible\r\n     */\r\n    GeoLeaf._UIDomUtils.getActiveProfileConfig = function () {\r\n        if (\r\n            !GeoLeaf.Config ||\r\n            typeof GeoLeaf.Config.getActiveProfile !== \"function\"\r\n        ) {\r\n            Log.warn(\r\n                \"[UIDomUtils] GeoLeaf.Config.getActiveProfile() indisponible. Impossible de r√©cup√©rer le profil actif.\"\r\n            );\r\n            return null;\r\n        }\r\n        const profile = GeoLeaf.Config.getActiveProfile();\r\n        if (!profile) {\r\n            Log.warn(\r\n                \"[UIDomUtils] Aucun profil actif retourn√© par GeoLeaf.Config.getActiveProfile().\"\r\n            );\r\n        }\r\n        return profile || null;\r\n    };\r\n\r\n    /**\r\n     * Construit les <option> d'un select √† partir de la taxonomie et d'un chemin optionsFrom.\r\n     * @param {HTMLSelectElement} selectEl - √âl√©ment <select> √† peupler\r\n     * @param {Object} profile - Objet profil contenant la taxonomie\r\n     * @param {string} optionsFrom - Chemin vers les options (ex: \"taxonomy.categories\")\r\n     */\r\n    GeoLeaf._UIDomUtils.populateSelectOptionsFromTaxonomy = function (\r\n        selectEl,\r\n        profile,\r\n        optionsFrom\r\n    ) {\r\n        if (!selectEl || !profile || !profile.taxonomy) return;\r\n\r\n        const taxonomy = profile.taxonomy;\r\n        const emptyOpt = $create(\"option\", {\r\n            value: \"\",\r\n            textContent: \"‚Äî Tous ‚Äî\"\r\n        });\r\n        selectEl.appendChild(emptyOpt);\r\n\r\n        if (optionsFrom === \"taxonomy.categories\") {\r\n            const categories = taxonomy.categories || {};\r\n            Object.keys(categories).forEach(function (catId) {\r\n                const cat = categories[catId];\r\n                const opt = $create(\"option\", {\r\n                    value: catId,\r\n                    textContent: cat.label || catId\r\n                });\r\n                selectEl.appendChild(opt);\r\n            });\r\n            return;\r\n        }\r\n\r\n        if (optionsFrom === \"taxonomy.categories[*].subcategories\") {\r\n            const categories = taxonomy.categories || {};\r\n            Object.keys(categories).forEach(function (catId) {\r\n                const cat = categories[catId];\r\n                const subs = (cat && cat.subcategories) || {};\r\n                Object.keys(subs).forEach(function (subId) {\r\n                    const sub = subs[subId];\r\n                    const catLabel = cat.label || catId;\r\n                    const subLabel = sub.label || subId;\r\n                    const opt = $create(\"option\", {\r\n                        value: subId,\r\n                        textContent: catLabel + \" ‚Äì \" + subLabel,\r\n                        attributes: { \"data-category-id\": catId }\r\n                    });\r\n                    selectEl.appendChild(opt);\r\n                });\r\n            });\r\n        }\r\n    };\r\n\r\n    Log.info(\"[GeoLeaf._UIDomUtils] Module DOM Utilities charg√©\");\r\n\r\n})(window);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    /**\r\n     * Namespace global GeoLeaf\r\n     */\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    GeoLeaf.UI = GeoLeaf.UI || {};\r\n\r\n    /**\r\n     * Logger unifi√©\r\n     */\r\n    const Log = GeoLeaf.Log;\r\n\r\n    /**\r\n     * Contexte pour les logs\r\n     * @const\r\n     */\r\n    const CONTEXT = \"[GeoLeaf.UI.CoordinatesDisplay]\";\r\n\r\n    /**\r\n     * Texte par d√©faut des coordonn√©es\r\n     * @const\r\n     */\r\n    const DEFAULT_COORDS_TEXT = \"Lat: --, Lng: --\";\r\n\r\n    /**\r\n     * Module GeoLeaf.UI.CoordinatesDisplay\r\n     *\r\n     * R√¥le :\r\n     * - Afficher les coordonn√©es du curseur en temps r√©el\r\n     * - Positionner le contr√¥le en bas √† droite √† c√¥t√© de la l√©gende\r\n     * - Permettre l'activation/d√©sactivation via configuration\r\n     */\r\n    const CoordinatesDisplay = {\r\n        /**\r\n         * R√©f√©rence √† la carte Leaflet.\r\n         * @type {L.Map|null}\r\n         * @private\r\n         */\r\n        _map: null,\r\n\r\n        /**\r\n         * R√©f√©rence au contr√¥le Leaflet des coordonn√©es.\r\n         * @type {L.Control|null}\r\n         * @private\r\n         */\r\n        _control: null,\r\n\r\n        /**\r\n         * Element DOM pour l'affichage des coordonn√©es\r\n         * @type {HTMLElement|null}\r\n         * @private\r\n         */\r\n        _coordsElement: null,\r\n\r\n        /**\r\n         * R√©f√©rence bound du listener mousemove (pour pouvoir le retirer)\r\n         * @type {Function|null}\r\n         * @private\r\n         */\r\n        _boundMouseMoveHandler: null,\r\n\r\n        /**\r\n         * Options du module\r\n         * @type {Object}\r\n         * @private\r\n         */\r\n        _options: {\r\n            position: \"bottomleft\",\r\n            decimals: 6\r\n        },\r\n\r\n        /**\r\n         * Initialise le module de coordonn√©es\r\n         * @param {L.Map} map - Instance de la carte Leaflet\r\n         * @param {Object} options - Options de configuration\r\n         */\r\n        init(map, options = {}) {\r\n            try {\r\n                if (!map) {\r\n                    throw new Error(\"Une instance de carte Leaflet est requise.\");\r\n                }\r\n\r\n                this._map = map;\r\n                this._options = Object.assign({}, this._options, options);\r\n\r\n                // V√©rifier si le module est activ√© dans la config\r\n                const showCoordinates = GeoLeaf.Config?.get(\"ui.showCoordinates\");\r\n\r\n                if (showCoordinates === false) {\r\n                    Log.info(`${CONTEXT} Affichage des coordonn√©es d√©sactiv√© dans la configuration.`);\r\n                    return;\r\n                }\r\n\r\n                // Stocker la r√©f√©rence bound du listener\r\n                this._boundMouseMoveHandler = this._onMouseMove.bind(this);\r\n\r\n                // Cr√©er le contr√¥le Leaflet\r\n                this._createControl();\r\n\r\n                Log.info(`${CONTEXT} Module initialis√© avec succ√®s.`);\r\n\r\n            } catch (err) {\r\n                Log.error(`${CONTEXT} Erreur lors de l'initialisation :`, err.message);\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Cr√©e le contr√¥le Leaflet pour l'affichage des coordonn√©es\r\n         * @private\r\n         */\r\n        _createControl() {\r\n            try {\r\n                // Attendre que le DOM soit pr√™t et chercher le wrapper d'√©chelle\r\n                setTimeout(() => {\r\n                    const scaleWrapper = document.querySelector('.gl-scale-main-wrapper');\r\n\r\n                    if (scaleWrapper) {\r\n                        // Ajouter un s√©parateur avant les coordonn√©es\r\n                        L.DomUtil.create('div', 'gl-scale-separator', scaleWrapper);\r\n\r\n                        // Cr√©er l'√©l√©ment d'affichage des coordonn√©es directement dans le wrapper\r\n                        this._coordsElement = L.DomUtil.create('div', 'gl-scale-coordinates', scaleWrapper);\r\n                        this._coordsElement.textContent = DEFAULT_COORDS_TEXT;\r\n\r\n                        // Ajouter l'√©couteur d'√©v√©nement mousemove avec r√©f√©rence stock√©e\r\n                        this._map.on('mousemove', this._boundMouseMoveHandler);\r\n\r\n                        Log.info(`${CONTEXT} Coordonn√©es int√©gr√©es au wrapper d'√©chelle.`);\r\n                    } else {\r\n                        Log.warn(`${CONTEXT} Wrapper d'√©chelle non trouv√©, utilisation du mode classique.`);\r\n                        this._createStandaloneControl();\r\n                    }\r\n                }, 100);\r\n\r\n            } catch (err) {\r\n                Log.error(`${CONTEXT} Erreur lors de la cr√©ation du contr√¥le :`, err.message);\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Cr√©e un contr√¥le standalone en fallback\r\n         * @private\r\n         */\r\n        _createStandaloneControl() {\r\n            const CoordinatesControl = L.Control.extend({\r\n                options: {\r\n                    position: this._options.position\r\n                },\r\n\r\n                onAdd: (map) => {\r\n                    const container = L.DomUtil.create(\"div\", \"geoleaf-coordinates-display\");\r\n                    L.DomEvent.disableClickPropagation(container);\r\n                    L.DomEvent.disableScrollPropagation(container);\r\n                    this._coordsElement = L.DomUtil.create(\"div\", \"coordinates-content\", container);\r\n                    this._coordsElement.textContent = DEFAULT_COORDS_TEXT;\r\n                    map.on(\"mousemove\", this._boundMouseMoveHandler);\r\n                    return container;\r\n                },\r\n\r\n                onRemove: (map) => {\r\n                    map.off(\"mousemove\", this._boundMouseMoveHandler);\r\n                }\r\n            });\r\n\r\n            this._control = new CoordinatesControl();\r\n            this._control.addTo(this._map);\r\n        },\r\n\r\n        /**\r\n         * Gestionnaire d'√©v√©nement pour le mouvement de la souris\r\n         * @param {Object} e - √âv√©nement Leaflet\r\n         * @private\r\n         */\r\n        _onMouseMove(e) {\r\n            if (!this._coordsElement) return;\r\n\r\n            const lat = e.latlng.lat.toFixed(this._options.decimals);\r\n            const lng = e.latlng.lng.toFixed(this._options.decimals);\r\n\r\n            this._coordsElement.textContent = `Lat: ${lat}, Lng: ${lng}`;\r\n        },\r\n\r\n        /**\r\n         * D√©truit le contr√¥le et nettoie les ressources\r\n         */\r\n        destroy() {\r\n            try {\r\n                // Nettoyer l'√©couteur d'√©v√©nements avec la r√©f√©rence stock√©e\r\n                if (this._map && this._boundMouseMoveHandler) {\r\n                    this._map.off('mousemove', this._boundMouseMoveHandler);\r\n                    this._boundMouseMoveHandler = null;\r\n                }\r\n\r\n                // Retirer l'√©l√©ment du DOM s'il existe\r\n                if (this._coordsElement && this._coordsElement.parentNode) {\r\n                    this._coordsElement.parentNode.removeChild(this._coordsElement);\r\n                    this._coordsElement = null;\r\n                }\r\n\r\n                // Retirer le contr√¥le standalone s'il existe\r\n                if (this._control && this._map) {\r\n                    this._map.removeControl(this._control);\r\n                    this._control = null;\r\n                }\r\n\r\n                Log.info(`${CONTEXT} Module d√©truit avec succ√®s.`);\r\n\r\n            } catch (err) {\r\n                Log.error(`${CONTEXT} Erreur lors de la destruction :`, err.message);\r\n            }\r\n        }\r\n    };\r\n\r\n    // Export du module\r\n    GeoLeaf.UI.CoordinatesDisplay = CoordinatesDisplay;\r\n\r\n})(typeof globalThis !== \"undefined\" ? globalThis : window);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    /**\r\n     * Namespace global GeoLeaf\r\n     */\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    GeoLeaf.UI = GeoLeaf.UI || {};\r\n\r\n    /**\r\n     * Logger unifi√©\r\n     */\r\n    const Log = GeoLeaf.Log;\r\n\r\n    /**\r\n     * Module GeoLeaf.UI.Branding\r\n     *\r\n     * R√¥le :\r\n     * - Afficher un texte de branding personnalisable\r\n     * - Positionner le contr√¥le selon la configuration\r\n     * - Permettre l'activation/d√©sactivation via configuration\r\n     */\r\n    const Branding = {\r\n        /**\r\n         * R√©f√©rence √† la carte Leaflet.\r\n         * @type {L.Map|null}\r\n         * @private\r\n         */\r\n        _map: null,\r\n\r\n        /**\r\n         * R√©f√©rence au contr√¥le Leaflet de branding.\r\n         * @type {L.Control|null}\r\n         * @private\r\n         */\r\n        _control: null,\r\n\r\n        /**\r\n         * Options du module\r\n         * @type {Object}\r\n         * @private\r\n         */\r\n        _options: {\r\n            position: \"bottomleft\",\r\n            text: \"Propuls√© par ¬© GeoLeaf with Leaflet\"\r\n        },\r\n\r\n        /**\r\n         * Initialise le module de branding\r\n         * @param {L.Map} map - Instance de la carte Leaflet\r\n         * @param {Object} options - Options de configuration\r\n         */\r\n        init(map, options = {}) {\r\n            const context = \"[GeoLeaf.UI.Branding]\";\r\n\r\n            try {\r\n                if (!map) {\r\n                    throw new Error(\"Une instance de carte Leaflet est requise.\");\r\n                }\r\n\r\n                this._map = map;\r\n                this._options = Object.assign({}, this._options, options);\r\n\r\n                // V√©rifier si le module est activ√© dans la config\r\n                const brandingConfig = GeoLeaf.Config?.get(\"brandingConfig\");\r\n\r\n                if (brandingConfig === false || (brandingConfig && brandingConfig.enabled === false)) {\r\n                    Log.info(`${context} Branding d√©sactiv√© dans la configuration.`);\r\n                    return;\r\n                }\r\n\r\n                // Utiliser les param√®tres de config si disponibles\r\n                if (brandingConfig && typeof brandingConfig === \"object\") {\r\n                    if (brandingConfig.text) {\r\n                        this._options.text = brandingConfig.text;\r\n                    }\r\n                    if (brandingConfig.position) {\r\n                        this._options.position = brandingConfig.position;\r\n                    }\r\n                }\r\n\r\n                // Cr√©er le contr√¥le Leaflet\r\n                this._createControl();\r\n\r\n                Log.info(`${context} Module initialis√© avec succ√®s.`);\r\n\r\n            } catch (err) {\r\n                Log.error(`${context} Erreur lors de l'initialisation :`, err.message);\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Cr√©e le contr√¥le Leaflet pour l'affichage du branding\r\n         * @private\r\n         */\r\n        _createControl() {\r\n            const context = \"[GeoLeaf.UI.Branding]\";\r\n\r\n            try {\r\n                // D√©finir le contr√¥le Leaflet personnalis√©\r\n                const BrandingControl = L.Control.extend({\r\n                    options: {\r\n                        position: this._options.position\r\n                    },\r\n\r\n                    onAdd: () => {\r\n                        // Cr√©er le conteneur principal\r\n                        const container = L.DomUtil.create(\"div\", \"geoleaf-branding\");\r\n\r\n                        // Emp√™cher les √©v√©nements de la carte sur ce contr√¥le\r\n                        L.DomEvent.disableClickPropagation(container);\r\n                        L.DomEvent.disableScrollPropagation(container);\r\n\r\n                        // Cr√©er l'√©l√©ment d'affichage du texte\r\n                        const brandingElement = L.DomUtil.create(\"div\", \"branding-content\", container);\r\n                        // SAFE: Utilisation de textContent pour √©viter XSS\r\n                        brandingElement.textContent = this._options.text;\r\n\r\n                        return container;\r\n                    },\r\n\r\n                    onRemove: () => {\r\n                        // Rien √† nettoyer pour ce contr√¥le\r\n                    }\r\n                });\r\n\r\n                // Cr√©er et ajouter le contr√¥le √† la carte\r\n                this._control = new BrandingControl();\r\n                this._control.addTo(this._map);\r\n\r\n                Log.info(`${context} Contr√¥le de branding cr√©√© et ajout√© √† la carte.`);\r\n\r\n            } catch (err) {\r\n                Log.error(`${context} Erreur lors de la cr√©ation du contr√¥le :`, err.message);\r\n            }\r\n        },\r\n\r\n        /**\r\n         * D√©truit le contr√¥le et nettoie les ressources\r\n         */\r\n        destroy() {\r\n            const context = \"[GeoLeaf.UI.Branding]\";\r\n\r\n            try {\r\n                if (this._control && this._map) {\r\n                    this._map.removeControl(this._control);\r\n                    this._control = null;\r\n                }\r\n\r\n                Log.info(`${context} Module d√©truit avec succ√®s.`);\r\n\r\n            } catch (err) {\r\n                Log.error(`${context} Erreur lors de la destruction :`, err.message);\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Active l'affichage du branding\r\n         */\r\n        show() {\r\n            if (this._control && !this._map.hasControl(this._control)) {\r\n                this._control.addTo(this._map);\r\n            }\r\n        },\r\n\r\n        /**\r\n         * D√©sactive l'affichage du branding\r\n         */\r\n        hide() {\r\n            if (this._control && this._map) {\r\n                this._map.removeControl(this._control);\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Met √† jour le texte du branding\r\n         * @param {string} text - Nouveau texte\r\n         */\r\n        setText(text) {\r\n            if (this._control) {\r\n                const container = this._control.getContainer();\r\n                if (container) {\r\n                    const brandingElement = container.querySelector(\".branding-content\");\r\n                    if (brandingElement) {\r\n                        // SAFE: Utilisation de textContent pour √©viter XSS\r\n                        brandingElement.textContent = text;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    // Export du module\r\n    GeoLeaf.UI.Branding = Branding;\r\n\r\n})(typeof globalThis !== \"undefined\" ? globalThis : window);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n/**\r\n * GeoLeaf Content Builder - Core Module\r\n *\r\n * Centralise les fonctions utilitaires, validateurs et r√©solution de badges\r\n * pour tous les renderers du Content Builder.\r\n *\r\n * @module ui/content-builder/core\r\n * @author GeoLeaf Team\r\n * @version 1.0.0\r\n * @since Sprint 4.5 (Janvier 2026)\r\n *\r\n * @example\r\n * // Acc√®s au module Core\r\n * const Core = GeoLeaf._ContentBuilder.Core;\r\n *\r\n * // Validation image URL\r\n * const imageUrl = Core.validateImageUrl('https://example.com/photo.jpg');\r\n *\r\n * // R√©solution badge taxonomie\r\n * const badge = Core.resolveBadge(poi, 'attributes.categoryId', 'default');\r\n *\r\n * // Formatage coordonn√©es\r\n * const coords = Core.formatCoordinates(45.7578, 4.8320);\r\n * // Retourne: \"45.757800, 4.832000\"\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    if (!GeoLeaf._ContentBuilder) GeoLeaf._ContentBuilder = {};\r\n\r\n    // ========================================\r\n    //   D√âPENDANCES & HELPERS\r\n    // ========================================\r\n\r\n    /**\r\n     * R√©cup√®re la fonction resolveField depuis GeoLeaf.Utils avec fallback d√©fensif.\r\n     *\r\n     * Cette fonction permet de r√©soudre des valeurs dans des objets POI en testant\r\n     * plusieurs chemins (paths) dans l'ordre jusqu'√† trouver une valeur valide.\r\n     *\r\n     * @function getResolveField\r\n     * @returns {Function} Fonction resolveField(obj, ...paths) ‚Üí value|null\r\n     *\r\n     * @example\r\n     * const resolveField = getResolveField();\r\n     * const name = resolveField(poi, 'attributes.name', 'attributes.nom', 'properties.name');\r\n     * // Teste dans l'ordre: poi.attributes.name ‚Üí poi.attributes.nom ‚Üí poi.properties.name\r\n     * // Retourne la premi√®re valeur non-null trouv√©e\r\n     *\r\n     * @example\r\n     * // Avec fallback si Utils non charg√©\r\n     * const resolveField = getResolveField();\r\n     * const value = resolveField({ attributes: { price: 42 } }, 'attributes.price');\r\n     * // Retourne: 42\r\n     */\r\n    function getResolveField() {\r\n        if (GeoLeaf.Utils && typeof GeoLeaf.Utils.resolveField === 'function') {\r\n            return GeoLeaf.Utils.resolveField;\r\n        }\r\n        // Fallback minimal si Utils non charg√©\r\n        return function (obj, ...paths) {\r\n            if (!obj) return null;\r\n            for (const path of paths) {\r\n                if (!path) continue;\r\n                const parts = String(path).split('.');\r\n                let current = obj;\r\n                let found = true;\r\n                for (const part of parts) {\r\n                    if (current && typeof current === 'object' && part in current) {\r\n                        current = current[part];\r\n                    } else {\r\n                        found = false;\r\n                        break;\r\n                    }\r\n                }\r\n                if (found && current !== undefined && current !== null) {\r\n                    return current;\r\n                }\r\n            }\r\n            return null;\r\n        };\r\n    }\r\n\r\n    /**\r\n     * R√©cup√®re la fonction escapeHtml depuis GeoLeaf.Security avec fallback d√©fensif.\r\n     *\r\n     * Essentiel pour pr√©venir les attaques XSS en √©chappant tous les caract√®res HTML\r\n     * sp√©ciaux avant insertion dans le DOM.\r\n     *\r\n     * @function getEscapeHtml\r\n     * @returns {Function} Fonction escapeHtml(str) ‚Üí string\r\n     *\r\n     * @example\r\n     * const escapeHtml = getEscapeHtml();\r\n     * const safe = escapeHtml('<script>alert(\"XSS\")</script>');\r\n     * // Retourne: \"&lt;script&gt;alert(&quot;XSS&quot;)&lt;/script&gt;\"\r\n     *\r\n     * @example\r\n     * // Utilisation dans un renderer\r\n     * const escapeHtml = getEscapeHtml();\r\n     * const html = '<div>' + escapeHtml(userInput) + '</div>';\r\n     * // userInput est s√©curis√© contre XSS\r\n     */\r\n    function getEscapeHtml() {\r\n        if (GeoLeaf.Security && typeof GeoLeaf.Security.escapeHtml === 'function') {\r\n            return GeoLeaf.Security.escapeHtml;\r\n        }\r\n        // Fallback minimal si Security non charg√©\r\n        return function (str) {\r\n            if (str == null) return '';\r\n            const div = document.createElement('div');\r\n            div.textContent = String(str);\r\n            return div.innerHTML;\r\n        };\r\n    }\r\n\r\n    /**\r\n     * R√©cup√®re le profil de configuration actif depuis GeoLeaf.Config.\r\n     *\r\n     * Le profil contient la taxonomie (cat√©gories, sous-cat√©gories), les styleRules,\r\n     * et toutes les configurations sp√©cifiques √† la couche active.\r\n     *\r\n     * @function getActiveProfile\r\n     * @returns {Object|null} Profil actif avec structure:\r\n     *   - {Object} taxonomy - Cat√©gories et sous-cat√©gories\r\n     *   - {Array} styleRules - R√®gles de style conditionnelles\r\n     *   - {Object} detailPopup - Configuration popup POI\r\n     *   - {Object} detailTooltip - Configuration tooltip POI\r\n     *   - {Array} detailLayout - Configuration panel POI\r\n     * @returns {null} Si Config non charg√© ou pas de profil actif\r\n     *\r\n     * @example\r\n     * const profile = getActiveProfile();\r\n     * if (profile && profile.taxonomy) {\r\n     *   const categories = profile.taxonomy.categories;\r\n     *   // Acc√®s aux cat√©gories de la taxonomie\r\n     * }\r\n     */\r\n    function getActiveProfile() {\r\n        if (GeoLeaf.Config && typeof GeoLeaf.Config.getActiveProfile === 'function') {\r\n            return GeoLeaf.Config.getActiveProfile() || null;\r\n        }\r\n        return null;\r\n    }\r\n\r\n    /**\r\n     * R√©cup√®re le syst√®me de logging GeoLeaf.Log avec fallback sur console.\r\n     *\r\n     * Permet d'utiliser les m√©thodes debug(), info(), warn(), error() de mani√®re\r\n     * coh√©rente dans tout le Content Builder.\r\n     *\r\n     * @function getLog\r\n     * @returns {Object} Logger avec m√©thodes:\r\n     *   - {Function} debug(message, ...args) - Logs de d√©bogage\r\n     *   - {Function} info(message, ...args) - Logs informatifs\r\n     *   - {Function} warn(message, ...args) - Avertissements\r\n     *   - {Function} error(message, ...args) - Erreurs\r\n     *\r\n     * @example\r\n     * const log = getLog();\r\n     * log.info('[ContentBuilder] Rendering popup');\r\n     * log.warn('[ContentBuilder] Image URL invalide:', url);\r\n     * log.error('[ContentBuilder] POI invalide:', poi);\r\n     */\r\n    function getLog() {\r\n        return GeoLeaf.Log || console;\r\n    }\r\n\r\n    // ========================================\r\n    //   VALIDATORS\r\n    // ========================================\r\n\r\n    /**\r\n     * Valide une URL d'image en v√©rifiant les protocoles autoris√©s et la structure.\r\n     *\r\n     * Utilise GeoLeaf.Security.validateUrl si disponible, sinon applique une validation\r\n     * basique avec whitelist de protocoles (https://, http://, data:image//, /, ./).\r\n     *\r\n     * @function validateImageUrl\r\n     * @param {string} url - URL √† valider\r\n     * @returns {string|null} URL valide (trimmed) ou null si invalide\r\n     *\r\n     * @example\r\n     * // URL HTTPS valide\r\n     * const url1 = validateImageUrl('https://example.com/photo.jpg');\r\n     * // Retourne: 'https://example.com/photo.jpg'\r\n     *\r\n     * @example\r\n     * // Data URL valide\r\n     * const url2 = validateImageUrl('data:image/png;base64,iVBORw0KG...');\r\n     * // Retourne: 'data:image/png;base64,iVBORw0KG...'\r\n     *\r\n     * @example\r\n     * // Chemin relatif valide\r\n     * const url3 = validateImageUrl('/images/photo.jpg');\r\n     * // Retourne: '/images/photo.jpg'\r\n     *\r\n     * @example\r\n     * // URL invalide (protocole interdit)\r\n     * const url4 = validateImageUrl('javascript:alert(1)');\r\n     * // Retourne: null\r\n     */\r\n    function validateImageUrl(url) {\r\n        if (!url || typeof url !== 'string') return null;\r\n\r\n        // Utiliser le validator de GeoLeaf.Security si disponible\r\n        if (GeoLeaf.Security && typeof GeoLeaf.Security.validateUrl === 'function') {\r\n            try {\r\n                return GeoLeaf.Security.validateUrl(url);\r\n            } catch (e) {\r\n                getLog().warn('[ContentBuilder.Core] URL image invalide:', e.message);\r\n                return null;\r\n            }\r\n        }\r\n\r\n        // Fallback : validation basique\r\n        const trimmed = url.trim();\r\n        if (/^https?:\\/\\//i.test(trimmed) ||\r\n            /^data:image\\//i.test(trimmed) ||\r\n            trimmed.startsWith('/') ||\r\n            trimmed.startsWith('./') ||\r\n            trimmed.startsWith('../')) {\r\n            return trimmed;\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    /**\r\n     * Valide des coordonn√©es g√©ographiques (latitude, longitude) avec support\r\n     * de plusieurs formats d'entr√©e.\r\n     *\r\n     * Supporte:\r\n     * - Format array: [lat, lng]\r\n     * - Format objet: {lat: number, lng: number}\r\n     * - Validation limites: lat ‚àà [-90, 90], lng ‚àà [-180, 180]\r\n     *\r\n     * @function validateCoordinates\r\n     * @param {Array<number>|Object|*} value - Coordonn√©es √† valider\r\n     * @returns {{lat: number, lng: number}|null} Coordonn√©es valides ou null\r\n     *\r\n     * @example\r\n     * // Format array\r\n     * const coords1 = validateCoordinates([45.7578, 4.8320]);\r\n     * // Retourne: { lat: 45.7578, lng: 4.8320 }\r\n     *\r\n     * @example\r\n     * // Format objet\r\n     * const coords2 = validateCoordinates({ lat: 45.7578, lng: 4.8320 });\r\n     * // Retourne: { lat: 45.7578, lng: 4.8320 }\r\n     *\r\n     * @example\r\n     * // Coordonn√©es invalides (hors limites)\r\n     * const coords3 = validateCoordinates([95, 200]);\r\n     * // Retourne: null (lat > 90, lng > 180)\r\n     *\r\n     * @example\r\n     * // Format invalide\r\n     * const coords4 = validateCoordinates('45.7578, 4.8320');\r\n     * // Retourne: null (string non support√©)\r\n     */\r\n    function validateCoordinates(value) {\r\n        if (value == null) return null;\r\n\r\n        let lat, lng;\r\n\r\n        // Format array [lat, lng]\r\n        if (Array.isArray(value) && value.length >= 2) {\r\n            lat = parseFloat(value[0]);\r\n            lng = parseFloat(value[1]);\r\n        }\r\n        // Format objet {lat, lng}\r\n        else if (typeof value === 'object' && value.lat !== undefined && value.lng !== undefined) {\r\n            lat = parseFloat(value.lat);\r\n            lng = parseFloat(value.lng);\r\n        }\r\n        // Format invalide\r\n        else {\r\n            return null;\r\n        }\r\n\r\n        // Validation des valeurs\r\n        if (isNaN(lat) || isNaN(lng)) return null;\r\n        if (lat < -90 || lat > 90) return null;\r\n        if (lng < -180 || lng > 180) return null;\r\n\r\n        return { lat, lng };\r\n    }\r\n\r\n    /**\r\n     * Valide une valeur num√©rique en la convertissant si n√©cessaire.\r\n     *\r\n     * Accepte number, string convertible en number.\r\n     * Rejette NaN, null, undefined, cha√Ænes vides.\r\n     *\r\n     * @function validateNumber\r\n     * @param {number|string|*} value - Valeur √† valider\r\n     * @returns {number|null} Nombre valide ou null si invalide\r\n     *\r\n     * @example\r\n     * // Number direct\r\n     * const num1 = validateNumber(42.5);\r\n     * // Retourne: 42.5\r\n     *\r\n     * @example\r\n     * // String convertible\r\n     * const num2 = validateNumber('42.5');\r\n     * // Retourne: 42.5\r\n     *\r\n     * @example\r\n     * // Valeurs invalides\r\n     * validateNumber(null);      // null\r\n     * validateNumber('');        // null\r\n     * validateNumber('abc');     // null\r\n     * validateNumber(NaN);       // null\r\n     * validateNumber(undefined); // null\r\n     */\r\n    function validateNumber(value) {\r\n        if (value == null || value === '') return null;\r\n        const num = typeof value === 'number' ? value : parseFloat(value);\r\n        return isNaN(num) ? null : num;\r\n    }\r\n\r\n    /**\r\n     * Valide un rating (note) dans l'√©chelle 0-5.\r\n     *\r\n     * Utilise validateNumber puis v√©rifie que la valeur est dans [0, 5].\r\n     * Utile pour les syst√®mes de notation 5 √©toiles.\r\n     *\r\n     * @function validateRating\r\n     * @param {number|string|*} value - Rating √† valider\r\n     * @returns {number|null} Rating valide ‚àà [0, 5] ou null si invalide\r\n     *\r\n     * @example\r\n     * // Rating valide\r\n     * const rating1 = validateRating(4.5);\r\n     * // Retourne: 4.5\r\n     *\r\n     * @example\r\n     * // Rating valide (limites)\r\n     * const rating2 = validateRating(0);   // 0 (valide)\r\n     * const rating3 = validateRating(5);   // 5 (valide)\r\n     *\r\n     * @example\r\n     * // Rating invalide (hors limites)\r\n     * const rating4 = validateRating(-1);  // null (< 0)\r\n     * const rating5 = validateRating(6);   // null (> 5)\r\n     * const rating6 = validateRating('excellent'); // null (non num√©rique)\r\n     */\r\n    function validateRating(value) {\r\n        const num = validateNumber(value);\r\n        if (num === null) return null;\r\n        if (num < 0 || num > 5) return null;\r\n        return num;\r\n    }\r\n\r\n    // ========================================\r\n    //   BADGE RESOLVER (Taxonomie + Styles)\r\n    // ========================================\r\n\r\n    /**\r\n     * R√©sout un badge en appliquant la taxonomie et les styleRules de la couche.\r\n     *\r\n     * Processus:\r\n     * 1. R√©cup√®re la valeur via resolveField (ex: categoryId)\r\n     * 2. Cherche le label dans taxonomy.categories ou subcategories\r\n     * 3. Applique les couleurs depuis GeoLeaf.Helpers.StyleResolver\r\n     * 4. Retourne { displayValue, style } pour affichage HTML\r\n     *\r\n     * G√®re 2 types de champs:\r\n     * - categoryId: r√©solution cat√©gorie principale\r\n     * - subCategoryId: r√©solution sous-cat√©gorie (avec parent categoryId)\r\n     *\r\n     * @function resolveBadge\r\n     * @param {Object} poi - POI avec attributs et _layerConfig\r\n     * @param {Object} poi.attributes - Attributs du POI (categoryId, subCategoryId, etc.)\r\n     * @param {Object} poi._layerConfig - Configuration de la couche (styleRules)\r\n     * @param {string} field - Chemin du champ (ex: 'attributes.categoryId')\r\n     * @param {string} [variant] - Variante du badge (non utilis√© actuellement)\r\n     * @returns {{displayValue: string, style: string}} Badge r√©solu\r\n     * @returns {string} returns.displayValue - Label du badge (taxonomie ou valeur brute)\r\n     * @returns {string} returns.style - CSS inline (background-color, border-color)\r\n     *\r\n     * @example\r\n     * // R√©solution cat√©gorie principale\r\n     * const badge1 = resolveBadge(\r\n     *   { attributes: { categoryId: 'restaurant' }, _layerConfig: { id: 'pois' } },\r\n     *   'attributes.categoryId'\r\n     * );\r\n     * // Retourne: {\r\n     * //   displayValue: 'Restaurant',\r\n     * //   style: 'background-color: #e74c3c; border-color: #c0392b;'\r\n     * // }\r\n     *\r\n     * @example\r\n     * // R√©solution sous-cat√©gorie\r\n     * const badge2 = resolveBadge(\r\n     *   { attributes: { categoryId: 'restaurant', subCategoryId: 'gastronomique' } },\r\n     *   'attributes.subCategoryId'\r\n     * );\r\n     * // Retourne: { displayValue: 'Gastronomique', style: '...' }\r\n     *\r\n     * @example\r\n     * // Valeur non mapp√©e dans taxonomie\r\n     * const badge3 = resolveBadge(\r\n     *   { attributes: { categoryId: 'unknown' } },\r\n     *   'attributes.categoryId'\r\n     * );\r\n     * // Retourne: { displayValue: 'unknown', style: '' }\r\n     */\r\n    function resolveBadge(poi, field, variant) {\r\n        const resolveField = getResolveField();\r\n        const value = resolveField(poi, field);\r\n\r\n        if (value == null || value === '') {\r\n            return { displayValue: '', style: '' };\r\n        }\r\n\r\n        const profile = getActiveProfile();\r\n        const taxonomy = profile?.taxonomy;\r\n        let displayValue = String(value);\r\n        let style = '';\r\n\r\n        // Pas de taxonomie : retour simple\r\n        if (!taxonomy || !field) {\r\n            return { displayValue, style };\r\n        }\r\n\r\n        const attrs = poi.attributes || {};\r\n\r\n        // R√©solution cat√©gorie principale\r\n        if (field.includes('categoryId') && !field.includes('subCategoryId')) {\r\n            const catData = taxonomy.categories?.[value];\r\n            if (catData?.label) {\r\n                displayValue = catData.label;\r\n            }\r\n\r\n            // Couleurs depuis styleRules de la couche\r\n            if (GeoLeaf.Helpers?.StyleResolver && poi._layerConfig) {\r\n                const styleColors = GeoLeaf.Helpers.StyleResolver.getColorsFromLayerStyle(\r\n                    poi,\r\n                    poi._layerConfig.id\r\n                );\r\n                if (styleColors) {\r\n                    if (styleColors.fillColor) {\r\n                        style += 'background-color: ' + styleColors.fillColor + ';';\r\n                    }\r\n                    if (styleColors.color) {\r\n                        style += 'border-color: ' + styleColors.color + ';';\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        // R√©solution sous-cat√©gorie\r\n        else if (field.includes('subCategoryId')) {\r\n            const catId = attrs.categoryId || attrs.category;\r\n            const catData = taxonomy.categories?.[catId];\r\n            const subCatData = catData?.subcategories?.[value];\r\n\r\n            if (subCatData?.label) {\r\n                displayValue = subCatData.label;\r\n            }\r\n\r\n            // Couleurs depuis styleRules de la couche\r\n            if (GeoLeaf.Helpers?.StyleResolver && poi._layerConfig) {\r\n                const styleColors = GeoLeaf.Helpers.StyleResolver.getColorsFromLayerStyle(\r\n                    poi,\r\n                    poi._layerConfig.id\r\n                );\r\n                if (styleColors) {\r\n                    if (styleColors.fillColor) {\r\n                        style += 'background-color: ' + styleColors.fillColor + ';';\r\n                    }\r\n                    if (styleColors.color) {\r\n                        style += 'border-color: ' + styleColors.color + ';';\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return { displayValue, style };\r\n    }\r\n\r\n    /**\r\n     * R√©sout un badge pour tooltip (texte uniquement, sans styles).\r\n     *\r\n     * Version simplifi√©e de resolveBadge:\r\n     * - Retourne uniquement le texte (displayValue)\r\n     * - Pas de styles CSS\r\n     * - Optimis√© pour tooltips HTML limit√©s\r\n     *\r\n     * Supporte √©galement categoryId et subCategoryId avec r√©solution taxonomie.\r\n     *\r\n     * @function resolveBadgeTooltip\r\n     * @param {Object} poi - POI avec attributs\r\n     * @param {Object} poi.attributes - Attributs du POI\r\n     * @param {string} field - Chemin du champ (ex: 'attributes.categoryId')\r\n     * @returns {string} Label du badge (ou valeur brute si pas de taxonomie)\r\n     *\r\n     * @example\r\n     * // R√©solution cat√©gorie avec taxonomie\r\n     * const text1 = resolveBadgeTooltip(\r\n     *   { attributes: { categoryId: 'restaurant' } },\r\n     *   'attributes.categoryId'\r\n     * );\r\n     * // Retourne: 'Restaurant' (label taxonomie)\r\n     *\r\n     * @example\r\n     * // R√©solution sous-cat√©gorie\r\n     * const text2 = resolveBadgeTooltip(\r\n     *   { attributes: { categoryId: 'restaurant', subCategoryId: 'gastronomique' } },\r\n     *   'attributes.subCategoryId'\r\n     * );\r\n     * // Retourne: 'Gastronomique'\r\n     *\r\n     * @example\r\n     * // Valeur vide\r\n     * const text3 = resolveBadgeTooltip(\r\n     *   { attributes: {} },\r\n     *   'attributes.unknownField'\r\n     * );\r\n     * // Retourne: ''\r\n     */\r\n    function resolveBadgeTooltip(poi, field) {\r\n        const resolveField = getResolveField();\r\n        const value = resolveField(poi, field);\r\n\r\n        if (value == null || value === '') return '';\r\n\r\n        const profile = getActiveProfile();\r\n        const taxonomy = profile?.taxonomy;\r\n\r\n        if (!taxonomy) return String(value);\r\n\r\n        const attrs = poi.attributes || {};\r\n\r\n        // Sous-cat√©gorie\r\n        if (field.includes('subCategoryId')) {\r\n            const catId = attrs.categoryId || attrs.category;\r\n            const catData = taxonomy.categories?.[catId];\r\n            const subCatData = catData?.subcategories?.[value];\r\n            if (subCatData?.label) return subCatData.label;\r\n        }\r\n        // Cat√©gorie\r\n        else if (field.includes('categoryId')) {\r\n            const catData = taxonomy.categories?.[value];\r\n            if (catData?.label) return catData.label;\r\n        }\r\n\r\n        return String(value);\r\n    }\r\n\r\n    // ========================================\r\n    //   UTILITAIRES DE FORMATAGE\r\n    // ========================================\r\n\r\n    /**\r\n     * Formate un nombre avec la locale fran√ßaise (s√©parateurs FR).\r\n     *\r\n     * Utilise toLocaleString('fr-FR'):\r\n     * - S√©parateur de milliers: espace (\\u202f)\r\n     * - S√©parateur de d√©cimales: virgule\r\n     *\r\n     * @function formatNumber\r\n     * @param {number} num - Nombre √† formater\r\n     * @returns {string} Nombre format√© avec conventions fran√ßaises\r\n     *\r\n     * @example\r\n     * // Entier\r\n     * const str1 = formatNumber(1234567);\r\n     * // Retourne: '1\\u202f234\\u202f567'\r\n     *\r\n     * @example\r\n     * // D√©cimal\r\n     * const str2 = formatNumber(1234.56);\r\n     * // Retourne: '1\\u202f234,56'\r\n     *\r\n     * @example\r\n     * // Petit nombre\r\n     * const str3 = formatNumber(42);\r\n     * // Retourne: '42'\r\n     */\r\n    function formatNumber(num) {\r\n        return num.toLocaleString('fr-FR');\r\n    }\r\n\r\n    /**\r\n     * Formate des coordonn√©es g√©ographiques en cha√Æne \"lat, lng\".\r\n     *\r\n     * Utilise toFixed pour contr√¥ler la pr√©cision d√©cimale.\r\n     * Pr√©cision recommand√©e: 6 d√©cimales (~10cm de pr√©cision).\r\n     *\r\n     * @function formatCoordinates\r\n     * @param {number} lat - Latitude (‚àà [-90, 90])\r\n     * @param {number} lng - Longitude (‚àà [-180, 180])\r\n     * @param {number} [precision=6] - Nombre de d√©cimales (1-15)\r\n     * @returns {string} Coordonn√©es format√©es \"lat, lng\"\r\n     *\r\n     * @example\r\n     * // Pr√©cision par d√©faut (6 d√©cimales)\r\n     * const str1 = formatCoordinates(45.7578137, 4.8320114);\r\n     * // Retourne: '45.757814, 4.832011'\r\n     *\r\n     * @example\r\n     * // Haute pr√©cision (8 d√©cimales)\r\n     * const str2 = formatCoordinates(45.7578137, 4.8320114, 8);\r\n     * // Retourne: '45.75781370, 4.83201140'\r\n     *\r\n     * @example\r\n     * // Faible pr√©cision (2 d√©cimales)\r\n     * const str3 = formatCoordinates(45.7578137, 4.8320114, 2);\r\n     * // Retourne: '45.76, 4.83'\r\n     */\r\n    function formatCoordinates(lat, lng, precision = 6) {\r\n        return lat.toFixed(precision) + ', ' + lng.toFixed(precision);\r\n    }\r\n\r\n    /**\r\n     * Formate un rating (note) au format \"X.X/5\".\r\n     *\r\n     * Utilise toFixed pour afficher le nombre de d√©cimales souhait√©.\r\n     * Compatible avec les syst√®mes de notation 5 √©toiles.\r\n     *\r\n     * @function formatRating\r\n     * @param {number} rating - Note √† formater (‚àà [0, 5])\r\n     * @param {number} [precision=1] - Nombre de d√©cimales (0-2)\r\n     * @returns {string} Rating format√© (ex: \"4.5/5\", \"3/5\")\r\n     *\r\n     * @example\r\n     * // Pr√©cision par d√©faut (1 d√©cimale)\r\n     * const str1 = formatRating(4.567);\r\n     * // Retourne: '4.6/5'\r\n     *\r\n     * @example\r\n     * // Sans d√©cimale\r\n     * const str2 = formatRating(4.567, 0);\r\n     * // Retourne: '5/5'\r\n     *\r\n     * @example\r\n     * // 2 d√©cimales\r\n     * const str3 = formatRating(4.567, 2);\r\n     * // Retourne: '4.57/5'\r\n     *\r\n     * @example\r\n     * // Note parfaite\r\n     * const str4 = formatRating(5);\r\n     * // Retourne: '5.0/5'\r\n     */\r\n    function formatRating(rating, precision = 1) {\r\n        return rating.toFixed(precision) + '/5';\r\n    }\r\n\r\n    // ========================================\r\n    //   EXPORT\r\n    // ========================================\r\n\r\n    GeoLeaf._ContentBuilder.Core = {\r\n        // Helpers d√©pendances\r\n        getResolveField,\r\n        getEscapeHtml,\r\n        getActiveProfile,\r\n        getLog,\r\n\r\n        // Validators\r\n        validateImageUrl,\r\n        validateCoordinates,\r\n        validateNumber,\r\n        validateRating,\r\n\r\n        // Badge resolver\r\n        resolveBadge,\r\n        resolveBadgeTooltip,\r\n\r\n        // Formatters\r\n        formatNumber,\r\n        formatCoordinates,\r\n        formatRating\r\n    };\r\n\r\n    getLog().info('[GeoLeaf._ContentBuilder.Core] Module Core charg√© - Helpers + Validators + Badge resolver');\r\n\r\n})(typeof window !== 'undefined' ? window : global);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n/**\r\n * GeoLeaf Content Builder - Templates Module\r\n *\r\n * Centralise tous les templates HTML (14 builders) et classes CSS standards\r\n * pour les renderers (text, number, badge, rating, image, link, list, etc.).\r\n *\r\n * Organisation:\r\n * - CSS_CLASSES: Library de classes CSS standards\r\n * - Template Builders: 14 fonctions de construction HTML\r\n * - Wrappers: Fonctions utilitaires (wrapInParagraph, wrapInDiv, wrapInLink)\r\n *\r\n * @module ui/content-builder/templates\r\n * @author Assistant\r\n * @version 1.0.0\r\n * @since 2026-01-18 (Sprint 4.5 - Modularisation)\r\n *\r\n * @example\r\n * // Import des templates\r\n * const Templates = GeoLeaf._ContentBuilder.Templates;\r\n *\r\n * @example\r\n * // Utilisation CSS_CLASSES\r\n * const className = Templates.CSS_CLASSES.badge; // 'gl-poi-badge'\r\n *\r\n * @example\r\n * // Cr√©ation d'un badge\r\n * const badgeHtml = Templates.createBadge(\r\n *   { displayValue: 'Restaurant', style: 'background-color: #e74c3c;' },\r\n *   'category',\r\n *   escapeHtml\r\n * );\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    if (!GeoLeaf._ContentBuilder) GeoLeaf._ContentBuilder = {};\r\n\r\n    // ========================================\r\n    //   CLASSES CSS STANDARDS\r\n    // ========================================\r\n\r\n    const CSS_CLASSES = {\r\n        // Container classes\r\n        text: 'gl-content__text',\r\n        longtext: 'gl-content__longtext',\r\n        number: 'gl-content__number',\r\n        metric: 'gl-content__metric',\r\n        badge: 'gl-poi-badge',\r\n        rating: 'gl-content__rating',\r\n        image: 'gl-content__image',\r\n        link: 'gl-content__link',\r\n        list: 'gl-content__list',\r\n        table: 'gl-content__table',\r\n        tags: 'gl-content__tags',\r\n        tag: 'gl-content__tag',\r\n        coordinates: 'gl-content__coordinates',\r\n        gallery: 'gl-content__gallery',\r\n\r\n        // Badge variants\r\n        badgeDefault: 'gl-poi-badge--default',\r\n        badgeStatus: 'gl-poi-badge--status',\r\n        badgePriority: 'gl-poi-badge--priority',\r\n        badgeCategory: 'gl-poi-badge--category',\r\n\r\n        // Rating\r\n        star: 'gl-star',\r\n        starFull: 'gl-star--full',\r\n        starHalf: 'gl-star--half',\r\n        starEmpty: 'gl-star--empty'\r\n    };\r\n\r\n    // ========================================\r\n    //   TEMPLATE BUILDERS\r\n    // ========================================\r\n\r\n    /**\r\n     * Construit un attribut HTML class=\"...\" avec classes de base et personnalis√©es.\r\n     *\r\n     * Combine baseClass (obligatoire) + customClass (optionnel) en un seul attribut.\r\n     *\r\n     * @function buildClassAttr\r\n     * @param {string} baseClass - Classe CSS de base (ex: 'gl-content__badge')\r\n     * @param {string} [customClass] - Classe personnalis√©e optionnelle\r\n     * @returns {string} Attribut HTML class (ex: ' class=\"gl-content__badge custom\"')\r\n     *\r\n     * @example\r\n     * // Classe de base uniquement\r\n     * const attr1 = buildClassAttr('gl-content__badge');\r\n     * // Retourne: ' class=\"gl-content__badge\"'\r\n     *\r\n     * @example\r\n     * // Classe de base + classe personnalis√©e\r\n     * const attr2 = buildClassAttr('gl-content__badge', 'my-custom-badge');\r\n     * // Retourne: ' class=\"gl-content__badge my-custom-badge\"'\r\n     */\r\n    function buildClassAttr(baseClass, customClass) {\r\n        const classes = [baseClass];\r\n        if (customClass) classes.push(customClass);\r\n        return ' class=\"' + classes.join(' ') + '\"';\r\n    }\r\n\r\n    /**\r\n     * Construit un attribut HTML style=\"...\" si un style est fourni.\r\n     *\r\n     * Retourne une cha√Æne vide si style est null/undefined/vide.\r\n     *\r\n     * @function buildStyleAttr\r\n     * @param {string} [style] - Style CSS inline (ex: 'color: red; background: blue;')\r\n     * @returns {string} Attribut HTML style (ex: ' style=\"color: red;\"') ou cha√Æne vide\r\n     *\r\n     * @example\r\n     * // Avec style\r\n     * const attr1 = buildStyleAttr('color: red; font-weight: bold;');\r\n     * // Retourne: ' style=\"color: red; font-weight: bold;\"'\r\n     *\r\n     * @example\r\n     * // Sans style\r\n     * const attr2 = buildStyleAttr('');\r\n     * // Retourne: ''\r\n     */\r\n    function buildStyleAttr(style) {\r\n        return style ? ' style=\"' + style + '\"' : '';\r\n    }\r\n\r\n    /**\r\n     * Construit un label HTML avec gestion d'ic√¥ne et √©chappement.\r\n     *\r\n     * Utilis√© dans les templates pour afficher un label avec ic√¥ne optionnelle.\r\n     *\r\n     * @function buildLabel\r\n     * @param {string} label - Texte du label (sera √©chapp√©)\r\n     * @param {Function} escapeHtml - Fonction d'√©chappement HTML\r\n     * @param {string} [icon] - Ic√¥ne optionnelle (HTML non √©chapp√©)\r\n     * @returns {string} HTML du label avec ic√¥ne si fournie\r\n     *\r\n     * @example\r\n     * // Label simple\r\n     * const html1 = buildLabel('Restaurant', escapeHtml);\r\n     * // Retourne: '<span>Restaurant</span>'\r\n     *\r\n     * @example\r\n     * // Label avec ic√¥ne\r\n     * const html2 = buildLabel('Restaurant', escapeHtml, '<i class=\"fa fa-utensils\"></i>');\r\n     * // Retourne: '<i class=\"fa fa-utensils\"></i><span>Restaurant</span>'\r\n     */\r\n    function buildLabel(label, escapeHtml, icon) {\r\n        if (!label) return '';\r\n        return '<strong>' + escapeHtml(label) + ':</strong> ';\r\n    }\r\n\r\n    /**\r\n     * Enveloppe du contenu HTML dans un paragraphe <p> avec classes.\r\n     *\r\n     * @function wrapInParagraph\r\n     * @param {string} content - Contenu HTML (d√©j√† √©chapp√© ou non)\r\n     * @param {string} className - Classe CSS de base\r\n     * @param {string} [customClass] - Classe personnalis√©e optionnelle\r\n     * @returns {string} HTML paragraphe avec classes\r\n     *\r\n     * @example\r\n     * const html = wrapInParagraph('Restaurant', 'gl-content__text');\r\n     * // Retourne: '<p class=\"gl-content__text\">Restaurant</p>'\r\n     *\r\n     * @example\r\n     * const html2 = wrapInParagraph('Restaurant', 'gl-content__text', 'my-custom');\r\n     * // Retourne: '<p class=\"gl-content__text my-custom\">Restaurant</p>'\r\n     */\r\n    function wrapInParagraph(content, className, customClass) {\r\n        return '<p' + buildClassAttr(className, customClass) + '>' + content + '</p>';\r\n    }\r\n\r\n    /**\r\n     * Enveloppe du contenu HTML dans un div <div> avec classes.\r\n     *\r\n     * @function wrapInDiv\r\n     * @param {string} content - Contenu HTML (d√©j√† √©chapp√© ou non)\r\n     * @param {string} className - Classe CSS de base\r\n     * @param {string} [customClass] - Classe personnalis√©e optionnelle\r\n     * @returns {string} HTML div avec classes\r\n     *\r\n     * @example\r\n     * const html = wrapInDiv('Content', 'gl-content__longtext');\r\n     * // Retourne: '<div class=\"gl-content__longtext\">Content</div>'\r\n     */\r\n    function wrapInDiv(content, className, customClass) {\r\n        return '<div' + buildClassAttr(className, customClass) + '>' + content + '</div>';\r\n    }\r\n\r\n    /**\r\n     * Cr√©e un √©l√©ment de texte simple <p> avec label optionnel.\r\n     *\r\n     * Format: <p class=\"gl-content__text\"><strong>Label:</strong> Value</p>\r\n     *\r\n     * @function createTextElement\r\n     * @param {string} value - Valeur texte (√† √©chapper)\r\n     * @param {Object} config - Configuration renderer\r\n     * @param {string} [config.label] - Label optionnel\r\n     * @param {string} [config.className] - Classe personnalis√©e\r\n     * @param {Function} escapeHtml - Fonction d'√©chappement HTML\r\n     * @returns {string} HTML paragraphe avec texte\r\n     *\r\n     * @example\r\n     * // Avec label\r\n     * const html1 = createTextElement('Restaurant', { label: 'Nom' }, escapeHtml);\r\n     * // Retourne: '<p class=\"gl-content__text\"><strong>Nom:</strong> Restaurant</p>'\r\n     *\r\n     * @example\r\n     * // Sans label\r\n     * const html2 = createTextElement('Restaurant', {}, escapeHtml);\r\n     * // Retourne: '<p class=\"gl-content__text\">Restaurant</p>'\r\n     */\r\n    function createTextElement(value, config, escapeHtml) {\r\n        const label = buildLabel(config.label, escapeHtml);\r\n        const content = label + escapeHtml(value);\r\n        return wrapInParagraph(content, CSS_CLASSES.text, config.className);\r\n    }\r\n\r\n    /**\r\n     * Cr√©e un √©l√©ment de texte long <div> avec label s√©par√©.\r\n     *\r\n     * Format: <div><p><strong>Label</strong></p><p>Value</p></div>\r\n     * Utilis√© pour descriptions, commentaires, textes longs.\r\n     *\r\n     * @function createLongtextElement\r\n     * @param {string} value - Valeur texte longue (√† √©chapper)\r\n     * @param {Object} config - Configuration renderer\r\n     * @param {string} [config.label] - Label optionnel\r\n     * @param {string} [config.className] - Classe personnalis√©e\r\n     * @param {Function} escapeHtml - Fonction d'√©chappement HTML\r\n     * @returns {string} HTML div avec texte long\r\n     *\r\n     * @example\r\n     * // Avec label\r\n     * const html1 = createLongtextElement(\r\n     *   'Une longue description...',\r\n     *   { label: 'Description' },\r\n     *   escapeHtml\r\n     * );\r\n     * // Retourne: '<div class=\"gl-content__longtext\">\r\n     * //   <p><strong>Description</strong></p>\r\n     * //   <p>Une longue description...</p>\r\n     * // </div>'\r\n     */\r\n    function createLongtextElement(value, config, escapeHtml) {\r\n        const label = config.label ? '<p><strong>' + escapeHtml(config.label) + '</strong></p>' : '';\r\n        const content = label + '<p>' + escapeHtml(value) + '</p>';\r\n        return wrapInDiv(content, CSS_CLASSES.longtext, config.className);\r\n    }\r\n\r\n    /**\r\n     * Cr√©e un √©l√©ment num√©rique <p> avec formatage locale FR.\r\n     *\r\n     * Formate le nombre avec toLocaleString('fr-FR').\r\n     * Supporte prefix, suffix, label.\r\n     *\r\n     * @function createNumberElement\r\n     * @param {number} value - Valeur num√©rique\r\n     * @param {Object} config - Configuration renderer\r\n     * @param {string} [config.label] - Label optionnel\r\n     * @param {string} [config.prefix] - Pr√©fixe (ex: \"~\")\r\n     * @param {string} [config.suffix] - Suffixe (ex: \"m¬≤\", \"habitants\")\r\n     * @param {string} [config.className] - Classe personnalis√©e\r\n     * @param {Function} escapeHtml - Fonction d'√©chappement HTML\r\n     * @returns {string} HTML paragraphe avec nombre format√©\r\n     *\r\n     * @example\r\n     * // Nombre simple avec suffix\r\n     * const html1 = createNumberElement(1234567, { suffix: 'habitants' }, escapeHtml);\r\n     * // Retourne: '<p class=\"gl-content__number\">1\\u202f234\\u202f567 habitants</p>'\r\n     *\r\n     * @example\r\n     * // Avec label + prefix + suffix\r\n     * const html2 = createNumberElement(120, { label: 'Surface', prefix: '~', suffix: 'm¬≤' }, escapeHtml);\r\n     * // Retourne: '<p class=\"gl-content__number\"><strong>Surface:</strong> ~120 m¬≤</p>'\r\n     */\r\n    function createNumberElement(value, config, escapeHtml) {\r\n        const formatted = value.toLocaleString('fr-FR');\r\n        const label = buildLabel(config.label, escapeHtml);\r\n        const suffix = config.suffix ? ' ' + escapeHtml(config.suffix) : '';\r\n        const prefix = config.prefix ? escapeHtml(config.prefix) + ' ' : '';\r\n        const content = label + prefix + formatted + suffix;\r\n        return wrapInParagraph(content, CSS_CLASSES.number, config.className);\r\n    }\r\n\r\n    /**\r\n     * Cr√©e un √©l√©ment m√©trique <p> avec formatage (similaire √† number).\r\n     *\r\n     * Identique √† createNumberElement mais utilise CSS_CLASSES.metric.\r\n     * Utilis√© pour m√©triques sp√©cifiques (KPI, statistiques, etc.).\r\n     *\r\n     * @function createMetricElement\r\n     * @param {number} value - Valeur num√©rique\r\n     * @param {Object} config - Configuration renderer\r\n     * @param {string} [config.label] - Label optionnel\r\n     * @param {string} [config.prefix] - Pr√©fixe (ex: \"+\", \"-\")\r\n     * @param {string} [config.suffix] - Suffixe (ex: \"%\", \"‚Ç¨\")\r\n     * @param {string} [config.className] - Classe personnalis√©e\r\n     * @param {Function} escapeHtml - Fonction d'√©chappement HTML\r\n     * @returns {string} HTML paragraphe avec m√©trique format√©e\r\n     *\r\n     * @example\r\n     * // M√©trique avec pourcentage\r\n     * const html1 = createMetricElement(95.5, { label: 'Satisfaction', suffix: '%' }, escapeHtml);\r\n     * // Retourne: '<p class=\"gl-content__metric\"><strong>Satisfaction:</strong> 95,5%</p>'\r\n     */\r\n    function createMetricElement(value, config, escapeHtml) {\r\n        const formatted = value.toLocaleString('fr-FR');\r\n        const label = buildLabel(config.label, escapeHtml);\r\n        const suffix = config.suffix ? escapeHtml(config.suffix) : '';\r\n        const prefix = config.prefix ? escapeHtml(config.prefix) : '';\r\n        const content = label + prefix + formatted + suffix;\r\n        return wrapInParagraph(content, CSS_CLASSES.metric, config.className);\r\n    }\r\n\r\n    /**\r\n     * Cr√©e un badge <span> avec variante et style inline.\r\n     *\r\n     * Variantes disponibles:\r\n     * - 'default': gl-poi-badge--default\r\n     * - 'status': gl-poi-badge--status\r\n     * - 'priority': gl-poi-badge--priority\r\n     * - 'category': gl-poi-badge--category\r\n     *\r\n     * @function createBadge\r\n     * @param {string} value - Texte du badge (√† √©chapper)\r\n     * @param {string} [variant='default'] - Variante du badge (default, status, priority, category)\r\n     * @param {string} [style] - Style CSS inline optionnel (ex: 'background-color: #e74c3c;')\r\n     * @param {Function} escapeHtml - Fonction d'√©chappement HTML\r\n     * @returns {string} HTML span badge\r\n     *\r\n     * @example\r\n     * // Badge default\r\n     * const html1 = createBadge('Restaurant', 'default', '', escapeHtml);\r\n     * // Retourne: '<span class=\"gl-poi-badge gl-poi-badge--default\">Restaurant</span>'\r\n     *\r\n     * @example\r\n     * // Badge category avec style\r\n     * const html2 = createBadge(\r\n     *   'Gastronomique',\r\n     *   'category',\r\n     *   'background-color: #e74c3c; color: white;',\r\n     *   escapeHtml\r\n     * );\r\n     * // Retourne: '<span class=\"gl-poi-badge gl-poi-badge--category\" style=\"...\">Gastronomique</span>'\r\n     */\r\n    function createBadge(value, variant, style, escapeHtml) {\r\n        variant = variant || 'default';\r\n        const badgeClass = CSS_CLASSES.badge + ' ' + CSS_CLASSES['badge' + variant.charAt(0).toUpperCase() + variant.slice(1)];\r\n        const styleAttr = buildStyleAttr(style);\r\n        return '<span class=\"' + badgeClass + '\"' + styleAttr + '>' + escapeHtml(value) + '</span>';\r\n    }\r\n\r\n    /**\r\n     * Cr√©e une √©toile <span> de notation avec classe CSS.\r\n     *\r\n     * Types disponibles:\r\n     * - 'full': gl-star--full (‚òÖ plein)\r\n     * - 'half': gl-star--half (¬Ω √©toile)\r\n     * - 'empty': gl-star--empty (‚òÜ vide)\r\n     *\r\n     * @function createStar\r\n     * @param {string} type - Type d'√©toile ('full', 'half', 'empty')\r\n     * @returns {string} HTML span √©toile\r\n     *\r\n     * @example\r\n     * const html1 = createStar('full');\r\n     * // Retourne: '<span class=\"gl-star gl-star--full\">‚òÖ</span>'\r\n     *\r\n     * @example\r\n     * const html2 = createStar('empty');\r\n     * // Retourne: '<span class=\"gl-star gl-star--empty\">‚òÖ</span>'\r\n     */\r\n    function createStar(type) {\r\n        const starClass = CSS_CLASSES.star + ' ' + CSS_CLASSES['star' + type.charAt(0).toUpperCase() + type.slice(1)];\r\n        return '<span class=\"' + starClass + '\">‚òÖ</span>';\r\n    }\r\n\r\n    /**\r\n     * Cr√©e un √©l√©ment de notation <p> avec √©toiles (0-5).\r\n     *\r\n     * G√©n√®re automatiquement les √©toiles pleines, demi et vides.\r\n     * Logique:\r\n     * - rating = 4.7 => 4 full + 1 half + 0 empty\r\n     * - rating = 3.2 => 3 full + 0 half + 2 empty\r\n     *\r\n     * @function createRatingElement\r\n     * @param {number} rating - Note (0-5)\r\n     * @param {Object} config - Configuration renderer\r\n     * @param {string} [config.label] - Label optionnel\r\n     * @param {number} [config.max=5] - Note maximale (g√©n√©ralement 5)\r\n     * @param {boolean} [config.showValue=true] - Afficher la valeur num√©rique\r\n     * @param {string} [config.className] - Classe personnalis√©e\r\n     * @param {Function} escapeHtml - Fonction d'√©chappement HTML\r\n     * @returns {string} HTML paragraphe avec √©toiles\r\n     *\r\n     * @example\r\n     * // Rating 4.5/5 avec label\r\n     * const html1 = createRatingElement(4.5, { label: 'Note', showValue: true }, escapeHtml);\r\n     * // Retourne: '<p class=\"gl-content__rating\">\r\n     * //   <strong>Note:</strong> ‚òÖ‚òÖ‚òÖ‚òÖ¬Ω (4.5/5)\r\n     * // </p>'\r\n     *\r\n     * @example\r\n     * // Rating sans valeur num√©rique\r\n     * const html2 = createRatingElement(3, { showValue: false }, escapeHtml);\r\n     * // Retourne: '<p class=\"gl-content__rating\">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ</p>'\r\n     */\r\n    function createRatingElement(rating, config, escapeHtml) {\r\n        let stars = '';\r\n        const fullStars = Math.floor(rating);\r\n        const hasHalfStar = (rating % 1) >= 0.5;\r\n\r\n        // √âtoiles pleines\r\n        for (let i = 0; i < fullStars; i++) {\r\n            stars += createStar('full');\r\n        }\r\n\r\n        // Demi-√©toile\r\n        if (hasHalfStar) {\r\n            stars += createStar('half');\r\n        }\r\n\r\n        // √âtoiles vides\r\n        const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);\r\n        for (let i = 0; i < emptyStars; i++) {\r\n            stars += createStar('empty');\r\n        }\r\n\r\n        const ratingText = ' (' + rating.toFixed(1) + '/5)';\r\n        const label = buildLabel(config.label, escapeHtml);\r\n        const content = label + stars + ratingText;\r\n        return wrapInDiv(content, CSS_CLASSES.rating, config.className);\r\n    }\r\n\r\n    /**\r\n     * Cr√©e un √©l√©ment image <img> avec classe et alt.\r\n     *\r\n     * @function createImageElement\r\n     * @param {string} src - URL de l'image (sera √©chapp√©e)\r\n     * @param {Object} config - Configuration renderer\r\n     * @param {string} [config.alt] - Texte alternatif optionnel\r\n     * @param {string} [config.className] - Classe personnalis√©e\r\n     * @param {Function} escapeHtml - Fonction d'√©chappement HTML\r\n     * @returns {string} HTML img\r\n     *\r\n     * @example\r\n     * // Image avec alt\r\n     * const html1 = createImageElement(\r\n     *   'https://example.com/photo.jpg',\r\n     *   { alt: 'Photo du restaurant' },\r\n     *   escapeHtml\r\n     * );\r\n     * // Retourne: '<img class=\"gl-content__image\" src=\"https://example.com/photo.jpg\" alt=\"Photo du restaurant\">'\r\n     *\r\n     * @example\r\n     * // Image sans alt\r\n     * const html2 = createImageElement('https://example.com/photo.jpg', {}, escapeHtml);\r\n     * // Retourne: '<img class=\"gl-content__image\" src=\"https://example.com/photo.jpg\" alt=\"\">'\r\n     */\r\n    function createImageElement(src, config, escapeHtml) {\r\n        const alt = config.alt ? escapeHtml(config.alt) : '';\r\n        const classAttr = buildClassAttr(CSS_CLASSES.image, config.className);\r\n        return '<img' + classAttr + ' src=\"' + escapeHtml(src) + '\" alt=\"' + alt + '\">';\r\n    }\r\n\r\n    /**\r\n     * Cr√©e un √©l√©ment lien <a> avec target=\"_blank\" et s√©curit√©.\r\n     *\r\n     * S√©curit√©: rel=\"noopener noreferrer\" pour √©viter tabnabbing.\r\n     *\r\n     * @function createLinkElement\r\n     * @param {string} href - URL du lien (sera √©chapp√©e)\r\n     * @param {Object} config - Configuration renderer\r\n     * @param {string} [config.text] - Texte du lien (d√©faut: URL)\r\n     * @param {string} [config.label] - Label optionnel\r\n     * @param {string} [config.className] - Classe personnalis√©e\r\n     * @param {Function} escapeHtml - Fonction d'√©chappement HTML\r\n     * @returns {string} HTML paragraphe avec lien\r\n     *\r\n     * @example\r\n     * // Lien avec texte personnalis√©\r\n     * const html1 = createLinkElement(\r\n     *   'https://example.com',\r\n     *   { text: 'Visiter le site', label: 'Site web' },\r\n     *   escapeHtml\r\n     * );\r\n     * // Retourne: '<p class=\"gl-content__link\">\r\n     * //   <strong>Site web:</strong>\r\n     * //   <a href=\"https://example.com\" target=\"_blank\" rel=\"noopener noreferrer\">Visiter le site</a>\r\n     * // </p>'\r\n     *\r\n     * @example\r\n     * // Lien sans texte (affiche URL)\r\n     * const html2 = createLinkElement('https://example.com', {}, escapeHtml);\r\n     * // Retourne: '<p class=\"gl-content__link\">\r\n     * //   <a href=\"https://example.com\" target=\"_blank\" rel=\"noopener noreferrer\">https://example.com</a>\r\n     * // </p>'\r\n     */\r\n    function createLinkElement(href, config, escapeHtml) {\r\n        const text = config.text ? escapeHtml(config.text) : escapeHtml(href);\r\n        const label = buildLabel(config.label, escapeHtml);\r\n        const link = '<a href=\"' + escapeHtml(href) + '\" target=\"_blank\" rel=\"noopener noreferrer\">' + text + '</a>';\r\n        const content = label + link;\r\n        return wrapInParagraph(content, CSS_CLASSES.link, config.className);\r\n    }\r\n\r\n    /**\r\n     * Cr√©e un √©l√©ment liste <ul> avec items.\r\n     *\r\n     * Convertit automatiquement les items en string via String(item).\r\n     *\r\n     * @function createListElement\r\n     * @param {Array<string|number|*>} items - Items de la liste\r\n     * @param {Object} config - Configuration renderer\r\n     * @param {string} [config.label] - Label optionnel\r\n     * @param {string} [config.className] - Classe personnalis√©e\r\n     * @param {Function} escapeHtml - Fonction d'√©chappement HTML\r\n     * @returns {string} HTML div avec liste ul\r\n     *\r\n     * @example\r\n     * // Liste avec label\r\n     * const html1 = createListElement(\r\n     *   ['Pizza', 'Pasta', 'Risotto'],\r\n     *   { label: 'Sp√©cialit√©s' },\r\n     *   escapeHtml\r\n     * );\r\n     * // Retourne: '<div class=\"gl-content__list\">\r\n     * //   <p><strong>Sp√©cialit√©s</strong></p>\r\n     * //   <ul><li>Pizza</li><li>Pasta</li><li>Risotto</li></ul>\r\n     * // </div>'\r\n     *\r\n     * @example\r\n     * // Liste simple sans label\r\n     * const html2 = createListElement(['Item 1', 'Item 2'], {}, escapeHtml);\r\n     * // Retourne: '<div class=\"gl-content__list\"><ul><li>Item 1</li><li>Item 2</li></ul></div>'\r\n     */\r\n    function createListElement(items, config, escapeHtml) {\r\n        const label = config.label ? '<p><strong>' + escapeHtml(config.label) + '</strong></p>' : '';\r\n        let list = '<ul>';\r\n        items.forEach(item => {\r\n            list += '<li>' + escapeHtml(String(item)) + '</li>';\r\n        });\r\n        list += '</ul>';\r\n        const content = label + list;\r\n        return wrapInDiv(content, CSS_CLASSES.list, config.className);\r\n    }\r\n\r\n    /**\r\n     * Cr√©e un √©l√©ment table <table> √† partir d'un objet cl√©/valeur.\r\n     *\r\n     * G√©n√®re une table HTML avec <th> pour les cl√©s et <td> pour les valeurs.\r\n     *\r\n     * @function createTableElement\r\n     * @param {Object} data - Donn√©es de la table (cl√©/valeur)\r\n     * @param {Object} config - Configuration renderer\r\n     * @param {string} [config.label] - Label optionnel\r\n     * @param {string} [config.className] - Classe personnalis√©e\r\n     * @param {Function} escapeHtml - Fonction d'√©chappement HTML\r\n     * @returns {string} HTML div avec table\r\n     *\r\n     * @example\r\n     * // Table avec label\r\n     * const html1 = createTableElement(\r\n     *   { 'Ouverture': '9h-18h', 'Fermeture': 'Dimanche' },\r\n     *   { label: 'Horaires' },\r\n     *   escapeHtml\r\n     * );\r\n     * // Retourne: '<div class=\"gl-content__table\">\r\n     * //   <p><strong>Horaires</strong></p>\r\n     * //   <table><tbody>\r\n     * //     <tr><th>Ouverture</th><td>9h-18h</td></tr>\r\n     * //     <tr><th>Fermeture</th><td>Dimanche</td></tr>\r\n     * //   </tbody></table>\r\n     * // </div>'\r\n     */\r\n    function createTableElement(data, config, escapeHtml) {\r\n        const label = config.label ? '<p><strong>' + escapeHtml(config.label) + '</strong></p>' : '';\r\n        let table = '<table><tbody>';\r\n\r\n        Object.keys(data).forEach(key => {\r\n            const keyLabel = escapeHtml(String(key));\r\n            const value = escapeHtml(String(data[key]));\r\n            table += '<tr><th>' + keyLabel + '</th><td>' + value + '</td></tr>';\r\n        });\r\n\r\n        table += '</tbody></table>';\r\n        const content = label + table;\r\n        return wrapInDiv(content, CSS_CLASSES.table, config.className);\r\n    }\r\n\r\n    /**\r\n     * Cr√©e un tag <span> unique avec classe gl-content__tag.\r\n     *\r\n     * Utilis√© par createTagsElement pour g√©n√©rer des tags individuels.\r\n     *\r\n     * @function createTag\r\n     * @param {string|number} tag - Texte du tag (√† √©chapper)\r\n     * @param {Function} escapeHtml - Fonction d'√©chappement HTML\r\n     * @returns {string} HTML span tag\r\n     *\r\n     * @example\r\n     * const html = createTag('Restaurant', escapeHtml);\r\n     * // Retourne: '<span class=\"gl-content__tag\">Restaurant</span>'\r\n     */\r\n    function createTag(tag, escapeHtml) {\r\n        return '<span class=\"' + CSS_CLASSES.tag + '\">' + escapeHtml(String(tag)) + '</span>';\r\n    }\r\n\r\n    /**\r\n     * Cr√©e un √©l√©ment cloud de tags <div> avec plusieurs tags.\r\n     *\r\n     * G√©n√®re un nuage de tags (tag cloud) avec chaque tag s√©par√© par un espace.\r\n     *\r\n     * @function createTagsElement\r\n     * @param {Array<string|number>} tags - Liste de tags\r\n     * @param {Object} config - Configuration renderer\r\n     * @param {string} [config.className] - Classe personnalis√©e\r\n     * @param {Function} escapeHtml - Fonction d'√©chappement HTML\r\n     * @returns {string} HTML div avec tags\r\n     *\r\n     * @example\r\n     * // Tags multiples\r\n     * const html = createTagsElement(\r\n     *   ['Pizza', 'Italien', 'Gastronomique'],\r\n     *   {},\r\n     *   escapeHtml\r\n     * );\r\n     * // Retourne: '<div class=\"gl-content__tags\">\r\n     * //   <span class=\"gl-content__tag\">Pizza</span>\r\n     * //   <span class=\"gl-content__tag\">Italien</span>\r\n     * //   <span class=\"gl-content__tag\">Gastronomique</span>\r\n     * // </div>'\r\n     */\r\n    function createTagsElement(tags, config, escapeHtml) {\r\n        let content = '';\r\n        tags.forEach(tag => {\r\n            content += createTag(tag, escapeHtml) + ' ';\r\n        });\r\n        return wrapInDiv(content.trim(), CSS_CLASSES.tags, config.className);\r\n    }\r\n\r\n    /**\r\n     * Cr√©e un √©l√©ment coordonn√©es <p> avec lat, lng.\r\n     *\r\n     * Formate automatiquement avec 6 d√©cimales de pr√©cision.\r\n     *\r\n     * @function createCoordinatesElement\r\n     * @param {number} lat - Latitude (‚àà [-90, 90])\r\n     * @param {number} lng - Longitude (‚àà [-180, 180])\r\n     * @param {Object} config - Configuration renderer\r\n     * @param {string} [config.className] - Classe personnalis√©e\r\n     * @param {Function} escapeHtml - Fonction d'√©chappement HTML\r\n     * @returns {string} HTML paragraphe avec coordonn√©es\r\n     *\r\n     * @example\r\n     * const html = createCoordinatesElement(45.7578137, 4.8320114, {}, escapeHtml);\r\n     * // Retourne: '<p class=\"gl-content__coordinates\">\r\n     * //   <strong>Coordonn√©es:</strong> 45.757814, 4.832011\r\n     * // </p>'\r\n     */\r\n    function createCoordinatesElement(lat, lng, config, escapeHtml) {\r\n        const latFixed = lat.toFixed(6);\r\n        const lngFixed = lng.toFixed(6);\r\n        const content = '<strong>Coordonn√©es:</strong> ' + latFixed + ', ' + lngFixed;\r\n        return wrapInParagraph(content, CSS_CLASSES.coordinates, config.className);\r\n    }\r\n\r\n    /**\r\n     * Cr√©e un √©l√©ment galerie <div> avec plusieurs images.\r\n     *\r\n     * G√©n√®re une galerie d'images sans balises <img> individuelles.\r\n     * Les URLs doivent √™tre valid√©es avant via validateImageUrl.\r\n     *\r\n     * @function createGalleryElement\r\n     * @param {Array<string>} photos - URLs des photos (d√©j√† valid√©es)\r\n     * @param {Object} config - Configuration renderer\r\n     * @param {string} [config.className] - Classe personnalis√©e\r\n     * @param {Function} escapeHtml - Fonction d'√©chappement HTML\r\n     * @returns {string} HTML div galerie avec images\r\n     *\r\n     * @example\r\n     * const html = createGalleryElement(\r\n     *   [\r\n     *     'https://example.com/photo1.jpg',\r\n     *     'https://example.com/photo2.jpg'\r\n     *   ],\r\n     *   {},\r\n     *   escapeHtml\r\n     * );\r\n     * // Retourne: '<div class=\"gl-content__gallery\">\r\n     * //   <img src=\"https://example.com/photo1.jpg\" alt=\"Photo\">\r\n     * //   <img src=\"https://example.com/photo2.jpg\" alt=\"Photo\">\r\n     * // </div>'\r\n     */\r\n    function createGalleryElement(photos, config, escapeHtml) {\r\n        let gallery = '';\r\n        photos.forEach(photo => {\r\n            gallery += '<img src=\"' + escapeHtml(photo) + '\" alt=\"Photo\">';\r\n        });\r\n        return wrapInDiv(gallery, CSS_CLASSES.gallery, config.className);\r\n    }\r\n\r\n    // ========================================\r\n    //   EXPORT\r\n    // ========================================\r\n\r\n    GeoLeaf._ContentBuilder.Templates = {\r\n        // Classes CSS\r\n        CSS_CLASSES,\r\n\r\n        // Helpers de base\r\n        buildClassAttr,\r\n        buildStyleAttr,\r\n        buildLabel,\r\n        wrapInParagraph,\r\n        wrapInDiv,\r\n\r\n        // Template builders\r\n        createTextElement,\r\n        createLongtextElement,\r\n        createNumberElement,\r\n        createMetricElement,\r\n        createBadge,\r\n        createStar,\r\n        createRatingElement,\r\n        createImageElement,\r\n        createLinkElement,\r\n        createListElement,\r\n        createTableElement,\r\n        createTag,\r\n        createTagsElement,\r\n        createCoordinatesElement,\r\n        createGalleryElement\r\n    };\r\n\r\n    const Log = GeoLeaf.Log || console;\r\n    Log.info('[GeoLeaf._ContentBuilder.Templates] Module Templates charg√© - 14 builders disponibles');\r\n\r\n    // V√©rification de l'export\r\n    if (!GeoLeaf._ContentBuilder || !GeoLeaf._ContentBuilder.Templates) {\r\n        Log.error('[GeoLeaf._ContentBuilder.Templates] ERREUR: Export √©chou√©!');\r\n    } else {\r\n        Log.info('[GeoLeaf._ContentBuilder.Templates] Export confirm√© - Templates.createMetricElement:', typeof GeoLeaf._ContentBuilder.Templates.createMetricElement);\r\n    }\r\n\r\n})(typeof window !== 'undefined' ? window : global);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n/**\r\n * GeoLeaf Content Builder - Assemblers Module\r\n *\r\n * G√®re l'assemblage des √©l√©ments de contenu en structures compl√®tes\r\n * pour les popups (detailPopup), tooltips (contentUnion) et panneaux lat√©raux (items).\r\n *\r\n * Organisation:\r\n * - Helpers: getCore, getRenderers, getResolveField, getEscapeHtml, etc.\r\n * - Assembleurs: buildPopupHTML, buildTooltipHTML, buildPanelItems\r\n *\r\n * @module ui/content-builder/assemblers\r\n * @author Assistant\r\n * @version 1.0.0\r\n * @since 2026-01-18 (Sprint 4.5 - Modularisation)\r\n *\r\n * @example\r\n * // Import des assembleurs\r\n * const Assemblers = GeoLeaf._ContentBuilder.Assemblers;\r\n *\r\n * @example\r\n * // Construction d'un popup complet\r\n * const popupHtml = Assemblers.buildPopupHTML(poi, config, options);\r\n *\r\n * @example\r\n * // Construction d'un tooltip\r\n * const tooltipHtml = Assemblers.buildTooltipHTML(poi, contentUnion);\r\n */\r\n\r\n(function(global) {\r\n    'use strict';\r\n\r\n    // Ensure we're always working with the global reference\r\n    if (!global.GeoLeaf) {\r\n        global.GeoLeaf = {};\r\n    }\r\n\r\n    // Use the global object directly throughout this module\r\n    const GeoLeaf = global.GeoLeaf;\r\n\r\n    // ========================================\r\n    //   ACC√àS AUX MODULES\r\n    // ========================================\r\n\r\n    /**\r\n     * Get Helpers module (centralized utilities)\r\n     * @returns {Object}\r\n     */\r\n    function getHelpers() {\r\n        return GeoLeaf._ContentBuilder?.Helpers || {};\r\n    }\r\n\r\n    function getCore() {\r\n        return GeoLeaf._ContentBuilder?.Core || null;\r\n    }\r\n\r\n    function getRenderers() {\r\n        return GeoLeaf._ContentBuilder || {};\r\n    }\r\n\r\n    // Use Helpers module with fallbacks\r\n    function getResolveField() {\r\n        const helpers = getHelpers();\r\n        if (helpers.getResolveField) return helpers.getResolveField();\r\n        const core = getCore();\r\n        if (core && core.getResolveField) return core.getResolveField();\r\n        // Minimal fallback\r\n        return function(obj, ...paths) {\r\n            for (const path of paths) {\r\n                const keys = path.split('.');\r\n                let value = obj;\r\n                for (const key of keys) {\r\n                    if (value == null) return null;\r\n                    value = value[key];\r\n                }\r\n                if (value !== null && value !== undefined) return value;\r\n            }\r\n            return null;\r\n        };\r\n    }\r\n\r\n    function getEscapeHtml() {\r\n        const helpers = getHelpers();\r\n        if (helpers.getEscapeHtml) return helpers.getEscapeHtml();\r\n        const core = getCore();\r\n        if (core && core.getEscapeHtml) return core.getEscapeHtml();\r\n        // Minimal fallback\r\n        return function(str) {\r\n            if (str == null) return '';\r\n            return String(str)\r\n                .replace(/&/g, '&amp;')\r\n                .replace(/</g, '&lt;')\r\n                .replace(/>/g, '&gt;')\r\n                .replace(/\"/g, '&quot;')\r\n                .replace(/'/g, '&#39;');\r\n        };\r\n    }\r\n\r\n    function getActiveProfile() {\r\n        const helpers = getHelpers();\r\n        if (helpers.getActiveProfile) return helpers.getActiveProfile();\r\n        const core = getCore();\r\n        if (core && core.getActiveProfile) return core.getActiveProfile();\r\n        return GeoLeaf.Config?.getActiveProfile?.() || null;\r\n    }\r\n\r\n    function getLog() {\r\n        const helpers = getHelpers();\r\n        if (helpers.getLog) return helpers.getLog();\r\n        const core = getCore();\r\n        if (core && core.getLog) return core.getLog();\r\n        return GeoLeaf.Utils?.Logger || console;\r\n    }\r\n\r\n    function renderItem(poi, config, options = {}) {\r\n        const enableDebug = (typeof window !== 'undefined' && window.__GEOLEAF_DEBUG_POPUP__) || false;\r\n        const renderers = getRenderers();\r\n        // ...logs [POPUP] supprim√©s...\r\n        if (renderers && renderers.renderItem) {\r\n            const result = renderers.renderItem(poi, config, options);\r\n            return result;\r\n        }\r\n\r\n        // Fallback : renderer direct\r\n        if (!config || !config.type) {\r\n            if (enableDebug) {\r\n                getLog().warn('[Assemblers renderItem DEBUG] No config or type');\r\n            }\r\n            return '';\r\n        }\r\n\r\n        const renderer = renderers['render' + config.type.charAt(0).toUpperCase() + config.type.slice(1)];\r\n        if (!renderer) {\r\n            if (enableDebug) {\r\n                getLog().warn('[Assemblers renderItem DEBUG] No renderer found for type:', config.type);\r\n            }\r\n            getLog().warn('[Assemblers] Type de rendu non support√©:', config.type);\r\n            return '';\r\n        }\r\n\r\n        const result = renderer(poi, config, options);\r\n        if (enableDebug) {\r\n            getLog().warn(`[Assemblers renderItem DEBUG] Result from renderer ${config.type}: ${result ? result.substring(0, 100) + '...' : 'EMPTY'}`);\r\n        }\r\n        return result;\r\n    }\r\n\r\n    // ========================================\r\n    //   ASSEMBLEURS\r\n    // ========================================\r\n\r\n    // ========================================\r\n    //   BUILD POPUP HTML\r\n    // ========================================\r\n\r\n    /**\r\n     * Group popup sections by type (hero images, badges, other)\r\n     * Extracted from buildPopupHTML to reduce complexity\r\n     *\r\n     * @private\r\n     * @param {Array<Object>} sortedConfig - Sorted config array\r\n     * @param {Object} poi - POI data\r\n     * @param {Object} renderOptions - Render options\r\n     * @returns {Array<{type: string, html?: string, items?: Array<string>}>} Grouped sections\r\n     *\r\n     * @typedef {Object} PopupSection\r\n     * @property {'hero'|'badges'|'content'} type - Section type\r\n     * @property {string} [html] - HTML content for hero/content sections\r\n     * @property {Array<string>} [items] - Badge HTML items for badges section\r\n     */\r\n    function groupPopupSections(sortedConfig, poi, renderOptions) {\r\n        const sections = [];\r\n        let badgeGroup = [];\r\n        // ...logs [POPUP] supprim√©s...\r\n        sortedConfig.forEach((item, index) => {\r\n            const isHeroImage = item.type === 'image' && item.variant === 'hero';\r\n            const isBadge = item.type === 'badge';\r\n            const nextItem = sortedConfig[index + 1];\r\n            const nextIsBadge = nextItem && nextItem.type === 'badge';\r\n            const itemHtml = renderItem(poi, item, renderOptions);\r\n            if (isHeroImage) {\r\n                sections.push({ type: 'hero', html: itemHtml });\r\n            } else if (isBadge) {\r\n                badgeGroup.push(itemHtml);\r\n                if (!nextIsBadge) {\r\n                    sections.push({ type: 'badges', items: [...badgeGroup] });\r\n                    badgeGroup = [];\r\n                }\r\n            } else {\r\n                sections.push({ type: 'content', html: itemHtml });\r\n            }\r\n        });\r\n\r\n        return sections;\r\n    }\r\n\r\n    /**\r\n     * Assemble popup HTML from grouped sections\r\n     * Extracted from buildPopupHTML to reduce complexity\r\n     *\r\n     * @private\r\n     * @param {Object} poi - POI data with id property\r\n     * @param {Array<PopupSection>} sections - Grouped popup sections\r\n     * @returns {string} Complete popup HTML\r\n     */\r\n    function assemblePopupHTML(poi, sections) {\r\n        let html = '<div class=\"gl-poi-popup\">';\r\n        let inBody = false;\r\n\r\n        sections.forEach(section => {\r\n            if (section.type === 'hero') {\r\n                if (inBody) {\r\n                    html += '</div>';\r\n                    inBody = false;\r\n                }\r\n                html += section.html;\r\n            } else {\r\n                if (!inBody) {\r\n                    html += '<div class=\"gl-poi-popup__body\">';\r\n                    inBody = true;\r\n                }\r\n\r\n                if (section.type === 'badges') {\r\n                    html += '<div class=\"gl-poi-popup__badges\">';\r\n                    section.items.forEach(badgeHtml => {\r\n                        html += badgeHtml;\r\n                    });\r\n                    html += '</div>';\r\n                } else {\r\n                    html += section.html;\r\n                }\r\n            }\r\n        });\r\n\r\n        // Lien \"Voir plus\"\r\n        if (!inBody) {\r\n            html += '<div class=\"gl-poi-popup__body\">';\r\n            inBody = true;\r\n        }\r\n        html += '<a href=\"#\" class=\"gl-poi-popup__link\" data-poi-id=\"' + (poi.id || '') + '\">Voir plus >>></a>';\r\n\r\n        if (inBody) {\r\n            html += '</div>';\r\n        }\r\n        html += '</div>';\r\n\r\n        return html;\r\n    }\r\n\r\n    /**\r\n     * Construit le HTML complet d'un popup avec structure et groupement de badges.\r\n     *\r\n     * G√®re la structure HTML du popup:\r\n     * 1. Images hero (en dehors du body)\r\n     * 2. Body avec badges group√©s + autres √©l√©ments\r\n     * 3. Lien \"Voir plus >>>\" automatique\r\n     *\r\n     * Tri automatique par config.order, badges group√©s si cons√©cutifs.\r\n     *\r\n     * @function buildPopupHTML\r\n     * @param {Object} poi - Donn√©es du POI normalis√©\r\n     * @param {Object} poi.id - ID du POI\r\n     * @param {Object} poi.attributes - Attributs du POI\r\n     * @param {Array<Object>} config - Configuration detailPopup (array de renderers)\r\n     * @param {Object} config[].type - Type de renderer ('text', 'badge', 'image', etc.)\r\n     * @param {number} config[].order - Ordre d'affichage (tri croissant)\r\n     * @param {string} [config[].variant] - Variante (ex: 'hero' pour images)\r\n     * @param {Object} [options={}] - Options de rendu\r\n     * @param {Function} [options.resolveCategoryDisplay] - R√©solution taxonomie personnalis√©e\r\n     * @returns {string} HTML complet du popup\r\n     *\r\n     * @example\r\n     * // Popup avec image hero + badges + texte\r\n     * const html = buildPopupHTML(\r\n     *   poi,\r\n     *   [\r\n     *     { type: 'image', field: 'attributes.photo', variant: 'hero', order: 1 },\r\n     *     { type: 'badge', field: 'attributes.categoryId', order: 2 },\r\n     *     { type: 'badge', field: 'attributes.status', order: 3 },\r\n     *     { type: 'text', field: 'attributes.description', order: 4 }\r\n     *   ],\r\n     *   {}\r\n     * );\r\n     * // Retourne:\r\n     * // <div class=\"gl-poi-popup\">\r\n     * //   <img src=\"...\" class=\"gl-poi-popup__hero\"> (hero en dehors du body)\r\n     * //   <div class=\"gl-poi-popup__body\">\r\n     * //     <div class=\"gl-poi-popup__badges\">\r\n     * //       <span class=\"gl-poi-badge\">Restaurant</span>\r\n     * //       <span class=\"gl-poi-badge\">Ouvert</span>\r\n     * //     </div>\r\n     * //     <p>Description...</p>\r\n     * //     <a href=\"#\" class=\"gl-poi-popup__link\" data-poi-id=\"123\">Voir plus >>></a>\r\n     * //   </div>\r\n     * // </div>\r\n     */\r\n    function buildPopupHTML(poi, config, options = {}) {\r\n        // Get helpers and utilities FIRST\r\n        const helpers = getHelpers();\r\n        const escapeHtml = getEscapeHtml();\r\n\r\n        if (!poi) {\r\n            getLog().warn('[Assemblers] POI invalide pour buildPopupHTML');\r\n            return '';\r\n        }\r\n\r\n        if (!config || !Array.isArray(config) || config.length === 0) {\r\n            const title = helpers.getDefaultTitle ? helpers.getDefaultTitle(poi) : (poi.title || poi.label || poi.name || 'Sans titre');\r\n            helpers.debugLog?.('popup', 'No config provided, using default popup');\r\n\r\n            return '<div class=\"gl-poi-popup\">' +\r\n                '<div class=\"gl-poi-popup__body\">' +\r\n                '<h3 class=\"gl-poi-popup__title\"><span class=\"gl-poi-popup__title-text\">' + escapeHtml(title) + '</span></h3>' +\r\n                '<a href=\"#\" class=\"gl-poi-popup__link\" data-poi-id=\"' + (poi.id || '') + '\">Voir plus >>></a>' +\r\n                '</div></div>';\r\n        }\r\n\r\n        // ...log supprim√© ([POPUP] buildPopupHTML - config items)...\r\n\r\n        // Use helpers for config sorting\r\n        const sortedConfig = helpers.sortConfigByOrder ? helpers.sortConfigByOrder(config) :\r\n            [...config].sort((a, b) => {\r\n                const orderA = typeof a.order === 'number' ? a.order : 999;\r\n                const orderB = typeof b.order === 'number' ? b.order : 999;\r\n                return orderA - orderB;\r\n            });\r\n\r\n        const renderOptions = {\r\n            context: 'popup',\r\n            includeIcon: true,\r\n            resolveCategoryDisplay: options.resolveCategoryDisplay\r\n        };\r\n\r\n        // ...log supprim√© ([POPUP] buildPopupHTML - sorted config)...\r\n\r\n        // Group sections and assemble HTML\r\n        try {\r\n            const sections = groupPopupSections(sortedConfig, poi, renderOptions);\r\n            // ...log supprim√© ([POPUP] buildPopupHTML - sections grouped)...\r\n\r\n            const html = assemblePopupHTML(poi, sections);\r\n            // ...log supprim√© ([POPUP] buildPopupHTML - HTML length)...\r\n\r\n            return html;\r\n        } catch(err) {\r\n            // ...log supprim√© ([POPUP] ERROR in buildPopupHTML)...\r\n            return '<div class=\"gl-poi-popup\"><div class=\"gl-poi-popup__body\">Erreur: ' + escapeHtml(err.message) + '</div></div>';\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Construit le HTML d'un tooltip (texte uniquement, limit√©).\r\n     *\r\n     * G√©n√®re un tooltip simple avec valeurs textuelles s√©par√©es par \" | \".\r\n     * Pas de HTML complexe, optimis√© pour tooltips Leaflet.\r\n     *\r\n     * Processus:\r\n     * 1. Si pas de config => utilise title/label/name par d√©faut\r\n     * 2. Sinon extrait les valeurs textuelles de chaque renderer\r\n     * 3. G√®re badge resolution via resolveBadgeTooltip\r\n     * 4. Joint les parties avec \" | \"\r\n     *\r\n     * @function buildTooltipHTML\r\n     * @param {Object} poi - Donn√©es du POI normalis√©\r\n     * @param {Object} poi.title - Titre par d√©faut\r\n     * @param {Object} poi.attributes - Attributs du POI\r\n     * @param {Array<Object>} config - Configuration detailTooltip (array de renderers)\r\n     * @param {string} config[].type - Type de renderer ('text', 'badge', 'number', etc.)\r\n     * @param {string} config[].field - Chemin du champ (ex: 'attributes.name')\r\n     * @param {number} [config[].order] - Ordre d'affichage (tri croissant)\r\n     * @param {Object} [options={}] - Options de rendu\r\n     * @returns {string} Texte du tooltip (pas de HTML, texte plat)\r\n     *\r\n     * @example\r\n     * // Tooltip simple sans config\r\n     * const text1 = buildTooltipHTML({ title: 'Restaurant Le Gourmet' }, []);\r\n     * // Retourne: 'Restaurant Le Gourmet'\r\n     *\r\n     * @example\r\n     * // Tooltip avec config (name + category + rating)\r\n     * const text2 = buildTooltipHTML(\r\n     *   poi,\r\n     *   [\r\n     *     { type: 'text', field: 'attributes.name', order: 1 },\r\n     *     { type: 'badge', field: 'attributes.categoryId', order: 2 },\r\n     *     { type: 'number', field: 'attributes.rating', order: 3 }\r\n     *   ]\r\n     * );\r\n     * // Retourne: 'Le Gourmet | Restaurant | 4.5'\r\n     *\r\n     * @example\r\n     * // Tooltip avec valeurs manquantes (skip√©s)\r\n     * const text3 = buildTooltipHTML(\r\n     *   poi,\r\n     *   [\r\n     *     { type: 'text', field: 'attributes.name', order: 1 },\r\n     *     { type: 'text', field: 'attributes.missingField', order: 2 }\r\n     *   ]\r\n     * );\r\n     * // Retourne: 'Le Gourmet' (missingField skipp√©)\r\n     */\r\n    function buildTooltipHTML(poi, config, options = {}) {\r\n        if (!poi) {\r\n            getLog().warn('[Assemblers] POI invalide pour buildTooltipHTML');\r\n            return '';\r\n        }\r\n\r\n        const helpers = getHelpers();\r\n        const escapeHtml = getEscapeHtml();\r\n        const resolveField = getResolveField();\r\n\r\n        // Si pas de config, tooltip par d√©faut - use helpers\r\n        if (!config || !Array.isArray(config) || config.length === 0) {\r\n            const title = helpers.getDefaultTitle ? helpers.getDefaultTitle(poi) :\r\n                (poi.title || poi.label || poi.name ||\r\n                 resolveField(poi, 'attributes.name', 'attributes.nom', 'properties.name', 'properties.nom') ||\r\n                 'Sans titre');\r\n            return escapeHtml(String(title));\r\n        }\r\n\r\n        // Use helpers for config sorting\r\n        const sortedConfig = helpers.sortConfigByOrder ? helpers.sortConfigByOrder(config) :\r\n            [...config].sort((a, b) => {\r\n                const orderA = typeof a.order === 'number' ? a.order : 999;\r\n                const orderB = typeof b.order === 'number' ? b.order : 999;\r\n                return orderA - orderB;\r\n            });\r\n\r\n        const renderOptions = { context: 'tooltip' };\r\n        const parts = [];\r\n\r\n        sortedConfig.forEach((item, index) => {\r\n            if (!item || !item.type || !item.field) return;\r\n\r\n            const value = resolveField(poi, item.field);\r\n            if (value == null || value === '') return;\r\n\r\n            // Pour les tooltips, on extrait juste la valeur textuelle\r\n            if (item.type === 'text' || item.type === 'badge') {\r\n                let displayValue = value;\r\n\r\n                // Use helpers for badge resolution\r\n                if (item.type === 'badge' && helpers.resolveBadgeLabel) {\r\n                    displayValue = helpers.resolveBadgeLabel(poi, item.field, value);\r\n                } else if (item.type === 'badge') {\r\n                    // Fallback to inline resolution\r\n                    const profile = getActiveProfile();\r\n                    const taxonomy = profile?.taxonomy;\r\n                    if (taxonomy) {\r\n                        const attrs = poi.attributes || {};\r\n                        if (item.field.includes('subCategoryId')) {\r\n                            const catId = attrs.categoryId || attrs.category;\r\n                            const catData = taxonomy.categories?.[catId];\r\n                            const subCatData = catData?.subcategories?.[value];\r\n                            if (subCatData?.label) displayValue = subCatData.label;\r\n                        } else if (item.field.includes('categoryId')) {\r\n                            const catData = taxonomy.categories?.[value];\r\n                            if (catData?.label) displayValue = catData.label;\r\n                        }\r\n                    }\r\n                }\r\n\r\n                parts.push(escapeHtml(String(displayValue)));\r\n            }\r\n            else if (item.type === 'number') {\r\n                const numValue = typeof value === 'number' ? value : parseFloat(value);\r\n                if (!isNaN(numValue)) {\r\n                    parts.push(numValue.toLocaleString('fr-FR'));\r\n                }\r\n            }\r\n            else if (item.type === 'image') {\r\n                // Image en tooltip : afficher en ligne\r\n                parts.push('<img src=\"' + escapeHtml(value) + '\" alt=\"\" style=\"max-width:150px;max-height:100px;display:block;margin:4px 0;\" />');\r\n            }\r\n            else if (item.type === 'link') {\r\n                const label = item.label || value;\r\n                parts.push('<a href=\"' + escapeHtml(value) + '\" target=\"_blank\">' + escapeHtml(label) + '</a>');\r\n            }\r\n        });\r\n\r\n        if (parts.length === 0) {\r\n            const title = poi.title || poi.label || 'Sans titre';\r\n            return escapeHtml(String(title));\r\n        }\r\n\r\n        // Joindre avec contentUnion ou espace\r\n        let result = '';\r\n        parts.forEach((part, index) => {\r\n            result += part;\r\n            if (index < parts.length - 1) {\r\n                const item = sortedConfig[index];\r\n                if (item && item.contentUnion) {\r\n                    result += ' ' + escapeHtml(item.contentUnion) + ' ';\r\n                } else {\r\n                    result += ' ';\r\n                }\r\n            }\r\n        });\r\n\r\n        return result;\r\n    }\r\n\r\n    /**\r\n     * Construit les √©l√©ments DOM pour un panneau lat√©ral (side panel / accordion).\r\n     *\r\n     * G√©n√®re un tableau d'objets pour chaque √©l√©ment du panneau:\r\n     * - html: HTML rendu de l'√©l√©ment\r\n     * - config: Configuration renderer originale\r\n     * - label: Label de l'√©l√©ment (pour accord√©on)\r\n     * - accordion: Si true, √©l√©ment dans un accord√©on\r\n     * - defaultOpen: Si true, accord√©on ouvert par d√©faut\r\n     *\r\n     * Tri automatique par config.order, √©l√©ments sans valeur skip√©s.\r\n     *\r\n     * @function buildPanelItems\r\n     * @param {Object} poi - Donn√©es du POI normalis√©\r\n     * @param {Object} poi.attributes - Attributs du POI\r\n     * @param {Array<Object>} config - Configuration detailLayout (array de renderers)\r\n     * @param {string} config[].type - Type de renderer ('text', 'list', 'image', etc.)\r\n     * @param {string} config[].field - Chemin du champ (ex: 'attributes.description')\r\n     * @param {number} [config[].order] - Ordre d'affichage (tri croissant)\r\n     * @param {string} [config[].label] - Label de l'√©l√©ment (pour accord√©on)\r\n     * @param {boolean} [config[].accordion] - Si true, √©l√©ment dans un accord√©on\r\n     * @param {boolean} [config[].defaultOpen=true] - Si false, accord√©on ferm√© par d√©faut\r\n     * @param {Object} [options={}] - Options de rendu\r\n     * @returns {Array<Object>} Tableau d'objets {html, config, label, accordion, defaultOpen}\r\n     * @returns {string} returns[].html - HTML rendu de l'√©l√©ment\r\n     * @returns {Object} returns[].config - Configuration renderer originale\r\n     * @returns {string} returns[].label - Label de l'√©l√©ment\r\n     * @returns {boolean} returns[].accordion - Si true, √©l√©ment dans un accord√©on\r\n     * @returns {boolean} returns[].defaultOpen - Si true, accord√©on ouvert par d√©faut\r\n     *\r\n     * @example\r\n     * // Panel simple sans accord√©on\r\n     * const items1 = buildPanelItems(\r\n     *   poi,\r\n     *   [\r\n     *     { type: 'text', field: 'attributes.name', label: 'Nom', order: 1 },\r\n     *     { type: 'longtext', field: 'attributes.description', label: 'Description', order: 2 }\r\n     *   ]\r\n     * );\r\n     * // Retourne: [\r\n     * //   { html: '<p>...</p>', config: {...}, label: 'Nom', accordion: false, defaultOpen: true },\r\n     * //   { html: '<div>...</div>', config: {...}, label: 'Description', accordion: false, defaultOpen: true }\r\n     * // ]\r\n     *\r\n     * @example\r\n     * // Panel avec accord√©ons\r\n     * const items2 = buildPanelItems(\r\n     *   poi,\r\n     *   [\r\n     *     { type: 'text', field: 'attributes.name', label: 'Nom', order: 1 },\r\n     *     { type: 'list', field: 'attributes.tags', label: 'Tags', accordion: true, defaultOpen: true, order: 2 },\r\n     *     { type: 'gallery', field: 'attributes.photos', label: 'Photos', accordion: true, defaultOpen: false, order: 3 }\r\n     *   ]\r\n     * );\r\n     * // Retourne: [\r\n     * //   { html: '<p>...</p>', label: 'Nom', accordion: false, defaultOpen: true },\r\n     * //   { html: '<ul>...</ul>', label: 'Tags', accordion: true, defaultOpen: true },\r\n     * //   { html: '<div>...</div>', label: 'Photos', accordion: true, defaultOpen: false }\r\n     * // ]\r\n     */\r\n    function buildPanelItems(poi, config, options = {}) {\r\n        if (!poi || !config || !Array.isArray(config)) {\r\n            return [];\r\n        }\r\n\r\n        const resolveField = getResolveField();\r\n        const renderOptions = { context: 'panel', ...options };\r\n\r\n        // Trier par order\r\n        const sortedConfig = [...config].sort((a, b) => {\r\n            const orderA = typeof a.order === 'number' ? a.order : 999;\r\n            const orderB = typeof b.order === 'number' ? b.order : 999;\r\n            return orderA - orderB;\r\n        });\r\n\r\n        const items = [];\r\n\r\n        sortedConfig.forEach(itemConfig => {\r\n            if (!itemConfig || !itemConfig.type) return;\r\n\r\n            // V√©rifier si la valeur existe\r\n            const value = resolveField(poi, itemConfig.field);\r\n            const hasValue = value !== null && value !== undefined && value !== '' &&\r\n                             !(Array.isArray(value) && value.length === 0);\r\n\r\n            if (!hasValue && itemConfig.type !== 'coordinates') return;\r\n\r\n            const html = renderItem(poi, itemConfig, renderOptions);\r\n            if (html) {\r\n                items.push({\r\n                    html: html,\r\n                    config: itemConfig,\r\n                    label: itemConfig.label || '',\r\n                    accordion: itemConfig.accordion === true,\r\n                    defaultOpen: itemConfig.defaultOpen !== false\r\n                });\r\n            }\r\n        });\r\n\r\n        return items;\r\n    }\r\n\r\n    // ========================================\r\n    //   EXPORT\r\n    // ========================================\r\n\r\n    console.log('[POPUP] assemblers.js - Registering Assemblers...');\r\n    console.log('[POPUP] assemblers.js - GeoLeaf before:', !!global.GeoLeaf);\r\n    console.log('[POPUP] assemblers.js - GeoLeaf._ContentBuilder before:', !!global.GeoLeaf?._ContentBuilder);\r\n\r\n    if (!GeoLeaf._ContentBuilder) {\r\n        console.log('[POPUP] assemblers.js - Creating GeoLeaf._ContentBuilder');\r\n        GeoLeaf._ContentBuilder = {};\r\n    }\r\n\r\n    GeoLeaf._ContentBuilder.Assemblers = {\r\n        buildPopupHTML,\r\n        buildTooltipHTML,\r\n        buildPanelItems\r\n    };\r\n\r\n    console.log('[POPUP] assemblers.js - Assemblers registered:', !!GeoLeaf._ContentBuilder.Assemblers);\r\n    console.log('[POPUP] assemblers.js - global.GeoLeaf._ContentBuilder.Assemblers:', !!global.GeoLeaf._ContentBuilder.Assemblers);\r\n\r\n    // Make sure global reference is updated\r\n    global.GeoLeaf = GeoLeaf;\r\n\r\n    getLog().info('[GeoLeaf._ContentBuilder.Assemblers] Module Assemblers charg√©');\r\n\r\n    global.GeoLeaf = GeoLeaf;\r\n\r\n})(typeof window !== 'undefined' ? window : global);\r\n","/**\r\n * GeoLeaf UI Content Builder Module\r\n * Module central pour la construction du contenu des tooltips, popups et panneaux lat√©raux.\r\n * Unifie le rendu pour tous les types de sources (JSON, GeoJSON, GPX, routes).\r\n *\r\n * @module ui/content-builder\r\n * @version 1.0.0\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    GeoLeaf._ContentBuilder = GeoLeaf._ContentBuilder || {};\r\n\r\n    // ========================================\r\n    //   CORE HELPERS (depuis Core module)\r\n    // ========================================\r\n\r\n    /**\r\n     * R√©cup√®re les helpers depuis Core (avec fallback)\r\n     */\r\n    function getCore() {\r\n        return GeoLeaf._ContentBuilder.Core || {\r\n            getResolveField: function() {\r\n                return GeoLeaf.Utils?.resolveField || (() => null);\r\n            },\r\n            getEscapeHtml: function() {\r\n                return GeoLeaf.Security?.escapeHtml || function(str) {\r\n                    if (str == null) return '';\r\n                    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;');\r\n                };\r\n            },\r\n            getActiveProfile: function() {\r\n                return GeoLeaf.Config?.getActiveProfile?.() || null;\r\n            },\r\n            getLog: function() {\r\n                return GeoLeaf.Log || console;\r\n            }\r\n        };\r\n    }\r\n\r\n    // Raccourcis vers Core\r\n    const getResolveField = () => getCore().getResolveField();\r\n    const getEscapeHtml = () => getCore().getEscapeHtml();\r\n    const getActiveProfile = () => getCore().getActiveProfile();\r\n    const getLog = () => getCore().getLog();\r\n\r\n    // ========================================\r\n    //   RENDERERS PAR TYPE\r\n    // ========================================\r\n\r\n    /**\r\n     * Construit un √©l√©ment de type \"text\"\r\n     * @param {Object} poi - Donn√©es du POI\r\n     * @param {Object} config - Configuration de l'√©l√©ment\r\n     * @param {Object} options - Options de rendu (context: 'popup'|'tooltip'|'panel')\r\n     * @returns {string} HTML\r\n     */\r\n    function renderText(poi, config, options = {}) {\r\n        const resolveField = getResolveField();\r\n        const escapeHtml = getEscapeHtml();\r\n\r\n        // Tester le champ tel quel, puis avec fallback attributes si properties\r\n        let value = resolveField(poi, config.field);\r\n\r\n        // Si le champ commence par \"properties.\" et n'a pas de valeur, essayer avec \"attributes.\"\r\n        if ((value == null || value === '') && config.field && config.field.startsWith('properties.')) {\r\n            const attributesField = config.field.replace(/^properties\\./, 'attributes.');\r\n            value = resolveField(poi, attributesField);\r\n        }\r\n\r\n        // Si le champ commence par \"attributes.\" et n'a pas de valeur, essayer avec \"properties.\"\r\n        if ((value == null || value === '') && config.field && config.field.startsWith('attributes.')) {\r\n            const propertiesField = config.field.replace(/^attributes\\./, 'properties.');\r\n            value = resolveField(poi, propertiesField);\r\n        }\r\n\r\n        if (value == null || value === '') return '';\r\n\r\n        const escaped = escapeHtml(String(value));\r\n        const variant = config.variant || 'default';\r\n        const context = options.context || 'popup';\r\n\r\n        if (variant === 'title') {\r\n            // Titre avec √©ventuelle ic√¥ne\r\n            let iconHtml = '';\r\n            if (options.includeIcon && options.resolveCategoryDisplay) {\r\n                const displayConfig = options.resolveCategoryDisplay(poi);\r\n                if (displayConfig && displayConfig.iconId) {\r\n                    const iconsConfig = (GeoLeaf.Config && typeof GeoLeaf.Config.getIconsConfig === \"function\")\r\n                        ? GeoLeaf.Config.getIconsConfig()\r\n                        : null;\r\n                    const iconPrefix = (iconsConfig && iconsConfig.symbolPrefix) || 'gl-poi-cat-';\r\n                    const iconIdNormalized = String(displayConfig.iconId).trim().toLowerCase().replace(/\\s+/g, '-');\r\n                    const symbolId = iconPrefix + iconIdNormalized;\r\n                    iconHtml = '<svg class=\"gl-poi-popup__icon\" aria-hidden=\"true\" focusable=\"false\" viewBox=\"0 0 24 24\">' +\r\n                        '<circle cx=\"12\" cy=\"12\" r=\"10\" fill=\"' + (displayConfig.colorFill || '#666') + '\" stroke=\"' + (displayConfig.colorStroke || '#222') + '\" stroke-width=\"1.5\"/>' +\r\n                        '<svg x=\"4\" y=\"4\" width=\"16\" height=\"16\"><use href=\"#' + symbolId + '\" style=\"color: #ffffff\"/></svg>' +\r\n                        '</svg>';\r\n                }\r\n            }\r\n            return '<h3 class=\"gl-poi-popup__title\">' + iconHtml + '<span class=\"gl-poi-popup__title-text\">' + escaped + '</span></h3>';\r\n        }\r\n\r\n        if (variant === 'short') {\r\n            return '<p class=\"gl-poi-popup__desc\">' + escaped + '</p>';\r\n        }\r\n\r\n        if (variant === 'long' || variant === 'paragraph') {\r\n            return '<p class=\"gl-poi-popup__desc gl-poi-popup__desc--long\">' + escaped + '</p>';\r\n        }\r\n\r\n        return '<p class=\"gl-poi-popup__desc\">' + escaped + '</p>';\r\n    }\r\n\r\n    /**\r\n     * Construit un √©l√©ment de type \"longtext\"\r\n     * @param {Object} poi - Donn√©es du POI\r\n     * @param {Object} config - Configuration de l'√©l√©ment\r\n     * @param {Object} options - Options de rendu\r\n     * @returns {string} HTML\r\n     */\r\n    function renderLongtext(poi, config, options = {}) {\r\n        const resolveField = getResolveField();\r\n        const escapeHtml = getEscapeHtml();\r\n\r\n        let value = resolveField(poi, config.field);\r\n        if ((value == null || value === '') && config.field && config.field.startsWith('properties.')) {\r\n            value = resolveField(poi, config.field.replace(/^properties\\./, 'attributes.'));\r\n        }\r\n        if ((value == null || value === '') && config.field && config.field.startsWith('attributes.')) {\r\n            value = resolveField(poi, config.field.replace(/^attributes\\./, 'properties.'));\r\n        }\r\n        if (value == null || value === '') return '';\r\n\r\n        const escaped = escapeHtml(String(value));\r\n        return '<div class=\"gl-content__longtext\"><p>' + escaped.replace(/\\n/g, '</p><p>') + '</p></div>';\r\n    }\r\n\r\n    /**\r\n     * Construit un √©l√©ment de type \"number\"\r\n     * @param {Object} poi - Donn√©es du POI\r\n     * @param {Object} config - Configuration de l'√©l√©ment\r\n     * @param {Object} options - Options de rendu\r\n     * @returns {string} HTML\r\n     */\r\n    function renderNumber(poi, config, options = {}) {\r\n        const resolveField = getResolveField();\r\n        const escapeHtml = getEscapeHtml();\r\n\r\n        let value = resolveField(poi, config.field);\r\n        if ((value == null || value === '') && config.field && config.field.startsWith('properties.')) {\r\n            value = resolveField(poi, config.field.replace(/^properties\\./, 'attributes.'));\r\n        }\r\n        if ((value == null || value === '') && config.field && config.field.startsWith('attributes.')) {\r\n            value = resolveField(poi, config.field.replace(/^attributes\\./, 'properties.'));\r\n        }\r\n        if (value == null || value === '') return '';\r\n\r\n        const numValue = typeof value === 'number' ? value : parseFloat(value);\r\n        if (isNaN(numValue)) return '';\r\n\r\n        const formatted = numValue.toLocaleString('fr-FR');\r\n        const label = config.label ? escapeHtml(config.label) : '';\r\n        const variant = config.variant || 'default';\r\n\r\n        if (variant === 'stat') {\r\n            return '<div class=\"gl-content__stat\">' +\r\n                (label ? '<span class=\"gl-content__stat-label\">' + label + '</span>' : '') +\r\n                '<span class=\"gl-content__stat-value\">' + formatted + '</span>' +\r\n                '</div>';\r\n        }\r\n\r\n        return '<p class=\"gl-content__number\">' +\r\n            (label ? '<strong>' + label + ':</strong> ' : '') +\r\n            formatted + '</p>';\r\n    }\r\n\r\n    /**\r\n     * Construit un √©l√©ment de type \"metric\" (nombre avec unit√©/suffixe)\r\n     * @param {Object} poi - Donn√©es du POI\r\n     * @param {Object} config - Configuration de l'√©l√©ment\r\n     * @param {Object} options - Options de rendu\r\n     * @returns {string} HTML\r\n     */\r\n    function renderMetric(poi, config, options = {}) {\r\n        const resolveField = getResolveField();\r\n        const escapeHtml = getEscapeHtml();\r\n\r\n        let value = resolveField(poi, config.field);\r\n        if ((value == null || value === '') && config.field && config.field.startsWith('properties.')) {\r\n            value = resolveField(poi, config.field.replace(/^properties\\./, 'attributes.'));\r\n        }\r\n        if ((value == null || value === '') && config.field && config.field.startsWith('attributes.')) {\r\n            value = resolveField(poi, config.field.replace(/^attributes\\./, 'properties.'));\r\n        }\r\n        if (value == null || value === '') return '';\r\n\r\n        const numValue = typeof value === 'number' ? value : parseFloat(value);\r\n        if (isNaN(numValue)) return '';\r\n\r\n        // Utiliser Templates si disponible, sinon fallback\r\n        if (GeoLeaf._ContentBuilder && GeoLeaf._ContentBuilder.Templates) {\r\n            return GeoLeaf._ContentBuilder.Templates.createMetricElement(numValue, config, escapeHtml);\r\n        }\r\n\r\n        // Fallback si Templates pas charg√©\r\n        const formatted = numValue.toLocaleString('fr-FR');\r\n        const suffix = config.suffix ? escapeHtml(config.suffix) : '';\r\n        const prefix = config.prefix ? escapeHtml(config.prefix) : '';\r\n        const label = config.label ? escapeHtml(config.label) : '';\r\n        return '<p class=\"gl-content__metric\">' +\r\n            (label ? '<strong>' + label + ':</strong> ' : '') +\r\n            prefix + formatted + suffix + '</p>';\r\n    }\r\n\r\n    /**\r\n     * Construit un √©l√©ment de type \"badge\"\r\n     * @param {Object} poi - Donn√©es du POI\r\n     * @param {Object} config - Configuration de l'√©l√©ment\r\n     * @param {Object} options - Options de rendu\r\n     * @returns {string} HTML\r\n     */\r\n    function renderBadge(poi, config, options = {}) {\r\n        const resolveField = getResolveField();\r\n        const escapeHtml = getEscapeHtml();\r\n        const Core = getCore();\r\n\r\n        let value = resolveField(poi, config.field);\r\n        if ((value == null || value === '') && config.field && config.field.startsWith('properties.')) {\r\n            value = resolveField(poi, config.field.replace(/^properties\\./, 'attributes.'));\r\n        }\r\n        if ((value == null || value === '') && config.field && config.field.startsWith('attributes.')) {\r\n            value = resolveField(poi, config.field.replace(/^attributes\\./, 'properties.'));\r\n        }\r\n        if (value == null || value === '') return '';\r\n\r\n        const variant = config.variant || 'default';\r\n\r\n        // Utiliser le badge resolver de Core\r\n        const badge = Core.resolveBadge ?\r\n            Core.resolveBadge(poi, config.field, variant) :\r\n            { displayValue: String(value), style: '' };\r\n\r\n        const escaped = escapeHtml(badge.displayValue);\r\n        const badgeClass = 'gl-poi-badge gl-poi-badge--' + variant;\r\n        const styleAttr = badge.style ? ' style=\"' + badge.style + '\"' : '';\r\n\r\n        return '<span class=\"' + badgeClass + '\"' + styleAttr + '>' + escaped + '</span>';\r\n    }\r\n\r\n    /**\r\n     * Construit un √©l√©ment de type \"rating\"\r\n     * @param {Object} poi - Donn√©es du POI\r\n     * @param {Object} config - Configuration de l'√©l√©ment\r\n     * @param {Object} options - Options de rendu\r\n     * @returns {string} HTML\r\n     */\r\n    function renderRating(poi, config, options = {}) {\r\n        const resolveField = getResolveField();\r\n        const escapeHtml = getEscapeHtml();\r\n\r\n        let value = resolveField(poi, config.field);\r\n        if ((value == null || value === '') && config.field && config.field.startsWith('properties.')) {\r\n            value = resolveField(poi, config.field.replace(/^properties\\./, 'attributes.'));\r\n        }\r\n        if ((value == null || value === '') && config.field && config.field.startsWith('attributes.')) {\r\n            value = resolveField(poi, config.field.replace(/^attributes\\./, 'properties.'));\r\n        }\r\n        if (value == null || value === '') return '';\r\n\r\n        const rating = typeof value === 'number' ? value : parseFloat(value);\r\n        if (isNaN(rating) || rating < 0 || rating > 5) return '';\r\n\r\n        // Variant stat avec layout sp√©cial (conserver l'ancien)\r\n        if (config.variant === 'stat') {\r\n            const label = config.label ? escapeHtml(config.label) : '';\r\n            let starsHtml = '<span class=\"gl-rating__stars\">';\r\n            for (let i = 1; i <= 5; i++) {\r\n                const isFilled = i <= Math.round(rating);\r\n                starsHtml += '<span class=\"gl-rating__star' + (isFilled ? ' gl-rating__star--filled' : '') + '\">‚òÖ</span>';\r\n            }\r\n            starsHtml += '</span>';\r\n            const numericValue = rating.toFixed(1);\r\n            return '<div class=\"gl-rating gl-rating--stat\">' +\r\n                (label ? '<span class=\"gl-rating__label\">' + label + '</span>' : '') +\r\n                '<div class=\"gl-rating__content\">' +\r\n                starsHtml +\r\n                '<span class=\"gl-rating__value\">' + numericValue + '/5</span>' +\r\n                '</div>' +\r\n                '</div>';\r\n        }\r\n\r\n        // Variante par d√©faut : utiliser template si disponible\r\n        if (GeoLeaf._ContentBuilder && GeoLeaf._ContentBuilder.Templates) {\r\n            return GeoLeaf._ContentBuilder.Templates.createRatingElement(rating, config, escapeHtml);\r\n        }\r\n\r\n        // Fallback si Templates pas charg√©\r\n        const label = config.label ? escapeHtml(config.label) : '';\r\n        let starsHtml = '<span class=\"gl-rating__stars\">';\r\n        for (let i = 1; i <= 5; i++) {\r\n            const isFilled = i <= Math.round(rating);\r\n            starsHtml += '<span class=\"gl-rating__star' + (isFilled ? ' gl-rating__star--filled' : '') + '\">‚òÖ</span>';\r\n        }\r\n        starsHtml += '</span>';\r\n        const numericValue = rating.toFixed(1);\r\n        return '<div class=\"gl-rating\">' +\r\n            (label ? '<span class=\"gl-rating__label\">' + label + ': </span>' : '') +\r\n            starsHtml +\r\n            '<span class=\"gl-rating__value\">' + numericValue + '/5</span>' +\r\n            '</div>';\r\n    }\r\n\r\n    /**\r\n     * Construit un √©l√©ment de type \"image\"\r\n     * @param {Object} poi - Donn√©es du POI\r\n     * @param {Object} config - Configuration de l'√©l√©ment\r\n     * @param {Object} options - Options de rendu\r\n     * @returns {string} HTML\r\n     */\r\n    function renderImage(poi, config, options = {}) {\r\n        const resolveField = getResolveField();\r\n        const escapeHtml = getEscapeHtml();\r\n        const Core = getCore();\r\n\r\n        let value = resolveField(poi, config.field);\r\n        if ((value == null || value === '') && config.field && config.field.startsWith('properties.')) {\r\n            value = resolveField(poi, config.field.replace(/^properties\\./, 'attributes.'));\r\n        }\r\n        if ((value == null || value === '') && config.field && config.field.startsWith('attributes.')) {\r\n            value = resolveField(poi, config.field.replace(/^attributes\\./, 'properties.'));\r\n        }\r\n        if (value == null || value === '') return '';\r\n\r\n        // Utiliser le validator de Core\r\n        const photoUrl = Core.validateImageUrl ?\r\n            Core.validateImageUrl(value) :\r\n            value;\r\n\r\n        if (!photoUrl) return '';\r\n\r\n        const alt = escapeHtml(config.label || 'Image');\r\n        const variant = config.variant || 'default';\r\n\r\n        if (variant === 'hero') {\r\n            return '<div class=\"gl-poi-popup__photo\"><img src=\"' + photoUrl + '\" alt=\"' + alt + '\" loading=\"lazy\" /></div>';\r\n        }\r\n\r\n        return '<div class=\"gl-poi-popup__photo\"><img src=\"' + photoUrl + '\" alt=\"' + alt + '\" loading=\"lazy\" /></div>';\r\n    }\r\n\r\n    /**\r\n     * Construit un √©l√©ment de type \"link\"\r\n     * @param {Object} poi - Donn√©es du POI\r\n     * @param {Object} config - Configuration de l'√©l√©ment\r\n     * @param {Object} options - Options de rendu\r\n     * @returns {string} HTML\r\n     */\r\n    function renderLink(poi, config, options = {}) {\r\n        const resolveField = getResolveField();\r\n        const escapeHtml = getEscapeHtml();\r\n\r\n        let value = resolveField(poi, config.field);\r\n        if ((value == null || value === '') && config.field && config.field.startsWith('properties.')) {\r\n            value = resolveField(poi, config.field.replace(/^properties\\./, 'attributes.'));\r\n        }\r\n        if ((value == null || value === '') && config.field && config.field.startsWith('attributes.')) {\r\n            value = resolveField(poi, config.field.replace(/^attributes\\./, 'properties.'));\r\n        }\r\n        if (value == null || value === '') return '';\r\n\r\n        const label = escapeHtml(config.label || value);\r\n        const variant = config.variant || 'default';\r\n\r\n        if (variant === 'button') {\r\n            return '<a href=\"' + escapeHtml(value) + '\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"gl-content__link gl-content__link--button\">' + label + '</a>';\r\n        }\r\n\r\n        return '<a href=\"' + escapeHtml(value) + '\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"gl-content__link\">' + label + '</a>';\r\n    }\r\n\r\n    /**\r\n     * Construit un √©l√©ment de type \"list\"\r\n     * @param {Object} poi - Donn√©es du POI\r\n     * @param {Object} config - Configuration de l'√©l√©ment\r\n     * @param {Object} options - Options de rendu\r\n     * @returns {string} HTML\r\n     */\r\n    function renderList(poi, config, options = {}) {\r\n        const resolveField = getResolveField();\r\n        const escapeHtml = getEscapeHtml();\r\n\r\n        let value = resolveField(poi, config.field);\r\n        if ((value == null || value === '') && config.field && config.field.startsWith('properties.')) {\r\n            value = resolveField(poi, config.field.replace(/^properties\\./, 'attributes.'));\r\n        }\r\n        if ((value == null || value === '') && config.field && config.field.startsWith('attributes.')) {\r\n            value = resolveField(poi, config.field.replace(/^attributes\\./, 'properties.'));\r\n        }\r\n        if (value == null) return '';\r\n\r\n        let items = [];\r\n        if (Array.isArray(value)) {\r\n            items = value;\r\n        } else if (typeof value === 'object') {\r\n            items = Object.entries(value).map(([k, v]) => k + ': ' + v);\r\n        } else {\r\n            return '';\r\n        }\r\n\r\n        if (items.length === 0) return '';\r\n\r\n        // Utiliser Templates si disponible, sinon fallback\r\n        if (GeoLeaf._ContentBuilder && GeoLeaf._ContentBuilder.Templates) {\r\n            return GeoLeaf._ContentBuilder.Templates.createListElement(items, config, escapeHtml);\r\n        }\r\n\r\n        // Fallback si Templates pas charg√©\r\n        const variant = config.variant || 'disc';\r\n        const listClass = 'gl-content__list gl-content__list--' + variant;\r\n        let html = '<ul class=\"' + listClass + '\">';\r\n        items.forEach(item => {\r\n            html += '<li>' + escapeHtml(String(item)) + '</li>';\r\n        });\r\n        html += '</ul>';\r\n        return html;\r\n    }\r\n\r\n    /**\r\n     * Construit un √©l√©ment de type \"table\"\r\n     * @param {Object} poi - Donn√©es du POI\r\n     * @param {Object} config - Configuration de l'√©l√©ment\r\n     * @param {Object} options - Options de rendu\r\n     * @returns {string} HTML\r\n     */\r\n    function renderTable(poi, config, options = {}) {\r\n        const resolveField = getResolveField();\r\n        const escapeHtml = getEscapeHtml();\r\n\r\n        const value = resolveField(poi, config.field);\r\n        if (value == null || !Array.isArray(value) || value.length === 0) return '';\r\n\r\n        const columns = config.columns || [];\r\n        if (columns.length === 0) return '';\r\n\r\n        const borders = config.borders || {};\r\n        let tableStyle = '';\r\n        if (borders.color) {\r\n            tableStyle += '--gl-table-border-color: ' + borders.color + ';';\r\n        }\r\n\r\n        let tableClass = 'gl-content__table';\r\n        if (borders.outer) tableClass += ' gl-content__table--border-outer';\r\n        if (borders.row) tableClass += ' gl-content__table--border-row';\r\n        if (borders.column) tableClass += ' gl-content__table--border-column';\r\n\r\n        let html = '<table class=\"' + tableClass + '\"' + (tableStyle ? ' style=\"' + tableStyle + '\"' : '') + '>';\r\n\r\n        // Header\r\n        html += '<thead><tr>';\r\n        columns.forEach(col => {\r\n            html += '<th>' + escapeHtml(col.label || col.key) + '</th>';\r\n        });\r\n        html += '</tr></thead>';\r\n\r\n        // Body\r\n        html += '<tbody>';\r\n        value.forEach(row => {\r\n            html += '<tr>';\r\n            columns.forEach(col => {\r\n                const cellValue = typeof row === 'object' ? (row[col.key] || '') : row;\r\n                html += '<td>' + escapeHtml(String(cellValue)) + '</td>';\r\n            });\r\n            html += '</tr>';\r\n        });\r\n        html += '</tbody></table>';\r\n\r\n        return html;\r\n    }\r\n\r\n    /**\r\n     * Construit un √©l√©ment de type \"tags\"\r\n     * @param {Object} poi - Donn√©es du POI\r\n     * @param {Object} config - Configuration de l'√©l√©ment\r\n     * @param {Object} options - Options de rendu\r\n     * @returns {string} HTML\r\n     */\r\n    function renderTags(poi, config, options = {}) {\r\n        const resolveField = getResolveField();\r\n        const escapeHtml = getEscapeHtml();\r\n\r\n        const value = resolveField(poi, config.field);\r\n        if (value == null || !Array.isArray(value) || value.length === 0) return '';\r\n\r\n        const validTags = value.filter(tag => tag && typeof tag === 'string');\r\n        if (validTags.length === 0) return '';\r\n\r\n        // Utiliser Templates si disponible, sinon fallback\r\n        if (GeoLeaf._ContentBuilder && GeoLeaf._ContentBuilder.Templates) {\r\n            return GeoLeaf._ContentBuilder.Templates.createTagsElement(validTags, config, escapeHtml);\r\n        }\r\n\r\n        // Fallback si Templates pas charg√©\r\n        let html = '<div class=\"gl-content__tags\">';\r\n        validTags.forEach(tag => {\r\n            html += '<span class=\"gl-content__tag\">' + escapeHtml(tag) + '</span>';\r\n        });\r\n        html += '</div>';\r\n        return html;\r\n    }\r\n\r\n    /**\r\n     * Construit un √©l√©ment de type \"coordinates\"\r\n     * @param {Object} poi - Donn√©es du POI\r\n     * @param {Object} config - Configuration de l'√©l√©ment\r\n     * @param {Object} options - Options de rendu\r\n     * @returns {string} HTML\r\n     */\r\n    function renderCoordinates(poi, config, options = {}) {\r\n        const resolveField = getResolveField();\r\n        const escapeHtml = getEscapeHtml();\r\n        const Core = getCore();\r\n\r\n        const value = resolveField(poi, config.field);\r\n        if (value == null) return '';\r\n\r\n        // Utiliser le validator de Core\r\n        const coords = Core.validateCoordinates ?\r\n            Core.validateCoordinates(value) :\r\n            null;\r\n\r\n        if (!coords) return '';\r\n\r\n        // Utiliser Templates si disponible, sinon fallback\r\n        if (GeoLeaf._ContentBuilder && GeoLeaf._ContentBuilder.Templates) {\r\n            return GeoLeaf._ContentBuilder.Templates.createCoordinatesElement(coords.lat, coords.lng, config, escapeHtml);\r\n        }\r\n\r\n        // Fallback si Templates pas charg√©\r\n        const label = config.label ? escapeHtml(config.label) : 'Coordonn√©es';\r\n        const formatted = Core.formatCoordinates ?\r\n            Core.formatCoordinates(coords.lat, coords.lng) :\r\n            coords.lat.toFixed(6) + ', ' + coords.lng.toFixed(6);\r\n        return '<div class=\"gl-content__coordinates\">' +\r\n            '<span class=\"gl-content__coordinates-label\">' + label + ':</span> ' +\r\n            '<span class=\"gl-content__coordinates-value\">' + formatted + '</span>' +\r\n            '</div>';\r\n    }\r\n\r\n    /**\r\n     * Construit un √©l√©ment de type \"gallery\"\r\n     * @param {Object} poi - Donn√©es du POI\r\n     * @param {Object} config - Configuration de l'√©l√©ment\r\n     * @param {Object} options - Options de rendu\r\n     * @returns {string} HTML\r\n     */\r\n    function renderGallery(poi, config, options = {}) {\r\n        const resolveField = getResolveField();\r\n        const escapeHtml = getEscapeHtml();\r\n\r\n        const value = resolveField(poi, config.field);\r\n        if (value == null || !Array.isArray(value) || value.length === 0) return '';\r\n\r\n        const validPhotos = value.filter(url => url && typeof url === 'string');\r\n        if (validPhotos.length === 0) return '';\r\n\r\n        // Utiliser Templates si disponible, sinon fallback\r\n        if (GeoLeaf._ContentBuilder && GeoLeaf._ContentBuilder.Templates) {\r\n            return GeoLeaf._ContentBuilder.Templates.createGalleryElement(validPhotos, config, escapeHtml);\r\n        }\r\n\r\n        // Fallback si Templates pas charg√©\r\n        let html = '<div class=\"gl-content__gallery\">';\r\n        validPhotos.forEach((imgUrl, index) => {\r\n            html += '<div class=\"gl-content__gallery-item\" data-index=\"' + index + '\">' +\r\n                '<img src=\"' + escapeHtml(imgUrl) + '\" alt=\"Image ' + (index + 1) + '\" loading=\"lazy\" />' +\r\n                '</div>';\r\n        });\r\n        html += '</div>';\r\n        return html;\r\n    }\r\n\r\n    // ========================================\r\n    //   REGISTRE DES RENDERERS\r\n    // ========================================\r\n\r\n    const RENDERERS = {\r\n        text: renderText,\r\n        longtext: renderLongtext,\r\n        number: renderNumber,\r\n        metric: renderMetric,\r\n        badge: renderBadge,\r\n        rating: renderRating,\r\n        image: renderImage,\r\n        link: renderLink,\r\n        list: renderList,\r\n        table: renderTable,\r\n        tags: renderTags,\r\n        coordinates: renderCoordinates,\r\n        gallery: renderGallery\r\n    };\r\n\r\n    /**\r\n     * Rend un √©l√©ment selon son type\r\n     * @param {Object} poi - Donn√©es du POI\r\n     * @param {Object} config - Configuration de l'√©l√©ment\r\n     * @param {Object} options - Options de rendu\r\n     * @returns {string} HTML\r\n     */\r\n    function renderItem(poi, config, options = {}) {\r\n        if (!config || !config.type) return '';\r\n\r\n        const renderer = RENDERERS[config.type];\r\n        if (!renderer) {\r\n            getLog().warn('[ContentBuilder] Type de rendu non support√©:', config.type);\r\n            return '';\r\n        }\r\n\r\n        return renderer(poi, config, options);\r\n    }\r\n\r\n    // ========================================\r\n    //   ASSEMBLEURS (via module Assemblers)\r\n    // ========================================\r\n\r\n    function getAssemblers() {\r\n        return global.GeoLeaf?._ContentBuilder?.Assemblers || null;\r\n    }\r\n\r\n    /**\r\n     * Construit le HTML complet d'un popup\r\n     * D√©l√®gue √† Assemblers.buildPopupHTML si disponible\r\n     */\r\n    function buildPopupHTML(poi, config, options = {}) {\r\n        const Assemblers = getAssemblers();\r\n\r\n        // ...logs supprim√©s ([POPUP] wrapper buildPopupHTML)...\r\n        if (Assemblers && Assemblers.buildPopupHTML) {\r\n            return Assemblers.buildPopupHTML(poi, config, options);\r\n        }\r\n        // Fallback minimal\r\n        if (!poi) return '';\r\n        const escapeHtml = getEscapeHtml();\r\n        const title = poi.title || poi.label || poi.name || 'Sans titre';\r\n        return '<div class=\"gl-poi-popup\"><div class=\"gl-poi-popup__body\">' +\r\n               '<h3 class=\"gl-poi-popup__title\"><span class=\"gl-poi-popup__title-text\">' +\r\n               escapeHtml(title) + '</span></h3>' +\r\n               '<a href=\"#\" class=\"gl-poi-popup__link\" data-poi-id=\"' + (poi.id || '') +\r\n               '\">Voir plus >>></a></div></div>';\r\n    }\r\n\r\n    /**\r\n     * Construit le HTML d'un tooltip\r\n     * D√©l√®gue √† Assemblers.buildTooltipHTML si disponible\r\n     */\r\n    function buildTooltipHTML(poi, config, options = {}) {\r\n        const Assemblers = getAssemblers();\r\n        if (Assemblers && Assemblers.buildTooltipHTML) {\r\n            return Assemblers.buildTooltipHTML(poi, config, options);\r\n        }\r\n\r\n        // Fallback minimal\r\n        if (!poi) return '';\r\n        const escapeHtml = getEscapeHtml();\r\n        const resolveField = getResolveField();\r\n        const title = poi.title || poi.label || poi.name ||\r\n                      resolveField(poi, 'attributes.name', 'attributes.nom', 'properties.name', 'properties.nom') ||\r\n                      'Sans titre';\r\n        return escapeHtml(String(title));\r\n    }\r\n\r\n    /**\r\n     * Construit les √©l√©ments DOM pour un panneau lat√©ral\r\n     * D√©l√®gue √† Assemblers.buildPanelItems si disponible\r\n     */\r\n    function buildPanelItems(poi, config, options = {}) {\r\n        const Assemblers = getAssemblers();\r\n        if (Assemblers && Assemblers.buildPanelItems) {\r\n            return Assemblers.buildPanelItems(poi, config, options);\r\n        }\r\n\r\n        // Fallback minimal\r\n        return [];\r\n    }\r\n\r\n    // ========================================\r\n    //   EXPORT\r\n    // ========================================\r\n\r\n    // Preserve existing Assemblers if it exists\r\n    const existingAssemblers = global.GeoLeaf?._ContentBuilder?.Assemblers;\r\n\r\n    GeoLeaf._ContentBuilder = {\r\n        // Renderers individuels\r\n        renderText,\r\n        renderLongtext,\r\n        renderNumber,\r\n        renderBadge,\r\n        renderImage,\r\n        renderLink,\r\n        renderList,\r\n        renderTable,\r\n        renderTags,\r\n        renderCoordinates,\r\n        renderGallery,\r\n        renderItem,\r\n\r\n        // Assembleurs\r\n        buildPopupHTML,\r\n        buildTooltipHTML,\r\n        buildPanelItems,\r\n\r\n        // Utilitaires expos√©s\r\n        getResolveField,\r\n        getEscapeHtml,\r\n        getActiveProfile\r\n    };\r\n\r\n    // Restore Assemblers module reference\r\n    if (existingAssemblers) {\r\n        GeoLeaf._ContentBuilder.Assemblers = existingAssemblers;\r\n    }\r\n\r\n    global.GeoLeaf = GeoLeaf;\r\n\r\n    getLog().info('[GeoLeaf._ContentBuilder] Module Content Builder charg√©');\r\n\r\n})(typeof window !== 'undefined' ? window : global);\r\n","/**\r\n * GeoLeaf UI Components - Module commun partag√©\r\n * Composants d'interface r√©utilisables pour Legend et LayerManager\r\n *\r\n * Extrait le code commun entre:\r\n * - legend-renderer.js\r\n * - layer-manager/renderer.js\r\n *\r\n * D√âPENDANCES:\r\n * - Leaflet (L.DomUtil, L.DomEvent)\r\n * - GeoLeaf.Log (optionnel)\r\n *\r\n * EXPOSE:\r\n * - GeoLeaf._UIComponents\r\n *\r\n * @module ui/components\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    const Log = GeoLeaf.Log;\r\n\r\n    /**\r\n     * Module UI Components\r\n     * @namespace _UIComponents\r\n     * @private\r\n     */\r\n    const _UIComponents = {\r\n        /**\r\n         * Cr√©e un accord√©on\r\n         * @param {HTMLElement} container - Conteneur parent\r\n         * @param {Object} config - Configuration de l'accord√©on\r\n         * @param {string} config.layerId - ID de la couche\r\n         * @param {string} config.label - Titre de l'accord√©on\r\n         * @param {boolean} config.collapsed - √âtat initial\r\n         * @param {boolean} config.visible - Couche visible ou non (pour grisage)\r\n         * @param {Function} [config.onToggle] - Callback lors du toggle\r\n         * @returns {Object} - { accordionEl, headerEl, bodyEl }\r\n         */\r\n        createAccordion(container, config) {\r\n            const accordionEl = global.L.DomUtil.create(\"div\", \"gl-legend__accordion\", container);\r\n            accordionEl.setAttribute(\"data-layer-id\", config.layerId);\r\n\r\n            if (config.collapsed) {\r\n                accordionEl.classList.add(\"gl-legend__accordion--collapsed\");\r\n            }\r\n\r\n            // Ajouter classe inactive si la couche n'est pas visible\r\n            if (config.visible === false) {\r\n                accordionEl.classList.add(\"gl-legend__accordion--inactive\");\r\n            }\r\n\r\n            // Header de l'accord√©on\r\n            const headerEl = global.L.DomUtil.create(\"div\", \"gl-legend__accordion-header\", accordionEl);\r\n            headerEl.setAttribute(\"role\", \"button\");\r\n            headerEl.setAttribute(\"tabindex\", \"0\");\r\n            headerEl.setAttribute(\"aria-expanded\", !config.collapsed);\r\n\r\n            const titleEl = global.L.DomUtil.create(\"span\", \"gl-legend__accordion-title\", headerEl);\r\n            titleEl.textContent = config.label;\r\n\r\n            const toggleEl = global.L.DomUtil.create(\"button\", \"gl-legend__accordion-toggle\", headerEl);\r\n            toggleEl.type = \"button\";\r\n            toggleEl.setAttribute(\"aria-label\", \"Basculer l'accord√©on\");\r\n            toggleEl.textContent = config.collapsed ? \"‚ñ∂\" : \"‚ñº\";\r\n\r\n            // Body de l'accord√©on\r\n            const bodyEl = global.L.DomUtil.create(\"div\", \"gl-legend__accordion-body\", accordionEl);\r\n\r\n            // Gestionnaire de clic sur le header\r\n            const onToggle = (ev) => {\r\n                // Ne rien faire si la couche est inactive\r\n                if (config.visible === false) {\r\n                    if (global.L && global.L.DomEvent) {\r\n                        global.L.DomEvent.stopPropagation(ev);\r\n                    }\r\n                    ev.preventDefault();\r\n                    return;\r\n                }\r\n\r\n                if (global.L && global.L.DomEvent) {\r\n                    global.L.DomEvent.stopPropagation(ev);\r\n                }\r\n                ev.preventDefault();\r\n\r\n                const isCollapsed = accordionEl.classList.toggle(\"gl-legend__accordion--collapsed\");\r\n                toggleEl.textContent = isCollapsed ? \"‚ñ∂\" : \"‚ñº\";\r\n                headerEl.setAttribute(\"aria-expanded\", !isCollapsed);\r\n\r\n                // Callback optionnel\r\n                if (typeof config.onToggle === \"function\") {\r\n                    config.onToggle(config.layerId, !isCollapsed);\r\n                }\r\n            };\r\n\r\n            this.attachEventHandler(headerEl, \"click\", onToggle);\r\n\r\n            return { accordionEl, headerEl, bodyEl, toggleEl };\r\n        },\r\n\r\n        /**\r\n         * Rend un symbole cercle (POI/Marker)\r\n         * @param {HTMLElement} container - Conteneur du symbole\r\n         * @param {Object} config - Configuration du symbole\r\n         * @returns {HTMLElement} - √âl√©ment cr√©√©\r\n         */\r\n        renderCircleSymbol(container, config) {\r\n            const circleEl = global.L.DomUtil.create(\"div\", \"gl-legend__circle\", container);\r\n\r\n            // Utiliser le radius transmis, sinon 24px par d√©faut (plus grand pour les l√©gendes avec ic√¥nes)\r\n            const radius = config.radius !== undefined ? config.radius : 24;\r\n            const size = radius * 2;\r\n            const fillColor = config.fillColor || config.color || \"#3388ff\";\r\n            const strokeColor = config.color || config.borderColor || \"rgba(0,0,0,0.2)\";\r\n            const strokeWidth = config.weight || 1;\r\n\r\n            circleEl.style.width = size + \"px\";\r\n            circleEl.style.height = size + \"px\";\r\n            circleEl.style.backgroundColor = fillColor;\r\n            circleEl.style.borderRadius = \"50%\";\r\n            circleEl.style.border = strokeWidth + \"px solid \" + strokeColor;\r\n            circleEl.style.position = \"relative\";\r\n            circleEl.style.display = \"flex\";\r\n            circleEl.style.alignItems = \"center\";\r\n            circleEl.style.justifyContent = \"center\";\r\n\r\n            if (config.fillOpacity !== undefined) {\r\n                circleEl.style.opacity = config.fillOpacity;\r\n            }\r\n\r\n            // Afficher l'ic√¥ne sprite SVG si pr√©sente\r\n            if (config.icon) {\r\n                // Validation de s√©curit√©: L'ID d'ic√¥ne doit √™tre alphanum√©rique avec tirets/underscores seulement\r\n                const iconId = config.icon.startsWith('#') ? config.icon.substring(1) : config.icon;\r\n                if (!/^[a-zA-Z0-9_-]+$/.test(iconId)) {\r\n                    if (Log) Log.error('[UIComponents] ID d\\'ic√¥ne invalide (caract√®res non autoris√©s):', config.icon);\r\n                    return circleEl;\r\n                }\r\n\r\n                const svg = document.createElementNS(\"http://www.w3.org/2000/svg\", \"svg\");\r\n                svg.setAttribute(\"viewBox\", \"0 0 24 24\");\r\n                // Rendre l'ic√¥ne √† 85% du cercle pour qu'elle soit bien visible\r\n                svg.style.width = (size * 0.85) + \"px\";\r\n                svg.style.height = (size * 0.85) + \"px\";\r\n                svg.style.fill = config.iconColor || \"currentColor\";\r\n                svg.style.stroke = config.iconColor || \"currentColor\";\r\n                svg.style.color = \"#ffffff\"; // D√©finir la couleur de base pour currentColor\r\n                svg.style.pointerEvents = \"none\";\r\n                svg.style.position = \"absolute\";\r\n\r\n                const use = document.createElementNS(\"http://www.w3.org/2000/svg\", \"use\");\r\n                // ID valid√©, construire le href s√©curis√©\r\n                const iconHref = '#' + iconId;\r\n                // Utiliser la syntaxe moderne href au lieu de xlink:href\r\n                use.setAttribute(\"href\", iconHref);\r\n                svg.appendChild(use);\r\n                circleEl.appendChild(svg);\r\n\r\n                // V√©rification d'erreur seulement si Log est disponible\r\n                if (Log) {\r\n                    const spriteExists = document.querySelector('svg[data-geoleaf-sprite=\"profile\"]');\r\n                    if (!spriteExists) {\r\n                        svg.setAttribute('data-sprite-missing', 'true');\r\n                        Log.warn('[UIComponents] Ic√¥ne', config.icon, 'r√©f√©renc√©e mais sprite non trouv√© dans le DOM');\r\n                    } else {\r\n                        const symbolId = config.icon.startsWith('#') ? config.icon.substring(1) : config.icon;\r\n                        const symbol = spriteExists.querySelector('#' + symbolId);\r\n                        if (!symbol) {\r\n                            svg.setAttribute('data-symbol-missing', config.icon);\r\n                            Log.warn('[UIComponents] Symbole', config.icon, 'non trouv√© dans le sprite SVG');\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n            return circleEl;\r\n        },\r\n\r\n        /**\r\n         * Rend un symbole ligne\r\n         * @param {HTMLElement} container - Conteneur du symbole\r\n         * @param {Object} config - Configuration du symbole\r\n         * @returns {HTMLElement} - √âl√©ment cr√©√©\r\n         */\r\n        renderLineSymbol(container, config) {\r\n            const width = config.width || 3;\r\n            const color = config.color || \"#3388ff\";\r\n            let style = config.style || \"solid\";\r\n            const dashArray = config.dashArray || null;\r\n            const outlineColor = config.outlineColor || null;\r\n            const outlineWidth = config.outlineWidth || null;\r\n\r\n            // Cr√©er un SVG pour les lignes complexes (dashArray custom, tirets √©pais, ou avec outline)\r\n            if (dashArray || width > 5 || (outlineColor && outlineWidth)) {\r\n                const svg = document.createElementNS(\"http://www.w3.org/2000/svg\", \"svg\");\r\n                svg.setAttribute(\"viewBox\", \"0 0 40 8\");\r\n                svg.style.width = \"40px\";\r\n                const totalHeight = Math.max(width, 3) + (outlineWidth || 0) + 4;\r\n                svg.style.height = totalHeight + \"px\";\r\n\r\n                // Si outline existe, dessiner d'abord la ligne de contour\r\n                if (outlineColor && outlineWidth) {\r\n                    const outlineLine = document.createElementNS(\"http://www.w3.org/2000/svg\", \"line\");\r\n                    outlineLine.setAttribute(\"x1\", \"0\");\r\n                    outlineLine.setAttribute(\"y1\", \"4\");\r\n                    outlineLine.setAttribute(\"x2\", \"40\");\r\n                    outlineLine.setAttribute(\"y2\", \"4\");\r\n                    outlineLine.setAttribute(\"stroke\", outlineColor);\r\n                    outlineLine.setAttribute(\"stroke-width\", width + (outlineWidth * 2));\r\n                    outlineLine.setAttribute(\"stroke-linecap\", \"round\");\r\n\r\n                    if (config.outlineOpacity !== undefined) {\r\n                        outlineLine.setAttribute(\"stroke-opacity\", config.outlineOpacity);\r\n                    }\r\n\r\n                    svg.appendChild(outlineLine);\r\n                }\r\n\r\n                // Dessiner ensuite la ligne principale\r\n                const line = document.createElementNS(\"http://www.w3.org/2000/svg\", \"line\");\r\n                line.setAttribute(\"x1\", \"0\");\r\n                line.setAttribute(\"y1\", \"4\");\r\n                line.setAttribute(\"x2\", \"40\");\r\n                line.setAttribute(\"y2\", \"4\");\r\n                line.setAttribute(\"stroke\", color);\r\n                line.setAttribute(\"stroke-width\", width);\r\n                line.setAttribute(\"stroke-linecap\", \"round\");\r\n\r\n                if (dashArray) {\r\n                    line.setAttribute(\"stroke-dasharray\", dashArray);\r\n                } else if (style === \"dashed\") {\r\n                    line.setAttribute(\"stroke-dasharray\", \"8,4\");\r\n                } else if (style === \"dotted\") {\r\n                    line.setAttribute(\"stroke-dasharray\", \"2,3\");\r\n                }\r\n\r\n                if (config.opacity !== undefined) {\r\n                    line.setAttribute(\"stroke-opacity\", config.opacity);\r\n                }\r\n\r\n                svg.appendChild(line);\r\n                container.appendChild(svg);\r\n                return svg;\r\n            }\r\n\r\n            // Fallback : DIV simple pour lignes basiques\r\n            const lineEl = global.L.DomUtil.create(\"div\", \"gl-legend__line\", container);\r\n            lineEl.style.width = \"30px\";\r\n            lineEl.style.height = width + \"px\";\r\n            lineEl.style.backgroundColor = color;\r\n\r\n            if (style === \"dashed\") {\r\n                lineEl.style.backgroundImage = `linear-gradient(to right, ${color} 50%, transparent 50%)`;\r\n                lineEl.style.backgroundSize = \"8px 100%\";\r\n            } else if (style === \"dotted\") {\r\n                lineEl.style.backgroundImage = `linear-gradient(to right, ${color} 30%, transparent 30%)`;\r\n                lineEl.style.backgroundSize = \"4px 100%\";\r\n            }\r\n\r\n            if (config.opacity !== undefined) {\r\n                lineEl.style.opacity = config.opacity;\r\n            }\r\n\r\n            return lineEl;\r\n        },\r\n\r\n        /**\r\n         * Rend un symbole polygone/remplissage\r\n         * @param {HTMLElement} container - Conteneur du symbole\r\n         * @param {Object} config - Configuration du symbole\r\n         * @returns {HTMLElement} - √âl√©ment cr√©√©\r\n         */\r\n        renderPolygonSymbol(container, config) {\r\n            const color = config.fillColor || config.color || \"#3388ff\";\r\n            const borderColor = config.borderColor || config.color || \"#333\";\r\n            const borderWidth = config.weight || 1;\r\n            const hasHatch = config.hatch && config.hatch.enabled;\r\n            // V√©rifier fillOpacity OU opacity (le generator peut utiliser l'un ou l'autre)\r\n            let fillOpacity = config.fillOpacity !== undefined ? config.fillOpacity :\r\n                               (config.opacity !== undefined ? config.opacity : 1);\r\n\r\n            // FIX: Si hatch avec renderMode=\"pattern_only\", forcer fillOpacity=1.0\r\n            // (m√™me logique que layer-manager.js ligne 823-828 - doit rester synchronis√©)\r\n            if (hasHatch && config.hatch.renderMode === 'pattern_only') {\r\n                fillOpacity = 1.0;\r\n            }\r\n\r\n            // Utiliser SVG si hachures pr√©sentes OU si fillOpacity = 0 (contour seul)\r\n            if (hasHatch || fillOpacity === 0) {\r\n                const svg = document.createElementNS(\"http://www.w3.org/2000/svg\", \"svg\");\r\n                svg.setAttribute(\"viewBox\", \"0 0 32 24\");\r\n                svg.style.width = \"32px\";\r\n                svg.style.height = \"24px\";\r\n\r\n                // Cr√©er le pattern de hachure SVG si n√©cessaire\r\n                if (hasHatch) {\r\n                    const hatchCfg = config.hatch;\r\n                    const type = hatchCfg.type || \"diagonal\";\r\n                    const spacing = hatchCfg.spacingPx || 10;\r\n                    const hatchColor = (hatchCfg.stroke && hatchCfg.stroke.color) || \"#000000\";\r\n                    const hatchOpacity = (hatchCfg.stroke && hatchCfg.stroke.opacity) !== undefined ? hatchCfg.stroke.opacity : 1;\r\n                    const hatchWidth = (hatchCfg.stroke && hatchCfg.stroke.widthPx) || 1;\r\n\r\n                    const patternId = \"hatch-legend-\" + Date.now() + \"-\" + Math.random().toString(36).substr(2, 9);\r\n                    const defs = document.createElementNS(\"http://www.w3.org/2000/svg\", \"defs\");\r\n                    const pattern = document.createElementNS(\"http://www.w3.org/2000/svg\", \"pattern\");\r\n\r\n                    pattern.setAttribute(\"id\", patternId);\r\n                    pattern.setAttribute(\"patternUnits\", \"userSpaceOnUse\");\r\n                    pattern.setAttribute(\"width\", spacing);\r\n                    pattern.setAttribute(\"height\", spacing);\r\n\r\n                    // Cr√©er le contenu selon le type\r\n                    if (type === \"diagonal\") {\r\n                        const line = document.createElementNS(\"http://www.w3.org/2000/svg\", \"line\");\r\n                        line.setAttribute(\"x1\", \"0\");\r\n                        line.setAttribute(\"y1\", \"0\");\r\n                        line.setAttribute(\"x2\", spacing);\r\n                        line.setAttribute(\"y2\", spacing);\r\n                        line.setAttribute(\"stroke\", hatchColor);\r\n                        line.setAttribute(\"stroke-width\", hatchWidth);\r\n                        line.setAttribute(\"stroke-opacity\", hatchOpacity);\r\n                        pattern.appendChild(line);\r\n                    } else if (type === \"dot\") {\r\n                        const circle = document.createElementNS(\"http://www.w3.org/2000/svg\", \"circle\");\r\n                        circle.setAttribute(\"cx\", spacing / 2);\r\n                        circle.setAttribute(\"cy\", spacing / 2);\r\n                        circle.setAttribute(\"r\", Math.max(0.3, spacing * 0.07));\r\n                        circle.setAttribute(\"fill\", hatchColor);\r\n                        circle.setAttribute(\"fill-opacity\", hatchOpacity);\r\n                        pattern.appendChild(circle);\r\n                    } else if (type === \"cross\") {\r\n                        const hLine = document.createElementNS(\"http://www.w3.org/2000/svg\", \"line\");\r\n                        hLine.setAttribute(\"x1\", \"0\");\r\n                        hLine.setAttribute(\"y1\", spacing / 2);\r\n                        hLine.setAttribute(\"x2\", spacing);\r\n                        hLine.setAttribute(\"y2\", spacing / 2);\r\n                        hLine.setAttribute(\"stroke\", hatchColor);\r\n                        hLine.setAttribute(\"stroke-width\", hatchWidth);\r\n                        hLine.setAttribute(\"stroke-opacity\", hatchOpacity);\r\n                        pattern.appendChild(hLine);\r\n\r\n                        const vLine = document.createElementNS(\"http://www.w3.org/2000/svg\", \"line\");\r\n                        vLine.setAttribute(\"x1\", spacing / 2);\r\n                        vLine.setAttribute(\"y1\", \"0\");\r\n                        vLine.setAttribute(\"x2\", spacing / 2);\r\n                        vLine.setAttribute(\"y2\", spacing);\r\n                        vLine.setAttribute(\"stroke\", hatchColor);\r\n                        vLine.setAttribute(\"stroke-width\", hatchWidth);\r\n                        vLine.setAttribute(\"stroke-opacity\", hatchOpacity);\r\n                        pattern.appendChild(vLine);\r\n                    } else if (type === \"x\") {\r\n                        const line1 = document.createElementNS(\"http://www.w3.org/2000/svg\", \"line\");\r\n                        line1.setAttribute(\"x1\", \"0\");\r\n                        line1.setAttribute(\"y1\", \"0\");\r\n                        line1.setAttribute(\"x2\", spacing);\r\n                        line1.setAttribute(\"y2\", spacing);\r\n                        line1.setAttribute(\"stroke\", hatchColor);\r\n                        line1.setAttribute(\"stroke-width\", hatchWidth);\r\n                        line1.setAttribute(\"stroke-opacity\", hatchOpacity);\r\n                        pattern.appendChild(line1);\r\n\r\n                        const line2 = document.createElementNS(\"http://www.w3.org/2000/svg\", \"line\");\r\n                        line2.setAttribute(\"x1\", spacing);\r\n                        line2.setAttribute(\"y1\", \"0\");\r\n                        line2.setAttribute(\"x2\", \"0\");\r\n                        line2.setAttribute(\"y2\", spacing);\r\n                        line2.setAttribute(\"stroke\", hatchColor);\r\n                        line2.setAttribute(\"stroke-width\", hatchWidth);\r\n                        line2.setAttribute(\"stroke-opacity\", hatchOpacity);\r\n                        pattern.appendChild(line2);\r\n                    }\r\n\r\n                    defs.appendChild(pattern);\r\n                    svg.appendChild(defs);\r\n\r\n                    // Rectangle avec hachure\r\n                    const rect = document.createElementNS(\"http://www.w3.org/2000/svg\", \"rect\");\r\n                    rect.setAttribute(\"x\", \"1\");\r\n                    rect.setAttribute(\"y\", \"1\");\r\n                    rect.setAttribute(\"width\", \"30\");\r\n                    rect.setAttribute(\"height\", \"22\");\r\n                    rect.setAttribute(\"fill\", `url(#${patternId})`);\r\n                    rect.setAttribute(\"stroke\", borderColor);\r\n                    rect.setAttribute(\"stroke-width\", borderWidth);\r\n                    if (fillOpacity !== 1) {\r\n                        rect.setAttribute(\"fill-opacity\", fillOpacity);\r\n                    }\r\n\r\n                    svg.appendChild(rect);\r\n                } else {\r\n                    // fillOpacity = 0 : rectangle transparent avec contour seulement\r\n                    const rect = document.createElementNS(\"http://www.w3.org/2000/svg\", \"rect\");\r\n                    rect.setAttribute(\"x\", \"1\");\r\n                    rect.setAttribute(\"y\", \"1\");\r\n                    rect.setAttribute(\"width\", \"30\");\r\n                    rect.setAttribute(\"height\", \"22\");\r\n                    rect.setAttribute(\"fill\", \"none\");\r\n                    rect.setAttribute(\"stroke\", borderColor);\r\n                    rect.setAttribute(\"stroke-width\", borderWidth);\r\n\r\n                    // Appliquer le dashArray si pr√©sent\r\n                    if (config.dashArray) {\r\n                        rect.setAttribute(\"stroke-dasharray\", config.dashArray);\r\n                    }\r\n\r\n                    svg.appendChild(rect);\r\n                }\r\n\r\n                container.appendChild(svg);\r\n                return svg;\r\n            }\r\n\r\n            // Fallback : DIV simple avec remplissage\r\n            const polygonEl = global.L.DomUtil.create(\"div\", \"gl-legend__polygon\", container);\r\n            polygonEl.style.width = \"24px\";\r\n            polygonEl.style.height = \"16px\";\r\n            polygonEl.style.backgroundColor = color;\r\n            polygonEl.style.border = borderWidth + \"px solid \" + borderColor;\r\n\r\n            if (fillOpacity !== 1) {\r\n                polygonEl.style.opacity = fillOpacity;\r\n            }\r\n\r\n            return polygonEl;\r\n        },\r\n\r\n        /**\r\n         * Rend un symbole √©toile (rating)\r\n         * @param {HTMLElement} container - Conteneur du symbole\r\n         * @param {Object} config - Configuration du symbole\r\n         * @returns {HTMLElement} - √âl√©ment cr√©√©\r\n         */\r\n        renderStarSymbol(container, config) {\r\n            const starContainer = global.L.DomUtil.create(\"div\", \"gl-legend__stars\", container);\r\n\r\n            const count = config.count || 5;\r\n            const color = config.color || \"#f1c40f\";\r\n            const size = config.size || 12;\r\n\r\n            for (let i = 0; i < count; i++) {\r\n                const starEl = global.L.DomUtil.create(\"span\", \"gl-legend__star\", starContainer);\r\n                starEl.textContent = \"‚òÖ\";\r\n                starEl.style.color = color;\r\n                starEl.style.fontSize = size + \"px\";\r\n            }\r\n\r\n            return starContainer;\r\n        },\r\n\r\n        /**\r\n         * Rend un symbole selon son type\r\n         * @param {HTMLElement} container - Conteneur du symbole\r\n         * @param {Object} config - Configuration du symbole\r\n         * @returns {HTMLElement} - √âl√©ment cr√©√©\r\n         */\r\n        renderSymbol(container, config) {\r\n            // Support de la structure avec config.symbol ou directement config\r\n            const symbolConfig = config.symbol || config;\r\n            const symbolType = symbolConfig.type || config.type || \"circle\";\r\n\r\n            switch (symbolType) {\r\n                case \"marker\":\r\n                case \"circle\":\r\n                    return this.renderCircleSymbol(container, symbolConfig);\r\n\r\n                case \"line\":\r\n                    return this.renderLineSymbol(container, symbolConfig);\r\n\r\n                case \"polygon\":\r\n                case \"fill\":\r\n                    return this.renderPolygonSymbol(container, symbolConfig);\r\n\r\n                case \"star\":\r\n                    return this.renderStarSymbol(container, symbolConfig);\r\n\r\n                case \"icon\":\r\n                    // Icon avec URL d'image\r\n                    if (symbolConfig.iconUrl) {\r\n                        const imgEl = global.L.DomUtil.create(\"img\", \"gl-legend__icon-img\", container);\r\n                        imgEl.src = symbolConfig.iconUrl;\r\n                        if (symbolConfig.size) {\r\n                            imgEl.style.width = symbolConfig.size + \"px\";\r\n                            imgEl.style.height = symbolConfig.size + \"px\";\r\n                        }\r\n                        return imgEl;\r\n                    }\r\n                    // Icon avec sprite SVG - utiliser renderCircleSymbol qui g√®re d√©j√† les sprites\r\n                    if (symbolConfig.icon) {\r\n                        return this.renderCircleSymbol(container, symbolConfig);\r\n                    }\r\n                    // Fallback vers circle\r\n                    return this.renderCircleSymbol(container, symbolConfig);\r\n\r\n                default:\r\n                    return this.renderCircleSymbol(container, symbolConfig);\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Cr√©e un bouton toggle (checkbox/switch)\r\n         * @param {HTMLElement} container - Conteneur parent\r\n         * @param {Object} config - Configuration du toggle\r\n         * @param {string} [config.id] - ID du toggle\r\n         * @param {boolean} config.isActive - √âtat initial (alias: active)\r\n         * @param {string} [config.className] - Classe CSS personnalis√©e\r\n         * @param {string} [config.label] - Label du toggle\r\n         * @param {string} [config.title] - Tooltip\r\n         * @param {Function} [config.onToggle] - Callback lors du toggle\r\n         * @returns {HTMLElement} - √âl√©ment bouton cr√©√©\r\n         */\r\n        createToggleButton(container, config) {\r\n            // Support isActive ou active\r\n            const isActive = config.isActive !== undefined ? config.isActive : config.active;\r\n            const className = config.className || \"gl-toggle-btn\";\r\n\r\n            const toggleBtn = global.L.DomUtil.create(\r\n                \"button\",\r\n                className,\r\n                container\r\n            );\r\n            toggleBtn.type = \"button\";\r\n\r\n            if (config.id) {\r\n                toggleBtn.setAttribute(\"data-toggle-id\", config.id);\r\n            }\r\n\r\n            toggleBtn.setAttribute(\"aria-pressed\", isActive ? \"true\" : \"false\");\r\n\r\n            if (config.title) {\r\n                toggleBtn.title = config.title;\r\n            }\r\n\r\n            if (isActive) {\r\n                toggleBtn.classList.add(className + \"--on\");\r\n            }\r\n\r\n            if (config.label) {\r\n                toggleBtn.textContent = config.label;\r\n            }\r\n\r\n            // Attacher le gestionnaire\r\n            if (typeof config.onToggle === \"function\") {\r\n                const className = config.className || \"gl-toggle-btn\";\r\n                const onToggle = (ev) => {\r\n                    if (global.L && global.L.DomEvent) {\r\n                        global.L.DomEvent.stopPropagation(ev);\r\n                    }\r\n                    ev.preventDefault();\r\n\r\n                    const isActive = toggleBtn.classList.toggle(className + \"--on\");\r\n                    toggleBtn.setAttribute(\"aria-pressed\", isActive ? \"true\" : \"false\");\r\n\r\n                    config.onToggle(config.id, isActive, ev);\r\n                };\r\n\r\n                this.attachEventHandler(toggleBtn, \"click\", onToggle);\r\n            }\r\n\r\n            return toggleBtn;\r\n        },\r\n\r\n        /**\r\n         * Attache un gestionnaire d'√©v√©nements compatible Leaflet\r\n         * @param {HTMLElement} element - √âl√©ment cible\r\n         * @param {string} eventName - Nom de l'√©v√©nement\r\n         * @param {Function} handler - Gestionnaire\r\n         */\r\n        attachEventHandler(element, eventName, handler) {\r\n            if (global.L && global.L.DomEvent) {\r\n                global.L.DomEvent.on(element, eventName, handler);\r\n                if (eventName === \"click\") {\r\n                    global.L.DomEvent.disableClickPropagation(element);\r\n                }\r\n            } else {\r\n                element.addEventListener(eventName, handler);\r\n            }\r\n        }\r\n    };\r\n\r\n    // Exposer dans l'espace de noms interne\r\n    GeoLeaf._UIComponents = _UIComponents;\r\n\r\n    if (Log) Log.info(\"[GeoLeaf._UIComponents] Module commun UI charg√©\");\r\n\r\n})(window);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n/**\r\n * GeoLeaf Notification System\r\n * Gestion des notifications toast et overlays\r\n * @module ui/notifications\r\n * @version 4.4.1\r\n * @updated 2026-01-23 - Standardisation API, queue prioritaire, int√©gration Telemetry\r\n */\r\n\r\n(function (window) {\r\n    \"use strict\";\r\n\r\n    // Namespace global GeoLeaf\r\n    const GeoLeaf = window.GeoLeaf || (window.GeoLeaf = {});\r\n\r\n    // Helper pour utiliser createElement unifi√©\r\n    const $create = (tag, props, ...children) => {\r\n        return GeoLeaf.Utils && GeoLeaf.Utils.createElement\r\n            ? GeoLeaf.Utils.createElement(tag, props, ...children)\r\n            : document.createElement(tag);\r\n    };\r\n\r\n    // Constantes pour les priorit√©s de la queue\r\n    const PRIORITY = {\r\n        ERROR: 3,\r\n        WARNING: 2,\r\n        SUCCESS: 1,\r\n        INFO: 1\r\n    };\r\n\r\nclass NotificationSystem {\r\n    constructor() {\r\n        this.container = null;\r\n        this.maxVisible = 3;              // Max toasts temporaires visibles\r\n        this.maxPersistent = 2;           // Max toasts persistants visibles\r\n        this.durations = {\r\n            success: 3000,\r\n            error: 5000,\r\n            warning: 4000,\r\n            info: 3000\r\n        };\r\n        this.config = {\r\n            enabled: true,\r\n            position: 'bottom-center',\r\n            animations: true\r\n        };\r\n\r\n        // Managers pour cleanup\r\n        this._eventManager = null;\r\n        this._timerManager = null;\r\n        this._activeToasts = new Map();\r\n\r\n        // Queue avec priorit√©s (limite: 15 max en attente)\r\n        this._queue = [];\r\n        this._maxQueueSize = 15;\r\n\r\n        // Buffer pour m√©triques Telemetry (avant chargement du module)\r\n        this._metricsBuffer = [];\r\n        this._metricsBufferTimeout = null;\r\n        this._telemetryAvailable = false;\r\n    }\r\n\r\n    /**\r\n     * Initialise le syst√®me de notifications\r\n     * @param {Object} config - Configuration\r\n     * @param {string} config.container - S√©lecteur du container\r\n     * @param {number} config.maxVisible - Nombre max de toasts visibles\r\n     * @param {Object} config.durations - Dur√©es par type\r\n     * @param {string} config.position - Position ('bottom-center', 'top-right', etc.)\r\n     * @param {boolean} config.animations - Activer les animations\r\n     */\r\n    init(config = {}) {\r\n        // Fusionner la config\r\n        this.config = { ...this.config, ...config };\r\n        this.maxVisible = config.maxVisible || 3;\r\n        this.durations = { ...this.durations, ...config.durations };\r\n\r\n        // R√©cup√©rer le container\r\n        this.container = document.querySelector(config.container || '#gl-notifications');\r\n\r\n        if (!this.container) {\r\n            const Log = GeoLeaf.Log;\r\n            if (Log) Log.warn('[GeoLeaf Notifications] Container introuvable:', config.container);\r\n            return false;\r\n        }\r\n\r\n        // Appliquer la classe de position\r\n        if (config.position) {\r\n            this.container.className = `gl-notifications gl-notifications--${config.position}`;\r\n        }\r\n\r\n        const Log = GeoLeaf.Log;\r\n        if (Log) Log.debug('[GeoLeaf Notifications] Syst√®me initialis√©');\r\n\r\n        // Initialiser les managers pour le cleanup\r\n        if (GeoLeaf.Utils) {\r\n            this._eventManager = GeoLeaf.Utils.events ? GeoLeaf.Utils.events.createManager('notifications') : null;\r\n            this._timerManager = GeoLeaf.Utils.timers ? GeoLeaf.Utils.timers.createManager('notifications') : null;\r\n        }\r\n\r\n        // D√©marrer le timer de 30s pour vider le buffer de m√©triques\r\n        this._startMetricsBufferTimeout();\r\n\r\n        // Flush imm√©diat si Telemetry est d√©j√† disponible\r\n        this._flushMetricsBuffer();\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Affiche une notification g√©n√©rique (m√©thode publique standardis√©e)\r\n     * Support double signature:\r\n     * - show(message, type, duration) : Appel positionnel classique\r\n     * - show(message, options) : Appel avec objet options\r\n     *\r\n     * @param {string} message - Message √† afficher\r\n     * @param {string|Object} typeOrOptions - Type ('success', 'error', 'warning', 'info') OU objet options\r\n     * @param {number} [duration] - Dur√©e personnalis√©e (ms) - ignor√© si typeOrOptions est un objet\r\n     *\r\n     * @example\r\n     * // Appel positionnel\r\n     * show(\"Message\", \"success\", 3000);\r\n     *\r\n     * @example\r\n     * // Appel avec options\r\n     * show(\"Message\", {\r\n     *   type: \"success\",\r\n     *   duration: 3000,\r\n     *   persistent: false,      // Toast persistant (ne s'auto-dismiss pas)\r\n     *   dismissible: true,      // Bouton de fermeture\r\n     *   icon: \"‚úì\",             // Ic√¥ne personnalis√©e (futur)\r\n     *   action: {               // Action button (futur)\r\n     *     label: \"Annuler\",\r\n     *     callback: () => {}\r\n     *   }\r\n     * });\r\n     */\r\n    show(message, typeOrOptions = 'info', duration) {\r\n        // Parser les arguments selon la signature\r\n        let options = {};\r\n\r\n        if (typeof typeOrOptions === 'string') {\r\n            // Signature positionnelle: show(message, type, duration)\r\n            options = {\r\n                type: typeOrOptions,\r\n                duration: duration\r\n            };\r\n        } else if (typeof typeOrOptions === 'object' && typeOrOptions !== null) {\r\n            // Signature objet: show(message, options)\r\n            options = typeOrOptions;\r\n        } else {\r\n            // Fallback par d√©faut\r\n            options = { type: 'info' };\r\n        }\r\n\r\n        // Ajouter √† la queue avec priorit√©\r\n        return this._enqueue(message, options);\r\n    }\r\n\r\n    /**\r\n     * Affiche une notification de succ√®s\r\n     * Support double signature:\r\n     * - success(message, duration)\r\n     * - success(message, options)\r\n     *\r\n     * @param {string} message - Message √† afficher\r\n     * @param {number|Object} [durationOrOptions] - Dur√©e (ms) OU objet options\r\n     *\r\n     * @example\r\n     * success(\"Sauvegarde r√©ussie\", 3000);\r\n     * success(\"Sauvegarde r√©ussie\", { duration: 3000, persistent: false });\r\n     */\r\n    success(message, durationOrOptions) {\r\n        if (typeof durationOrOptions === 'number') {\r\n            return this.show(message, 'success', durationOrOptions);\r\n        } else if (typeof durationOrOptions === 'object') {\r\n            return this.show(message, { ...durationOrOptions, type: 'success' });\r\n        } else {\r\n            return this.show(message, 'success');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Affiche une notification d'erreur\r\n     * Support double signature:\r\n     * - error(message, duration)\r\n     * - error(message, options)\r\n     *\r\n     * @param {string} message - Message √† afficher\r\n     * @param {number|Object} [durationOrOptions] - Dur√©e (ms) OU objet options\r\n     *\r\n     * @example\r\n     * error(\"Erreur r√©seau\", 5000);\r\n     * error(\"Erreur r√©seau\", { duration: 5000, persistent: true });\r\n     */\r\n    error(message, durationOrOptions) {\r\n        if (typeof durationOrOptions === 'number') {\r\n            return this.show(message, 'error', durationOrOptions);\r\n        } else if (typeof durationOrOptions === 'object') {\r\n            return this.show(message, { ...durationOrOptions, type: 'error' });\r\n        } else {\r\n            return this.show(message, 'error');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Affiche une notification d'avertissement\r\n     * Support double signature:\r\n     * - warning(message, duration)\r\n     * - warning(message, options)\r\n     *\r\n     * @param {string} message - Message √† afficher\r\n     * @param {number|Object} [durationOrOptions] - Dur√©e (ms) OU objet options\r\n     *\r\n     * @example\r\n     * warning(\"Connexion instable\", 4000);\r\n     * warning(\"Connexion instable\", { duration: 4000 });\r\n     */\r\n    warning(message, durationOrOptions) {\r\n        if (typeof durationOrOptions === 'number') {\r\n            return this.show(message, 'warning', durationOrOptions);\r\n        } else if (typeof durationOrOptions === 'object') {\r\n            return this.show(message, { ...durationOrOptions, type: 'warning' });\r\n        } else {\r\n            return this.show(message, 'warning');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Affiche une notification d'information\r\n     * Support double signature:\r\n     * - info(message, duration)\r\n     * - info(message, options)\r\n     *\r\n     * @param {string} message - Message √† afficher\r\n     * @param {number|Object} [durationOrOptions] - Dur√©e (ms) OU objet options\r\n     *\r\n     * @example\r\n     * info(\"Synchronisation en cours\", 3000);\r\n     * info(\"Synchronisation en cours\", { persistent: true, dismissible: false });\r\n     */\r\n    info(message, durationOrOptions) {\r\n        if (typeof durationOrOptions === 'number') {\r\n            return this.show(message, 'info', durationOrOptions);\r\n        } else if (typeof durationOrOptions === 'object') {\r\n            return this.show(message, { ...durationOrOptions, type: 'info' });\r\n        } else {\r\n            return this.show(message, 'info');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Ajoute une notification √† la queue avec priorit√©\r\n     * @private\r\n     * @param {string} message - Message\r\n     * @param {Object} options - Options de la notification\r\n     */\r\n    _enqueue(message, options) {\r\n        const type = options.type || 'info';\r\n        const priority = PRIORITY[type.toUpperCase()] || PRIORITY.INFO;\r\n\r\n        const item = {\r\n            message,\r\n            options: {\r\n                type,\r\n                duration: options.duration,\r\n                persistent: options.persistent || false,\r\n                dismissible: options.dismissible !== false, // true par d√©faut\r\n                icon: options.icon,\r\n                action: options.action\r\n            },\r\n            priority,\r\n            timestamp: Date.now()\r\n        };\r\n\r\n        // V√©rifier la limite de la queue\r\n        if (this._queue.length >= this._maxQueueSize) {\r\n            // Trouver l'√©l√©ment de plus faible priorit√© (et plus ancien si √©galit√©)\r\n            const lowestPriorityIndex = this._queue.reduce((minIdx, item, idx, arr) => {\r\n                const minItem = arr[minIdx];\r\n                if (item.priority < minItem.priority ||\r\n                    (item.priority === minItem.priority && item.timestamp < minItem.timestamp)) {\r\n                    return idx;\r\n                }\r\n                return minIdx;\r\n            }, 0);\r\n\r\n            // Si le nouvel item est plus prioritaire que le moins prioritaire dans la queue\r\n            if (item.priority > this._queue[lowestPriorityIndex].priority) {\r\n                // Supprimer le moins prioritaire\r\n                this._queue.splice(lowestPriorityIndex, 1);\r\n                // Tracker la m√©trique\r\n                this._recordMetric('notification.dropped', 1);\r\n\r\n                const Log = GeoLeaf.Log;\r\n                if (Log) Log.warn('[GeoLeaf Notifications] Queue pleine, notification dropp√©e');\r\n            } else {\r\n                // Dropper le nouveau item\r\n                this._recordMetric('notification.dropped', 1);\r\n                const Log = GeoLeaf.Log;\r\n                if (Log) Log.warn('[GeoLeaf Notifications] Queue pleine, notification rejet√©e');\r\n                return;\r\n            }\r\n        }\r\n\r\n        // Ajouter √† la queue\r\n        this._queue.push(item);\r\n        this._recordMetric('notification.queued', 1);\r\n\r\n        // Trier la queue par priorit√© (desc) puis timestamp (asc)\r\n        this._queue.sort((a, b) => {\r\n            if (b.priority !== a.priority) {\r\n                return b.priority - a.priority; // Priorit√© d√©croissante\r\n            }\r\n            return a.timestamp - b.timestamp; // Timestamp croissant (FIFO pour m√™me priorit√©)\r\n        });\r\n\r\n        // Traiter la queue\r\n        return this._processQueue();\r\n    }\r\n\r\n    /**\r\n     * Traite la queue et affiche les notifications selon disponibilit√©\r\n     * @private\r\n     */\r\n    _processQueue() {\r\n        if (!this.container || !this.config.enabled || this._queue.length === 0) {\r\n            return null;\r\n        }\r\n\r\n        // Compter les toasts actuellement visibles\r\n        const visibleToasts = this.container.querySelectorAll('.gl-toast:not(.gl-toast--removing)');\r\n        const temporaryToasts = Array.from(visibleToasts).filter(t => !t.dataset.persistent);\r\n        const persistentToasts = Array.from(visibleToasts).filter(t => t.dataset.persistent);\r\n\r\n        // Tant qu'il y a de la place et des items dans la queue\r\n        let lastToast = null;\r\n        while (this._queue.length > 0) {\r\n            const nextItem = this._queue[0];\r\n            const isPersistent = nextItem.options.persistent;\r\n\r\n            // V√©rifier si on peut afficher ce toast\r\n            const canShow = isPersistent\r\n                ? persistentToasts.length < this.maxPersistent\r\n                : temporaryToasts.length < this.maxVisible;\r\n\r\n            if (!canShow) {\r\n                // Si c'est un toast prioritaire (error), retirer un toast existant moins prioritaire\r\n                if (nextItem.priority === PRIORITY.ERROR && temporaryToasts.length > 0) {\r\n                    // Trouver un toast info ou success √† retirer\r\n                    const toastToRemove = temporaryToasts.find(t =>\r\n                        t.classList.contains('gl-toast--info') ||\r\n                        t.classList.contains('gl-toast--success')\r\n                    ) || temporaryToasts[0];\r\n\r\n                    this._remove(toastToRemove, true); // true = reorganization\r\n                    // Continuer pour afficher le toast prioritaire\r\n                } else {\r\n                    // Pas de place, arr√™ter le traitement\r\n                    break;\r\n                }\r\n            }\r\n\r\n            // Retirer de la queue et afficher\r\n            const item = this._queue.shift();\r\n            lastToast = this._showImmediate(item.message, item.options);\r\n\r\n            // Mettre √† jour les compteurs\r\n            if (isPersistent) {\r\n                persistentToasts.push(null); // Placeholder\r\n            } else {\r\n                temporaryToasts.push(null); // Placeholder\r\n            }\r\n        }\r\n\r\n        return lastToast;\r\n    }\r\n\r\n    /**\r\n     * Affiche une notification imm√©diatement (utilis√©e par la queue)\r\n     * @private\r\n     * @param {string} message - Message √† afficher\r\n     * @param {Object} options - Options de la notification\r\n     */\r\n    _showImmediate(message, options) {\r\n        const type = options.type || 'info';\r\n        const duration = options.duration || this.durations[type];\r\n        const persistent = options.persistent || false;\r\n        const dismissible = options.dismissible !== false;\r\n\r\n        // Cr√©er le toast\r\n        const toast = $create('div', {\r\n            className: `gl-toast gl-toast--${type}`,\r\n            attributes: {\r\n                'role': 'alert',\r\n                // Utiliser assertive pour errors et toasts prioritaires\r\n                'aria-live': (type === 'error' || options.priority === PRIORITY.ERROR) ? 'assertive' : 'polite'\r\n            }\r\n        });\r\n\r\n        // Marquer si persistant\r\n        if (persistent) {\r\n            toast.dataset.persistent = 'true';\r\n        }\r\n\r\n        // Cr√©er le message (textContent = s√©curis√©)\r\n        const messageSpan = $create('span', {\r\n            className: 'gl-toast__message',\r\n            textContent: message\r\n        });\r\n        toast.appendChild(messageSpan);\r\n\r\n        // Cr√©er le bouton de fermeture (si dismissible)\r\n        if (dismissible) {\r\n            const closeBtn = $create('button', {\r\n                className: 'gl-toast__close',\r\n                attributes: {\r\n                    'aria-label': 'Fermer la notification',\r\n                    'title': 'Fermer'\r\n                },\r\n                textContent: '√ó',\r\n                onClick: () => {\r\n                    this._recordMetric('notification.dismissed.manual', 1);\r\n                    this._remove(toast, false);\r\n                }\r\n            });\r\n            toast.appendChild(closeBtn);\r\n        }\r\n\r\n        // Ajouter au DOM\r\n        this.container.appendChild(toast);\r\n\r\n        // Tracker m√©trique\r\n        this._recordMetric(`notification.shown.${type}`, 1);\r\n\r\n        // Animation d'entr√©e\r\n        if (this.config.animations) {\r\n            requestAnimationFrame(() => {\r\n                requestAnimationFrame(() => {\r\n                    toast.classList.add('gl-toast--visible');\r\n                });\r\n            });\r\n        } else {\r\n            toast.classList.add('gl-toast--visible');\r\n        }\r\n\r\n        // Planifier l'auto-suppression (seulement si non persistant)\r\n        if (!persistent) {\r\n            const autoRemove = setTimeout(() => {\r\n                this._recordMetric('notification.dismissed.auto', 1);\r\n                this._remove(toast, false);\r\n            }, duration);\r\n\r\n            if (this._timerManager) {\r\n                toast.dataset.timerId = this._timerManager.setTimeout(() => {\r\n                    this._recordMetric('notification.dismissed.auto', 1);\r\n                    this._remove(toast, false);\r\n                }, duration);\r\n            } else {\r\n                toast.dataset.timeoutId = autoRemove;\r\n            }\r\n        }\r\n\r\n        return toast;\r\n    }\r\n\r\n    /**\r\n     * Retire une notification\r\n     * @private\r\n     * @param {HTMLElement} toast - √âl√©ment toast √† retirer\r\n     * @param {boolean} isReorganization - Si true, c'est une r√©organisation (animation diff√©rente)\r\n     */\r\n    _remove(toast, isReorganization = false) {\r\n        if (!toast || toast.classList.contains('gl-toast--removing')) {\r\n            return;\r\n        }\r\n\r\n        // Annuler le timeout auto si fermeture manuelle\r\n        if (toast.dataset.timeoutId) {\r\n            clearTimeout(parseInt(toast.dataset.timeoutId));\r\n            delete toast.dataset.timeoutId;\r\n        }\r\n        if (toast.dataset.timerId && this._timerManager) {\r\n            this._timerManager.clearTimeout(toast.dataset.timerId);\r\n            delete toast.dataset.timerId;\r\n        }\r\n\r\n        // Animation de sortie\r\n        toast.classList.add('gl-toast--removing');\r\n        toast.classList.remove('gl-toast--visible');\r\n\r\n        // Appliquer animation sp√©cifique pour r√©organisation\r\n        if (isReorganization && this.config.animations) {\r\n            toast.classList.add('gl-toast--sliding-up');\r\n        }\r\n\r\n        const removeDelay = this.config.animations ? 200 : 0;\r\n        const removeTimer = setTimeout(() => {\r\n            if (toast.parentNode) {\r\n                toast.remove();\r\n            }\r\n            // Traiter la queue apr√®s suppression\r\n            this._processQueue();\r\n        }, removeDelay);\r\n\r\n        if (this._timerManager) {\r\n            this._timerManager.setTimeout(() => {\r\n                if (toast.parentNode) {\r\n                    toast.remove();\r\n                }\r\n                this._processQueue();\r\n            }, removeDelay);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Efface toutes les notifications\r\n     */\r\n    clearAll() {\r\n        if (!this.container) return;\r\n\r\n        const toasts = this.container.querySelectorAll('.gl-toast');\r\n        toasts.forEach(toast => this._remove(toast, false));\r\n\r\n        // Vider aussi la queue\r\n        this._queue = [];\r\n    }\r\n\r\n    /**\r\n     * Ferme une notification sp√©cifique par sa r√©f√©rence DOM\r\n     * @param {HTMLElement} toastEl - √âl√©ment toast retourn√© par show/info/success/etc.\r\n     */\r\n    dismiss(toastEl) {\r\n        if (!toastEl) return;\r\n        this._remove(toastEl, false);\r\n    }\r\n\r\n    /**\r\n     * D√©sactive temporairement les notifications\r\n     */\r\n    disable() {\r\n        this.config.enabled = false;\r\n        const Log = GeoLeaf.Log;\r\n        if (Log) Log.debug('[GeoLeaf Notifications] Syst√®me d√©sactiv√©');\r\n    }\r\n\r\n    /**\r\n     * R√©active les notifications\r\n     */\r\n    enable() {\r\n        this.config.enabled = true;\r\n        const Log = GeoLeaf.Log;\r\n        if (Log) Log.debug('[GeoLeaf Notifications] Syst√®me activ√©');\r\n        // Traiter la queue au cas o√π des items sont en attente\r\n        this._processQueue();\r\n    }\r\n\r\n    /**\r\n     * Enregistre une m√©trique Telemetry (avec buffer si module pas encore charg√©)\r\n     * @private\r\n     * @param {string} name - Nom de la m√©trique\r\n     * @param {number} value - Valeur\r\n     */\r\n    _recordMetric(name, value = 1) {\r\n        // V√©rifier si Telemetry est disponible\r\n        if (GeoLeaf.Storage && GeoLeaf.Storage.Telemetry && typeof GeoLeaf.Storage.Telemetry.recordMetric === 'function') {\r\n            // Telemetry disponible, enregistrer directement\r\n            try {\r\n                GeoLeaf.Storage.Telemetry.recordMetric(name, value);\r\n                this._telemetryAvailable = true;\r\n            } catch (error) {\r\n                const Log = GeoLeaf.Log;\r\n                if (Log) Log.warn('[GeoLeaf Notifications] Erreur enregistrement m√©trique:', error);\r\n            }\r\n        } else {\r\n            // Telemetry pas encore disponible, ajouter au buffer\r\n            this._metricsBuffer.push({ name, value, timestamp: Date.now() });\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Vide le buffer de m√©triques vers Telemetry\r\n     * @private\r\n     */\r\n    _flushMetricsBuffer() {\r\n        if (this._metricsBuffer.length === 0) {\r\n            return;\r\n        }\r\n\r\n        // V√©rifier si Telemetry est maintenant disponible\r\n        if (GeoLeaf.Storage && GeoLeaf.Storage.Telemetry && typeof GeoLeaf.Storage.Telemetry.recordMetric === 'function') {\r\n            const Log = GeoLeaf.Log;\r\n            if (Log) Log.debug(`[GeoLeaf Notifications] Flush de ${this._metricsBuffer.length} m√©triques vers Telemetry`);\r\n\r\n            // Enregistrer toutes les m√©triques du buffer\r\n            this._metricsBuffer.forEach(metric => {\r\n                try {\r\n                    GeoLeaf.Storage.Telemetry.recordMetric(metric.name, metric.value);\r\n                } catch (error) {\r\n                    if (Log) Log.warn('[GeoLeaf Notifications] Erreur flush m√©trique:', error);\r\n                }\r\n            });\r\n\r\n            // Vider le buffer\r\n            this._metricsBuffer = [];\r\n            this._telemetryAvailable = true;\r\n\r\n            // Annuler le timeout si actif\r\n            if (this._metricsBufferTimeout) {\r\n                clearTimeout(this._metricsBufferTimeout);\r\n                this._metricsBufferTimeout = null;\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * D√©marre le timeout de 30s pour vider le buffer (√©viter fuite m√©moire)\r\n     * @private\r\n     */\r\n    _startMetricsBufferTimeout() {\r\n        // Timeout de 30s pour vider le buffer m√™me si Telemetry ne charge pas\r\n        this._metricsBufferTimeout = setTimeout(() => {\r\n            if (this._metricsBuffer.length > 0) {\r\n                const Log = GeoLeaf.Log;\r\n                if (Log) Log.warn(`[GeoLeaf Notifications] Timeout buffer m√©triques (30s), ${this._metricsBuffer.length} m√©triques abandonn√©es`);\r\n                this._metricsBuffer = [];\r\n            }\r\n            this._metricsBufferTimeout = null;\r\n        }, 30000); // 30 secondes\r\n    }\r\n\r\n    /**\r\n     * √âchappe le HTML pour √©viter les injections XSS\r\n     * @private\r\n     * @param {string} text - Texte √† √©chapper\r\n     * @returns {string} Texte √©chapp√©\r\n     * @deprecated Utilisez textContent au lieu de innerHTML\r\n     */\r\n    _escapeHtml(text) {\r\n        if (GeoLeaf.Security && typeof GeoLeaf.Security.escapeHtml === 'function') {\r\n            return GeoLeaf.Security.escapeHtml(text);\r\n        }\r\n        // Fallback s√©curis√© si Security n'est pas charg√©\r\n        if (text == null) return '';\r\n        return String(text).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;');\r\n    }\r\n\r\n    /**\r\n     * D√©truit le syst√®me de notifications et nettoie toutes les ressources\r\n     * Retire tous les event listeners et timers actifs\r\n     */\r\n    destroy() {\r\n        const Log = GeoLeaf.Log;\r\n\r\n        // Clear tous les timers actifs\r\n        if (this._timerManager) {\r\n            this._timerManager.destroy();\r\n            this._timerManager = null;\r\n        }\r\n\r\n        // Retire tous les event listeners\r\n        if (this._eventManager) {\r\n            this._eventManager.destroy();\r\n            this._eventManager = null;\r\n        }\r\n\r\n        // Clear le timeout du buffer\r\n        if (this._metricsBufferTimeout) {\r\n            clearTimeout(this._metricsBufferTimeout);\r\n            this._metricsBufferTimeout = null;\r\n        }\r\n\r\n        // Vider le buffer de m√©triques (une derni√®re tentative)\r\n        if (this._metricsBuffer.length > 0) {\r\n            this._flushMetricsBuffer();\r\n            // Si toujours pas vid√©, abandonner\r\n            this._metricsBuffer = [];\r\n        }\r\n\r\n        // Retire tous les toasts actifs\r\n        if (this.container) {\r\n            const toasts = this.container.querySelectorAll('.gl-toast');\r\n            toasts.forEach(toast => toast.remove());\r\n        }\r\n\r\n        // Clear la queue\r\n        this._queue = [];\r\n\r\n        // Clear la map\r\n        this._activeToasts.clear();\r\n\r\n        // Reset les propri√©t√©s\r\n        this.container = null;\r\n        this.config.enabled = false;\r\n\r\n        if (Log) Log.info('[GeoLeaf Notifications] Syst√®me d√©truit et nettoy√©');\r\n    }\r\n\r\n    /**\r\n     * Get current status of notification system\r\n     * @returns {Object} Status information\r\n     */\r\n    getStatus() {\r\n        const visibleToasts = this.container ? this.container.querySelectorAll('.gl-toast:not(.gl-toast--removing)') : [];\r\n        const temporaryToasts = Array.from(visibleToasts).filter(t => !t.dataset.persistent);\r\n        const persistentToasts = Array.from(visibleToasts).filter(t => t.dataset.persistent);\r\n\r\n        return {\r\n            enabled: this.config.enabled,\r\n            initialized: !!this.container,\r\n            activeToasts: visibleToasts.length,\r\n            temporaryToasts: temporaryToasts.length,\r\n            persistentToasts: persistentToasts.length,\r\n            queued: this._queue.length,\r\n            maxVisible: this.maxVisible,\r\n            maxPersistent: this.maxPersistent,\r\n            position: this.config.position,\r\n            telemetryAvailable: this._telemetryAvailable,\r\n            metricsBuffered: this._metricsBuffer.length\r\n        };\r\n    }\r\n}\r\n\r\n// Cr√©er une instance singleton et l'exposer\r\nGeoLeaf._UINotifications = new NotificationSystem();\r\n\r\n})(window);\r\n","/**\r\n * GeoLeaf UI Module - Event Delegation\r\n * Centralisation de la gestion des √©v√©nements UI avec patterns de d√©l√©gation efficaces\r\n *\r\n * @module ui/event-delegation\r\n * @author Assistant\r\n * @version 1.0.0\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    const Log = GeoLeaf.Log;\r\n\r\n    GeoLeaf._UIEventDelegation = GeoLeaf._UIEventDelegation || {};\r\n\r\n    // ========================================\r\n    //   CONSTANTES & √âTAT\r\n    // ========================================\r\n\r\n    /**\r\n     * Map des listeners actifs pour cleanup\r\n     * @type {Map<string, {element: HTMLElement, event: string, handler: Function}>}\r\n     */\r\n    const _activeListeners = new Map();\r\n\r\n    /**\r\n     * Compteur pour identifiants uniques des listeners\r\n     * @type {number}\r\n     */\r\n    let _listenerIdCounter = 0;\r\n\r\n    // ========================================\r\n    //   UTILITAIRES DE D√âL√âGATION\r\n    // ========================================\r\n\r\n    /**\r\n     * Attache un event listener avec tracking automatique pour cleanup\r\n     * @param {HTMLElement} element - √âl√©ment DOM\r\n     * @param {string} event - Type d'√©v√©nement\r\n     * @param {Function} handler - Handler de l'√©v√©nement\r\n     * @param {Object} options - Options pour addEventListener\r\n     * @returns {string} ID unique du listener pour cleanup\r\n     */\r\n    function attachTrackedListener(element, event, handler, options = {}) {\r\n        if (!element || typeof handler !== 'function') {\r\n            if (Log) Log.warn(\"[UI.EventDelegation] attachTrackedListener: √©lement ou handler manquant\");\r\n            return null;\r\n        }\r\n\r\n        const listenerId = `listener_${++_listenerIdCounter}`;\r\n\r\n        // Wrapper pour tracking automatique des erreurs\r\n        const wrappedHandler = function(e) {\r\n            try {\r\n                return handler.call(this, e);\r\n            } catch (error) {\r\n                if (Log) Log.error(\"[UI.EventDelegation] Erreur dans handler:\", error);\r\n            }\r\n        };\r\n\r\n        element.addEventListener(event, wrappedHandler, options);\r\n\r\n        _activeListeners.set(listenerId, {\r\n            element,\r\n            event,\r\n            handler: wrappedHandler,\r\n            originalHandler: handler\r\n        });\r\n\r\n        return listenerId;\r\n    }\r\n\r\n    /**\r\n     * D√©tache un listener track√©e\r\n     * @param {string} listenerId - ID retourn√© par attachTrackedListener\r\n     * @returns {boolean} True si succ√®s\r\n     */\r\n    function detachTrackedListener(listenerId) {\r\n        if (!listenerId || !_activeListeners.has(listenerId)) {\r\n            return false;\r\n        }\r\n\r\n        const { element, event, handler } = _activeListeners.get(listenerId);\r\n        element.removeEventListener(event, handler);\r\n        _activeListeners.delete(listenerId);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Nettoie tous les listeners track√©es\r\n     * @returns {number} Nombre de listeners nettoy√©es\r\n     */\r\n    function cleanupAllListeners() {\r\n        let cleaned = 0;\r\n        for (const [listenerId, { element, event, handler }] of _activeListeners) {\r\n            element.removeEventListener(event, handler);\r\n            cleaned++;\r\n        }\r\n        _activeListeners.clear();\r\n        if (Log && cleaned > 0) {\r\n            Log.info(`[UI.EventDelegation] ${cleaned} listeners nettoy√©es`);\r\n        }\r\n        return cleaned;\r\n    }\r\n\r\n    // ========================================\r\n    //   D√âL√âGATION PAR TYPES UI SP√âCIFIQUES\r\n    // ========================================\r\n\r\n    /**\r\n     * G√®re les √©v√©nements des inputs de filtre avec debouncing\r\n     * @param {HTMLElement} filterContainer - Conteneur des filtres\r\n     * @param {Function} onFilterChange - Callback appel√© lors des changements\r\n     * @param {number} debounceMs - D√©lai de debounce (d√©faut: 300ms)\r\n     * @returns {string[]} IDs des listeners cr√©√©s\r\n     */\r\n    function attachFilterInputEvents(filterContainer, onFilterChange, debounceMs = 300) {\r\n        if (!filterContainer || typeof onFilterChange !== 'function') {\r\n            if (Log) Log.warn(\"[UI.EventDelegation] attachFilterInputEvents: param√®tres manquants\");\r\n            return [];\r\n        }\r\n\r\n        const listenerIds = [];\r\n        let debounceTimer = null;\r\n\r\n        // Fonction debounce pour les inputs\r\n        const debouncedHandler = function() {\r\n            if (debounceTimer) clearTimeout(debounceTimer);\r\n            debounceTimer = setTimeout(() => {\r\n                onFilterChange();\r\n            }, debounceMs);\r\n        };\r\n\r\n        // D√©l√©gation pour tous les inputs de type text/range\r\n        const textInputHandler = function(e) {\r\n            if (e.target.matches('input[type=\"text\"], input[type=\"range\"]')) {\r\n                debouncedHandler();\r\n            }\r\n        };\r\n\r\n        // D√©l√©gation pour les checkboxes (pas de debounce)\r\n        const checkboxHandler = function(e) {\r\n            if (e.target.matches('input[type=\"checkbox\"]')) {\r\n                onFilterChange();\r\n            }\r\n        };\r\n\r\n        // D√©l√©gation pour les selects\r\n        const selectHandler = function(e) {\r\n            if (e.target.matches('select')) {\r\n                onFilterChange();\r\n            }\r\n        };\r\n\r\n        listenerIds.push(attachTrackedListener(filterContainer, 'input', textInputHandler));\r\n        listenerIds.push(attachTrackedListener(filterContainer, 'change', checkboxHandler));\r\n        listenerIds.push(attachTrackedListener(filterContainer, 'change', selectHandler));\r\n\r\n        return listenerIds.filter(id => id !== null);\r\n    }\r\n\r\n    /**\r\n     * G√®re les √©v√©nements d'accord√©on avec d√©l√©gation\r\n     * @param {HTMLElement} container - Conteneur des accord√©ons\r\n     * @returns {string} ID du listener cr√©√©\r\n     */\r\n    function attachAccordionEvents(container) {\r\n        if (!container) {\r\n            if (Log) Log.warn(\"[UI.EventDelegation] attachAccordionEvents: conteneur manquant\");\r\n            return null;\r\n        }\r\n\r\n        const accordionHandler = function(e) {\r\n            // Cherche le bouton d'accord√©on dans la hi√©rarchie\r\n            const accordionButton = e.target.closest('.gl-accordion-toggle, .accordion-arrow');\r\n            if (!accordionButton) return;\r\n\r\n            e.preventDefault();\r\n            e.stopPropagation();\r\n\r\n            // Trouve le panel associ√©\r\n            const panel = accordionButton.closest('.gl-accordion')?.querySelector('.gl-accordion-content');\r\n            if (!panel) return;\r\n\r\n            // Toggle accord√©on\r\n            const isExpanded = panel.style.display !== 'none';\r\n            panel.style.display = isExpanded ? 'none' : 'block';\r\n\r\n            // Met √† jour l'aria-expanded\r\n            accordionButton.setAttribute('aria-expanded', !isExpanded);\r\n\r\n            // Met √† jour l'ic√¥ne si pr√©sente\r\n            const icon = accordionButton.querySelector('.accordion-icon, .accordion-arrow');\r\n            if (icon) {\r\n                icon.classList.toggle('expanded', !isExpanded);\r\n            }\r\n        };\r\n\r\n        return attachTrackedListener(container, 'click', accordionHandler);\r\n    }\r\n\r\n    /**\r\n     * G√®re les √©v√©nements des contr√¥les de carte (delegation pour les boutons)\r\n     * @param {HTMLElement} mapContainer - Conteneur de la carte\r\n     * @param {Object} handlers - Map des handlers { selectorPattern: handlerFunction }\r\n     * @returns {string[]} IDs des listeners cr√©√©s\r\n     */\r\n    function attachMapControlEvents(mapContainer, handlers) {\r\n        if (!mapContainer || !handlers || typeof handlers !== 'object') {\r\n            if (Log) Log.warn(\"[UI.EventDelegation] attachMapControlEvents: param√®tres manquants\");\r\n            return [];\r\n        }\r\n\r\n        const listenerIds = [];\r\n\r\n        const controlHandler = function(e) {\r\n            for (const [selector, handler] of Object.entries(handlers)) {\r\n                if (e.target.matches(selector) || e.target.closest(selector)) {\r\n                    e.preventDefault();\r\n                    e.stopPropagation();\r\n\r\n                    if (typeof handler === 'function') {\r\n                        handler.call(this, e);\r\n                    }\r\n                    break;\r\n                }\r\n            }\r\n        };\r\n\r\n        listenerIds.push(attachTrackedListener(mapContainer, 'click', controlHandler));\r\n        return listenerIds.filter(id => id !== null);\r\n    }\r\n\r\n    // ========================================\r\n    //   API PUBLIQUE\r\n    // ========================================\r\n\r\n    // Fonctions de base\r\n    GeoLeaf._UIEventDelegation.attachTrackedListener = attachTrackedListener;\r\n    GeoLeaf._UIEventDelegation.detachTrackedListener = detachTrackedListener;\r\n    GeoLeaf._UIEventDelegation.cleanupAllListeners = cleanupAllListeners;\r\n\r\n    // D√©l√©gations sp√©cialis√©es\r\n    GeoLeaf._UIEventDelegation.attachFilterInputEvents = attachFilterInputEvents;\r\n    GeoLeaf._UIEventDelegation.attachAccordionEvents = attachAccordionEvents;\r\n    GeoLeaf._UIEventDelegation.attachMapControlEvents = attachMapControlEvents;\r\n\r\n    // Statistiques et debug\r\n    /**\r\n     * Obtient le nombre de listeners actifs enregistr√©s\r\n     * Utile pour le debugging et le monitoring des fuites m√©moire\r\n     * @returns {number} Nombre de listeners actifs\r\n     * @example\r\n     * const count = GeoLeaf._UIEventDelegation.getActiveListenersCount();\r\n     * console.log(`${count} listeners actifs`);\r\n     */\r\n    GeoLeaf._UIEventDelegation.getActiveListenersCount = function() {\r\n        return _activeListeners.size;\r\n    };\r\n\r\n    /**\r\n     * R√©cup√®re la liste compl√®te des listeners actifs avec leurs m√©tadonn√©es\r\n     * Retourne une Map avec ID listener comme cl√© et info d√©taill√©es\r\n     * @returns {Map<string, Object>} Map des listeners actifs (id -> {element, event, handler, timestamp})\r\n     * @example\r\n     * const listeners = GeoLeaf._UIEventDelegation.getActiveListeners();\r\n     * listeners.forEach((info, id) => console.log(`Listener ${id} sur ${info.event}`));\r\n     */\r\n    GeoLeaf._UIEventDelegation.getActiveListeners = function() {\r\n        return Array.from(_activeListeners.keys());\r\n    };\r\n\r\n    if (Log) {\r\n        Log.info(\"[UI.EventDelegation] Module initialis√©\");\r\n    }\r\n\r\n})(window);\r\n","/**\r\n * GeoLeaf UI Module - Filter State Manager\r\n * Gestion centralis√©e de l'√©tat des filtres avec patterns observateur\r\n *\r\n * @module ui/filter-state-manager\r\n * @author Assistant\r\n * @version 1.0.0\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    const Log = GeoLeaf.Log;\r\n\r\n    GeoLeaf._UIFilterStateManager = GeoLeaf._UIFilterStateManager || {};\r\n\r\n    // ========================================\r\n    //   √âTAT CENTRALIS√â DES FILTRES\r\n    // ========================================\r\n\r\n    /**\r\n     * √âtat actuel des filtres\r\n     * @type {Object}\r\n     * @private\r\n     */\r\n    let _filterState = {\r\n        // √âtat des filtres par ID\r\n        values: new Map(),\r\n\r\n        // M√©tadonn√©es des filtres\r\n        metadata: new Map(),\r\n\r\n        // Profil actuel\r\n        activeProfile: null,\r\n\r\n        // Callbacks observers\r\n        observers: new Set()\r\n    };\r\n\r\n    /**\r\n     * Timestamps pour debouncing\r\n     * @type {Map<string, number>}\r\n     * @private\r\n     */\r\n    const _debounceTimers = new Map();\r\n\r\n    // ========================================\r\n    //   GESTION DE L'√âTAT DES FILTRES\r\n    // ========================================\r\n\r\n    /**\r\n     * Initialise l'√©tat des filtres depuis un profil\r\n     * @param {Object} profile - Configuration du profil\r\n     * @returns {boolean} Succ√®s de l'initialisation\r\n     */\r\n    function initializeFromProfile(profile) {\r\n        if (!profile || !profile.filters) {\r\n            if (Log) Log.warn(\"[UI.FilterStateManager] Profil ou filtres manquants\");\r\n            return false;\r\n        }\r\n\r\n        // R√©initialise l'√©tat\r\n        _filterState.values.clear();\r\n        _filterState.metadata.clear();\r\n        _filterState.activeProfile = profile;\r\n\r\n        // Configure chaque filtre avec ses valeurs par d√©faut\r\n        profile.filters.forEach(filter => {\r\n            if (!filter.id) return;\r\n\r\n            const metadata = {\r\n                type: filter.type,\r\n                label: filter.label,\r\n                required: !!filter.required,\r\n                min: filter.min,\r\n                max: filter.max,\r\n                options: filter.options || [],\r\n                optionsFrom: filter.optionsFrom\r\n            };\r\n\r\n            _filterState.metadata.set(filter.id, metadata);\r\n\r\n            // Valeur par d√©faut selon le type\r\n            let defaultValue = null;\r\n            switch (filter.type) {\r\n                case 'select':\r\n                case 'multiselect':\r\n                    defaultValue = filter.default || (filter.type === 'multiselect' ? [] : '');\r\n                    break;\r\n                case 'range':\r\n                    defaultValue = filter.default ?? ((filter.min + filter.max) / 2);\r\n                    break;\r\n                case 'tree':\r\n                case 'tree-category':\r\n                case 'categoryTree':\r\n                    defaultValue = filter.default || [];\r\n                    break;\r\n                default:\r\n                    defaultValue = filter.default || '';\r\n            }\r\n\r\n            _filterState.values.set(filter.id, defaultValue);\r\n        });\r\n\r\n        // Notifie les observateurs\r\n        _notifyObservers('init', null, _filterState.values);\r\n\r\n        if (Log) {\r\n            Log.info(`[UI.FilterStateManager] Initialis√© avec ${_filterState.values.size} filtres`);\r\n        }\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Met √† jour la valeur d'un filtre\r\n     * @param {string} filterId - ID du filtre\r\n     * @param {*} value - Nouvelle valeur\r\n     * @param {boolean} skipNotify - √âviter la notification (d√©faut: false)\r\n     * @returns {boolean} Succ√®s de la mise √† jour\r\n     */\r\n    function updateFilterValue(filterId, value, skipNotify = false) {\r\n        if (!filterId || !_filterState.metadata.has(filterId)) {\r\n            if (Log) Log.warn(`[UI.FilterStateManager] Filtre inconnu: ${filterId}`);\r\n            return false;\r\n        }\r\n\r\n        const metadata = _filterState.metadata.get(filterId);\r\n        const oldValue = _filterState.values.get(filterId);\r\n\r\n        // Validation selon le type\r\n        const validatedValue = _validateFilterValue(value, metadata);\r\n        if (validatedValue === null && value !== null) {\r\n            if (Log) Log.warn(`[UI.FilterStateManager] Valeur invalide pour ${filterId}:`, value);\r\n            return false;\r\n        }\r\n\r\n        // Mise √† jour\r\n        _filterState.values.set(filterId, validatedValue);\r\n\r\n        // Notification avec debouncing pour les ranges\r\n        if (!skipNotify) {\r\n            if (metadata.type === 'range') {\r\n                _notifyWithDebounce(filterId, 'change', oldValue, validatedValue, 200);\r\n            } else {\r\n                _notifyObservers('change', filterId, validatedValue, oldValue);\r\n            }\r\n        }\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * R√©cup√®re la valeur d'un filtre\r\n     * @param {string} filterId - ID du filtre\r\n     * @returns {*} Valeur du filtre ou null si inexistant\r\n     */\r\n    function getFilterValue(filterId) {\r\n        return _filterState.values.get(filterId) || null;\r\n    }\r\n\r\n    /**\r\n     * R√©cup√®re toutes les valeurs de filtres\r\n     * @returns {Object} Object avec filterId -> value\r\n     */\r\n    function getAllFilterValues() {\r\n        return Object.fromEntries(_filterState.values);\r\n    }\r\n\r\n    /**\r\n     * R√©cup√®re les m√©tadonn√©es d'un filtre\r\n     * @param {string} filterId - ID du filtre\r\n     * @returns {Object|null} M√©tadonn√©es ou null\r\n     */\r\n    function getFilterMetadata(filterId) {\r\n        return _filterState.metadata.get(filterId) || null;\r\n    }\r\n\r\n    /**\r\n     * Remet √† z√©ro tous les filtres\r\n     * @param {boolean} skipNotify - √âviter la notification (d√©faut: false)\r\n     */\r\n    function resetAllFilters(skipNotify = false) {\r\n        const oldState = new Map(_filterState.values);\r\n\r\n        _filterState.values.forEach((value, filterId) => {\r\n            const metadata = _filterState.metadata.get(filterId);\r\n            if (!metadata) return;\r\n\r\n            // Remise √† z√©ro selon le type\r\n            let resetValue = null;\r\n            switch (metadata.type) {\r\n                case 'multiselect':\r\n                case 'tree':\r\n                case 'tree-category':\r\n                case 'categoryTree':\r\n                    resetValue = [];\r\n                    break;\r\n                case 'range':\r\n                    resetValue = (metadata.min + metadata.max) / 2;\r\n                    break;\r\n                default:\r\n                    resetValue = '';\r\n            }\r\n\r\n            _filterState.values.set(filterId, resetValue);\r\n        });\r\n\r\n        if (!skipNotify) {\r\n            _notifyObservers('reset', null, _filterState.values, oldState);\r\n        }\r\n    }\r\n\r\n    // ========================================\r\n    //   SYST√àME D'OBSERVATEURS\r\n    // ========================================\r\n\r\n    /**\r\n     * Ajoute un observateur pour les changements d'√©tat\r\n     * @param {Function} callback - Fonction appel√©e lors des changements\r\n     * @returns {Function} Fonction pour d√©sabonner l'observateur\r\n     */\r\n    function addObserver(callback) {\r\n        if (typeof callback !== 'function') {\r\n            if (Log) Log.warn(\"[UI.FilterStateManager] Observateur doit √™tre une fonction\");\r\n            return () => {};\r\n        }\r\n\r\n        _filterState.observers.add(callback);\r\n\r\n        // Retourne fonction de d√©sabonnement\r\n        return function unsubscribe() {\r\n            _filterState.observers.delete(callback);\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Notifie tous les observateurs\r\n     * @param {string} type - Type de changement ('init', 'change', 'reset')\r\n     * @param {string|null} filterId - ID du filtre chang√© (null pour global)\r\n     * @param {*} newValue - Nouvelle valeur\r\n     * @param {*} oldValue - Ancienne valeur\r\n     * @private\r\n     */\r\n    function _notifyObservers(type, filterId, newValue, oldValue) {\r\n        const event = {\r\n            type,\r\n            filterId,\r\n            newValue,\r\n            oldValue,\r\n            timestamp: Date.now(),\r\n            allValues: Object.fromEntries(_filterState.values)\r\n        };\r\n\r\n        _filterState.observers.forEach(callback => {\r\n            try {\r\n                callback(event);\r\n            } catch (error) {\r\n                if (Log) Log.error(\"[UI.FilterStateManager] Erreur dans observateur:\", error);\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Notification avec debouncing\r\n     * @param {string} filterId - ID du filtre\r\n     * @param {string} type - Type d'√©v√©nement\r\n     * @param {*} oldValue - Ancienne valeur\r\n     * @param {*} newValue - Nouvelle valeur\r\n     * @param {number} delay - D√©lai de debounce\r\n     * @private\r\n     */\r\n    function _notifyWithDebounce(filterId, type, oldValue, newValue, delay) {\r\n        // Clear existing timer\r\n        if (_debounceTimers.has(filterId)) {\r\n            clearTimeout(_debounceTimers.get(filterId));\r\n        }\r\n\r\n        // Set new timer\r\n        const timer = setTimeout(() => {\r\n            _notifyObservers(type, filterId, newValue, oldValue);\r\n            _debounceTimers.delete(filterId);\r\n        }, delay);\r\n\r\n        _debounceTimers.set(filterId, timer);\r\n    }\r\n\r\n    // ========================================\r\n    //   VALIDATION DE VALEURS\r\n    // ========================================\r\n\r\n    /**\r\n     * Valide une valeur selon les m√©tadonn√©es du filtre\r\n     * @param {*} value - Valeur √† valider\r\n     * @param {Object} metadata - M√©tadonn√©es du filtre\r\n     * @returns {*} Valeur valid√©e ou null si invalide\r\n     * @private\r\n     */\r\n    function _validateFilterValue(value, metadata) {\r\n        if (!metadata) return null;\r\n\r\n        switch (metadata.type) {\r\n            case 'select':\r\n                return typeof value === 'string' ? value : '';\r\n\r\n            case 'multiselect':\r\n                return Array.isArray(value) ? value : [];\r\n\r\n            case 'range':\r\n                const num = parseFloat(value);\r\n                if (isNaN(num)) return metadata.min || 0;\r\n                if (metadata.min !== undefined && num < metadata.min) return metadata.min;\r\n                if (metadata.max !== undefined && num > metadata.max) return metadata.max;\r\n                return num;\r\n\r\n            case 'tree':\r\n            case 'tree-category':\r\n            case 'categoryTree':\r\n                return Array.isArray(value) ? value : [];\r\n\r\n            default:\r\n                return value;\r\n        }\r\n    }\r\n\r\n    // ========================================\r\n    //   UTILITAIRES DE REQU√äTES\r\n    // ========================================\r\n\r\n    /**\r\n     * V√©rifie si des filtres sont actuellement actifs\r\n     * @returns {boolean} True si au moins un filtre est actif\r\n     */\r\n    function hasActiveFilters() {\r\n        for (const [filterId, value] of _filterState.values) {\r\n            const metadata = _filterState.metadata.get(filterId);\r\n            if (!metadata) continue;\r\n\r\n            // V√©rifie selon le type si la valeur est \"active\"\r\n            switch (metadata.type) {\r\n                case 'multiselect':\r\n                case 'tree':\r\n                case 'tree-category':\r\n                case 'categoryTree':\r\n                    if (Array.isArray(value) && value.length > 0) return true;\r\n                    break;\r\n                case 'select':\r\n                    if (value && value !== '') return true;\r\n                    break;\r\n                case 'range':\r\n                    // Consid√®re actif si diff√©rent de la valeur par d√©faut\r\n                    const defaultVal = (metadata.min + metadata.max) / 2;\r\n                    if (Math.abs(value - defaultVal) > 0.01) return true;\r\n                    break;\r\n            }\r\n        }\r\n        return false;\r\n    }\r\n\r\n    /**\r\n     * R√©cup√®re un r√©sum√© des filtres actifs\r\n     * @returns {Array} Liste des filtres actifs avec leurs valeurs\r\n     */\r\n    function getActiveFiltersSummary() {\r\n        const summary = [];\r\n\r\n        for (const [filterId, value] of _filterState.values) {\r\n            const metadata = _filterState.metadata.get(filterId);\r\n            if (!metadata) continue;\r\n\r\n            let isActive = false;\r\n            let displayValue = '';\r\n\r\n            switch (metadata.type) {\r\n                case 'multiselect':\r\n                case 'tree':\r\n                case 'tree-category':\r\n                case 'categoryTree':\r\n                    if (Array.isArray(value) && value.length > 0) {\r\n                        isActive = true;\r\n                        displayValue = `${value.length} s√©lectionn√©(s)`;\r\n                    }\r\n                    break;\r\n                case 'select':\r\n                    if (value && value !== '') {\r\n                        isActive = true;\r\n                        displayValue = value;\r\n                    }\r\n                    break;\r\n                case 'range':\r\n                    const defaultVal = (metadata.min + metadata.max) / 2;\r\n                    if (Math.abs(value - defaultVal) > 0.01) {\r\n                        isActive = true;\r\n                        displayValue = value.toString().replace('.', ',');\r\n                    }\r\n                    break;\r\n            }\r\n\r\n            if (isActive) {\r\n                summary.push({\r\n                    id: filterId,\r\n                    label: metadata.label || filterId,\r\n                    value: displayValue,\r\n                    type: metadata.type\r\n                });\r\n            }\r\n        }\r\n\r\n        return summary;\r\n    }\r\n\r\n    // ========================================\r\n    //   API PUBLIQUE\r\n    // ========================================\r\n\r\n    // Gestion d'√©tat principal\r\n    GeoLeaf._UIFilterStateManager.initializeFromProfile = initializeFromProfile;\r\n    GeoLeaf._UIFilterStateManager.updateFilterValue = updateFilterValue;\r\n    GeoLeaf._UIFilterStateManager.getFilterValue = getFilterValue;\r\n    GeoLeaf._UIFilterStateManager.getAllFilterValues = getAllFilterValues;\r\n    GeoLeaf._UIFilterStateManager.getFilterMetadata = getFilterMetadata;\r\n    GeoLeaf._UIFilterStateManager.resetAllFilters = resetAllFilters;\r\n\r\n    // Syst√®me d'observateurs\r\n    GeoLeaf._UIFilterStateManager.addObserver = addObserver;\r\n\r\n    // Utilitaires de requ√™tes\r\n    GeoLeaf._UIFilterStateManager.hasActiveFilters = hasActiveFilters;\r\n    GeoLeaf._UIFilterStateManager.getActiveFiltersSummary = getActiveFiltersSummary;\r\n\r\n    // Propri√©t√©s en lecture seule\r\n    Object.defineProperty(GeoLeaf._UIFilterStateManager, 'activeProfile', {\r\n        get: () => _filterState.activeProfile,\r\n        enumerable: true\r\n    });\r\n\r\n    Object.defineProperty(GeoLeaf._UIFilterStateManager, 'filterCount', {\r\n        get: () => _filterState.values.size,\r\n        enumerable: true\r\n    });\r\n\r\n    if (Log) {\r\n        Log.info(\"[UI.FilterStateManager] Module initialis√©\");\r\n    }\r\n\r\n})(window);\r\n","/**\r\n * GeoLeaf Scale Control\r\n * G√®re l'affichage de l'√©chelle graphique, num√©rique et du niveau de zoom\r\n *\r\n * @module map/scale-control\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    const Log = GeoLeaf.Log || console;\r\n\r\n    /**\r\n     * Contr√¥le d'√©chelle personnalis√©\r\n     */\r\n    const ScaleControl = {\r\n        _map: null,\r\n        _config: null,\r\n        _container: null,\r\n        _scaleLineMetric: null,\r\n        _numericElement: null,\r\n        _zoomElement: null,\r\n        _inputElement: null,\r\n        _scalePrefix: null,\r\n        _mainWrapper: null,\r\n        _eventHandlers: {},\r\n\r\n        /**\r\n         * Initialise le contr√¥le d'√©chelle\r\n         * @param {L.Map} map - Instance de la carte Leaflet\r\n         * @param {Object} config - Configuration depuis scaleConfig\r\n         */\r\n        init(map, config) {\r\n            if (!map) {\r\n                Log.error(\"[GeoLeaf.ScaleControl] Carte non fournie\");\r\n                return;\r\n            }\r\n\r\n            this._map = map;\r\n            this._config = config || {};\r\n\r\n            // Cr√©er un conteneur unique pour tout\r\n            this._createMainContainer();\r\n\r\n            Log.info(\"[GeoLeaf.ScaleControl] Contr√¥le d'√©chelle initialis√©\");\r\n        },\r\n\r\n        /**\r\n         * Cr√©e le conteneur principal avec √©chelle graphique et bloc personnalis√©\r\n         * @private\r\n         */\r\n        _createMainContainer() {\r\n            const position = this._config.position || 'bottomleft';\r\n\r\n            // Conteneur principal - disposition horizontale\r\n            this._mainWrapper = L.DomUtil.create('div', 'gl-scale-main-wrapper');\r\n\r\n            // 1. √âchelle graphique\r\n            if (this._config.scaleGraphic !== false) {\r\n                const graphicWrapper = L.DomUtil.create('div', 'gl-scale-graphic-wrapper', this._mainWrapper);\r\n                this._addGraphicScaleToContainer(graphicWrapper);\r\n            }\r\n\r\n            // 2. Bloc personnalis√© (√©chelle num√©rique + zoom) sur la m√™me ligne\r\n            if (this._config.scaleNumeric || this._config.scaleNivel) {\r\n                this._createCustomScaleBlock(this._mainWrapper);\r\n            }\r\n\r\n            // Ajouter le conteneur principal √† la carte\r\n            const CustomControl = L.Control.extend({\r\n                options: {\r\n                    position: position\r\n                },\r\n                onAdd: () => {\r\n                    return this._mainWrapper;\r\n                }\r\n            });\r\n\r\n            new CustomControl().addTo(this._map);\r\n        },\r\n\r\n        /**\r\n         * Ajoute l'√©chelle graphique Leaflet dans un conteneur\r\n         * @param {HTMLElement} container - Conteneur cible\r\n         * @private\r\n         */\r\n        _addGraphicScaleToContainer(container) {\r\n            // Cr√©er l'√©chelle graphique manuellement (pas via L.control.scale)\r\n            const scaleDiv = L.DomUtil.create('div', 'leaflet-control-scale leaflet-control', container);\r\n\r\n            const scaleLineMetric = L.DomUtil.create('div', 'leaflet-control-scale-line', scaleDiv);\r\n            this._scaleLineMetric = scaleLineMetric;\r\n\r\n            // Fonction de mise √† jour de l'√©chelle graphique\r\n            const updateScale = () => {\r\n                const y = this._map.getSize().y / 2;\r\n                const maxMeters = this._map.distance(\r\n                    this._map.containerPointToLatLng([0, y]),\r\n                    this._map.containerPointToLatLng([150, y])\r\n                );\r\n                this._updateScaleLine(this._scaleLineMetric, maxMeters);\r\n            };\r\n\r\n            this._eventHandlers.graphicScaleUpdate = updateScale;\r\n            this._map.on('zoomend moveend', updateScale);\r\n            updateScale();\r\n\r\n            Log.info(\"[GeoLeaf.ScaleControl] √âchelle graphique ajout√©e\");\r\n        },\r\n\r\n        /**\r\n         * Met √† jour la ligne d'√©chelle graphique\r\n         * @param {HTMLElement} scaleLine - √âl√©ment de la ligne d'√©chelle\r\n         * @param {number} maxMeters - Distance maximale en m√®tres\r\n         * @private\r\n         */\r\n        _updateScaleLine(scaleLine, maxMeters) {\r\n            const maxKm = maxMeters / 1000;\r\n            let scale, ratio;\r\n\r\n            if (maxKm > 1) {\r\n                const maxNiceKm = this._getRoundNum(maxKm);\r\n                ratio = maxNiceKm / maxKm;\r\n                scale = maxNiceKm + ' km';\r\n            } else {\r\n                const maxNiceM = this._getRoundNum(maxMeters);\r\n                ratio = maxNiceM / maxMeters;\r\n                scale = maxNiceM + ' m';\r\n            }\r\n\r\n            scaleLine.style.width = Math.round(150 * ratio) + 'px';\r\n            scaleLine.textContent = scale;\r\n        },\r\n\r\n        /**\r\n         * Arrondit un nombre √† une valeur \"propre\" (1, 2, 5, 10, 20, 50, etc.)\r\n         * @param {number} num - Nombre √† arrondir\r\n         * @returns {number} Nombre arrondi\r\n         * @private\r\n         */\r\n        _getRoundNum(num) {\r\n            const pow10 = Math.pow(10, (Math.floor(num) + '').length - 1);\r\n            let d = num / pow10;\r\n\r\n            d = d >= 10 ? 10 : d >= 5 ? 5 : d >= 3 ? 3 : d >= 2 ? 2 : 1;\r\n\r\n            return pow10 * d;\r\n        },\r\n\r\n        /**\r\n         * Cr√©e le bloc personnalis√© (√©chelle num√©rique + niveau de zoom)\r\n         * @param {HTMLElement} parentContainer - Conteneur parent\r\n         * @private\r\n         */\r\n        _createCustomScaleBlock(parentContainer) {\r\n            // Cr√©er le conteneur - disposition horizontale\r\n            this._container = L.DomUtil.create('div', 'gl-scale-control', parentContainer);\r\n\r\n            // √âchelle num√©rique\r\n            if (this._config.scaleNumeric) {\r\n                if (this._config.scaleNumericEditable) {\r\n                    this._createEditableScale();\r\n                } else {\r\n                    this._createReadOnlyScale();\r\n                }\r\n            }\r\n\r\n            // Niveau de zoom\r\n            if (this._config.scaleNivel) {\r\n                this._createZoomLevel();\r\n            }\r\n\r\n            // √âv√©nements de mise √† jour\r\n            const updateHandler = () => this._updateScale();\r\n            this._eventHandlers.numericScaleUpdate = updateHandler;\r\n            this._map.on('zoomend moveend', updateHandler);\r\n            this._updateScale(); // Mise √† jour initiale\r\n\r\n            Log.info(\"[GeoLeaf.ScaleControl] Bloc personnalis√© ajout√©\");\r\n        },\r\n\r\n        /**\r\n         * Cr√©e l'√©chelle num√©rique en lecture seule\r\n         * @private\r\n         */\r\n        _createReadOnlyScale() {\r\n            this._numericElement = L.DomUtil.create('div', 'gl-scale-numeric', this._container);\r\n        },\r\n\r\n        /**\r\n         * Cr√©e l'√©chelle num√©rique √©ditable avec input\r\n         * @private\r\n         */\r\n        _createEditableScale() {\r\n            // Cr√©er un conteneur pour l'√©chelle √©ditable\r\n            const wrapper = L.DomUtil.create('div', 'gl-scale-numeric-editable', this._container);\r\n\r\n            // Cr√©er le pr√©fixe \"1:\" (toujours visible)\r\n            this._scalePrefix = L.DomUtil.create('span', 'gl-scale-prefix', wrapper);\r\n            this._scalePrefix.textContent = '1:';\r\n\r\n            // Cr√©er le span affich√© initialement (soulign√© et cliquable) - contient uniquement le d√©nominateur\r\n            this._numericElement = L.DomUtil.create('span', 'gl-scale-numeric-clickable', wrapper);\r\n            this._numericElement.textContent = '0';\r\n\r\n            // Cr√©er l'input (cach√© initialement) - contient uniquement le d√©nominateur\r\n            this._inputElement = L.DomUtil.create('input', 'gl-scale-numeric-input', wrapper);\r\n            this._inputElement.type = 'text';\r\n            this._inputElement.placeholder = '250000';\r\n            this._inputElement.style.display = 'none';\r\n\r\n            // Emp√™cher les interactions de la carte lors de l'√©dition\r\n            L.DomEvent.disableClickPropagation(wrapper);\r\n            L.DomEvent.disableScrollPropagation(wrapper);\r\n\r\n            // Clic sur le span : passer en mode √©dition\r\n            this._numericElement.addEventListener('click', () => {\r\n                this._switchToEditMode();\r\n            });\r\n\r\n            // Validation avec Enter\r\n            this._inputElement.addEventListener('keypress', (e) => {\r\n                if (e.key === 'Enter') {\r\n                    this._onScaleInputChange();\r\n                    this._switchToDisplayMode();\r\n                }\r\n            });\r\n\r\n            // Validation en cliquant √† l'ext√©rieur (blur)\r\n            this._inputElement.addEventListener('blur', () => {\r\n                this._onScaleInputChange();\r\n                this._switchToDisplayMode();\r\n            });\r\n        },\r\n\r\n        /**\r\n         * Cr√©e l'affichage du niveau de zoom\r\n         * @private\r\n         */\r\n        _createZoomLevel() {\r\n            this._zoomElement = L.DomUtil.create('div', 'gl-scale-zoom', this._container);\r\n        },\r\n\r\n        /**\r\n         * Bascule en mode √©dition (affiche l'input)\r\n         * @private\r\n         */\r\n        _switchToEditMode() {\r\n            if (!this._numericElement || !this._inputElement) return;\r\n\r\n            // Copier la valeur actuelle dans l'input\r\n            this._inputElement.value = this._numericElement.textContent;\r\n\r\n            // Cacher le span, afficher l'input\r\n            this._numericElement.style.display = 'none';\r\n            this._inputElement.style.display = 'inline-block';\r\n\r\n            // Focus et s√©lection du texte\r\n            this._inputElement.focus();\r\n            this._inputElement.select();\r\n        },\r\n\r\n        /**\r\n         * Bascule en mode affichage (affiche le span)\r\n         * @private\r\n         */\r\n        _switchToDisplayMode() {\r\n            if (!this._numericElement || !this._inputElement) return;\r\n\r\n            // Cacher l'input, afficher le span\r\n            this._inputElement.style.display = 'none';\r\n            this._numericElement.style.display = 'inline';\r\n        },\r\n\r\n        /**\r\n         * Met √† jour l'affichage de l'√©chelle et du zoom\r\n         * @private\r\n         */\r\n        _updateScale() {\r\n            const zoom = this._map.getZoom();\r\n            const scale = this._calculateScale(zoom);\r\n\r\n            // Mettre √† jour l'√©chelle num√©rique\r\n            if (this._numericElement) {\r\n                if (this._config.scaleNumericEditable) {\r\n                    // Mettre √† jour uniquement le d√©nominateur (sans '1:')\r\n                    if (this._inputElement.style.display === 'none') {\r\n                        this._numericElement.textContent = this._formatNumber(scale);\r\n                    }\r\n                } else {\r\n                    // Mode non √©ditable : afficher \"1:\" + d√©nominateur\r\n                    this._numericElement.textContent = `1:${this._formatNumber(scale)}`;\r\n                }\r\n            }\r\n\r\n            // Mettre √† jour le niveau de zoom\r\n            if (this._zoomElement) {\r\n                this._zoomElement.textContent = `Zoom: ${Number(zoom).toFixed(2)}`;\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Calcule l'√©chelle approximative en fonction du niveau de zoom\r\n         * @param {number} zoom - Niveau de zoom Leaflet\r\n         * @param {number} [lat] - Latitude optionnelle (utilise le centre de la carte si non fournie)\r\n         * @returns {number} √âchelle (ex: 250000 pour 1:250000)\r\n         * @private\r\n         */\r\n        _calculateScale(zoom, lat) {\r\n            // Utiliser la latitude fournie ou celle du centre de la carte\r\n            const latitude = lat !== undefined ? lat : this._map.getCenter().lat;\r\n            // Formule approximative bas√©e sur la taille des tuiles Web Mercator\r\n            const metersPerPixel = 156543.03392 * Math.cos(latitude * Math.PI / 180) / Math.pow(2, zoom);\r\n            const scale = metersPerPixel * 96 / 0.0254; // 96 DPI\r\n            return Math.round(scale);\r\n        },\r\n\r\n        /**\r\n         * Formate un nombre avec des espaces comme s√©parateurs de milliers\r\n         * @param {number} num - Nombre √† formater\r\n         * @returns {string} Nombre format√©\r\n         * @private\r\n         */\r\n        _formatNumber(num) {\r\n            return num.toString().replace(/\\B(?=(\\d{3})+(?!\\d))/g, \" \");\r\n        },\r\n\r\n        /**\r\n         * G√®re le changement manuel de l'√©chelle\r\n         * @private\r\n         */\r\n        _onScaleInputChange() {\r\n            if (!this._inputElement) return;\r\n\r\n            const input = this._inputElement.value.trim();\r\n            // Parser uniquement le d√©nominateur (nombre avec espaces optionnels)\r\n            const cleanedInput = input.replace(/\\s/g, '');\r\n            const targetScale = parseInt(cleanedInput, 10);\r\n\r\n            if (!isNaN(targetScale) && targetScale > 0) {\r\n                const targetZoom = this._calculateZoomFromScale(targetScale);\r\n                // Utiliser setView avec zoomSnap: 0 pour permettre les zooms fractionnaires\r\n                this._map.setView(this._map.getCenter(), targetZoom, {\r\n                    animate: true,\r\n                    zoomSnap: 0\r\n                });\r\n                Log.info(`[GeoLeaf.ScaleControl] Zoom ajust√© √† ${targetZoom} pour √©chelle 1:${targetScale}`);\r\n            } else {\r\n                Log.warn(\"[GeoLeaf.ScaleControl] Format d'√©chelle invalide:\", input);\r\n                this._updateScale(); // R√©initialiser la valeur\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Calcule le niveau de zoom pour atteindre une √©chelle donn√©e\r\n         * @param {number} targetScale - √âchelle cible (ex: 250000)\r\n         * @returns {number} Niveau de zoom (peut √™tre d√©cimal pour plus de pr√©cision)\r\n         * @private\r\n         */\r\n        _calculateZoomFromScale(targetScale) {\r\n            const lat = this._map.getCenter().lat;\r\n            const metersPerPixel = targetScale * 0.0254 / 96;\r\n            let zoom = Math.log2(156543.03392 * Math.cos(lat * Math.PI / 180) / metersPerPixel);\r\n\r\n            // Affiner le zoom par it√©ration pour obtenir l'√©chelle exacte\r\n            // Utiliser une m√©thode de convergence pr√©cise\r\n            for (let i = 0; i < 20; i++) {\r\n                const currentScale = this._calculateScale(zoom, lat); // Passer lat pour √©viter recalcul\r\n                const diff = targetScale - currentScale;\r\n\r\n                // Si l'erreur est inf√©rieure √† 1 (pratiquement identique), on arr√™te\r\n                if (Math.abs(diff) < 1) {\r\n                    break;\r\n                }\r\n\r\n                // Ajuster le zoom proportionnellement √† l'erreur\r\n                // Plus l'√©chelle est grande, plus on doit d√©zoomer (zoom plus petit)\r\n                const adjustment = Math.log2(targetScale / currentScale);\r\n                zoom -= adjustment * 0.95; // Facteur d'amortissement pour √©viter les oscillations\r\n            }\r\n\r\n            // Arrondir √† 4 d√©cimales pour une pr√©cision maximale\r\n            const preciseZoom = Math.round(zoom * 10000) / 10000;\r\n            return Math.max(0, Math.min(22, preciseZoom));\r\n        },\r\n\r\n        /**\r\n         * D√©truit le contr√¥le et nettoie les ressources\r\n         */\r\n        destroy() {\r\n            // Retirer les event listeners de la carte\r\n            if (this._map && this._eventHandlers) {\r\n                if (this._eventHandlers.graphicScaleUpdate) {\r\n                    this._map.off('zoomend moveend', this._eventHandlers.graphicScaleUpdate);\r\n                }\r\n                if (this._eventHandlers.numericScaleUpdate) {\r\n                    this._map.off('zoomend moveend', this._eventHandlers.numericScaleUpdate);\r\n                }\r\n            }\r\n\r\n            // Supprimer le conteneur principal du DOM\r\n            if (this._mainWrapper && this._mainWrapper.parentNode) {\r\n                this._mainWrapper.parentNode.removeChild(this._mainWrapper);\r\n            }\r\n\r\n            // Nettoyer toutes les r√©f√©rences\r\n            this._map = null;\r\n            this._config = null;\r\n            this._container = null;\r\n            this._scaleLineMetric = null;\r\n            this._numericElement = null;\r\n            this._zoomElement = null;\r\n            this._inputElement = null;\r\n            this._scalePrefix = null;\r\n            this._mainWrapper = null;\r\n            this._eventHandlers = {};\r\n\r\n            Log.info(\"[GeoLeaf.ScaleControl] Contr√¥le d√©truit et ressources nettoy√©es\");\r\n        }\r\n    };\r\n\r\n    // Exposer le module\r\n    GeoLeaf.ScaleControl = ScaleControl;\r\n\r\n    /**\r\n     * Initialise automatiquement le contr√¥le d'√©chelle si la configuration est pr√©sente\r\n     */\r\n    GeoLeaf.initScaleControl = function(map) {\r\n        if (!map) {\r\n            Log.warn(\"[GeoLeaf.ScaleControl] Impossible d'initialiser : carte non fournie\");\r\n            return;\r\n        }\r\n\r\n        const config = GeoLeaf.Config && GeoLeaf.Config.get\r\n            ? GeoLeaf.Config.get('scaleConfig')\r\n            : null;\r\n\r\n        if (config && (config.scaleGraphic || config.scaleNumeric || config.scaleNivel)) {\r\n            ScaleControl.init(map, config);\r\n        }\r\n    };\r\n\r\n})(typeof window !== \"undefined\" ? window : global);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n/**\r\n * GeoLeaf UI - Filter Control Builder\r\n * Construit les contr√¥les de filtres individuels\r\n *\r\n * @module ui/filter-control-builder\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n\r\n    // D√©pendances\r\n    const Log = GeoLeaf.Log || console;\r\n    const $create = GeoLeaf.Utils?.createElement || function(tag, props) {\r\n        const el = document.createElement(tag);\r\n        if (props) {\r\n            if (props.className) el.className = props.className;\r\n            if (props.textContent) el.textContent = props.textContent;\r\n            if (props.id) el.id = props.id;\r\n            if (props.name) el.name = props.name;\r\n            if (props.type) el.type = props.type;\r\n            if (props.placeholder) el.placeholder = props.placeholder;\r\n            if (props.value !== undefined) el.value = props.value;\r\n            if (props.checked !== undefined) el.checked = props.checked;\r\n            if (props.multiple !== undefined) el.multiple = props.multiple;\r\n            if (props.style) Object.assign(el.style, props.style);\r\n            if (props.attributes) {\r\n                for (const [key, value] of Object.entries(props.attributes)) {\r\n                    el.setAttribute(key, value);\r\n                }\r\n            }\r\n            if (props.min !== undefined) el.min = props.min;\r\n            if (props.max !== undefined) el.max = props.max;\r\n            if (props.step !== undefined) el.step = props.step;\r\n        }\r\n        return el;\r\n    };\r\n\r\n    /**\r\n     * Construit un contr√¥le de filtre individuel\r\n     * @param {Object} filterDef - D√©finition du filtre\r\n     * @param {Object} profile - Configuration du profil\r\n     * @param {boolean} skipLabel - Sauter la cr√©ation du label (d√©faut: false)\r\n     * @returns {HTMLElement|null}\r\n     */\r\n    GeoLeaf.UI._buildFilterControl = function(filterDef, profile, skipLabel) {\r\n        if (!filterDef || !filterDef.id || !filterDef.type) return null;\r\n\r\n        const wrapper = $create(\"div\", {\r\n            className: \"gl-filter-panel__group\",\r\n            attributes: { \"data-gl-filter-id\": filterDef.id }\r\n        });\r\n\r\n        let labelEl = null;\r\n        // Ne pas cr√©er de label si skipLabel est true (pour les accord√©ons qui ont leur propre titre)\r\n        if (filterDef.label && !skipLabel) {\r\n            labelEl = $create(\"label\", {\r\n                className: \"gl-filter-panel__label\",\r\n                textContent: filterDef.label\r\n            });\r\n            wrapper.appendChild(labelEl);\r\n        }\r\n\r\n        let control = null;\r\n\r\n        // 1) SELECT / MULTISELECT classiques\r\n        if (filterDef.type === \"select\" || filterDef.type === \"multiselect\") {\r\n            const selectEl = $create(\"select\", {\r\n                className: \"gl-filter-panel__control gl-filter-panel__control--select\",\r\n                name: filterDef.id,\r\n                id: \"gl-filter-\" + filterDef.id\r\n            });\r\n\r\n            if (labelEl) {\r\n                labelEl.setAttribute(\"for\", selectEl.id);\r\n            }\r\n\r\n            if (filterDef.type === \"multiselect\") {\r\n                selectEl.multiple = true;\r\n            }\r\n\r\n            if (filterDef.optionsFrom) {\r\n                GeoLeaf.UI._populateSelectOptionsFromTaxonomy?.(\r\n                    selectEl,\r\n                    profile,\r\n                    filterDef.optionsFrom\r\n                );\r\n            }\r\n\r\n            control = selectEl;\r\n        }\r\n\r\n        // 2) SLIDER (range)\r\n        else if (filterDef.type === \"range\") {\r\n            const container = $create(\"div\", { className: \"gl-filter-panel__range-wrapper\" });\r\n\r\n            const input = $create(\"input\", {\r\n                type: \"range\",\r\n                className: \"gl-filter-panel__control gl-filter-panel__control--range\",\r\n                id: \"gl-filter-\" + filterDef.id,\r\n                name: filterDef.id\r\n            });\r\n\r\n            if (labelEl) {\r\n                labelEl.setAttribute(\"for\", input.id);\r\n            }\r\n\r\n            if (typeof filterDef.min === \"number\") input.min = String(filterDef.min);\r\n            if (typeof filterDef.max === \"number\") input.max = String(filterDef.max);\r\n            if (typeof filterDef.step === \"number\") input.step = String(filterDef.step);\r\n\r\n            const valueLabel = $create(\"span\", { className: \"gl-filter-panel__range-value\" });\r\n\r\n            let initialValue;\r\n            if (typeof filterDef.default === \"number\") {\r\n                initialValue = filterDef.default;\r\n            } else if (input.min && input.max) {\r\n                const min = parseFloat(input.min);\r\n                const max = parseFloat(input.max);\r\n                initialValue = (min + max) / 2;\r\n            } else {\r\n                initialValue = input.min ? parseFloat(input.min) : 0;\r\n            }\r\n\r\n            if (!isNaN(initialValue)) {\r\n                input.value = String(initialValue);\r\n                valueLabel.textContent = initialValue.toString().replace(\".\", \",\");\r\n            }\r\n\r\n            input.addEventListener(\"input\", function() {\r\n                const val = parseFloat(input.value);\r\n                if (!isNaN(val)) {\r\n                    valueLabel.textContent = val.toString().replace(\".\", \",\");\r\n                }\r\n            });\r\n\r\n            container.appendChild(input);\r\n            container.appendChild(valueLabel);\r\n            control = container;\r\n        }\r\n\r\n        // 3) TREE-VIEW cat√©gories / sous-cat√©gories\r\n        else if (filterDef.type === \"tree\" || filterDef.type === \"tree-category\" || filterDef.type === \"categoryTree\") {\r\n            // LAZY LOADING: Retourner un container vide avec marqueur\r\n            const treeContainer = $create(\"div\", {\r\n                className: \"gl-filter-panel__tree gl-filter-panel__tree--lazy\",\r\n                attributes: {\r\n                    \"data-lazy-type\": \"categories\",\r\n                    \"data-filter-id\": filterDef.id\r\n                }\r\n            });\r\n\r\n            control = treeContainer;\r\n        }\r\n\r\n        // 4) CHECKBOX GROUP\r\n        else if (filterDef.type === \"checkbox-group\") {\r\n            const groupContainer = $create(\"div\", { className: \"gl-filter-panel__checkbox-group\" });\r\n\r\n            if (Array.isArray(filterDef.options)) {\r\n                filterDef.options.forEach(function(opt) {\r\n                    const label = $create(\"label\", { className: \"gl-filter-panel__checkbox-label\" });\r\n\r\n                    const checkbox = $create(\"input\", {\r\n                        type: \"checkbox\",\r\n                        className: \"gl-filter-panel__checkbox\",\r\n                        name: filterDef.id,\r\n                        value: opt.id,\r\n                        checked: !!opt.checked,\r\n                        attributes: { \"data-filter-option-id\": opt.id }\r\n                    });\r\n\r\n                    const text = $create(\"span\", {\r\n                        className: \"gl-filter-panel__checkbox-text\",\r\n                        textContent: opt.label || opt.id\r\n                    });\r\n\r\n                    label.appendChild(checkbox);\r\n                    label.appendChild(text);\r\n                    groupContainer.appendChild(label);\r\n                });\r\n            }\r\n            control = groupContainer;\r\n        }\r\n\r\n        // 5) SEARCH\r\n        else if (filterDef.type === \"search\") {\r\n            const searchInput = $create(\"input\", {\r\n                type: \"text\",\r\n                className: \"gl-filter-panel__control gl-filter-panel__control--search\",\r\n                name: filterDef.id,\r\n                placeholder: filterDef.placeholder || \"Filtrer...\"\r\n            });\r\n\r\n            if (Array.isArray(filterDef.searchFields)) {\r\n                searchInput.setAttribute(\"data-search-fields\", filterDef.searchFields.join(\",\"));\r\n            }\r\n\r\n            control = searchInput;\r\n        }\r\n\r\n        // 6) PROXIMITY\r\n        else if (filterDef.type === \"proximity\") {\r\n            const proximityContainer = $create(\"div\", { className: \"gl-filter-panel__proximity\" });\r\n\r\n            if (filterDef.label) {\r\n                const title = $create(\"h3\", {\r\n                    className: \"gl-filter-panel__proximity-title\",\r\n                    textContent: filterDef.label\r\n                });\r\n                proximityContainer.appendChild(title);\r\n            }\r\n\r\n            const button = $create(\"button\", {\r\n                type: \"button\",\r\n                className: \"gl-btn gl-btn--secondary gl-filter-panel__proximity-btn\",\r\n                attributes: { \"data-filter-proximity-btn\": \"true\" },\r\n                textContent: filterDef.buttonLabel || \"Activer\"\r\n            });\r\n            proximityContainer.appendChild(button);\r\n\r\n            const rangeWrapper = $create(\"div\", {\r\n                className: \"gl-filter-panel__proximity-range\",\r\n                style: { display: \"none\" }\r\n            });\r\n\r\n            const rangeLabel = $create(\"label\", {\r\n                className: \"gl-filter-panel__label\",\r\n                textContent: \"Rayon (km)\",\r\n                attributes: { \"for\": \"gl-filter-proximity-radius\" }\r\n            });\r\n            rangeWrapper.appendChild(rangeLabel);\r\n\r\n            const rangeContainer = $create(\"div\", { className: \"gl-filter-panel__range-wrapper\" });\r\n\r\n            let minRadius = 1;\r\n            let maxRadius = 50;\r\n            let stepRadius = 1;\r\n            let defaultRadius = 10;\r\n            try {\r\n                const activeProfile = GeoLeaf.Config?.getActiveProfile?.();\r\n                if (activeProfile) {\r\n                    const searchConfig = (activeProfile.panels && activeProfile.panels.search) || activeProfile.search;\r\n                    if (searchConfig) {\r\n                        if (typeof searchConfig.radiusMin === \"number\" && searchConfig.radiusMin > 0) {\r\n                            minRadius = searchConfig.radiusMin;\r\n                        }\r\n                        if (typeof searchConfig.radiusMax === \"number\" && searchConfig.radiusMax > 0) {\r\n                            maxRadius = searchConfig.radiusMax;\r\n                        }\r\n                        if (typeof searchConfig.radiusStep === \"number\" && searchConfig.radiusStep > 0) {\r\n                            stepRadius = searchConfig.radiusStep;\r\n                        }\r\n                        if (typeof searchConfig.radiusDefault === \"number\" && searchConfig.radiusDefault > 0) {\r\n                            defaultRadius = searchConfig.radiusDefault;\r\n                        }\r\n                        defaultRadius = Math.max(minRadius, Math.min(defaultRadius, maxRadius));\r\n                    }\r\n                }\r\n            } catch (err) {\r\n                Log?.warn?.(\"[GeoLeaf.UI] Erreur lecture radius config:\", err);\r\n            }\r\n\r\n            const rangeInput = $create(\"input\", {\r\n                type: \"range\",\r\n                className: \"gl-filter-panel__control gl-filter-panel__control--range\",\r\n                id: \"gl-filter-proximity-radius\",\r\n                name: filterDef.id + \"_radius\",\r\n                min: String(minRadius),\r\n                max: String(maxRadius),\r\n                step: String(stepRadius),\r\n                value: String(defaultRadius),\r\n                attributes: { \"data-filter-proximity-radius\": \"true\" }\r\n            });\r\n\r\n            const rangeValue = $create(\"span\", {\r\n                className: \"gl-filter-panel__range-value\",\r\n                textContent: String(defaultRadius)\r\n            });\r\n\r\n            rangeInput.addEventListener(\"input\", function() {\r\n                rangeValue.textContent = rangeInput.value;\r\n            });\r\n\r\n            rangeContainer.appendChild(rangeInput);\r\n            rangeContainer.appendChild(rangeValue);\r\n            rangeWrapper.appendChild(rangeContainer);\r\n\r\n            const instruction = $create(\"p\", {\r\n                className: \"gl-filter-panel__proximity-instruction\",\r\n                textContent: filterDef.instructionText || \"Cliquez sur la carte\",\r\n                style: { display: \"none\" }\r\n            });\r\n            rangeWrapper.appendChild(instruction);\r\n\r\n            proximityContainer.appendChild(rangeWrapper);\r\n            control = proximityContainer;\r\n        }\r\n\r\n        // 7) TAGS\r\n        else if (filterDef.type === \"multiselect-tags\" || filterDef.id === \"tags\") {\r\n            const tagsContainer = $create(\"div\", {\r\n                className: \"gl-filter-panel__tags-container\",\r\n                attributes: {\r\n                    \"data-lazy-type\": \"tags\",\r\n                    \"data-filter-id\": filterDef.id\r\n                }\r\n            });\r\n            control = tagsContainer;\r\n        }\r\n\r\n        // Aucun type reconnu\r\n        if (!control) {\r\n            return null;\r\n        }\r\n\r\n        if (labelEl && control instanceof HTMLElement && !control.id) {\r\n            const controlId = \"gl-filter-\" + filterDef.id;\r\n            control.id = controlId;\r\n            labelEl.setAttribute(\"for\", controlId);\r\n        }\r\n\r\n        wrapper.appendChild(control);\r\n        return wrapper;\r\n    };\r\n\r\n})(window);\r\n\r\n/**\r\n * Fonctions globales pour le chargement lazy des filtres\r\n * Utilis√©es par le lazy-loader pour construire le contenu √† la demande\r\n */\r\n\r\n/**\r\n * Construit le contenu HTML de l'arbre de cat√©gories\r\n * @param {Object} scanResult - R√©sultat du scan ({usedIds: Set, visibleLayerIds: Array})\r\n * @returns {string} HTML string\r\n */\r\nwindow._buildCategoryTreeContent = function(scanResult) {\r\n    // R√©cup√©rer le profil actif via l'API Config (enrichedProfile contient taxonomy)\r\n    const profile = (GeoLeaf.Config && typeof GeoLeaf.Config.getActiveProfile === \"function\")\r\n        ? GeoLeaf.Config.getActiveProfile()\r\n        : null;\r\n    if (!profile || !profile.taxonomy || !profile.taxonomy.categories) {\r\n        return '<div class=\"gl-empty-state\">Aucune cat√©gorie disponible</div>';\r\n    }\r\n\r\n    const categories = profile.taxonomy.categories;\r\n    const usedCategoryIds = scanResult.usedIds;\r\n\r\n    // S√©curit√© : √©chapper les valeurs dynamiques inject√©es dans le HTML\r\n    const esc = (GeoLeaf.Security && typeof GeoLeaf.Security.escapeHtml === 'function')\r\n        ? function(s) { return GeoLeaf.Security.escapeHtml(s); }\r\n        : function(s) { return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;'); };\r\n\r\n    // Comparaison insensible √† la casse : normaliser les IDs scann√©s\r\n    const usedLower = new Set();\r\n    usedCategoryIds.forEach(function(id) { usedLower.add(id.toLowerCase()); });\r\n\r\n    // Filtrer les cat√©gories pour afficher celles utilis√©es (comparaison case-insensitive)\r\n    const catIds = Object.keys(categories).filter(catId => usedLower.has(catId.toLowerCase()));\r\n\r\n    if (catIds.length === 0) {\r\n        return '<div class=\"gl-empty-state\">ND - Non disponible</div>';\r\n    }\r\n\r\n    let html = '<ul class=\"gl-filter-tree gl-filter-tree--root\">';\r\n\r\n    catIds.forEach(function(catId) {\r\n        const cat = categories[catId] || {};\r\n\r\n        // Filtrer aussi les sous-cat√©gories (comparaison case-insensitive)\r\n        const subs = cat.subcategories || {};\r\n        const subKeys = Object.keys(subs).filter(subId => usedLower.has(subId.toLowerCase()));\r\n        const hasSubcategories = subKeys.length > 0;\r\n\r\n        html += '<li class=\"gl-filter-tree__item gl-filter-tree__item--category\">';\r\n        html += '<div class=\"gl-filter-tree__row\">';\r\n\r\n        if (hasSubcategories) {\r\n            html += '<span class=\"gl-filter-tree__arrow\" data-category-id=\"' + esc(catId) + '\">‚ñ∂</span>';\r\n        } else {\r\n            html += '<span class=\"gl-filter-tree__spacer\"></span>';\r\n        }\r\n\r\n        html += '<label class=\"gl-filter-tree__label gl-filter-tree__label--category\">';\r\n        html += '<input type=\"checkbox\" class=\"gl-filter-tree__checkbox gl-filter-tree__checkbox--category\" ';\r\n        html += 'name=\"categories_category\" value=\"' + esc(catId) + '\" ';\r\n        html += 'data-gl-filter-category-id=\"' + esc(catId) + '\">';\r\n        html += '<span class=\"gl-filter-tree__text\">' + esc(cat.label || catId) + '</span>';\r\n        html += '</label>';\r\n        html += '</div>';\r\n\r\n        if (hasSubcategories) {\r\n            html += '<ul class=\"gl-filter-tree gl-filter-tree--subcategories\">';\r\n\r\n            subKeys.forEach(function(subId) {\r\n                const sub = subs[subId] || {};\r\n                html += '<li class=\"gl-filter-tree__item gl-filter-tree__item--subcategory\">';\r\n                html += '<label class=\"gl-filter-tree__label gl-filter-tree__label--subcategory\">';\r\n                html += '<input type=\"checkbox\" class=\"gl-filter-tree__checkbox gl-filter-tree__checkbox--subcategory\" ';\r\n                html += 'name=\"categories_subcategory\" value=\"' + esc(subId) + '\" ';\r\n                html += 'data-gl-filter-category-id=\"' + esc(catId) + '\" ';\r\n                html += 'data-gl-filter-subcategory-id=\"' + esc(subId) + '\">';\r\n                html += '<span class=\"gl-filter-tree__text\">' + esc(sub.label || subId) + '</span>';\r\n                html += '</label>';\r\n                html += '</li>';\r\n            });\r\n\r\n            html += '</ul>';\r\n        }\r\n\r\n        html += '</li>';\r\n    });\r\n\r\n    html += '</ul>';\r\n    return html;\r\n};\r\n\r\n/**\r\n * Construit le contenu HTML de la liste de tags\r\n * @param {Array} tags - Array de tags uniques tri√©s\r\n * @returns {string} HTML string\r\n */\r\nwindow._buildTagsListContent = function(tags) {\r\n    if (!tags || tags.length === 0) {\r\n        return '<div class=\"gl-empty-state\">ND - Non disponible</div>';\r\n    }\r\n\r\n    // S√©curit√© : √©chapper les valeurs dynamiques\r\n    const esc = (GeoLeaf.Security && typeof GeoLeaf.Security.escapeHtml === 'function')\r\n        ? function(s) { return GeoLeaf.Security.escapeHtml(s); }\r\n        : function(s) { return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;'); };\r\n\r\n    let html = '';\r\n    tags.forEach(function(tag) {\r\n        html += '<span class=\"gl-filter-panel__tag-badge\" data-tag-value=\"' + esc(tag) + '\">' + esc(tag) + '</span>';\r\n    });\r\n\r\n    return html;\r\n};\r\n\r\n/**\r\n * Attache les event listeners pour l'arbre de cat√©gories apr√®s rendering\r\n * @param {HTMLElement} container - Container de l'arbre\r\n */\r\nwindow._attachCategoryTreeListeners = function(container) {\r\n    // Event listeners pour les fl√®ches d'expansion\r\n    const arrows = container.querySelectorAll('.gl-filter-tree__arrow');\r\n    arrows.forEach(function(arrow) {\r\n        arrow.addEventListener('click', function(e) {\r\n            e.stopPropagation();\r\n            const li = this.closest('.gl-filter-tree__item--category');\r\n            const subList = li.querySelector('.gl-filter-tree--subcategories');\r\n            if (subList) {\r\n                const isExpanded = li.classList.contains('is-expanded');\r\n                if (isExpanded) {\r\n                    li.classList.remove('is-expanded');\r\n                    this.textContent = '‚ñ∂';\r\n                } else {\r\n                    li.classList.add('is-expanded');\r\n                    this.textContent = '‚ñº';\r\n                }\r\n            }\r\n        });\r\n    });\r\n\r\n    // Event listeners pour les checkboxes de cat√©gorie (parent)\r\n    const categoryCheckboxes = container.querySelectorAll('.gl-filter-tree__checkbox--category');\r\n    categoryCheckboxes.forEach(function(inputCat) {\r\n        inputCat.addEventListener('change', function() {\r\n            const li = this.closest('.gl-filter-tree__item--category');\r\n            const subCheckboxes = li.querySelectorAll('.gl-filter-tree__checkbox--subcategory');\r\n            subCheckboxes.forEach(function(subCb) {\r\n                subCb.checked = inputCat.checked;\r\n            });\r\n            inputCat.indeterminate = false;\r\n        });\r\n    });\r\n\r\n    // Event listeners pour les checkboxes de sous-cat√©gorie (enfant)\r\n    const subcategoryCheckboxes = container.querySelectorAll('.gl-filter-tree__checkbox--subcategory');\r\n    subcategoryCheckboxes.forEach(function(inputSub) {\r\n        inputSub.addEventListener('change', function() {\r\n            const liCat = this.closest('.gl-filter-tree__item--category');\r\n            const categoryCheckbox = liCat.querySelector('.gl-filter-tree__checkbox--category');\r\n            const subCheckboxes = liCat.querySelectorAll('.gl-filter-tree__checkbox--subcategory');\r\n\r\n            const checkedCount = Array.from(subCheckboxes).filter(cb => cb.checked).length;\r\n            const totalCount = subCheckboxes.length;\r\n\r\n            if (checkedCount === 0) {\r\n                categoryCheckbox.checked = false;\r\n                categoryCheckbox.indeterminate = false;\r\n            } else if (checkedCount === totalCount) {\r\n                categoryCheckbox.checked = true;\r\n                categoryCheckbox.indeterminate = false;\r\n            } else {\r\n                categoryCheckbox.checked = false;\r\n                categoryCheckbox.indeterminate = true;\r\n            }\r\n        });\r\n    });\r\n};\r\n\r\n/**\r\n * Attache les event listeners pour les tags apr√®s rendering\r\n * @param {HTMLElement} container - Container des tags\r\n */\r\nwindow._attachTagsListeners = function(container) {\r\n    const badges = container.querySelectorAll('.gl-filter-panel__tag-badge');\r\n    badges.forEach(function(badge) {\r\n        badge.addEventListener('click', function() {\r\n            this.classList.toggle('is-selected');\r\n        });\r\n    });\r\n};\r\n","/**\r\n * GeoLeaf UI Filter Panel - Shared Helpers\r\n * Fonctions utilitaires partag√©es pour le panneau de filtres\r\n *\r\n * @module ui/filter-panel/shared\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n\r\n    // D√©pendances lazy\r\n    const getLog = () => (GeoLeaf.Log || console);\r\n\r\n    GeoLeaf._UIFilterPanelShared = GeoLeaf._UIFilterPanelShared || {};\r\n\r\n    // ========================================\r\n    //   CONVERSION DE FEATURES\r\n    // ========================================\r\n\r\n    /**\r\n     * Convertit une feature GeoJSON Point en objet POI-like\r\n     * @param {Object} feature - Feature GeoJSON\r\n     * @returns {Object|null} - POI-like ou null\r\n     */\r\n    GeoLeaf._UIFilterPanelShared.featureToPoiLike = function(feature) {\r\n        if (!feature || !feature.geometry || !feature.properties) return null;\r\n\r\n        const geom = feature.geometry;\r\n        if (!geom || geom.type?.toLowerCase().indexOf(\"point\") === -1) return null;\r\n\r\n        const coords = Array.isArray(geom.coordinates) ? geom.coordinates : null;\r\n        const latlng = coords && coords.length >= 2 ? [coords[1], coords[0]] : null;\r\n        const props = feature.properties || {};\r\n        const poi = Object.assign({}, props);\r\n\r\n        if (!poi.title && props.name) poi.title = props.name;\r\n        if (!poi.id && feature.id) poi.id = feature.id;\r\n        if (!poi.latlng && latlng) poi.latlng = latlng;\r\n        if (!poi.attributes && props.attributes) poi.attributes = props.attributes;\r\n\r\n        return poi;\r\n    };\r\n\r\n    /**\r\n     * Convertit une feature GeoJSON LineString en objet Route-like\r\n     * @param {Object} feature - Feature GeoJSON\r\n     * @returns {Object|null} - Route-like ou null\r\n     */\r\n    GeoLeaf._UIFilterPanelShared.featureToRouteLike = function(feature) {\r\n        if (!feature || !feature.geometry || !feature.properties) return null;\r\n\r\n        const geom = feature.geometry;\r\n        if (!geom || geom.type?.toLowerCase().indexOf(\"line\") === -1) return null;\r\n\r\n        const props = feature.properties || {};\r\n\r\n        // Exclude protected areas (aires_prot√©g√©es_nationales) - they should not be treated as routes/itineraries\r\n        // Protected areas have minimal properties: fid, Name, region only\r\n        const hasOtherProperties = Object.keys(props).some(key =>\r\n            !['fid', 'name', 'Name', 'region', 'REGION', 'Region'].includes(key)\r\n        );\r\n        if (!hasOtherProperties && (props.fid !== undefined || props.Name)) {\r\n            // Likely a protected area, not an itinerary\r\n            return null;\r\n        }\r\n\r\n        const route = Object.assign({}, props);\r\n\r\n        if (!route.title && props.name) route.title = props.name;\r\n        if (!route.id && feature.id) route.id = feature.id;\r\n        route.geometry = geom;\r\n\r\n        return route;\r\n    };\r\n\r\n    // ========================================\r\n    //   R√âCUP√âRATION DES DONN√âES\r\n    // ========================================\r\n\r\n    /**\r\n     * R√©cup√®re tous les POI depuis les diff√©rentes sources\r\n     * @returns {Array} - Liste des POI\r\n     */\r\n    GeoLeaf._UIFilterPanelShared.getBasePois = function() {\r\n        const Log = getLog();\r\n        const featureToPoiLike = GeoLeaf._UIFilterPanelShared.featureToPoiLike;\r\n\r\n        // 1) Prendre depuis GeoJSON (mode layers-only) si dispo\r\n        try {\r\n            if (GeoLeaf.GeoJSON && typeof GeoLeaf.GeoJSON.getFeatures === \"function\") {\r\n                const feats = GeoLeaf.GeoJSON.getFeatures({ geometryTypes: [\"point\"] }) || [];\r\n                const pois = feats.map(featureToPoiLike).filter(Boolean);\r\n                if (pois.length) return pois;\r\n            }\r\n        } catch (err) {\r\n            Log.warn(\"[GeoLeaf.UI.FilterPanel] Erreur r√©cup√©ration POI via GeoJSON:\", err);\r\n        }\r\n\r\n        // 2) Config active (legacy)\r\n        try {\r\n            if (GeoLeaf.Config) {\r\n                if (typeof GeoLeaf.Config.get === \"function\") {\r\n                    const fromGet = GeoLeaf.Config.get(\"poi\");\r\n                    if (Array.isArray(fromGet)) return fromGet;\r\n                }\r\n                if (Array.isArray(GeoLeaf.Config._activeProfileData?.poi)) {\r\n                    return GeoLeaf.Config._activeProfileData.poi;\r\n                }\r\n            }\r\n        } catch (err) {\r\n            Log.warn(\"[GeoLeaf.UI.FilterPanel] Erreur r√©cup√©ration POI via Config:\", err);\r\n        }\r\n\r\n        // 3) Fallback d√©mo\r\n        if (global.cfg && Array.isArray(global.cfg.poi)) {\r\n            return global.cfg.poi;\r\n        }\r\n\r\n        return [];\r\n    };\r\n\r\n    /**\r\n     * R√©cup√®re toutes les routes depuis les diff√©rentes sources\r\n     * @returns {Array} - Liste des routes\r\n     */\r\n    GeoLeaf._UIFilterPanelShared.getBaseRoutes = function() {\r\n        const Log = getLog();\r\n        const featureToRouteLike = GeoLeaf._UIFilterPanelShared.featureToRouteLike;\r\n\r\n        // 1) Via GeoJSON (layers-only)\r\n        try {\r\n            if (GeoLeaf.GeoJSON && typeof GeoLeaf.GeoJSON.getFeatures === \"function\") {\r\n                const feats = GeoLeaf.GeoJSON.getFeatures({ geometryTypes: [\"line\", \"linestring\", \"multilinestring\"] }) || [];\r\n                const routes = feats.map(featureToRouteLike).filter(Boolean);\r\n                if (routes.length) return routes;\r\n            }\r\n        } catch (err) {\r\n            Log.warn(\"[GeoLeaf.UI.FilterPanel] Erreur r√©cup√©ration routes via GeoJSON:\", err);\r\n        }\r\n\r\n        // 2) Config active (legacy)\r\n        try {\r\n            if (GeoLeaf.Config) {\r\n                if (typeof GeoLeaf.Config.get === \"function\") {\r\n                    const fromGet = GeoLeaf.Config.get(\"routes\");\r\n                    if (Array.isArray(fromGet)) return fromGet;\r\n                }\r\n                if (Array.isArray(GeoLeaf.Config._activeProfileData?.routes)) {\r\n                    return GeoLeaf.Config._activeProfileData.routes;\r\n                }\r\n            }\r\n        } catch (err) {\r\n            Log.warn(\"[GeoLeaf.UI.FilterPanel] Erreur r√©cup√©ration routes via Config:\", err);\r\n        }\r\n\r\n        // 3) Fallback d√©mo\r\n        if (global.cfg && Array.isArray(global.cfg.routes)) {\r\n            return global.cfg.routes;\r\n        }\r\n\r\n        return [];\r\n    };\r\n\r\n    // ========================================\r\n    //   UTILITAIRES\r\n    // ========================================\r\n\r\n    /**\r\n     * Retourne l'√©l√©ment DOM du panneau de filtres.\r\n     * Priorit√© au conteneur flottant #gl-filter-panel, puis fallback #gl-left-panel.\r\n     * @returns {HTMLElement|null}\r\n     */\r\n    GeoLeaf._UIFilterPanelShared.getFilterPanelElement = function() {\r\n        let el = document.getElementById(\"gl-filter-panel\");\r\n        if (el) return el;\r\n\r\n        el = document.getElementById(\"gl-left-panel\");\r\n        if (el) return el;\r\n\r\n        const Log = getLog();\r\n        Log.warn(\"[GeoLeaf.UI.FilterPanel] Aucun conteneur de panneau de filtres trouv√© (#gl-filter-panel / #gl-left-panel).\");\r\n\r\n        return null;\r\n    };\r\n\r\n    /**\r\n     * Acc√®de √† une propri√©t√© imbriqu√©e (ex: \"attributes.nom\")\r\n     * @param {Object} obj - Objet source\r\n     * @param {string} path - Chemin vers la propri√©t√©\r\n     * @returns {*} - Valeur ou null\r\n     */\r\n    GeoLeaf._UIFilterPanelShared.getNestedValue = function(obj, path) {\r\n        if (!obj || !path) return null;\r\n        const keys = path.split('.');\r\n        let value = obj;\r\n        for (let i = 0; i < keys.length; i++) {\r\n            if (value === null || value === undefined) return null;\r\n            value = value[keys[i]];\r\n        }\r\n        return value;\r\n    };\r\n\r\n    /**\r\n     * Extrait un point repr√©sentatif d'une g√©om√©trie (pour calcul de distance)\r\n     * @param {Object} geometry - G√©om√©trie GeoJSON\r\n     * @returns {Object|null} - { lat, lng } ou null\r\n     */\r\n    GeoLeaf._UIFilterPanelShared.getRepresentativePoint = function(geometry) {\r\n        if (!geometry || !geometry.coordinates) return null;\r\n\r\n        if (geometry.type === 'Polygon' || geometry.type === 'MultiPolygon') {\r\n            // Pour un polygone, utiliser le premier point du premier anneau\r\n            const coords = geometry.type === 'Polygon'\r\n                ? geometry.coordinates[0][0]\r\n                : geometry.coordinates[0][0][0];\r\n            return coords ? { lng: coords[0], lat: coords[1] } : null;\r\n\r\n        } else if (geometry.type === 'LineString') {\r\n            // Pour une ligne, utiliser le point du milieu\r\n            const coords = geometry.coordinates;\r\n            if (coords && coords.length > 0) {\r\n                const midIndex = Math.floor(coords.length / 2);\r\n                return { lng: coords[midIndex][0], lat: coords[midIndex][1] };\r\n            }\r\n\r\n        } else if (geometry.type === 'MultiLineString') {\r\n            // Pour multi-ligne, utiliser le point du milieu de la premi√®re ligne\r\n            const coords = geometry.coordinates[0];\r\n            if (coords && coords.length > 0) {\r\n                const midIndex = Math.floor(coords.length / 2);\r\n                return { lng: coords[midIndex][0], lat: coords[midIndex][1] };\r\n            }\r\n\r\n        } else if (geometry.type === 'Point') {\r\n            return { lng: geometry.coordinates[0], lat: geometry.coordinates[1] };\r\n\r\n        } else if (geometry.type === 'MultiPoint') {\r\n            // Pour multi-point, utiliser le premier point\r\n            const coords = geometry.coordinates[0];\r\n            return coords ? { lng: coords[0], lat: coords[1] } : null;\r\n        }\r\n\r\n        return null;\r\n    };\r\n\r\n    /**\r\n     * Collecte tous les tags uniques depuis une liste d'items\r\n     * @param {Array} items - Liste d'items (POI, routes)\r\n     * @returns {Array} - Tags uniques tri√©s\r\n     */\r\n    GeoLeaf._UIFilterPanelShared.collectAllTags = function(items) {\r\n        const tagSet = new Set();\r\n\r\n        items.forEach(function(item) {\r\n            // Support GeoJSON properties.attributes.tags, item.attributes.tags, et item.tags\r\n            const props = item.properties || item;\r\n            const attrs = props.attributes || item.attributes || {};\r\n            const tags = attrs.tags || props.tags || item.tags;\r\n\r\n            if (Array.isArray(tags) && tags.length > 0) {\r\n                tags.forEach(function(t) {\r\n                    if (t && typeof t === \"string\") {\r\n                        tagSet.add(t);\r\n                    }\r\n                });\r\n            }\r\n        });\r\n\r\n        const arr = Array.from(tagSet);\r\n        arr.sort();\r\n        return arr;\r\n    };\r\n\r\n})(window);\r\n","/**\n * GeoLeaf UI Filter Panel - State Reader\n * Lecture de l'√©tat des filtres depuis le DOM\n *\n * @module ui/filter-panel/state-reader\n */\n(function (global) {\n    \"use strict\";\n\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\n\n    GeoLeaf._UIFilterPanelStateReader = GeoLeaf._UIFilterPanelStateReader || {};\n\n    /**\n     * Structure par d√©faut de l'√©tat des filtres\n     * @returns {Object}\n     */\n    GeoLeaf._UIFilterPanelStateReader.getDefaultState = function() {\n        return {\n            categoriesTree: [],\n            subCategoriesTree: [],\n            minRating: NaN,\n            hasMinRating: false,\n            selectedTags: [],\n            hasTags: false,\n            dataTypes: { poi: true, routes: true },\n            searchText: \"\",\n            hasSearchText: false,\n            proximity: {\n                active: false,\n                center: null,\n                radius: 10\n            }\n        };\n    };\n\n    /**\n     * Lit l'√©tat actuel des filtres depuis le panneau DOM\n     * @param {HTMLElement} panelEl - √âl√©ment du panneau de filtres\n     * @returns {Object} - √âtat des filtres\n     */\n    GeoLeaf._UIFilterPanelStateReader.readFiltersFromPanel = function(panelEl) {\n        const state = GeoLeaf._UIFilterPanelStateReader.getDefaultState();\n\n        if (!panelEl) return state;\n\n        // Types de donn√©es (POI / Routes)\n        const poiCheckbox = panelEl.querySelector(\n            \"[data-gl-filter-id='dataTypes'] input[value='poi']\"\n        );\n        const routesCheckbox = panelEl.querySelector(\n            \"[data-gl-filter-id='dataTypes'] input[value='routes']\"\n        );\n        if (poiCheckbox) state.dataTypes.poi = poiCheckbox.checked;\n        if (routesCheckbox) state.dataTypes.routes = routesCheckbox.checked;\n\n        // Recherche textuelle\n        const searchInput = panelEl.querySelector(\n            \"[data-gl-filter-id='searchText'] input[type='text']\"\n        );\n        if (searchInput && searchInput.value.trim() !== \"\") {\n            state.searchText = searchInput.value.trim().toLowerCase();\n            state.hasSearchText = true;\n        }\n\n        // Proximit√©\n        const proximityContainer = panelEl.querySelector(\n            \"[data-gl-filter-id='proximity']\"\n        );\n        if (proximityContainer) {\n            const isActive = proximityContainer.getAttribute(\"data-proximity-active\") === \"true\";\n            const lat = parseFloat(proximityContainer.getAttribute(\"data-proximity-lat\"));\n            const lng = parseFloat(proximityContainer.getAttribute(\"data-proximity-lng\"));\n            const radius = parseFloat(proximityContainer.getAttribute(\"data-proximity-radius\"));\n\n            if (isActive && !isNaN(lat) && !isNaN(lng) && !isNaN(radius)) {\n                state.proximity.active = true;\n                state.proximity.center = { lat: lat, lng: lng };\n                state.proximity.radius = radius;\n            }\n        }\n\n        // Tree-view : cat√©gories coch√©es\n        panelEl\n            .querySelectorAll(\"input.gl-filter-tree__checkbox--category:checked\")\n            .forEach(function(input) {\n                const val = input.value;\n                if (val) {\n                    state.categoriesTree.push(String(val));\n                }\n            });\n\n        // Tree-view : sous-cat√©gories coch√©es\n        panelEl\n            .querySelectorAll(\"input.gl-filter-tree__checkbox--subcategory:checked\")\n            .forEach(function(input) {\n                const subId = input.getAttribute(\"data-gl-filter-subcategory-id\");\n                if (subId) {\n                    state.subCategoriesTree.push(String(subId));\n                }\n            });\n\n        // Slider de note minimale\n        const ratingInput = panelEl.querySelector(\n            \"[data-gl-filter-id='minRating'] input[type='range']\"\n        );\n        if (ratingInput && ratingInput.value !== \"\") {\n            const val = parseFloat(ratingInput.value);\n            if (!isNaN(val)) {\n                state.minRating = val;\n                state.hasMinRating = val > 0;\n            }\n        }\n\n        // Tags s√©lectionn√©s (badges)\n        const tagsContainer = panelEl.querySelector(\n            \"[data-gl-filter-id='tags'] .gl-filter-panel__tags-container\"\n        );\n        if (tagsContainer) {\n            const selectedBadges = tagsContainer.querySelectorAll(\n                \".gl-filter-panel__tag-badge.is-selected\"\n            );\n            const selected = Array.from(selectedBadges).map(function(badge) {\n                return badge.getAttribute(\"data-tag-value\");\n            }).filter(Boolean);\n            state.selectedTags = selected;\n            state.hasTags = selected.length > 0;\n        }\n\n        return state;\n    };\n\n    /**\n     * R√©initialise les contr√¥les du panneau de filtres √† leur √©tat par d√©faut\n     * @param {HTMLElement} panelEl - √âl√©ment du panneau de filtres\n     */\n    GeoLeaf._UIFilterPanelStateReader.resetControls = function(panelEl) {\n        if (!panelEl) return;\n\n        // Checkbox-group (POI/Routes) - reset to checked by default\n        const dataTypesCheckboxes = panelEl.querySelectorAll(\n            \"[data-gl-filter-id='dataTypes'] input[type='checkbox']\"\n        );\n        dataTypesCheckboxes.forEach(function(input) {\n            input.checked = true;\n        });\n\n        // Search text input\n        const searchInput = panelEl.querySelector(\n            \"[data-gl-filter-id='searchText'] input[type='text']\"\n        );\n        if (searchInput) {\n            searchInput.value = \"\";\n        }\n\n        // Proximit√©\n        const proximityWrapper = panelEl.querySelector(\n            \"[data-gl-filter-id='proximity']\"\n        );\n        if (proximityWrapper) {\n            proximityWrapper.removeAttribute(\"data-proximity-active\");\n            proximityWrapper.removeAttribute(\"data-proximity-lat\");\n            proximityWrapper.removeAttribute(\"data-proximity-lng\");\n            proximityWrapper.removeAttribute(\"data-proximity-radius\");\n\n            const btn = proximityWrapper.querySelector(\".gl-filter-panel__proximity-btn\");\n            if (btn) {\n                btn.classList.remove(\"is-active\");\n                btn.textContent = btn.getAttribute(\"data-label-inactive\") || \"Activer\";\n            }\n\n            const rangeWrapper = proximityWrapper.querySelector(\".gl-filter-panel__proximity-range\");\n            if (rangeWrapper) {\n                rangeWrapper.style.display = \"none\";\n            }\n\n            const instruction = proximityWrapper.querySelector(\".gl-filter-panel__proximity-instruction\");\n            if (instruction) {\n                instruction.style.display = \"none\";\n            }\n\n            // Supprimer le cercle et le marqueur de la carte\n            if (GeoLeaf.UI && GeoLeaf.UI._proximityCircle && GeoLeaf.UI._proximityMap) {\n                GeoLeaf.UI._proximityMap.removeLayer(GeoLeaf.UI._proximityCircle);\n                GeoLeaf.UI._proximityCircle = null;\n            }\n            if (GeoLeaf.UI && GeoLeaf.UI._proximityMarker && GeoLeaf.UI._proximityMap) {\n                GeoLeaf.UI._proximityMap.removeLayer(GeoLeaf.UI._proximityMarker);\n                GeoLeaf.UI._proximityMarker = null;\n            }\n            if (GeoLeaf.UI) {\n                GeoLeaf.UI._proximityMode = false;\n            }\n        }\n\n        // Checkboxes du tree-view (cat√©gories & sous-cat√©gories)\n        panelEl\n            .querySelectorAll(\".gl-filter-tree__checkbox\")\n            .forEach(function(input) {\n                input.checked = false;\n            });\n\n        // Tags - d√©s√©lectionner tous les badges\n        const tagBadges = panelEl.querySelectorAll(\n            \".gl-filter-panel__tag-badge.is-selected\"\n        );\n        tagBadges.forEach(function(badge) {\n            badge.classList.remove(\"is-selected\");\n        });\n\n        // Select classiques\n        panelEl\n            .querySelectorAll(\"select.gl-filter-panel__control--select\")\n            .forEach(function(sel) {\n                if (sel.multiple) {\n                    Array.from(sel.options).forEach(function(opt) {\n                        opt.selected = false;\n                    });\n                } else {\n                    sel.value = \"\";\n                }\n            });\n\n        // Slider note\n        const ratingInput = panelEl.querySelector(\n            \"[data-gl-filter-id='minRating'] input[type='range']\"\n        );\n        const ratingLabel = panelEl.querySelector(\n            \"[data-gl-filter-id='minRating'] .gl-filter-panel__range-value\"\n        );\n        if (ratingInput) {\n            const min = ratingInput.min !== \"\" ? ratingInput.min : \"0\";\n            ratingInput.value = min;\n            if (ratingLabel) {\n                ratingLabel.textContent = String(min).replace(\".\", \",\");\n            }\n        }\n    };\n\n})(window);\n","/**\r\n * GeoLeaf UI Filter Panel - Lazy Loader\r\n * Chargement √† la demande des filtres cat√©gories et tags\r\n *\r\n * @module ui/filter-panel/lazy-loader\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    const Log = GeoLeaf.Log || console;\r\n\r\n    GeoLeaf._UIFilterPanelLazyLoader = {\r\n        _cache: {},\r\n        _openAccordions: new Set(),\r\n\r\n        /**\r\n         * Charge les cat√©gories pour le th√®me actif\r\n         * @param {string} themeId - ID du th√®me\r\n         * @returns {Array} - Array de cat√©gories avec leurs sous-cat√©gories\r\n         */\r\n        loadCategories(themeId) {\r\n            const cacheKey = `categories_${themeId}`;\r\n\r\n            if (this._cache[cacheKey]) {\r\n                Log.debug(\"[LazyLoader] Cache HIT pour cat√©gories:\", themeId);\r\n                return this._cache[cacheKey];\r\n            }\r\n\r\n            Log.debug(\"[LazyLoader] Cache MISS pour cat√©gories, scan en cours...\");\r\n            const result = this._scanCategories(themeId);\r\n            this._cache[cacheKey] = result;\r\n            return result;\r\n        },\r\n\r\n        /**\r\n         * Charge les tags pour le th√®me actif\r\n         * @param {string} themeId - ID du th√®me\r\n         * @returns {Array} - Array de tags uniques\r\n         */\r\n        loadTags(themeId) {\r\n            const cacheKey = `tags_${themeId}`;\r\n\r\n            if (this._cache[cacheKey]) {\r\n                Log.debug(\"[LazyLoader] Cache HIT pour tags:\", themeId);\r\n                return this._cache[cacheKey];\r\n            }\r\n\r\n            Log.debug(\"[LazyLoader] Cache MISS pour tags, scan en cours...\");\r\n            const result = this._scanTags(themeId);\r\n            this._cache[cacheKey] = result;\r\n            return result;\r\n        },\r\n\r\n        /**\r\n         * Scanne les features pour extraire les cat√©gories utilis√©es\r\n         * @private\r\n         * @param {string} themeId - ID du th√®me\r\n         * @returns {Object} - {categories: Map, usedIds: Set}\r\n         */\r\n        _scanCategories(themeId) {\r\n            const startTime = performance.now();\r\n\r\n            // R√©cup√©rer les couches visibles du th√®me\r\n            const visibleLayerIds = this._getVisibleLayerIds(themeId);\r\n\r\n            // R√©cup√©rer toutes les features\r\n            let allFeatures = [];\r\n            try {\r\n                if (GeoLeaf.GeoJSON && typeof GeoLeaf.GeoJSON.getFeatures === \"function\") {\r\n                    allFeatures = GeoLeaf.GeoJSON.getFeatures() || [];\r\n                }\r\n            } catch (err) {\r\n                Log.warn(\"[LazyLoader] Erreur r√©cup√©ration features:\", err);\r\n                return { categories: new Map(), usedIds: new Set() };\r\n            }\r\n\r\n            // Filtrer par couches visibles\r\n            const visibleFeatures = allFeatures.filter(feature => {\r\n                const layerId = feature.properties?._layerId || feature.properties?.layerId || feature._layerId;\r\n                return visibleLayerIds.includes(layerId);\r\n            });\r\n\r\n            Log.debug(`[LazyLoader] Scan cat√©gories: ${visibleFeatures.length} features sur ${visibleLayerIds.length} couches actives`);\r\n\r\n            // Extraire les cat√©gories uniques (normalisation lowercase + variantes camelCase)\r\n            const usedCategoryIds = new Set();\r\n            visibleFeatures.forEach(feature => {\r\n                const props = feature.properties || {};\r\n                if (props.categoryId) {\r\n                    usedCategoryIds.add(props.categoryId);\r\n                }\r\n                if (props.subcategoryId) {\r\n                    usedCategoryIds.add(props.subcategoryId);\r\n                }\r\n                // Variante camelCase (subCategoryId) pr√©sente dans certains GeoJSON\r\n                if (props.subCategoryId) {\r\n                    usedCategoryIds.add(props.subCategoryId);\r\n                }\r\n            });\r\n\r\n            const elapsed = (performance.now() - startTime).toFixed(2);\r\n            Log.info(`[LazyLoader] Scan cat√©gories termin√© en ${elapsed}ms: ${usedCategoryIds.size} cat√©gories trouv√©es`);\r\n\r\n            return {\r\n                usedIds: usedCategoryIds,\r\n                visibleLayerIds: visibleLayerIds\r\n            };\r\n        },\r\n\r\n        /**\r\n         * Scanne les features pour extraire les tags utilis√©s\r\n         * @private\r\n         * @param {string} themeId - ID du th√®me\r\n         * @returns {Array} - Array de tags tri√©s\r\n         */\r\n        _scanTags(themeId) {\r\n            const startTime = performance.now();\r\n\r\n            // R√©cup√©rer les couches visibles du th√®me\r\n            const visibleLayerIds = this._getVisibleLayerIds(themeId);\r\n\r\n            // R√©cup√©rer toutes les features\r\n            let allFeatures = [];\r\n            try {\r\n                if (GeoLeaf.GeoJSON && typeof GeoLeaf.GeoJSON.getFeatures === \"function\") {\r\n                    allFeatures = GeoLeaf.GeoJSON.getFeatures() || [];\r\n                }\r\n            } catch (err) {\r\n                Log.warn(\"[LazyLoader] Erreur r√©cup√©ration features:\", err);\r\n                return [];\r\n            }\r\n\r\n            // Filtrer par couches visibles\r\n            const visibleFeatures = allFeatures.filter(feature => {\r\n                const layerId = feature.properties?._layerId || feature.properties?.layerId || feature._layerId;\r\n                return visibleLayerIds.includes(layerId);\r\n            });\r\n\r\n            // Extraire les tags uniques\r\n            const tagSet = new Set();\r\n            visibleFeatures.forEach(feature => {\r\n                const props = feature.properties || {};\r\n                const attrs = props.attributes || {};\r\n                const tags = attrs.tags || props.tags;\r\n\r\n                if (Array.isArray(tags)) {\r\n                    tags.forEach(tag => {\r\n                        if (tag && typeof tag === \"string\") {\r\n                            tagSet.add(tag);\r\n                        }\r\n                    });\r\n                }\r\n            });\r\n\r\n            const tagsArray = Array.from(tagSet).sort();\r\n            const elapsed = (performance.now() - startTime).toFixed(2);\r\n\r\n            Log.info(`[LazyLoader] Scan tags termin√© en ${elapsed}ms:`, {\r\n                totalFeatures: allFeatures.length,\r\n                visibleFeatures: visibleFeatures.length,\r\n                tagsFound: tagsArray.length\r\n            });\r\n\r\n            return tagsArray;\r\n        },\r\n\r\n        /**\r\n         * R√©cup√®re les IDs des couches r√©ellement visibles sur la carte\r\n         * @private\r\n         * @param {string} themeId - ID du th√®me (non utilis√©, mais conserv√© pour compatibilit√©)\r\n         * @returns {Array} - Array d'IDs de couches avec visible: true\r\n         */\r\n        _getVisibleLayerIds(themeId) {\r\n            let visibleLayerIds = [];\r\n\r\n            try {\r\n                // R√©cup√©rer toutes les couches charg√©es\r\n                if (GeoLeaf.GeoJSON && typeof GeoLeaf.GeoJSON.getAllLayers === \"function\") {\r\n                    const allLayers = GeoLeaf.GeoJSON.getAllLayers();\r\n                    // Filtrer uniquement celles qui sont visibles (ON dans layer manager)\r\n                    visibleLayerIds = allLayers\r\n                        .filter(layer => layer.visible === true)\r\n                        .map(layer => layer.id);\r\n\r\n                    Log.debug(`[LazyLoader] ${visibleLayerIds.length} couches visibles trouv√©es:`, visibleLayerIds);\r\n                }\r\n            } catch (err) {\r\n                Log.warn(\"[LazyLoader] Erreur r√©cup√©ration couches visibles:\", err);\r\n            }\r\n\r\n            return visibleLayerIds;\r\n        },\r\n\r\n        /**\r\n         * Marque un accord√©on comme ouvert\r\n         * @param {string} type - 'categories' ou 'tags'\r\n         * @param {HTMLElement} element - Element de l'accord√©on\r\n         */\r\n        markAccordionOpen(type, element) {\r\n            this._openAccordions.add({ type, element });\r\n            Log.debug(`[LazyLoader] Accord√©on \"${type}\" marqu√© comme ouvert`);\r\n        },\r\n\r\n        /**\r\n         * Marque un accord√©on comme ferm√©\r\n         * @param {HTMLElement} element - Element de l'accord√©on\r\n         */\r\n        markAccordionClosed(element) {\r\n            this._openAccordions.forEach(item => {\r\n                if (item.element === element) {\r\n                    this._openAccordions.delete(item);\r\n                    Log.debug(`[LazyLoader] Accord√©on \"${item.type}\" marqu√© comme ferm√©`);\r\n                }\r\n            });\r\n        },\r\n\r\n        /**\r\n         * Invalide le cache pour un th√®me sp√©cifique\r\n         * @param {string} themeId - ID du th√®me\r\n         */\r\n        invalidateCacheForTheme(themeId) {\r\n            delete this._cache[`categories_${themeId}`];\r\n            delete this._cache[`tags_${themeId}`];\r\n            Log.info(`[LazyLoader] Cache invalid√© pour th√®me: ${themeId}`);\r\n        },\r\n\r\n        /**\r\n         * Invalide tout le cache (changement de th√®me)\r\n         */\r\n        clearCache() {\r\n            this._cache = {};\r\n            Log.info(\"[LazyLoader] Cache compl√®tement vid√©\");\r\n        },\r\n\r\n        /**\r\n         * Rafra√Æchit les accord√©ons ouverts\r\n         * Utilis√© apr√®s un changement de th√®me ou toggle de couche\r\n         */\r\n        refreshOpenAccordions() {\r\n            if (this._openAccordions.size === 0) {\r\n                Log.debug(\"[LazyLoader] Aucun accord√©on ouvert √† rafra√Æchir\");\r\n                return;\r\n            }\r\n\r\n            Log.info(`[LazyLoader] Rafra√Æchissement de ${this._openAccordions.size} accord√©on(s) ouvert(s)`);\r\n            const currentTheme = GeoLeaf.ThemeSelector?.getCurrentTheme();\r\n\r\n            if (!currentTheme) {\r\n                Log.warn(\"[LazyLoader] Impossible de r√©cup√©rer le th√®me actif\");\r\n                return;\r\n            }\r\n\r\n            this._openAccordions.forEach(({ type, element }) => {\r\n                // Sauvegarder l'√©tat des checkboxes / tags s√©lectionn√©s\r\n                const savedStates = this._saveCheckboxStates(element);\r\n\r\n                // Cibler la zone [data-lazy-type] qui re√ßoit le innerHTML\r\n                const contentArea = element.querySelector('[data-lazy-type]');\r\n\r\n                if (!contentArea) {\r\n                    Log.warn(\"[LazyLoader] Zone [data-lazy-type] introuvable dans l'accord√©on\");\r\n                    return;\r\n                }\r\n\r\n                // R√©initialiser le flag lazyLoaded pour permettre un futur rechargement\r\n                element.dataset.lazyLoaded = \"false\";\r\n\r\n                // Appeler la fonction de render appropri√©e\r\n                if (type === 'categories') {\r\n                    this._rerenderCategories(contentArea, currentTheme, savedStates);\r\n                } else if (type === 'tags') {\r\n                    this._rerenderTags(contentArea, currentTheme, savedStates);\r\n                }\r\n\r\n                // Re-marquer comme charg√© apr√®s le re-render\r\n                element.dataset.lazyLoaded = \"true\";\r\n            });\r\n        },\r\n\r\n        /**\r\n         * Re-render les cat√©gories dans un accord√©on\r\n         * @private\r\n         */\r\n        _rerenderCategories(contentArea, themeId, savedStates) {\r\n            const result = this.loadCategories(themeId);\r\n\r\n            // Appeler la fonction globale de construction d'arbre\r\n            if (typeof window._buildCategoryTreeContent === \"function\") {\r\n                const content = window._buildCategoryTreeContent(result);\r\n                contentArea.innerHTML = content;\r\n\r\n                // Attacher les event listeners\r\n                if (typeof window._attachCategoryTreeListeners === \"function\") {\r\n                    window._attachCategoryTreeListeners(contentArea);\r\n                }\r\n\r\n                // Restaurer les √©tats des checkboxes\r\n                this._restoreCheckboxStates(contentArea, savedStates);\r\n            } else {\r\n                Log.warn(\"[LazyLoader] _buildCategoryTreeContent introuvable\");\r\n                contentArea.innerHTML = '<div class=\"gl-empty-state\">Erreur de chargement</div>';\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Re-render les tags dans un accord√©on\r\n         * @private\r\n         */\r\n        _rerenderTags(contentArea, themeId, savedStates) {\r\n            const tags = this.loadTags(themeId);\r\n\r\n            // Appeler la fonction globale de construction de liste\r\n            if (typeof window._buildTagsListContent === \"function\") {\r\n                const content = window._buildTagsListContent(tags);\r\n                contentArea.innerHTML = content;\r\n\r\n                // Attacher les event listeners\r\n                if (typeof window._attachTagsListeners === \"function\") {\r\n                    window._attachTagsListeners(contentArea);\r\n                }\r\n\r\n                // Restaurer les √©tats des checkboxes\r\n                this._restoreCheckboxStates(contentArea, savedStates);\r\n            } else {\r\n                Log.warn(\"[LazyLoader] _buildTagsListContent introuvable\");\r\n                contentArea.innerHTML = '<div class=\"gl-empty-state\">Erreur de chargement</div>';\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Sauvegarde l'√©tat des checkboxes avant re-render\r\n         * @private\r\n         */\r\n        _saveCheckboxStates(element) {\r\n            const states = {};\r\n            const checkboxes = element.querySelectorAll('input[type=\"checkbox\"]');\r\n\r\n            checkboxes.forEach(cb => {\r\n                const categoryId = cb.dataset.glFilterCategoryId;\r\n                const subcategoryId = cb.dataset.glFilterSubcategoryId;\r\n                const value = cb.value;\r\n\r\n                let key;\r\n                if (subcategoryId) {\r\n                    key = `${categoryId}:${subcategoryId}`;\r\n                } else if (categoryId) {\r\n                    key = categoryId;\r\n                } else if (value) {\r\n                    key = value;\r\n                }\r\n\r\n                if (key) {\r\n                    states[key] = cb.checked;\r\n                }\r\n            });\r\n\r\n            return states;\r\n        },\r\n\r\n        /**\r\n         * Restaure l'√©tat des checkboxes apr√®s re-render\r\n         * @private\r\n         */\r\n        _restoreCheckboxStates(element, savedStates) {\r\n            if (!savedStates || Object.keys(savedStates).length === 0) return;\r\n\r\n            const checkboxes = element.querySelectorAll('input[type=\"checkbox\"]');\r\n            let restoredCount = 0;\r\n\r\n            checkboxes.forEach(cb => {\r\n                const categoryId = cb.dataset.glFilterCategoryId;\r\n                const subcategoryId = cb.dataset.glFilterSubcategoryId;\r\n                const value = cb.value;\r\n\r\n                let key;\r\n                if (subcategoryId) {\r\n                    key = `${categoryId}:${subcategoryId}`;\r\n                } else if (categoryId) {\r\n                    key = categoryId;\r\n                } else if (value) {\r\n                    key = value;\r\n                }\r\n\r\n                if (key && savedStates[key] !== undefined) {\r\n                    cb.checked = savedStates[key];\r\n                    restoredCount++;\r\n                }\r\n            });\r\n\r\n            Log.debug(`[LazyLoader] ${restoredCount} √©tats de checkbox restaur√©s`);\r\n        }\r\n    };\r\n\r\n    // √âcouter les √©v√©nements de changement de th√®me\r\n    document.addEventListener('geoleaf:theme:applied', () => {\r\n        Log.info(\"[LazyLoader] √âv√©nement theme:applied d√©tect√© ‚Äî invalidation compl√®te\");\r\n\r\n        // 1. Vider le cache de donn√©es (scan cat√©gories/tags)\r\n        GeoLeaf._UIFilterPanelLazyLoader.clearCache();\r\n\r\n        // 2. R√©initialiser TOUS les flags data-lazy-loaded sur les accord√©ons\r\n        //    (ferm√©s ou ouverts) pour forcer un rechargement au prochain expand\r\n        const allAccordions = document.querySelectorAll('.gl-filter-panel__group--accordion[data-lazy-loaded]');\r\n        allAccordions.forEach(acc => {\r\n            acc.dataset.lazyLoaded = \"false\";\r\n        });\r\n        Log.debug(`[LazyLoader] ${allAccordions.length} flag(s) data-lazy-loaded r√©initialis√©(s)`);\r\n\r\n        // 3. Rafra√Æchir les accord√©ons actuellement ouverts (re-render imm√©diat)\r\n        GeoLeaf._UIFilterPanelLazyLoader.refreshOpenAccordions();\r\n    });\r\n\r\n    // √âcouter l'√©v√©nement de changement de visibilit√© de couche\r\n    document.addEventListener('geoleaf:geojson:visibility-changed', (e) => {\r\n        const detail = e.detail || {};\r\n        Log.info(\"[LazyLoader] Visibilit√© couche chang√©e:\", detail.layerId, detail.visible);\r\n\r\n        // Invalider le cache du th√®me actif\r\n        const currentTheme = GeoLeaf.ThemeSelector?.getCurrentTheme();\r\n        if (currentTheme) {\r\n            GeoLeaf._UIFilterPanelLazyLoader.invalidateCacheForTheme(currentTheme);\r\n            // Rafra√Æchir les accord√©ons ouverts\r\n            GeoLeaf._UIFilterPanelLazyLoader.refreshOpenAccordions();\r\n        }\r\n    });\r\n\r\n})(window);\r\n","/**\r\n * GeoLeaf UI Filter Panel - Applier\r\n * Application des filtres aux couches POI, Routes, GeoJSON\r\n *\r\n * @module ui/filter-panel/applier\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n\r\n    // D√©pendances lazy\r\n    const getLog = () => (GeoLeaf.Log || console);\r\n    const getShared = () => GeoLeaf._UIFilterPanelShared;\r\n    const getStateReader = () => GeoLeaf._UIFilterPanelStateReader;\r\n\r\n    GeoLeaf._UIFilterPanelApplier = GeoLeaf._UIFilterPanelApplier || {};\r\n\r\n    // Cache et optimisations pour les performances\r\n    let _cachedFilterState = null;\r\n    let _lastApplyTime = 0;\r\n    const APPLY_DEBOUNCE_DELAY = 300; // 300ms\r\n\r\n    // Fonction debounce pour l'application des filtres\r\n    let _applyFiltersTimeout = null;\r\n    let _lastSkipRoutes = false; // Store skipRoutes flag for debounced call\r\n    const _debouncedApplyFilters = function(panelEl, skipRoutes) {\r\n        if (_applyFiltersTimeout) {\r\n            clearTimeout(_applyFiltersTimeout);\r\n        }\r\n        _lastSkipRoutes = skipRoutes || false;\r\n        _applyFiltersTimeout = setTimeout(() => {\r\n            GeoLeaf._UIFilterPanelApplier._applyFiltersImmediate(panelEl, _lastSkipRoutes);\r\n        }, APPLY_DEBOUNCE_DELAY);\r\n    };\r\n\r\n    /**\r\n     * MEMORY LEAK FIX (Phase 2): Cleanup timeout on destroy\r\n     */\r\n    GeoLeaf._UIFilterPanelApplier.destroy = function() {\r\n        if (_applyFiltersTimeout) {\r\n            clearTimeout(_applyFiltersTimeout);\r\n            _applyFiltersTimeout = null;\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Rafra√Æchit la visibilit√© des POI selon la liste filtr√©e.\r\n     * IMPORTANT: Cette fonction filtre UNIQUEMENT les POI du syst√®me POI traditionnel.\r\n     * Les couches GeoJSON (point, line, polygon) sont g√©r√©es par filterGeoJSONLayers().\r\n     * On n'appelle PAS filterFeatures() ici pour √©viter de masquer les couches GeoJSON.\r\n     *\r\n     * @param {Array} filteredPois - Liste des POI √† afficher\r\n     */\r\n    GeoLeaf._UIFilterPanelApplier.refreshPoiLayer = function(filteredPois) {\r\n        const Log = getLog();\r\n\r\n        // V√©rifier si le syst√®me POI est activ√© dans la config\r\n        const Config = GeoLeaf.Config;\r\n        const poiConfig = (Config && typeof Config.get === 'function') ? Config.get('poiConfig') : null;\r\n        if (poiConfig && poiConfig.enabled === false) {\r\n            Log.debug(\"[GeoLeaf.UI.FilterPanel] Syst√®me POI d√©sactiv√©, pas de rafra√Æchissement de la couche POI.\");\r\n            return;\r\n        }\r\n\r\n        // Fallback: utiliser l'ancien syst√®me POI (si GeoJSON n'est pas disponible)\r\n        if (!GeoLeaf.POI) {\r\n            Log.warn(\"[GeoLeaf.UI.FilterPanel] GeoLeaf.POI indisponible, pas de rafra√Æchissement de la couche POI.\");\r\n            return;\r\n        }\r\n\r\n        if (typeof GeoLeaf.POI._clearAllForTests === \"function\") {\r\n            GeoLeaf.POI._clearAllForTests();\r\n        } else {\r\n            Log.warn(\"[GeoLeaf.UI.FilterPanel] GeoLeaf.POI._clearAllForTests indisponible.\");\r\n        }\r\n\r\n        filteredPois.forEach(function(p) {\r\n            try {\r\n                GeoLeaf.POI.addPoi(p);\r\n            } catch (err) {\r\n                Log.warn(\"[GeoLeaf.UI.FilterPanel] Impossible d'ajouter un POI filtr√©:\", p, err);\r\n            }\r\n        });\r\n\r\n        Log.debug(`[GeoLeaf.UI.FilterPanel] refreshPoiLayer: ${filteredPois.length} POI visibles`);\r\n    };\r\n\r\n    /**\r\n     * Applique les filtres aux couches GeoJSON (polygones et polylignes)\r\n     * @param {Object} state - √âtat des filtres\r\n     */\r\n    GeoLeaf._UIFilterPanelApplier.filterGeoJSONLayers = function(state) {\r\n        const Log = getLog();\r\n        const Shared = getShared();\r\n\r\n        if (!GeoLeaf.GeoJSON || typeof GeoLeaf.GeoJSON.filterFeatures !== 'function') {\r\n            return;\r\n        }\r\n\r\n        const hasCats = state.categoriesTree && state.categoriesTree.length > 0;\r\n        const hasSubs = state.subCategoriesTree && state.subCategoriesTree.length > 0;\r\n        const hasTags = state.hasTags && state.selectedTags && state.selectedTags.length > 0;\r\n        const selectedTags = state.selectedTags || [];\r\n        const hasProximity = state.proximity && state.proximity.active;\r\n        const hasSearchText = state.hasSearchText && state.searchText;\r\n        const searchText = state.searchText || '';\r\n        const getDistance = GeoLeaf.Utils && typeof GeoLeaf.Utils.getDistance === 'function' ? GeoLeaf.Utils.getDistance : null;\r\n\r\n        // Helper pour obtenir les champs de recherche depuis la config de la couche\r\n        const getLayerSearchFields = (layerId) => {\r\n            try {\r\n                const layerData = GeoLeaf.GeoJSON.getLayerData(layerId);\r\n                if (layerData && layerData.config) {\r\n                    // Priorit√© 1: search.indexingFields (format standard des configs de couches)\r\n                    if (layerData.config.search && Array.isArray(layerData.config.search.indexingFields)) {\r\n                        return layerData.config.search.indexingFields;\r\n                    }\r\n                    // Priorit√© 2: indexingFields √† la racine (legacy)\r\n                    if (Array.isArray(layerData.config.indexingFields)) {\r\n                        return layerData.config.indexingFields;\r\n                    }\r\n                    // Priorit√© 3: searchFields (legacy)\r\n                    if (Array.isArray(layerData.config.searchFields)) {\r\n                        return layerData.config.searchFields;\r\n                    }\r\n                }\r\n            } catch (err) {\r\n                Log.warn(\"[GeoLeaf.UI.FilterPanel] Erreur r√©cup√©ration champs de recherche:\", err);\r\n            }\r\n\r\n            // Fallback: champs par d√©faut du profil\r\n            try {\r\n                const activeProfile = GeoLeaf.Config && GeoLeaf.Config._activeProfileData;\r\n                if (activeProfile && activeProfile.search && activeProfile.search.filters) {\r\n                    const searchFilter = activeProfile.search.filters.find(f => f.type === 'search');\r\n                    if (searchFilter && Array.isArray(searchFilter.searchFields)) {\r\n                        return searchFilter.searchFields;\r\n                    }\r\n                }\r\n            } catch (err) {\r\n                Log.warn(\"[GeoLeaf.UI.FilterPanel] Erreur r√©cup√©ration champs par d√©faut:\", err);\r\n            }\r\n\r\n            // Fallback ultime\r\n            return ['title', 'description', 'properties.title', 'properties.name', 'properties.description', 'attributes.nom'];\r\n        };\r\n\r\n        // Helper pour tester la recherche textuelle sur une feature\r\n        const matchesSearchText = (feature, layerId) => {\r\n            if (!hasSearchText) return true;\r\n\r\n            const searchFields = getLayerSearchFields(layerId);\r\n            const searchLower = searchText.toLowerCase();\r\n\r\n            for (let i = 0; i < searchFields.length; i++) {\r\n                let fieldPath = searchFields[i];\r\n                let value = null;\r\n\r\n                // Normaliser le chemin: si commence par \"properties.\", on le supprime\r\n                // puisque on va chercher directement dans feature.properties\r\n                let propertiesFieldPath = fieldPath;\r\n                if (fieldPath.startsWith('properties.')) {\r\n                    propertiesFieldPath = fieldPath.substring('properties.'.length);\r\n                }\r\n\r\n                // Tester d'abord dans properties\r\n                if (feature.properties) {\r\n                    value = Shared.getNestedValue(feature.properties, propertiesFieldPath);\r\n                }\r\n\r\n                // Si pas trouv√©, tester √† la racine avec le chemin original\r\n                if (!value) {\r\n                    value = Shared.getNestedValue(feature, fieldPath);\r\n                }\r\n\r\n                if (value && String(value).toLowerCase().includes(searchLower)) {\r\n                    return true;\r\n                }\r\n            }\r\n\r\n            return false;\r\n        };\r\n\r\n        // Fonction de filtre commune pour polygones et lignes\r\n        const createFilterFunction = (geometryType) => (feature, layerId) => {\r\n            const props = feature.properties || {};\r\n\r\n            // Filtrage par recherche textuelle\r\n            if (hasSearchText && !matchesSearchText(feature, layerId)) {\r\n                return false;\r\n            }\r\n\r\n            // Filtrage par cat√©gorie/sous-cat√©gorie\r\n            if (hasCats || hasSubs) {\r\n                const catId = props.categoryId || props.category || null;\r\n                const subId = props.subcategoryId || props.subCategoryId || props.subcategory || props.sub_category || null;\r\n\r\n                // Si pas de cat√©gorie sur cette feature, masquer quand filtre actif\r\n                if (!catId && !subId) return false;\r\n\r\n                // Si des sous-cat√©gories sont s√©lectionn√©es\r\n                if (hasSubs) {\r\n                    if (!subId || !state.subCategoriesTree.includes(String(subId))) {\r\n                        return false;\r\n                    }\r\n                }\r\n\r\n                // Si seulement des cat√©gories (pas de sous-cat)\r\n                if (hasCats && !hasSubs) {\r\n                    if (!catId || !state.categoriesTree.includes(String(catId))) {\r\n                        return false;\r\n                    }\r\n                }\r\n            }\r\n\r\n            // Filtrage par tags (au moins UN des tags s√©lectionn√©s doit √™tre pr√©sent)\r\n            if (hasTags) {\r\n                let featureTags = props.tags || [];\r\n                if (!Array.isArray(featureTags)) {\r\n                    if (typeof featureTags === 'string') {\r\n                        featureTags = featureTags.split(/[,;]+/);\r\n                    } else {\r\n                        featureTags = [];\r\n                    }\r\n                }\r\n                featureTags = featureTags.map(t => String(t).trim()).filter(Boolean);\r\n\r\n                const hasAtLeastOneTag = selectedTags.some(tag => featureTags.includes(tag));\r\n                if (!hasAtLeastOneTag) {\r\n                    return false;\r\n                }\r\n            }\r\n\r\n            // Filtrage par proximit√©\r\n            if (hasProximity && state.proximity.center && getDistance) {\r\n                const point = Shared.getRepresentativePoint(feature.geometry);\r\n                if (point) {\r\n                    const distance = getDistance(\r\n                        state.proximity.center.lat,\r\n                        state.proximity.center.lng,\r\n                        point.lat,\r\n                        point.lng\r\n                    );\r\n                    if (distance > state.proximity.radius) {\r\n                        return false;\r\n                    }\r\n                }\r\n            }\r\n\r\n            return true;\r\n        };\r\n\r\n        // Filtrer les polygones (zones)\r\n        GeoLeaf.GeoJSON.filterFeatures(createFilterFunction('polygon'), { geometryType: 'polygon' });\r\n\r\n        // Filtrer les polylignes (routes GeoJSON)\r\n        GeoLeaf.GeoJSON.filterFeatures(createFilterFunction('line'), { geometryType: 'line' });\r\n\r\n        // Filtrer les points (POI GeoJSON - MultiPoint, Point, etc.)\r\n        GeoLeaf.GeoJSON.filterFeatures(createFilterFunction('point'), { geometryType: 'point' });\r\n    };\r\n\r\n    /**\r\n     * Applique tous les filtres actifs avec debounce\r\n     * @param {HTMLElement} panelEl - √âl√©ment du panneau de filtres\r\n     */\r\n    GeoLeaf._UIFilterPanelApplier.applyFiltersNow = function(panelEl, skipRoutes) {\r\n        _debouncedApplyFilters(panelEl, skipRoutes);\r\n    };\r\n\r\n    /**\r\n     * Applique tous les filtres actifs imm√©diatement (interne, avec protection contre les appels r√©p√©t√©s)\r\n     * @private\r\n     * @param {HTMLElement} panelEl - √âl√©ment du panneau de filtres\r\n     * @param {boolean} skipRoutes - Si true, skip le traitement des routes (preserve leurs styles)\r\n     */\r\n    GeoLeaf._UIFilterPanelApplier._applyFiltersImmediate = function(panelEl, skipRoutes) {\r\n        const Log = getLog();\r\n        const Shared = getShared();\r\n        const StateReader = getStateReader();\r\n\r\n        // √âviter les appels r√©p√©t√©s trop rapproch√©s\r\n        const now = Date.now();\r\n        if (now - _lastApplyTime < 100) return; // 100ms minimum entre les appels\r\n        _lastApplyTime = now;\r\n\r\n        const basePois = Shared.getBasePois();\r\n        const baseRoutes = Shared.getBaseRoutes();\r\n        const state = StateReader.readFiltersFromPanel(panelEl);\r\n\r\n        // Filtrage des couches GeoJSON (polygones, polylignes)\r\n        GeoLeaf._UIFilterPanelApplier.filterGeoJSONLayers(state);\r\n\r\n        if (!basePois.length && !baseRoutes.length) {\r\n            Log.info(\"[GeoLeaf.UI.FilterPanel] Aucun POI ni route source trouv√©.\");\r\n            return;\r\n        }\r\n\r\n        // G√©rer le filtrage et l'affichage des itin√©raires via GeoLeaf.Route\r\n        if (GeoLeaf.Route && typeof GeoLeaf.Route.isInitialized === 'function' && GeoLeaf.Route.isInitialized()) {\r\n            if (state.dataTypes.routes) {\r\n                // Si skipRoutes=true, on affiche juste les routes existantes sans les recharger\r\n                if (skipRoutes) {\r\n                    GeoLeaf.Route.show();\r\n                } else {\r\n                    // Filtrer les routes\r\n                    let filteredRoutes = baseRoutes;\r\n                    filteredRoutes = GeoLeaf.Filters && typeof GeoLeaf.Filters.filterRouteList === 'function'\r\n                        ? GeoLeaf.Filters.filterRouteList(baseRoutes, state)\r\n                        : baseRoutes;\r\n\r\n                    Log.info(\"[GeoLeaf.UI.FilterPanel] Filtres appliqu√©s sur les routes.\", {\r\n                        total: baseRoutes.length,\r\n                        result: filteredRoutes.length\r\n                    });\r\n\r\n                    // Utiliser filterVisibility() si disponible pour pr√©server les styles\r\n                    // Sinon, utiliser loadFromConfig() (comportement par d√©faut)\r\n                    if (typeof GeoLeaf.Route.filterVisibility === 'function') {\r\n                        GeoLeaf.Route.filterVisibility(filteredRoutes);\r\n                    } else if (typeof GeoLeaf.Route.loadFromConfig === 'function') {\r\n                        GeoLeaf.Route.loadFromConfig(filteredRoutes);\r\n                    }\r\n                    GeoLeaf.Route.show();\r\n                }\r\n            } else {\r\n                GeoLeaf.Route.hide();\r\n            }\r\n        }\r\n\r\n        // Filtrer les POI\r\n        const filtered = GeoLeaf._UIFilterPanelApplier.filterPoiList(basePois, state);\r\n\r\n        Log.info(\"[GeoLeaf.UI.FilterPanel] Filtres appliqu√©s sur les POI.\", {\r\n            total: basePois.length,\r\n            result: filtered.length,\r\n            filters: state\r\n        });\r\n\r\n        GeoLeaf._UIFilterPanelApplier.refreshPoiLayer(filtered);\r\n    };\r\n\r\n    /**\r\n     * Filtre une liste de POI selon les crit√®res fournis\r\n     * D√©l√®gue vers GeoLeaf.Filters.filterPoiList()\r\n     *\r\n     * @param {Array} basePois - Liste compl√®te des POI\r\n     * @param {Object} filterState - √âtat des filtres\r\n     * @returns {Array} POI filtr√©s\r\n     */\r\n    GeoLeaf._UIFilterPanelApplier.filterPoiList = function(basePois, filterState) {\r\n        if (GeoLeaf.Filters && typeof GeoLeaf.Filters.filterPoiList === 'function') {\r\n            return GeoLeaf.Filters.filterPoiList(basePois, filterState);\r\n        }\r\n\r\n        const Log = getLog();\r\n        Log.warn('[GeoLeaf.UI.FilterPanel] Module Filters non charg√©, retour liste compl√®te');\r\n        return basePois || [];\r\n    };\r\n\r\n    /**\r\n     * Filtre une liste de routes selon les crit√®res fournis\r\n     * D√©l√®gue vers GeoLeaf.Filters.filterRouteList()\r\n     *\r\n     * @param {Array} baseRoutes - Liste compl√®te des routes\r\n     * @param {Object} filterState - √âtat des filtres\r\n     * @returns {Array} Routes filtr√©es\r\n     */\r\n    GeoLeaf._UIFilterPanelApplier.filterRouteList = function(baseRoutes, filterState) {\r\n        if (GeoLeaf.Filters && typeof GeoLeaf.Filters.filterRouteList === 'function') {\r\n            return GeoLeaf.Filters.filterRouteList(baseRoutes, filterState);\r\n        }\r\n\r\n        const Log = getLog();\r\n        Log.warn('[GeoLeaf.UI.FilterPanel] Module Filters non charg√©, retour liste compl√®te');\r\n        return baseRoutes || [];\r\n    };\r\n\r\n    /**\r\n     * Applique les filtres initiaux au chargement\r\n     */\r\n    GeoLeaf._UIFilterPanelApplier.applyFiltersInitial = function() {\r\n        const Log = getLog();\r\n        const Shared = getShared();\r\n        const StateReader = getStateReader();\r\n\r\n        const panelEl = Shared.getFilterPanelElement();\r\n        if (!panelEl) {\r\n            Log.warn(\"[GeoLeaf.UI.FilterPanel] Panneau de filtres non trouv√©, impossible d'appliquer les filtres initiaux.\");\r\n            return;\r\n        }\r\n\r\n        Log.info(\"[GeoLeaf.UI.FilterPanel] Application des filtres initiaux...\");\r\n\r\n        const state = StateReader.readFiltersFromPanel(panelEl);\r\n        const basePois = Shared.getBasePois();\r\n        const baseRoutes = Shared.getBaseRoutes();\r\n\r\n        if (!basePois.length && !baseRoutes.length) {\r\n            Log.info(\"[GeoLeaf.UI.FilterPanel] Aucun POI ni route source trouv√©.\");\r\n            return;\r\n        }\r\n\r\n        // G√©rer les itin√©raires\r\n        if (GeoLeaf.Route && typeof GeoLeaf.Route.isInitialized === 'function' && GeoLeaf.Route.isInitialized()) {\r\n            if (state.dataTypes.routes) {\r\n                let filteredRoutes = GeoLeaf._UIFilterPanelApplier.filterRouteList(baseRoutes, state);\r\n                if (typeof GeoLeaf.Route.loadFromConfig === 'function') {\r\n                    GeoLeaf.Route.loadFromConfig(filteredRoutes);\r\n                }\r\n                GeoLeaf.Route.show();\r\n            } else {\r\n                GeoLeaf.Route.hide();\r\n            }\r\n        }\r\n\r\n        // Filtrer et charger les POI\r\n        const filtered = GeoLeaf._UIFilterPanelApplier.filterPoiList(basePois, state);\r\n        Log.info(\"[GeoLeaf.UI.FilterPanel] POI filtr√©s pour chargement initial.\", {\r\n            total: basePois.length,\r\n            result: filtered.length\r\n        });\r\n\r\n        GeoLeaf._UIFilterPanelApplier.refreshPoiLayer(filtered);\r\n    };\r\n\r\n})(window);\r\n","/**\r\n * GeoLeaf UI Filter Panel - Renderer\r\n * Construction du panneau HTML de filtres\r\n *\r\n * @module ui/filter-panel/renderer\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n\r\n    // Helper pour utiliser createElement unifi√©\r\n    const $create = (tag, props, ...children) => {\r\n        return GeoLeaf.Utils && GeoLeaf.Utils.createElement\r\n            ? GeoLeaf.Utils.createElement(tag, props, ...children)\r\n            : document.createElement(tag);\r\n    };\r\n\r\n    // D√©pendances lazy\r\n    const getLog = () => (GeoLeaf.Log || console);\r\n    const getShared = () => GeoLeaf._UIFilterPanelShared;\r\n    const getStateReader = () => GeoLeaf._UIFilterPanelStateReader;\r\n    const getApplier = () => GeoLeaf._UIFilterPanelApplier;\r\n\r\n    GeoLeaf._UIFilterPanelRenderer = GeoLeaf._UIFilterPanelRenderer || {};\r\n    GeoLeaf._UIFilterPanelRenderer._eventCleanups = [];\r\n\r\n    /**\r\n     * Construit le panneau de filtres depuis la configuration du profil actif\r\n     * @param {Object} options - Options\r\n     * @param {HTMLElement} [options.container] - Conteneur cible\r\n     */\r\n    GeoLeaf._UIFilterPanelRenderer.buildFilterPanelFromActiveProfile = function(options) {\r\n        const Log = getLog();\r\n        const Shared = getShared();\r\n        const StateReader = getStateReader();\r\n        const Applier = getApplier();\r\n\r\n        if (Log) Log.debug(\"[FilterPanel] buildFilterPanelFromActiveProfile APPEL√â, options:\", options);\r\n\r\n        const profile = GeoLeaf.UI._getActiveProfileConfig();\r\n        if (Log) Log.debug(\"[FilterPanel] Profile r√©cup√©r√©:\", profile);\r\n\r\n        if (!profile) {\r\n            Log.warn(\"[GeoLeaf.UI.FilterPanel] Aucun profil actif trouv√©\");\r\n            return;\r\n        }\r\n\r\n        Log.info(\"[GeoLeaf.UI.FilterPanel] Profil actif:\", profile.id || \"unknown\");\r\n\r\n        // Support both profile.panels.search (old) and profile.search (new)\r\n        const searchPanel = (profile.panels && profile.panels.search) || profile.search;\r\n        if (Log) Log.debug(\"[FilterPanel] searchPanel:\", searchPanel);\r\n\r\n        if (!searchPanel) {\r\n            Log.warn(\"[GeoLeaf.UI.FilterPanel] Aucune configuration search/panels.search dans le profil\");\r\n            return;\r\n        }\r\n\r\n        const filters = searchPanel && Array.isArray(searchPanel.filters) ? searchPanel.filters : null;\r\n        if (Log) Log.debug(\"[FilterPanel] Filters:\", filters);\r\n\r\n        if (!filters || !filters.length) {\r\n            Log.warn(\"[GeoLeaf.UI.FilterPanel] Aucun filtre d√©fini dans profile.search.filters pour le profil actif. Filters:\", filters);\r\n            return;\r\n        }\r\n\r\n        Log.info(\"[GeoLeaf.UI.FilterPanel] Nombre de filtres trouv√©s:\", filters.length);\r\n\r\n        const container = (options && options.container) || Shared.getFilterPanelElement();\r\n        if (!container) {\r\n            Log.warn(\"[GeoLeaf.UI.FilterPanel] Conteneur de panneau introuvable\");\r\n            return;\r\n        }\r\n\r\n        // ---------------------------------------------------------\r\n        // Vider le conteneur existant\r\n        // ---------------------------------------------------------\r\n        while (container.firstChild) {\r\n            container.removeChild(container.firstChild);\r\n        }\r\n\r\n        container.classList.add(\"gl-filter-panel\");\r\n\r\n        // ---------------------------------------------------------\r\n        // Header\r\n        // ---------------------------------------------------------\r\n        const header = $create(\"div\", {\r\n            className: \"gl-filter-panel__header\"\r\n        });\r\n\r\n        const title = $create(\"h2\", {\r\n            className: \"gl-filter-panel__title\",\r\n            textContent: searchPanel.title || \"Filtres\"\r\n        });\r\n        header.appendChild(title);\r\n\r\n        // Bouton toggle avec fl√®che (comme le tableau)\r\n        const toggleBtn = $create(\"button\", {\r\n            type: \"button\",\r\n            className: \"gl-filter-panel__toggle-btn\",\r\n            attributes: {\r\n                \"data-gl-action\": \"filter-close\",\r\n                \"aria-label\": \"Fermer le panneau\"\r\n            }\r\n        });\r\n        const toggleIcon = $create(\"span\", {\r\n            className: \"gl-filter-panel__toggle-icon\",\r\n            textContent: \"‚óÄ\"\r\n        });\r\n        toggleBtn.appendChild(toggleIcon);\r\n        header.appendChild(toggleBtn);\r\n\r\n        container.appendChild(header);\r\n\r\n        // ---------------------------------------------------------\r\n        // Body : champs de filtre\r\n        // ---------------------------------------------------------\r\n        const body = $create(\"div\", {\r\n            className: \"gl-filter-panel__body\"\r\n        });\r\n\r\n        // Sprint 3.2: Use DocumentFragment for batch DOM operations\r\n        const bodyFragment = document.createDocumentFragment();\r\n\r\n        filters.forEach(function(filterDef) {\r\n            // Passer skipLabel=true pour les filtres avec accord√©on (categories et tags) et proximity (qui g√®re son propre label)\r\n            const skipLabel = (filterDef.id === 'categories' || filterDef.id === 'tags' || filterDef.type === 'proximity');\r\n            const groupEl = GeoLeaf.UI._buildFilterControl(filterDef, profile, skipLabel);\r\n\r\n            if (groupEl) {\r\n                // Wrapper avec accord√©on pour categories et tags\r\n                if (filterDef.id === 'categories' || filterDef.id === 'tags') {\r\n                    const accordionGroup = $create(\"div\", {\r\n                        className: \"gl-filter-panel__group--accordion\",\r\n                        attributes: { \"data-accordion-for\": filterDef.id }\r\n                    });\r\n\r\n                    const accordionHeader = $create(\"div\", {\r\n                        className: \"gl-filter-panel__accordion-header\"\r\n                    });\r\n\r\n                    const accordionTitle = $create(\"h3\", {\r\n                        className: \"gl-filter-panel__accordion-title\",\r\n                        textContent: filterDef.label || (filterDef.id === 'categories' ? 'Afficher les cat√©gories' : 'Afficher les tags')\r\n                    });\r\n\r\n                    const accordionArrow = $create(\"span\", {\r\n                        className: \"gl-filter-panel__accordion-arrow\",\r\n                        textContent: \"‚ñ∂\"\r\n                    });\r\n\r\n                    accordionHeader.appendChild(accordionTitle);\r\n                    accordionHeader.appendChild(accordionArrow);\r\n\r\n                    const accordionBody = $create(\"div\", {\r\n                        className: \"gl-filter-panel__accordion-body\"\r\n                    });\r\n\r\n                    // Wrapper n√©cessaire pour la technique CSS Grid\r\n                    const accordionWrapper = $create(\"div\");\r\n                    accordionWrapper.appendChild(groupEl);\r\n                    accordionBody.appendChild(accordionWrapper);\r\n\r\n                    const accordionClickHandler = function() {\r\n                        requestAnimationFrame(function() {\r\n                            accordionGroup.classList.toggle(\"is-expanded\");\r\n\r\n                            const isExpanded = accordionGroup.classList.contains(\"is-expanded\");\r\n\r\n                            // LAZY LOADING: Charger le contenu √† la demande si n√©cessaire\r\n                            if (isExpanded) {\r\n                                GeoLeaf._UIFilterPanelRenderer._loadAccordionContentIfNeeded(accordionGroup, filterDef);\r\n                            } else {\r\n                                // Marquer comme ferm√©\r\n                                const LazyLoader = GeoLeaf._UIFilterPanelLazyLoader;\r\n                                if (LazyLoader) {\r\n                                    LazyLoader.markAccordionClosed(accordionGroup);\r\n                                }\r\n                            }\r\n                        });\r\n                    };\r\n\r\n                    const events = GeoLeaf.Utils?.events;\r\n                    if (events) {\r\n                        GeoLeaf._UIFilterPanelRenderer._eventCleanups.push(\r\n                            events.on(\r\n                                accordionHeader,\r\n                                \"click\",\r\n                                accordionClickHandler,\r\n                                false,\r\n                                'FilterPanel.accordionToggle'\r\n                            )\r\n                        );\r\n                    } else {\r\n                        accordionHeader.addEventListener(\"click\", accordionClickHandler);\r\n                    }\r\n\r\n                    accordionGroup.appendChild(accordionHeader);\r\n                    accordionGroup.appendChild(accordionBody);\r\n                    bodyFragment.appendChild(accordionGroup);\r\n                } else {\r\n                    bodyFragment.appendChild(groupEl);\r\n                }\r\n            }\r\n        });\r\n\r\n        body.appendChild(bodyFragment);\r\n\r\n        container.appendChild(body);\r\n\r\n        // ---------------------------------------------------------\r\n        // Footer : boutons Appliquer / R√©initialiser\r\n        // ---------------------------------------------------------\r\n        const footer = $create(\"div\", {\r\n            className: \"gl-filter-panel__footer\"\r\n        });\r\n\r\n        const applyBtn = $create(\"button\", {\r\n            type: \"button\",\r\n            className: \"gl-btn gl-btn--accent gl-filter-panel__btn-apply\",\r\n            textContent: (searchPanel.actions && searchPanel.actions.applyLabel) || \"Appliquer\"\r\n        });\r\n        footer.appendChild(applyBtn);\r\n\r\n        const resetBtn = $create(\"button\", {\r\n            type: \"button\",\r\n            className: \"gl-btn gl-btn--subtle gl-filter-panel__btn-reset\",\r\n            textContent: (searchPanel.actions && searchPanel.actions.resetLabel) || \"R√©initialiser\"\r\n        });\r\n        footer.appendChild(resetBtn);\r\n\r\n        container.appendChild(footer);\r\n\r\n        // ---------------------------------------------------------\r\n        // Wiring √©v√®nements (fermer / reset / appliquer)\r\n        // ---------------------------------------------------------\r\n        if (!container._glFilterHandlersBound) {\r\n            // D√©clarer events une seule fois pour tout le bloc\r\n            const events = GeoLeaf.Utils?.events;\r\n\r\n            const containerClickHandler = function(evt) {\r\n                const target = evt.target;\r\n\r\n                // Fermer le panneau (utilise closest pour g√©rer les clics sur les enfants du bouton)\r\n                if (target.closest(\"[data-gl-action='filter-close']\")) {\r\n                    evt.preventDefault();\r\n                    GeoLeaf._UIFilterPanelRenderer.toggleFilterPanelVisibility(false);\r\n                    return;\r\n                }\r\n\r\n                // R√©initialiser les filtres + r√©afficher tous les POI\r\n                if (target.classList.contains(\"gl-filter-panel__btn-reset\")) {\r\n                    evt.preventDefault();\r\n                    StateReader.resetControls(container);\r\n                    Applier.applyFiltersNow(container, true); // skipRoutes=true to preserve route styling\r\n                    return;\r\n                }\r\n\r\n                // Appliquer les filtres\r\n                if (target.classList.contains(\"gl-filter-panel__btn-apply\")) {\r\n                    evt.preventDefault();\r\n                    Applier.applyFiltersNow(container);\r\n                    return;\r\n                }\r\n            };\r\n\r\n            if (events) {\r\n                GeoLeaf._UIFilterPanelRenderer._eventCleanups.push(\r\n                    events.on(\r\n                        container,\r\n                        \"click\",\r\n                        containerClickHandler,\r\n                        false,\r\n                        'FilterPanel.containerClick'\r\n                    )\r\n                );\r\n            } else {\r\n                container.addEventListener(\"click\", containerClickHandler);\r\n            }\r\n\r\n            // Gestionnaire pour la touche Entr√©e dans l'input de recherche textuelle\r\n            const containerKeydownHandler = function(evt) {\r\n                if (evt.key === \"Enter\" || evt.keyCode === 13) {\r\n                    const target = evt.target;\r\n                    const searchInput = target.closest(\"[data-gl-filter-id='searchText'] input[type='text']\");\r\n                    if (searchInput) {\r\n                        evt.preventDefault();\r\n                        Applier.applyFiltersNow(container);\r\n                        return;\r\n                    }\r\n                }\r\n            };\r\n\r\n            if (events) {\r\n                GeoLeaf._UIFilterPanelRenderer._eventCleanups.push(\r\n                    events.on(\r\n                        container,\r\n                        \"keydown\",\r\n                        containerKeydownHandler,\r\n                        false,\r\n                        'FilterPanel.enterKey'\r\n                    )\r\n                );\r\n            } else {\r\n                container.addEventListener(\"keydown\", containerKeydownHandler);\r\n            }\r\n\r\n            container._glFilterHandlersBound = true;\r\n        }\r\n\r\n        // Le panneau doit √™tre masqu√© par d√©faut au d√©marrage\r\n        // Il ne s'affichera que lorsque l'utilisateur cliquera sur le bouton toggle\r\n        container.classList.remove(\"is-open\");\r\n    };\r\n\r\n    /**\r\n     * Bascule la visibilit√© du panneau de filtres.\r\n     * @param {boolean} [forceState] - Force l'√©tat (true = ouvert, false = ferm√©)\r\n     */\r\n    GeoLeaf._UIFilterPanelRenderer.toggleFilterPanelVisibility = function(forceState) {\r\n        const Shared = getShared();\r\n        const container = Shared.getFilterPanelElement();\r\n        if (!container) return;\r\n\r\n        const isOpen = container.classList.contains(\"is-open\");\r\n        let nextState;\r\n\r\n        if (typeof forceState === \"boolean\") {\r\n            nextState = forceState;\r\n        } else {\r\n            nextState = !isOpen;\r\n        }\r\n\r\n        if (nextState) {\r\n            container.classList.add(\"is-open\");\r\n        } else {\r\n            container.classList.remove(\"is-open\");\r\n        }\r\n\r\n        // Mettre √† jour l'ic√¥ne du bouton toggle externe\r\n        const toggleBtn = document.getElementById(\"gl-filter-toggle\");\r\n        if (toggleBtn) {\r\n            const icon = toggleBtn.querySelector(\".gl-filter-toggle__icon\");\r\n            if (icon) {\r\n                if (nextState) {\r\n                    // Panneau ouvert : fl√®che vers la gauche (pour fermer)\r\n                    // SAFE: SVG statique hardcod√©\r\n                    GeoLeaf.DOMSecurity.clearElementFast(icon);\r\n                    const svg = GeoLeaf.DOMSecurity.createSVGIcon(16, 16, 'M15 18l-6-6 6-6', {\r\n                        stroke: 'currentColor',\r\n                        strokeWidth: '6',\r\n                        fill: 'none'\r\n                    });\r\n                    icon.appendChild(svg);\r\n                    toggleBtn.setAttribute(\"aria-label\", \"Fermer le panneau de filtres\");\r\n                } else {\r\n                    // Panneau ferm√© : fl√®che vers la droite (pour ouvrir)\r\n                    // SAFE: SVG statique hardcod√©\r\n                    GeoLeaf.DOMSecurity.clearElementFast(icon);\r\n                    const svg = GeoLeaf.DOMSecurity.createSVGIcon(16, 16, 'M9 6l6 6-6 6', {\r\n                        stroke: 'currentColor',\r\n                        strokeWidth: '6',\r\n                        fill: 'none'\r\n                    });\r\n                    icon.appendChild(svg);\r\n                    toggleBtn.setAttribute(\"aria-label\", \"Ouvrir le panneau de filtres\");\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Initialise le bouton toggle du panneau de filtres\r\n     */\r\n    GeoLeaf._UIFilterPanelRenderer.initFilterToggle = function() {\r\n        const Log = getLog();\r\n        const Shared = getShared();\r\n\r\n        const toggleBtn = document.getElementById(\"gl-filter-toggle\");\r\n        const panel = Shared.getFilterPanelElement();\r\n\r\n        if (!toggleBtn || !panel) {\r\n            Log.info(\"[GeoLeaf.UI.FilterPanel] Bouton toggle ou panneau filtres introuvable\");\r\n            return;\r\n        }\r\n\r\n        const toggleClickHandler = function() {\r\n            const isOpen = panel.classList.contains(\"is-open\");\r\n            const icon = toggleBtn.querySelector(\".gl-filter-toggle__icon\");\r\n\r\n            if (isOpen) {\r\n                panel.classList.remove(\"is-open\");\r\n                if (icon) {\r\n                    // SAFE: SVG statique hardcod√©\r\n                    GeoLeaf.DOMSecurity.clearElementFast(icon);\r\n                    const svg = GeoLeaf.DOMSecurity.createSVGIcon(16, 16, 'M9 6l6 6-6 6', {\r\n                        stroke: 'currentColor',\r\n                        strokeWidth: '6',\r\n                        fill: 'none'\r\n                    });\r\n                    icon.appendChild(svg);\r\n                }\r\n                toggleBtn.setAttribute(\"aria-label\", \"Ouvrir le panneau de filtres\");\r\n            } else {\r\n                panel.classList.add(\"is-open\");\r\n                if (icon) {\r\n                    // SAFE: SVG statique hardcod√©\r\n                    GeoLeaf.DOMSecurity.clearElementFast(icon);\r\n                    const svg = GeoLeaf.DOMSecurity.createSVGIcon(16, 16, 'M15 18l-6-6 6-6', {\r\n                        stroke: 'currentColor',\r\n                        strokeWidth: '6',\r\n                        fill: 'none'\r\n                    });\r\n                    icon.appendChild(svg);\r\n                }\r\n                toggleBtn.setAttribute(\"aria-label\", \"Fermer le panneau de filtres\");\r\n            }\r\n        };\r\n\r\n        const events = GeoLeaf.Utils?.events;\r\n        if (events) {\r\n            GeoLeaf._UIFilterPanelRenderer._eventCleanups.push(\r\n                events.on(\r\n                    toggleBtn,\r\n                    \"click\",\r\n                    toggleClickHandler,\r\n                    false,\r\n                    'FilterPanel.toggleButton'\r\n                )\r\n            );\r\n        } else {\r\n            toggleBtn.addEventListener(\"click\", toggleClickHandler);\r\n        }\r\n\r\n        Log.info(\"[GeoLeaf.UI.FilterPanel] Bouton toggle filtres initialis√©\");\r\n    };\r\n\r\n    /**\r\n     * Rafra√Æchit les badges de tags dans le panneau de filtres.\r\n     * Doit √™tre appel√© APR√àS que les POI ont √©t√© charg√©s.\r\n     */\r\n    GeoLeaf._UIFilterPanelRenderer.refreshFilterTags = function() {\r\n        const Log = getLog();\r\n        const Shared = getShared();\r\n\r\n        const container = Shared.getFilterPanelElement();\r\n        if (!container) {\r\n            Log.warn(\"[GeoLeaf.UI.FilterPanel.refreshFilterTags] Panneau de filtres non trouv√©\");\r\n            return;\r\n        }\r\n\r\n        // R√©cup√©rer POI et routes\r\n        const basePois = Shared.getBasePois();\r\n        const baseRoutes = Shared.getBaseRoutes();\r\n        const allItems = basePois.concat(baseRoutes);\r\n\r\n        Log.debug(\"[GeoLeaf.UI.FilterPanel.refreshFilterTags] Items:\", basePois.length, \"POI,\", baseRoutes.length, \"routes\");\r\n\r\n        // Collecter tous les tags\r\n        const allTags = Shared.collectAllTags(allItems);\r\n\r\n        // Peupler les badges\r\n        GeoLeaf._UIFilterPanelRenderer.populateTagsBadges(container, allTags);\r\n    };\r\n\r\n    /**\r\n     * Peuple le conteneur de badges avec les tags fournis\r\n     * @param {HTMLElement} panelEl - √âl√©ment du panneau de filtres\r\n     * @param {Array} allTags - Liste des tags uniques\r\n     */\r\n    GeoLeaf._UIFilterPanelRenderer.populateTagsBadges = function(panelEl, allTags) {\r\n        const Log = getLog();\r\n        const wrapper = panelEl.querySelector(\"[data-gl-filter-id='tags']\");\r\n        if (!wrapper) {\r\n            Log.debug(\"[GeoLeaf.UI.FilterPanel] Wrapper tags non trouv√© - probablement pas utilis√© dans ce profil\");\r\n            return;\r\n        }\r\n\r\n        const tagsContainer = wrapper.querySelector(\".gl-filter-panel__tags-container\");\r\n        if (!tagsContainer) {\r\n            Log.warn(\"[GeoLeaf.UI.FilterPanel] Container tags non trouv√©\");\r\n            return;\r\n        }\r\n\r\n        // Trouver l'accord√©on parent par l'attribut data-accordion-for\r\n        const accordionGroup = panelEl.querySelector(\"[data-accordion-for='tags']\");\r\n        Log.debug(\"[GeoLeaf.UI.FilterPanel] Recherche accord√©on avec [data-accordion-for='tags']\");\r\n        Log.debug(\"[GeoLeaf.UI.FilterPanel] Accord√©on trouv√©:\", accordionGroup);\r\n\r\n        // Vider le container\r\n        while (tagsContainer.firstChild) {\r\n            tagsContainer.removeChild(tagsContainer.firstChild);\r\n        }\r\n\r\n        // Si pas de tags, cacher compl√®tement l'accord√©on parent\r\n        if (!allTags.length) {\r\n            Log.debug(\"[GeoLeaf.UI.FilterPanel] Pas de tags (count:\", allTags.length, \")\");\r\n            if (accordionGroup) {\r\n                accordionGroup.style.display = \"none\";\r\n                Log.info(\"[GeoLeaf.UI.FilterPanel] Accord√©on tags CACH√â (display: none)\");\r\n            } else {\r\n                Log.warn(\"[GeoLeaf.UI.FilterPanel] Accord√©on tags non trouv√© pour le cacher\");\r\n            }\r\n            return;\r\n        }\r\n\r\n        // S'il y a des tags, s'assurer que l'accord√©on est visible\r\n        Log.debug(\"[GeoLeaf.UI.FilterPanel] Tags d√©tect√©s (count:\", allTags.length, \")\");\r\n        if (accordionGroup) {\r\n            accordionGroup.style.display = \"\";\r\n            Log.info(\"[GeoLeaf.UI.FilterPanel] Accord√©on tags AFFICH√â\");\r\n        }\r\n\r\n        // Cr√©er les badges\r\n        // Sprint 3.2: Use DocumentFragment for batch DOM operations\r\n        const tagsFragment = document.createDocumentFragment();\r\n\r\n        allTags.forEach(function(tag) {\r\n            const badgeClickHandler = function() {\r\n                this.classList.toggle(\"is-selected\");\r\n            };\r\n\r\n            const badge = $create(\"span\", {\r\n                className: \"gl-filter-panel__tag-badge\",\r\n                textContent: tag,\r\n                attributes: { \"data-tag-value\": tag },\r\n                onClick: badgeClickHandler\r\n            });\r\n\r\n            const events = GeoLeaf.Utils?.events;\r\n            if (events) {\r\n                GeoLeaf._UIFilterPanelRenderer._eventCleanups.push(\r\n                    events.on(\r\n                        badge,\r\n                        \"click\",\r\n                        badgeClickHandler,\r\n                        false,\r\n                        'FilterPanel.tagBadge'\r\n                    )\r\n                );\r\n            } else {\r\n                badge.addEventListener(\"click\", badgeClickHandler);\r\n            }\r\n\r\n            tagsFragment.appendChild(badge);\r\n        });\r\n\r\n        tagsContainer.appendChild(tagsFragment);\r\n    };\r\n\r\n    /**\r\n     * Cleanup method for event listeners\r\n     * Call this when destroying the filter panel\r\n     * MEMORY LEAK FIX (Phase 2): Also cleanup timeouts in applier\r\n     */\r\n    GeoLeaf._UIFilterPanelRenderer.destroy = function() {\r\n        const Log = getLog();\r\n        if (Log) Log.debug(\"[FilterPanel] Cleaning up event listeners\");\r\n\r\n        if (GeoLeaf._UIFilterPanelRenderer._eventCleanups) {\r\n            GeoLeaf._UIFilterPanelRenderer._eventCleanups.forEach(cleanup => {\r\n                if (typeof cleanup === 'function') {\r\n                    cleanup();\r\n                }\r\n            });\r\n            GeoLeaf._UIFilterPanelRenderer._eventCleanups = [];\r\n        }\r\n\r\n        // MEMORY LEAK FIX (Phase 2): Cleanup applier timeouts\r\n        if (GeoLeaf._UIFilterPanelApplier && GeoLeaf._UIFilterPanelApplier.destroy) {\r\n            GeoLeaf._UIFilterPanelApplier.destroy();\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Charge le contenu d'un accord√©on √† la demande (lazy loading)\r\n     * @param {HTMLElement} accordionGroup - Element de l'accord√©on\r\n     * @param {Object} filterDef - D√©finition du filtre\r\n     */\r\n    GeoLeaf._UIFilterPanelRenderer._loadAccordionContentIfNeeded = function(accordionGroup, filterDef) {\r\n        const Log = getLog();\r\n        const LazyLoader = GeoLeaf._UIFilterPanelLazyLoader;\r\n\r\n        if (!LazyLoader) {\r\n            Log.warn(\"[FilterPanel] LazyLoader non disponible\");\r\n            return;\r\n        }\r\n\r\n        // V√©rifier si le contenu a d√©j√† √©t√© charg√© (le flag est reset √† \"false\" lors d'un changement de th√®me)\r\n        if (accordionGroup.dataset.lazyLoaded === \"true\") {\r\n            Log.debug(\"[FilterPanel] Accord√©on d√©j√† charg√© pour ce th√®me, skip\");\r\n            return;\r\n        }\r\n\r\n        // Trouver le container de contenu\r\n        const contentArea = accordionGroup.querySelector('[data-lazy-type]');\r\n        if (!contentArea) {\r\n            Log.debug(\"[FilterPanel] Pas de zone lazy dans cet accord√©on\");\r\n            return;\r\n        }\r\n\r\n        const lazyType = contentArea.dataset.lazyType;\r\n        Log.info(`[FilterPanel] Chargement lazy du contenu: ${lazyType}`);\r\n\r\n        // R√©cup√©rer le th√®me actif (avec fallback sur le th√®me par d√©faut du profil)\r\n        let currentTheme = GeoLeaf.ThemeSelector?.getCurrentTheme();\r\n        if (!currentTheme) {\r\n            // Fallback : r√©cup√©rer le th√®me par d√©faut depuis le profil\r\n            const profile = (GeoLeaf.Config && typeof GeoLeaf.Config.getActiveProfile === \"function\")\r\n                ? GeoLeaf.Config.getActiveProfile()\r\n                : null;\r\n            if (profile && profile.themes && profile.themes.config && profile.themes.config.defautTheme) {\r\n                currentTheme = profile.themes.config.defautTheme;\r\n                Log.info(\"[FilterPanel] Fallback sur le th√®me par d√©faut:\", currentTheme);\r\n            }\r\n        }\r\n        if (!currentTheme) {\r\n            // Dernier fallback : utiliser \"defaut\" comme ID g√©n√©rique\r\n            currentTheme = \"defaut\";\r\n            Log.warn(\"[FilterPanel] Th√®me actif introuvable, utilisation de 'defaut'\");\r\n        }\r\n\r\n        // Afficher un spinner pendant le chargement\r\n        contentArea.innerHTML = '<div class=\"gl-filter-panel__loading\">Chargement...</div>';\r\n\r\n        // Charger de mani√®re asynchrone pour ne pas bloquer l'UI\r\n        setTimeout(() => {\r\n            try {\r\n                if (lazyType === 'categories') {\r\n                    const result = LazyLoader.loadCategories(currentTheme);\r\n\r\n                    // V√©rifier s'il y a des cat√©gories\r\n                    if (!result.usedIds || result.usedIds.size === 0) {\r\n                        contentArea.innerHTML = '<div class=\"gl-filter-panel__empty\">Aucune cat√©gorie disponible sur les couches visibles</div>';\r\n                        accordionGroup.dataset.lazyLoaded = \"true\";\r\n                        return;\r\n                    }\r\n\r\n                    // Construire le contenu HTML\r\n                    if (typeof window._buildCategoryTreeContent === \"function\") {\r\n                        const htmlContent = window._buildCategoryTreeContent(result);\r\n                        contentArea.innerHTML = htmlContent;\r\n\r\n                        // Attacher les event listeners\r\n                        if (typeof window._attachCategoryTreeListeners === \"function\") {\r\n                            window._attachCategoryTreeListeners(contentArea);\r\n                        }\r\n                    } else {\r\n                        contentArea.innerHTML = '<div class=\"gl-filter-panel__error\">Erreur: fonction de construction introuvable</div>';\r\n                    }\r\n\r\n                    // Marquer l'accord√©on comme ouvert\r\n                    LazyLoader.markAccordionOpen('categories', accordionGroup);\r\n\r\n                } else if (lazyType === 'tags') {\r\n                    const tags = LazyLoader.loadTags(currentTheme);\r\n\r\n                    // V√©rifier s'il y a des tags\r\n                    if (!tags || tags.length === 0) {\r\n                        contentArea.innerHTML = '<div class=\"gl-filter-panel__empty\">Aucun tag disponible sur les couches visibles</div>';\r\n                        accordionGroup.dataset.lazyLoaded = \"true\";\r\n                        return;\r\n                    }\r\n\r\n                    // Construire le contenu HTML\r\n                    if (typeof window._buildTagsListContent === \"function\") {\r\n                        const htmlContent = window._buildTagsListContent(tags);\r\n                        contentArea.innerHTML = htmlContent;\r\n\r\n                        // Attacher les event listeners\r\n                        if (typeof window._attachTagsListeners === \"function\") {\r\n                            window._attachTagsListeners(contentArea);\r\n                        }\r\n                    } else {\r\n                        contentArea.innerHTML = '<div class=\"gl-filter-panel__error\">Erreur: fonction de construction introuvable</div>';\r\n                    }\r\n\r\n                    // Marquer l'accord√©on comme ouvert\r\n                    LazyLoader.markAccordionOpen('tags', accordionGroup);\r\n                }\r\n\r\n                // Marquer comme charg√©\r\n                accordionGroup.dataset.lazyLoaded = \"true\";\r\n\r\n            } catch (err) {\r\n                Log.error(\"[FilterPanel] Erreur durant le chargement lazy:\", err);\r\n                while (contentArea.firstChild) contentArea.removeChild(contentArea.firstChild);\r\n                const errDiv = document.createElement('div');\r\n                errDiv.className = 'gl-filter-panel__error';\r\n                errDiv.textContent = 'Erreur: ' + err.message;\r\n                contentArea.appendChild(errDiv);\r\n            }\r\n        }, 10); // 10ms delay pour laisser l'accord√©on s'ouvrir\r\n    };\r\n\r\n})(window);\r\n","/**\r\n * GeoLeaf UI Filter Panel - Proximity\r\n * Gestion des filtres de proximit√© (GPS, manuel, cercle)\r\n *\r\n * @module ui/filter-panel/proximity\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n\r\n    // D√©pendances lazy\r\n    const getLog = () => (GeoLeaf.Log || console);\r\n\r\n    GeoLeaf._UIFilterPanelProximity = GeoLeaf._UIFilterPanelProximity || {};\r\n    GeoLeaf._UIFilterPanelProximity._eventCleanups = [];\r\n\r\n    /**\r\n     * Initialise la fonctionnalit√© de proximit√©\r\n     * @param {L.Map} map - Instance de carte Leaflet\r\n     */\r\n    GeoLeaf._UIFilterPanelProximity.initProximityFilter = function(map) {\r\n        const Log = getLog();\r\n\r\n        if (!map) {\r\n            Log.warn(\"[GeoLeaf.UI.FilterPanel] Carte non disponible pour le filtre de proximit√©\");\r\n            return;\r\n        }\r\n\r\n        // Stocker sur GeoLeaf.UI pour acc√®s global\r\n        GeoLeaf.UI._proximityMode = false;\r\n        GeoLeaf.UI._proximityCircle = null;\r\n        GeoLeaf.UI._proximityMarker = null;\r\n        GeoLeaf.UI._proximityMap = map;\r\n        GeoLeaf.UI._proximityClickHandler = null;\r\n\r\n        // √âcouter les changements sur le slider de rayon - avec cleanup tracking\r\n        const events = GeoLeaf.Utils?.events;\r\n        if (events) {\r\n            const inputHandler = function(evt) {\r\n                const slider = evt.target.closest(\"[data-filter-proximity-radius]\");\r\n                if (!slider) return;\r\n\r\n                const proximityControl = slider.closest(\".gl-filter-panel__proximity\");\r\n                if (!proximityControl) return;\r\n\r\n                const wrapper = proximityControl.closest(\"[data-gl-filter-id='proximity']\");\r\n                if (!wrapper) return;\r\n\r\n                const newRadius = parseFloat(slider.value);\r\n\r\n                // Mettre √† jour l'attribut sur le wrapper\r\n                wrapper.setAttribute(\"data-proximity-radius\", newRadius);\r\n\r\n                // Si un cercle existe, le mettre √† jour visuellement\r\n                if (GeoLeaf.UI._proximityCircle) {\r\n                    const radiusMeters = newRadius * 1000;\r\n                    GeoLeaf.UI._proximityCircle.setRadius(radiusMeters);\r\n                }\r\n            };\r\n\r\n            const clickHandler = function(evt) {\r\n                const btn = evt.target.closest(\"[data-filter-proximity-btn]\");\r\n                if (!btn) return;\r\n\r\n                evt.preventDefault();\r\n                GeoLeaf._UIFilterPanelProximity.toggleProximityMode(btn, map);\r\n            };\r\n\r\n            GeoLeaf._UIFilterPanelProximity._eventCleanups.push(\r\n                events.on(\r\n                    document,\r\n                    \"input\",\r\n                    inputHandler,\r\n                    false,\r\n                    'ProximityFilter.radiusInput'\r\n                )\r\n            );\r\n            GeoLeaf._UIFilterPanelProximity._eventCleanups.push(\r\n                events.on(\r\n                    document,\r\n                    \"click\",\r\n                    clickHandler,\r\n                    false,\r\n                    'ProximityFilter.buttonClick'\r\n                )\r\n            );\r\n        } else {\r\n            // Fallback sans cleanup\r\n            Log.warn('[ProximityFilter] EventListenerManager not available - listeners will not be cleaned up');\r\n            document.addEventListener(\"input\", function(evt) {\r\n                const slider = evt.target.closest(\"[data-filter-proximity-radius]\");\r\n                if (!slider) return;\r\n                const proximityControl = slider.closest(\".gl-filter-panel__proximity\");\r\n                if (!proximityControl) return;\r\n                const wrapper = proximityControl.closest(\"[data-gl-filter-id='proximity']\");\r\n                if (!wrapper) return;\r\n                const newRadius = parseFloat(slider.value);\r\n                wrapper.setAttribute(\"data-proximity-radius\", newRadius);\r\n                if (GeoLeaf.UI._proximityCircle) {\r\n                    const radiusMeters = newRadius * 1000;\r\n                    GeoLeaf.UI._proximityCircle.setRadius(radiusMeters);\r\n                }\r\n            });\r\n            document.addEventListener(\"click\", function(evt) {\r\n                const btn = evt.target.closest(\"[data-filter-proximity-btn]\");\r\n                if (!btn) return;\r\n                evt.preventDefault();\r\n                GeoLeaf._UIFilterPanelProximity.toggleProximityMode(btn, map);\r\n            });\r\n        }\r\n\r\n        Log.info(\"[GeoLeaf.UI.FilterPanel] Filtre de proximit√© initialis√©\");\r\n    };\r\n\r\n    /**\r\n     * Cleanup du filtre de proximit√©\r\n     */\r\n    GeoLeaf._UIFilterPanelProximity.destroy = function() {\r\n        const Log = getLog();\r\n\r\n        // Cleanup event listeners\r\n        if (GeoLeaf._UIFilterPanelProximity._eventCleanups && GeoLeaf._UIFilterPanelProximity._eventCleanups.length > 0) {\r\n            GeoLeaf._UIFilterPanelProximity._eventCleanups.forEach(cleanup => {\r\n                if (typeof cleanup === 'function') cleanup();\r\n            });\r\n            GeoLeaf._UIFilterPanelProximity._eventCleanups = [];\r\n            Log.info('[ProximityFilter] Event listeners cleaned up');\r\n        }\r\n\r\n        // Cleanup map references\r\n        if (GeoLeaf.UI._proximityCircle) {\r\n            GeoLeaf.UI._proximityMap.removeLayer(GeoLeaf.UI._proximityCircle);\r\n            GeoLeaf.UI._proximityCircle = null;\r\n        }\r\n        if (GeoLeaf.UI._proximityMarker) {\r\n            GeoLeaf.UI._proximityMap.removeLayer(GeoLeaf.UI._proximityMarker);\r\n            GeoLeaf.UI._proximityMarker = null;\r\n        }\r\n\r\n        GeoLeaf.UI._proximityMap = null;\r\n        GeoLeaf.UI._proximityMode = false;\r\n    };\r\n\r\n    /**\r\n     * Bascule le mode de proximit√©\r\n     * @param {HTMLElement} btn - Bouton de proximit√©\r\n     * @param {L.Map} map - Instance de carte\r\n     */\r\n    GeoLeaf._UIFilterPanelProximity.toggleProximityMode = function(btn, map) {\r\n        const Log = getLog();\r\n\r\n        GeoLeaf.UI._proximityMode = !GeoLeaf.UI._proximityMode;\r\n\r\n        const container = btn.closest(\".gl-filter-panel__proximity\");\r\n        const rangeWrapper = container.querySelector(\".gl-filter-panel__proximity-range\");\r\n        const instruction = container.querySelector(\".gl-filter-panel__proximity-instruction\");\r\n\r\n        if (GeoLeaf.UI._proximityMode) {\r\n            btn.textContent = \"D√©sactiver\";\r\n            btn.classList.add(\"is-active\");\r\n            if (rangeWrapper) rangeWrapper.style.display = \"block\";\r\n            if (instruction) instruction.style.display = \"block\";\r\n\r\n            // V√©rifier si la position GPS est disponible et r√©cente (< 5 minutes)\r\n            const hasRecentGPS = GeoLeaf.UI._userPosition &&\r\n                                (Date.now() - GeoLeaf.UI._userPosition.timestamp < 300000);\r\n\r\n            if (hasRecentGPS) {\r\n                GeoLeaf._UIFilterPanelProximity.activateGPSMode(container, map);\r\n            } else {\r\n                GeoLeaf._UIFilterPanelProximity.activateManualMode(container, map);\r\n            }\r\n\r\n        } else {\r\n            // D√©sactiver le mode proximit√©\r\n            GeoLeaf._UIFilterPanelProximity.deactivateProximityMode(btn, container, map);\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Active le mode GPS automatique\r\n     * @param {HTMLElement} container - Container de proximit√©\r\n     * @param {L.Map} map - Instance de carte\r\n     */\r\n    GeoLeaf._UIFilterPanelProximity.activateGPSMode = function(container, map) {\r\n        const Log = getLog();\r\n\r\n        Log.info(\"[GeoLeaf.UI.FilterPanel] Utilisation de la position GPS pour la recherche par proximit√©\");\r\n\r\n        const radiusInput = container.querySelector(\"[data-filter-proximity-radius]\");\r\n        const radius = radiusInput ? parseFloat(radiusInput.value) : 10;\r\n        const radiusMeters = radius * 1000;\r\n\r\n        const wrapper = container.closest(\"[data-gl-filter-id='proximity']\");\r\n        if (!wrapper) {\r\n            Log.warn(\"[GeoLeaf.UI.FilterPanel] Wrapper proximity non trouv√©\");\r\n            return;\r\n        }\r\n\r\n        // Supprimer les √©l√©ments existants\r\n        if (GeoLeaf.UI._proximityCircle) {\r\n            map.removeLayer(GeoLeaf.UI._proximityCircle);\r\n        }\r\n        if (GeoLeaf.UI._proximityMarker) {\r\n            map.removeLayer(GeoLeaf.UI._proximityMarker);\r\n        }\r\n\r\n        // Cr√©er le cercle √† la position GPS\r\n        const gpsLatLng = global.L.latLng(GeoLeaf.UI._userPosition.lat, GeoLeaf.UI._userPosition.lng);\r\n\r\n        const interactiveShapes = GeoLeaf.Config.get('ui.interactiveShapes', false);\r\n        GeoLeaf.UI._proximityCircle = global.L.circle(gpsLatLng, {\r\n            radius: radiusMeters,\r\n            color: \"#c2410c\",\r\n            fillColor: \"#c2410c\",\r\n            fillOpacity: 0.2,\r\n            weight: 2,\r\n            interactive: interactiveShapes\r\n        }).addTo(map);\r\n\r\n        // Ne pas cr√©er de marqueur suppl√©mentaire si la g√©olocalisation est active\r\n        if (!GeoLeaf.UI._geolocationActive) {\r\n            // Mode GPS mais g√©olocalisation pas en tracking continu : cr√©er un marqueur draggable\r\n            GeoLeaf.UI._proximityMarker = global.L.marker(gpsLatLng, {\r\n                draggable: true,\r\n                icon: global.L.divIcon({\r\n                    className: 'gl-proximity-gps-marker',\r\n                    html: '<div style=\"width: 20px; height: 20px; background: #2563eb; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.3);\"></div>',\r\n                    iconSize: [20, 20],\r\n                    iconAnchor: [10, 10]\r\n                })\r\n            }).addTo(map);\r\n\r\n            // G√©rer le d√©placement du marqueur\r\n            GeoLeaf.UI._proximityMarker.on('dragend', function() {\r\n                const newLatLng = GeoLeaf.UI._proximityMarker.getLatLng();\r\n                if (GeoLeaf.UI._proximityCircle) {\r\n                    GeoLeaf.UI._proximityCircle.setLatLng(newLatLng);\r\n                }\r\n                wrapper.setAttribute(\"data-proximity-lat\", newLatLng.lat);\r\n                wrapper.setAttribute(\"data-proximity-lng\", newLatLng.lng);\r\n                Log.info(\"[GeoLeaf.UI.FilterPanel] Point de proximit√© GPS d√©plac√©:\", {\r\n                    lat: newLatLng.lat,\r\n                    lng: newLatLng.lng,\r\n                    radius: radius\r\n                });\r\n            });\r\n        } else {\r\n            GeoLeaf.UI._proximityMarker = null;\r\n            Log.info(\"[GeoLeaf.UI.FilterPanel] Cercle de proximit√© affich√© autour du marqueur GPS\");\r\n        }\r\n\r\n        // D√©finir les attributs sur le wrapper\r\n        wrapper.setAttribute(\"data-proximity-lat\", gpsLatLng.lat);\r\n        wrapper.setAttribute(\"data-proximity-lng\", gpsLatLng.lng);\r\n        wrapper.setAttribute(\"data-proximity-radius\", radius);\r\n        wrapper.setAttribute(\"data-proximity-active\", \"true\");\r\n\r\n        // Centrer la carte sur la position GPS\r\n        map.setView(gpsLatLng, Math.max(map.getZoom(), 14), {\r\n            animate: true,\r\n            duration: 0.5\r\n        });\r\n\r\n        Log.info(\"[GeoLeaf.UI.FilterPanel] Point de proximit√© GPS d√©fini:\", {\r\n            lat: gpsLatLng.lat,\r\n            lng: gpsLatLng.lng,\r\n            radius: radius\r\n        });\r\n\r\n        // Pas de handler de clic n√©cessaire en mode GPS\r\n        GeoLeaf.UI._proximityClickHandler = null;\r\n    };\r\n\r\n    /**\r\n     * Active le mode manuel (clic sur la carte)\r\n     * @param {HTMLElement} container - Container de proximit√©\r\n     * @param {L.Map} map - Instance de carte\r\n     */\r\n    GeoLeaf._UIFilterPanelProximity.activateManualMode = function(container, map) {\r\n        const Log = getLog();\r\n\r\n        Log.info(\"[GeoLeaf.UI.FilterPanel] Mode manuel : cliquez sur la carte pour d√©finir le point de recherche\");\r\n\r\n        map.getContainer().style.cursor = \"crosshair\";\r\n\r\n        // Cr√©er le handler pour pouvoir le retirer plus tard\r\n        GeoLeaf.UI._proximityClickHandler = function(e) {\r\n            const radiusInput = container.querySelector(\"[data-filter-proximity-radius]\");\r\n            const radius = radiusInput ? parseFloat(radiusInput.value) : 10;\r\n            const radiusMeters = radius * 1000;\r\n\r\n            const wrapper = container.closest(\"[data-gl-filter-id='proximity']\");\r\n            if (!wrapper) {\r\n                Log.warn(\"[GeoLeaf.UI.FilterPanel] Wrapper proximity non trouv√©\");\r\n                return;\r\n            }\r\n\r\n            if (GeoLeaf.UI._proximityCircle) {\r\n                map.removeLayer(GeoLeaf.UI._proximityCircle);\r\n            }\r\n            if (GeoLeaf.UI._proximityMarker) {\r\n                map.removeLayer(GeoLeaf.UI._proximityMarker);\r\n            }\r\n\r\n            const interactiveShapes = GeoLeaf.Config.get('ui.interactiveShapes', false);\r\n            GeoLeaf.UI._proximityCircle = global.L.circle(e.latlng, {\r\n                radius: radiusMeters,\r\n                color: \"#c2410c\",\r\n                fillColor: \"#c2410c\",\r\n                fillOpacity: 0.2,\r\n                weight: 2,\r\n                interactive: interactiveShapes\r\n            }).addTo(map);\r\n\r\n            GeoLeaf.UI._proximityMarker = global.L.marker(e.latlng, {\r\n                draggable: true\r\n            }).addTo(map);\r\n\r\n            // G√©rer le d√©placement du marqueur\r\n            GeoLeaf.UI._proximityMarker.on('dragend', function() {\r\n                const newLatLng = GeoLeaf.UI._proximityMarker.getLatLng();\r\n\r\n                if (GeoLeaf.UI._proximityCircle) {\r\n                    GeoLeaf.UI._proximityCircle.setLatLng(newLatLng);\r\n                }\r\n\r\n                wrapper.setAttribute(\"data-proximity-lat\", newLatLng.lat);\r\n                wrapper.setAttribute(\"data-proximity-lng\", newLatLng.lng);\r\n\r\n                Log.info(\"[GeoLeaf.UI.FilterPanel] Point de proximit√© d√©plac√©:\", {\r\n                    lat: newLatLng.lat,\r\n                    lng: newLatLng.lng,\r\n                    radius: radius\r\n                });\r\n            });\r\n\r\n            // D√©finir les attributs sur le wrapper\r\n            wrapper.setAttribute(\"data-proximity-lat\", e.latlng.lat);\r\n            wrapper.setAttribute(\"data-proximity-lng\", e.latlng.lng);\r\n            wrapper.setAttribute(\"data-proximity-radius\", radius);\r\n            wrapper.setAttribute(\"data-proximity-active\", \"true\");\r\n\r\n            map.getContainer().style.cursor = \"\";\r\n\r\n            Log.info(\"[GeoLeaf.UI.FilterPanel] Point de proximit√© d√©fini:\", {\r\n                lat: e.latlng.lat,\r\n                lng: e.latlng.lng,\r\n                radius: radius\r\n            });\r\n\r\n            // Nettoyer le handler apr√®s le premier clic\r\n            map.off('click', GeoLeaf.UI._proximityClickHandler);\r\n            GeoLeaf.UI._proximityClickHandler = null;\r\n        };\r\n\r\n        // Attacher le handler √† la carte\r\n        map.on('click', GeoLeaf.UI._proximityClickHandler);\r\n    };\r\n\r\n    /**\r\n     * D√©sactive le mode de proximit√©\r\n     * @param {HTMLElement} btn - Bouton de proximit√©\r\n     * @param {HTMLElement} container - Container de proximit√©\r\n     * @param {L.Map} map - Instance de carte\r\n     */\r\n    GeoLeaf._UIFilterPanelProximity.deactivateProximityMode = function(btn, container, map) {\r\n        const Log = getLog();\r\n\r\n        btn.textContent = \"Activer\";\r\n        btn.classList.remove(\"is-active\");\r\n\r\n        const rangeWrapper = container.querySelector(\".gl-filter-panel__proximity-range\");\r\n        const instruction = container.querySelector(\".gl-filter-panel__proximity-instruction\");\r\n\r\n        if (rangeWrapper) rangeWrapper.style.display = \"none\";\r\n        if (instruction) instruction.style.display = \"none\";\r\n\r\n        map.getContainer().style.cursor = \"\";\r\n\r\n        // Retirer le handler de clic\r\n        if (GeoLeaf.UI._proximityClickHandler) {\r\n            map.off('click', GeoLeaf.UI._proximityClickHandler);\r\n            GeoLeaf.UI._proximityClickHandler = null;\r\n        }\r\n\r\n        // Retirer le cercle et le marqueur\r\n        if (GeoLeaf.UI._proximityCircle) {\r\n            map.removeLayer(GeoLeaf.UI._proximityCircle);\r\n            GeoLeaf.UI._proximityCircle = null;\r\n        }\r\n        if (GeoLeaf.UI._proximityMarker) {\r\n            map.removeLayer(GeoLeaf.UI._proximityMarker);\r\n            GeoLeaf.UI._proximityMarker = null;\r\n        }\r\n\r\n        // Retirer les attributs du wrapper\r\n        const wrapper = container.closest(\"[data-gl-filter-id='proximity']\");\r\n        if (wrapper) {\r\n            wrapper.removeAttribute(\"data-proximity-active\");\r\n            wrapper.removeAttribute(\"data-proximity-lat\");\r\n            wrapper.removeAttribute(\"data-proximity-lng\");\r\n        }\r\n\r\n        Log.info(\"[GeoLeaf.UI.FilterPanel] Mode proximit√© d√©sactiv√©\");\r\n    };\r\n\r\n})(window);\r\n","/**\n * GeoLeaf UI Filter Panel - Core\n * API publique et d√©l√©gation vers les sous-modules\n *\n * @module ui/filter-panel/core\n */\n(function (global) {\n    \"use strict\";\n\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\n\n    // D√©pendances lazy\n    const getLog = () => (GeoLeaf.Log || console);\n    const getShared = () => GeoLeaf._UIFilterPanelShared;\n    const getStateReader = () => GeoLeaf._UIFilterPanelStateReader;\n    const getApplier = () => GeoLeaf._UIFilterPanelApplier;\n    const getRenderer = () => GeoLeaf._UIFilterPanelRenderer;\n    const getProximity = () => GeoLeaf._UIFilterPanelProximity;\n\n    // Cr√©er le namespace si n√©cessaire\n    GeoLeaf._UIFilterPanel = GeoLeaf._UIFilterPanel || {};\n\n    // ========================================\n    //   API PUBLIQUE - D√©l√©gation vers sous-modules\n    // ========================================\n\n    /**\n     * Construit le panneau de filtres depuis la configuration du profil actif\n     * @param {Object} options - Options\n     */\n    GeoLeaf._UIFilterPanel.buildFilterPanelFromActiveProfile = function(options) {\n        const Renderer = getRenderer();\n        if (Renderer && Renderer.buildFilterPanelFromActiveProfile) {\n            return Renderer.buildFilterPanelFromActiveProfile(options);\n        }\n        getLog().error(\"[GeoLeaf.UI.FilterPanel] Module Renderer non charg√©\");\n    };\n\n    /**\n     * Bascule la visibilit√© du panneau de filtres\n     * @param {boolean} [forceState]\n     */\n    GeoLeaf._UIFilterPanel.toggleFilterPanelVisibility = function(forceState) {\n        const Renderer = getRenderer();\n        if (Renderer && Renderer.toggleFilterPanelVisibility) {\n            return Renderer.toggleFilterPanelVisibility(forceState);\n        }\n    };\n\n    /**\n     * Initialise le bouton toggle du panneau de filtres\n     */\n    GeoLeaf._UIFilterPanel.initFilterToggle = function() {\n        const Renderer = getRenderer();\n        if (Renderer && Renderer.initFilterToggle) {\n            return Renderer.initFilterToggle();\n        }\n    };\n\n    /**\n     * Rafra√Æchit les badges de tags\n     */\n    GeoLeaf._UIFilterPanel.refreshFilterTags = function() {\n        const Renderer = getRenderer();\n        if (Renderer && Renderer.refreshFilterTags) {\n            return Renderer.refreshFilterTags();\n        }\n    };\n\n    /**\n     * Applique les filtres initiaux\n     */\n    GeoLeaf._UIFilterPanel.applyFiltersInitial = function() {\n        const Applier = getApplier();\n        if (Applier && Applier.applyFiltersInitial) {\n            return Applier.applyFiltersInitial();\n        }\n    };\n\n    /**\n     * Initialise le filtre de proximit√©\n     * @param {L.Map} map\n     */\n    GeoLeaf._UIFilterPanel.initProximityFilter = function(map) {\n        const Proximity = getProximity();\n        if (Proximity && Proximity.initProximityFilter) {\n            return Proximity.initProximityFilter(map);\n        }\n    };\n\n    /**\n     * Retourne l'√©l√©ment DOM du panneau de filtres\n     * @returns {HTMLElement|null}\n     */\n    GeoLeaf._UIFilterPanel._getFilterPanelElement = function() {\n        const Shared = getShared();\n        if (Shared && Shared.getFilterPanelElement) {\n            return Shared.getFilterPanelElement();\n        }\n        return null;\n    };\n\n    /**\n     * R√©cup√®re les POI de base\n     * @returns {Array}\n     */\n    GeoLeaf._UIFilterPanel._getBasePois = function() {\n        const Shared = getShared();\n        if (Shared && Shared.getBasePois) {\n            return Shared.getBasePois();\n        }\n        return [];\n    };\n\n    /**\n     * R√©cup√®re les routes de base\n     * @returns {Array}\n     */\n    GeoLeaf._UIFilterPanel._getBaseRoutes = function() {\n        const Shared = getShared();\n        if (Shared && Shared.getBaseRoutes) {\n            return Shared.getBaseRoutes();\n        }\n        return [];\n    };\n\n    /**\n     * Lit l'√©tat des filtres depuis le panneau\n     * @param {HTMLElement} panelEl\n     * @returns {Object}\n     */\n    GeoLeaf._UIFilterPanel._readFiltersFromPanel = function(panelEl) {\n        const StateReader = getStateReader();\n        if (StateReader && StateReader.readFiltersFromPanel) {\n            return StateReader.readFiltersFromPanel(panelEl);\n        }\n        return {};\n    };\n\n    /**\n     * Filtre une liste de POI\n     * @param {Array} basePois\n     * @param {Object} filterState\n     * @returns {Array}\n     */\n    GeoLeaf._UIFilterPanel._filterPoiList = function(basePois, filterState) {\n        const Applier = getApplier();\n        if (Applier && Applier.filterPoiList) {\n            return Applier.filterPoiList(basePois, filterState);\n        }\n        return basePois || [];\n    };\n\n    /**\n     * Filtre une liste de routes\n     * @param {Array} baseRoutes\n     * @param {Object} filterState\n     * @returns {Array}\n     */\n    GeoLeaf._UIFilterPanel._filterRouteList = function(baseRoutes, filterState) {\n        const Applier = getApplier();\n        if (Applier && Applier.filterRouteList) {\n            return Applier.filterRouteList(baseRoutes, filterState);\n        }\n        return baseRoutes || [];\n    };\n\n    /**\n     * Rafra√Æchit la couche POI\n     * @param {Array} filteredPois\n     */\n    GeoLeaf._UIFilterPanel._refreshPoiLayer = function(filteredPois) {\n        const Applier = getApplier();\n        if (Applier && Applier.refreshPoiLayer) {\n            return Applier.refreshPoiLayer(filteredPois);\n        }\n    };\n\n})(window);\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n/**\r\n * GeoLeaf UI Module - Filter Panel (Aggregator)\r\n *\r\n * Ce fichier est un agr√©gateur pour la r√©trocompatibilit√©.\r\n * La logique a √©t√© d√©plac√©e dans les sous-modules :\r\n * - filter-panel/shared.js       : Helpers de donn√©es partag√©s\r\n * - filter-panel/state-reader.js : Lecture de l'√©tat des filtres\r\n * - filter-panel/applier.js      : Application des filtres\r\n * - filter-panel/renderer.js     : Construction du panneau HTML\r\n * - filter-panel/proximity.js    : Gestion des filtres de proximit√©\r\n * - filter-panel/core.js         : API publique et d√©l√©gation\r\n *\r\n * @module ui/filter-panel\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n\r\n    // V√©rifier que les sous-modules sont charg√©s\r\n    const requiredModules = [\r\n        '_UIFilterPanelShared',\r\n        '_UIFilterPanelStateReader',\r\n        '_UIFilterPanelApplier',\r\n        '_UIFilterPanelRenderer',\r\n        '_UIFilterPanelProximity',\r\n        '_UIFilterPanel'\r\n    ];\r\n\r\n    const missingModules = requiredModules.filter(m => !GeoLeaf[m]);\r\n\r\n    if (missingModules.length > 0) {\r\n        const Log = GeoLeaf.Log || console;\r\n        Log.error(\"[GeoLeaf.UI.FilterPanel] Sous-modules manquants:\", missingModules.join(', '));\r\n        Log.error(\"[GeoLeaf.UI.FilterPanel] Assurez-vous de charger les modules filter-panel/*.js avant filter-panel.js\");\r\n    }\r\n\r\n    // L'API publique est expos√©e via GeoLeaf._UIFilterPanel (dans core.js)\r\n    // Ce fichier sert uniquement de point de validation\r\n\r\n})(window);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n/**\r\n * GeoLeaf UI Module - Main Orchestrator (Sprint 4.4 Refactored)\r\n * Orchestrateur principal pour l'interface utilisateur avec d√©l√©gation compl√®te vers sous-modules\r\n *\r\n * @module geoleaf.ui\r\n * @author Assistant\r\n * @version 4.4.0 - Modular Architecture\r\n *\r\n * RESPONSABILIT√âS:\r\n * ‚úÖ Exposition de l'API publique unifi√©e\r\n * ‚úÖ D√©l√©gation vers sous-modules sp√©cialis√©s\r\n * ‚úÖ Initialisation et coordination des composants\r\n * ‚úÖ Compatibility layer pour le code legacy\r\n *\r\n * MODULES D√âL√âGU√âS:\r\n * - Theme Management    ‚Üí _UITheme (ui/theme.js)\r\n * - Controls            ‚Üí _UIControls (ui/controls.js)\r\n * - Panel Builder       ‚Üí _UIPanelBuilder (ui/panel-builder.js)\r\n * - Filter Panel        ‚Üí _UIFilterPanel (ui/filter-panel.js)\r\n * - Notifications       ‚Üí _UINotifications (ui/notifications.js)\r\n * - Event Delegation    ‚Üí _UIEventDelegation (ui/event-delegation.js)\r\n * - Filter State Mgmt   ‚Üí _UIFilterStateManager (ui/filter-state-manager.js)\r\n */\r\n(function (window) {\r\n    \"use strict\";\r\n\r\n    // ========================================\r\n    //   NAMESPACE & DEPENDENCIES\r\n    // ========================================\r\n\r\n    const GeoLeaf = window.GeoLeaf || (window.GeoLeaf = {});\r\n    const Log = GeoLeaf.Log;\r\n\r\n    GeoLeaf.UI = GeoLeaf.UI || {};\r\n\r\n    // Helper pour createElement unifi√©\r\n    const $create = (tag, props, ...children) => {\r\n        if (GeoLeaf.Utils && GeoLeaf.Utils.createElement) {\r\n            return GeoLeaf.Utils.createElement(tag, props, ...children);\r\n        }\r\n        // Fallback to native if DomHelpers not loaded yet\r\n        const el = document.createElement(tag);\r\n        if (props) {\r\n            if (props.className) el.className = props.className;\r\n            if (props.textContent) el.textContent = props.textContent;\r\n        }\r\n        return el;\r\n    };\r\n\r\n    // ========================================\r\n    //   MODULE AVAILABILITY CHECKS\r\n    // ========================================\r\n\r\n    /**\r\n     * V√©rifie la disponibilit√© des modules requis\r\n     * @returns {Object} Status de disponibilit√© des modules\r\n     */\r\n    function checkModuleAvailability() {\r\n        const modules = {\r\n            theme: !!GeoLeaf._UITheme,\r\n            controls: !!GeoLeaf._UIControls,\r\n            panelBuilder: !!(GeoLeaf._UIPanelBuilder || GeoLeaf.UI.PanelBuilder),\r\n            filterPanel: !!GeoLeaf._UIFilterPanel,\r\n            notifications: !!GeoLeaf._UINotifications,\r\n            eventDelegation: !!GeoLeaf._UIEventDelegation,\r\n            filterStateManager: !!GeoLeaf._UIFilterStateManager\r\n        };\r\n\r\n        const missing = Object.entries(modules)\r\n            .filter(([name, available]) => !available)\r\n            .map(([name]) => name);\r\n\r\n        if (missing.length > 0 && Log) {\r\n            Log.warn(\"[UI.Orchestrator] Modules manquants:\", missing.join(', '));\r\n        }\r\n\r\n        return { modules, missing, allAvailable: missing.length === 0 };\r\n    }\r\n\r\n    // ========================================\r\n    //   API DELEGATION - THEME MANAGEMENT\r\n    // ========================================\r\n\r\n    if (GeoLeaf._UITheme) {\r\n        // D√©l√©gation directe des fonctions th√®me\r\n        GeoLeaf.UI.initThemeToggle = GeoLeaf._UITheme.initThemeToggle;\r\n        GeoLeaf.UI.toggleTheme = GeoLeaf._UITheme.toggleTheme;\r\n        GeoLeaf.UI.applyTheme = GeoLeaf._UITheme.applyTheme;\r\n        GeoLeaf.UI.getCurrentTheme = GeoLeaf._UITheme.getCurrentTheme;\r\n\r\n        // Compatibility aliases\r\n        GeoLeaf.UI.setTheme = GeoLeaf._UITheme.applyTheme;\r\n    }\r\n\r\n    // ========================================\r\n    //   API DELEGATION - CONTROLS\r\n    // ========================================\r\n\r\n    if (GeoLeaf._UIControls) {\r\n        // D√©l√©gation des contr√¥les Leaflet\r\n        GeoLeaf.UI.initFullscreenControl = GeoLeaf._UIControls.initFullscreenControl;\r\n        GeoLeaf.UI.initGeolocationControl = GeoLeaf._UIControls.initGeolocationControl;\r\n        GeoLeaf.UI.initPoiAddControl = GeoLeaf._UIControls.initPoiAddControl;\r\n        GeoLeaf.UI.initScaleControl = GeoLeaf._UIControls.initScaleControl;\r\n\r\n        // √âtat g√©olocalisation (maintenu pour compatibilit√©)\r\n        GeoLeaf.UI._userPosition = null;\r\n        GeoLeaf.UI._geolocationActive = false;\r\n        GeoLeaf.UI._geolocationWatchId = null;\r\n    }\r\n\r\n    // ========================================\r\n    //   API DELEGATION - PANEL BUILDER\r\n    // ========================================\r\n\r\n    if (GeoLeaf._UIPanelBuilder || GeoLeaf.UI.PanelBuilder) {\r\n        // D√©l√©gation vers panel builder\r\n        GeoLeaf.UI.buildSidePanel = (GeoLeaf._UIPanelBuilder && GeoLeaf._UIPanelBuilder.buildSidePanel) ||\r\n                                   (GeoLeaf.UI.PanelBuilder && GeoLeaf.UI.PanelBuilder.buildSidePanel);\r\n        GeoLeaf.UI.renderPoiSidePanel = (GeoLeaf._UIPanelBuilder && GeoLeaf._UIPanelBuilder.renderPoiSidePanel) ||\r\n                                       (GeoLeaf.UI.PanelBuilder && GeoLeaf.UI.PanelBuilder.renderPoiSidePanel);\r\n\r\n        // Legacy compatibility pour POI panels\r\n        GeoLeaf.UI.renderPoiPanelWithLayout = function(poi, layout, container) {\r\n            if (GeoLeaf.UI.renderPoiSidePanel) {\r\n                return GeoLeaf.UI.renderPoiSidePanel(poi, layout, container);\r\n            }\r\n            if (Log) Log.warn(\"[UI.Orchestrator] renderPoiPanelWithLayout: PanelBuilder non disponible\");\r\n        };\r\n\r\n        // Helper functions (deprecated, pour compatibilit√©)\r\n        GeoLeaf.UI._resolveField = function(poi, fieldPath) {\r\n            if (GeoLeaf._UIDomUtils && GeoLeaf._UIDomUtils.resolveField) {\r\n                return GeoLeaf._UIDomUtils.resolveField(poi, fieldPath);\r\n            }\r\n            return null;\r\n        };\r\n\r\n        GeoLeaf.UI._createPlainSection = function(label, innerContent, extraClass) {\r\n            if (GeoLeaf.UI.PanelBuilder && GeoLeaf.UI.PanelBuilder.createPlainSection) {\r\n                return GeoLeaf.UI.PanelBuilder.createPlainSection(label, innerContent, extraClass);\r\n            }\r\n            return $create(\"section\", { className: \"gl-poi-panel__section \" + (extraClass || \"\") });\r\n        };\r\n\r\n        GeoLeaf.UI._createAccordionSection = function(label, innerContent, options) {\r\n            if (GeoLeaf.UI.PanelBuilder && GeoLeaf.UI.PanelBuilder.createAccordionSection) {\r\n                return GeoLeaf.UI.PanelBuilder.createAccordionSection(label, innerContent, options);\r\n            }\r\n            return $create(\"section\", { className: \"gl-poi-panel__section--accordion\" });\r\n        };\r\n    }\r\n\r\n    // ========================================\r\n    //   API DELEGATION - FILTER PANEL\r\n    // ========================================\r\n\r\n    if (GeoLeaf._UIFilterPanel) {\r\n        // D√©l√©gation des fonctions filtres\r\n        GeoLeaf.UI.buildFilterPanelFromActiveProfile = GeoLeaf._UIFilterPanel.buildFilterPanelFromActiveProfile;\r\n        GeoLeaf.UI.refreshFilterTags = GeoLeaf._UIFilterPanel.refreshFilterTags;\r\n        GeoLeaf.UI.initFilterToggle = GeoLeaf._UIFilterPanel.initFilterToggle;\r\n        GeoLeaf.UI.initProximityFilter = GeoLeaf._UIFilterPanel.initProximityFilter;\r\n        GeoLeaf.UI._getBasePois = GeoLeaf._UIFilterPanel.getBasePois;\r\n        GeoLeaf.UI._getBaseRoutes = GeoLeaf._UIFilterPanel.getBaseRoutes;\r\n\r\n        // Filter state integration si disponible\r\n        if (GeoLeaf._UIFilterStateManager) {\r\n            // Bridge entre filter panel et state manager\r\n            GeoLeaf.UI.resetAllFilters = function() {\r\n                GeoLeaf._UIFilterStateManager.resetAllFilters();\r\n                if (GeoLeaf._UIFilterPanel.refreshFilterTags) {\r\n                    GeoLeaf._UIFilterPanel.refreshFilterTags();\r\n                }\r\n            };\r\n\r\n            GeoLeaf.UI.getActiveFilters = GeoLeaf._UIFilterStateManager.getActiveFiltersSummary;\r\n            GeoLeaf.UI.hasActiveFilters = GeoLeaf._UIFilterStateManager.hasActiveFilters;\r\n        }\r\n    }\r\n\r\n    // ========================================\r\n    //   API DELEGATION - NOTIFICATIONS\r\n    // ========================================\r\n\r\n    if (GeoLeaf._UINotifications) {\r\n        // Cr√©er un namespace d√©di√© pour l'acc√®s complet\r\n        GeoLeaf.UI.Notifications = {\r\n            show: GeoLeaf._UINotifications.show.bind(GeoLeaf._UINotifications),\r\n            success: GeoLeaf._UINotifications.success.bind(GeoLeaf._UINotifications),\r\n            error: GeoLeaf._UINotifications.error.bind(GeoLeaf._UINotifications),\r\n            warning: GeoLeaf._UINotifications.warning.bind(GeoLeaf._UINotifications),\r\n            info: GeoLeaf._UINotifications.info.bind(GeoLeaf._UINotifications),\r\n            clearAll: GeoLeaf._UINotifications.clearAll.bind(GeoLeaf._UINotifications),\r\n            enable: GeoLeaf._UINotifications.enable.bind(GeoLeaf._UINotifications),\r\n            disable: GeoLeaf._UINotifications.disable.bind(GeoLeaf._UINotifications),\r\n            getStatus: GeoLeaf._UINotifications.getStatus.bind(GeoLeaf._UINotifications)\r\n        };\r\n\r\n        // Raccourcis globaux pour l'API publique (r√©trocompatibilit√©)\r\n        GeoLeaf.UI.showNotification = GeoLeaf._UINotifications.show.bind(GeoLeaf._UINotifications);\r\n        GeoLeaf.UI.showSuccess = GeoLeaf._UINotifications.success.bind(GeoLeaf._UINotifications);\r\n        GeoLeaf.UI.showError = GeoLeaf._UINotifications.error.bind(GeoLeaf._UINotifications);\r\n        GeoLeaf.UI.showWarning = GeoLeaf._UINotifications.warning.bind(GeoLeaf._UINotifications);\r\n        GeoLeaf.UI.showInfo = GeoLeaf._UINotifications.info.bind(GeoLeaf._UINotifications);\r\n        GeoLeaf.UI.clearNotifications = GeoLeaf._UINotifications.clearAll.bind(GeoLeaf._UINotifications);\r\n    }\r\n\r\n    // ========================================\r\n    //   EVENT DELEGATION INTEGRATION\r\n    // ========================================\r\n\r\n    let _delegationInitialized = false;\r\n\r\n    /**\r\n     * Initialise la d√©l√©gation d'√©v√©nements pour l'interface\r\n     * @param {Object} options - Options d'initialisation\r\n     */\r\n    function initializeEventDelegation(options = {}) {\r\n        if (_delegationInitialized || !GeoLeaf._UIEventDelegation) return;\r\n\r\n        const { mapContainer, filterContainer } = options;\r\n\r\n        // Event listeners pour les filtres si disponible\r\n        if (filterContainer && GeoLeaf._UIFilterStateManager) {\r\n            GeoLeaf._UIEventDelegation.attachFilterInputEvents(\r\n                filterContainer,\r\n                () => {\r\n                    // Callback de changement de filtre - d√©l√©guer vers FilterPanel\r\n                    if (GeoLeaf._UIFilterPanel && GeoLeaf._UIFilterPanel.refreshFilterTags) {\r\n                        GeoLeaf._UIFilterPanel.refreshFilterTags();\r\n                    }\r\n                }\r\n            );\r\n        }\r\n\r\n        // Event listeners pour les accord√©ons\r\n        document.addEventListener('DOMContentLoaded', () => {\r\n            const accordionContainers = document.querySelectorAll('.gl-poi-panel, .gl-filter-panel');\r\n            accordionContainers.forEach(container => {\r\n                GeoLeaf._UIEventDelegation.attachAccordionEvents(container);\r\n            });\r\n        });\r\n\r\n        _delegationInitialized = true;\r\n        if (Log) Log.info(\"[UI.Orchestrator] Event delegation initialis√©e\");\r\n    }\r\n\r\n    // ========================================\r\n    //   MAIN INITIALIZATION\r\n    // ========================================\r\n\r\n    /**\r\n     * Point d'entr√©e principal pour l'initialisation UI\r\n     * @param {Object} options - Options d'initialisation\r\n     * @param {HTMLElement} options.map - Instance carte Leaflet\r\n     * @param {HTMLElement} options.mapContainer - Conteneur DOM de la carte\r\n     * @param {HTMLElement} options.filterContainer - Conteneur des filtres\r\n     * @param {string} options.buttonSelector - S√©lecteur du bouton th√®me\r\n     * @param {boolean} options.autoInitOnDomReady - Auto-init au DOMContentLoaded\r\n     * @param {boolean} options.enableEventDelegation - Active la d√©l√©gation d'√©v√©nements (d√©faut: true)\r\n     */\r\n    GeoLeaf.UI.init = function(options = {}) {\r\n        const config = {\r\n            buttonSelector: options.buttonSelector || '[data-gl-role=\"theme-toggle\"]',\r\n            autoInitOnDomReady: !!options.autoInitOnDomReady,\r\n            enableEventDelegation: options.enableEventDelegation !== false\r\n        };\r\n\r\n        // V√©rification des modules\r\n        const { missing, allAvailable } = checkModuleAvailability();\r\n        if (!allAvailable && Log) {\r\n            Log.warn(\"[UI.Orchestrator] Initialisation avec modules manquants:\", missing);\r\n        }\r\n\r\n        // Initialisation du th√®me\r\n        if (GeoLeaf.UI.initThemeToggle) {\r\n            try {\r\n                GeoLeaf.UI.initThemeToggle(config);\r\n            } catch (error) {\r\n                if (Log) Log.error(\"[UI.Orchestrator] Erreur init th√®me:\", error);\r\n            }\r\n        }\r\n\r\n        // Initialisation des contr√¥les si carte disponible\r\n        if (options.map && options.mapContainer) {\r\n            // Fullscreen control\r\n            if (GeoLeaf.UI.initFullscreenControl) {\r\n                try {\r\n                    GeoLeaf.UI.initFullscreenControl(options.map, options.mapContainer);\r\n                } catch (error) {\r\n                    if (Log) Log.error(\"[UI.Orchestrator] Erreur fullscreen control:\", error);\r\n                }\r\n            }\r\n\r\n            // Geolocation control - forcer l'initialisation\r\n            if (GeoLeaf.UI.initGeolocationControl) {\r\n                try {\r\n                    GeoLeaf.UI.initGeolocationControl(options.map, options.config);\r\n                } catch (error) {\r\n                    if (Log) Log.error(\"[UI.Orchestrator] Erreur geolocation control:\", error);\r\n                }\r\n            }\r\n\r\n            // POI Add control - forcer l'initialisation\r\n            if (GeoLeaf.UI.initPoiAddControl) {\r\n                try {\r\n                    GeoLeaf.UI.initPoiAddControl(options.map, options.config);\r\n                } catch (error) {\r\n                    if (Log) Log.error(\"[UI.Orchestrator] Erreur POI add control:\", error);\r\n                }\r\n            }\r\n\r\n            // Scale control\r\n            if (GeoLeaf.UI.initScaleControl) {\r\n                try {\r\n                    GeoLeaf.UI.initScaleControl(options.map);\r\n                } catch (error) {\r\n                    if (Log) Log.error(\"[UI.Orchestrator] Erreur scale control:\", error);\r\n                }\r\n            }\r\n        }\r\n\r\n        // Initialisation de la d√©l√©gation d'√©v√©nements\r\n        if (config.enableEventDelegation) {\r\n            initializeEventDelegation({\r\n                mapContainer: options.mapContainer,\r\n                filterContainer: options.filterContainer\r\n            });\r\n        }\r\n\r\n        // Initialisation du filter state manager si profil disponible\r\n        if (GeoLeaf._UIFilterStateManager && GeoLeaf.Config) {\r\n            const activeProfile = GeoLeaf.Config.getActiveProfile?.() || null;\r\n            if (activeProfile && activeProfile.filters) {\r\n                try {\r\n                    GeoLeaf._UIFilterStateManager.initializeFromProfile(activeProfile);\r\n                } catch (error) {\r\n                    if (Log) Log.error(\"[UI.Orchestrator] Erreur init filter state:\", error);\r\n                }\r\n            }\r\n        }\r\n\r\n        if (Log) {\r\n            Log.info(`[UI.Orchestrator] Initialisation termin√©e (modules: ${Object.keys(checkModuleAvailability().modules).length})`);\r\n        }\r\n    };\r\n\r\n    // ========================================\r\n    //   UTILITY & DEBUG FUNCTIONS\r\n    // ========================================\r\n\r\n    /**\r\n     * Informations de debug sur l'√©tat des modules\r\n     * @returns {Object} Status d√©taill√© des modules\r\n     */\r\n    GeoLeaf.UI.getModuleStatus = function() {\r\n        return checkModuleAvailability();\r\n    };\r\n\r\n    /**\r\n     * Nettoyage g√©n√©ral des resources UI\r\n     */\r\n    GeoLeaf.UI.cleanup = function() {\r\n        // Nettoyage des event listeners\r\n        if (GeoLeaf._UIEventDelegation && GeoLeaf._UIEventDelegation.cleanupAllListeners) {\r\n            const cleaned = GeoLeaf._UIEventDelegation.cleanupAllListeners();\r\n            if (Log && cleaned > 0) {\r\n                Log.info(`[UI.Orchestrator] ${cleaned} event listeners nettoy√©s`);\r\n            }\r\n        }\r\n\r\n        // Reset flag d√©l√©gation\r\n        _delegationInitialized = false;\r\n\r\n        if (Log) Log.info(\"[UI.Orchestrator] Nettoyage termin√©\");\r\n    };\r\n\r\n    // ========================================\r\n    //   LEGACY COMPATIBILITY LAYER\r\n    // ========================================\r\n\r\n    // Fonctions legacy maintenues pour compatibilit√©\r\n    GeoLeaf.UI._attachAccordionBehavior = function(container) {\r\n        if (GeoLeaf._UIEventDelegation && GeoLeaf._UIEventDelegation.attachAccordionEvents) {\r\n            return GeoLeaf._UIEventDelegation.attachAccordionEvents(container);\r\n        }\r\n        if (Log) Log.warn(\"[UI.Orchestrator] _attachAccordionBehavior: EventDelegation module manquant\");\r\n    };\r\n\r\n    GeoLeaf.UI._getActiveProfileConfig = function() {\r\n        if (GeoLeaf._UIDomUtils && GeoLeaf._UIDomUtils.getActiveProfileConfig) {\r\n            return GeoLeaf._UIDomUtils.getActiveProfileConfig();\r\n        }\r\n        return GeoLeaf.Config?.getActiveProfile?.() || null;\r\n    };\r\n\r\n    // Version info\r\n    GeoLeaf.UI.VERSION = \"4.4.0\";\r\n    GeoLeaf.UI.BUILD = \"Sprint-4.4-Modular\";\r\n\r\n    if (Log) {\r\n        Log.info(`[UI.Orchestrator] Module initialis√© v${GeoLeaf.UI.VERSION}`);\r\n    }\r\n\r\n})(window);\r\n","/**\n * GeoLeaf Data Normalizer Module\n * Module central pour la normalisation des donn√©es provenant de diff√©rentes sources.\n * Convertit JSON, GeoJSON, GPX (future) et Routes vers un format POI unifi√©.\n *\n * @module data/normalizer\n * @version 1.0.0\n */\n(function (global) {\n    \"use strict\";\n\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\n    GeoLeaf._Normalizer = GeoLeaf._Normalizer || {};\n\n    // ========================================\n    //   TYPES DE SOURCES\n    // ========================================\n\n    const SOURCE_TYPES = {\n        JSON: 'json',\n        GEOJSON: 'geojson',\n        GPX: 'gpx',\n        ROUTE: 'route'\n    };\n\n    // ========================================\n    //   UTILITAIRES\n    // ========================================\n\n    /**\n     * R√©cup√®re le Log\n     * @returns {Object}\n     */\n    function getLog() {\n        return GeoLeaf.Log || console;\n    }\n\n    /**\n     * G√©n√®re un ID unique\n     * @returns {string}\n     */\n    function generateUniqueId() {\n        return 'poi_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);\n    }\n\n    /**\n     * D√©termine le type de g√©om√©trie √† partir des coordonn√©es Leaflet\n     * @param {Object} layer - Layer Leaflet\n     * @returns {string} 'Point', 'Polygon', 'LineString' ou 'Unknown'\n     */\n    function detectGeometryType(layer) {\n        if (!layer) return 'Unknown';\n\n        if (typeof layer.getLatLng === 'function') {\n            return 'Point';\n        }\n        if (typeof layer.getLatLngs === 'function') {\n            const latLngs = layer.getLatLngs();\n            // Polygon : tableau de tableaux de points (anneau ext√©rieur + trous √©ventuels)\n            // LineString : tableau de points\n            if (Array.isArray(latLngs) && latLngs.length > 0) {\n                if (Array.isArray(latLngs[0]) && Array.isArray(latLngs[0][0])) {\n                    return 'Polygon';\n                }\n                if (Array.isArray(latLngs[0])) {\n                    // Peut √™tre Polygon ou LineString selon si ferm√©\n                    return 'Polygon';\n                }\n                return 'LineString';\n            }\n        }\n        return 'Unknown';\n    }\n\n    /**\n     * Extrait les coordonn√©es d'un layer Leaflet\n     * @param {Object} layer - Layer Leaflet\n     * @returns {Array|null} Coordonn√©es [lat, lng] ou null\n     */\n    function extractCoordinates(layer) {\n        if (!layer) return null;\n\n        if (typeof layer.getLatLng === 'function') {\n            const ll = layer.getLatLng();\n            return ll ? [ll.lat, ll.lng] : null;\n        }\n\n        if (typeof layer.getCenter === 'function') {\n            const center = layer.getCenter();\n            return center ? [center.lat, center.lng] : null;\n        }\n\n        if (typeof layer.getBounds === 'function') {\n            try {\n                const bounds = layer.getBounds();\n                if (bounds && bounds.isValid()) {\n                    const center = bounds.getCenter();\n                    return center ? [center.lat, center.lng] : null;\n                }\n            } catch (e) {\n                // Bounds invalides\n            }\n        }\n\n        return null;\n    }\n\n    // ========================================\n    //   NORMALISEURS PAR TYPE DE SOURCE\n    // ========================================\n\n    /**\n     * Normalise une entr√©e JSON en POI\n     * @param {Object} data - Donn√©es JSON brutes\n     * @param {Object} layerConfig - Configuration du layer\n     * @returns {Object} POI normalis√©\n     */\n    function normalizeFromJSON(data, layerConfig = {}) {\n        if (!data) return null;\n\n        const id = data.id || data.uid || data.guid || generateUniqueId();\n        const dataMapping = layerConfig.dataMapping || {};\n\n        // Extraction du titre\n        const titleField = dataMapping.title || 'title';\n        const title = data[titleField] || data.title || data.name || data.label || data.nom || 'Sans titre';\n\n        // Extraction de la description\n        const descField = dataMapping.description || 'description';\n        const description = data[descField] || data.description || data.shortDescription || '';\n\n        // Extraction des coordonn√©es\n        const latField = dataMapping.lat || 'lat';\n        const lngField = dataMapping.lng || 'lng';\n        let lat = data[latField];\n        let lng = data[lngField];\n\n        // Fallbacks pour coordonn√©es\n        if (lat === undefined) lat = data.latitude || data.y;\n        if (lng === undefined) lng = data.longitude || data.lng || data.x;\n\n        // Extraction cat√©gorie/sous-cat√©gorie\n        const catField = dataMapping.categoryId || 'categoryId';\n        const subCatField = dataMapping.subCategoryId || 'subCategoryId';\n        const categoryId = data[catField] || data.categoryId || data.category || null;\n        const subCategoryId = data[subCatField] || data.subCategoryId || data.subcategory || null;\n\n        // Construction des attributs (toutes les propri√©t√©s)\n        const attributes = { ...data };\n\n        return {\n            id: String(id),\n            sourceType: SOURCE_TYPES.JSON,\n            geometryType: 'Point',\n            title: String(title),\n            description: String(description || ''),\n            lat: lat !== undefined ? parseFloat(lat) : null,\n            lng: lng !== undefined ? parseFloat(lng) : null,\n            categoryId: categoryId,\n            subCategoryId: subCategoryId,\n            attributes: attributes,\n            rawData: data\n        };\n    }\n\n    /**\n     * Normalise une feature GeoJSON en POI\n     * @param {Object} feature - Feature GeoJSON\n     * @param {Object} layerConfig - Configuration du layer\n     * @param {Object} layer - Layer Leaflet (optionnel, pour coordonn√©es)\n     * @returns {Object} POI normalis√©\n     */\n    function normalizeFromGeoJSON(feature, layerConfig = {}, layer = null) {\n        if (!feature) return null;\n\n        const props = feature.properties || {};\n        const geometry = feature.geometry || {};\n        const dataMapping = layerConfig.dataMapping || {};\n\n        // ID\n        const id = feature.id || props.id || props.uid || props.guid || generateUniqueId();\n\n        // Type de g√©om√©trie\n        let geometryType = geometry.type || 'Unknown';\n        if (layer && geometryType === 'Unknown') {\n            geometryType = detectGeometryType(layer);\n        }\n\n        // Extraction du titre\n        const titleField = dataMapping.title || 'title';\n        const titlePath = titleField.includes('.') ? titleField.split('.').pop() : titleField;\n        const title = props[titlePath] || props.name || props.nom || props.title || props.label || 'Sans titre';\n\n        // Extraction de la description\n        const descField = dataMapping.description || 'description';\n        const descPath = descField.includes('.') ? descField.split('.').pop() : descField;\n        const description = props[descPath] || props.description || props.shortDescription || '';\n\n        // Coordonn√©es\n        let lat = null, lng = null;\n        if (geometry.coordinates) {\n            if (geometryType === 'Point') {\n                // GeoJSON : [lng, lat]\n                lng = geometry.coordinates[0];\n                lat = geometry.coordinates[1];\n            } else if (layer) {\n                const coords = extractCoordinates(layer);\n                if (coords) {\n                    lat = coords[0];\n                    lng = coords[1];\n                }\n            } else if (geometry.coordinates.length > 0) {\n                // Calculer le centre approximatif\n                const flatCoords = flattenCoordinates(geometry.coordinates, geometry.type);\n                if (flatCoords.length > 0) {\n                    let sumLat = 0, sumLng = 0;\n                    flatCoords.forEach(c => {\n                        sumLng += c[0];\n                        sumLat += c[1];\n                    });\n                    lng = sumLng / flatCoords.length;\n                    lat = sumLat / flatCoords.length;\n                }\n            }\n        } else if (layer) {\n            const coords = extractCoordinates(layer);\n            if (coords) {\n                lat = coords[0];\n                lng = coords[1];\n            }\n        }\n\n        // Cat√©gorie/sous-cat√©gorie\n        const catField = dataMapping.categoryId || 'categoryId';\n        const catPath = catField.includes('.') ? catField.split('.').pop() : catField;\n        const subCatField = dataMapping.subCategoryId || 'subCategoryId';\n        const subCatPath = subCatField.includes('.') ? subCatField.split('.').pop() : subCatField;\n\n        const categoryId = props[catPath] || props.categoryId || props.category || null;\n        const subCategoryId = props[subCatPath] || props.subCategoryId || props.subcategory || null;\n\n        // Construction des attributs\n        const attributes = { ...props };\n\n        return {\n            id: String(id),\n            sourceType: SOURCE_TYPES.GEOJSON,\n            geometryType: geometryType,\n            title: String(title),\n            description: String(description || ''),\n            lat: lat !== null ? parseFloat(lat) : null,\n            lng: lng !== null ? parseFloat(lng) : null,\n            categoryId: categoryId,\n            subCategoryId: subCategoryId,\n            attributes: attributes,\n            properties: props, // Conserve aussi properties pour compatibilit√©\n            rawData: feature\n        };\n    }\n\n    /**\n     * Aplatit les coordonn√©es GeoJSON selon le type de g√©om√©trie\n     * @param {Array} coords - Coordonn√©es imbriqu√©es\n     * @param {string} type - Type de g√©om√©trie\n     * @returns {Array} Tableau de [lng, lat]\n     */\n    function flattenCoordinates(coords, type) {\n        if (!coords || !Array.isArray(coords)) return [];\n\n        switch (type) {\n            case 'Point':\n                return [coords];\n            case 'MultiPoint':\n            case 'LineString':\n                return coords;\n            case 'MultiLineString':\n            case 'Polygon':\n                return coords.flat();\n            case 'MultiPolygon':\n                return coords.flat(2);\n            default:\n                // Aplatir r√©cursivement\n                const flat = [];\n                const flatten = (arr) => {\n                    if (!Array.isArray(arr)) return;\n                    if (typeof arr[0] === 'number') {\n                        flat.push(arr);\n                    } else {\n                        arr.forEach(flatten);\n                    }\n                };\n                flatten(coords);\n                return flat;\n        }\n    }\n\n    /**\n     * Normalise un waypoint GPX en POI (placeholder pour futur module)\n     * @param {Object} waypoint - Waypoint GPX\n     * @param {Object} layerConfig - Configuration du layer\n     * @returns {Object} POI normalis√©\n     */\n    function normalizeFromGPX(waypoint, layerConfig = {}) {\n        if (!waypoint) return null;\n\n        getLog().info('[Normalizer] GPX normalization - placeholder for future implementation');\n\n        // Structure de base pour GPX\n        const id = waypoint.name || waypoint.sym || generateUniqueId();\n        const title = waypoint.name || waypoint.cmt || 'Point GPX';\n        const description = waypoint.desc || waypoint.cmt || '';\n\n        return {\n            id: String(id),\n            sourceType: SOURCE_TYPES.GPX,\n            geometryType: 'Point',\n            title: String(title),\n            description: String(description),\n            lat: waypoint.lat !== undefined ? parseFloat(waypoint.lat) : null,\n            lng: waypoint.lon !== undefined ? parseFloat(waypoint.lon) : null,\n            categoryId: waypoint.type || null,\n            subCategoryId: null,\n            attributes: { ...waypoint },\n            rawData: waypoint\n        };\n    }\n\n    /**\n     * Normalise un point de route en POI\n     * @param {Object} routePoint - Point de route\n     * @param {Object} routeConfig - Configuration de la route\n     * @returns {Object} POI normalis√©\n     */\n    function normalizeFromRoute(routePoint, routeConfig = {}) {\n        if (!routePoint) return null;\n\n        const id = routePoint.id || routePoint.placeId || generateUniqueId();\n        const title = routePoint.name || routePoint.title || routePoint.address || 'Point de route';\n        const description = routePoint.description || routePoint.comment || '';\n\n        let lat = null, lng = null;\n        if (routePoint.latLng) {\n            lat = routePoint.latLng.lat;\n            lng = routePoint.latLng.lng;\n        } else if (routePoint.lat !== undefined && routePoint.lng !== undefined) {\n            lat = routePoint.lat;\n            lng = routePoint.lng;\n        }\n\n        return {\n            id: String(id),\n            sourceType: SOURCE_TYPES.ROUTE,\n            geometryType: 'Point',\n            title: String(title),\n            description: String(description),\n            lat: lat !== null ? parseFloat(lat) : null,\n            lng: lng !== null ? parseFloat(lng) : null,\n            categoryId: routePoint.type || 'route-point',\n            subCategoryId: routePoint.order !== undefined ? `stop-${routePoint.order}` : null,\n            order: routePoint.order,\n            address: routePoint.address,\n            attributes: { ...routePoint },\n            rawData: routePoint\n        };\n    }\n\n    // ========================================\n    //   FONCTION PRINCIPALE\n    // ========================================\n\n    /**\n     * Normalise des donn√©es selon leur type de source\n     * @param {string} sourceType - Type de source ('json', 'geojson', 'gpx', 'route')\n     * @param {Object} data - Donn√©es brutes\n     * @param {Object} layerConfig - Configuration du layer\n     * @param {Object} options - Options additionnelles (layer Leaflet, etc.)\n     * @returns {Object} POI normalis√©\n     */\n    function normalizeFeature(sourceType, data, layerConfig = {}, options = {}) {\n        if (!data) {\n            getLog().warn('[Normalizer] Donn√©es nulles pour normalisation');\n            return null;\n        }\n\n        switch (sourceType) {\n            case SOURCE_TYPES.JSON:\n                return normalizeFromJSON(data, layerConfig);\n\n            case SOURCE_TYPES.GEOJSON:\n                return normalizeFromGeoJSON(data, layerConfig, options.layer);\n\n            case SOURCE_TYPES.GPX:\n                return normalizeFromGPX(data, layerConfig);\n\n            case SOURCE_TYPES.ROUTE:\n                return normalizeFromRoute(data, layerConfig);\n\n            default:\n                getLog().warn('[Normalizer] Type de source non reconnu:', sourceType);\n                // Tenter une d√©tection automatique\n                return autoDetectAndNormalize(data, layerConfig, options);\n        }\n    }\n\n    /**\n     * D√©tecte automatiquement le type de source et normalise\n     * @param {Object} data - Donn√©es brutes\n     * @param {Object} layerConfig - Configuration du layer\n     * @param {Object} options - Options additionnelles\n     * @returns {Object} POI normalis√©\n     */\n    function autoDetectAndNormalize(data, layerConfig = {}, options = {}) {\n        // D√©tection GeoJSON\n        if (data.type === 'Feature' && data.geometry) {\n            return normalizeFromGeoJSON(data, layerConfig, options.layer);\n        }\n\n        // D√©tection GPX (waypoint)\n        if (data.lat !== undefined && data.lon !== undefined && (data.name || data.sym)) {\n            return normalizeFromGPX(data, layerConfig);\n        }\n\n        // D√©tection Route\n        if (data.latLng || (data.order !== undefined && data.address)) {\n            return normalizeFromRoute(data, layerConfig);\n        }\n\n        // Par d√©faut : JSON\n        return normalizeFromJSON(data, layerConfig);\n    }\n\n    /**\n     * Normalise un tableau de donn√©es\n     * @param {string} sourceType - Type de source\n     * @param {Array} dataArray - Tableau de donn√©es brutes\n     * @param {Object} layerConfig - Configuration du layer\n     * @param {Object} options - Options additionnelles\n     * @returns {Array} Tableau de POIs normalis√©s\n     */\n    function normalizeCollection(sourceType, dataArray, layerConfig = {}, options = {}) {\n        if (!Array.isArray(dataArray)) {\n            getLog().warn('[Normalizer] normalizeCollection attend un tableau');\n            return [];\n        }\n\n        return dataArray\n            .map(data => normalizeFeature(sourceType, data, layerConfig, options))\n            .filter(poi => poi !== null);\n    }\n\n    // ========================================\n    //   EXPORT\n    // ========================================\n\n    GeoLeaf._Normalizer = {\n        // Types de sources\n        SOURCE_TYPES,\n\n        // Normaliseurs par type\n        normalizeFromJSON,\n        normalizeFromGeoJSON,\n        normalizeFromGPX,\n        normalizeFromRoute,\n\n        // Fonctions principales\n        normalizeFeature,\n        autoDetectAndNormalize,\n        normalizeCollection,\n\n        // Utilitaires\n        detectGeometryType,\n        extractCoordinates,\n        generateUniqueId\n    };\n\n    getLog().info('[GeoLeaf._Normalizer] Module Normalizer charg√©');\n\n})(typeof window !== 'undefined' ? window : global);\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n/**\r\n * @fileoverview Chargeur centralis√© de styles GeoLeaf\r\n * G√®re le chargement, la validation et le cache des fichiers style.json\r\n * Supporte les labels int√©gr√©s et la d√©tection automatique\r\n * @module loaders/style-loader\r\n */\r\n\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = global.GeoLeaf = global.GeoLeaf || {};\r\n\r\n/**\r\n * Cache en m√©moire des styles charg√©s\r\n * Cl√©: \"profileId:layerId:styleId\"\r\n * Valeur: { styleData, labelConfig, timestamp }\r\n */\r\nconst styleCache = new Map();\r\n\r\n/**\r\n * Configuration du loader\r\n */\r\nlet loaderConfig = {\r\n    debug: false,\r\n    validateOnLoad: true,\r\n    throwOnValidationError: true\r\n};\r\n\r\nfunction getProfilesBasePath() {\r\n    const cfg = GeoLeaf.Config;\r\n\r\n    if (cfg && typeof cfg.get === \"function\") {\r\n        const configured = cfg.get(\"data.profilesBasePath\", \"profiles\");\r\n        if (typeof configured === \"string\" && configured.trim().length > 0) {\r\n            return configured.endsWith(\"/\") ? configured.slice(0, -1) : configured;\r\n        }\r\n    }\r\n\r\n    return \"profiles\";\r\n}\r\n\r\n/**\r\n * Initialise le style loader avec la configuration GeoLeaf\r\n * @param {Object} config - Configuration GeoLeaf (doit contenir { debug: boolean })\r\n */\r\nfunction initStyleLoader(config = {}) {\r\n    loaderConfig.debug = config.debug === true;\r\n\r\n    if (loaderConfig.debug) {\r\n        console.log('[StyleLoader] Mode debug activ√© - cache d√©sactiv√©');\r\n    }\r\n}\r\n\r\n/**\r\n * Charge et valide un fichier de style\r\n * @param {string} profileId - ID du profil\r\n * @param {string} layerId - ID de la couche\r\n * @param {string} styleId - ID du style\r\n * @param {string} styleFileName - Nom du fichier de style (ex: \"default.json\")\r\n * @param {string} layerDirectory - R√©pertoire de la couche (ex: \"layers/tourism_poi_all\")\r\n * @returns {Promise<Object>} Style charg√© et valid√© avec labels extraits\r\n * @throws {Error} Si le fichier est invalide ou introuvable\r\n */\r\nasync function loadAndValidateStyle(profileId, layerId, styleId, styleFileName, layerDirectory) {\r\n    const cacheKey = `${profileId}:${layerId}:${styleId}`;\r\n\r\n    // V√©rifier le cache (sauf en mode debug)\r\n    if (!loaderConfig.debug && styleCache.has(cacheKey)) {\r\n        const cached = styleCache.get(cacheKey);\r\n        console.log(`[StyleLoader] Style charg√© depuis le cache: ${cacheKey}`);\r\n        return cached;\r\n    }\r\n\r\n    try {\r\n        // Construire le chemin du fichier de style\r\n        const profilesBasePath = getProfilesBasePath();\r\n        const stylePath = `${profilesBasePath}/${profileId}/${layerDirectory}/styles/${styleFileName}`;\r\n\r\n        console.log(`[StyleLoader] Chargement du style: ${stylePath}`);\r\n\r\n        // Charger le fichier JSON\r\n        const response = await fetch(stylePath);\r\n\r\n        if (!response.ok) {\r\n            throw new Error(\r\n                `Impossible de charger le fichier de style: ${stylePath}\\n` +\r\n                `HTTP ${response.status}: ${response.statusText}`\r\n            );\r\n        }\r\n\r\n        let styleData;\r\n        try {\r\n            styleData = await response.json();\r\n        } catch (jsonError) {\r\n            // Erreur de parsing JSON - format d√©taill√©\r\n            const errorContext = {\r\n                profileId,\r\n                layerId,\r\n                styleId,\r\n                stylePath,\r\n                httpStatus: response.status,\r\n                parseError: jsonError.message\r\n            };\r\n\r\n            console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');\r\n            console.error('‚ùå ERREUR DE PARSING JSON - FICHIER STYLE MALFORM√â');\r\n            console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');\r\n            console.error(`Fichier: ${stylePath}`);\r\n            console.error(`Erreur: ${jsonError.message}`);\r\n            console.error('Contexte:', JSON.stringify(errorContext, null, 2));\r\n            console.error('Stack trace:', jsonError.stack);\r\n            console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');\r\n\r\n            throw new Error(\r\n                `Le fichier de style contient du JSON malform√©: ${stylePath}\\n` +\r\n                `Erreur de parsing: ${jsonError.message}\\n` +\r\n                `Veuillez v√©rifier la syntaxe JSON du fichier.`\r\n            );\r\n        }\r\n\r\n        // VALIDATION STRICTE: Ajouter visibleByDefault si manquant et label.enabled: true\r\n        if (styleData.label && styleData.label.enabled === true) {\r\n            if (styleData.label.visibleByDefault === undefined) {\r\n                // Fallback automatique √† false\r\n                styleData.label.visibleByDefault = false;\r\n                console.warn(\r\n                    `[StyleLoader] ‚ö†Ô∏è Param√®tre \"visibleByDefault\" manquant dans le style: ${stylePath}\\n` +\r\n                    `Le style a \"label.enabled: true\" mais pas de \"visibleByDefault\".\\n` +\r\n                    `Fallback appliqu√©: visibleByDefault = false\\n` +\r\n                    `Ajoutez explicitement \"visibleByDefault\": false ou true dans le fichier de style.`\r\n                );\r\n            }\r\n        }\r\n\r\n        // Valider le style contre le sch√©ma\r\n        if (loaderConfig.validateOnLoad) {\r\n            const StyleValidator = GeoLeaf._StyleValidator;\r\n            if (!StyleValidator) {\r\n                console.warn('[StyleLoader] GeoLeaf._StyleValidator non disponible, validation ignor√©e');\r\n            }\r\n\r\n            const validationResult = StyleValidator ? StyleValidator.validateStyle(styleData, {\r\n                profileId,\r\n                layerId,\r\n                styleId,\r\n                stylePath\r\n            }) : { valid: true, errors: [], warnings: [] };\r\n\r\n            if (!validationResult.valid) {\r\n                const errorMessage = StyleValidator ? StyleValidator.formatValidationErrors(validationResult, stylePath) : 'Erreurs de validation';\r\n                console.error(errorMessage);\r\n\r\n                if (loaderConfig.throwOnValidationError) {\r\n                    throw new Error(\r\n                        `Le fichier de style ne respecte pas le sch√©ma GeoLeaf: ${stylePath}\\n` +\r\n                        `Consultez la console pour les d√©tails des erreurs.`\r\n                    );\r\n                }\r\n            }\r\n\r\n            // Afficher les avertissements m√™me si validation OK\r\n            if (validationResult.warnings.length > 0) {\r\n                console.warn(`[StyleLoader] ${validationResult.warnings.length} avertissement(s) pour ${stylePath}:`);\r\n                validationResult.warnings.forEach(warning => {\r\n                    console.warn(`  - ${warning.field}: ${warning.message}`);\r\n                });\r\n            }\r\n        }\r\n\r\n        // Extraire la configuration de labels int√©gr√©s\r\n        const labelConfig = extractLabelConfig(styleData);\r\n\r\n        // Pr√©parer l'objet de retour\r\n        const result = {\r\n            styleData,\r\n            labelConfig,\r\n            metadata: {\r\n                profileId,\r\n                layerId,\r\n                styleId,\r\n                stylePath,\r\n                hasIntegratedLabels: labelConfig !== null,\r\n                loadedAt: new Date().toISOString()\r\n            }\r\n        };\r\n\r\n        // Mettre en cache (sauf en mode debug)\r\n        if (!loaderConfig.debug) {\r\n            styleCache.set(cacheKey, result);\r\n        }\r\n\r\n        console.log(\r\n            `[StyleLoader] Style charg√© avec succ√®s: ${styleId}` +\r\n            (labelConfig ? ' (avec labels int√©gr√©s)' : '')\r\n        );\r\n\r\n        return result;\r\n\r\n    } catch (error) {\r\n        // Re-throw les erreurs avec contexte complet\r\n        if (error.message.includes('JSON malform√©') || error.message.includes('sch√©ma GeoLeaf')) {\r\n            throw error;\r\n        }\r\n\r\n        // Erreur r√©seau ou autre\r\n        const errorContext = {\r\n            profileId,\r\n            layerId,\r\n            styleId,\r\n            styleFileName,\r\n            layerDirectory,\r\n            originalError: error.message\r\n        };\r\n\r\n        console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');\r\n        console.error('‚ùå ERREUR DE CHARGEMENT DE STYLE');\r\n        console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');\r\n        console.error('Contexte:', JSON.stringify(errorContext, null, 2));\r\n        console.error('Stack trace:', error.stack);\r\n        console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');\r\n\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * Extrait la configuration de labels depuis un style charg√©\r\n * D√©tecte automatiquement si les labels sont int√©gr√©s dans le style\r\n * @param {Object} styleData - Donn√©es du style\r\n * @returns {Object|null} Configuration de labels ou null si absents/d√©sactiv√©s\r\n */\r\nfunction extractLabelConfig(styleData) {\r\n    if (!styleData || typeof styleData !== 'object') {\r\n        return null;\r\n    }\r\n\r\n    // V√©rifier si le champ label est un objet de configuration\r\n    if (styleData.label && typeof styleData.label === 'object' && styleData.label !== null) {\r\n        // V√©rifier que enabled est true\r\n        if (styleData.label.enabled === true) {\r\n            return {\r\n                ...styleData.label,\r\n                isIntegrated: true\r\n            };\r\n        }\r\n    }\r\n\r\n    // Pas de labels int√©gr√©s ou d√©sactiv√©s\r\n    return null;\r\n}\r\n\r\n/**\r\n * Charge un style avec gestion simplifi√©e (sans validation stricte)\r\n * Utilis√© pour les cas o√π on veut charger m√™me si validation √©choue\r\n * @param {string} profileId - ID du profil\r\n * @param {string} layerId - ID de la couche\r\n * @param {string} styleId - ID du style\r\n * @param {string} styleFileName - Nom du fichier\r\n * @param {string} layerDirectory - R√©pertoire de la couche\r\n * @returns {Promise<Object>} Style charg√© (peut contenir des erreurs)\r\n */\r\nasync function loadStyleLenient(profileId, layerId, styleId, styleFileName, layerDirectory) {\r\n    const previousThrowSetting = loaderConfig.throwOnValidationError;\r\n    loaderConfig.throwOnValidationError = false;\r\n\r\n    try {\r\n        return await loadAndValidateStyle(profileId, layerId, styleId, styleFileName, layerDirectory);\r\n    } finally {\r\n        loaderConfig.throwOnValidationError = previousThrowSetting;\r\n    }\r\n}\r\n\r\n/**\r\n * Pr√©charge plusieurs styles en parall√®le\r\n * @param {Array<Object>} styleConfigs - Tableau de { profileId, layerId, styleId, styleFileName, layerDirectory }\r\n * @returns {Promise<Array<Object>>} R√©sultats de chargement\r\n */\r\nasync function preloadStyles(styleConfigs) {\r\n    console.log(`[StyleLoader] Pr√©chargement de ${styleConfigs.length} style(s)...`);\r\n\r\n    const promises = styleConfigs.map(config =>\r\n        loadAndValidateStyle(\r\n            config.profileId,\r\n            config.layerId,\r\n            config.styleId,\r\n            config.styleFileName,\r\n            config.layerDirectory\r\n        ).catch(error => ({\r\n            error: true,\r\n            message: error.message,\r\n            config\r\n        }))\r\n    );\r\n\r\n    const results = await Promise.all(promises);\r\n\r\n    const successCount = results.filter(r => !r.error).length;\r\n    const errorCount = results.filter(r => r.error).length;\r\n\r\n    console.log(`[StyleLoader] Pr√©chargement termin√©: ${successCount} succ√®s, ${errorCount} erreurs`);\r\n\r\n    return results;\r\n}\r\n\r\n/**\r\n * Efface le cache des styles\r\n * @param {string} [cacheKey] - Cl√© sp√©cifique √† effacer (optionnel, sinon tout le cache)\r\n */\r\nfunction clearStyleCache(cacheKey = null) {\r\n    if (cacheKey) {\r\n        styleCache.delete(cacheKey);\r\n        console.log(`[StyleLoader] Cache effac√© pour: ${cacheKey}`);\r\n    } else {\r\n        const count = styleCache.size;\r\n        styleCache.clear();\r\n        console.log(`[StyleLoader] Cache complet effac√© (${count} entr√©e(s))`);\r\n    }\r\n}\r\n\r\n/**\r\n * Obtient les statistiques du cache\r\n * @returns {Object} Statistiques { size, keys, debug }\r\n */\r\nfunction getCacheStats() {\r\n    return {\r\n        size: styleCache.size,\r\n        keys: Array.from(styleCache.keys()),\r\n        debug: loaderConfig.debug,\r\n        cacheEnabled: !loaderConfig.debug\r\n    };\r\n}\r\n\r\n/**\r\n * Charge un style depuis une configuration de couche\r\n * D√©tecte automatiquement les r√©f√©rences obsol√®tes √† styleFile\r\n * @param {string} profileId - ID du profil\r\n * @param {Object} layerConfig - Configuration de la couche\r\n * @param {string} styleIdOrFileName - ID du style ou nom de fichier\r\n * @returns {Promise<Object>} Style charg√©\r\n */\r\nasync function loadStyleFromLayerConfig(profileId, layerConfig, styleIdOrFileName) {\r\n    const layerId = layerConfig.id;\r\n    const layerDirectory = layerConfig._layerDirectory || `layers/${layerId}`;\r\n\r\n    // V√©rifier si styleFile est pr√©sent dans labels (configuration obsol√®te)\r\n    if (layerConfig.labels && layerConfig.labels.styleFile) {\r\n        const errorMessage =\r\n            `‚ùå CONFIGURATION OBSOL√àTE D√âTECT√âE\\n` +\r\n            `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\\n` +\r\n            `La couche \"${layerId}\" utilise une r√©f√©rence obsol√®te √† un fichier\\n` +\r\n            `de labels s√©par√© via \"labels.styleFile\".\\n\\n` +\r\n            `GeoLeaf ne supporte plus les fichiers de labels s√©par√©s (styleLabel.json).\\n` +\r\n            `Les labels doivent √™tre int√©gr√©s dans les fichiers de style.\\n\\n` +\r\n            `Valeur d√©tect√©e: ${layerConfig.labels.styleFile}\\n` +\r\n            `Profil: ${profileId}\\n` +\r\n            `Couche: ${layerId}\\n\\n` +\r\n            `Action requise:\\n` +\r\n            `1. Supprimez la propri√©t√© \"labels.styleFile\" de la configuration\\n` +\r\n            `2. Int√©grez les labels dans les fichiers de style (propri√©t√© \"label\")\\n` +\r\n            `3. Consultez docs/STYLE_FORMAT_SPEC.md pour la syntaxe\\n` +\r\n            `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`;\r\n\r\n        console.error(errorMessage);\r\n        throw new Error(`Configuration obsol√®te: labels.styleFile d√©tect√© dans la couche ${layerId}`);\r\n    }\r\n\r\n    // Trouver le fichier de style dans styles.available\r\n    let styleFileName = styleIdOrFileName;\r\n    let styleId = styleIdOrFileName;\r\n\r\n    if (layerConfig.styles && layerConfig.styles.available) {\r\n        const styleConfig = layerConfig.styles.available.find(s => s.id === styleIdOrFileName || s.file === styleIdOrFileName);\r\n        if (styleConfig) {\r\n            styleFileName = styleConfig.file;\r\n            styleId = styleConfig.id;\r\n        }\r\n    }\r\n\r\n    return loadAndValidateStyle(profileId, layerId, styleId, styleFileName, layerDirectory);\r\n}\r\n\r\n/**\r\n * Construit le chemin complet d'un fichier de style\r\n * @param {string} profileId - ID du profil\r\n * @param {string} layerDirectory - R√©pertoire de la couche\r\n * @param {string} styleFileName - Nom du fichier\r\n * @returns {string} Chemin complet\r\n */\r\nfunction getStylePath(profileId, layerDirectory, styleFileName) {\r\n    return `profiles/${profileId}/${layerDirectory}/styles/${styleFileName}`;\r\n}\r\n\r\n/**\r\n * Module Style Loader\r\n * Expose toutes les fonctions publiques\r\n */\r\nconst StyleLoader = {\r\n    initStyleLoader,\r\n    loadAndValidateStyle,\r\n    extractLabelConfig,\r\n    loadStyleLenient,\r\n    preloadStyles,\r\n    clearStyleCache,\r\n    getCacheStats,\r\n    loadStyleFromLayerConfig,\r\n    getStylePath,\r\n    styleCache // Export pour tests/debugging\r\n};\r\n\r\n// Exposer le module\r\nGeoLeaf._StyleLoader = StyleLoader;\r\n\r\n})(window);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    /**\r\n     * Namespace global GeoLeaf\r\n     */\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n\r\n    /**\r\n     * Logger unifi√©\r\n     */\r\n    const Log = GeoLeaf.Log;\r\n\r\n    /**\r\n     * Module Config.Loader\r\n     *\r\n     * Responsabilit√©s :\r\n     * - Chargement HTTP via fetch() avec validation CSRF/XSS\r\n     * - Validation Content-Type stricte\r\n     * - Gestion des headers personnalis√©s\r\n     * - Helper g√©n√©rique _fetchJson()\r\n     */\r\n    const LoaderModule = {\r\n        /**\r\n         * Charge une configuration depuis une URL JSON et retourne l'objet.\r\n         *\r\n         * @param {string} url - URL du fichier JSON\r\n         * @param {Object} [options] - Options de chargement\r\n         * @param {Object} [options.headers] - Headers HTTP personnalis√©s (ex: CSRF token)\r\n         * @param {boolean} [options.strictContentType=true] - Validation stricte du Content-Type\r\n         * @returns {Promise<Object>}\r\n         * @example\r\n         * Loader.loadUrl('/api/config.json', {\r\n         *     headers: { 'X-CSRF-Token': '...' },\r\n         *     strictContentType: true\r\n         * })\r\n         */\r\n        loadUrl(url, options = {}) {\r\n            if (!url) {\r\n                Log.warn(\"[GeoLeaf.Config.Loader] URL JSON manquante dans loadUrl().\");\r\n                return Promise.resolve({});\r\n            }\r\n\r\n            const { headers = {}, strictContentType = true } = options;\r\n\r\n            // Validation de l'URL avec le module Security\r\n            const Security =\r\n                typeof GeoLeaf !== \"undefined\" && GeoLeaf.Security\r\n                    ? GeoLeaf.Security\r\n                    : null;\r\n\r\n            // Pour les URLs relatives (commen√ßant par ./ ou ../ ou /), on les laisse passer\r\n            const isRelative = /^\\.{0,2}\\//.test(url) || /^\\/[^/]/.test(url);\r\n\r\n            if (!isRelative) {\r\n                // URL absolue : validation stricte avec Security.validateUrl\r\n                if (Security && typeof Security.validateUrl === \"function\") {\r\n                    try {\r\n                        url = Security.validateUrl(url);\r\n                    } catch (e) {\r\n                        const errMsg = \"[GeoLeaf.Config.Loader] \" + e.message;\r\n                        Log.error(errMsg);\r\n                        return Promise.reject(new Error(errMsg));\r\n                    }\r\n                } else {\r\n                    // Fallback : v√©rification basique si Security pas disponible\r\n                    if (!/^https?:\\/\\//i.test(url)) {\r\n                        const errMsg =\r\n                            \"[GeoLeaf.Config.Loader] URL doit √™tre relative ou commencer par http:// ou https://\";\r\n                        Log.error(errMsg);\r\n                        return Promise.reject(new Error(errMsg));\r\n                    }\r\n                }\r\n            }\r\n\r\n            // Configuration fetch avec headers personnalis√©s\r\n            const fetchOptions = {\r\n                method: \"GET\",\r\n                headers: {\r\n                    Accept: \"application/json\",\r\n                    ...headers\r\n                }\r\n            };\r\n\r\n            return fetch(url, fetchOptions)\r\n                .then((response) => {\r\n                    if (!response.ok) {\r\n                        throw new Error(\"HTTP \" + response.status + \" pour \" + url);\r\n                    }\r\n\r\n                    // Validation Content-Type stricte\r\n                    const contentType = response.headers.get(\"content-type\");\r\n                    if (strictContentType) {\r\n                        if (!contentType || !contentType.includes(\"application/json\")) {\r\n                            throw new Error(\r\n                                \"[GeoLeaf.Config.Loader] Content-Type invalide: attendu 'application/json', re√ßu '\" +\r\n                                (contentType || \"null\") +\r\n                                \"'. Cela peut indiquer une attaque XSS ou un serveur mal configur√©.\"\r\n                            );\r\n                        }\r\n                    } else if (contentType && !contentType.includes(\"application/json\")) {\r\n                        Log.warn(\"[GeoLeaf.Config.Loader] Content-Type inattendu:\", contentType);\r\n                    }\r\n\r\n                    // Security: Wrap response.json() to handle parse errors\r\n                    return response.json().catch((parseErr) => {\r\n                        const errMsg = \"[GeoLeaf.Config.Loader] Erreur de parsing JSON pour \" + url + \": \" + parseErr.message;\r\n                        Log.error(errMsg);\r\n                        throw new Error(errMsg);\r\n                    });\r\n                })\r\n                .then((jsonCfg) => {\r\n                    if (typeof jsonCfg !== \"object\" || jsonCfg === null) {\r\n                        throw new Error(\"Le JSON de configuration n'est pas un objet valide.\");\r\n                    }\r\n\r\n                    return jsonCfg;\r\n                })\r\n                .catch((err) => {\r\n                    Log.error(\"[GeoLeaf.Config.Loader] Erreur lors du chargement JSON :\", err);\r\n                    throw err;\r\n                });\r\n        },\r\n\r\n        /**\r\n         * Helper interne pour charger un JSON sans le fusionner dans la configuration.\r\n         *\r\n         * @param {string} url\r\n         * @param {Object} [options]\r\n         * @param {Object} [options.headers]\r\n         * @param {boolean} [options.strictContentType=true]\r\n         * @returns {Promise<Object|null>}\r\n         */\r\n        fetchJson(url, options = {}) {\r\n            if (!url) {\r\n                Log.warn(\"[GeoLeaf.Config.Loader] fetchJson() appel√© sans URL.\");\r\n                return Promise.resolve(null);\r\n            }\r\n\r\n            const { headers = {}, strictContentType = true } = options;\r\n\r\n            const Security =\r\n                typeof GeoLeaf !== \"undefined\" && GeoLeaf.Security\r\n                    ? GeoLeaf.Security\r\n                    : null;\r\n\r\n            const isRelative =\r\n                /^\\.{0,2}\\//.test(url) || /^\\/[^/]/.test(url);\r\n\r\n            if (!isRelative) {\r\n                if (Security && typeof Security.validateUrl === \"function\") {\r\n                    try {\r\n                        url = Security.validateUrl(url);\r\n                    } catch (e) {\r\n                        const errMsg =\r\n                            \"[GeoLeaf.Config.Loader] \" + e.message;\r\n                        Log.error(errMsg);\r\n                        return Promise.reject(new Error(errMsg));\r\n                    }\r\n                } else {\r\n                    if (!/^https?:\\/\\//i.test(url)) {\r\n                        const errMsg =\r\n                            \"[GeoLeaf.Config.Loader] URL doit √™tre relative ou commencer par http:// ou https://\";\r\n                        Log.error(errMsg);\r\n                        return Promise.reject(new Error(errMsg));\r\n                    }\r\n                }\r\n            }\r\n\r\n            const fetchOptions = {\r\n                method: \"GET\",\r\n                headers: {\r\n                    Accept: \"application/json\",\r\n                    ...headers\r\n                }\r\n            };\r\n\r\n            return fetch(url, fetchOptions)\r\n                .then((response) => {\r\n                    if (!response.ok) {\r\n                        throw new Error(\"HTTP \" + response.status + \" pour \" + url);\r\n                    }\r\n\r\n                    const contentType = response.headers.get(\"content-type\");\r\n                    if (strictContentType) {\r\n                        if (!contentType || !contentType.includes(\"application/json\")) {\r\n                            throw new Error(\r\n                                \"[GeoLeaf.Config.Loader] Content-Type invalide dans fetchJson: attendu 'application/json', re√ßu '\" +\r\n                                (contentType || \"null\") +\r\n                                \"'.\"\r\n                            );\r\n                        }\r\n                    } else if (contentType && !contentType.includes(\"application/json\")) {\r\n                        Log.warn(\"[GeoLeaf.Config.Loader] fetchJson() Content-Type inattendu:\", contentType);\r\n                    }\r\n\r\n                    // Security: Wrap response.json() to handle parse errors\r\n                    return response.json().catch((parseErr) => {\r\n                        const errMsg = \"[GeoLeaf.Config.Loader] Erreur de parsing JSON dans fetchJson pour \" + url + \": \" + parseErr.message;\r\n                        Log.error(errMsg);\r\n                        throw new Error(errMsg);\r\n                    });\r\n                })\r\n                .then((json) => {\r\n                    if (typeof json !== \"object\" || json === null) {\r\n                        Log.warn(\r\n                            \"[GeoLeaf.Config.Loader] fetchJson() a re√ßu un JSON non-objet pour l'URL :\",\r\n                            url\r\n                        );\r\n                    }\r\n                    return json;\r\n                })\r\n                .catch((err) => {\r\n                    Log.error(\r\n                        \"[GeoLeaf.Config.Loader] Erreur fetchJson() pour \" + url + \" :\",\r\n                        err\r\n                    );\r\n                    throw err; // Re-throw pour que l'appelant puisse g√©rer l'erreur\r\n                });\r\n        }\r\n    };\r\n\r\n    // Exposer le module\r\n    GeoLeaf._ConfigLoader = LoaderModule;\r\n})(window);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    /**\r\n     * Namespace global GeoLeaf\r\n     */\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n\r\n    /**\r\n     * Logger unifi√©\r\n     */\r\n    const Log = GeoLeaf.Log;\r\n\r\n    /**\r\n     * Module Config.Storage\r\n     *\r\n     * Responsabilit√©s :\r\n     * - Stockage et gestion de la configuration consolid√©e\r\n     * - API get/set avec chemins \"a.b.c\"\r\n     * - Fusion profonde (deep merge)\r\n     * - Helpers de navigation dans l'arbre de config\r\n     */\r\n    const StorageModule = {\r\n        /**\r\n         * Configuration interne (r√©f√©rence partag√©e)\r\n         * @type {Object}\r\n         * @private\r\n         */\r\n        _config: null,\r\n\r\n        /**\r\n         * Initialise le module avec une r√©f√©rence √† la config.\r\n         *\r\n         * @param {Object} config - R√©f√©rence √† l'objet de configuration global\r\n         */\r\n        init(config) {\r\n            this._config = config;\r\n        },\r\n\r\n        /**\r\n         * Retourne la configuration compl√®te (objet).\r\n         *\r\n         * @returns {Object}\r\n         */\r\n        getAll() {\r\n            return this._config || {};\r\n        },\r\n\r\n        /**\r\n         * R√©cup√®re une valeur via un chemin de type \"map.center\" ou \"basemaps.street.url\".\r\n         *\r\n         * @param {string} path - Chemin avec des points.\r\n         * @param {*} [defaultValue] - Valeur renvoy√©e si le chemin n'existe pas.\r\n         * @returns {*}\r\n         */\r\n        get(path, defaultValue) {\r\n            if (!this._config) {\r\n                return typeof defaultValue === \"undefined\" ? undefined : defaultValue;\r\n            }\r\n\r\n            if (!path || typeof path !== \"string\") {\r\n                return typeof defaultValue === \"undefined\" ? undefined : defaultValue;\r\n            }\r\n\r\n            const segments = path.split(\".\");\r\n            let current = this._config;\r\n\r\n            for (let i = 0; i < segments.length; i++) {\r\n                const key = segments[i];\r\n                if (current && Object.prototype.hasOwnProperty.call(current, key)) {\r\n                    current = current[key];\r\n                } else {\r\n                    return typeof defaultValue === \"undefined\" ? undefined : defaultValue;\r\n                }\r\n            }\r\n\r\n            return current;\r\n        },\r\n\r\n        /**\r\n         * D√©finit une valeur via un chemin de type \"map.center\" ou \"basemaps.street.url\".\r\n         * Cr√©e les objets interm√©diaires si n√©cessaire.\r\n         *\r\n         * @param {string} path\r\n         * @param {*} value\r\n         */\r\n        set(path, value) {\r\n            if (!this._config) {\r\n                Log.warn(\"[GeoLeaf.Config.Storage] Configuration non initialis√©e.\");\r\n                return;\r\n            }\r\n\r\n            if (!path || typeof path !== \"string\") {\r\n                Log.warn(\"[GeoLeaf.Config.Storage] set() requiert un chemin string.\");\r\n                return;\r\n            }\r\n\r\n            const segments = path.split(\".\");\r\n            let current = this._config;\r\n\r\n            for (let i = 0; i < segments.length; i++) {\r\n                const key = segments[i];\r\n\r\n                if (i === segments.length - 1) {\r\n                    current[key] = value;\r\n                } else {\r\n                    if (\r\n                        !Object.prototype.hasOwnProperty.call(current, key) ||\r\n                        typeof current[key] !== \"object\" ||\r\n                        current[key] === null\r\n                    ) {\r\n                        current[key] = {};\r\n                    }\r\n                    current = current[key];\r\n                }\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Retourne une section de configuration (ex : \"basemaps\", \"map\").\r\n         *\r\n         * @param {string} sectionName\r\n         * @param {Object} [defaultValue]\r\n         * @returns {Object|*}\r\n         */\r\n        getSection(sectionName, defaultValue) {\r\n            if (!sectionName) {\r\n                return typeof defaultValue === \"undefined\" ? undefined : defaultValue;\r\n            }\r\n            const value = this.get(sectionName);\r\n            if (typeof value === \"undefined\") {\r\n                return typeof defaultValue === \"undefined\" ? undefined : defaultValue;\r\n            }\r\n            return value;\r\n        },\r\n\r\n        /**\r\n         * Fusion profonde (deep merge) simple pour objets JSON.\r\n         *\r\n         * @param {Object} target\r\n         * @param {Object} source\r\n         * @returns {Object}\r\n         */\r\n        deepMerge(target, source) {\r\n            const output = Object.assign({}, target || {});\r\n            if (!source || typeof source !== \"object\") {\r\n                return output;\r\n            }\r\n\r\n            Object.keys(source).forEach((key) => {\r\n                const srcVal = source[key];\r\n                const tgtVal = output[key];\r\n\r\n                if (\r\n                    srcVal &&\r\n                    typeof srcVal === \"object\" &&\r\n                    !Array.isArray(srcVal) &&\r\n                    tgtVal &&\r\n                    typeof tgtVal === \"object\" &&\r\n                    !Array.isArray(tgtVal)\r\n                ) {\r\n                    output[key] = this.deepMerge(tgtVal, srcVal);\r\n                } else {\r\n                    output[key] = srcVal;\r\n                }\r\n            });\r\n\r\n            return output;\r\n        },\r\n\r\n        /**\r\n         * Lecture d'une valeur via un chemin \"a.b.c\".\r\n         *\r\n         * @param {Object} source\r\n         * @param {string} path\r\n         * @returns {*}\r\n         */\r\n        getValueByPath(source, path) {\r\n            if (!source || !path) return undefined;\r\n            const parts = path.split(\".\");\r\n            let current = source;\r\n\r\n            for (let i = 0; i < parts.length; i += 1) {\r\n                if (current == null) {\r\n                    return undefined;\r\n                }\r\n                current = current[parts[i]];\r\n            }\r\n\r\n            return current;\r\n        },\r\n\r\n        /**\r\n         * √âcriture d'une valeur via un chemin \"a.b.c\".\r\n         * Cr√©e les sous-objets interm√©diaires si n√©cessaire.\r\n         *\r\n         * @param {Object} target\r\n         * @param {string} path\r\n         * @param {*} value\r\n         */\r\n        setValueByPath(target, path, value) {\r\n            if (!target || !path) return;\r\n            const parts = path.split(\".\");\r\n            let current = target;\r\n\r\n            for (let i = 0; i < parts.length - 1; i += 1) {\r\n                const key = parts[i];\r\n                if (\r\n                    !Object.prototype.hasOwnProperty.call(current, key) ||\r\n                    current[key] == null\r\n                ) {\r\n                    current[key] = {};\r\n                }\r\n                current = current[key];\r\n            }\r\n\r\n            current[parts[parts.length - 1]] = value;\r\n        }\r\n    };\r\n\r\n    // Exposer le module\r\n    GeoLeaf._ConfigStorage = StorageModule;\r\n})(window);\r\n","(function (global) {\r\n    \"use strict\";\r\n\r\n    /**\r\n     * Namespace global GeoLeaf\r\n     */\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n\r\n    /**\r\n     * Logger unifi√©\r\n     */\r\n    const Log = GeoLeaf.Log;\r\n\r\n    /**\r\n     * Module Config.Normalization\r\n     *\r\n     * Responsabilit√©s :\r\n     * - Normalisation structurelle des POI (mapping brut ‚Üí format GeoLeaf)\r\n     * - Application de mapping.json sur POI non normalis√©s\r\n     * - Normalisation des avis (reviews) : ancien/nouveau format\r\n     * - Validation de la structure POI : id/title/location\r\n     */\r\n    const NormalizationModule = {\r\n        /**\r\n         * Safe object assignment that prevents prototype pollution.\r\n         * Blocks dangerous keys: __proto__, constructor, prototype\r\n         * @param {Object} target\r\n         * @param {Object} source\r\n         * @returns {Object}\r\n         * @private\r\n         */\r\n        _safeAssign(target, source) {\r\n            const dangerousKeys = ['__proto__', 'constructor', 'prototype'];\r\n\r\n            for (const key in source) {\r\n                if (!source.hasOwnProperty(key)) continue;\r\n                if (dangerousKeys.includes(key)) {\r\n                    Log.warn('[GeoLeaf.Config.Normalization] Tentative de pollution de prototype bloqu√©e', { key });\r\n                    continue;\r\n                }\r\n                target[key] = source[key];\r\n            }\r\n\r\n            return target;\r\n        },\r\n\r\n        /**\r\n         * V√©rifie si un POI est d√©j√† normalis√© au format GeoLeaf :\r\n         * {\r\n         *   id: string,\r\n         *   title: string,\r\n         *   location: { lat: number, lng: number },\r\n         *   attributes?: object\r\n         * }\r\n         *\r\n         * @param {Object} poi\r\n         * @returns {boolean}\r\n         */\r\n        isPoiStructNormalized(poi) {\r\n            if (!poi || typeof poi !== \"object\") return false;\r\n\r\n            if (typeof poi.id !== \"string\" || poi.id.trim() === \"\") {\r\n                return false;\r\n            }\r\n\r\n            // Supporter les deux formats de label/titre\r\n            const hasTitle = typeof poi.title === \"string\" && poi.title.trim() !== \"\";\r\n            const hasLabel = typeof poi.label === \"string\" && poi.label.trim() !== \"\";\r\n            if (!hasTitle && !hasLabel) {\r\n                return false;\r\n            }\r\n\r\n            // Nouveau format : latlng = [lat, lng]\r\n            if (Array.isArray(poi.latlng) && poi.latlng.length >= 2) {\r\n                const lat = poi.latlng[0];\r\n                const lng = poi.latlng[1];\r\n                if (typeof lat === \"number\" && !Number.isNaN(lat) &&\r\n                    typeof lng === \"number\" && !Number.isNaN(lng)) {\r\n                    return true;\r\n                }\r\n            }\r\n\r\n            // Ancien format : location.lat/lng\r\n            if (poi.location && typeof poi.location === \"object\") {\r\n                const lat = poi.location.lat;\r\n                const lng = poi.location.lng;\r\n                if (typeof lat === \"number\" && !Number.isNaN(lat) &&\r\n                    typeof lng === \"number\" && !Number.isNaN(lng)) {\r\n                    return true;\r\n                }\r\n            }\r\n\r\n            return false;\r\n        },\r\n\r\n        /**\r\n         * Applique un mapping brut ‚Üí POI normalis√© pour un POI donn√©.\r\n         *\r\n         * @param {Object} rawPoi\r\n         * @param {Object} mappingDef  mappingConfig.mapping\r\n         * @returns {Object|null}\r\n         */\r\n        mapRawPoiToNormalized(rawPoi, mappingDef) {\r\n            if (!rawPoi || !mappingDef || typeof mappingDef !== \"object\") {\r\n                return null;\r\n            }\r\n\r\n            const Storage = GeoLeaf._ConfigStorage;\r\n            if (!Storage) {\r\n                Log.error(\"[GeoLeaf.Config.Normalization] Module Storage non disponible.\");\r\n                return null;\r\n            }\r\n\r\n            // Socle minimal conforme au cahier des charges POI\r\n            const normalized = {\r\n                id: \"\",\r\n                title: \"\",\r\n                location: { lat: 0, lng: 0 },\r\n                attributes: {}\r\n            };\r\n\r\n            Object.keys(mappingDef).forEach((targetPath) => {\r\n                const sourcePath = mappingDef[targetPath];\r\n                if (!sourcePath) return;\r\n\r\n                const value = Storage.getValueByPath(rawPoi, sourcePath);\r\n                if (typeof value === \"undefined\") return;\r\n\r\n                Storage.setValueByPath(normalized, targetPath, value);\r\n            });\r\n\r\n            if (\r\n                !normalized.attributes ||\r\n                typeof normalized.attributes !== \"object\" ||\r\n                Array.isArray(normalized.attributes)\r\n            ) {\r\n                normalized.attributes = {};\r\n            }\r\n\r\n            return normalized;\r\n        },\r\n\r\n        /**\r\n         * Normalise structurellement un tableau de POI en utilisant\r\n         * √©ventuellement mapping.json du profil actif.\r\n         *\r\n         * R√®gles :\r\n         *  - SANS mapping.json :\r\n         *      ‚Üí on renvoie les POI tels quels (comportement 100 % r√©trocompatible).\r\n         *  - AVEC mapping.json :\r\n         *      ‚Üí si le POI est d√©j√† normalis√© ‚Üí on le garde tel quel ;\r\n         *      ‚Üí sinon, on applique le mapping ;\r\n         *      ‚Üí si apr√®s mapping le POI reste non normalis√© ‚Üí POI ignor√© (warning).\r\n         *\r\n         * @param {Array} rawPoiArray\r\n         * @param {Object|null} mappingConfig  mapping.json complet ou null\r\n         * @returns {Array}\r\n         */\r\n        normalizePoiWithMapping(rawPoiArray, mappingConfig) {\r\n            if (!Array.isArray(rawPoiArray)) {\r\n                return [];\r\n            }\r\n\r\n            const hasMapping =\r\n                mappingConfig &&\r\n                typeof mappingConfig === \"object\" &&\r\n                mappingConfig.mapping &&\r\n                typeof mappingConfig.mapping === \"object\";\r\n\r\n            // üîÅ CAS 1 ‚Äî AUCUN mapping.json fourni :\r\n            // on ne touche √† rien, on renvoie les POI du profil tels quels.\r\n            if (!hasMapping) {\r\n                Log.debug(\r\n                    \"[GeoLeaf.Config.Normalization] Aucun mapping.json fourni ; \" +\r\n                    \"les POI sont utilis√©s tels quels (aucune normalisation structurelle).\"\r\n                );\r\n                return rawPoiArray;\r\n            }\r\n\r\n            // üîÅ CAS 2 ‚Äî mapping.json pr√©sent : on applique vraiment la normalisation\r\n            const mappingDef = mappingConfig.mapping;\r\n            const result = [];\r\n\r\n            rawPoiArray.forEach((rawPoi, index) => {\r\n                // 1) D√©j√† normalis√© ‚Üí on garde\r\n                if (this.isPoiStructNormalized(rawPoi)) {\r\n                    result.push(rawPoi);\r\n                    return;\r\n                }\r\n\r\n                // 2) Non normalis√© + mapping ‚Üí tentative de normalisation\r\n                const normalized = this.mapRawPoiToNormalized(rawPoi, mappingDef);\r\n                if (normalized && this.isPoiStructNormalized(normalized)) {\r\n                    result.push(normalized);\r\n                } else {\r\n                    Log.warn(\r\n                        \"[GeoLeaf.Config.Normalization] POI non normalis√© m√™me apr√®s application du mapping ; POI ignor√©.\",\r\n                        {\r\n                            poiIndex: index,\r\n                            poiId: rawPoi && rawPoi.id\r\n                        }\r\n                    );\r\n                }\r\n            });\r\n\r\n            return result;\r\n        },\r\n\r\n        /**\r\n         * Normalise le tableau de POI, notamment pour les avis (reviews).\r\n         *\r\n         * - Alimente syst√©matiquement `attributes.reviews` si des avis sont pr√©sents.\r\n         * - Supporte l'ancien format (tableau simple) et le nouveau format objet\r\n         *   `{ rating, count, summary, recent[] }`.\r\n         *\r\n         * @param {Array} poiArray\r\n         * @returns {Array}\r\n         */\r\n        normalizePoiArray(poiArray) {\r\n            if (!Array.isArray(poiArray)) {\r\n                return poiArray;\r\n            }\r\n\r\n            return poiArray.map((poi, index) => {\r\n                if (!poi || typeof poi !== \"object\") {\r\n                    return poi;\r\n                }\r\n\r\n                // Copie superficielle du POI avec protection contre la pollution de prototype\r\n                // Protection: on cr√©e un objet vide sans prototype et copie les propri√©t√©s\r\n                // en excluant __proto__, constructor, prototype\r\n                const normalized = this._safeAssign({}, poi);\r\n\r\n                // Bloc attributes existant ou nouveau\r\n                const baseAttributes =\r\n                    normalized.attributes &&\r\n                    typeof normalized.attributes === \"object\" &&\r\n                    !Array.isArray(normalized.attributes)\r\n                        ? normalized.attributes\r\n                        : {};\r\n\r\n                const attributes = this._safeAssign({}, baseAttributes);\r\n\r\n                // Handle reviews - preserve full structure when it exists\r\n                // 1) If attributes.reviews is already an object with recent array (new format), preserve it\r\n                if (\r\n                    attributes.reviews &&\r\n                    typeof attributes.reviews === \"object\" &&\r\n                    !Array.isArray(attributes.reviews) &&\r\n                    Array.isArray(attributes.reviews.recent)\r\n                ) {\r\n                    // Keep the full reviews object: { rating, count, summary, recent: [...] }\r\n                    // Just limit the recent array to 5\r\n                    attributes.reviews = {\r\n                        ...attributes.reviews,\r\n                        recent: attributes.reviews.recent.slice(0, 5)\r\n                    };\r\n                }\r\n                // 2) If poi.reviews is an object with recent array (new format at root), move to attributes\r\n                else if (\r\n                    normalized.reviews &&\r\n                    typeof normalized.reviews === \"object\" &&\r\n                    !Array.isArray(normalized.reviews) &&\r\n                    Array.isArray(normalized.reviews.recent)\r\n                ) {\r\n                    attributes.reviews = {\r\n                        ...normalized.reviews,\r\n                        recent: normalized.reviews.recent.slice(0, 5)\r\n                    };\r\n                }\r\n                // 3) Legacy: attributes.reviews is already a flat array\r\n                else if (Array.isArray(attributes.reviews)) {\r\n                    attributes.reviews = attributes.reviews.slice(0, 5);\r\n                }\r\n                // 4) Legacy: poi.reviews is a flat array at root\r\n                else if (Array.isArray(normalized.reviews)) {\r\n                    attributes.reviews = normalized.reviews.slice(0, 5);\r\n                }\r\n                // 5) Unexpected format\r\n                else if (normalized.reviews !== undefined || attributes.reviews !== undefined) {\r\n                    Log.warn(\"[GeoLeaf.Config.Normalization] Format de `reviews` inattendu pour le POI :\", {\r\n                        poiIndex: index,\r\n                        poiId: normalized.id,\r\n                        reviewsType: typeof normalized.reviews,\r\n                        attributesReviewsType: typeof attributes.reviews\r\n                    });\r\n                    attributes.reviews = [];\r\n                }\r\n                // 6) No reviews at all\r\n                else {\r\n                    attributes.reviews = [];\r\n                }\r\n\r\n                normalized.attributes = attributes;\r\n\r\n                return normalized;\r\n            });\r\n        }\r\n    };\r\n\r\n    // Exposer le module\r\n    GeoLeaf._ConfigNormalization = NormalizationModule;\r\n})(window);\r\n","(function (global) {\r\n    \"use strict\";\r\n\r\n    /**\r\n     * Namespace global GeoLeaf\r\n     */\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n\r\n    /**\r\n     * Logger unifi√©\r\n     */\r\n    const Log = GeoLeaf.Log;\r\n\r\n    /**\r\n     * Module Config.Taxonomy\r\n     *\r\n     * Responsabilit√©s :\r\n     * - Chargement et gestion de la taxonomie (cat√©gories/sous-cat√©gories)\r\n     * - Lecture des cat√©gories depuis mapping.json (ancienne taxonomie)\r\n     * - Lecture des cat√©gories depuis profile.json (nouvelle taxonomie)\r\n     * - API de consultation : getCategories(), getCategory(), getSubcategory()\r\n     */\r\n    const TaxonomyModule = {\r\n        /**\r\n         * Configuration interne (r√©f√©rence partag√©e)\r\n         * @type {Object}\r\n         * @private\r\n         */\r\n        _config: null,\r\n\r\n        /**\r\n         * Initialise le module avec une r√©f√©rence √† la config.\r\n         *\r\n         * @param {Object} config - R√©f√©rence √† l'objet de configuration global\r\n         */\r\n        init(config) {\r\n            this._config = config;\r\n        },\r\n\r\n        /**\r\n         * Charge un fichier de taxonomie (mapping cat√©gories / sous-cat√©gories)\r\n         * et le fusionne dans la configuration existante.\r\n         *\r\n         * @param {string} [url] - URL du fichier de mapping (depuis le profil)\r\n         * @param {Object} [options]\r\n         * @param {Object} [options.headers]\r\n         * @param {boolean} [options.strictContentType=true]\r\n         * @returns {Promise<Object>} - Objet categories consolid√©\r\n         */\r\n        loadTaxonomy(url = null, options = {}) {\r\n            const Loader = GeoLeaf._ConfigLoader;\r\n            if (!Loader) {\r\n                Log.error(\"[GeoLeaf.Config.Taxonomy] Module Loader non disponible.\");\r\n                return Promise.reject(new Error(\"Loader module not available\"));\r\n            }\r\n\r\n            if (!url) {\r\n                Log.info(\"[GeoLeaf.Config.Taxonomy] Aucune URL de mapping fournie ‚Äî skip.\");\r\n                return Promise.resolve({});\r\n            }\r\n\r\n            return Loader.loadUrl(url, options)\r\n                .then((cfg) => {\r\n                    const hasCategories =\r\n                        cfg &&\r\n                        typeof cfg === \"object\" &&\r\n                        cfg.categories &&\r\n                        typeof cfg.categories === \"object\" &&\r\n                        !Array.isArray(cfg.categories);\r\n\r\n                    if (!hasCategories) {\r\n                        Log.warn(\r\n                            \"[GeoLeaf.Config.Taxonomy] Fichier de mapping cat√©gories charg√© mais \" +\r\n                            \"aucune propri√©t√© 'categories' valide trouv√©e (attendu: { \\\"categories\\\": { ... } }).\"\r\n                        );\r\n                    } else {\r\n                        // Fusionner dans la config\r\n                        if (!this._config.categories || typeof this._config.categories !== \"object\") {\r\n                            this._config.categories = {};\r\n                        }\r\n                        Object.assign(this._config.categories, cfg.categories);\r\n\r\n                        Log.info(\r\n                            \"[GeoLeaf.Config.Taxonomy] Mapping cat√©gories fusionn√© avec succ√®s.\"\r\n                        );\r\n                    }\r\n\r\n                    return this.getCategories();\r\n                })\r\n                .catch((err) => {\r\n                    Log.error(\"[GeoLeaf.Config.Taxonomy] Erreur lors du chargement de la taxonomie :\", err);\r\n                    return {};\r\n                });\r\n        },\r\n\r\n        /**\r\n         * Retourne l'objet complet des cat√©gories (mapping interne).\r\n         *\r\n         * @returns {Object} - { [categoryId]: { label, icon, colorFill, colorStroke, subcategories? } }\r\n         */\r\n        getCategories() {\r\n            if (!this._config) return {};\r\n            const cats = this._config.categories;\r\n            return (cats && typeof cats === \"object\" && !Array.isArray(cats)) ? cats : {};\r\n        },\r\n\r\n        /**\r\n         * Retourne une cat√©gorie √† partir de son identifiant.\r\n         *\r\n         * @param {string} categoryId\r\n         * @returns {Object|undefined}\r\n         */\r\n        getCategory(categoryId) {\r\n            if (!categoryId || typeof categoryId !== \"string\") {\r\n                return undefined;\r\n            }\r\n\r\n            const cats = this.getCategories();\r\n            if (!Object.prototype.hasOwnProperty.call(cats, categoryId)) {\r\n                return undefined;\r\n            }\r\n\r\n            return cats[categoryId];\r\n        },\r\n\r\n        /**\r\n         * Retourne une sous-cat√©gorie √† partir de son identifiant et de celui\r\n         * de la cat√©gorie parente.\r\n         *\r\n         * @param {string} categoryId\r\n         * @param {string} subCategoryId\r\n         * @returns {Object|undefined}\r\n         */\r\n        getSubcategory(categoryId, subCategoryId) {\r\n            if (\r\n                !categoryId || typeof categoryId !== \"string\" ||\r\n                !subCategoryId || typeof subCategoryId !== \"string\"\r\n            ) {\r\n                return undefined;\r\n            }\r\n\r\n            const category = this.getCategory(categoryId);\r\n            if (\r\n                !category ||\r\n                !category.subcategories ||\r\n                typeof category.subcategories !== \"object\" ||\r\n                Array.isArray(category.subcategories)\r\n            ) {\r\n                return undefined;\r\n            }\r\n\r\n            const subs = category.subcategories;\r\n            if (!Object.prototype.hasOwnProperty.call(subs, subCategoryId)) {\r\n                return undefined;\r\n            }\r\n\r\n            return subs[subCategoryId];\r\n        }\r\n    };\r\n\r\n    // Exposer le module\r\n    GeoLeaf._ConfigTaxonomy = TaxonomyModule;\r\n})(window);\r\n","/**\r\n * @fileoverview Chargeur de profil V3.0 pour GeoLeaf\r\n * G√®re le chargement modulaire des profils avec structure V3:\r\n * - profile.json (m√©tadonn√©es)\r\n * - taxonomy.json (cat√©gories/sous-cat√©gories)\r\n * - themes.json (th√®mes visuels)\r\n * - layers.json (index des couches)\r\n * - layers/{layerId}/{layerId}_config.json (config par couche)\r\n * @module config/profile-v3-loader\r\n */\r\n\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = global.GeoLeaf = global.GeoLeaf || {};\r\n    const Log = GeoLeaf.Log;\r\n\r\n    /**\r\n     * Module de chargement de profils V3.0\r\n     * @namespace ProfileV3Loader\r\n     */\r\n    const ProfileV3Loader = {\r\n        /**\r\n         * Charge un profil v3.0 avec structure modulaire\r\n         * @param {Object} profile - Objet profile.json v3.0\r\n         * @param {string} baseUrl - URL de base du profil\r\n         * @param {string} profileId - ID du profil\r\n         * @param {number} timestamp - Timestamp pour cache busting\r\n         * @param {Object} fetchOptions - Options de fetch\r\n         * @returns {Promise<Object>} Profil enrichi avec toutes les donn√©es charg√©es\r\n         */\r\n        async loadV3Profile(profile, baseUrl, profileId, timestamp = Date.now(), fetchOptions = {}) {\r\n            const Loader = GeoLeaf._ConfigLoader;\r\n\r\n            if (!Loader) {\r\n                throw new Error(\"GeoLeaf._ConfigLoader non disponible\");\r\n            }\r\n\r\n            Log.info(`[ProfileV3Loader] Chargement profil V3.0: ${profileId}`);\r\n\r\n            try {\r\n                // 1. Charger les ressources en parall√®le\r\n                const [taxonomyData, themesData, layersFileData] = await Promise.all([\r\n                    this._loadTaxonomy(profile, baseUrl, timestamp, fetchOptions),\r\n                    this._loadThemes(profile, baseUrl, timestamp, fetchOptions),\r\n                    this._loadLayersFile(profile, baseUrl, timestamp, fetchOptions)\r\n                ]);\r\n\r\n                // 2. D√©terminer la source des layers\r\n                const layersSource = layersFileData || profile.layers || [];\r\n\r\n                // 3. Charger les configurations individuelles des layers\r\n                const layersConfigs = await this._loadLayerConfigs(\r\n                    layersSource,\r\n                    baseUrl,\r\n                    timestamp,\r\n                    fetchOptions\r\n                );\r\n\r\n                // 4. Construire le profil enrichi\r\n                const enrichedProfile = this._buildEnrichedProfile({\r\n                    profile,\r\n                    baseUrl,\r\n                    profileId,\r\n                    taxonomy: taxonomyData,\r\n                    themes: themesData,\r\n                    layersSource,\r\n                    layersConfigs\r\n                });\r\n\r\n                Log.info(\"[ProfileV3Loader] Profil V3.0 charg√© avec succ√®s\", {\r\n                    profileId,\r\n                    hasTaxonomy: !!enrichedProfile.taxonomy,\r\n                    hasThemes: !!enrichedProfile.themes,\r\n                    layersCount: enrichedProfile.layers ? enrichedProfile.layers.length : 0\r\n                });\r\n\r\n                return enrichedProfile;\r\n\r\n            } catch (error) {\r\n                Log.error(\"[ProfileV3Loader] Erreur chargement profil V3.0:\", error);\r\n                throw error;\r\n            }\r\n        },\r\n\r\n        /**\r\n         * V√©rifie si des features GeoJSON ont des categoryId/subCategoryId\r\n         * @private\r\n         * @returns {boolean} true si au moins une feature a des cat√©gories\r\n         */\r\n        _shouldLoadTaxonomy() {\r\n            // Toujours charger la taxonomie si elle est r√©f√©renc√©e dans le profil\r\n            // Les features GeoJSON ne sont pas encore charg√©es √† ce stade\r\n            return true;\r\n        },\r\n\r\n        /**\r\n         * Charge taxonomy.json si r√©f√©renc√© ET si des features ont des cat√©gories\r\n         * @private\r\n         */\r\n        async _loadTaxonomy(profile, baseUrl, timestamp, fetchOptions) {\r\n            const Loader = GeoLeaf._ConfigLoader;\r\n            const taxonomyFile = profile.Files?.taxonomyFile || profile.taxonomyFile;\r\n\r\n            if (!taxonomyFile && !profile.taxonomy) {\r\n                return null;\r\n            }\r\n\r\n            // V√©rifier si on doit charger la taxonomy (si features ont des cat√©gories)\r\n            const shouldLoad = this._shouldLoadTaxonomy();\r\n            if (!shouldLoad) {\r\n                Log.info(\"[ProfileV3Loader] Taxonomy.json non charg√© (aucune cat√©gorie d√©tect√©e dans les donn√©es)\");\r\n                return null;\r\n            }\r\n\r\n            if (taxonomyFile) {\r\n                try {\r\n                    const taxonomy = await Loader.fetchJson(\r\n                        `${baseUrl}/${taxonomyFile}?t=${timestamp}`,\r\n                        fetchOptions\r\n                    );\r\n                    Log.info(\"[ProfileV3Loader] Taxonomy.json charg√© avec succ√®s\");\r\n                    return taxonomy;\r\n                } catch (err) {\r\n                    Log.warn(\"[ProfileV3Loader] Erreur chargement taxonomy.json:\", err);\r\n                    return null;\r\n                }\r\n            }\r\n\r\n            return profile.taxonomy || null;\r\n        },\r\n\r\n        /**\r\n         * Charge themes.json si r√©f√©renc√©\r\n         * @private\r\n         */\r\n        async _loadThemes(profile, baseUrl, timestamp, fetchOptions) {\r\n            const Loader = GeoLeaf._ConfigLoader;\r\n            const themesFile = profile.Files?.themesFile || profile.themesFile;\r\n\r\n            if (themesFile) {\r\n                try {\r\n                    const themes = await Loader.fetchJson(\r\n                        `${baseUrl}/${themesFile}?t=${timestamp}`,\r\n                        fetchOptions\r\n                    );\r\n                    return themes;\r\n                } catch (err) {\r\n                    Log.warn(\"[ProfileV3Loader] Erreur chargement themes.json:\", err);\r\n                    return null;\r\n                }\r\n            }\r\n\r\n            return profile.themes || null;\r\n        },\r\n\r\n        /**\r\n         * Charge layers.json si r√©f√©renc√©\r\n         * @private\r\n         */\r\n        async _loadLayersFile(profile, baseUrl, timestamp, fetchOptions) {\r\n            const Loader = GeoLeaf._ConfigLoader;\r\n            const layersFile = profile.Files?.layersFile;\r\n\r\n            if (layersFile) {\r\n                try {\r\n                    const layers = await Loader.fetchJson(\r\n                        `${baseUrl}/${layersFile}?t=${timestamp}`,\r\n                        fetchOptions\r\n                    );\r\n                    return layers;\r\n                } catch (err) {\r\n                    Log.warn(\"[ProfileV3Loader] Erreur chargement layers.json:\", err);\r\n                    return null;\r\n                }\r\n            }\r\n\r\n            return null;\r\n        },\r\n\r\n        /**\r\n         * Charge les configurations individuelles des layers\r\n         * @private\r\n         */\r\n        async _loadLayerConfigs(layersSource, baseUrl, timestamp, fetchOptions) {\r\n            const Loader = GeoLeaf._ConfigLoader;\r\n\r\n            if (!Array.isArray(layersSource) || layersSource.length === 0) {\r\n                return [];\r\n            }\r\n\r\n            const promises = layersSource.map(async (layerRef) => {\r\n                if (!layerRef.configFile) {\r\n                    return {\r\n                        id: layerRef.id,\r\n                        config: null,\r\n                        layerDirectory: null,\r\n                        layerManagerId: layerRef.layerManagerId || null\r\n                    };\r\n                }\r\n\r\n                const layerDirectory = layerRef.configFile.replace(/\\/[^\\/]+$/, '');\r\n\r\n                try {\r\n                    const layerConfig = await Loader.fetchJson(\r\n                        `${baseUrl}/${layerRef.configFile}?t=${timestamp}`,\r\n                        fetchOptions\r\n                    );\r\n\r\n                    return {\r\n                        id: layerRef.id,\r\n                        config: layerConfig,\r\n                        layerDirectory: layerDirectory,\r\n                        layerManagerId: layerRef.layerManagerId || null\r\n                    };\r\n                } catch (err) {\r\n                    Log.error(`[ProfileV3Loader] Erreur chargement ${layerRef.configFile}:`, err);\r\n                    return {\r\n                        id: layerRef.id,\r\n                        config: null,\r\n                        layerDirectory: layerDirectory,\r\n                        layerManagerId: layerRef.layerManagerId || null\r\n                    };\r\n                }\r\n            });\r\n\r\n            return Promise.all(promises);\r\n        },\r\n\r\n        /**\r\n         * Construit le profil enrichi avec toutes les donn√©es charg√©es\r\n         * @private\r\n         */\r\n        _buildEnrichedProfile(params) {\r\n            const { profile, baseUrl, profileId, taxonomy, themes, layersSource, layersConfigs } = params;\r\n\r\n            const enrichedProfile = { ...profile };\r\n\r\n            // Ajouter le basePath pour r√©solution des chemins\r\n            enrichedProfile.basePath = baseUrl;\r\n            enrichedProfile._profileId = profileId;\r\n\r\n            // Int√©grer la taxonomie\r\n            if (taxonomy) {\r\n                enrichedProfile.taxonomy = taxonomy;\r\n            }\r\n\r\n            // Int√©grer les th√®mes\r\n            if (themes) {\r\n                enrichedProfile.themes = themes;\r\n            }\r\n\r\n            // Int√©grer les configurations de couches\r\n            if (layersConfigs && layersConfigs.length > 0) {\r\n                enrichedProfile.layers = layersConfigs.map(layerData => {\r\n                    if (layerData.config) {\r\n                        // Ajouter le layerDirectory, profileId ET layerManagerId √† la config\r\n                        const normalized = {\r\n                            ...layerData.config,\r\n                            _layerDirectory: layerData.layerDirectory,\r\n                            _profileId: profileId,\r\n                            layerManagerId: layerData.layerManagerId || layerData.config.layerManagerId || 'geojson-default'\r\n                        };\r\n\r\n                        // Normaliser data.file ‚Üí dataFile pour compatibilit√© GeoJSON loader\r\n                        if (normalized.data && normalized.data.file && !normalized.dataFile) {\r\n                            const dataDir = normalized.data.directory || 'data';\r\n                            normalized.dataFile = `${dataDir}/${normalized.data.file}`;\r\n                        }\r\n\r\n                        return normalized;\r\n                    }\r\n                    // Fallback si erreur de chargement\r\n                    const original = layersSource.find(l => l.id === layerData.id);\r\n                    return original || { id: layerData.id, error: \"Failed to load config\" };\r\n                });\r\n            }\r\n\r\n            return enrichedProfile;\r\n        },\r\n\r\n        /**\r\n         * D√©termine si un profil utilise la structure V3.0\r\n         * @param {Object} profile - Objet profile.json\r\n         * @returns {boolean} True si V3.0\r\n         */\r\n        isV3Profile(profile) {\r\n            if (!profile || typeof profile !== 'object') {\r\n                return false;\r\n            }\r\n\r\n            // D√©tection V3.0: pr√©sence de Files ou version >= 3.0.0\r\n            if (profile.Files && typeof profile.Files === 'object') {\r\n                return true;\r\n            }\r\n\r\n            if (profile.version) {\r\n                const versionMatch = profile.version.match(/^(\\d+)\\.(\\d+)/);\r\n                if (versionMatch) {\r\n                    const major = parseInt(versionMatch[1], 10);\r\n                    return major >= 3;\r\n                }\r\n            }\r\n\r\n            return false;\r\n        }\r\n    };\r\n\r\n    // Exposer le module\r\n    GeoLeaf._ProfileV3Loader = ProfileV3Loader;\r\n\r\n})(window);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    /**\r\n     * Namespace global GeoLeaf\r\n     */\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n\r\n    /**\r\n     * Logger unifi√©\r\n     */\r\n    const Log = GeoLeaf.Log;\r\n\r\n    /**\r\n     * Module Config.Profile\r\n     *\r\n     * Responsabilit√©s :\r\n     * - Chargement des profils m√©tier (tourism, etc.)\r\n     * - Gestion des ressources de profil : profile.json, poi.json, routes.json, mapping.json\r\n     * - API de consultation : getActiveProfile*()\r\n     * - √âv√©nements DOM : geoleaf:profile:loaded\r\n     */\r\n    const ProfileModule = {\r\n        /**\r\n         * Configuration interne (r√©f√©rence partag√©e)\r\n         * @type {Object}\r\n         * @private\r\n         */\r\n        _config: null,\r\n\r\n        /**\r\n         * Profil actuellement actif (ID du profil).\r\n         * @type {string|null}\r\n         * @private\r\n         */\r\n        _activeProfileId: null,\r\n\r\n        /**\r\n         * Description du profil actif (contenu de profile.json).\r\n         * @type {Object|null}\r\n         * @private\r\n         */\r\n        _activeProfile: null,\r\n\r\n        /**\r\n         * Donn√©es rattach√©es au profil actif :\r\n         * - poi.json normalis√©\r\n         * - routes.json\r\n         * - mapping.json\r\n         * @type {{poi: Array, routes: Array, mapping: Object|null}}\r\n         * @private\r\n         */\r\n        _activeProfileData: {\r\n            poi: [],\r\n            routes: [],\r\n            mapping: null\r\n        },\r\n\r\n        /**\r\n         * Initialise le module avec une r√©f√©rence √† la config.\r\n         *\r\n         * @param {Object} config - R√©f√©rence √† l'objet de configuration global\r\n         */\r\n        init(config) {\r\n            this._config = config;\r\n        },\r\n\r\n        /**\r\n         * Indique si l'usage de mapping.json pour normaliser les POI de profil est activ√©.\r\n         *\r\n         * üîé Cherche plusieurs noms possibles dans config.data pour rester robuste :\r\n         *   - config.data.enableProfilePoiMapping (nom recommand√©)\r\n         *   - config.data.useProfilePoiMapping\r\n         *   - config.data.useMapping (compatibilit√© √©ventuelle)\r\n         *\r\n         * @returns {boolean} true si le mapping doit √™tre utilis√©, false sinon.\r\n         */\r\n        isProfilePoiMappingEnabled() {\r\n            const dataCfg = this._config && this._config.data;\r\n            if (!dataCfg || typeof dataCfg !== \"object\") {\r\n                return true; // par d√©faut : mapping actif\r\n            }\r\n\r\n            if (typeof dataCfg.enableProfilePoiMapping === \"boolean\") {\r\n                return dataCfg.enableProfilePoiMapping;\r\n            }\r\n            if (typeof dataCfg.useProfilePoiMapping === \"boolean\") {\r\n                return dataCfg.useProfilePoiMapping;\r\n            }\r\n            if (typeof dataCfg.useMapping === \"boolean\") {\r\n                return dataCfg.useMapping;\r\n            }\r\n\r\n            return true;\r\n        },\r\n\r\n        /**\r\n         * Charge les ressources li√©es au profil actif :\r\n         * - profile.json\r\n         * - poi.json\r\n         * - mapping.json\r\n         * - routes.json\r\n         *\r\n         * Utilise config.data.activeProfile et config.data.profilesBasePath.\r\n         * Injecte aussi, pour compatibilit√©, les POI et routes dans this._config.poi / this._config.routes.\r\n         * Injecte d√©sormais la taxonomie (categories) depuis profile.json dans this._config.categories.\r\n         *\r\n         * @param {Object} [options]\r\n         * @param {Object} [options.headers] - Headers HTTP optionnels.\r\n         * @param {boolean} [options.strictContentType=true] - Validation stricte du Content-Type.\r\n         * @returns {Promise<Object>} Configuration consolid√©e incluant les donn√©es du profil.\r\n         */\r\n        loadActiveProfileResources(options = {}) {\r\n            const dataCfg = this._config && this._config.data;\r\n            if (!dataCfg || !dataCfg.activeProfile) {\r\n                Log.info(\r\n                    \"[GeoLeaf.Config.Profile] Aucun profil actif d√©fini dans config.data.activeProfile ; aucun chargement de profil effectu√©.\"\r\n                );\r\n                return Promise.resolve(this._config);\r\n            }\r\n\r\n            // Nouveau : mode layers-only (pas de poi.json / routes.json). Par d√©faut activ√©.\r\n            const useLegacyProfileData =\r\n                typeof dataCfg.useLegacyProfileData === \"boolean\"\r\n                    ? dataCfg.useLegacyProfileData\r\n                    : false;\r\n\r\n            const profileId = dataCfg.activeProfile;\r\n            const basePath = dataCfg.profilesBasePath || \"data/profiles\";\r\n            const baseUrl = `${basePath}/${profileId}`;\r\n\r\n            Log.info(\"[GeoLeaf.Config.Profile] D√©but du chargement du profil :\", {\r\n                profileId,\r\n                baseUrl,\r\n                configData: dataCfg\r\n            });\r\n\r\n            const fetchOptions = {\r\n                headers: options.headers || {},\r\n                strictContentType:\r\n                    typeof options.strictContentType === \"boolean\"\r\n                        ? options.strictContentType\r\n                        : true\r\n            };\r\n\r\n            const Loader = GeoLeaf._ConfigLoader;\r\n            const Normalization = GeoLeaf._ConfigNormalization;\r\n\r\n            if (!Loader || !Normalization) {\r\n                Log.error(\"[GeoLeaf.Config.Profile] Modules Loader ou Normalization non disponibles.\");\r\n                return Promise.reject(new Error(\"Required modules not available\"));\r\n            }\r\n\r\n            // üîß Nouveau : pilotage global de l'usage de mapping.json via config.data.*\r\n            const isPoiMappingEnabled = this.isProfilePoiMappingEnabled();\r\n            if (!isPoiMappingEnabled) {\r\n                Log.info(\r\n                    \"[GeoLeaf.Config.Profile] Mapping de POI d√©sactiv√© via configuration globale ; \" +\r\n                    \"les POI du profil seront consid√©r√©s comme d√©j√† normalis√©s.\"\r\n                );\r\n            }\r\n\r\n            Log.info(\"[GeoLeaf.Config.Profile] Chargement des ressources du profil actif :\", {\r\n                profileId,\r\n                baseUrl\r\n            });\r\n\r\n            const timestamp = Date.now();\r\n\r\n            // Branche legacy (maintien backward compat) : charge poi.json/routes.json\r\n            if (useLegacyProfileData) {\r\n                // Si le mapping est d√©sactiv√©, on ne charge pas mapping.json (Promise.resolve(null))\r\n                const mappingPromise = isPoiMappingEnabled\r\n                    ? Loader.fetchJson(`${baseUrl}/mapping.json?t=${timestamp}`, fetchOptions)\r\n                    : Promise.resolve(null);\r\n\r\n                // routes.json est optionnel - on tente de le charger mais on tol√®re son absence\r\n                const routesPromise = Loader.fetchJson(`${baseUrl}/routes.json?t=${timestamp}`, fetchOptions)\r\n                    .catch(() => {\r\n                        Log.info(\"[GeoLeaf.Config.Profile] routes.json non disponible ou invalide, utilisation d'un tableau vide.\");\r\n                        return [];\r\n                    });\r\n\r\n                return Promise.all([\r\n                    Loader.fetchJson(`${baseUrl}/profile.json?t=${timestamp}`, fetchOptions),\r\n                    Loader.fetchJson(`${baseUrl}/poi.json?t=${timestamp}`, fetchOptions),\r\n                    mappingPromise,\r\n                    routesPromise\r\n                ])\r\n                    .then(([profile, poi, mapping, routes]) => {\r\n                        return this._finalizeProfileLoad({\r\n                            profile,\r\n                            poi,\r\n                            routes,\r\n                            mapping,\r\n                            mappingEnabled: isPoiMappingEnabled\r\n                        });\r\n                    })\r\n                    .catch((err) => {\r\n                        Log.error(\r\n                            \"[GeoLeaf.Config.Profile] Erreur lors du chargement des ressources du profil actif :\",\r\n                            err\r\n                        );\r\n                        return this._config;\r\n                    });\r\n            }\r\n\r\n            // Nouveau chemin : layers-only. On charge d'abord profile.json pour v√©rifier si mapping est requis.\r\n            return Loader.fetchJson(`${baseUrl}/profile.json?t=${timestamp}`, fetchOptions)\r\n                .then((profile) => {\r\n                    // Utiliser la logique de d√©tection du ProfileV3Loader pour coh√©rence\r\n                    const isV3 = GeoLeaf._ProfileV3Loader && GeoLeaf._ProfileV3Loader.isV3Profile(profile);\r\n\r\n                    if (isV3) {\r\n                        Log.info(\"[GeoLeaf.Config.Profile] Profil v3.0 d√©tect√© - Chargement modulaire\");\r\n                        // Pour v3.0, retourner directement la config (pas besoin du .then suivant)\r\n                        return this._loadV3Profile(profile, baseUrl, timestamp, fetchOptions);\r\n                    }\r\n\r\n                    // Version 2.0 (ancien comportement)\r\n                    // V√©rifier si au moins une couche a normalized:false (n√©cessite mapping)\r\n                    let requiresMapping = false;\r\n                    if (profile && Array.isArray(profile.layers)) {\r\n                        requiresMapping = profile.layers.some(layer => layer.normalized === false);\r\n                    }\r\n\r\n                    // Charger mapping seulement si requis\r\n                    const mappingPromise = isPoiMappingEnabled && requiresMapping\r\n                        ? Loader.fetchJson(`${baseUrl}/mapping.json?t=${timestamp}`, fetchOptions).catch((err) => {\r\n                              Log.error(\"[GeoLeaf.Config.Profile] mapping.json requis (normalized:false) mais non trouv√© ou invalide.\", err);\r\n                              return null;\r\n                          })\r\n                        : Promise.resolve(null);\r\n\r\n                    return Promise.all([Promise.resolve(profile), mappingPromise]);\r\n                })\r\n                .then((result) => {\r\n                    // Si c'est un profil v3.0, on le retourne directement (pas un array)\r\n                    if (result && !Array.isArray(result)) {\r\n                        return result;\r\n                    }\r\n\r\n                    // Sinon c'est un array [profile, mapping] (v2.0)\r\n                    const [profile, mapping] = result;\r\n                    this._activeProfileId = profileId;\r\n                    this._activeProfile = profile || null;\r\n\r\n                    Log.info(\"[GeoLeaf.Config.Profile] Profil charg√© (layers-only)\", {\r\n                        profileId,\r\n                        profileLoaded: !!profile,\r\n                        profileKeys: profile ? Object.keys(profile) : []\r\n                    });\r\n\r\n                    // Dans ce mode, on ne pr√©charge pas les POI/Routes : ils seront lus via GeoJSON layers.\r\n                    this._activeProfileData = {\r\n                        poi: [],\r\n                        routes: [],\r\n                        mapping: mapping && typeof mapping === \"object\" ? mapping : null\r\n                    };\r\n\r\n                    // Taxonomie : reste depuis profile.json\r\n                    if (\r\n                        profile &&\r\n                        typeof profile === \"object\" &&\r\n                        profile.taxonomy &&\r\n                        profile.taxonomy.categories &&\r\n                        typeof profile.taxonomy.categories === \"object\" &&\r\n                        !Array.isArray(profile.taxonomy.categories)\r\n                    ) {\r\n                        this._config.categories = profile.taxonomy.categories;\r\n                        Log.info(\r\n                            \"[GeoLeaf.Config.Profile] Taxonomie des cat√©gories charg√©e (layers-only).\",\r\n                            {\r\n                                profileId,\r\n                                categoriesCount: Object.keys(profile.taxonomy.categories || {}).length\r\n                            }\r\n                        );\r\n                    }\r\n\r\n                    // Stockage par profil\r\n                    if (\r\n                        !this._config.profiles ||\r\n                        typeof this._config.profiles !== \"object\" ||\r\n                        Array.isArray(this._config.profiles)\r\n                    ) {\r\n                        this._config.profiles = {};\r\n                    }\r\n\r\n                    this._config.profiles[profileId] = {\r\n                        profile: this._activeProfile,\r\n                        poi: this._activeProfileData.poi,\r\n                        routes: this._activeProfileData.routes,\r\n                        mapping: this._activeProfileData.mapping\r\n                    };\r\n\r\n                    // √âv√©nement pour les autres modules\r\n                    this._fireProfileLoadedEvent(profileId, {\r\n                        profile: this._activeProfile,\r\n                        poi: this._activeProfileData.poi,\r\n                        routes: this._activeProfileData.routes,\r\n                        mapping: this._activeProfileData.mapping\r\n                    });\r\n\r\n                    return this._config;\r\n                })\r\n                .catch((err) => {\r\n                    Log.error(\r\n                        \"[GeoLeaf.Config.Profile] Erreur lors du chargement des ressources du profil actif :\",\r\n                        err\r\n                    );\r\n                    return this._config;\r\n                });\r\n        },\r\n\r\n        /**\r\n         * Charge un profil v3.0 avec structure modulaire\r\n         * @param {Object} profile - Objet profile.json v3.0\r\n         * @param {string} baseUrl - URL de base du profil\r\n         * @param {number} timestamp - Timestamp pour cache busting\r\n         * @param {Object} fetchOptions - Options de fetch\r\n         * @returns {Promise<Object>} Config consolid√©e\r\n         * @private\r\n         */\r\n        _loadV3Profile(profile, baseUrl, timestamp, fetchOptions) {\r\n            const profileId = this._config.data.activeProfile;\r\n\r\n            // Utiliser le ProfileV3Loader pour charger le profil\r\n            if (!GeoLeaf._ProfileV3Loader) {\r\n                Log.error(\"[GeoLeaf.Config.Profile] ProfileV3Loader non disponible\");\r\n                return Promise.reject(new Error(\"ProfileV3Loader non disponible\"));\r\n            }\r\n\r\n            return GeoLeaf._ProfileV3Loader.loadV3Profile(\r\n                profile,\r\n                baseUrl,\r\n                profileId,\r\n                timestamp,\r\n                fetchOptions\r\n            ).then(enrichedProfile => {\r\n                // Stocker le profil enrichi\r\n                this._activeProfileId = profileId;\r\n                this._activeProfile = enrichedProfile;\r\n\r\n                Log.info(\"[GeoLeaf.Config.Profile] Profil v3.0 charg√© avec succ√®s\", {\r\n                    profileId,\r\n                    hasTaxonomy: !!enrichedProfile.taxonomy,\r\n                    hasThemes: !!enrichedProfile.themes,\r\n                    layersCount: enrichedProfile.layers ? enrichedProfile.layers.length : 0\r\n                });\r\n\r\n                this._activeProfileData = {\r\n                    poi: [],\r\n                    routes: [],\r\n                    mapping: null\r\n                };\r\n\r\n                // Stocker la taxonomie dans config.categories pour compatibilit√©\r\n                if (enrichedProfile.taxonomy && enrichedProfile.taxonomy.categories) {\r\n                    this._config.categories = enrichedProfile.taxonomy.categories;\r\n                    Log.info(\"[GeoLeaf.Config.Profile] Taxonomie charg√©e depuis v3.0\", {\r\n                        categoriesCount: Object.keys(enrichedProfile.taxonomy.categories || {}).length\r\n                    });\r\n                }\r\n\r\n                // Copier toutes les propri√©t√©s du profil dans this._config\r\n                Object.keys(enrichedProfile).forEach(key => {\r\n                    if (key !== 'layers' && key !== 'taxonomy' && key !== 'themes') {\r\n                        this._config[key] = enrichedProfile[key];\r\n                    }\r\n                });\r\n\r\n                // Stocker par profil\r\n                if (!this._config.profiles || typeof this._config.profiles !== \"object\") {\r\n                    this._config.profiles = {};\r\n                }\r\n\r\n                this._config.profiles[profileId] = {\r\n                    profile: this._activeProfile,\r\n                    poi: [],\r\n                    routes: [],\r\n                    mapping: null\r\n                };\r\n\r\n                // √âv√©nement\r\n                this._fireProfileLoadedEvent(profileId, {\r\n                    profile: this._activeProfile,\r\n                    poi: [],\r\n                    routes: [],\r\n                    mapping: null\r\n                });\r\n\r\n                return enrichedProfile;\r\n            });\r\n        },\r\n\r\n        // Factorise la fin du chargement (branche legacy uniquement)\r\n        _finalizeProfileLoad({ profile, poi, routes, mapping, mappingEnabled }) {\r\n            const Normalization = GeoLeaf._ConfigNormalization;\r\n\r\n            this._activeProfile = profile || null;\r\n\r\n            Log.info(\r\n                \"[GeoLeaf.Config.Profile] Profil charg√© depuis profile.json :\",\r\n                {\r\n                    profileId: this._activeProfileId,\r\n                    profileLoaded: profile !== null && profile !== undefined,\r\n                    profileKeys: profile ? Object.keys(profile) : []\r\n                }\r\n            );\r\n\r\n            // Si le mapping est coup√© au niveau global, on l'ignore m√™me s'il existe\r\n            const mappingForNormalization =\r\n                mappingEnabled && mapping && typeof mapping === \"object\"\r\n                    ? mapping\r\n                    : null;\r\n\r\n            // 1) Normalisation STRUCTURELLE des POI\r\n            const structurallyNormalizedPoi = Array.isArray(poi)\r\n                ? Normalization.normalizePoiWithMapping(poi, mappingForNormalization)\r\n                : [];\r\n\r\n            // 2) Normalisation m√©tier des avis\r\n            const normalizedPoi = Normalization.normalizePoiArray(structurallyNormalizedPoi);\r\n\r\n            const safeMapping = mappingForNormalization;\r\n            const safeRoutes = Array.isArray(routes) ? routes : [];\r\n\r\n            this._activeProfileData = {\r\n                poi: normalizedPoi,\r\n                mapping: safeMapping,\r\n                routes: safeRoutes\r\n            };\r\n\r\n            // Injection r√©trocompatible dans la config globale\r\n            if (normalizedPoi.length) {\r\n                this._config.poi = normalizedPoi;\r\n            }\r\n            if (safeRoutes.length) {\r\n                this._config.routes = safeRoutes;\r\n            }\r\n\r\n            // Taxonomie\r\n            if (\r\n                profile &&\r\n                typeof profile === \"object\" &&\r\n                profile.taxonomy &&\r\n                profile.taxonomy.categories &&\r\n                typeof profile.taxonomy.categories === \"object\" &&\r\n                !Array.isArray(profile.taxonomy.categories)\r\n            ) {\r\n                this._config.categories = profile.taxonomy.categories;\r\n                Log.info(\r\n                    \"[GeoLeaf.Config.Profile] Taxonomie des cat√©gories charg√©e depuis le profil actif.\",\r\n                    {\r\n                        profileId: this._activeProfileId,\r\n                        categoriesCount: Object.keys(profile.taxonomy.categories || {}).length\r\n                    }\r\n                );\r\n            }\r\n\r\n            // Stockage par profil\r\n            if (\r\n                !this._config.profiles ||\r\n                typeof this._config.profiles !== \"object\" ||\r\n                Array.isArray(this._config.profiles)\r\n            ) {\r\n                this._config.profiles = {};\r\n            }\r\n\r\n            this._config.profiles[this._activeProfileId] = {\r\n                profile: this._activeProfile,\r\n                poi: this._activeProfileData.poi,\r\n                routes: this._activeProfileData.routes,\r\n                mapping: this._activeProfileData.mapping\r\n            };\r\n\r\n            // √âv√©nement\r\n            this._fireProfileLoadedEvent(this._activeProfileId, {\r\n                profile: this._activeProfile,\r\n                poi: this._activeProfileData.poi,\r\n                routes: this._activeProfileData.routes,\r\n                mapping: this._activeProfileData.mapping\r\n            });\r\n\r\n            return this._config;\r\n        },\r\n\r\n        /**\r\n         * Retourne l'identifiant du profil actuellement charg√© (ou null).\r\n         *\r\n         * @returns {string|null}\r\n         */\r\n        getActiveProfileId() {\r\n            return this._activeProfileId;\r\n        },\r\n\r\n        /**\r\n         * Retourne l'objet profile.json du profil actif (ou null).\r\n         *\r\n         * @returns {Object|null}\r\n         */\r\n        getActiveProfile() {\r\n            return this._activeProfile;\r\n        },\r\n\r\n        /**\r\n         * Retourne le tableau de POI normalis√©s du profil actif.\r\n         *\r\n         * @returns {Array}\r\n         */\r\n        getActiveProfilePoi() {\r\n            return (this._activeProfileData && Array.isArray(this._activeProfileData.poi))\r\n                ? this._activeProfileData.poi\r\n                : [];\r\n        },\r\n\r\n        /**\r\n         * Retourne le tableau de routes du profil actif.\r\n         *\r\n         * @returns {Array}\r\n         */\r\n        getActiveProfileRoutes() {\r\n            return (this._activeProfileData && Array.isArray(this._activeProfileData.routes))\r\n                ? this._activeProfileData.routes\r\n                : [];\r\n        },\r\n\r\n        /**\r\n         * Retourne l'objet de mapping du profil actif (mapping.json).\r\n         *\r\n         * @returns {Object|null}\r\n         */\r\n        getActiveProfileMapping() {\r\n            return (this._activeProfileData && this._activeProfileData.mapping)\r\n                ? this._activeProfileData.mapping\r\n                : null;\r\n        },\r\n\r\n        /**\r\n         * Retourne la configuration des ic√¥nes depuis la taxonomie du profil actif.\r\n         *\r\n         * @returns {Object|null}\r\n         */\r\n        getIconsConfig() {\r\n            return (this._activeProfile && this._activeProfile.taxonomy && this._activeProfile.taxonomy.icons)\r\n                ? this._activeProfile.taxonomy.icons\r\n                : null;\r\n        },\r\n\r\n        /**\r\n         * Retourne les configurations de couches charg√©es depuis le profil actif v3.0\r\n         *\r\n         * @returns {Array|null}\r\n         */\r\n        getActiveProfileLayersConfig() {\r\n            return (this._activeProfile && this._activeProfile.layers)\r\n                ? this._activeProfile.layers\r\n                : null;\r\n        },\r\n\r\n        /**\r\n         * √âmet un √©v√©nement DOM \"geoleaf:profile:loaded\" lorsque le profil\r\n         * actif et ses donn√©es associ√©es sont charg√©s.\r\n         *\r\n         * @param {string} profileId\r\n         * @param {Object} payload\r\n         * @private\r\n         */\r\n        _fireProfileLoadedEvent(profileId, payload) {\r\n            if (typeof document === \"undefined\" || typeof document.dispatchEvent !== \"function\") {\r\n                return;\r\n            }\r\n\r\n            try {\r\n                const event = new CustomEvent(\"geoleaf:profile:loaded\", {\r\n                    detail: {\r\n                        profileId,\r\n                        data: payload\r\n                    }\r\n                });\r\n                document.dispatchEvent(event);\r\n            } catch (e) {\r\n                try {\r\n                    const legacyEvent = document.createEvent(\"CustomEvent\");\r\n                    legacyEvent.initCustomEvent(\r\n                        \"geoleaf:profile:loaded\",\r\n                        false,\r\n                        false,\r\n                        {\r\n                            profileId,\r\n                            data: payload\r\n                        }\r\n                    );\r\n                    document.dispatchEvent(legacyEvent);\r\n                } catch (err) {\r\n                    Log.warn(\r\n                        \"[GeoLeaf.Config.Profile] Impossible d'√©mettre l'√©v√©nement geoleaf:profile:loaded.\"\r\n                    );\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    // Exposer le module\r\n    GeoLeaf._ConfigProfile = ProfileModule;\r\n})(window);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    /**\r\n     * Namespace global GeoLeaf\r\n     */\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n\r\n    /**\r\n     * Logger unifi√©\r\n     */\r\n    const Log = GeoLeaf.Log;\r\n\r\n    /**\r\n     * Module DataConverter\r\n     *\r\n     * Responsabilit√©s :\r\n     * - Convertir les donn√©es brutes (Array de POI, Array de routes) vers GeoJSON FeatureCollection\r\n     * - Normaliser les g√©om√©tries\r\n     * - G√©rer les diff√©rents formats : POI, LineString, Polygon\r\n     *\r\n     * Utilis√© par GeoLeaf.GeoJSON lors du chargement depuis profile.json\r\n     */\r\n    const DataConverterModule = {\r\n        /**\r\n         * Convertit un array de POI en GeoJSON FeatureCollection.\r\n         *\r\n         * Chaque POI doit avoir :\r\n         * - id (string)\r\n         * - latlng (array [lat, lng])\r\n         * - title (string)\r\n         * - attributes (object)\r\n         *\r\n         * @param {Array} poiArray - Array de POI\r\n         * @returns {Object} FeatureCollection GeoJSON\r\n         */\r\n        convertPoiArrayToGeoJSON(poiArray) {\r\n            if (!Array.isArray(poiArray)) {\r\n                Log.warn(\"[DataConverter.convertPoiArrayToGeoJSON] Input n'est pas un array, retour FeatureCollection vide\");\r\n                return {\r\n                    type: \"FeatureCollection\",\r\n                    features: []\r\n                };\r\n            }\r\n\r\n            const features = poiArray\r\n                .map((poi) => {\r\n                    if (!poi || typeof poi !== \"object\") {\r\n                        return null;\r\n                    }\r\n\r\n                    if (!poi.id) {\r\n                        Log.warn(\"[DataConverter.convertPoiArrayToGeoJSON] POI sans ID, ignor√©\", poi);\r\n                        return null;\r\n                    }\r\n\r\n                    // Valider latlng\r\n                    let coordinates = null;\r\n                    if (Array.isArray(poi.latlng) && poi.latlng.length === 2) {\r\n                        // GeoJSON utilise [lon, lat], mais les donn√©es utilisent [lat, lon]\r\n                        coordinates = [poi.latlng[1], poi.latlng[0]];\r\n                    } else if (\r\n                        poi.location &&\r\n                        typeof poi.location.lat === \"number\" &&\r\n                        typeof poi.location.lng === \"number\"\r\n                    ) {\r\n                        coordinates = [poi.location.lng, poi.location.lat];\r\n                    } else {\r\n                        Log.warn(\r\n                            \"[DataConverter.convertPoiArrayToGeoJSON] POI sans coordonn√©es valides, ignor√©\",\r\n                            { id: poi.id }\r\n                        );\r\n                        return null;\r\n                    }\r\n\r\n                    // Construire la feature GeoJSON\r\n                    const feature = {\r\n                        type: \"Feature\",\r\n                        id: poi.id,\r\n                        geometry: {\r\n                            type: \"Point\",\r\n                            coordinates: coordinates\r\n                        },\r\n                        properties: {\r\n                            id: poi.id,\r\n                            title: poi.title || \"Sans titre\",\r\n                            description: poi.description || \"\",\r\n                            ...poi.attributes // Fusionner les attributs\r\n                        }\r\n                    };\r\n\r\n                    return feature;\r\n                })\r\n                .filter((f) => f !== null);\r\n\r\n            Log.debug(\"[DataConverter.convertPoiArrayToGeoJSON] Converti\", {\r\n                input: poiArray.length,\r\n                output: features.length\r\n            });\r\n\r\n            return {\r\n                type: \"FeatureCollection\",\r\n                features: features\r\n            };\r\n        },\r\n\r\n        /**\r\n         * Convertit un array de routes (LineString) en GeoJSON FeatureCollection.\r\n         *\r\n         * Chaque route doit avoir :\r\n         * - id (string)\r\n         * - geometry avec type: \"LineString\" et coordinates\r\n         * - attributes (object optionnel)\r\n         *\r\n         * @param {Array} routeArray - Array de routes\r\n         * @returns {Object} FeatureCollection GeoJSON\r\n         */\r\n        convertRouteArrayToGeoJSON(routeArray) {\r\n            if (!Array.isArray(routeArray)) {\r\n                Log.warn(\"[DataConverter.convertRouteArrayToGeoJSON] Input n'est pas un array, retour FeatureCollection vide\");\r\n                return {\r\n                    type: \"FeatureCollection\",\r\n                    features: []\r\n                };\r\n            }\r\n\r\n            const features = routeArray\r\n                .map((route) => {\r\n                    if (!route || typeof route !== \"object\") {\r\n                        return null;\r\n                    }\r\n\r\n                    if (!route.id) {\r\n                        Log.warn(\"[DataConverter.convertRouteArrayToGeoJSON] Route sans ID, ignor√©e\", route);\r\n                        return null;\r\n                    }\r\n\r\n                    // Valider la g√©om√©trie\r\n                    if (!route.geometry || route.geometry.type !== \"LineString\" || !Array.isArray(route.geometry.coordinates)) {\r\n                        Log.warn(\r\n                            \"[DataConverter.convertRouteArrayToGeoJSON] Route sans g√©om√©trie LineString valide, ignor√©e\",\r\n                            { id: route.id }\r\n                        );\r\n                        return null;\r\n                    }\r\n\r\n                    // Construire la feature GeoJSON\r\n                    const feature = {\r\n                        type: \"Feature\",\r\n                        id: route.id,\r\n                        geometry: {\r\n                            type: \"LineString\",\r\n                            coordinates: route.geometry.coordinates\r\n                        },\r\n                        properties: {\r\n                            id: route.id,\r\n                            title: route.title || \"Sans titre\",\r\n                            description: route.description || \"\",\r\n                            categoryId: route.categoryId,\r\n                            subCategoryId: route.subCategoryId,\r\n                            ...route.attributes // Fusionner les attributs\r\n                        }\r\n                    };\r\n\r\n                    return feature;\r\n                })\r\n                .filter((f) => f !== null);\r\n\r\n            Log.debug(\"[DataConverter.convertRouteArrayToGeoJSON] Converti\", {\r\n                input: routeArray.length,\r\n                output: features.length\r\n            });\r\n\r\n            return {\r\n                type: \"FeatureCollection\",\r\n                features: features\r\n            };\r\n        },\r\n\r\n        /**\r\n         * Convertit un array de zones (Polygon) en GeoJSON FeatureCollection.\r\n         *\r\n         * Chaque zone doit avoir :\r\n         * - id (string)\r\n         * - geometry avec type: \"Polygon\" et coordinates\r\n         * - attributes (object optionnel)\r\n         *\r\n         * @param {Array} zoneArray - Array de zones\r\n         * @returns {Object} FeatureCollection GeoJSON\r\n         */\r\n        convertZoneArrayToGeoJSON(zoneArray) {\r\n            if (!Array.isArray(zoneArray)) {\r\n                Log.warn(\"[DataConverter.convertZoneArrayToGeoJSON] Input n'est pas un array, retour FeatureCollection vide\");\r\n                return {\r\n                    type: \"FeatureCollection\",\r\n                    features: []\r\n                };\r\n            }\r\n\r\n            const features = zoneArray\r\n                .map((zone) => {\r\n                    if (!zone || typeof zone !== \"object\") {\r\n                        return null;\r\n                    }\r\n\r\n                    if (!zone.id) {\r\n                        Log.warn(\"[DataConverter.convertZoneArrayToGeoJSON] Zone sans ID, ignor√©e\", zone);\r\n                        return null;\r\n                    }\r\n\r\n                    // Valider la g√©om√©trie\r\n                    if (!zone.geometry || zone.geometry.type !== \"Polygon\" || !Array.isArray(zone.geometry.coordinates)) {\r\n                        Log.warn(\r\n                            \"[DataConverter.convertZoneArrayToGeoJSON] Zone sans g√©om√©trie Polygon valide, ignor√©e\",\r\n                            { id: zone.id }\r\n                        );\r\n                        return null;\r\n                    }\r\n\r\n                    // Construire la feature GeoJSON\r\n                    const feature = {\r\n                        type: \"Feature\",\r\n                        id: zone.id,\r\n                        geometry: {\r\n                            type: \"Polygon\",\r\n                            coordinates: zone.geometry.coordinates\r\n                        },\r\n                        properties: {\r\n                            id: zone.id,\r\n                            title: zone.title || zone.siteName || \"Sans titre\",\r\n                            description: zone.description || \"\",\r\n                            ...zone.attributes // Fusionner les attributs\r\n                        }\r\n                    };\r\n\r\n                    return feature;\r\n                })\r\n                .filter((f) => f !== null);\r\n\r\n            Log.debug(\"[DataConverter.convertZoneArrayToGeoJSON] Converti\", {\r\n                input: zoneArray.length,\r\n                output: features.length\r\n            });\r\n\r\n            return {\r\n                type: \"FeatureCollection\",\r\n                features: features\r\n            };\r\n        },\r\n\r\n        /**\r\n         * Convertit un string GPX en GeoJSON FeatureCollection.\r\n         *\r\n         * Parse les √©l√©ments waypoints et tracks, cr√©e des Points ou LineStrings.\r\n         *\r\n         * @param {string} gpxString - Contenu XML du fichier GPX\r\n         * @returns {Object} FeatureCollection GeoJSON\r\n         */\r\n        convertGpxToGeoJSON(gpxString) {\r\n            if (!gpxString || typeof gpxString !== \"string\") {\r\n                Log.warn(\"[DataConverter.convertGpxToGeoJSON] GPX string invalide\");\r\n                return {\r\n                    type: \"FeatureCollection\",\r\n                    features: []\r\n                };\r\n            }\r\n\r\n            try {\r\n                // Parser le XML\r\n                const parser = new DOMParser();\r\n                const gpxDoc = parser.parseFromString(gpxString, \"text/xml\");\r\n\r\n                const parseErrors = gpxDoc.getElementsByTagName(\"parsererror\");\r\n                if (parseErrors.length > 0) {\r\n                    Log.error(\"[DataConverter.convertGpxToGeoJSON] Erreur parsing XML:\", parseErrors[0].textContent);\r\n                    return {\r\n                        type: \"FeatureCollection\",\r\n                        features: []\r\n                    };\r\n                }\r\n\r\n                const features = [];\r\n                const gpxNamespace = \"http://www.topografix.com/GPX/1/1\";\r\n\r\n                // 1. Parser les waypoints (wpt)\r\n                const waypoints = gpxDoc.getElementsByTagName(\"wpt\");\r\n                for (let i = 0; i < waypoints.length; i++) {\r\n                    const wpt = waypoints[i];\r\n                    const lat = parseFloat(wpt.getAttribute(\"lat\"));\r\n                    const lon = parseFloat(wpt.getAttribute(\"lon\"));\r\n\r\n                    if (!isNaN(lat) && !isNaN(lon)) {\r\n                        const nameElem = wpt.getElementsByTagName(\"name\")[0];\r\n                        const descElem = wpt.getElementsByTagName(\"desc\")[0];\r\n                        const symElem = wpt.getElementsByTagName(\"sym\")[0];\r\n\r\n                        // Extraire les extensions GeoLeaf si pr√©sentes\r\n                        const geoLeafExt = {};\r\n                        const tagsList = []; // Accumulateur pour les tags multiples\r\n                        const extensions = wpt.getElementsByTagName(\"extensions\");\r\n                        if (extensions.length > 0) {\r\n                            const ext = extensions[0];\r\n                            // Utiliser childNodes pour √™tre s√ªr d'avoir tous les √©l√©ments\r\n                            for (let j = 0; j < ext.childNodes.length; j++) {\r\n                                const child = ext.childNodes[j];\r\n                                // Ignorer les n≈ìuds texte\r\n                                if (child.nodeType !== 1) continue;\r\n\r\n                                // R√©cup√©rer le nom du tag (g√®re les namespaces)\r\n                                const tagName = child.tagName || child.nodeName || '';\r\n                                const localName = child.localName || tagName.split(':').pop();\r\n\r\n                                // V√©rifier si c'est une extension GeoLeaf\r\n                                const isGeoLeaf = tagName.toLowerCase().startsWith(\"geoleaf:\") ||\r\n                                    (child.namespaceURI && child.namespaceURI.includes(\"geoleaf\"));\r\n\r\n                                if (isGeoLeaf || tagName.includes(':')) {\r\n                                    // Utiliser localName comme cl√© (sans pr√©fixe)\r\n                                    const key = localName || tagName.replace(/^[^:]+:/, '');\r\n                                    const value = child.textContent || '';\r\n\r\n                                    // Cas sp√©cial : les tags sont accumul√©s dans un tableau\r\n                                    if (key === 'tag' || key === 'tags') {\r\n                                        if (value) tagsList.push(value);\r\n                                    } else {\r\n                                        geoLeafExt[key] = value;\r\n                                    }\r\n                                }\r\n                            }\r\n                        }\r\n\r\n                        // Ajouter les tags comme tableau si pr√©sents\r\n                        if (tagsList.length > 0) {\r\n                            geoLeafExt.tags = tagsList;\r\n                        }\r\n\r\n                        const feature = {\r\n                            type: \"Feature\",\r\n                            id: geoLeafExt.id || (nameElem ? nameElem.textContent : `wpt-${i}`),\r\n                            geometry: {\r\n                                type: \"Point\",\r\n                                coordinates: [lon, lat]\r\n                            },\r\n                            properties: {\r\n                                id: geoLeafExt.id || (nameElem ? nameElem.textContent : `wpt-${i}`),\r\n                                title: nameElem ? nameElem.textContent : `Waypoint ${i + 1}`,\r\n                                description: descElem ? descElem.textContent : \"\",\r\n                                symbol: symElem ? symElem.textContent : \"\",\r\n                                ...geoLeafExt // Inclure les extensions GeoLeaf\r\n                            }\r\n                        };\r\n\r\n                        features.push(feature);\r\n                    }\r\n                }\r\n\r\n                // 2. Parser les tracks (trk)\r\n                const tracks = gpxDoc.getElementsByTagName(\"trk\");\r\n                for (let i = 0; i < tracks.length; i++) {\r\n                    const trk = tracks[i];\r\n                    const nameElem = trk.getElementsByTagName(\"name\")[0];\r\n                    const descElem = trk.getElementsByTagName(\"desc\")[0];\r\n\r\n                    // Extraire les extensions GeoLeaf pour le track\r\n                    const trkGeoLeafExt = {};\r\n                    const trkTagsList = []; // Accumulateur pour les tags multiples\r\n                    const trkExtensions = trk.getElementsByTagName(\"extensions\");\r\n                    if (trkExtensions.length > 0) {\r\n                        const ext = trkExtensions[0];\r\n                        for (let m = 0; m < ext.childNodes.length; m++) {\r\n                            const child = ext.childNodes[m];\r\n                            if (child.nodeType !== 1) continue;\r\n\r\n                            const tagName = child.tagName || child.nodeName || '';\r\n                            const localName = child.localName || tagName.split(':').pop();\r\n\r\n                            const isGeoLeaf = tagName.toLowerCase().startsWith(\"geoleaf:\") ||\r\n                                (child.namespaceURI && child.namespaceURI.includes(\"geoleaf\"));\r\n\r\n                            if (isGeoLeaf || tagName.includes(':')) {\r\n                                const key = localName || tagName.replace(/^[^:]+:/, '');\r\n                                const value = child.textContent || '';\r\n\r\n                                // Cas sp√©cial : les tags sont accumul√©s dans un tableau\r\n                                if (key === 'tag' || key === 'tags') {\r\n                                    if (value) trkTagsList.push(value);\r\n                                } else {\r\n                                    trkGeoLeafExt[key] = value;\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    // Ajouter les tags comme tableau si pr√©sents\r\n                    if (trkTagsList.length > 0) {\r\n                        trkGeoLeafExt.tags = trkTagsList;\r\n                    }\r\n\r\n                    const segments = trk.getElementsByTagName(\"trkseg\");\r\n                    for (let j = 0; j < segments.length; j++) {\r\n                        const segment = segments[j];\r\n                        const trkpts = segment.getElementsByTagName(\"trkpt\");\r\n\r\n                        const coordinates = [];\r\n                        for (let k = 0; k < trkpts.length; k++) {\r\n                            const trkpt = trkpts[k];\r\n                            const lat = parseFloat(trkpt.getAttribute(\"lat\"));\r\n                            const lon = parseFloat(trkpt.getAttribute(\"lon\"));\r\n\r\n                            if (!isNaN(lat) && !isNaN(lon)) {\r\n                                coordinates.push([lon, lat]);\r\n                            }\r\n                        }\r\n\r\n                        if (coordinates.length > 0) {\r\n                            const feature = {\r\n                                type: \"Feature\",\r\n                                id: nameElem ? `${nameElem.textContent}-${j}` : `trk-${i}-${j}`,\r\n                                geometry: {\r\n                                    type: \"LineString\",\r\n                                    coordinates: coordinates\r\n                                },\r\n                                properties: {\r\n                                    id: nameElem ? `${nameElem.textContent}-${j}` : `trk-${i}-${j}`,\r\n                                    title: nameElem ? nameElem.textContent : `Track ${i + 1}`,\r\n                                    description: descElem ? descElem.textContent : \"\",\r\n                                    segmentIndex: j,\r\n                                    pointCount: coordinates.length,\r\n                                    ...trkGeoLeafExt // Inclure les extensions GeoLeaf du track\r\n                                }\r\n                            };\r\n\r\n                            features.push(feature);\r\n                        }\r\n                    }\r\n                }\r\n\r\n                Log.debug(\"[DataConverter.convertGpxToGeoJSON] Converti\", {\r\n                    waypoints: waypoints.length,\r\n                    tracks: tracks.length,\r\n                    features: features.length\r\n                });\r\n\r\n                return {\r\n                    type: \"FeatureCollection\",\r\n                    features: features\r\n                };\r\n            } catch (err) {\r\n                Log.error(\"[DataConverter.convertGpxToGeoJSON] Erreur lors du parsing GPX:\", err);\r\n                return {\r\n                    type: \"FeatureCollection\",\r\n                    features: []\r\n                };\r\n            }\r\n        },\r\n\r\n        /**\r\n         * D√©tecte automatiquement le type de donn√©es et les convertit en GeoJSON.\r\n         *\r\n         * Strat√©gie de d√©tection :\r\n         * 1. Si d√©j√† GeoJSON (type: \"FeatureCollection\"), retourner tel quel\r\n         * 2. Si array : analyser le premier √©l√©ment\r\n         *    - S'il a \"latlng\" ou \"location\" ‚Üí POI\r\n         *    - S'il a \"geometry.type === 'LineString'\" ‚Üí Route\r\n         *    - S'il a \"geometry.type === 'Polygon'\" ‚Üí Zone\r\n         * 3. Sinon : retourner vide\r\n         *\r\n         * @param {*} data - Donn√©es √† convertir\r\n         * @returns {Object} FeatureCollection GeoJSON\r\n         */\r\n        autoConvert(data) {\r\n            if (!data) {\r\n                Log.warn(\"[DataConverter.autoConvert] Donn√©es nulles, retour FeatureCollection vide\");\r\n                return {\r\n                    type: \"FeatureCollection\",\r\n                    features: []\r\n                };\r\n            }\r\n\r\n            // Cas 1 : D√©j√† GeoJSON\r\n            if (data.type === \"FeatureCollection\" && Array.isArray(data.features)) {\r\n                Log.debug(\"[DataConverter.autoConvert] Donn√©es d√©j√† en GeoJSON, passage direct\");\r\n                return data;\r\n            }\r\n\r\n            if (data.type === \"Feature\" && data.geometry) {\r\n                Log.debug(\"[DataConverter.autoConvert] Feature unique, conversion en FeatureCollection\");\r\n                return {\r\n                    type: \"FeatureCollection\",\r\n                    features: [data]\r\n                };\r\n            }\r\n\r\n            // Cas 2 : Array\r\n            if (!Array.isArray(data) || data.length === 0) {\r\n                Log.warn(\"[DataConverter.autoConvert] Donn√©es ne sont pas un array ou array vide\");\r\n                return {\r\n                    type: \"FeatureCollection\",\r\n                    features: []\r\n                };\r\n            }\r\n\r\n            const firstItem = data[0];\r\n\r\n            if (!firstItem || typeof firstItem !== \"object\") {\r\n                Log.warn(\"[DataConverter.autoConvert] Premier √©l√©ment invalide\");\r\n                return {\r\n                    type: \"FeatureCollection\",\r\n                    features: []\r\n                };\r\n            }\r\n\r\n            // Analyser le type\r\n            if (firstItem.latlng || (firstItem.location && typeof firstItem.location.lat === \"number\")) {\r\n                // POI\r\n                Log.debug(\"[DataConverter.autoConvert] D√©tect√© comme array de POI\");\r\n                return this.convertPoiArrayToGeoJSON(data);\r\n            } else if (\r\n                firstItem.geometry &&\r\n                firstItem.geometry.type === \"LineString\" &&\r\n                Array.isArray(firstItem.geometry.coordinates)\r\n            ) {\r\n                // Route\r\n                Log.debug(\"[DataConverter.autoConvert] D√©tect√© comme array de routes\");\r\n                return this.convertRouteArrayToGeoJSON(data);\r\n            } else if (\r\n                firstItem.geometry &&\r\n                firstItem.geometry.type === \"Polygon\" &&\r\n                Array.isArray(firstItem.geometry.coordinates)\r\n            ) {\r\n                // Zone\r\n                Log.debug(\"[DataConverter.autoConvert] D√©tect√© comme array de zones\");\r\n                return this.convertZoneArrayToGeoJSON(data);\r\n            } else {\r\n                Log.warn(\"[DataConverter.autoConvert] Type de donn√©es non reconnu\");\r\n                return {\r\n                    type: \"FeatureCollection\",\r\n                    features: []\r\n                };\r\n            }\r\n        }\r\n    };\r\n\r\n    // Exposition de l'API\r\n    GeoLeaf._DataConverter = DataConverterModule;\r\n})(typeof window !== \"undefined\" ? window : global);\r\n","/*!\r\n * GeoLeaf Core ‚Äì Config / Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    /**\r\n     * Namespace global GeoLeaf\r\n     */\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n\r\n    /**\r\n     * Logger unifi√© (d√©fini par geoleaf.logger-shim.js charg√© en premier)\r\n     */\r\n    const Log = GeoLeaf.Log;\r\n\r\n    /**\r\n     * Module GeoLeaf.Config\r\n     *\r\n     * R√¥le :\r\n     * - Centraliser la configuration de GeoLeaf (options carte, basemaps, th√®mes, etc.)\r\n     * - Charger une configuration depuis un objet JS ou un fichier JSON externe (fetch)\r\n     * - Fournir des helpers pour lire / √©crire via chemins de type \"map.center\" ou \"basemaps.street.url\"\r\n     * - G√©rer les profils m√©tiers (tourism, etc.) et leurs ressources associ√©es\r\n     *\r\n     * Architecture Phase 4 :\r\n     * - config/loader.js       : Chargement HTTP, fetch, validation CSRF\r\n     * - config/taxonomy.js     : Gestion taxonomie (cat√©gories/sous-cat√©gories)\r\n     * - config/storage.js      : get/set/merge config, helpers paths\r\n     * - config/normalization.js: Normalisation POI (mapping brut‚ÜíGeoLeaf)\r\n     * - config/profile.js      : Gestion profils m√©tier (profile.json, poi.json, routes.json)\r\n     */\r\n    const Config = GeoLeaf.Config = GeoLeaf.Config || {};\r\n\r\n    /* ------------------------------------------------------------------ */\r\n    /*  Module-level state                                                 */\r\n    /* ------------------------------------------------------------------ */\r\n\r\n    /**\r\n     * Configuration interne consolid√©e\r\n     * @type {Object}\r\n     * @private\r\n     */\r\n    Config._config = {};\r\n\r\n    /**\r\n     * Indicateur de chargement\r\n     * @type {boolean}\r\n     * @private\r\n     */\r\n    Config._isLoaded = false;\r\n\r\n    /**\r\n     * Source de la configuration (\"inline\", \"url\", null)\r\n     * @type {string|null}\r\n     * @private\r\n     */\r\n    Config._source = null;\r\n\r\n    /**\r\n     * Options internes\r\n     * @type {{autoEvent: boolean}}\r\n     * @private\r\n     */\r\n    Config._options = {\r\n        /**\r\n         * Si true, √©met un √©v√©nement DOM \"geoleaf:config:loaded\" apr√®s chargement.\r\n         */\r\n        autoEvent: true\r\n    };\r\n\r\n    /* ------------------------------------------------------------------ */\r\n    /*  Core methods                                                       */\r\n    /* ------------------------------------------------------------------ */\r\n\r\n    /**\r\n     * Initialisation du module de configuration.\r\n     *\r\n     * @param {Object} [options]\r\n     * @param {Object} [options.config] - Objet de configuration fourni directement.\r\n     * @param {string} [options.url] - URL d'un fichier JSON √† charger.\r\n     * @param {Object} [options.headers] - Headers HTTP personnalis√©s pour loadUrl (ex: CSRF token).\r\n     * @param {boolean} [options.strictContentType=true] - Validation stricte du Content-Type.\r\n     * @param {boolean} [options.autoEvent] - D√©sactiver ou non l'√©v√©nement auto.\r\n     * @param {Function} [options.onLoaded] - Callback appel√© une fois la config disponible (apr√®s mapping).\r\n     *\r\n     * @param {Object}  [options.mappingHeaders]\r\n     *        Headers HTTP sp√©cifiques pour le mapping (sinon ceux de headers sont r√©utilis√©s).\r\n     * @param {boolean} [options.mappingStrictContentType]\r\n     *        Si d√©fini, surcharge strictContentType pour le mapping.\r\n     *\r\n     * @returns {Promise<Object>} - Promesse r√©solue avec l'objet de configuration.\r\n     */\r\n    Config.init = function (options = {}) {\r\n        this._options = Object.assign({}, this._options, {\r\n            autoEvent:\r\n                typeof options.autoEvent === \"boolean\"\r\n                    ? options.autoEvent\r\n                    : this._options.autoEvent\r\n        });\r\n\r\n        // Cas 1 : configuration inline (objet JS directement fourni)\r\n        if (options.config && typeof options.config === \"object\") {\r\n            this._applyConfig(options.config, \"inline\");\r\n\r\n            // Si un profileId est sp√©cifi√©, le mettre √† jour apr√®s l'application de la config\r\n            if (typeof options.profileId === \"string\" && options.profileId.length > 0) {\r\n                if (!this._config.data) {\r\n                    this._config.data = {};\r\n                }\r\n                this._config.data.activeProfile = options.profileId;\r\n                Log.info(\"[GeoLeaf.Config] Profil actif chang√© vers:\", options.profileId);\r\n            }\r\n\r\n            this._maybeFireLoadedEvent();\r\n\r\n            if (typeof options.onLoaded === \"function\") {\r\n                try {\r\n                    options.onLoaded(this._config);\r\n                } catch (e) {\r\n                    Log.error(\"[GeoLeaf.Config] Erreur dans onLoaded (inline) :\", e);\r\n                }\r\n            }\r\n\r\n            return Promise.resolve(this._config);\r\n        }\r\n\r\n        // Cas 2 : chargement via URL JSON\r\n        if (typeof options.url === \"string\" && options.url.length > 0) {\r\n            const loadOptions = {\r\n                headers: options.headers,\r\n                strictContentType:\r\n                    typeof options.strictContentType === \"boolean\"\r\n                        ? options.strictContentType\r\n                        : true\r\n            };\r\n\r\n            const mappingUrl =\r\n                typeof options.mappingUrl === \"string\" && options.mappingUrl.length > 0\r\n                    ? options.mappingUrl\r\n                    : null;\r\n\r\n            const mappingOptions = {\r\n                headers: options.mappingHeaders || options.headers,\r\n                strictContentType:\r\n                    typeof options.mappingStrictContentType === \"boolean\"\r\n                        ? options.mappingStrictContentType\r\n                        : loadOptions.strictContentType\r\n            };\r\n\r\n            // 1) Charger la config principale\r\n            return this.loadUrl(options.url, loadOptions)\r\n                .then((cfg) => {\r\n                    // Appliquer le profileId APR√àS le chargement de l'URL\r\n                    if (typeof options.profileId === \"string\" && options.profileId.length > 0) {\r\n                        if (!cfg.data) {\r\n                            cfg.data = {};\r\n                        }\r\n                        cfg.data.activeProfile = options.profileId;\r\n                        this._config.data.activeProfile = options.profileId;\r\n                        Log.info(\"[GeoLeaf.Config] Profil actif chang√© vers:\", options.profileId);\r\n                    }\r\n                    return cfg;\r\n                })\r\n                // 2) Charger le mapping cat√©gories (si URL fournie)\r\n                .then((cfg) => {\r\n                    if (!mappingUrl) {\r\n                        return cfg;\r\n                    }\r\n\r\n                    return this.loadTaxonomy(mappingUrl, mappingOptions)\r\n                        .then(() => cfg)\r\n                        .catch((err) => {\r\n                            Log.warn(\r\n                                \"[GeoLeaf.Config] √âchec du chargement du mapping cat√©gories depuis \" +\r\n                                mappingUrl +\r\n                                \" (GeoLeaf continuera sans mapping d√©di√©) :\",\r\n                                err\r\n                            );\r\n                            return cfg;\r\n                        });\r\n                })\r\n                // 3) Appeler onLoaded une fois TOUT charg√© (config + mapping)\r\n                .then((cfg) => {\r\n                    if (typeof options.onLoaded === \"function\") {\r\n                        try {\r\n                            options.onLoaded(cfg);\r\n                        } catch (e) {\r\n                            Log.error(\"[GeoLeaf.Config] Erreur dans onLoaded (url+mapping) :\", e);\r\n                        }\r\n                    }\r\n                    return cfg;\r\n                })\r\n                .catch((err) => {\r\n                    Log.error(\"[GeoLeaf.Config] Erreur init() avec url :\", err);\r\n\r\n                    // Appeler onError si fourni\r\n                    if (typeof options.onError === \"function\") {\r\n                        try {\r\n                            options.onError(err);\r\n                        } catch (e) {\r\n                            Log.error(\"[GeoLeaf.Config] Erreur dans onError :\", e);\r\n                        }\r\n                    }\r\n\r\n                    throw err; // Re-throw pour que la Promise soit rejet√©e\r\n                });\r\n        }\r\n\r\n        // Cas 3 : Aucun param√®tre fourni : on se contente d'un objet vide\r\n        this._applyConfig({}, \"inline\");\r\n\r\n        // Si un profileId est sp√©cifi√©, le mettre √† jour\r\n        if (typeof options.profileId === \"string\" && options.profileId.length > 0) {\r\n            if (!this._config.data) {\r\n                this._config.data = {};\r\n            }\r\n            this._config.data.activeProfile = options.profileId;\r\n            Log.info(\"[GeoLeaf.Config] Profil actif chang√© vers:\", options.profileId);\r\n        }\r\n\r\n        this._maybeFireLoadedEvent();\r\n\r\n        if (typeof options.onLoaded === \"function\") {\r\n            try {\r\n                options.onLoaded(this._config);\r\n            } catch (e) {\r\n                Log.error(\"[GeoLeaf.Config] Erreur dans onLoaded (vide) :\", e);\r\n            }\r\n        }\r\n\r\n        return Promise.resolve(this._config);\r\n    };\r\n\r\n    /**\r\n     * Initialise les sous-modules avec la r√©f√©rence partag√©e √† la config.\r\n     *\r\n     * @private\r\n     */\r\n    Config._initSubModules = function () {\r\n        const Storage = GeoLeaf._ConfigStorage;\r\n        const Taxonomy = GeoLeaf._ConfigTaxonomy;\r\n        const Profile = GeoLeaf._ConfigProfile;\r\n\r\n        if (Storage && typeof Storage.init === \"function\") {\r\n            Storage.init(this._config);\r\n        }\r\n        if (Taxonomy && typeof Taxonomy.init === \"function\") {\r\n            Taxonomy.init(this._config);\r\n        }\r\n        if (Profile && typeof Profile.init === \"function\") {\r\n            Profile.init(this._config);\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Applique une configuration brute (remplace la pr√©c√©dente de mani√®re fusionn√©e).\r\n     *\r\n     * @param {Object} cfg\r\n     * @param {string} source\r\n     * @private\r\n     */\r\n    Config._applyConfig = function (cfg, source) {\r\n        if (typeof cfg !== \"object\" || cfg === null) {\r\n            cfg = {};\r\n        }\r\n\r\n        // Validation de la structure du JSON\r\n        this._validateConfig(cfg);\r\n\r\n        // Fusion profonde avec la configuration existante\r\n        const Storage = GeoLeaf._ConfigStorage;\r\n        if (Storage && typeof Storage.deepMerge === \"function\") {\r\n            this._config = Storage.deepMerge(this._config, cfg);\r\n        } else {\r\n            this._config = Object.assign({}, this._config, cfg);\r\n        }\r\n\r\n        // Normalisation des POI (avis) apr√®s fusion\r\n        const Normalization = GeoLeaf._ConfigNormalization;\r\n        if (Array.isArray(this._config.poi) && Normalization) {\r\n            this._config.poi = Normalization.normalizePoiArray(this._config.poi);\r\n        }\r\n\r\n        this._isLoaded = true;\r\n        this._source = source || \"inline\";\r\n\r\n        // Initialiser les sous-modules maintenant que _config est charg√©\r\n        this._initSubModules();\r\n\r\n        try {\r\n            // On r√©cup√®re le bloc \"logging\" soit depuis le cfg brut, soit depuis la configuration consolid√©e\r\n            const loggingCfg =\r\n                (cfg && typeof cfg === \"object\" && cfg.logging)\r\n                    ? cfg.logging\r\n                    : (this._config && this._config.logging ? this._config.logging : null);\r\n\r\n            // Prise en compte du flag global debug\r\n            let level = loggingCfg && loggingCfg.level;\r\n            let debugFlag = false;\r\n            if ((cfg && typeof cfg.debug !== 'undefined')) {\r\n                debugFlag = !!cfg.debug;\r\n            } else if (this._config && typeof this._config.debug !== 'undefined') {\r\n                debugFlag = !!this._config.debug;\r\n            }\r\n\r\n            if (!level) {\r\n                level = debugFlag ? 'debug' : 'info';\r\n            }\r\n\r\n            if (level && GeoLeaf.Log && typeof GeoLeaf.Log.setLevel === \"function\") {\r\n                GeoLeaf.Log.setLevel(level);\r\n                Log.info(\"[GeoLeaf.Config] Niveau de log appliqu√© depuis la configuration :\", level, \"(debug:\", debugFlag, \")\");\r\n            }\r\n        } catch (e) {\r\n            Log.warn(\"[GeoLeaf.Config] Impossible d'appliquer le niveau de log depuis la configuration :\", e);\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Indique si la configuration est consid√©r√©e comme \"charg√©e\".\r\n     *\r\n     * @returns {boolean}\r\n     */\r\n    Config.isLoaded = function () {\r\n        return this._isLoaded;\r\n    };\r\n\r\n    /**\r\n     * Retourne la source de la config (\"inline\", \"url\", null).\r\n     *\r\n     * @returns {string|null}\r\n     */\r\n    Config.getSource = function () {\r\n        return this._source;\r\n    };\r\n\r\n    /**\r\n     * Envoie un √©v√©nement DOM \"geoleaf:config:loaded\" si autoEvent = true.\r\n     *\r\n     * @private\r\n     */\r\n    Config._maybeFireLoadedEvent = function () {\r\n        if (!this._options.autoEvent) {\r\n            return;\r\n        }\r\n\r\n        if (typeof document === \"undefined\" || typeof document.dispatchEvent !== \"function\") {\r\n            return;\r\n        }\r\n\r\n        try {\r\n            const event = new CustomEvent(\"geoleaf:config:loaded\", {\r\n                detail: {\r\n                    config: this._config,\r\n                    source: this._source\r\n                }\r\n            });\r\n            document.dispatchEvent(event);\r\n        } catch (e) {\r\n            // En environnement tr√®s ancien, CustomEvent peut ne pas exister\r\n            try {\r\n                const legacyEvent = document.createEvent(\"CustomEvent\");\r\n                legacyEvent.initCustomEvent(\r\n                    \"geoleaf:config:loaded\",\r\n                    false,\r\n                    false,\r\n                    {\r\n                        config: this._config,\r\n                        source: this._source\r\n                    }\r\n                );\r\n                document.dispatchEvent(legacyEvent);\r\n            } catch (err) {\r\n                // On ne bloque pas le fonctionnement si l'√©v√©nement √©choue\r\n                Log.warn(\"[GeoLeaf.Config] Impossible d'√©mettre l'√©v√©nement geoleaf:config:loaded.\");\r\n            }\r\n        }\r\n    };\r\n\r\n})(window);\r\n","/*!\r\n * GeoLeaf Core ‚Äì Config / Validation\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = global.GeoLeaf;\r\n    const Log = GeoLeaf.Log;\r\n    const Config = GeoLeaf.Config;\r\n\r\n    /**\r\n     * Valide la structure du JSON de configuration.\r\n     * Lance une erreur si les donn√©es critiques sont invalides.\r\n     *\r\n     * @param {Object} cfg - Configuration √† valider\r\n     * @throws {Error} Si la structure est invalide\r\n     * @private\r\n     */\r\n    Config._validateConfig = function (cfg) {\r\n        if (!cfg || typeof cfg !== \"object\") {\r\n            return; // Pas de validation si vide\r\n        }\r\n\r\n        // Validation de map.center\r\n        if (cfg.map && cfg.map.center !== undefined) {\r\n            if (\r\n                !Array.isArray(cfg.map.center) ||\r\n                cfg.map.center.length !== 2 ||\r\n                typeof cfg.map.center[0] !== \"number\" ||\r\n                typeof cfg.map.center[1] !== \"number\"\r\n            ) {\r\n                throw new Error(\r\n                    \"[GeoLeaf.Config] map.center doit √™tre un tableau de 2 nombres [lat, lng].\"\r\n                );\r\n            }\r\n        }\r\n\r\n        // Validation de map.zoom\r\n        if (cfg.map && cfg.map.zoom !== undefined) {\r\n            if (typeof cfg.map.zoom !== \"number\" || cfg.map.zoom < 0 || cfg.map.zoom > 20) {\r\n                throw new Error(\r\n                    \"[GeoLeaf.Config] map.zoom doit √™tre un nombre entre 0 et 20.\"\r\n                );\r\n            }\r\n        }\r\n\r\n        // Validation de basemaps\r\n        if (cfg.basemaps !== undefined) {\r\n            if (typeof cfg.basemaps !== \"object\" || cfg.basemaps === null) {\r\n                throw new Error(\r\n                    \"[GeoLeaf.Config] basemaps doit √™tre un objet.\"\r\n                );\r\n            }\r\n        }\r\n\r\n        // Validation de poi\r\n        if (cfg.poi !== undefined) {\r\n            if (!Array.isArray(cfg.poi)) {\r\n                throw new Error(\r\n                    \"[GeoLeaf.Config] poi doit √™tre un tableau.\"\r\n                );\r\n            }\r\n        }\r\n\r\n        // Validation de geojson\r\n        if (cfg.geojson !== undefined) {\r\n            if (!Array.isArray(cfg.geojson)) {\r\n                throw new Error(\r\n                    \"[GeoLeaf.Config] geojson doit √™tre un tableau.\"\r\n                );\r\n            }\r\n        }\r\n\r\n        // Validation de categories\r\n        if (cfg.categories !== undefined) {\r\n            if (\r\n                typeof cfg.categories !== \"object\" ||\r\n                cfg.categories === null ||\r\n                Array.isArray(cfg.categories)\r\n            ) {\r\n                throw new Error(\r\n                    \"[GeoLeaf.Config] categories doit √™tre un objet.\"\r\n                );\r\n            }\r\n\r\n            // Valider chaque cat√©gorie\r\n            Object.entries(cfg.categories).forEach(([catId, catData]) => {\r\n                if (!catData || typeof catData !== \"object\") {\r\n                    Log.warn(\r\n                        `[GeoLeaf.Config] Cat√©gorie '${catId}' invalide (doit √™tre un objet).`\r\n                    );\r\n                    return;\r\n                }\r\n\r\n                if (!catData.label || typeof catData.label !== \"string\") {\r\n                    Log.warn(\r\n                        `[GeoLeaf.Config] Cat√©gorie '${catId}' : le champ 'label' est manquant ou invalide.`\r\n                    );\r\n                }\r\n\r\n                // Validation couleurs : accepter soit 'color' (ancien format), soit 'colorFill'/'colorStroke' (nouveau format)\r\n                const hasOldFormat = catData.color && typeof catData.color === \"string\";\r\n                const hasNewFormat =\r\n                    (catData.colorFill && typeof catData.colorFill === \"string\") ||\r\n                    (catData.colorStroke && typeof catData.colorStroke === \"string\");\r\n\r\n                if (!hasOldFormat && !hasNewFormat) {\r\n                    Log.warn(\r\n                        `[GeoLeaf.Config] Cat√©gorie '${catId}' : aucune couleur d√©finie (ni 'color', ni 'colorFill'/'colorStroke').`\r\n                    );\r\n                }\r\n\r\n                // Valider les sous-cat√©gories\r\n                if (catData.subcategories !== undefined) {\r\n                    if (\r\n                        typeof catData.subcategories !== \"object\" ||\r\n                        catData.subcategories === null ||\r\n                        Array.isArray(catData.subcategories)\r\n                    ) {\r\n                        Log.warn(\r\n                            `[GeoLeaf.Config] Cat√©gorie '${catId}' : subcategories doit √™tre un objet.`\r\n                        );\r\n                        return;\r\n                    }\r\n\r\n                    Object.entries(catData.subcategories).forEach(([subId, subData]) => {\r\n                        if (!subData || typeof subData !== \"object\") {\r\n                            Log.warn(\r\n                                `[GeoLeaf.Config] Sous-cat√©gorie '${subId}' dans '${catId}' invalide (doit √™tre un objet).`\r\n                            );\r\n                            return;\r\n                        }\r\n\r\n                        if (!subData.label || typeof subData.label !== \"string\") {\r\n                            Log.warn(\r\n                                `[GeoLeaf.Config] Sous-cat√©gorie '${subId}' dans '${catId}' : le champ 'label' est manquant ou invalide.`\r\n                            );\r\n                        }\r\n\r\n                        const hasOldFormatSub =\r\n                            subData.color && typeof subData.color === \"string\";\r\n                        const hasNewFormatSub =\r\n                            (subData.colorFill && typeof subData.colorFill === \"string\") ||\r\n                            (subData.colorStroke && typeof subData.colorStroke === \"string\");\r\n\r\n                        if (!hasOldFormatSub && !hasNewFormatSub) {\r\n                            Log.warn(\r\n                                `[GeoLeaf.Config] Sous-cat√©gorie '${subId}' dans '${catId}' : aucune couleur d√©finie (ni 'color', ni 'colorFill'/'colorStroke').`\r\n                            );\r\n                        }\r\n                    });\r\n                }\r\n            });\r\n        }\r\n\r\n        Log.debug(\"[GeoLeaf.Config] Validation de la structure r√©ussie.\");\r\n    };\r\n\r\n})(window);\r\n","/*!\r\n * GeoLeaf Core ‚Äì Config / Loaders\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = global.GeoLeaf;\r\n    const Log = GeoLeaf.Log;\r\n    const Config = GeoLeaf.Config;\r\n\r\n    /**\r\n     * Charge une configuration depuis une URL JSON et la fusionne.\r\n     *\r\n     * @param {string} url - URL du fichier JSON\r\n     * @param {Object} [options] - Options de chargement\r\n     * @param {Object} [options.headers] - Headers HTTP personnalis√©s (ex: CSRF token)\r\n     * @param {boolean} [options.strictContentType=true] - Validation stricte du Content-Type\r\n     * @returns {Promise<Object>}\r\n     * @example\r\n     * Config.loadUrl('/api/config.json', {\r\n     *     headers: { 'X-CSRF-Token': '...' },\r\n     *     strictContentType: true\r\n     * })\r\n     */\r\n    Config.loadUrl = function (url, options = {}) {\r\n        const Loader = GeoLeaf._ConfigLoader;\r\n        if (!Loader) {\r\n            Log.error(\"[GeoLeaf.Config] Module Loader non disponible.\");\r\n            return Promise.reject(new Error(\"Loader module not available\"));\r\n        }\r\n\r\n        return Loader.loadUrl(url, options)\r\n            .then((jsonCfg) => {\r\n                // Validation de la structure du JSON\r\n                this._validateConfig(jsonCfg);\r\n\r\n                // Fusion profonde avec la configuration existante\r\n                const Storage = GeoLeaf._ConfigStorage;\r\n                if (Storage && typeof Storage.deepMerge === \"function\") {\r\n                    this._config = Storage.deepMerge(this._config, jsonCfg);\r\n                } else {\r\n                    // Fallback si Storage pas disponible\r\n                    this._config = Object.assign({}, this._config, jsonCfg);\r\n                }\r\n\r\n                // Normalisation des POI (avis) √©ventuels dans la config\r\n                const Normalization = GeoLeaf._ConfigNormalization;\r\n                if (Array.isArray(this._config.poi) && Normalization) {\r\n                    this._config.poi = Normalization.normalizePoiArray(this._config.poi);\r\n                }\r\n\r\n                this._isLoaded = true;\r\n                this._source = \"url\";\r\n\r\n                // Initialiser les sous-modules maintenant que _config est charg√©\r\n                this._initSubModules();\r\n\r\n                this._maybeFireLoadedEvent();\r\n\r\n                return this._config;\r\n            })\r\n            .catch((err) => {\r\n                Log.error(\"[GeoLeaf.Config] Erreur lors du chargement JSON :\", err);\r\n                return this._config;\r\n            });\r\n    };\r\n\r\n    /**\r\n     * Charge un fichier de taxonomie (mapping cat√©gories / sous-cat√©gories)\r\n     * et le fusionne dans la configuration existante.\r\n     *\r\n     * @param {string} [url] - URL du fichier de mapping (depuis le profil)\r\n     * @param {Object} [options]\r\n     * @param {Object} [options.headers]\r\n     * @param {boolean} [options.strictContentType=true]\r\n     * @returns {Promise<Object>} - Objet categories consolid√©\r\n     */\r\n    Config.loadTaxonomy = function (url = null, options = {}) {\r\n        const Taxonomy = GeoLeaf._ConfigTaxonomy;\r\n        if (!Taxonomy) {\r\n            Log.error(\"[GeoLeaf.Config] Module Taxonomy non disponible.\");\r\n            return Promise.reject(new Error(\"Taxonomy module not available\"));\r\n        }\r\n\r\n        return Taxonomy.loadTaxonomy(url, options);\r\n    };\r\n\r\n    /**\r\n     * Charge les ressources li√©es au profil actif :\r\n     * - profile.json\r\n     * - poi.json\r\n     * - mapping.json\r\n     * - routes.json\r\n     *\r\n     * @param {Object} [options]\r\n     * @param {Object} [options.headers] - Headers HTTP optionnels.\r\n     * @param {boolean} [options.strictContentType=true] - Validation stricte du Content-Type.\r\n     * @returns {Promise<Object>} Configuration consolid√©e incluant les donn√©es du profil.\r\n     */\r\n    Config.loadActiveProfileResources = function (options = {}) {\r\n        const Profile = GeoLeaf._ConfigProfile;\r\n        if (!Profile) {\r\n            Log.error(\"[GeoLeaf.Config] Module Profile non disponible.\");\r\n            return Promise.reject(new Error(\"Profile module not available\"));\r\n        }\r\n\r\n        return Profile.loadActiveProfileResources(options);\r\n    };\r\n\r\n})(window);\r\n","/*!\r\n * GeoLeaf Core ‚Äì Config / Accessors\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = global.GeoLeaf;\r\n    const Log = GeoLeaf.Log;\r\n    const Config = GeoLeaf.Config;\r\n\r\n    /* ------------------------------------------------------------------ */\r\n    /*  Storage accessors                                                  */\r\n    /* ------------------------------------------------------------------ */\r\n\r\n    /**\r\n     * Retourne la configuration compl√®te (objet).\r\n     *\r\n     * @returns {Object}\r\n     */\r\n    Config.getAll = function () {\r\n        // S'assurer que les sous-modules sont initialis√©s\r\n        if (!this._isLoaded) {\r\n            this._initSubModules();\r\n        }\r\n\r\n        const Storage = GeoLeaf._ConfigStorage;\r\n        return Storage && typeof Storage.getAll === \"function\"\r\n            ? Storage.getAll()\r\n            : this._config;\r\n    };\r\n\r\n    /**\r\n     * R√©cup√®re une valeur via un chemin de type \"map.center\" ou \"basemaps.street.url\".\r\n     *\r\n     * @param {string} path - Chemin avec des points.\r\n     * @param {*} [defaultValue] - Valeur renvoy√©e si le chemin n'existe pas.\r\n     * @returns {*}\r\n     */\r\n    Config.get = function (path, defaultValue) {\r\n        // S'assurer que les sous-modules sont initialis√©s\r\n        if (!this._isLoaded) {\r\n            this._initSubModules();\r\n        }\r\n\r\n        const Storage = GeoLeaf._ConfigStorage;\r\n        return Storage && typeof Storage.get === \"function\"\r\n            ? Storage.get(path, defaultValue)\r\n            : defaultValue;\r\n    };\r\n\r\n    /**\r\n     * D√©finit une valeur via un chemin de type \"map.center\" ou \"basemaps.street.url\".\r\n     * Cr√©e les objets interm√©diaires si n√©cessaire.\r\n     *\r\n     * @param {string} path\r\n     * @param {*} value\r\n     */\r\n    Config.set = function (path, value) {\r\n        const Storage = GeoLeaf._ConfigStorage;\r\n        if (Storage && typeof Storage.set === \"function\") {\r\n            Storage.set(path, value);\r\n        } else {\r\n            Log.warn(\"[GeoLeaf.Config] Module Storage non disponible pour set().\");\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Retourne une section de configuration (ex : \"basemaps\", \"map\").\r\n     *\r\n     * @param {string} sectionName\r\n     * @param {Object} [defaultValue]\r\n     * @returns {Object|*}\r\n     */\r\n    Config.getSection = function (sectionName, defaultValue) {\r\n        const Storage = GeoLeaf._ConfigStorage;\r\n        return Storage && typeof Storage.getSection === \"function\"\r\n            ? Storage.getSection(sectionName, defaultValue)\r\n            : defaultValue;\r\n    };\r\n\r\n    /* ------------------------------------------------------------------ */\r\n    /*  Taxonomy accessors                                                 */\r\n    /* ------------------------------------------------------------------ */\r\n\r\n    /**\r\n     * Retourne l'objet complet des cat√©gories (mapping interne).\r\n     *\r\n     * @returns {Object} - { [categoryId]: { label, icon, colorFill, colorStroke, subcategories? } }\r\n     */\r\n    Config.getCategories = function () {\r\n        // S'assurer que les sous-modules sont initialis√©s\r\n        if (!this._isLoaded) {\r\n            this._initSubModules();\r\n        }\r\n\r\n        const Taxonomy = GeoLeaf._ConfigTaxonomy;\r\n        return Taxonomy && typeof Taxonomy.getCategories === \"function\"\r\n            ? Taxonomy.getCategories()\r\n            : {};\r\n    };\r\n\r\n    /**\r\n     * Retourne une cat√©gorie √† partir de son identifiant.\r\n     *\r\n     * @param {string} categoryId\r\n     * @returns {Object|undefined}\r\n     */\r\n    Config.getCategory = function (categoryId) {\r\n        const Taxonomy = GeoLeaf._ConfigTaxonomy;\r\n        return Taxonomy && typeof Taxonomy.getCategory === \"function\"\r\n            ? Taxonomy.getCategory(categoryId)\r\n            : undefined;\r\n    };\r\n\r\n    /**\r\n     * Retourne une sous-cat√©gorie √† partir de son identifiant et de celui\r\n     * de la cat√©gorie parente.\r\n     *\r\n     * @param {string} categoryId\r\n     * @param {string} subCategoryId\r\n     * @returns {Object|undefined}\r\n     */\r\n    Config.getSubcategory = function (categoryId, subCategoryId) {\r\n        const Taxonomy = GeoLeaf._ConfigTaxonomy;\r\n        return Taxonomy && typeof Taxonomy.getSubcategory === \"function\"\r\n            ? Taxonomy.getSubcategory(categoryId, subCategoryId)\r\n            : undefined;\r\n    };\r\n\r\n    /* ------------------------------------------------------------------ */\r\n    /*  Profile accessors                                                  */\r\n    /* ------------------------------------------------------------------ */\r\n\r\n    /**\r\n     * Retourne l'identifiant du profil actuellement charg√© (ou null).\r\n     *\r\n     * @returns {string|null}\r\n     */\r\n    Config.getActiveProfileId = function () {\r\n        const Profile = GeoLeaf._ConfigProfile;\r\n        return Profile && typeof Profile.getActiveProfileId === \"function\"\r\n            ? Profile.getActiveProfileId()\r\n            : null;\r\n    };\r\n\r\n    /**\r\n     * Retourne l'objet profile.json du profil actif (ou null).\r\n     *\r\n     * @returns {Object|null}\r\n     */\r\n    Config.getActiveProfile = function () {\r\n        const Profile = GeoLeaf._ConfigProfile;\r\n        return Profile && typeof Profile.getActiveProfile === \"function\"\r\n            ? Profile.getActiveProfile()\r\n            : null;\r\n    };\r\n\r\n    /**\r\n     * Retourne le tableau de POI normalis√©s du profil actif.\r\n     *\r\n     * @returns {Array}\r\n     */\r\n    Config.getActiveProfilePoi = function () {\r\n        const Profile = GeoLeaf._ConfigProfile;\r\n        return Profile && typeof Profile.getActiveProfilePoi === \"function\"\r\n            ? Profile.getActiveProfilePoi()\r\n            : [];\r\n    };\r\n\r\n    /**\r\n     * Retourne le tableau de routes du profil actif.\r\n     *\r\n     * @returns {Array}\r\n     */\r\n    Config.getActiveProfileRoutes = function () {\r\n        const Profile = GeoLeaf._ConfigProfile;\r\n        return Profile && typeof Profile.getActiveProfileRoutes === \"function\"\r\n            ? Profile.getActiveProfileRoutes()\r\n            : [];\r\n    };\r\n\r\n    /**\r\n     * Retourne l'objet de mapping du profil actif (mapping.json).\r\n     *\r\n     * @returns {Object|null}\r\n     */\r\n    Config.getActiveProfileMapping = function () {\r\n        const Profile = GeoLeaf._ConfigProfile;\r\n        return Profile && typeof Profile.getActiveProfileMapping === \"function\"\r\n            ? Profile.getActiveProfileMapping()\r\n            : null;\r\n    };\r\n\r\n    /**\r\n     * Retourne la configuration des ic√¥nes depuis la taxonomie du profil actif.\r\n     *\r\n     * @returns {Object|null}\r\n     */\r\n    Config.getIconsConfig = function () {\r\n        const Profile = GeoLeaf._ConfigProfile;\r\n        return Profile && typeof Profile.getIconsConfig === \"function\"\r\n            ? Profile.getIconsConfig()\r\n            : null;\r\n    };\r\n\r\n    /**\r\n     * Indique si l'usage de mapping.json pour normaliser les POI de profil est activ√©.\r\n     *\r\n     * @returns {boolean} true si le mapping doit √™tre utilis√©, false sinon.\r\n     */\r\n    Config.isProfilePoiMappingEnabled = function () {\r\n        const Profile = GeoLeaf._ConfigProfile;\r\n        return Profile && typeof Profile.isProfilePoiMappingEnabled === \"function\"\r\n            ? Profile.isProfilePoiMappingEnabled()\r\n            : true;\r\n    };\r\n\r\n})(window);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    // ---------------------------------------------------------\r\n    // Namespace global + logger unifi√© (avec fallback console)\r\n    // ---------------------------------------------------------\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n\r\n    // Logger unifi√© (d√©fini par geoleaf.logger-shim.js charg√© en premier)\r\n    const Log = GeoLeaf.Log;\r\n\r\n    // V√©rification Leaflet\r\n    if (!global.L) {\r\n        Log.error(\"[GeoLeaf.Baselayers] Leaflet (L) est introuvable. Charge d'abord Leaflet 1.9.\");\r\n        return;\r\n    }\r\n\r\n    const L = global.L;\r\n\r\n    const Baselayers = (function () {\r\n        let _map = null;\r\n        let _activeKey = null;\r\n        let _uiBound = false;\r\n        const _baseLayers = Object.create(null);\r\n\r\n        // Fallback : basemaps par d√©faut (100 % utilisables sans cl√©)\r\n        const DEFAULT_BASELAYERS = {\r\n            street: {\r\n                label: \"Street\",\r\n                url: \"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\",\r\n                options: {\r\n                    maxZoom: 19,\r\n                    attribution: \"&copy; OpenStreetMap contributors\"\r\n                }\r\n            },\r\n            topo: {\r\n                label: \"Topo\",\r\n                url: \"https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png\",\r\n                options: {\r\n                    maxZoom: 17,\r\n                    attribution:\r\n                        \"Map data: &copy; OpenStreetMap contributors, SRTM | Map style: &copy; OpenTopoMap\"\r\n                }\r\n            },\r\n            satellite: {\r\n                label: \"Satellite\",\r\n                url: \"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}\",\r\n                options: {\r\n                    maxZoom: 19,\r\n                    attribution:\r\n                        \"Tiles &copy; Esri ‚Äî Source: Esri, Earthstar Geographics, and the GIS user community\"\r\n                }\r\n            }\r\n        };\r\n\r\n        function _ensureMap(explicitMap) {\r\n            if (explicitMap && typeof explicitMap.setView === \"function\") {\r\n                _map = explicitMap;\r\n                Log.info(\"[GeoLeaf.Baselayers] _ensureMap: using explicit map passed to init().\", _map);\r\n                return;\r\n            }\r\n            if (_map && typeof _map.setView === \"function\") {\r\n                return;\r\n            }\r\n            const gl = global.GeoLeaf || {};\r\n            if (gl.Core && typeof gl.Core.getMap === \"function\") {\r\n                const m = gl.Core.getMap();\r\n                if (m && typeof m.setView === \"function\") {\r\n                    _map = m;\r\n                    Log.info(\"[GeoLeaf.Baselayers] _ensureMap: acquired map from GeoLeaf.Core.getMap()\", _map);\r\n                }\r\n            }\r\n        }\r\n\r\n        function _registerDefaultBaseLayers() {\r\n            Object.keys(DEFAULT_BASELAYERS).forEach(function (key) {\r\n                if (!_baseLayers[key]) {\r\n                    registerBaseLayer(key, DEFAULT_BASELAYERS[key]);\r\n                    Log.info(\"[GeoLeaf.Baselayers] _registerDefaultBaseLayers: registered\", key);\r\n                }\r\n            });\r\n        }\r\n\r\n        function _normalizeOptions(definition) {\r\n            const opts = Object.assign({}, definition.options || {});\r\n            // minZoom pour limiter le zoom arri√®re\r\n            if (typeof opts.minZoom !== \"number\") {\r\n                if (typeof definition.minZoom === \"number\") {\r\n                    opts.minZoom = definition.minZoom;\r\n                }\r\n            }\r\n            // maxZoom minimal pour √©viter les warnings \"no maxZoom specified\"\r\n            if (typeof opts.maxZoom !== \"number\") {\r\n                opts.maxZoom = typeof definition.maxZoom === \"number\" ? definition.maxZoom : 19;\r\n            }\r\n            if (!opts.attribution && definition.attribution) {\r\n                opts.attribution = definition.attribution;\r\n            }\r\n            return opts;\r\n        }\r\n\r\n        function registerBaseLayer(key, definition) {\r\n            if (!key) {\r\n                Log.warn(\"[GeoLeaf.Baselayers] registerBaseLayer appel√© sans cl√©.\");\r\n                return;\r\n            }\r\n            if (!definition) {\r\n                Log.warn(\"[GeoLeaf.Baselayers] D√©finition manquante pour la couche :\", key);\r\n                return;\r\n            }\r\n\r\n            // Utiliser definition.id si disponible, sinon la cl√©\r\n            const actualKey = definition.id || key;\r\n            let layerInstance = null;\r\n            const label = definition.label || actualKey;\r\n\r\n            // Cas 1 : on re√ßoit directement une instance de L.TileLayer\r\n            if (definition instanceof L.TileLayer) {\r\n                layerInstance = definition;\r\n            }\r\n            // Cas 2 : on re√ßoit un objet contenant .layer d√©j√† pr√™t\r\n            else if (definition.layer && definition.layer instanceof L.TileLayer) {\r\n                layerInstance = definition.layer;\r\n            }\r\n            // Cas 3 : on re√ßoit une config { url, options, ... } ‚Üí on cr√©e la tileLayer\r\n            else if (definition.url) {\r\n                const options = _normalizeOptions(definition);\r\n                layerInstance = L.tileLayer(definition.url, options);\r\n            } else {\r\n                Log.warn(\r\n                    \"[GeoLeaf.Baselayers] D√©finition invalide pour la couche :\",\r\n                    actualKey,\r\n                    \"(aucune url / aucun layer fourni)\"\r\n                );\r\n                return;\r\n            }\r\n\r\n            _baseLayers[actualKey] = {\r\n                key: actualKey,\r\n                label: label,\r\n                layer: layerInstance\r\n            };\r\n        }\r\n\r\n        function registerBaseLayers(definitions) {\r\n            if (!definitions || typeof definitions !== \"object\") {\r\n                Log.warn(\"[GeoLeaf.Baselayers] registerBaseLayers attend un objet de d√©finitions.\");\r\n                return;\r\n            }\r\n            Object.keys(definitions).forEach(function (key) {\r\n                registerBaseLayer(key, definitions[key]);\r\n            });\r\n        }\r\n\r\n        function _refreshUI() {\r\n            if (!global.document) {\r\n                return;\r\n            }\r\n            const elements = global.document.querySelectorAll(\"[data-gl-baselayer]\");\r\n            const leftPanel = global.document.getElementById('gl-left-panel');\r\n            let activeElement = null;\r\n\r\n            elements.forEach(function (el) {\r\n                const key = el.getAttribute(\"data-gl-baselayer\");\r\n                if (!key) {\r\n                    return;\r\n                }\r\n                const isActive = key === _activeKey;\r\n                if (isActive) {\r\n                    el.classList.add(\"gl-baselayer-active\", \"is-active\");\r\n                    el.setAttribute(\"aria-pressed\", \"true\");\r\n                    activeElement = el;\r\n                } else {\r\n                    el.classList.remove(\"gl-baselayer-active\", \"is-active\");\r\n                    el.setAttribute(\"aria-pressed\", \"false\");\r\n                }\r\n            });\r\n\r\n            // Animer l'indicateur vers le bouton actif\r\n            if (leftPanel && activeElement) {\r\n                _updateActiveIndicator(leftPanel, activeElement);\r\n            }\r\n        }\r\n\r\n        function _updateActiveIndicator(panel, activeButton) {\r\n            if (!panel || !activeButton) {\r\n                return;\r\n            }\r\n\r\n            const panelRect = panel.getBoundingClientRect();\r\n            const buttonRect = activeButton.getBoundingClientRect();\r\n\r\n            // Calculer la position relative du bouton par rapport au panneau\r\n            const left = buttonRect.left - panelRect.left;\r\n            const width = buttonRect.width;\r\n\r\n            // Mettre √† jour la position et la largeur de l'indicateur (::before)\r\n            panel.style.setProperty('--indicator-left', left + 'px');\r\n            panel.style.setProperty('--indicator-width', width + 'px');\r\n        }\r\n\r\n        function _createBaseLayerControlsUI(config) {\r\n            if (!global.document) {\r\n                return;\r\n            }\r\n\r\n            // Si config n'est pas fourni, essayer de le r√©cup√©rer depuis GeoLeaf.Config\r\n            if (!config && global.GeoLeaf && global.GeoLeaf.Config && typeof global.GeoLeaf.Config.get === 'function') {\r\n                config = {\r\n                    ui: global.GeoLeaf.Config.get('ui'),\r\n                    basemaps: global.GeoLeaf.Config.get('basemaps') || {}\r\n                };\r\n            }\r\n\r\n            // V√©rifier si showBaseLayerControls est activ√©\r\n            const showControls = config && config.ui && config.ui.showBaseLayerControls !== false;\r\n\r\n            let leftPanel = global.document.getElementById('gl-left-panel');\r\n\r\n            if (showControls) {\r\n                // Cr√©er le panneau s'il n'existe pas\r\n                if (!leftPanel) {\r\n                    leftPanel = global.document.createElement('div');\r\n                    leftPanel.id = 'gl-left-panel';\r\n                    leftPanel.className = 'gl-left-panel';\r\n\r\n                    // Trouver le conteneur de la carte pour y ins√©rer le panneau\r\n                    const mapContainer = global.document.getElementById('geoleaf-map') ||\r\n                                       global.document.querySelector('.gl-map');\r\n\r\n                    if (mapContainer) {\r\n                        mapContainer.appendChild(leftPanel);\r\n                    } else {\r\n                        // Fallback: ajouter au body\r\n                        global.document.body.appendChild(leftPanel);\r\n                    }\r\n                }\r\n\r\n                // Cr√©er les boutons de s√©lection de fond de carte\r\n                // SAFE: Cha√Æne vide pour nettoyer le contenu avant reconstruction\r\n                GeoLeaf.DOMSecurity.clearElementFast(leftPanel);\r\n\r\n                // Utiliser _baseLayers enregistr√©s plut√¥t que config.basemaps\r\n                // car les basemaps par d√©faut peuvent avoir √©t√© ajout√©s\r\n                Object.keys(_baseLayers).forEach(function(key) {\r\n                    const def = _baseLayers[key];\r\n                    const button = global.document.createElement('button');\r\n                    button.className = 'gl-baselayer-btn';\r\n                    button.setAttribute('data-gl-baselayer', key);\r\n                    button.setAttribute('aria-label', def.label || key);\r\n                    button.textContent = def.label || key;\r\n                    leftPanel.appendChild(button);\r\n                });\r\n                leftPanel.style.display = 'flex';\r\n\r\n                Log.info(\"[GeoLeaf.Baselayers] Contr√¥les de fond de carte cr√©√©s avec\", Object.keys(_baseLayers).length, \"boutons\");\r\n\r\n                // Initialiser la position de l'indicateur apr√®s un court d√©lai\r\n                // pour s'assurer que le DOM est compl√®tement rendu\r\n                setTimeout(function() {\r\n                    _refreshUI();\r\n                }, 50);\r\n            } else {\r\n                // Masquer ou supprimer le panneau si showBaseLayerControls est false\r\n                if (leftPanel) {\r\n                    leftPanel.style.display = 'none';\r\n                }\r\n            }\r\n        }\r\n\r\n        function _bindUIOnce() {\r\n            if (_uiBound || !global.document) {\r\n                return;\r\n            }\r\n            _uiBound = true;\r\n\r\n            // Un seul listener global : tout √©l√©ment avec data-gl-baselayer utilise le m√™me setBaseLayer()\r\n            global.document.addEventListener(\"click\", function (evt) {\r\n                const target = evt.target.closest(\"[data-gl-baselayer]\");\r\n                if (!target) {\r\n                    return;\r\n                }\r\n                const key = target.getAttribute(\"data-gl-baselayer\");\r\n                if (!key) {\r\n                    return;\r\n                }\r\n                evt.preventDefault();\r\n                setBaseLayer(key);\r\n            });\r\n\r\n            // Recalculer la position de l'indicateur lors du redimensionnement de la fen√™tre\r\n            let resizeTimeout;\r\n            global.addEventListener('resize', function() {\r\n                clearTimeout(resizeTimeout);\r\n                resizeTimeout = setTimeout(function() {\r\n                    _refreshUI();\r\n                }, 100);\r\n            });\r\n        }\r\n\r\n        function setBaseLayer(key, options) {\r\n            options = options || {};\r\n\r\n            if (!key) {\r\n                Log.warn(\"[GeoLeaf.Baselayers] setBaseLayer appel√© sans cl√©.\");\r\n                return;\r\n            }\r\n\r\n            const previousKey = _activeKey;\r\n\r\n            _ensureMap();\r\n            Log.info(\r\n                \"[GeoLeaf.Baselayers] setBaseLayer called: key=\",\r\n                key,\r\n                \"_map=\",\r\n                _map ? true : false\r\n            );\r\n            if (!_map) {\r\n                Log.warn(\r\n                    \"[GeoLeaf.Baselayers] Aucun L.Map disponible. Assure-toi que GeoLeaf.Core est initialis√©.\"\r\n                );\r\n                return;\r\n            }\r\n\r\n            if (!_baseLayers[key]) {\r\n                Log.warn(\"[GeoLeaf.Baselayers] Couche inconnue :\", key);\r\n                const keys = Object.keys(_baseLayers);\r\n                if (!previousKey && keys.length > 0) {\r\n                    const fallbackKey = keys[0];\r\n                    if (!options.silent) {\r\n                        Log.warn(\r\n                            \"[GeoLeaf.Baselayers] Bascule vers la premi√®re couche disponible :\",\r\n                            fallbackKey\r\n                        );\r\n                    }\r\n                    setBaseLayer(fallbackKey, { silent: true });\r\n                }\r\n                return;\r\n            }\r\n\r\n            // Si la couche est d√©j√† active, on ne fait que rafra√Æchir l'UI\r\n            if (_activeKey === key) {\r\n                _refreshUI();\r\n                return;\r\n            }\r\n\r\n            // Retirer l'ancienne couche si pr√©sente (avec garde-fous)\r\n            if (previousKey && _baseLayers[previousKey]) {\r\n                const prev = _baseLayers[previousKey].layer;\r\n                try {\r\n                    if (\r\n                        prev &&\r\n                        _map &&\r\n                        typeof _map.hasLayer === \"function\" &&\r\n                        _map.hasLayer(prev)\r\n                    ) {\r\n                        _map.removeLayer(prev);\r\n                    }\r\n                } catch (e) {\r\n                    Log.warn(\r\n                        \"[GeoLeaf.Baselayers] Impossible de retirer la couche pr√©c√©dente:\",\r\n                        e\r\n                    );\r\n                }\r\n            }\r\n\r\n            const nextLayer = _baseLayers[key].layer;\r\n            if (!nextLayer || typeof nextLayer.addTo !== \"function\") {\r\n                Log.error(\"[GeoLeaf.Baselayers] Couche invalide pour la cl√©:\", key);\r\n                return;\r\n            }\r\n\r\n            try {\r\n                nextLayer.addTo(_map);\r\n            } catch (e) {\r\n                Log.error(\r\n                    \"[GeoLeaf.Baselayers] Impossible d'ajouter la couche au L.Map:\",\r\n                    e\r\n                );\r\n                return;\r\n            }\r\n\r\n            _activeKey = key;\r\n            _refreshUI();\r\n\r\n            Log.info(\"[GeoLeaf.Baselayers] Activated base layer:\", key);\r\n\r\n            // √âv√©nement personnalis√© : geoleaf:basemap:change\r\n            if (!options.silent) {\r\n                if (\r\n                    typeof document !== \"undefined\" &&\r\n                    typeof document.dispatchEvent === \"function\"\r\n                ) {\r\n                    const detail = {\r\n                        key,\r\n                        previousKey,\r\n                        map: _map,\r\n                        layer: nextLayer,\r\n                        source: \"geoleaf.baselayers\"\r\n                    };\r\n\r\n                    try {\r\n                        if (typeof CustomEvent === \"function\") {\r\n                            const event = new CustomEvent(\"geoleaf:basemap:change\", {\r\n                                detail\r\n                            });\r\n                            document.dispatchEvent(event);\r\n                        } else {\r\n                            const legacyEvent = document.createEvent(\"CustomEvent\");\r\n                            legacyEvent.initCustomEvent(\r\n                                \"geoleaf:basemap:change\",\r\n                                true,\r\n                                true,\r\n                                detail\r\n                            );\r\n                            document.dispatchEvent(legacyEvent);\r\n                        }\r\n                    } catch (err) {\r\n                        Log.warn(\r\n                            \"[GeoLeaf.Baselayers] Impossible d'√©mettre l'√©v√©nement geoleaf:basemap:change.\",\r\n                            err\r\n                        );\r\n                    }\r\n                }\r\n\r\n                Log.info(\"[GeoLeaf.Baselayers] Couche de fond active :\", key);\r\n            }\r\n        }\r\n\r\n        function getBaseLayers() {\r\n            return Object.assign({}, _baseLayers);\r\n        }\r\n\r\n        function getActiveKey() {\r\n            return _activeKey;\r\n        }\r\n\r\n        function getActiveLayer() {\r\n            return _activeKey && _baseLayers[_activeKey]\r\n                ? _baseLayers[_activeKey].layer\r\n                : null;\r\n        }\r\n\r\n        /**\r\n         * Initialisation du module Baselayers.\r\n         *\r\n         * Usage flexible :\r\n         * GeoLeaf.Baselayers.init({\r\n         *   map: mapLeaflet,              // optionnel si GeoLeaf.Core est d√©j√† initialis√©\r\n         *   baselayers: { street: {...}, topo: {...}, satellite: {...} },\r\n         *   defaultKey: \"street\"          // ou activeKey / initialKey\r\n         * });\r\n         *\r\n         * Si aucune couche n‚Äôest fournie, les 3 basemaps par d√©faut (OSM / OpenTopoMap / Esri WorldImagery)\r\n         * sont automatiquement enregistr√©es, et une est activ√©e.\r\n         */\r\n                function init(options) {\r\n            options = options || {};\r\n\r\n            if (options.map) {\r\n                _map = options.map;\r\n            } else {\r\n                _ensureMap();\r\n            }\r\n\r\n            _registerDefaultBaseLayers();\r\n\r\n            if (options.baselayers && typeof options.baselayers === \"object\") {\r\n                registerBaseLayers(options.baselayers);\r\n            }\r\n\r\n            if (options.activeKey) {\r\n                setBaseLayer(options.activeKey, { silent: true });\r\n            }\r\n\r\n            // Si aucune couche n'est active, on prend la premi√®re disponible.\r\n            if (!_activeKey) {\r\n                const keys = Object.keys(_baseLayers);\r\n                if (keys.length > 0) {\r\n                    const defaultKey = keys[0];\r\n                    Log.info(\"[GeoLeaf.Baselayers] init: aucune couche active, bascule sur\", defaultKey);\r\n                    setBaseLayer(defaultKey, { silent: true });\r\n                }\r\n            }\r\n\r\n            // Cr√©er les contr√¥les UI de fond de carte si la config le demande\r\n            _createBaseLayerControlsUI(options);\r\n\r\n            // Lie les boutons UI d√©clar√©s dans le DOM (data-gl-baselayer)\r\n            _bindUIOnce();\r\n\r\n            return {\r\n                map: _map,\r\n                activeKey: getActiveKey(),\r\n                layers: getBaseLayers()\r\n            };\r\n        }\r\n\r\n        return {\r\n            init: init,\r\n            registerBaseLayer: registerBaseLayer,\r\n            registerBaseLayers: registerBaseLayers,\r\n            setBaseLayer: setBaseLayer,\r\n            setActive: setBaseLayer, // alias pour compatibilit√©\r\n            getBaseLayers: getBaseLayers,\r\n            getActiveKey: getActiveKey,\r\n            getActiveLayer: getActiveLayer\r\n        };\r\n    })();\r\n\r\n    // Nommage stabilis√© : BaseLayers devient la forme officielle,\r\n    // Baselayers reste un alias de compatibilit√©.\r\n    GeoLeaf.Baselayers = Baselayers;\r\n    GeoLeaf.BaseLayers = Baselayers;\r\n})(window);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n/**\r\n * GeoLeaf Filters Module\r\n * Filtrage des POI et Routes selon crit√®res (cat√©gories, tags, proximit√©, recherche, note)\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    const Log = GeoLeaf.Log;\r\n    const Utils = GeoLeaf.Utils;\r\n\r\n    // ========================================\r\n    //   HELPER FUNCTIONS\r\n    // ========================================\r\n\r\n    /**\r\n     * Extrait une valeur depuis un chemin (ex: \"attributes.shortDescription\")\r\n     * @param {object} obj - Objet source\r\n     * @param {string} path - Chemin avec notation point\r\n     * @returns {*} Valeur trouv√©e ou null\r\n     * @private\r\n     */\r\n    function getNestedValue(obj, path) {\r\n        return path.split('.').reduce((current, prop) =>\r\n            current && current[prop] !== undefined ? current[prop] : null, obj);\r\n    }\r\n\r\n    /**\r\n     * R√©cup√®re les champs de recherche depuis le profil actif\r\n     * 1. Priorit√© : extrait les champs marqu√©s \"search\": true dans panels.detail.layout et panels.route.layout\r\n     * 2. Fallback : r√©cup√®re searchFields du filtre search dans le profil\r\n     * 3. Fallback final : champs par d√©faut\r\n     * @returns {Array<string>} Liste des chemins de champs √† rechercher\r\n     * @private\r\n     */\r\n    function getSearchFieldsFromProfile() {\r\n        try {\r\n            // Essayer de r√©cup√©rer depuis GeoLeaf.Config\r\n            if (GeoLeaf.Config && typeof GeoLeaf.Config.getActiveProfile === 'function') {\r\n                const profile = GeoLeaf.Config.getActiveProfile();\r\n\r\n                // 1. PRIORIT√â : Extraire les champs avec \"search\": true depuis tous les layouts\r\n                const searchableFieldsSet = new Set();\r\n\r\n                // Extraire depuis panels.detail.layout (POI)\r\n                if (profile && profile.panels && profile.panels.detail && Array.isArray(profile.panels.detail.layout)) {\r\n                    profile.panels.detail.layout\r\n                        .filter(item => item.search === true && item.field)\r\n                        .forEach(item => searchableFieldsSet.add(item.field));\r\n                }\r\n\r\n                // Extraire depuis panels.route.layout (Routes)\r\n                if (profile && profile.panels && profile.panels.route && Array.isArray(profile.panels.route.layout)) {\r\n                    profile.panels.route.layout\r\n                        .filter(item => item.search === true && item.field)\r\n                        .forEach(item => searchableFieldsSet.add(item.field));\r\n                }\r\n\r\n                if (searchableFieldsSet.size > 0) {\r\n                    const searchableFields = Array.from(searchableFieldsSet);\r\n                    if (Log) Log.debug('[Filters] Champs de recherche depuis layouts (search:true):', searchableFields);\r\n                    return searchableFields;\r\n                }\r\n\r\n                // 2. FALLBACK : Chercher searchFields dans panels.search.filters\r\n                if (profile && profile.panels && profile.panels.search && Array.isArray(profile.panels.search.filters)) {\r\n                    const searchFilter = profile.panels.search.filters.find(f => f.type === 'search');\r\n                    if (searchFilter && Array.isArray(searchFilter.searchFields) && searchFilter.searchFields.length > 0) {\r\n                        if (Log) Log.debug('[Filters] Champs de recherche depuis searchFields (fallback):', searchFilter.searchFields);\r\n                        return searchFilter.searchFields;\r\n                    }\r\n                }\r\n            }\r\n        } catch (err) {\r\n            if (Log) Log.warn('[Filters] Erreur extraction searchFields du profil:', err);\r\n        }\r\n\r\n        // 3. FALLBACK FINAL : champs par d√©faut\r\n        const defaultFields = ['title', 'label', 'name'];\r\n        if (Log) Log.debug('[Filters] Utilisation des champs de recherche par d√©faut:', defaultFields);\r\n        return defaultFields;\r\n    }\r\n\r\n    /**\r\n     * Extrait les coordonn√©es d'une route dans diff√©rents formats\r\n     * @param {object} route - Objet route\r\n     * @returns {Array<[number, number]>} Tableau de coordonn√©es [lat, lng]\r\n     * @private\r\n     */\r\n    function extractRouteCoords(route) {\r\n        // Cas 1 : tableau direct de [lat, lng]\r\n        if (Array.isArray(route.geometry) && route.geometry.length > 0) {\r\n            if (\r\n                Array.isArray(route.geometry[0]) &&\r\n                typeof route.geometry[0][0] === \"number\" &&\r\n                typeof route.geometry[0][1] === \"number\"\r\n            ) {\r\n                return route.geometry.map((pair) => [pair[0], pair[1]]);\r\n            }\r\n\r\n            // Cas 2 : GeoJSON-like dans un tableau\r\n            if (\r\n                route.geometry[0] &&\r\n                typeof route.geometry[0] === \"object\" &&\r\n                route.geometry[0].type === \"LineString\" &&\r\n                Array.isArray(route.geometry[0].coordinates)\r\n            ) {\r\n                return route.geometry[0].coordinates.map((c) => [c[1], c[0]]);\r\n            }\r\n        }\r\n\r\n        // Cas 3 : vrai objet GeoJSON\r\n        if (\r\n            route.geometry &&\r\n            typeof route.geometry === \"object\" &&\r\n            route.geometry.type === \"LineString\" &&\r\n            Array.isArray(route.geometry.coordinates)\r\n        ) {\r\n            return route.geometry.coordinates.map((c) => [c[1], c[0]]);\r\n        }\r\n\r\n        return [];\r\n    }\r\n\r\n    // ========================================\r\n    //   PUBLIC API\r\n    // ========================================\r\n\r\n    /**\r\n     * Filtre une liste de POI selon les crit√®res fournis\r\n     * @param {Array} basePois - Liste compl√®te des POI\r\n     * @param {object} filterState - √âtat des filtres\r\n     * @param {Array<string>} [filterState.categoriesTree] - IDs des cat√©gories s√©lectionn√©es\r\n     * @param {Array<string>} [filterState.subCategoriesTree] - IDs des sous-cat√©gories s√©lectionn√©es\r\n     * @param {boolean} [filterState.hasMinRating] - Activer filtre note minimale\r\n     * @param {number} [filterState.minRating] - Note minimale\r\n     * @param {Array<string>} [filterState.selectedTags] - Tags s√©lectionn√©s\r\n     * @param {boolean} [filterState.hasTags] - Activer filtre tags\r\n     * @param {object} [filterState.dataTypes] - Types de donn√©es (poi, routes)\r\n     * @param {string} [filterState.searchText] - Texte de recherche\r\n     * @param {boolean} [filterState.hasSearchText] - Activer recherche textuelle\r\n     * @param {object} [filterState.proximity] - Filtre proximit√© {active, center, radius}\r\n     * @returns {Array} POI filtr√©s\r\n     */\r\n    function filterPoiList(basePois, filterState) {\r\n        const catsSel = filterState.categoriesTree || [];\r\n        const subsSel = filterState.subCategoriesTree || [];\r\n        const hasCats = catsSel.length > 0;\r\n        const hasSubs = subsSel.length > 0;\r\n        const hasMinRating = !!filterState.hasMinRating;\r\n        const minRating = filterState.minRating;\r\n        const selectedTags = filterState.selectedTags || [];\r\n        const hasTags = filterState.hasTags;\r\n        const dataTypes = filterState.dataTypes || { poi: true, routes: true };\r\n        const searchText = filterState.searchText || \"\";\r\n        const hasSearchText = filterState.hasSearchText || false;\r\n        const proximity = filterState.proximity || { active: false };\r\n\r\n        if (Log) {\r\n            Log.debug(\"[Filters] D√©but filtrage POI:\", {\r\n                totalPOI: basePois.length,\r\n                hasCats,\r\n                hasSubs,\r\n                hasSearchText,\r\n                proximityActive: proximity.active\r\n            });\r\n        }\r\n\r\n        if (!Array.isArray(basePois) || basePois.length === 0) {\r\n            if (Log) Log.debug(\"[Filters] Aucun POI √† filtrer\");\r\n            return [];\r\n        }\r\n\r\n        // Utilise GeoLeaf.Utils.getDistance() (formule de Haversine)\r\n        const getDistance = Utils ? Utils.getDistance : null;\r\n\r\n        return basePois.filter(function (poi) {\r\n            const attrs = poi.attributes || {};\r\n            const props = poi.properties || {};\r\n\r\n            // Filtre Type de donn√©es (POI / Routes)\r\n            const poiType = poi.type || attrs.type || props.type || 'poi';\r\n            if (poiType === 'route' || poiType === 'routes') {\r\n                if (!dataTypes.routes) return false;\r\n            } else {\r\n                if (!dataTypes.poi) return false;\r\n            }\r\n\r\n            // Filtre Recherche textuelle\r\n            if (hasSearchText) {\r\n                const searchFields = getSearchFieldsFromProfile();\r\n                let matchFound = false;\r\n\r\n                for (let i = 0; i < searchFields.length; i++) {\r\n                    const fieldPath = searchFields[i];\r\n                    const value = getNestedValue(poi, fieldPath);\r\n\r\n                    if (value && String(value).toLowerCase().includes(searchText)) {\r\n                        matchFound = true;\r\n                        break;\r\n                    }\r\n                }\r\n\r\n                if (!matchFound) return false;\r\n            }\r\n\r\n            // Filtre Proximit√©\r\n            if (proximity.active && proximity.center && getDistance) {\r\n                let lat, lng;\r\n\r\n                // V√©rifier d'abord le format latlng [lat, lng]\r\n                if (poi.latlng && Array.isArray(poi.latlng) && poi.latlng.length === 2) {\r\n                    lat = poi.latlng[0];\r\n                    lng = poi.latlng[1];\r\n                } else {\r\n                    lat = poi.lat || poi.latitude || attrs.latitude || props.latitude ||\r\n                              (poi.coordinates && poi.coordinates[1]) ||\r\n                              (poi.geometry && poi.geometry.coordinates && poi.geometry.coordinates[1]);\r\n                    lng = poi.lng || poi.longitude || attrs.longitude || props.longitude ||\r\n                              (poi.coordinates && poi.coordinates[0]) ||\r\n                              (poi.geometry && poi.geometry.coordinates && poi.geometry.coordinates[0]);\r\n                }\r\n\r\n                if (lat && lng) {\r\n                    const distance = getDistance(proximity.center.lat, proximity.center.lng, lat, lng);\r\n                    if (distance > proximity.radius) return false;\r\n                } else {\r\n                    // Si pas de coordonn√©es, on exclut du filtre proximit√©\r\n                    return false;\r\n                }\r\n            }\r\n\r\n            const catId =\r\n                attrs.categoryId ||\r\n                poi.categoryId ||\r\n                poi.category ||\r\n                props.categoryId ||\r\n                props.category ||\r\n                null;\r\n\r\n            const subId =\r\n                attrs.subCategoryId ||\r\n                poi.subCategoryId ||\r\n                poi.subCategory ||\r\n                poi.sub_category ||\r\n                props.subCategoryId ||\r\n                props.sub_category ||\r\n                null;\r\n\r\n            // Filtre cat√©gories / sous-cat√©gories (tree-view)\r\n            // Logique:\r\n            // - Si des sous-cat√©gories sont coch√©es: le POI doit avoir cette sous-cat√©gorie\r\n            // - Si seulement des cat√©gories sont coch√©es (sans sous-cat): le POI doit avoir cette cat√©gorie\r\n            if (hasCats || hasSubs) {\r\n                // Cas 1: Des sous-cat√©gories sont s√©lectionn√©es\r\n                if (hasSubs) {\r\n                    // Si le POI a une sous-cat√©gorie, v√©rifier qu'elle est dans la liste\r\n                    if (subId && subsSel.includes(String(subId))) {\r\n                        // OK - sous-cat√©gorie correspond\r\n                    } else {\r\n                        // POI n'a pas la bonne sous-cat√©gorie\r\n                        // On v√©rifie si sa cat√©gorie est s√©lectionn√©e SANS sous-cat√©gorie coch√©e\r\n                        // (permet de garder les POI dont la cat√©gorie est coch√©e mais pas leurs sous-cat)\r\n                        if (hasCats && catId && catsSel.includes(String(catId))) {\r\n                            // V√©rifier si aucune sous-cat de cette cat√©gorie n'est coch√©e\r\n                            // Pour simplifier, on rejette si des sous-cat sont coch√©es\r\n                            return false;\r\n                        } else {\r\n                            return false;\r\n                        }\r\n                    }\r\n                }\r\n                // Cas 2: Seulement des cat√©gories (pas de sous-cat)\r\n                else if (hasCats) {\r\n                    if (!catId || !catsSel.includes(String(catId))) {\r\n                        return false;\r\n                    }\r\n                }\r\n            }\r\n\r\n            // Filtre note minimale\r\n            if (hasMinRating) {\r\n                let avg = 0;\r\n                let hasRating = false;\r\n\r\n                // Cas 1: reviews est un objet avec rating (format actuel)\r\n                let reviewsObj = attrs.reviews || poi.reviews || props.reviews;\r\n                if (reviewsObj && typeof reviewsObj === \"object\" && !Array.isArray(reviewsObj)) {\r\n                    if (typeof reviewsObj.rating === \"number\") {\r\n                        avg = reviewsObj.rating;\r\n                        hasRating = true;\r\n                    }\r\n                }\r\n\r\n                // Cas 2: reviews est un array (ancien format)\r\n                else if (Array.isArray(reviewsObj) && reviewsObj.length > 0) {\r\n                    const sum = reviewsObj.reduce(\r\n                        (acc, r) => acc + (Number(r.rating) || 0),\r\n                        0\r\n                    );\r\n                    avg = sum / reviewsObj.length;\r\n                    hasRating = avg > 0;\r\n                }\r\n\r\n                // Cas 3: rating directement sur l'objet\r\n                else if (typeof attrs.rating === \"number\") {\r\n                    avg = attrs.rating;\r\n                    hasRating = true;\r\n                } else if (typeof poi.rating === \"number\") {\r\n                    avg = poi.rating;\r\n                    hasRating = true;\r\n                } else if (typeof props.rating === \"number\") {\r\n                    avg = props.rating;\r\n                    hasRating = true;\r\n                }\r\n\r\n                // Exclure si: 1) pas de note OU 2) note < minRating\r\n                // Comportement: quand filtre actif, seuls les POI avec note >= minRating passent\r\n                if (!hasRating || avg < minRating) {\r\n                    return false;\r\n                }\r\n            }\r\n\r\n            // Tags (au moins UN des tags s√©lectionn√©s doit √™tre pr√©sent dans le POI)\r\n            if (hasTags) {\r\n                let poiTags =\r\n                    attrs.tags || poi.tags || props.tags || [];\r\n                if (!Array.isArray(poiTags)) {\r\n                    if (typeof poiTags === \"string\") {\r\n                        poiTags = poiTags.split(/[,;]+/);\r\n                    } else {\r\n                        poiTags = [];\r\n                    }\r\n                }\r\n                poiTags = poiTags\r\n                    .map((t) => String(t).trim())\r\n                    .filter(Boolean);\r\n\r\n                const hasAtLeastOne = selectedTags.some((tag) =>\r\n                    poiTags.includes(tag)\r\n                );\r\n                if (!hasAtLeastOne) {\r\n                    return false;\r\n                }\r\n            }\r\n\r\n            return true;\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Filtre une liste de routes selon les crit√®res fournis\r\n     * @param {Array} baseRoutes - Liste compl√®te des routes\r\n     * @param {object} filterState - √âtat des filtres\r\n     * @param {Array<string>} [filterState.categoriesTree] - IDs des cat√©gories s√©lectionn√©es\r\n     * @param {Array<string>} [filterState.subCategoriesTree] - IDs des sous-cat√©gories s√©lectionn√©es\r\n     * @param {Array<string>} [filterState.selectedTags] - Tags s√©lectionn√©s\r\n     * @param {boolean} [filterState.hasTags] - Activer filtre tags\r\n     * @param {string} [filterState.searchText] - Texte de recherche\r\n     * @param {boolean} [filterState.hasSearchText] - Activer recherche textuelle\r\n     * @param {object} [filterState.proximity] - Filtre proximit√© {active, center, radius}\r\n     * @returns {Array} Routes filtr√©es\r\n     */\r\n    function filterRouteList(baseRoutes, filterState) {\r\n        const catsSel = filterState.categoriesTree || [];\r\n        const subsSel = filterState.subCategoriesTree || [];\r\n        const hasCats = catsSel.length > 0;\r\n        const hasSubs = subsSel.length > 0;\r\n        const selectedTags = filterState.selectedTags || [];\r\n        const hasTags = filterState.hasTags;\r\n        const hasMinRating = !!filterState.hasMinRating;\r\n        const minRating = filterState.minRating;\r\n        const searchText = filterState.searchText || \"\";\r\n        const hasSearchText = filterState.hasSearchText || false;\r\n        const proximity = filterState.proximity || { active: false };\r\n\r\n        if (Log) {\r\n            Log.debug(\"[Filters] D√©but filtrage routes:\", {\r\n                totalRoutes: baseRoutes.length,\r\n                hasCats,\r\n                hasSubs,\r\n                hasMinRating,\r\n                minRating,\r\n                hasSearchText,\r\n                proximityActive: proximity.active\r\n            });\r\n        }\r\n\r\n        if (!Array.isArray(baseRoutes) || baseRoutes.length === 0) {\r\n            if (Log) Log.debug(\"[Filters] Aucune route √† filtrer\");\r\n            return [];\r\n        }\r\n\r\n        // Utilise GeoLeaf.Utils.getDistance() (formule de Haversine)\r\n        const getDistance = Utils ? Utils.getDistance : null;\r\n\r\n        return baseRoutes.filter(function (route) {\r\n            const attrs = route.attributes || {};\r\n            const props = route.properties || {};\r\n\r\n            // Filtre Recherche textuelle\r\n            if (hasSearchText) {\r\n                const searchFields = getSearchFieldsFromProfile();\r\n                let matchFound = false;\r\n\r\n                for (let i = 0; i < searchFields.length; i++) {\r\n                    const fieldPath = searchFields[i];\r\n                    const value = getNestedValue(route, fieldPath);\r\n\r\n                    if (value && String(value).toLowerCase().includes(searchText)) {\r\n                        matchFound = true;\r\n                        break;\r\n                    }\r\n                }\r\n\r\n                if (!matchFound) return false;\r\n            }\r\n\r\n            // Filtre cat√©gories / sous-cat√©gories (tree-view)\r\n            const catId =\r\n                attrs.categoryId ||\r\n                route.categoryId ||\r\n                route.category ||\r\n                props.categoryId ||\r\n                props.category ||\r\n                null;\r\n\r\n            const subId =\r\n                attrs.subCategoryId ||\r\n                route.subCategoryId ||\r\n                route.subCategory ||\r\n                route.sub_category ||\r\n                props.subCategoryId ||\r\n                props.sub_category ||\r\n                null;\r\n\r\n            // Filtre cat√©gories / sous-cat√©gories (tree-view)\r\n            // Logique:\r\n            // - Si des sous-cat√©gories sont coch√©es: la route doit avoir cette sous-cat√©gorie\r\n            // - Si seulement des cat√©gories sont coch√©es (sans sous-cat): la route doit avoir cette cat√©gorie\r\n            if (hasCats || hasSubs) {\r\n                // Cas 1: Des sous-cat√©gories sont s√©lectionn√©es\r\n                if (hasSubs) {\r\n                    if (subId && subsSel.includes(String(subId))) {\r\n                        // OK - sous-cat√©gorie correspond\r\n                    } else {\r\n                        // Route n'a pas la bonne sous-cat√©gorie\r\n                        if (hasCats && catId && catsSel.includes(String(catId))) {\r\n                            return false;\r\n                        } else {\r\n                            return false;\r\n                        }\r\n                    }\r\n                }\r\n                // Cas 2: Seulement des cat√©gories (pas de sous-cat)\r\n                else if (hasCats) {\r\n                    if (!catId || !catsSel.includes(String(catId))) {\r\n                        return false;\r\n                    }\r\n                }\r\n            }\r\n\r\n            // Filtre Tags (au moins UN des tags s√©lectionn√©s doit √™tre pr√©sent)\r\n            if (hasTags) {\r\n                let routeTags =\r\n                    attrs.tags || route.tags || props.tags || [];\r\n                if (!Array.isArray(routeTags)) {\r\n                    if (typeof routeTags === \"string\") {\r\n                        routeTags = routeTags.split(/[,;]+/);\r\n                    } else {\r\n                        routeTags = [];\r\n                    }\r\n                }\r\n                routeTags = routeTags\r\n                    .map((t) => String(t).trim())\r\n                    .filter(Boolean);\r\n\r\n                const hasAtLeastOne = selectedTags.some((tag) =>\r\n                    routeTags.includes(tag)\r\n                );\r\n                if (!hasAtLeastOne) {\r\n                    return false;\r\n                }\r\n            }\r\n\r\n            // Filtre note minimale (m√™me logique que pour les POI)\r\n            if (hasMinRating) {\r\n                let avg = 0;\r\n                let hasRating = false;\r\n\r\n                // Cas 1: reviews est un objet avec rating (format actuel)\r\n                let reviewsObj = attrs.reviews || route.reviews || props.reviews;\r\n                if (reviewsObj && typeof reviewsObj === \"object\" && !Array.isArray(reviewsObj)) {\r\n                    if (typeof reviewsObj.rating === \"number\") {\r\n                        avg = reviewsObj.rating;\r\n                        hasRating = true;\r\n                    }\r\n                }\r\n\r\n                // Cas 2: reviews est un array (ancien format)\r\n                else if (Array.isArray(reviewsObj) && reviewsObj.length > 0) {\r\n                    const sum = reviewsObj.reduce(\r\n                        (acc, r) => acc + (Number(r.rating) || 0),\r\n                        0\r\n                    );\r\n                    avg = sum / reviewsObj.length;\r\n                    hasRating = avg > 0;\r\n                }\r\n\r\n                // Cas 3: rating directement sur l'objet\r\n                else if (typeof attrs.rating === \"number\") {\r\n                    avg = attrs.rating;\r\n                    hasRating = true;\r\n                } else if (typeof route.rating === \"number\") {\r\n                    avg = route.rating;\r\n                    hasRating = true;\r\n                } else if (typeof props.rating === \"number\") {\r\n                    avg = props.rating;\r\n                    hasRating = true;\r\n                }\r\n\r\n                // Exclure si: 1) pas de note OU 2) note < minRating\r\n                // Comportement: quand filtre actif, seules les routes avec note >= minRating passent\r\n                if (!hasRating || avg < minRating) {\r\n                    return false;\r\n                }\r\n            }\r\n\r\n            // Filtre Proximit√© : v√©rifier si au moins un point de l'itin√©raire est dans le cercle\r\n            if (proximity.active && proximity.center && getDistance) {\r\n                const coords = extractRouteCoords(route);\r\n\r\n                if (coords.length === 0) {\r\n                    // Si pas de coordonn√©es, on exclut du filtre proximit√©\r\n                    return false;\r\n                }\r\n\r\n                // V√©rifier si au moins un point de l'itin√©raire est dans le rayon\r\n                let isInRadius = false;\r\n                for (let i = 0; i < coords.length; i++) {\r\n                    const lat = coords[i][0];\r\n                    const lng = coords[i][1];\r\n                    const distance = getDistance(proximity.center.lat, proximity.center.lng, lat, lng);\r\n                    if (distance <= proximity.radius) {\r\n                        isInRadius = true;\r\n                        break;\r\n                    }\r\n                }\r\n\r\n                if (!isInRadius) {\r\n                    return false;\r\n                }\r\n            }\r\n\r\n            return true;\r\n        });\r\n    }\r\n\r\n    // ========================================\r\n    //   EXPORT\r\n    // ========================================\r\n\r\n    GeoLeaf.Filters = {\r\n        filterPoiList,\r\n        filterRouteList\r\n    };\r\n\r\n})(typeof window !== \"undefined\" ? window : global);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n/**\r\n * GeoLeaf POI Module - √âtat Partag√©\r\n * Variables et constantes partag√©es entre tous les sous-modules POI\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    GeoLeaf._POIShared = GeoLeaf._POIShared || {};\r\n\r\n    // ========================================\r\n    //   CONSTANTES\r\n    // ========================================\r\n\r\n    const POI_MARKER_SIZE = GeoLeaf.Constants?.POI_MARKER_SIZE || 16;\r\n    const POI_MAX_ZOOM = GeoLeaf.Constants?.POI_MAX_ZOOM || 18;\r\n\r\n    // Ic√¥ne par d√©faut (cercle bleu SVG en base64)\r\n    const defaultIconUrl = \"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSI4IiBmaWxsPSIjNGE5MGU1IiBzdHJva2U9IiNmZmYiIHN0cm9rZS13aWR0aD0iMiIvPjwvc3ZnPg==\";\r\n\r\n    // ========================================\r\n    //   √âTAT PARTAG√â\r\n    // ========================================\r\n\r\n    /**\r\n     * √âtat mutable partag√© entre tous les sous-modules POI\r\n     * Accessible via GeoLeaf._POIShared.state\r\n     */\r\n    const state = {\r\n        // LayerGroup Leaflet contenant tous les marqueurs POI\r\n        poiLayerGroup: null,\r\n\r\n        // Cluster group (si activ√©)\r\n        poiClusterGroup: null,\r\n\r\n        // Tableau des donn√©es POI charg√©es\r\n        allPois: [],\r\n\r\n        // Map pour stocker les marqueurs Leaflet par ID de POI\r\n        poiMarkers: new Map(),\r\n\r\n        // Configuration du module POI\r\n        poiConfig: {},\r\n\r\n        // R√©f√©rence vers la carte Leaflet\r\n        mapInstance: null,\r\n\r\n        // Indicateur de chargement en cours\r\n        isLoading: false,\r\n\r\n        // √âl√©ment DOM pour le panneau lat√©ral POI\r\n        sidePanelElement: null,\r\n\r\n        // POI actuellement affich√© dans le panneau\r\n        currentPoiInPanel: null,\r\n\r\n        // Overlay de fond sombre pour le side panel\r\n        sidePanelOverlay: null,\r\n\r\n        // Index de l'image courante dans la galerie\r\n        currentGalleryIndex: 0\r\n    };\r\n\r\n    // ========================================\r\n    //   UTILITAIRES PARTAG√âS\r\n    // ========================================\r\n\r\n    /**\r\n     * Helper interne : garantit qu'un maxZoom num√©rique est d√©fini sur la carte.\r\n     * Utilis√© pour √©viter les erreurs du plugin de clustering (\"Map has no maxZoom specified\").\r\n     *\r\n     * @param {L.Map} map - Instance de la carte Leaflet\r\n     * @param {number} [fallback=18] - Valeur par d√©faut si map.options.maxZoom n'existe pas\r\n     */\r\n    function ensureMapMaxZoom(map, fallback = 18) {\r\n        if (!map || !map.options) return;\r\n        if (typeof map.options.maxZoom !== 'number' || isNaN(map.options.maxZoom)) {\r\n            map.options.maxZoom = fallback;\r\n        }\r\n    }\r\n\r\n    // ========================================\r\n    //   EXPORT\r\n    // ========================================\r\n\r\n    GeoLeaf._POIShared = {\r\n        // Constantes (lecture seule)\r\n        constants: Object.freeze({\r\n            POI_MARKER_SIZE,\r\n            POI_MAX_ZOOM,\r\n            defaultIconUrl\r\n        }),\r\n\r\n        // √âtat mutable (accessible en lecture/√©criture par sous-modules)\r\n        state,\r\n\r\n        // Utilitaires\r\n        ensureMapMaxZoom\r\n    };\r\n\r\n})(typeof window !== \"undefined\" ? window : global);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n/**\r\n * GeoLeaf POI Module - Normalizers\r\n * Fonctions de normalisation et extraction de donn√©es POI\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    const Log = GeoLeaf.Log;\r\n    const Security = GeoLeaf.Security || {};\r\n    const Utils = GeoLeaf.Utils || {};\r\n\r\n    GeoLeaf._POINormalizers = GeoLeaf._POINormalizers || {};\r\n\r\n    // ========================================\r\n    //   NORMALISATION POI\r\n    // ========================================\r\n\r\n    /**\r\n     * Normalise un POI vers la structure standard { id, latlng, title, attributes: {...} }.\r\n     * Transforme l'ancien format vers le nouveau format attendu par le profile.json.\r\n     *\r\n     * @param {object} poi - POI au format brut (ancien ou nouveau).\r\n     * @returns {object} POI normalis√©.\r\n     */\r\n    function normalizePoi(poi) {\r\n        if (!poi) return null;\r\n\r\n        const p = poi;\r\n        // Pr√©f√©rer les champs \"attributes\" du nouveau sch√©ma\r\n        const attr = (p && typeof p.attributes === 'object' && p.attributes) ? p.attributes : {};\r\n        const props = p.properties || {};\r\n\r\n        // Helper to sanitize URLs\r\n        const sanitizeUrl = (url) => {\r\n            if (!url || typeof url !== 'string') return null;\r\n            const trimmed = url.trim();\r\n            if (trimmed.match(/^(https?:\\/\\/|data:image\\/)/i)) {\r\n                return trimmed;\r\n            }\r\n            return null;\r\n        };\r\n\r\n        // Helper to escape HTML - utilise Security.escapeHtml\r\n        const escapeHtml = Security.escapeHtml || ((str) => {\r\n            if (!str) return '';\r\n            const div = document.createElement('div');\r\n            div.textContent = str;\r\n            return div.innerHTML;\r\n        });\r\n\r\n        // Utilise resolveField si disponible\r\n        const resolveField = Utils.resolveField || ((obj, ...paths) => {\r\n            for (const path of paths) {\r\n                const keys = path.split('.');\r\n                let value = obj;\r\n                for (const key of keys) {\r\n                    if (value && typeof value === 'object' && key in value) {\r\n                        value = value[key];\r\n                    } else {\r\n                        value = null;\r\n                        break;\r\n                    }\r\n                }\r\n                if (value && typeof value === 'string' && value.trim()) {\r\n                    return value;\r\n                }\r\n            }\r\n            return '';\r\n        });\r\n\r\n        // Construire la structure normalis√©e\r\n        const normalized = {\r\n            id: p.id || null,\r\n            latlng: p.latlng || null,\r\n            // Le titre provient du champ label (nouvelle structure) ou des anciens champs\r\n            title: escapeHtml(resolveField(p, 'title', 'label', 'name', 'attributes.title', 'properties.label', 'properties.name') || 'Sans nom'),\r\n            // Pr√©server aussi label et name au niveau racine\r\n            label: escapeHtml(resolveField(p, 'label', 'name', 'title')),\r\n            name: escapeHtml(resolveField(p, 'name', 'label', 'title')),\r\n            description: escapeHtml(resolveField(p, 'description', 'attributes.description')),\r\n            // ‚úÖ IMPORTANT: Pr√©server les properties originales pour la r√©solution de champs comme \"properties.Name\"\r\n            properties: p.properties || {},\r\n            attributes: {\r\n                // D'abord, copier TOUS les attributs originaux pour pr√©server les champs sp√©cifiques\r\n                ...attr,\r\n                // Puis ajouter/surcharger avec les mappings normalis√©s\r\n                // Description courte : premier niveau du POI\r\n                shortDescription: escapeHtml(resolveField(p, 'description', 'attributes.shortDescription', 'properties.description')),\r\n                // Description longue : champ attributes.description_long ou anciens champs\r\n                longDescription: escapeHtml(resolveField(p, 'attributes.description_long', 'description_long', 'properties.description_long', 'attributes.longDescription')),\r\n                // Cat√©gories : pr√©f√©rer attributes.categoryId puis fallback anciens champs\r\n                categoryId: attr.categoryId || p.categoryId || p.category || props.category || null,\r\n                subCategoryId: attr.subCategoryId || p.subCategoryId || p.sub_category || props.sub_category || null,\r\n                // Image principale : attributes.photo ou attributes.mainImage, sinon premi√®re image de la galerie\r\n                mainImage: sanitizeUrl(attr.photo || attr.mainImage || props.photo || (attr.gallery && attr.gallery[0]) || (p.gallery && p.gallery[0]) || null),\r\n                // Galerie d'images : provenant de attributes.gallery ou anciens champs\r\n                gallery: ((attr.gallery || p.gallery || props.gallery || p.images || props.images) || [])\r\n                    .map(img => {\r\n                        if (typeof img === 'string') return sanitizeUrl(img);\r\n                        if (img && img.url) return sanitizeUrl(img.url);\r\n                        return null;\r\n                    })\r\n                    .filter(Boolean),\r\n                price: attr.price || p.price || props.price || null,\r\n                // Horaires d'ouverture : attributes.opening_hours (snake_case) ou openingHours camelCase\r\n                openingHours: attr.opening_hours || attr.openingHours || p.opening_hours || props.opening_hours || p.openingHours || props.openingHours || null,\r\n                openingHoursTable: null, // Sera construit √† partir de openingHours si n√©cessaire\r\n                reviews: attr.reviews || p.reviews || props.reviews || null,\r\n                // Tags : pr√©f√©rer attributes.tags\r\n                tags: (attr.tags || p.tags || props.tags || [])\r\n                    .map(t => escapeHtml(String(t))),\r\n                // Lien / site web : attributes.link (nouveau) ou anciens champs\r\n                website: sanitizeUrl(attr.link || attr.website || p.link || props.link || p.website || props.website || null),\r\n                address: escapeHtml(resolveField(p, 'attributes.address', 'address', 'properties.address')),\r\n                phone: escapeHtml(resolveField(p, 'attributes.phone', 'phone', 'properties.phone')),\r\n                email: escapeHtml(resolveField(p, 'attributes.email', 'email', 'properties.email')),\r\n                services: (attr.services || p.services || props.services || [])\r\n                    .map(s => escapeHtml(String(s)))\r\n            }\r\n        };\r\n\r\n        // Construire openingHoursTable si openingHours existe\r\n        if (normalized.attributes.openingHours && Array.isArray(normalized.attributes.openingHours)) {\r\n            normalized.attributes.openingHoursTable = normalized.attributes.openingHours.map(raw => {\r\n                if (raw == null) return null;\r\n                const text = String(raw).trim();\r\n                if (!text) return null;\r\n\r\n                const parts = text.split(':');\r\n                if (parts.length > 1) {\r\n                    const day = parts.shift().trim();\r\n                    const rest = parts.join(':').trim();\r\n\r\n                    let open = '';\r\n                    let close = '';\r\n                    const hoursParts = rest.split(/[‚Äì-]/);\r\n                    if (hoursParts.length > 1) {\r\n                        open = hoursParts[0].trim();\r\n                        close = hoursParts.slice(1).join('‚Äì').trim();\r\n                    } else {\r\n                        open = rest;\r\n                    }\r\n\r\n                    return { day, open, close };\r\n                }\r\n\r\n                return { day: text, open: '', close: '' };\r\n            }).filter(Boolean);\r\n        }\r\n\r\n        // ‚úÖ IMPORTANT: Pr√©server les m√©tadonn√©es de configuration de couche\r\n        // Ces champs sont ajout√©s par GeoJSON._convertFeatureToPOI\r\n        if (poi._sidepanelConfig) {\r\n            normalized._sidepanelConfig = poi._sidepanelConfig;\r\n        }\r\n        if (poi._layerConfig) {\r\n            normalized._layerConfig = poi._layerConfig;\r\n        }\r\n\r\n        return normalized;\r\n    }\r\n\r\n    /**\r\n     * Extrait la valeur d'un champ depuis un POI normalis√© en utilisant la notation point√©e.\r\n     *\r\n     * @param {object} normalizedPoi - POI normalis√©.\r\n     * @param {string} fieldPath - Chemin du champ (ex: \"title\", \"attributes.gallery\", \"attributes.reviews.rating\").\r\n     * @returns {*} Valeur du champ ou null si introuvable.\r\n     */\r\n    function getFieldValue(normalizedPoi, fieldPath) {\r\n        if (!normalizedPoi || !fieldPath) return null;\r\n\r\n        console.log('[DEBUG getFieldValue] Recherche:', fieldPath, 'dans POI:', {\r\n            id: normalizedPoi.id,\r\n            hasProperties: !!normalizedPoi.properties,\r\n            hasAttributes: !!normalizedPoi.attributes,\r\n            propertiesKeys: normalizedPoi.properties ? Object.keys(normalizedPoi.properties) : [],\r\n            attributesKeys: normalizedPoi.attributes ? Object.keys(normalizedPoi.attributes) : []\r\n        });\r\n\r\n        if (Log && typeof Log.debug === 'function') {\r\n            Log.debug(\"[POI.getFieldValue] Recherche fieldPath:\", fieldPath, \"| POI:\", normalizedPoi.id);\r\n        }\r\n\r\n        const parts = fieldPath.split('.');\r\n        let value = normalizedPoi;\r\n\r\n        for (const part of parts) {\r\n            if (value == null || typeof value !== 'object') {\r\n                if (Log && typeof Log.debug === 'function') {\r\n                    Log.debug(\"[POI.getFieldValue] Chemin interrompu √† la partie:\", part, \"| value actuelle:\", value);\r\n                }\r\n                return null;\r\n            }\r\n            value = value[part];\r\n        }\r\n\r\n        console.log('[DEBUG getFieldValue] Valeur trouv√©e:', value, 'pour fieldPath:', fieldPath);\r\n\r\n        if (Log && typeof Log.debug === 'function') {\r\n            Log.debug(\"[POI.getFieldValue] Valeur trouv√©e pour\", fieldPath, \":\", value);\r\n        }\r\n\r\n        // Retourner null pour les valeurs vides\r\n        if (value === undefined || value === '' || (Array.isArray(value) && value.length === 0)) {\r\n            console.log('[DEBUG getFieldValue] Valeur vide, retourne null');\r\n            if (Log && typeof Log.debug === 'function') {\r\n                Log.debug(\"[POI.getFieldValue] Valeur vide ou tableau vide, retourne null\");\r\n            }\r\n            return null;\r\n        }\r\n\r\n        return value;\r\n    }\r\n\r\n    /**\r\n     * Extrait les coordonn√©es d'un POI et les normalise en [lat, lng].\r\n     *\r\n     * @param {object} poi - POI brut.\r\n     * @returns {Array<number>|null} Coordonn√©es [lat, lng] ou null si invalides.\r\n     */\r\n    function extractCoordinates(poi) {\r\n        if (!poi) return null;\r\n\r\n        let lat, lng;\r\n\r\n        // Format 1: poi.latlng = [lat, lng]\r\n        if (Array.isArray(poi.latlng) && poi.latlng.length >= 2) {\r\n            lat = poi.latlng[0];\r\n            lng = poi.latlng[1];\r\n        }\r\n        // Format 2: poi.latlng = {lat, lng}\r\n        else if (poi.latlng && typeof poi.latlng === 'object') {\r\n            lat = poi.latlng.lat;\r\n            lng = poi.latlng.lng || poi.latlng.lon;\r\n        }\r\n        // Format 3: poi.lat, poi.lng\r\n        else if (typeof poi.lat === 'number' && typeof poi.lng === 'number') {\r\n            lat = poi.lat;\r\n            lng = poi.lng;\r\n        }\r\n        // Format 4: poi.latitude, poi.longitude\r\n        else if (typeof poi.latitude === 'number' && typeof poi.longitude === 'number') {\r\n            lat = poi.latitude;\r\n            lng = poi.longitude;\r\n        }\r\n        // Format 5: poi.geometry.coordinates (GeoJSON)\r\n        else if (poi.geometry && Array.isArray(poi.geometry.coordinates)) {\r\n            // GeoJSON: [lng, lat] (invers√©!)\r\n            lng = poi.geometry.coordinates[0];\r\n            lat = poi.geometry.coordinates[1];\r\n        }\r\n\r\n        // Validation\r\n        if (typeof lat !== 'number' || typeof lng !== 'number' || isNaN(lat) || isNaN(lng)) {\r\n            return null;\r\n        }\r\n\r\n        // Validation bounds\r\n        if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {\r\n            return null;\r\n        }\r\n\r\n        return [lat, lng];\r\n    }\r\n\r\n    /**\r\n     * G√©n√®re un ID unique pour un POI sans ID.\r\n     *\r\n     * @param {object} poi - POI.\r\n     * @returns {string} ID g√©n√©r√©.\r\n     */\r\n    function generatePoiId(poi) {\r\n        const timestamp = Date.now();\r\n        const random = Math.floor(Math.random() * 10000);\r\n        const label = (poi.title || poi.label || poi.name || 'poi').toLowerCase().replace(/[^a-z0-9]/g, '-').substring(0, 20);\r\n        return `poi-${label}-${timestamp}-${random}`;\r\n    }\r\n\r\n    // ========================================\r\n    //   EXPORT\r\n    // ========================================\r\n\r\n    GeoLeaf._POINormalizers = {\r\n        normalizePoi,\r\n        getFieldValue,\r\n        extractCoordinates,\r\n        generatePoiId\r\n    };\r\n\r\n})(typeof window !== \"undefined\" ? window : global);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n/**\r\n * GeoLeaf POI Module - Popup & Tooltips\r\n * Gestion des popups rapides et tooltips sur les marqueurs.\r\n * D√©l√®gue le rendu au module _ContentBuilder centralis√©.\r\n *\r\n * @module poi/popup\r\n * @version 2.0.0\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    const Log = GeoLeaf.Log || console;\r\n    const Security = GeoLeaf.Security || {};\r\n    const Utils = GeoLeaf.Utils || {};\r\n\r\n    GeoLeaf._POIPopup = GeoLeaf._POIPopup || {};\r\n\r\n    // ========================================\r\n    //   UTILITAIRES LOCAUX\r\n    // ========================================\r\n\r\n    /**\r\n     * R√©cup√®re le ContentBuilder\r\n     * @returns {Object|null}\r\n     */\r\n    function getContentBuilder() {\r\n        return GeoLeaf._ContentBuilder || null;\r\n    }\r\n\r\n    /**\r\n     * R√©sout la valeur d'un champ √† partir d'un objet POI.\r\n     * D√©l√®gue √† Utils.resolveField si disponible.\r\n     *\r\n     * @param {object} poi - Objet POI source.\r\n     * @param {string} field - Chemin du champ (ex: \"attributes.photo\").\r\n     * @returns {*} Valeur du champ ou null.\r\n     */\r\n    function resolveField(poi, field) {\r\n        if (!poi || !field) return null;\r\n\r\n        if (Utils.resolveField) {\r\n            return Utils.resolveField(poi, field);\r\n        }\r\n\r\n        // Fallback minimal\r\n        const parts = field.split('.');\r\n        let current = poi;\r\n        for (const part of parts) {\r\n            if (current && typeof current === 'object' && part in current) {\r\n                current = current[part];\r\n            } else {\r\n                return null;\r\n            }\r\n        }\r\n        return current;\r\n    }\r\n\r\n    /**\r\n     * √âchappe le HTML pour pr√©venir XSS.\r\n     * D√©l√®gue √† Security.escapeHtml si disponible.\r\n     *\r\n     * @param {string} str - Cha√Æne √† √©chapper.\r\n     * @returns {string} Cha√Æne √©chapp√©e.\r\n     */\r\n    function escapeHtml(str) {\r\n        if (!str) return '';\r\n        if (Security.escapeHtml) {\r\n            return Security.escapeHtml(str);\r\n        }\r\n        // Fallback\r\n        const div = document.createElement('div');\r\n        div.textContent = str;\r\n        return div.innerHTML;\r\n    }\r\n\r\n    // ========================================\r\n    //   CONFIGURATION\r\n    // ========================================\r\n\r\n    /**\r\n     * R√©cup√®re la configuration de popup pour une couche/POI.\r\n     *\r\n     * @param {object} poi - Donn√©es du POI.\r\n     * @returns {Array|null} Configuration detailPopup ou null.\r\n     */\r\n    function getPopupConfig(poi) {\r\n        // 1. Config attach√©e depuis la couche du POI\r\n        if (poi._layerConfig?.popup?.detailPopup) {\r\n            Log.info && Log.info('[POI Popup] Config popup depuis layerConfig');\r\n            return poi._layerConfig.popup.detailPopup;\r\n        }\r\n\r\n        // 2. Fallback: profil actif\r\n        const Config = GeoLeaf.Config;\r\n        if (Config && typeof Config.getActiveProfile === 'function') {\r\n            const profile = Config.getActiveProfile();\r\n\r\n            // Chercher la config dans les emplacements standards\r\n            if (profile?.popup?.detailPopup) {\r\n                Log.info && Log.info('[POI Popup] Config popup depuis profil actif (profile.popup.detailPopup)');\r\n                return profile.popup.detailPopup;\r\n            }\r\n\r\n            // ALTERNATIVE: V√©rifier aussi dans panels.poi (ancienne structure)\r\n            if (profile?.panels?.poi?.popup?.detailPopup) {\r\n                Log.info && Log.info('[POI Popup] Config popup depuis profil actif (profile.panels.poi.popup.detailPopup - ancienne structure)');\r\n                return profile.panels.poi.popup.detailPopup;\r\n            }\r\n        }\r\n\r\n        Log.warn && Log.warn('[POI Popup] Aucune configuration detailPopup trouv√©e pour POI:', poi.id || 'unknown');\r\n        return null;\r\n    }\r\n\r\n    /**\r\n     * R√©cup√®re la configuration de tooltip pour une couche/POI.\r\n     *\r\n     * @param {object} poi - Donn√©es du POI.\r\n     * @returns {Array|null} Configuration detailTooltip ou null.\r\n     */\r\n    function getTooltipConfig(poi) {\r\n        // 1. Config depuis popup.detailTooltip (structure standard)\r\n        if (poi._layerConfig?.popup?.detailTooltip) {\r\n            return poi._layerConfig.popup.detailTooltip;\r\n        }\r\n\r\n        // 2. Config depuis tooltip.detailTooltip\r\n        if (poi._layerConfig?.tooltip?.detailTooltip) {\r\n            return poi._layerConfig.tooltip.detailTooltip;\r\n        }\r\n\r\n        // 3. Config directe detailTooltip\r\n        if (poi._layerConfig?.detailTooltip) {\r\n            return poi._layerConfig.detailTooltip;\r\n        }\r\n\r\n        // 4. Fallback: profil actif\r\n        const Config = GeoLeaf.Config;\r\n        if (Config && typeof Config.getActiveProfile === 'function') {\r\n            const profile = Config.getActiveProfile();\r\n            if (profile?.popup?.detailTooltip) {\r\n                return profile.popup.detailTooltip;\r\n            }\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    // ========================================\r\n    //   CONSTRUCTION DU CONTENU\r\n    // ========================================\r\n\r\n    /**\r\n     * Construit le contenu HTML d'un popup rapide pour un POI.\r\n     * Utilise ContentBuilder si disponible, sinon logique interne.\r\n     *\r\n     * @param {object} poi - Donn√©es du POI.\r\n     * @param {Function} resolveCategoryDisplay - Fonction pour r√©soudre l'affichage de cat√©gorie.\r\n     * @returns {string} HTML du popup.\r\n     */\r\n    function buildQuickPopupContent(poi, resolveCategoryDisplay) {\r\n        if (!poi) {\r\n            Log.warn && Log.warn('[POI Popup] POI invalide');\r\n            return '';\r\n        }\r\n\r\n        const config = getPopupConfig(poi);\r\n        const ContentBuilder = getContentBuilder();\r\n\r\n        // Si ContentBuilder disponible, d√©l√©guer\r\n        if (ContentBuilder && typeof ContentBuilder.buildPopupHTML === 'function') {\r\n            return ContentBuilder.buildPopupHTML(poi, config, {\r\n                resolveCategoryDisplay: resolveCategoryDisplay\r\n            });\r\n        }\r\n\r\n        // Fallback si ContentBuilder non charg√©\r\n        Log.warn && Log.warn('[POI Popup] ContentBuilder non disponible, fallback basique');\r\n        return buildFallbackPopup(poi, config, resolveCategoryDisplay);\r\n    }\r\n\r\n    /**\r\n     * Construit le contenu d'un tooltip pour un POI.\r\n     * Utilise ContentBuilder si disponible.\r\n     *\r\n     * @param {object} poi - Donn√©es du POI.\r\n     * @param {Function} resolveCategoryDisplay - Fonction pour r√©soudre l'affichage de cat√©gorie.\r\n     * @returns {string} HTML du tooltip.\r\n     */\r\n    function buildTooltipContent(poi, resolveCategoryDisplay) {\r\n        if (!poi) {\r\n            Log.warn && Log.warn('[POI Tooltip] POI invalide');\r\n            return '';\r\n        }\r\n\r\n        const config = getTooltipConfig(poi);\r\n        const ContentBuilder = getContentBuilder();\r\n\r\n        // Si ContentBuilder disponible, d√©l√©guer\r\n        if (ContentBuilder && typeof ContentBuilder.buildTooltipHTML === 'function') {\r\n            return ContentBuilder.buildTooltipHTML(poi, config, {\r\n                resolveCategoryDisplay: resolveCategoryDisplay\r\n            });\r\n        }\r\n\r\n        // Fallback si ContentBuilder non charg√©\r\n        return escapeHtml(\r\n            resolveField(poi, 'title') ||\r\n            resolveField(poi, 'label') ||\r\n            resolveField(poi, 'name') ||\r\n            'POI'\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Fallback pour construire un popup basique sans ContentBuilder.\r\n     *\r\n     * @param {object} poi - Donn√©es du POI.\r\n     * @param {Array} config - Configuration detailPopup.\r\n     * @param {Function} resolveCategoryDisplay - Fonction pour r√©soudre l'affichage de cat√©gorie.\r\n     * @returns {string} HTML du popup.\r\n     */\r\n    function buildFallbackPopup(poi, config, resolveCategoryDisplay) {\r\n        const title = escapeHtml(\r\n            resolveField(poi, 'title') ||\r\n            resolveField(poi, 'label') ||\r\n            resolveField(poi, 'name') ||\r\n            'POI'\r\n        );\r\n\r\n        const description = resolveField(poi, 'attributes.description') ||\r\n                            resolveField(poi, 'description') || '';\r\n\r\n        let html = '<div class=\"gl-poi-popup\">';\r\n        html += '<div class=\"gl-poi-popup__body\">';\r\n        html += '<h3 class=\"gl-poi-popup__title\"><span class=\"gl-poi-popup__title-text\">' + title + '</span></h3>';\r\n        if (description) {\r\n            html += '<p class=\"gl-poi-popup__desc\">' + escapeHtml(description) + '</p>';\r\n        }\r\n        html += '<a href=\"#\" class=\"gl-poi-popup__link\" data-poi-id=\"' + (poi.id || '') + '\">Voir plus >>></a>';\r\n        html += '</div></div>';\r\n\r\n        return html;\r\n    }\r\n\r\n    // ========================================\r\n    //   ATTACHMENT LEAFLET\r\n    // ========================================\r\n\r\n    /**\r\n     * Attache un tooltip √† un marqueur Leaflet.\r\n     *\r\n     * @param {L.Marker} marker - Marqueur Leaflet.\r\n     * @param {string} content - Contenu du tooltip (texte).\r\n     * @param {object} options - Options du tooltip.\r\n     */\r\n    function attachTooltip(marker, content, options) {\r\n        if (!marker || typeof marker.bindTooltip !== 'function') {\r\n            Log.warn && Log.warn('[POI Popup] Marker invalide pour attachTooltip');\r\n            return;\r\n        }\r\n\r\n        const defaultOptions = {\r\n            direction: \"top\",\r\n            offset: [0, -10],\r\n            opacity: 0.9,\r\n            className: \"gl-poi-tooltip\"\r\n        };\r\n\r\n        const finalOptions = Object.assign({}, defaultOptions, options || {});\r\n        marker.bindTooltip(content, finalOptions);\r\n    }\r\n\r\n    /**\r\n     * G√®re le tooltip d'un marqueur selon la configuration.\r\n     *\r\n     * @param {L.Marker} marker - Marqueur Leaflet.\r\n     * @param {object} poi - Donn√©es du POI.\r\n     * @param {object} config - Configuration POI globale.\r\n     * @param {Function} resolveCategoryDisplay - Fonction pour r√©soudre l'affichage de cat√©gorie.\r\n     */\r\n    function manageTooltip(marker, poi, config, resolveCategoryDisplay) {\r\n        if (!marker || !poi) return;\r\n\r\n        const tooltipMode = config?.tooltipMode || \"hover\"; // \"hover\", \"permanent\", \"none\"\r\n\r\n        if (tooltipMode === \"none\") {\r\n            return;\r\n        }\r\n\r\n        // Construire le contenu du tooltip\r\n        const tooltipText = buildTooltipContent(poi, resolveCategoryDisplay);\r\n\r\n        if (tooltipMode === \"permanent\") {\r\n            attachTooltip(marker, tooltipText, { permanent: true });\r\n        } else {\r\n            attachTooltip(marker, tooltipText);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Attache un popup √† un marqueur Leaflet.\r\n     *\r\n     * @param {L.Marker} marker - Marqueur Leaflet.\r\n     * @param {string} content - Contenu HTML du popup.\r\n     * @param {object} options - Options du popup.\r\n     */\r\n    function attachPopup(marker, content, options) {\r\n        if (!marker || typeof marker.bindPopup !== 'function') {\r\n            Log.error && Log.error('[POI Popup] Marker invalide ou pas de bindPopup');\r\n            return;\r\n        }\r\n\r\n        const defaultOptions = {\r\n            maxWidth: 300,\r\n            minWidth: 200,\r\n            className: \"gl-poi-popup-leaflet\",\r\n            closeButton: true,\r\n            autoPan: true\r\n        };\r\n\r\n        const finalOptions = Object.assign({}, defaultOptions, options || {});\r\n        marker.bindPopup(content, finalOptions);\r\n    }\r\n\r\n    // ========================================\r\n    //   EXPORT\r\n    // ========================================\r\n\r\n    GeoLeaf._POIPopup = {\r\n        // Construction de contenu\r\n        buildQuickPopupContent,\r\n        buildTooltipContent,\r\n\r\n        // Gestion Leaflet\r\n        attachTooltip,\r\n        manageTooltip,\r\n        attachPopup,\r\n\r\n        // Configuration\r\n        getPopupConfig,\r\n        getTooltipConfig\r\n    };\r\n\r\n    Log.info && Log.info('[GeoLeaf._POIPopup] Module POI Popup/Tooltip charg√© (v2.0.0)');\r\n\r\n})(typeof window !== \"undefined\" ? window : global);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n/**\r\n * GeoLeaf POI Module - Markers\r\n * Cr√©ation et gestion des marqueurs Leaflet pour les POI\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    const Log = GeoLeaf.Log;\r\n    const Security = GeoLeaf.Security || {};\r\n\r\n    GeoLeaf._POIMarkers = GeoLeaf._POIMarkers || {};\r\n\r\n    // R√©f√©rences aux modules POI\r\n    const getShared = () => GeoLeaf._POIShared;\r\n    const getNormalizers = () => GeoLeaf._POINormalizers;\r\n    const getPopup = () => GeoLeaf._POIPopup;\r\n\r\n    /**\r\n     * Obtient la configuration de base des POI depuis le profil actif.\r\n     *\r\n     * @returns {object} Configuration de base { radius, weight, colorFill, colorStroke, fillOpacity, opacity, showIconsOnMap }.\r\n     */\r\n    function getPoiBaseConfig() {\r\n        const base = {\r\n            radius: 6,\r\n            weight: 1.5,\r\n            colorFill: \"#4a90e5\",\r\n            colorStroke: \"#ffffff\",\r\n            fillOpacity: 0.8,\r\n            opacity: 0.9,\r\n            showIconsOnMap: true\r\n        };\r\n\r\n        try {\r\n            if (GeoLeaf.Config && typeof GeoLeaf.Config.getActiveProfile === \"function\") {\r\n                const activeProfile = GeoLeaf.Config.getActiveProfile();\r\n                const poiCfg =\r\n                    activeProfile &&\r\n                    activeProfile.appearance &&\r\n                    activeProfile.appearance.poi;\r\n\r\n                if (poiCfg) {\r\n                    if (typeof poiCfg.radius === \"number\") base.radius = poiCfg.radius;\r\n                    if (typeof poiCfg.weight === \"number\") base.weight = poiCfg.weight;\r\n                    if (typeof poiCfg.fillOpacity === \"number\") base.fillOpacity = poiCfg.fillOpacity;\r\n                    if (typeof poiCfg.opacity === \"number\") base.opacity = poiCfg.opacity;\r\n                    if (typeof poiCfg.showIconsOnMap === \"boolean\") base.showIconsOnMap = poiCfg.showIconsOnMap;\r\n\r\n                    if (typeof poiCfg.colorFill === \"string\") {\r\n                        base.colorFill = poiCfg.colorFill;\r\n                    }\r\n                    if (typeof poiCfg.colorStroke === \"string\") {\r\n                        base.colorStroke = poiCfg.colorStroke;\r\n                    }\r\n                }\r\n            }\r\n\r\n            // Fallback sur variables CSS\r\n            if (typeof document !== \"undefined\" && typeof window !== \"undefined\" && window.getComputedStyle) {\r\n                const root = getComputedStyle(document.documentElement);\r\n                const fillCss = root.getPropertyValue(\"--gl-color-poi-fill-default\").trim();\r\n                const strokeCss = root.getPropertyValue(\"--gl-color-poi-stroke-default\").trim();\r\n                if (fillCss && !base.colorFill) base.colorFill = fillCss;\r\n                if (strokeCss && !base.colorStroke) base.colorStroke = strokeCss;\r\n            }\r\n        } catch (err) {\r\n            if (Log) Log.warn(\"[POI] getPoiBaseConfig() : Erreur lecture config :\", err);\r\n        }\r\n\r\n        return base;\r\n    }\r\n\r\n    /**\r\n     * R√©sout les couleurs d'un POI depuis category.style.json du profil actif.\r\n     * Ordre de priorit√© des couleurs :\r\n     * 1. Style de la couche (poi._layerConfig.style)\r\n     * 2. Style de cat√©gorie (category.style.json)\r\n     * 3. Style par d√©faut (baseConfig)\r\n     *\r\n     * @param {object} poi - Donn√©es du POI.\r\n     * @param {object} baseConfig - Configuration de base avec couleurs par d√©faut\r\n     * @returns {object} { colorFill, colorStroke, colorRoute, weight, radius, fillOpacity, opacity }\r\n     */\r\n    function resolveCategoryColors(poi, baseConfig) {\r\n        let colors = {\r\n            colorFill: baseConfig.colorFill,\r\n            colorStroke: baseConfig.colorStroke,\r\n            colorRoute: null,\r\n            weight: baseConfig.weight,\r\n            radius: baseConfig.radius,\r\n            fillOpacity: baseConfig.fillOpacity !== undefined ? baseConfig.fillOpacity : null,\r\n            opacity: baseConfig.opacity !== undefined ? baseConfig.opacity : null\r\n        };\r\n\r\n        // 1. Appliquer d'abord le style de la couche si disponible\r\n        if (poi._layerConfig && poi._layerConfig.style) {\r\n            const layerStyle = poi._layerConfig.style;\r\n            if (layerStyle.fillColor) colors.colorFill = layerStyle.fillColor;\r\n            if (layerStyle.color) colors.colorStroke = layerStyle.color;\r\n            if (typeof layerStyle.weight === 'number') colors.weight = layerStyle.weight;\r\n            if (typeof layerStyle.radius === 'number') colors.radius = layerStyle.radius;\r\n            if (typeof layerStyle.fillOpacity === 'number') colors.fillOpacity = layerStyle.fillOpacity;\r\n            if (typeof layerStyle.opacity === 'number') colors.opacity = layerStyle.opacity;\r\n        }\r\n\r\n        // 2. Appliquer ensuite les couleurs depuis les styleRules de la couche\r\n        if (GeoLeaf.Helpers && GeoLeaf.Helpers.StyleResolver) {\r\n            const styleColors = GeoLeaf.Helpers.StyleResolver.resolvePoiColors(poi);\r\n            if (styleColors.colorFill) colors.colorFill = styleColors.colorFill;\r\n            if (styleColors.colorStroke) colors.colorStroke = styleColors.colorStroke;\r\n            if (styleColors.colorRoute) colors.colorRoute = styleColors.colorRoute;\r\n        }\r\n\r\n        return colors;\r\n    }\r\n\r\n    /**\r\n     * R√©sout l'affichage d'un POI (ic√¥ne + couleurs) depuis la taxonomie et category.style.json du profil actif.\r\n     * Ordre de priorit√© des styles :\r\n     * 1. Style de la couche (poi._layerConfig.style) pour les couleurs\r\n     * 2. Style de cat√©gorie (category.style.json) pour les couleurs\r\n     * 3. Taxonomie pour les ic√¥nes\r\n     * 4. Style par d√©faut (baseConfig)\r\n     *\r\n     * @param {object} poi - Donn√©es du POI.\r\n     * @returns {object} Configuration d'affichage { useIcon, iconId, colorFill, colorStroke, weight, radius, fillOpacity, opacity }.\r\n     */\r\n    function resolveCategoryDisplay(poi) {\r\n        const categoriesConfig = (GeoLeaf.Config && typeof GeoLeaf.Config.getCategories === \"function\")\r\n            ? GeoLeaf.Config.getCategories()\r\n            : {};\r\n\r\n        const shared = getShared();\r\n        const poiConfig = shared ? shared.state.poiConfig : {};\r\n        const showIconsOnMap = (poiConfig.showIconsOnMap !== false);\r\n\r\n        const baseConfig = getPoiBaseConfig();\r\n\r\n        // R√©soudre les couleurs via resolveCategoryColors\r\n        const colors = resolveCategoryColors(poi, baseConfig);\r\n\r\n        let result = {\r\n            useIcon: false,\r\n            iconId: null,\r\n            colorFill: colors.colorFill,\r\n            colorStroke: colors.colorStroke,\r\n            colorRoute: colors.colorRoute,\r\n            weight: colors.weight,\r\n            radius: colors.radius,\r\n            fillOpacity: colors.fillOpacity,\r\n            opacity: colors.opacity\r\n        };\r\n\r\n        // D√©terminer si on utilise les ic√¥nes\r\n        if (showIconsOnMap) {\r\n            try {\r\n                const iconsConfig = (GeoLeaf.Config && typeof GeoLeaf.Config.getIconsConfig === \"function\")\r\n                    ? GeoLeaf.Config.getIconsConfig()\r\n                    : null;\r\n\r\n                if (iconsConfig && iconsConfig.showOnMap !== false) {\r\n                    result.useIcon = true;\r\n                }\r\n            } catch (e) {\r\n                // Fallback showIconsOnMap reste true par d√©faut\r\n            }\r\n        }\r\n\r\n        const categoryId = poi.categoryId || poi.category ||\r\n            (poi.attributes && poi.attributes.categoryId) ||\r\n            (poi.properties && poi.properties.categoryId) ||\r\n            (poi.properties && poi.properties.category);\r\n\r\n        const subCategoryId = poi.subCategoryId || poi.subCategory || poi.sub_category ||\r\n            (poi.attributes && poi.attributes.subCategoryId) ||\r\n            (poi.properties && poi.properties.subCategoryId) ||\r\n            (poi.properties && poi.properties.sub_category);\r\n\r\n        // R√©solution de l'ic√¥ne depuis la taxonomie (pas les couleurs)\r\n        if (subCategoryId && categoryId && categoriesConfig[categoryId]?.subcategories) {\r\n            const subCat = categoriesConfig[categoryId].subcategories[subCategoryId];\r\n            const cat = categoriesConfig[categoryId];\r\n\r\n            if (subCat) {\r\n                result.iconId = subCat.icon || subCat.iconId || cat.icon || cat.iconId || null;\r\n            } else {\r\n                result.iconId = cat.icon || cat.iconId || null;\r\n            }\r\n        } else if (categoryId && categoriesConfig[categoryId]) {\r\n            const cat = categoriesConfig[categoryId];\r\n            result.iconId = cat.icon || cat.iconId || null;\r\n        } else {\r\n            // Ne logger que si une cat√©gorie est r√©ellement d√©finie (√©viter les warnings pour undefined/null)\r\n            if (categoryId && categoryId !== 'undefined' && categoryId !== 'null' && Log) {\r\n                Log.warn(`[POI] resolveCategoryDisplay() : Cat√©gorie '${categoryId}' non trouv√©e dans la taxonomie.`);\r\n            }\r\n        }\r\n\r\n        return result;\r\n    }\r\n\r\n    /**\r\n     * Injecte le sprite SVG du profil actif dans le DOM (asynchrone).\r\n     * Lit la configuration des ic√¥nes depuis taxonomy.icons.\r\n     * √âvite les duplications en v√©rifiant l'existence.\r\n     * Note: La fonction reste nomm√©e \"Sync\" pour la compatibilit√©, mais utilise fetch (async) en interne.\r\n     */\r\n    async function ensureProfileSpriteInjectedSync() {\r\n        try {\r\n            if (typeof GeoLeaf.Config === \"undefined\" || typeof GeoLeaf.Config.getIconsConfig !== \"function\") {\r\n                if (Log) Log.warn(\"[POI] GeoLeaf.Config.getIconsConfig non disponible\");\r\n                return;\r\n            }\r\n\r\n            const iconsCfg = GeoLeaf.Config.getIconsConfig();\r\n            // Log seulement la premi√®re fois ou si la config change\r\n            if (!ensureProfileSpriteInjectedSync._lastConfig || JSON.stringify(iconsCfg) !== JSON.stringify(ensureProfileSpriteInjectedSync._lastConfig)) {\r\n                if (Log) Log.debug(\"[POI] IconsConfig r√©cup√©r√©:\", iconsCfg);\r\n                ensureProfileSpriteInjectedSync._lastConfig = iconsCfg;\r\n            }\r\n            if (!iconsCfg) {\r\n                if (Log) Log.warn(\"[POI] Aucune configuration d'ic√¥nes trouv√©e\");\r\n                return;\r\n            }\r\n\r\n            const spriteUrl = iconsCfg.spriteUrl;\r\n\r\n            if (!spriteUrl || typeof spriteUrl !== \"string\") {\r\n                if (Log) Log.warn(\"[POI] spriteUrl manquant ou invalide:\", spriteUrl);\r\n                return;\r\n            }\r\n\r\n            // V√©rifier si le sprite est d√©j√† inject√©\r\n            const existing = document.querySelector('svg[data-geoleaf-sprite=\"profile\"]');\r\n            if (existing) {\r\n                if (Log) Log.debug(\"[POI] Sprite SVG d√©j√† inject√©\");\r\n                return;\r\n            }\r\n\r\n            if (Log) Log.info(\"[POI] Chargement sprite depuis:\", spriteUrl);\r\n\r\n            // ‚úÖ NOUVEAU: Utiliser fetch asynchrone pour √©viter l'avertissement de d√©pr√©ciation\r\n            // et am√©liorer les performances en √©vitant de bloquer le thread principal\r\n            try {\r\n                const response = await fetch(spriteUrl);\r\n\r\n                if (response.ok) {\r\n                    const svgText = await response.text();\r\n\r\n                    // SAFE: Utilisation de DOMParser au lieu de innerHTML pour √©viter l'ex√©cution de scripts\r\n                    const parser = new DOMParser();\r\n                    const doc = parser.parseFromString(svgText, \"image/svg+xml\");\r\n\r\n                    // V√©rifier les erreurs de parsing\r\n                    const parserError = doc.querySelector(\"parsererror\");\r\n                    if (parserError) {\r\n                        if (Log) Log.warn(\"[POI] Erreur parsing SVG sprite :\", parserError.textContent);\r\n                        return;\r\n                    }\r\n\r\n                    const svgEl = doc.documentElement;\r\n                    if (svgEl && svgEl.tagName.toLowerCase() === \"svg\") {\r\n                        svgEl.setAttribute(\"data-geoleaf-sprite\", \"profile\");\r\n                        svgEl.style.position = \"absolute\";\r\n                        svgEl.style.width = \"0\";\r\n                        svgEl.style.height = \"0\";\r\n                        svgEl.style.overflow = \"hidden\";\r\n                        svgEl.setAttribute(\"aria-hidden\", \"true\");\r\n\r\n                        if (document.body.firstChild) {\r\n                            document.body.insertBefore(svgEl, document.body.firstChild);\r\n                        } else {\r\n                            document.body.appendChild(svgEl);\r\n                        }\r\n\r\n                        const symbolCount = svgEl.querySelectorAll('symbol').length;\r\n                        if (Log) Log.info(\"[POI] Sprite SVG profil inject√© dans le DOM (async).\", symbolCount, \"symboles charg√©s.\");\r\n                    }\r\n                } else {\r\n                    if (Log) Log.warn(\"[POI] Erreur chargement sprite profil: HTTP\", response.status);\r\n                }\r\n            } catch (err) {\r\n                if (Log) Log.warn(\"[POI] Erreur chargement sprite profil (async):\", err);\r\n            }\r\n        } catch (err) {\r\n            if (Log) Log.warn(\"[POI] Erreur chargement sprite profil :\", err);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Extrait les coordonn√©es d'un POI pour la cr√©ation de marqueur.\r\n     *\r\n     * @param {object} poi - Donn√©es du POI.\r\n     * @returns {[number, number]|null} [latitude, longitude] ou null si invalides.\r\n     */\r\n    function extractMarkerCoordinates(poi) {\r\n        if (!poi) {\r\n            if (Log) Log.warn(\"[POI] extractMarkerCoordinates() : POI invalide.\", poi);\r\n            return null;\r\n        }\r\n\r\n        const normalizers = getNormalizers();\r\n        if (!normalizers) {\r\n            if (Log) Log.error(\"[POI] extractMarkerCoordinates() : Module Normalizers non charg√©.\");\r\n            return null;\r\n        }\r\n\r\n        const coords = normalizers.extractCoordinates(poi);\r\n        if (!coords) {\r\n            if (Log) Log.warn(\"[POI] extractMarkerCoordinates() : POI sans coordonn√©es valides.\", poi);\r\n            return null;\r\n        }\r\n\r\n        return coords;\r\n    }\r\n\r\n    /**\r\n     * Construit l'ic√¥ne Leaflet (DivIcon) pour un marqueur POI.\r\n     * Mode ic√¥ne : utilise le sprite SVG profil avec cercle de fond.\r\n     * Mode simple : cercle simple sans ic√¥ne.\r\n     *\r\n     * @param {object} displayConfig - Configuration d'affichage { useIcon, iconId, colorFill, colorStroke, radius, weight, fillOpacity, opacity }.\r\n     * @returns {L.DivIcon} Ic√¥ne Leaflet configur√©e.\r\n     */\r\n    function buildMarkerIcon(displayConfig) {\r\n        const baseConfig = getPoiBaseConfig();\r\n        const radius = displayConfig.radius !== undefined ? displayConfig.radius : baseConfig.radius;\r\n        const weight = displayConfig.weight !== undefined ? displayConfig.weight : baseConfig.weight;\r\n        const fillOpacity = displayConfig.fillOpacity;\r\n        const strokeOpacity = displayConfig.opacity;\r\n\r\n        const iconSizeCircle = Math.max(Math.round((radius * 2) + (weight * 2)), 8);\r\n        const iconSizeIcon = Math.max(Math.round((radius * 2) + (weight * 2)), 16);\r\n\r\n        // Appliquer fillOpacity √† colorFill si d√©fini\r\n        let colorFill = displayConfig.colorFill;\r\n        if (fillOpacity !== null && typeof fillOpacity === 'number') {\r\n            // Convertir la couleur hex en rgba avec fillOpacity\r\n            if (colorFill && colorFill.startsWith('#')) {\r\n                const r = parseInt(colorFill.slice(1, 3), 16);\r\n                const g = parseInt(colorFill.slice(3, 5), 16);\r\n                const b = parseInt(colorFill.slice(5, 7), 16);\r\n                colorFill = 'rgba(' + r + ', ' + g + ', ' + b + ', ' + fillOpacity + ')';\r\n            }\r\n        }\r\n\r\n        // Appliquer opacity au stroke (colorStroke) si d√©fini\r\n        let colorStroke = displayConfig.colorStroke;\r\n        if (strokeOpacity !== null && typeof strokeOpacity === 'number') {\r\n            // Convertir la couleur hex en rgba avec opacity\r\n            if (colorStroke && colorStroke.startsWith('#')) {\r\n                const r = parseInt(colorStroke.slice(1, 3), 16);\r\n                const g = parseInt(colorStroke.slice(3, 5), 16);\r\n                const b = parseInt(colorStroke.slice(5, 7), 16);\r\n                colorStroke = 'rgba(' + r + ', ' + g + ', ' + b + ', ' + strokeOpacity + ')';\r\n            }\r\n        }\r\n\r\n        if (displayConfig.useIcon && displayConfig.iconId) {\r\n            // Mode ic√¥ne : DivIcon avec sprite m√©tier\r\n            const iconsConfig = (GeoLeaf.Config && typeof GeoLeaf.Config.getIconsConfig === \"function\")\r\n                ? GeoLeaf.Config.getIconsConfig()\r\n                : null;\r\n            const iconPrefix = (iconsConfig && iconsConfig.symbolPrefix) || \"gl-poi-cat-\";\r\n\r\n            const iconIdNormalized = String(displayConfig.iconId)\r\n                .trim()\r\n                .toLowerCase()\r\n                .replace(/\\s+/g, \"-\");\r\n\r\n            const symbolId = iconPrefix + iconIdNormalized;\r\n\r\n            const htmlIcon = [\r\n                '<div class=\"gl-poi-marker\" style=\"',\r\n                \"--gl-poi-fill:\", colorFill, \";\",\r\n                \"--gl-poi-stroke:\", colorStroke, \";\",\r\n                \"width:\", iconSizeIcon, \"px;\",\r\n                \"height:\", iconSizeIcon, \"px;\",\r\n                '\">',\r\n                '<svg class=\"gl-poi-marker__icon\" aria-hidden=\"true\" focusable=\"false\" viewBox=\"0 0 24 24\" style=\"overflow: visible;\">',\r\n                '<circle cx=\"12\" cy=\"12\" r=\"10\" fill=\"', colorFill, '\" stroke=\"', colorStroke, '\" stroke-width=\"', weight, '\"/>',\r\n                '<svg x=\"2\" y=\"2\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" preserveAspectRatio=\"xMidYMid meet\" overflow=\"visible\">',\r\n                '<use href=\"#', symbolId, '\" style=\"color: #ffffff\"/>',\r\n                '</svg>',\r\n                \"</svg>\",\r\n                \"</div>\"\r\n            ].join(\"\");\r\n\r\n            return L.divIcon({\r\n                html: htmlIcon,\r\n                className: \"gl-poi-divicon\",\r\n                iconSize: [iconSizeIcon, iconSizeIcon],\r\n                iconAnchor: [iconSizeIcon / 2, iconSizeIcon / 2],\r\n                popupAnchor: [0, -(iconSizeIcon / 2)]\r\n            });\r\n        } else {\r\n            // Mode point simple (sans ic√¥ne)\r\n            const htmlCircle = [\r\n                '<div class=\"gl-poi-marker\" style=\"',\r\n                \"--gl-poi-fill:\", colorFill, \";\",\r\n                \"--gl-poi-stroke:\", colorStroke, \";\",\r\n                \"width:\", iconSizeCircle, \"px;\",\r\n                \"height:\", iconSizeCircle, \"px;\",\r\n                '\">',\r\n                '<svg class=\"gl-poi-marker__circle\" aria-hidden=\"true\" focusable=\"false\">',\r\n                '<circle cx=\"50%\" cy=\"50%\" r=\"', radius, '\"',\r\n                ' fill=\"', colorFill, '\"',\r\n                ' stroke=\"', colorStroke, '\"',\r\n                ' stroke-width=\"', weight, '\" />',\r\n                \"</svg>\",\r\n                \"</div>\"\r\n            ].join(\"\");\r\n\r\n            return L.divIcon({\r\n                html: htmlCircle,\r\n                className: \"gl-poi-divicon\",\r\n                iconSize: [iconSizeCircle, iconSizeCircle],\r\n                iconAnchor: [iconSizeCircle / 2, iconSizeCircle / 2],\r\n                popupAnchor: [0, -(iconSizeCircle / 2)]\r\n            });\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Attache les √©v√©nements et comportements √† un marqueur POI (tooltip, popup, side panel).\r\n     *\r\n     * @param {L.Marker} marker - Marqueur Leaflet √† configurer.\r\n     * @param {object} poi - Donn√©es du POI.\r\n     */\r\n    function attachMarkerEvents(marker, poi) {\r\n        // Attacher m√©tadonn√©es POI\r\n        marker._geoleafPoiData = poi;\r\n\r\n        const shared = getShared();\r\n        const poiConfig = shared ? shared.state.poiConfig : {};\r\n        const popupModule = getPopup();\r\n\r\n        // Gestion tooltip\r\n        if (popupModule && typeof popupModule.manageTooltip === 'function') {\r\n            popupModule.manageTooltip(marker, poi, poiConfig, resolveCategoryDisplay);\r\n        }\r\n\r\n        // V√©rifier si les popups sont activ√©s (par d√©faut: true)\r\n        const showPopup = (poiConfig.showPopup !== false);\r\n\r\n        if (showPopup) {\r\n            // Mode popup: afficher le popup avec lien \"Voir plus\"\r\n            if (popupModule && typeof popupModule.buildQuickPopupContent === 'function') {\r\n                const popupContent = popupModule.buildQuickPopupContent(poi, resolveCategoryDisplay);\r\n                if (popupContent) {\r\n                    if (popupModule.attachPopup) {\r\n                        popupModule.attachPopup(marker, popupContent);\r\n                    } else {\r\n                        marker.bindPopup(popupContent);\r\n                    }\r\n                } else {\r\n                    Log.error('[markers] Popup content vide pour POI:', poi.id);\r\n                }\r\n\r\n                // Initialiser le flag de popup actif\r\n                marker._geoleafPopupActive = false;\r\n\r\n                // Bloquer l'ouverture du tooltip pendant que le popup est actif\r\n                marker.on('tooltipopen', function() {\r\n                    if (marker._geoleafPopupActive) {\r\n                        marker.closeTooltip();\r\n                    }\r\n                });\r\n\r\n                // Attacher √©v√©nement pour le lien \"Voir plus\" du popup\r\n                marker.on('popupopen', function() {\r\n                    // Marquer le popup comme actif et fermer le tooltip\r\n                    marker._geoleafPopupActive = true;\r\n                    marker.closeTooltip();\r\n\r\n                    setTimeout(function() {\r\n                        const link = document.querySelector('.gl-poi-popup__link[data-poi-id=\"' + poi.id + '\"]');\r\n                        if (link) {\r\n                            if (Log) Log.info('[POI] Lien \"Voir plus\" trouv√© pour POI:', poi.id);\r\n\r\n                            // Retirer les anciens listeners pour √©viter les doublons\r\n                            const newLink = link.cloneNode(true);\r\n                            link.parentNode.replaceChild(newLink, link);\r\n\r\n                            newLink.addEventListener('click', function(e) {\r\n                                e.preventDefault();\r\n                                e.stopPropagation();\r\n\r\n                                if (Log) Log.info('[POI] Clic sur \"Voir plus\" pour POI:', poi.id);\r\n\r\n                                // Fermer le popup\r\n                                if (marker && marker.closePopup) {\r\n                                    marker.closePopup();\r\n                                }\r\n\r\n                                // Ouvrir le side panel avec un petit d√©lai\r\n                                setTimeout(function() {\r\n                                    if (Log) Log.info('[POI] Appel de showPoiDetails pour:', poi.id);\r\n                                    if (GeoLeaf.POI && typeof GeoLeaf.POI.showPoiDetails === 'function') {\r\n                                        GeoLeaf.POI.showPoiDetails(poi);\r\n                                    } else {\r\n                                        if (Log) Log.error('[POI] GeoLeaf.POI.showPoiDetails non disponible');\r\n                                    }\r\n                                }, 100);\r\n                            });\r\n                        } else {\r\n                            if (Log) Log.warn('[POI] Lien \"Voir plus\" non trouv√© pour POI:', poi.id);\r\n                        }\r\n                    }, 50);\r\n                });\r\n\r\n                // R√©activer le tooltip quand le popup se ferme\r\n                marker.on('popupclose', function() {\r\n                    marker._geoleafPopupActive = false;\r\n\r\n                    // R√©ouvrir le tooltip s'il est permanent (mode \"always\")\r\n                    if (marker.getTooltip() && marker.getTooltip().options.permanent) {\r\n                        setTimeout(function() {\r\n                            if (marker.openTooltip && !marker._geoleafPopupActive) {\r\n                                marker.openTooltip();\r\n                            }\r\n                        }, 50);\r\n                    }\r\n                });\r\n            }\r\n        } else {\r\n            // Mode direct: ouvrir le side panel directement au clic sur le marker (sans popup)\r\n            marker.on('click', function(e) {\r\n                e.originalEvent.stopPropagation();\r\n\r\n                if (Log) Log.info('[POI] Clic direct sur marker (sans popup) pour POI:', poi.id);\r\n\r\n                if (GeoLeaf.POI && typeof GeoLeaf.POI.showPoiDetails === 'function') {\r\n                    GeoLeaf.POI.showPoiDetails(poi);\r\n                } else {\r\n                    if (Log) Log.error('[POI] GeoLeaf.POI.showPoiDetails non disponible');\r\n                }\r\n            });\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Cr√©e un marqueur Leaflet pour un POI.\r\n     * Orchestrateur principal : coordonn√©es ‚Üí affichage ‚Üí ic√¥ne ‚Üí √©v√©nements.\r\n     *\r\n     * @param {object} poi - Donn√©es du POI.\r\n     * @returns {L.Marker|null} Marqueur Leaflet ou null si invalide.\r\n     */\r\n    /**\r\n     * Cr√©e un marqueur Leaflet pour un POI.\r\n     * Orchestrateur principal : coordonn√©es ‚Üí affichage ‚Üí ic√¥ne ‚Üí √©v√©nements.\r\n     *\r\n     * @param {object} poi - Donn√©es du POI.\r\n     * @param {object} [options] - Options de cr√©ation.\r\n     * @param {boolean} [options.attachEvents=true] - Si false, ne pas attacher les √©v√©nements (popup, tooltip).\r\n     * @param {string} [options.pane] - Nom du pane Leaflet √† utiliser pour le z-index.\r\n     * @returns {L.Marker|null} Marqueur Leaflet ou null si invalide.\r\n     */\r\n    function createMarker(poi, options = {}) {\r\n        if (!poi) {\r\n            if (Log) Log.warn(\"[POI] createMarker() : POI invalide.\", poi);\r\n            return null;\r\n        }\r\n\r\n        const { attachEvents = true, pane } = options;\r\n\r\n        // Extraction coordonn√©es\r\n        const coords = extractMarkerCoordinates(poi);\r\n        if (!coords) {\r\n            return null;\r\n        }\r\n\r\n        const [lat, lon] = coords;\r\n\r\n        // R√©solution de l'affichage (ic√¥ne et couleurs)\r\n        const displayConfig = resolveCategoryDisplay(poi);\r\n\r\n        // Construction de l'ic√¥ne Leaflet\r\n        const customIcon = buildMarkerIcon(displayConfig);\r\n\r\n        // Options du marker avec pane si fourni\r\n        const markerOptions = { icon: customIcon };\r\n        if (pane) {\r\n            markerOptions.pane = pane;\r\n        }\r\n\r\n        // Cr√©ation du marqueur Leaflet avec le pane\r\n        const marker = L.marker([lat, lon], markerOptions);\r\n\r\n        // Attacher √©v√©nements et comportements (sauf si d√©sactiv√©)\r\n        if (attachEvents) {\r\n            attachMarkerEvents(marker, poi);\r\n        }\r\n\r\n        return marker;\r\n    }\r\n\r\n    // ========================================\r\n    //   EXPORT\r\n    // ========================================\r\n\r\n    GeoLeaf._POIMarkers = {\r\n        getPoiBaseConfig,\r\n        resolveCategoryDisplay,\r\n        ensureProfileSpriteInjectedSync,\r\n        extractMarkerCoordinates,\r\n        buildMarkerIcon,\r\n        attachMarkerEvents,\r\n        createMarker\r\n    };\r\n\r\n})(typeof window !== \"undefined\" ? window : global);\r\n","/**\r\n * @fileoverview Abstract Renderer Base Class\r\n * @description Base class providing common functionality for all renderers\r\n * @version 1.0.0\r\n * @phase Phase 5 - Code Optimization\r\n *\r\n * @author GeoLeaf Team\r\n * @since 3.1.0\r\n *\r\n * @benefits\r\n * - Eliminates ~20% code duplication across renderers\r\n * - Unified dependency resolution pattern\r\n * - Consistent error handling and logging\r\n * - Easier testing and maintenance\r\n */\r\n\r\n(function (global) {\r\n    'use strict';\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    if (!GeoLeaf._Renderers) GeoLeaf._Renderers = {};\r\n\r\n    /**\r\n     * @class AbstractRenderer\r\n     * @description Base class for all renderer implementations\r\n     *\r\n     * Common Patterns Extracted:\r\n     * - Dependency resolution (Log, Security, Config, Utils)\r\n     * - DOM element creation helpers\r\n     * - Event handler registration/cleanup\r\n     * - State management\r\n     * - Error handling and logging\r\n     *\r\n     * @example\r\n     * class MyCustomRenderer extends AbstractRenderer {\r\n     *     constructor(options) {\r\n     *         super(options);\r\n     *         this.init();\r\n     *     }\r\n     *\r\n     *     render(data) {\r\n     *         this.log('info', 'Rendering data', data);\r\n     *         const element = this.createElement('div', 'my-class');\r\n     *         // ... custom rendering logic\r\n     *         return element;\r\n     *     }\r\n     * }\r\n     */\r\n    class AbstractRenderer {\r\n        /**\r\n         * @constructor\r\n         * @param {Object} [options={}] - Renderer configuration options\r\n         * @param {string} [options.name='Renderer'] - Renderer name for logging\r\n         * @param {Object} [options.config={}] - Custom configuration\r\n         * @param {boolean} [options.debug=false] - Enable debug logging\r\n         */\r\n        constructor(options = {}) {\r\n            /**\r\n             * @private\r\n             * @type {string}\r\n             */\r\n            this._name = options.name || 'Renderer';\r\n\r\n            /**\r\n             * @private\r\n             * @type {Object}\r\n             */\r\n            this._config = options.config || {};\r\n\r\n            /**\r\n             * @private\r\n             * @type {boolean}\r\n             */\r\n            this._debug = options.debug || false;\r\n\r\n            /**\r\n             * @private\r\n             * @type {Array<Function>}\r\n             */\r\n            this._eventListeners = [];\r\n\r\n            /**\r\n             * @private\r\n             * @type {boolean}\r\n             */\r\n            this._initialized = false;\r\n\r\n            /**\r\n             * @private\r\n             * @type {WeakMap<HTMLElement, Object>}\r\n             */\r\n            this._stateMap = new WeakMap();\r\n        }\r\n\r\n        // ========================================\r\n        //   DEPENDENCY RESOLUTION\r\n        // ========================================\r\n\r\n        /**\r\n         * Get Log utility with fallback\r\n         * @protected\r\n         * @returns {Object} Log object\r\n         */\r\n        getLog() {\r\n            return GeoLeaf.Log || console;\r\n        }\r\n\r\n        /**\r\n         * Get Security utilities with fallback\r\n         * @protected\r\n         * @returns {Object} Security object with escapeHtml function\r\n         */\r\n        getSecurity() {\r\n            if (GeoLeaf.Security && typeof GeoLeaf.Security.escapeHtml === 'function') {\r\n                return GeoLeaf.Security;\r\n            }\r\n            // Fallback security utilities\r\n            return {\r\n                escapeHtml: (str) => {\r\n                    if (str == null) return '';\r\n                    const div = document.createElement('div');\r\n                    div.textContent = String(str);\r\n                    return div.innerHTML;\r\n                },\r\n                setSafeHTML: (element, html) => {\r\n                    if (!element) return;\r\n                    if (GeoLeaf.DOMSecurity && typeof GeoLeaf.DOMSecurity.setSafeHTML === 'function') {\r\n                        GeoLeaf.DOMSecurity.setSafeHTML(element, html);\r\n                    } else {\r\n                        element.textContent = html; // Safe fallback\r\n                    }\r\n                }\r\n            };\r\n        }\r\n\r\n        /**\r\n         * Get Utils with field resolution\r\n         * @protected\r\n         * @returns {Object} Utils object with resolveField function\r\n         */\r\n        getUtils() {\r\n            if (GeoLeaf.Utils && typeof GeoLeaf.Utils.resolveField === 'function') {\r\n                return GeoLeaf.Utils;\r\n            }\r\n            // Fallback resolveField implementation\r\n            return {\r\n                resolveField: (obj, ...paths) => {\r\n                    if (!obj) return null;\r\n                    for (const path of paths) {\r\n                        if (!path) continue;\r\n                        const parts = String(path).split('.');\r\n                        let current = obj;\r\n                        let found = true;\r\n                        for (const part of parts) {\r\n                            if (current && typeof current === 'object' && part in current) {\r\n                                current = current[part];\r\n                            } else {\r\n                                found = false;\r\n                                break;\r\n                            }\r\n                        }\r\n                        if (found && current !== undefined && current !== null) {\r\n                            return current;\r\n                        }\r\n                    }\r\n                    return null;\r\n                }\r\n            };\r\n        }\r\n\r\n        /**\r\n         * Get active profile configuration\r\n         * @protected\r\n         * @returns {Object|null} Active profile or null\r\n         */\r\n        getActiveProfile() {\r\n            if (GeoLeaf.Config && typeof GeoLeaf.Config.getActiveProfile === 'function') {\r\n                return GeoLeaf.Config.getActiveProfile() || null;\r\n            }\r\n            return null;\r\n        }\r\n\r\n        // ========================================\r\n        //   LOGGING UTILITIES\r\n        // ========================================\r\n\r\n        /**\r\n         * Log message with level\r\n         * @protected\r\n         * @param {string} level - Log level (debug, info, warn, error)\r\n         * @param {string} message - Log message\r\n         * @param {...*} args - Additional arguments\r\n         */\r\n        log(level, message, ...args) {\r\n            if (level === 'debug' && !this._debug) return;\r\n\r\n            const log = this.getLog();\r\n            const prefix = `[${this._name}]`;\r\n\r\n            switch (level) {\r\n                case 'debug':\r\n                case 'info':\r\n                    log.info(prefix, message, ...args);\r\n                    break;\r\n                case 'warn':\r\n                    log.warn(prefix, message, ...args);\r\n                    break;\r\n                case 'error':\r\n                    log.error(prefix, message, ...args);\r\n                    break;\r\n                default:\r\n                    log.info(prefix, message, ...args);\r\n            }\r\n        }\r\n\r\n        /**\r\n         * Log debug message (if debug enabled)\r\n         * @protected\r\n         * @param {string} message - Debug message\r\n         * @param {...*} args - Additional arguments\r\n         */\r\n        debug(message, ...args) {\r\n            this.log('debug', message, ...args);\r\n        }\r\n\r\n        /**\r\n         * Log info message\r\n         * @protected\r\n         * @param {string} message - Info message\r\n         * @param {...*} args - Additional arguments\r\n         */\r\n        info(message, ...args) {\r\n            this.log('info', message, ...args);\r\n        }\r\n\r\n        /**\r\n         * Log warning message\r\n         * @protected\r\n         * @param {string} message - Warning message\r\n         * @param {...*} args - Additional arguments\r\n         */\r\n        warn(message, ...args) {\r\n            this.log('warn', message, ...args);\r\n        }\r\n\r\n        /**\r\n         * Log error message\r\n         * @protected\r\n         * @param {string} message - Error message\r\n         * @param {...*} args - Additional arguments\r\n         */\r\n        error(message, ...args) {\r\n            this.log('error', message, ...args);\r\n        }\r\n\r\n        // ========================================\r\n        //   DOM BUILDERS\r\n        // ========================================\r\n\r\n        /**\r\n         * Create DOM element with class and attributes\r\n         * @protected\r\n         * @param {string} tagName - HTML tag name\r\n         * @param {string|Array<string>} [className] - CSS class name(s)\r\n         * @param {Object} [attributes={}] - HTML attributes\r\n         * @returns {HTMLElement} Created element\r\n         *\r\n         * @example\r\n         * const div = this.createElement('div', 'my-class', { id: 'my-id', 'data-value': '123' });\r\n         * const button = this.createElement('button', ['btn', 'btn-primary'], { type: 'button' });\r\n         */\r\n        createElement(tagName, className, attributes = {}) {\r\n            const element = document.createElement(tagName);\r\n\r\n            if (className) {\r\n                if (Array.isArray(className)) {\r\n                    element.classList.add(...className);\r\n                } else {\r\n                    element.className = className;\r\n                }\r\n            }\r\n\r\n            Object.keys(attributes).forEach(key => {\r\n                element.setAttribute(key, attributes[key]);\r\n            });\r\n\r\n            return element;\r\n        }\r\n\r\n        /**\r\n         * Create text node with safe content\r\n         * @protected\r\n         * @param {string} text - Text content\r\n         * @returns {Text} Text node\r\n         */\r\n        createTextNode(text) {\r\n            return document.createTextNode(text || '');\r\n        }\r\n\r\n        /**\r\n         * Create element with safe text content\r\n         * @protected\r\n         * @param {string} tagName - HTML tag name\r\n         * @param {string} text - Text content\r\n         * @param {string} [className] - CSS class name\r\n         * @returns {HTMLElement} Element with text\r\n         */\r\n        createTextElement(tagName, text, className) {\r\n            const element = this.createElement(tagName, className);\r\n            element.textContent = text || '';\r\n            return element;\r\n        }\r\n\r\n        /**\r\n         * Create element with safe HTML content\r\n         * @protected\r\n         * @param {string} tagName - HTML tag name\r\n         * @param {string} html - HTML content (will be sanitized)\r\n         * @param {string} [className] - CSS class name\r\n         * @returns {HTMLElement} Element with HTML\r\n         */\r\n        createHTMLElement(tagName, html, className) {\r\n            const element = this.createElement(tagName, className);\r\n            const security = this.getSecurity();\r\n            security.setSafeHTML(element, html);\r\n            return element;\r\n        }\r\n\r\n        /**\r\n         * Append multiple children to parent element\r\n         * @protected\r\n         * @param {HTMLElement} parent - Parent element\r\n         * @param {...HTMLElement} children - Child elements to append\r\n         * @returns {HTMLElement} Parent element (for chaining)\r\n         */\r\n        appendChildren(parent, ...children) {\r\n            children.forEach(child => {\r\n                if (child) parent.appendChild(child);\r\n            });\r\n            return parent;\r\n        }\r\n\r\n        // ========================================\r\n        //   EVENT HANDLING\r\n        // ========================================\r\n\r\n        /**\r\n         * Register event listener with automatic cleanup\r\n         * @protected\r\n         * @param {HTMLElement} element - Target element\r\n         * @param {string} event - Event name\r\n         * @param {Function} handler - Event handler\r\n         * @param {Object} [options] - Event listener options\r\n         * @returns {Function} Cleanup function\r\n         */\r\n        addEventListener(element, event, handler, options) {\r\n            if (!element || !event || !handler) {\r\n                this.warn('addEventListener: invalid parameters');\r\n                return () => {};\r\n            }\r\n\r\n            const boundHandler = handler.bind(this);\r\n            element.addEventListener(event, boundHandler, options);\r\n\r\n            // Store for cleanup\r\n            const cleanup = () => {\r\n                element.removeEventListener(event, boundHandler, options);\r\n            };\r\n            this._eventListeners.push(cleanup);\r\n\r\n            return cleanup;\r\n        }\r\n\r\n        /**\r\n         * Remove all registered event listeners\r\n         * @protected\r\n         */\r\n        removeAllEventListeners() {\r\n            this._eventListeners.forEach(cleanup => cleanup());\r\n            this._eventListeners = [];\r\n        }\r\n\r\n        // ========================================\r\n        //   STATE MANAGEMENT\r\n        // ========================================\r\n\r\n        /**\r\n         * Set element state\r\n         * @protected\r\n         * @param {HTMLElement} element - Element to store state for\r\n         * @param {Object} state - State data\r\n         */\r\n        setState(element, state) {\r\n            if (element) {\r\n                this._stateMap.set(element, { ...state });\r\n            }\r\n        }\r\n\r\n        /**\r\n         * Get element state\r\n         * @protected\r\n         * @param {HTMLElement} element - Element to get state from\r\n         * @returns {Object|null} Element state or null\r\n         */\r\n        getState(element) {\r\n            return element ? this._stateMap.get(element) || null : null;\r\n        }\r\n\r\n        /**\r\n         * Update element state (merge with existing)\r\n         * @protected\r\n         * @param {HTMLElement} element - Element to update state for\r\n         * @param {Object} updates - State updates to merge\r\n         */\r\n        updateState(element, updates) {\r\n            if (element) {\r\n                const currentState = this.getState(element) || {};\r\n                this.setState(element, { ...currentState, ...updates });\r\n            }\r\n        }\r\n\r\n        /**\r\n         * Delete element state\r\n         * @protected\r\n         * @param {HTMLElement} element - Element to delete state for\r\n         */\r\n        deleteState(element) {\r\n            if (element) {\r\n                this._stateMap.delete(element);\r\n            }\r\n        }\r\n\r\n        // ========================================\r\n        //   LIFECYCLE METHODS\r\n        // ========================================\r\n\r\n        /**\r\n         * Initialize renderer (called in constructor or manually)\r\n         * Override in subclasses for custom initialization\r\n         * @protected\r\n         */\r\n        init() {\r\n            if (this._initialized) {\r\n                this.warn('Renderer already initialized');\r\n                return;\r\n            }\r\n\r\n            this.debug('Initializing renderer');\r\n            this._initialized = true;\r\n        }\r\n\r\n        /**\r\n         * Check if renderer is initialized\r\n         * @public\r\n         * @returns {boolean} true if initialized\r\n         */\r\n        isInitialized() {\r\n            return this._initialized;\r\n        }\r\n\r\n        /**\r\n         * Destroy renderer and cleanup resources\r\n         * @public\r\n         */\r\n        destroy() {\r\n            this.debug('Destroying renderer');\r\n            this.removeAllEventListeners();\r\n            this._stateMap = new WeakMap();\r\n            this._initialized = false;\r\n        }\r\n\r\n        // ========================================\r\n        //   ABSTRACT METHODS (to be overridden)\r\n        // ========================================\r\n\r\n        /**\r\n         * Render content (must be implemented by subclasses)\r\n         * @abstract\r\n         * @param {*} data - Data to render\r\n         * @param {Object} [options] - Render options\r\n         * @returns {HTMLElement|string|null} Rendered content\r\n         * @throws {Error} If not implemented\r\n         */\r\n        render(data, options) {\r\n            throw new Error(`${this._name}.render() must be implemented by subclass`);\r\n        }\r\n    }\r\n\r\n    // Export to GeoLeaf namespace\r\n    GeoLeaf._Renderers.AbstractRenderer = AbstractRenderer;\r\n\r\n    if (GeoLeaf.Log) {\r\n        GeoLeaf.Log.info('[GeoLeaf._Renderers.AbstractRenderer] Base class loaded');\r\n    }\r\n\r\n})(window);\r\n","/**\n * POI Renderers - Field Renderers Module (Migrated to AbstractRenderer)\n * Rendu des champs simples: texte, badges, liens, tags\n *\n * @module poi/renderers/field-renderers\n * @requires renderers/abstract-renderer\n * @version 2.0.0 - Migrated to AbstractRenderer base class\n */\n((global) => {\n    'use strict';\n\n    const GeoLeaf = global.GeoLeaf || {};\n\n    // Ensure AbstractRenderer is loaded\n    if (!GeoLeaf._Renderers || !GeoLeaf._Renderers.AbstractRenderer) {\n        if (GeoLeaf.Log) {\n            GeoLeaf.Log.error('[FieldRenderers] AbstractRenderer not loaded! Load abstract-renderer.js first.');\n        }\n        return;\n    }\n\n    const AbstractRenderer = GeoLeaf._Renderers.AbstractRenderer;\n\n    /**\n     * @class FieldRenderers\n     * @extends AbstractRenderer\n     * @description Renders simple POI fields: text, badges, links, tags\n     */\n    class FieldRenderers extends AbstractRenderer {\n        constructor(options = {}) {\n            super({\n                name: 'FieldRenderers',\n                debug: options.debug || false,\n                config: options.config || {}\n            });\n            this.init();\n        }\n\n        /**\n         * Render method (required by AbstractRenderer)\n         * Delegates to specific render methods\n         * @param {Object} data - Render data {section, poi, value, type}\n         * @returns {HTMLElement|null} Rendered element\n         */\n        render(data) {\n            const { section, poi, value, type } = data;\n\n            switch (type) {\n                case 'text':\n                    return this.renderText(section, poi, value);\n                case 'badge':\n                    return this.renderBadge(section, value, poi);\n                case 'link':\n                    return this.renderLink(section, value);\n                case 'tags':\n                    return this.renderTags(section, value);\n                default:\n                    this.warn('Unknown render type:', type);\n                    return null;\n            }\n        }\n\n        /**\n         * Rend un champ texte (title, description, etc.)\n         * @param {Object} section - Section config\n         * @param {Object} poi - POI data\n         * @param {string} value - Text value\n         * @returns {HTMLElement|null}\n         */\n        async renderText(section, poi, value) {\n            const security = this.getSecurity();\n\n            // Cas sp√©cial pour le titre avec ic√¥ne\n            if (section.style === 'title' || section.variant === 'title') {\n                return await this._renderTitleWithIcon(poi, value);\n            }\n\n            // Texte normal ou multiline\n            if (!value) {\n                this.warn('renderText: no value provided');\n                return null;\n            }\n\n            const element = this.createElement(\n                section.variant === 'multiline' ? 'div' : 'p',\n                'gl-poi-sidepanel__desc'\n            );\n\n            if (section.variant === 'multiline') {\n                element.style.whiteSpace = 'pre-wrap';\n                element.style.lineHeight = '1.6';\n            }\n\n            element.textContent = value;\n            this.info('renderText: element created, variant:', section.variant || 'normal');\n\n            return element;\n        }\n\n        /**\n         * Rend un titre avec ic√¥ne SVG\n         * @private\n         * @param {Object} poi - POI data\n         * @param {string} value - Title text\n         * @returns {HTMLElement}\n         */\n        async _renderTitleWithIcon(poi, value) {\n            const titleH2 = this.createElement('h2', 'gl-poi-sidepanel__title');\n\n            // Ajouter l'ic√¥ne SVG au titre\n            const markers = this._getMarkers();\n            if (markers && markers.resolveCategoryDisplay && markers.ensureProfileSpriteInjectedSync) {\n                const displayInfo = markers.resolveCategoryDisplay(poi);\n                this.debug('_renderTitleWithIcon: displayInfo =', displayInfo);\n\n                if (displayInfo.iconId) {\n                    await markers.ensureProfileSpriteInjectedSync();\n\n                    const svgIcon = this._createCategoryIcon(displayInfo);\n                    if (svgIcon) {\n                        this.debug('_renderTitleWithIcon: SVG icon created successfully');\n                        titleH2.appendChild(svgIcon);\n                    } else {\n                        this.warn('_renderTitleWithIcon: SVG icon creation failed');\n                    }\n                } else {\n                    this.debug('_renderTitleWithIcon: No iconId in displayInfo');\n                }\n            } else {\n                this.warn('_renderTitleWithIcon: Markers or required methods not available');\n            }\n\n            // Ajouter le texte du titre\n            const titleSpan = this.createTextElement('span',\n                value || poi.title || poi.label || poi.name || 'POI',\n                'gl-poi-sidepanel__title-text'\n            );\n            titleH2.appendChild(titleSpan);\n\n            this.info('renderText: title element created with icon');\n            return titleH2;\n        }\n\n        /**\n         * Cr√©e une ic√¥ne SVG de cat√©gorie\n         * @private\n         * @param {Object} displayInfo - Display information {iconId, colorFill, colorStroke}\n         * @returns {SVGElement|null}\n         */\n        _createCategoryIcon(displayInfo) {\n            // R√©cup√©rer la config d'ic√¥nes depuis GeoLeaf.Config\n            const iconsConfig = (GeoLeaf.Config && typeof GeoLeaf.Config.getIconsConfig === 'function')\n                ? GeoLeaf.Config.getIconsConfig()\n                : null;\n\n            const iconPrefix = (iconsConfig && iconsConfig.symbolPrefix) || \"gl-poi-cat-\";\n            const iconIdNormalized = String(displayInfo.iconId).trim().toLowerCase().replace(/\\s+/g, '-');\n            const symbolId = iconPrefix + iconIdNormalized;\n\n            this.debug('_createCategoryIcon: symbolId =', symbolId, ', colors =', displayInfo.colorFill, displayInfo.colorStroke);\n            this.debug('_createCategoryIcon: iconPrefix from config =', iconPrefix);\n\n            // V√©rifier si le sprite existe dans le DOM\n            const sprite = document.querySelector('svg[data-geoleaf-sprite=\"profile\"]');\n            if (!sprite) {\n                this.warn('_createCategoryIcon: Sprite SVG non trouv√© dans le DOM! Le sprite doit √™tre charg√© avant.');\n            } else {\n                this.debug('_createCategoryIcon: Sprite trouv√©, nombre de symboles:', sprite.querySelectorAll('symbol').length);\n            }\n\n            // V√©rifier si le symbole existe dans le sprite\n            const spriteSymbol = sprite ? sprite.querySelector(`#${symbolId}`) : null;\n            if (!spriteSymbol) {\n                this.warn('_createCategoryIcon: Symbole non trouv√© dans le sprite:', symbolId);\n                if (sprite) {\n                    // Lister les symboles disponibles pour debug\n                    const availableSymbols = Array.from(sprite.querySelectorAll('symbol')).map(s => s.id).slice(0, 5);\n                    this.debug('_createCategoryIcon: Premiers symboles disponibles:', availableSymbols);\n                }\n            }\n\n            const svgIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');\n            svgIcon.setAttribute('width', '32');\n            svgIcon.setAttribute('height', '32');\n            svgIcon.setAttribute('viewBox', '0 0 24 24');\n            svgIcon.setAttribute('class', 'gl-poi-sidepanel__icon');\n            svgIcon.style.marginRight = '10px';\n            svgIcon.style.flexShrink = '0';\n\n            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');\n            circle.setAttribute('cx', '12');\n            circle.setAttribute('cy', '12');\n            circle.setAttribute('r', '10');\n            circle.setAttribute('fill', displayInfo.colorFill || '#3388ff');\n            circle.setAttribute('stroke', displayInfo.colorStroke || '#fff');\n            circle.setAttribute('stroke-width', '1.5');\n\n            svgIcon.appendChild(circle);\n\n            // Ajouter le symbole uniquement s'il existe\n            if (spriteSymbol) {\n                // SVG imbriqu√© pour le symbole (comme dans le popup)\n                const innerSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');\n                innerSvg.setAttribute('x', '4');\n                innerSvg.setAttribute('y', '4');\n                innerSvg.setAttribute('width', '16');\n                innerSvg.setAttribute('height', '16');\n                innerSvg.setAttribute('viewBox', '0 0 32 32');\n\n                const use = document.createElementNS('http://www.w3.org/2000/svg', 'use');\n                use.setAttributeNS('http://www.w3.org/1999/xlink', 'xlink:href', '#' + symbolId);\n                use.setAttribute('href', '#' + symbolId);\n                use.style.color = '#ffffff';\n\n                innerSvg.appendChild(use);\n                svgIcon.appendChild(innerSvg);\n            }\n\n            this.debug('_createCategoryIcon: SVG structure created');\n            return svgIcon;\n        }\n\n        /**\n         * Rend un badge (cat√©gorie, sous-cat√©gorie)\n         * @param {Object} section - Section config\n         * @param {string} value - Badge text\n         * @param {Object} poi - POI data\n         * @returns {HTMLElement|null}\n         */\n        renderBadge(section, value, poi) {\n            if (!value) return null;\n\n            const container = this.createElement('div', 'gl-poi-badge-container');\n            const badge = this.createTextElement('span', value, 'gl-poi-badge');\n\n            // R√©cup√©rer les couleurs depuis la taxonomie\n            const markers = this._getMarkers();\n            if (markers && markers.resolveCategoryDisplay) {\n                const displayInfo = markers.resolveCategoryDisplay(poi);\n                if (displayInfo.colorFill) {\n                    badge.style.background = displayInfo.colorFill;\n                    badge.style.color = '#fff';\n                }\n            }\n\n            container.appendChild(badge);\n            return container;\n        }\n\n        /**\n         * Rend un lien (website, etc.)\n         * @param {Object} section - Section config\n         * @param {string} url - URL\n         * @returns {HTMLElement|null}\n         */\n        renderLink(section, url) {\n            if (!url) return null;\n\n            const linkP = this.createElement('p', 'gl-poi-sidepanel__link');\n            const anchor = this.createElement('a', null, {\n                href: url,\n                target: '_blank',\n                rel: 'noopener noreferrer'\n            });\n\n            anchor.textContent = section.linkText || url;\n            linkP.appendChild(anchor);\n\n            return linkP;\n        }\n\n        /**\n         * Rend une liste de tags\n         * @param {Object} section - Section config\n         * @param {Array<string>} tags - Tags array\n         * @returns {HTMLElement|null}\n         */\n        renderTags(section, tags) {\n            if (!tags || !Array.isArray(tags) || tags.length === 0) return null;\n\n            const tagsDiv = this.createElement('div', 'gl-poi-sidepanel__tags');\n\n            tags.forEach(tag => {\n                if (tag) {\n                    const tagSpan = this.createTextElement('span', tag, 'gl-poi-tag');\n                    tagsDiv.appendChild(tagSpan);\n                }\n            });\n\n            return tagsDiv;\n        }\n\n        /**\n         * Get POI Markers module\n         * @private\n         * @returns {Object|null}\n         */\n        _getMarkers() {\n            return GeoLeaf._POIMarkers || null;\n        }\n    }\n\n    // Export to namespace\n    if (!GeoLeaf.POI) GeoLeaf.POI = {};\n    if (!GeoLeaf.POI.Renderers) GeoLeaf.POI.Renderers = {};\n\n    GeoLeaf.POI.Renderers.FieldRenderers = FieldRenderers;\n\n    // Lazy singleton instance for backward compatibility\n    let instance = null;\n    const getInstance = () => {\n        if (!instance) {\n            instance = new FieldRenderers();\n        }\n        return instance;\n    };\n\n    GeoLeaf.POI.Renderers.renderText = (section, poi, value) =>\n        getInstance().renderText(section, poi, value);\n\n    GeoLeaf.POI.Renderers.renderBadge = (section, value, poi) =>\n        getInstance().renderBadge(section, value, poi);\n\n    GeoLeaf.POI.Renderers.renderLink = (section, url) =>\n        getInstance().renderLink(section, url);\n\n    GeoLeaf.POI.Renderers.renderTags = (section, tags) =>\n        getInstance().renderTags(section, tags);\n\n    if (GeoLeaf.Log) {\n        GeoLeaf.Log.info('[POI.Renderers.FieldRenderers] Loaded (v2.0 - AbstractRenderer)');\n    }\n\n})(window);\n","/**\r\n * POI Renderers - Media Renderers Module (Migrated to AbstractRenderer)\r\n * Rendu des m√©dias: images, galeries, lightbox\r\n *\r\n * @module poi/renderers/media-renderers\r\n * @requires renderers/abstract-renderer\r\n * @version 2.0.0 - Migrated to AbstractRenderer base class\r\n */\r\n((global) => {\r\n    'use strict';\r\n\r\n    const GeoLeaf = global.GeoLeaf || {};\r\n\r\n    // Ensure AbstractRenderer is loaded\r\n    if (!GeoLeaf._Renderers || !GeoLeaf._Renderers.AbstractRenderer) {\r\n        console.error('[MediaRenderers] AbstractRenderer not loaded! Load abstract-renderer.js first.');\r\n        return;\r\n    }\r\n\r\n    const AbstractRenderer = GeoLeaf._Renderers.AbstractRenderer;\r\n\r\n    /**\r\n     * @class MediaRenderers\r\n     * @extends AbstractRenderer\r\n     * @description Renders media elements: images, galleries, lightbox\r\n     */\r\n    class MediaRenderers extends AbstractRenderer {\r\n        constructor(options = {}) {\r\n            super({\r\n                name: 'MediaRenderers',\r\n                debug: options.debug || false,\r\n                config: options.config || {}\r\n            });\r\n            this.init();\r\n        }\r\n\r\n        /**\r\n         * Render method (required by AbstractRenderer)\r\n         * @param {Object} data - Render data {section, value, type}\r\n         * @returns {HTMLElement|null} Rendered element\r\n         */\r\n        render(data) {\r\n            const { section, value, type } = data;\r\n\r\n            switch (type) {\r\n                case 'image':\r\n                    return this.renderImage(section, value);\r\n                case 'gallery':\r\n                    return this.renderGallery(section, value);\r\n                default:\r\n                    this.warn('Unknown media render type:', type);\r\n                    return null;\r\n            }\r\n        }\r\n\r\n        /**\r\n         * Rend une image (hero ou normale)\r\n         * @param {Object} section - Section config\r\n         * @param {string} imageUrl - Image URL\r\n         * @returns {HTMLElement|null}\r\n         */\r\n        renderImage(section, imageUrl) {\r\n            if (!imageUrl) return null;\r\n\r\n            const className = section.variant === 'hero'\r\n                ? 'gl-poi-sidepanel__photo gl-poi-sidepanel__photo--hero'\r\n                : 'gl-poi-sidepanel__photo';\r\n\r\n            const photoDiv = this.createElement('div', className);\r\n            const img = this.createElement('img', null, {\r\n                src: imageUrl,\r\n                alt: section.label || 'Photo',\r\n                loading: 'lazy'\r\n            });\r\n\r\n            photoDiv.appendChild(img);\r\n            return photoDiv;\r\n        }\r\n\r\n        /**\r\n         * Rend une galerie d'images avec miniatures\r\n         * @param {Object} section - Section config\r\n         * @param {Array<string>} gallery - Array of image URLs\r\n         * @returns {HTMLElement|null}\r\n         */\r\n        renderGallery(section, gallery) {\r\n            if (!gallery || !Array.isArray(gallery) || gallery.length === 0) {\r\n                this.warn('renderGallery: invalid gallery data', gallery);\r\n                return null;\r\n            }\r\n\r\n            this.info('renderGallery: rendering', gallery.length, 'images');\r\n\r\n            const galleryDiv = this.createElement('div', 'gl-poi-gallery');\r\n\r\n            // Image principale\r\n            const mainDiv = this._createMainImage(gallery[0]);\r\n            galleryDiv.appendChild(mainDiv);\r\n\r\n            // Miniatures si plusieurs images\r\n            if (gallery.length > 1) {\r\n                const thumbsDiv = this._createThumbnails(gallery, mainDiv);\r\n                galleryDiv.appendChild(thumbsDiv);\r\n            }\r\n\r\n            return galleryDiv;\r\n        }\r\n\r\n        /**\r\n         * Cr√©e l'image principale de la galerie\r\n         * @private\r\n         * @param {string} imageUrl - Image URL\r\n         * @returns {HTMLElement}\r\n         */\r\n        _createMainImage(imageUrl) {\r\n            const mainDiv = this.createElement('div', 'gl-poi-gallery__main', {\r\n                'data-gallery-index': '0'\r\n            });\r\n\r\n            const mainImg = this.createElement('img', null, {\r\n                src: imageUrl,\r\n                alt: 'Image 1',\r\n                loading: 'lazy'\r\n            });\r\n\r\n            mainDiv.appendChild(mainImg);\r\n            return mainDiv;\r\n        }\r\n\r\n        /**\r\n         * Cr√©e les miniatures de la galerie\r\n         * @private\r\n         * @param {Array<string>} gallery - Array of image URLs\r\n         * @param {HTMLElement} mainDiv - Main image container\r\n         * @returns {HTMLElement}\r\n         */\r\n        _createThumbnails(gallery, mainDiv) {\r\n            const thumbsDiv = this.createElement('div', 'gl-poi-gallery__thumbnails');\r\n            const mainImg = mainDiv.querySelector('img');\r\n\r\n            gallery.forEach((imgUrl, index) => {\r\n                const thumbDiv = this._createThumbnail(imgUrl, index, mainImg, mainDiv, thumbsDiv);\r\n                thumbsDiv.appendChild(thumbDiv);\r\n            });\r\n\r\n            return thumbsDiv;\r\n        }\r\n\r\n        /**\r\n         * Cr√©e une miniature individuelle\r\n         * @private\r\n         * @param {string} imgUrl - Image URL\r\n         * @param {number} index - Image index\r\n         * @param {HTMLElement} mainImg - Main image element\r\n         * @param {HTMLElement} mainDiv - Main image container\r\n         * @param {HTMLElement} thumbsDiv - Thumbnails container\r\n         * @returns {HTMLElement}\r\n         */\r\n        _createThumbnail(imgUrl, index, mainImg, mainDiv, thumbsDiv) {\r\n            const thumbDiv = this.createElement('div',\r\n                index === 0 ? 'gl-poi-gallery__thumb active' : 'gl-poi-gallery__thumb',\r\n                { 'data-index': index.toString() }\r\n            );\r\n\r\n            const imgThumb = this.createElement('img', null, {\r\n                src: imgUrl,\r\n                alt: `Image ${index + 1}`,\r\n                loading: 'lazy'\r\n            });\r\n\r\n            thumbDiv.appendChild(imgThumb);\r\n\r\n            // Event listener pour changer l'image principale\r\n            this.addEventListener(thumbDiv, 'click', (e) => {\r\n                e.preventDefault();\r\n                e.stopPropagation();\r\n\r\n                // Retirer la classe active de toutes les miniatures\r\n                const allThumbs = thumbsDiv.querySelectorAll('.gl-poi-gallery__thumb');\r\n                allThumbs.forEach(t => t.classList.remove('active'));\r\n\r\n                // Ajouter la classe active √† la miniature cliqu√©e\r\n                thumbDiv.classList.add('active');\r\n\r\n                // Changer l'image principale\r\n                mainImg.src = imgUrl;\r\n                mainImg.alt = `Image ${index + 1}`;\r\n                mainDiv.setAttribute('data-gallery-index', index.toString());\r\n\r\n                this.info('Gallery: Switched to image', index + 1);\r\n            }, true);\r\n\r\n            return thumbDiv;\r\n        }\r\n\r\n        /**\r\n         * Cleanup when gallery is destroyed\r\n         * @override\r\n         */\r\n        destroy() {\r\n            this.debug('Destroying MediaRenderers');\r\n            super.destroy();\r\n        }\r\n    }\r\n\r\n    // Export to namespace\r\n    if (!GeoLeaf.POI) GeoLeaf.POI = {};\r\n    if (!GeoLeaf.POI.Renderers) GeoLeaf.POI.Renderers = {};\r\n\r\n    GeoLeaf.POI.Renderers.MediaRenderers = MediaRenderers;\r\n\r\n    // Lazy singleton instance for backward compatibility\r\n    let instance = null;\r\n    const getInstance = () => {\r\n        if (!instance) {\r\n            instance = new MediaRenderers();\r\n        }\r\n        return instance;\r\n    };\r\n\r\n    GeoLeaf.POI.Renderers.renderImage = (section, imageUrl) =>\r\n        getInstance().renderImage(section, imageUrl);\r\n\r\n    GeoLeaf.POI.Renderers.renderGallery = (section, gallery) =>\r\n        getInstance().renderGallery(section, gallery);\r\n\r\n    if (GeoLeaf.Log) {\r\n        GeoLeaf.Log.info('[POI.Renderers.MediaRenderers] Loaded (v2.0 - AbstractRenderer)');\r\n    }\r\n\r\n})(window);\r\n","/**\r\n * GeoLeaf POI Module - Lightbox Manager\r\n * Gestion de l'affichage lightbox pour les images\r\n * Phase 6.2 - Extraction depuis core.js\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n\r\n    /**\r\n     * Gestionnaire de lightbox pour affichage d'images en plein √©cran\r\n     */\r\n    class LightboxManager {\r\n        constructor() {\r\n            this.currentLightbox = null;\r\n            this.closeHandler = null;\r\n        }\r\n\r\n        /**\r\n         * Ouvre une lightbox pour afficher une image en plein √©cran\r\n         * @param {string} imageSrc - URL de l'image √† afficher\r\n         */\r\n        open(imageSrc) {\r\n            // Fermer lightbox pr√©c√©dente si existe\r\n            this.close();\r\n\r\n            const lightbox = document.createElement('div');\r\n            lightbox.className = 'gl-poi-lightbox';\r\n            lightbox.style.cssText = `\r\n                position: fixed;\r\n                top: 0;\r\n                left: 0;\r\n                right: 0;\r\n                bottom: 0;\r\n                background: rgba(0,0,0,0.95);\r\n                z-index: 10000;\r\n                display: flex;\r\n                align-items: center;\r\n                justify-content: center;\r\n                cursor: pointer;\r\n            `;\r\n\r\n            const img = document.createElement('img');\r\n            img.src = imageSrc;\r\n            img.style.cssText = `\r\n                max-width: 90%;\r\n                max-height: 90%;\r\n                object-fit: contain;\r\n            `;\r\n\r\n            lightbox.appendChild(img);\r\n            document.body.appendChild(lightbox);\r\n\r\n            // Stocker r√©f√©rence\r\n            this.currentLightbox = lightbox;\r\n\r\n            // Fermer en cliquant n'importe o√π\r\n            lightbox.addEventListener('click', () => {\r\n                this.close();\r\n            });\r\n\r\n            // Fermer avec Escape\r\n            this.closeHandler = (e) => {\r\n                if (e.key === 'Escape') {\r\n                    this.close();\r\n                }\r\n            };\r\n            document.addEventListener('keydown', this.closeHandler);\r\n        }\r\n\r\n        /**\r\n         * Ferme la lightbox active\r\n         */\r\n        close() {\r\n            if (this.currentLightbox && document.body.contains(this.currentLightbox)) {\r\n                document.body.removeChild(this.currentLightbox);\r\n            }\r\n\r\n            if (this.closeHandler) {\r\n                document.removeEventListener('keydown', this.closeHandler);\r\n                this.closeHandler = null;\r\n            }\r\n\r\n            this.currentLightbox = null;\r\n        }\r\n\r\n        /**\r\n         * V√©rifie si une lightbox est actuellement ouverte\r\n         * @returns {boolean}\r\n         */\r\n        isOpen() {\r\n            return this.currentLightbox !== null && document.body.contains(this.currentLightbox);\r\n        }\r\n    }\r\n\r\n    // Export global\r\n    GeoLeaf.LightboxManager = LightboxManager;\r\n\r\n    // Instance singleton pour usage simple\r\n    GeoLeaf._lightboxManager = new LightboxManager();\r\n\r\n})(typeof window !== \"undefined\" ? window : global);\r\n","/**\r\n * GeoLeaf POI Module - UI Behaviors\r\n * Comportements interactifs pour le side panel (accord√©ons, galeries)\r\n * Phase 6.2 - Extraction depuis core.js\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    const Log = GeoLeaf.Log;\r\n\r\n    /**\r\n     * Comportements UI pour le side panel POI\r\n     */\r\n    const UIBehaviors = {\r\n        /**\r\n         * Attache le comportement d'accord√©on exclusif (un seul ouvert √† la fois)\r\n         * @param {HTMLElement} container - Conteneur parent des accord√©ons\r\n         */\r\n        attachSingleAccordionBehavior(container) {\r\n            const accordions = container.querySelectorAll('details.gl-accordion');\r\n            if (accordions.length === 0) return;\r\n\r\n            accordions.forEach(accordion => {\r\n                accordion.addEventListener('toggle', (event) => {\r\n                    // Si cet accord√©on vient d'√™tre ouvert\r\n                    if (event.target.open) {\r\n                        // Fermer tous les autres accord√©ons\r\n                        accordions.forEach(otherAccordion => {\r\n                            if (otherAccordion !== event.target && otherAccordion.open) {\r\n                                otherAccordion.removeAttribute('open');\r\n                            }\r\n                        });\r\n                    }\r\n                });\r\n            });\r\n\r\n            if (Log) Log.info('[POI] Comportement singleAccordion activ√©:', accordions.length, 'accord√©ons');\r\n        },\r\n\r\n        /**\r\n         * Attache les √©v√©nements de navigation pour une galerie d'images\r\n         * @param {HTMLElement} sidePanelElement - √âl√©ment du side panel\r\n         * @param {LightboxManager} lightboxManager - Instance du gestionnaire de lightbox\r\n         */\r\n        attachGalleryEvents(sidePanelElement, lightboxManager) {\r\n            if (!sidePanelElement) return;\r\n\r\n            // Navigation par miniatures\r\n            const thumbs = sidePanelElement.querySelectorAll('.gl-poi-gallery__thumb');\r\n            const mainImg = sidePanelElement.querySelector('.gl-poi-gallery__main img');\r\n\r\n            if (!mainImg || thumbs.length === 0) return;\r\n\r\n            thumbs.forEach((thumb) => {\r\n                thumb.addEventListener('click', () => {\r\n                    const index = parseInt(thumb.getAttribute('data-index'), 10);\r\n                    const imgSrc = thumb.querySelector('img').src;\r\n\r\n                    // Mettre √† jour l'image principale\r\n                    mainImg.src = imgSrc;\r\n                    mainImg.alt = `Image ${index + 1}`;\r\n\r\n                    // Mettre √† jour l'√©tat actif des miniatures\r\n                    thumbs.forEach(t => t.classList.remove('active'));\r\n                    thumb.classList.add('active');\r\n                });\r\n            });\r\n\r\n            // Clic sur l'image principale pour lightbox\r\n            mainImg.addEventListener('click', () => {\r\n                if (lightboxManager) {\r\n                    lightboxManager.open(mainImg.src);\r\n                }\r\n            });\r\n        },\r\n\r\n        /**\r\n         * Configure tous les comportements UI pour le side panel\r\n         * @param {HTMLElement} container - Conteneur du side panel\r\n         * @param {LightboxManager} lightboxManager - Instance du gestionnaire de lightbox\r\n         */\r\n        setupAll(container, lightboxManager) {\r\n            this.attachSingleAccordionBehavior(container);\r\n            this.attachGalleryEvents(container, lightboxManager);\r\n        }\r\n    };\r\n\r\n    // Export global\r\n    GeoLeaf._POIUIBehaviors = UIBehaviors;\r\n\r\n})(typeof window !== \"undefined\" ? window : global);\r\n","/**\r\n * GeoLeaf POI Module - Component Renderers\r\n * Rendu des composants UI (badges, liens, listes, tableaux, tags)\r\n * Phase 6.2 - Extraction depuis core.js\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    const Log = GeoLeaf.Log;\r\n\r\n    /**\r\n     * Renderers pour les composants UI du side panel\r\n     */\r\n    class ComponentRenderers {\r\n        constructor() {\r\n            // R√©f√©rence aux modules POI\r\n            this.getMarkers = () => GeoLeaf._POIMarkers;\r\n        }\r\n\r\n        /**\r\n         * Rend un badge avec style de cat√©gorie\r\n         * @param {object} section - Configuration de section\r\n         * @param {string} value - Valeur du badge\r\n         * @param {object} poi - POI complet\r\n         * @returns {HTMLElement|null}\r\n         */\r\n        renderBadge(section, value, poi) {\r\n            if (!value) return null;\r\n\r\n            const container = document.createElement('div');\r\n            container.className = 'gl-poi-badge-container';\r\n\r\n            const badge = document.createElement('span');\r\n            badge.className = 'gl-poi-badge';\r\n            badge.textContent = value;\r\n\r\n            // R√©cup√©rer les couleurs depuis la taxonomie si disponible\r\n            const markers = this.getMarkers();\r\n            if (markers && markers.resolveCategoryDisplay) {\r\n                const displayInfo = markers.resolveCategoryDisplay(poi);\r\n                if (displayInfo.colorFill) {\r\n                    badge.style.background = displayInfo.colorFill;\r\n                    badge.style.color = '#fff';\r\n                }\r\n            }\r\n\r\n            container.appendChild(badge);\r\n            return container;\r\n        }\r\n\r\n        /**\r\n         * Rend un lien externe\r\n         * @param {object} section - Configuration de section\r\n         * @param {string} url - URL du lien\r\n         * @returns {HTMLElement|null}\r\n         */\r\n        renderLink(section, url) {\r\n            if (!url) return null;\r\n\r\n            const container = document.createElement('div');\r\n            container.className = 'gl-poi-link-container';\r\n\r\n            const link = document.createElement('a');\r\n            link.className = 'gl-poi-website-link';\r\n            link.href = url;\r\n            link.target = '_blank';\r\n            link.rel = 'noopener noreferrer';\r\n            link.textContent = section.label || 'Visiter le site web ‚Üí';\r\n\r\n            container.appendChild(link);\r\n            return container;\r\n        }\r\n\r\n        /**\r\n         * Rend une liste (tableau de prix, etc.)\r\n         * @param {object} section - Configuration de section\r\n         * @param {Array|object} data - Donn√©es √† afficher\r\n         * @returns {HTMLElement|null}\r\n         */\r\n        renderList(section, data) {\r\n            if (!data) {\r\n                if (Log) Log.warn('[POI] renderList: data is null/undefined');\r\n                return null;\r\n            }\r\n\r\n            const div = document.createElement('div');\r\n            div.className = 'gl-poi-section';\r\n\r\n            // Cas sp√©cial pour price (objet)\r\n            if (typeof data === 'object' && !Array.isArray(data)) {\r\n                if (Log) Log.info('[POI] renderList: price object:', data);\r\n\r\n                if (data.from || data.to) {\r\n                    const p = document.createElement('p');\r\n                    const strong = document.createElement('strong');\r\n\r\n                    const safeFrom = Number.isFinite(Number(data.from)) ? Number(data.from) : null;\r\n                    const safeTo = Number.isFinite(Number(data.to)) ? Number(data.to) : null;\r\n                    const safeCurrency = data.currency || 'USD';\r\n\r\n                    if (safeFrom !== null && safeTo !== null) {\r\n                        strong.textContent = `De ${safeFrom} √† ${safeTo} ${safeCurrency}`;\r\n                    } else if (safeFrom !== null) {\r\n                        strong.textContent = `√Ä partir de ${safeFrom} ${safeCurrency}`;\r\n                    } else if (safeTo !== null) {\r\n                        strong.textContent = `Jusqu'√† ${safeTo} ${safeCurrency}`;\r\n                    }\r\n\r\n                    if (strong.textContent) {\r\n                        p.appendChild(strong);\r\n                        div.appendChild(p);\r\n                    }\r\n                }\r\n                if (data.description) {\r\n                    const desc = document.createElement('p');\r\n                    desc.textContent = data.description;\r\n                    desc.style.fontSize = '0.85rem';\r\n                    desc.style.color = 'var(--gl-color-text-muted)';\r\n                    div.appendChild(desc);\r\n                }\r\n\r\n                if (div.children.length === 0) {\r\n                    if (Log) Log.warn('[POI] renderList: price object has no displayable content');\r\n                    return null;\r\n                }\r\n                return div;\r\n            }\r\n\r\n            // Liste normale (array)\r\n            if (Array.isArray(data)) {\r\n                const variant = section.variant || 'disc';\r\n\r\n                const ul = document.createElement('ul');\r\n                ul.className = 'gl-poi-list-unordered';\r\n\r\n                // Appliquer le style de puce selon le variant\r\n                if (variant === 'disc' || variant === 'circle' || variant === 'square') {\r\n                    ul.style.listStyleType = variant;\r\n                } else {\r\n                    ul.style.listStyleType = 'disc'; // Par d√©faut\r\n                }\r\n\r\n                data.forEach(item => {\r\n                    const li = document.createElement('li');\r\n                    li.textContent = item;\r\n                    ul.appendChild(li);\r\n                });\r\n\r\n                div.appendChild(ul);\r\n            }\r\n\r\n            return div;\r\n        }\r\n\r\n        /**\r\n         * Rend un tableau avec en-t√™tes et bordures\r\n         * @param {object} section - Configuration de section\r\n         * @param {Array} data - Donn√©es du tableau\r\n         * @returns {HTMLElement|null}\r\n         */\r\n        renderTable(section, data) {\r\n            if (!data || !Array.isArray(data)) {\r\n                if (Log) Log.warn('[POI] renderTable: data is', data ? 'not an array' : 'null/undefined', '- type:', typeof data);\r\n                return null;\r\n            }\r\n\r\n            if (Log) Log.info('[POI] renderTable: rendering', data.length, 'rows');\r\n\r\n            // Transformer les cha√Ænes en objets si n√©cessaire\r\n            let tableData = data;\r\n            if (data.length > 0 && typeof data[0] === 'string' && section.columns && section.columns.length === 2) {\r\n                // D√©tecter le format \"Cl√© : Valeur\" ou \"Cl√© ‚Äì Valeur\"\r\n                tableData = data.map(str => {\r\n                    const separators = [' : ', ': ', ' ‚Äì ', '‚Äì', ' - ', '-'];\r\n                    for (const sep of separators) {\r\n                        const parts = str.split(sep);\r\n                        if (parts.length >= 2) {\r\n                            return {\r\n                                [section.columns[0].key]: parts[0].trim(),\r\n                                [section.columns[1].key]: parts.slice(1).join(sep).trim()\r\n                            };\r\n                        }\r\n                    }\r\n                    // Si aucun s√©parateur trouv√©, tout dans la premi√®re colonne\r\n                    return {\r\n                        [section.columns[0].key]: str,\r\n                        [section.columns[1].key]: ''\r\n                    };\r\n                });\r\n                if (Log) Log.info('[POI] renderTable: transformed string array to object array');\r\n            }\r\n\r\n            const table = document.createElement('table');\r\n            table.className = 'gl-poi-table';\r\n\r\n            // Gestion des bordures selon la configuration\r\n            const borders = section.borders || {};\r\n            if (borders.outer !== false) {\r\n                table.style.border = `1px solid ${borders.color || 'var(--gl-color-border-soft)'}`;\r\n            }\r\n\r\n            // En-t√™tes\r\n            if (section.columns) {\r\n                const thead = document.createElement('thead');\r\n                const tr = document.createElement('tr');\r\n                section.columns.forEach((col, index) => {\r\n                    const th = document.createElement('th');\r\n                    th.textContent = col.label;\r\n                    th.style.padding = '8px';\r\n                    th.style.textAlign = 'left';\r\n                    th.style.fontWeight = '600';\r\n                    th.style.backgroundColor = 'var(--gl-color-bg-subtle)';\r\n\r\n                    if (borders.row !== false) {\r\n                        th.style.borderBottom = `1px solid ${borders.color || 'var(--gl-color-border-soft)'}`;\r\n                    }\r\n                    if (borders.column && index > 0) {\r\n                        th.style.borderLeft = `1px solid ${borders.color || 'var(--gl-color-border-soft)'}`;\r\n                    }\r\n\r\n                    tr.appendChild(th);\r\n                });\r\n                thead.appendChild(tr);\r\n                table.appendChild(thead);\r\n            }\r\n\r\n            // Lignes de donn√©es\r\n            const tbody = document.createElement('tbody');\r\n            tableData.forEach((row, rowIndex) => {\r\n                const tr = document.createElement('tr');\r\n                if (section.columns) {\r\n                    section.columns.forEach((col, colIndex) => {\r\n                        const td = document.createElement('td');\r\n                        td.textContent = row[col.key] || '';\r\n                        td.style.padding = '8px';\r\n\r\n                        if (borders.row !== false && rowIndex < tableData.length - 1) {\r\n                            td.style.borderBottom = `1px solid ${borders.color || 'var(--gl-color-border-soft)'}`;\r\n                        }\r\n                        if (borders.column && colIndex > 0) {\r\n                            td.style.borderLeft = `1px solid ${borders.color || 'var(--gl-color-border-soft)'}`;\r\n                        }\r\n\r\n                        tr.appendChild(td);\r\n                    });\r\n                }\r\n                tbody.appendChild(tr);\r\n            });\r\n            table.appendChild(tbody);\r\n\r\n            return table;\r\n        }\r\n\r\n        /**\r\n         * Rend des tags\r\n         * @param {object} section - Configuration de section\r\n         * @param {Array<string>} tags - Liste de tags\r\n         * @returns {HTMLElement|null}\r\n         */\r\n        renderTags(section, tags) {\r\n            if (!tags || !Array.isArray(tags)) {\r\n                if (Log) Log.warn('[POI] renderTags: tags is', tags ? 'not an array' : 'null/undefined', '- type:', typeof tags, '- value:', tags);\r\n                return null;\r\n            }\r\n\r\n            if (tags.length === 0) {\r\n                if (Log) Log.warn('[POI] renderTags: tags array is empty');\r\n                return null;\r\n            }\r\n\r\n            if (Log) Log.info('[POI] renderTags: rendering', tags.length, 'tags');\r\n\r\n            const div = document.createElement('div');\r\n            div.className = 'gl-poi-sidepanel__tags';\r\n            div.style.display = 'flex';\r\n            div.style.flexWrap = 'wrap';\r\n            div.style.gap = '6px';\r\n\r\n            tags.forEach(tag => {\r\n                const tagSpan = document.createElement('span');\r\n                tagSpan.className = 'gl-poi-tag';\r\n                tagSpan.textContent = tag;\r\n                div.appendChild(tagSpan);\r\n            });\r\n\r\n            return div;\r\n        }\r\n\r\n        /**\r\n         * Rend les avis (reviews)\r\n         * @param {object} section - Configuration de section\r\n         * @param {Array} reviews - Liste d'avis\r\n         * @returns {HTMLElement|null}\r\n         */\r\n        renderReviews(section, reviews) {\r\n            if (!reviews || !Array.isArray(reviews)) {\r\n                if (Log) Log.warn('[POI] renderReviews: reviews is', reviews ? 'not an array' : 'null/undefined', '- type:', typeof reviews);\r\n                return null;\r\n            }\r\n\r\n            if (Log) Log.info('[POI] renderReviews: rendering', reviews.length, 'reviews');\r\n\r\n            const div = document.createElement('div');\r\n            div.className = 'gl-poi-reviews';\r\n\r\n            const maxCount = section.maxCount || 5;\r\n            reviews.slice(0, maxCount).forEach(review => {\r\n                const reviewDiv = document.createElement('div');\r\n                reviewDiv.className = 'gl-poi-review';\r\n                reviewDiv.style.borderLeft = '3px solid var(--gl-color-accent-soft)';\r\n                reviewDiv.style.paddingLeft = '12px';\r\n                reviewDiv.style.marginBottom = '12px';\r\n\r\n                const header = document.createElement('p');\r\n                header.style.fontSize = '0.875rem';\r\n                header.style.fontWeight = '600';\r\n                header.style.marginBottom = '4px';\r\n\r\n                const safeAuthor = review.authorName || 'Anonyme';\r\n                const safeRating = Number.isFinite(review.rating) ? review.rating : 0;\r\n                const verifiedMark = review.verified ? ' ‚úì' : '';\r\n                header.textContent = `${safeAuthor} - ‚≠ê${safeRating}/5${verifiedMark}`;\r\n                reviewDiv.appendChild(header);\r\n\r\n                if (review.comment) {\r\n                    const comment = document.createElement('p');\r\n                    comment.textContent = review.comment;\r\n                    comment.style.fontSize = '0.85rem';\r\n                    comment.style.marginBottom = '4px';\r\n                    reviewDiv.appendChild(comment);\r\n                }\r\n\r\n                if (review.createdAt) {\r\n                    const date = document.createElement('p');\r\n                    date.style.fontSize = '0.75rem';\r\n                    date.style.color = 'var(--gl-color-text-muted)';\r\n                    date.textContent = review.createdAt;\r\n                    reviewDiv.appendChild(date);\r\n                }\r\n\r\n                div.appendChild(reviewDiv);\r\n            });\r\n\r\n            return div;\r\n        }\r\n    }\r\n\r\n    // Export global\r\n    GeoLeaf.ComponentRenderers = ComponentRenderers;\r\n\r\n})(typeof window !== \"undefined\" ? window : global);\r\n","/**\n * GeoLeaf POI Module - Section Orchestrator\n * Orchestration du rendu des sections (dispatcher, extraction valeurs, accord√©ons)\n * Phase 6.2 - Extraction depuis core.js\n */\n(function (global) {\n    \"use strict\";\n\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\n    const Log = GeoLeaf.Log;\n    const Utils = GeoLeaf.Utils || {};\n\n    /**\n     * Orchestrateur de sections pour le side panel POI\n     */\n    class SectionOrchestrator {\n        constructor() {\n            // Initialiser les renderers\n            this.componentRenderers = null;\n            this.fieldRenderers = null;\n            this.mediaRenderers = null;\n        }\n\n        /**\n         * Initialise les renderers (lazy loading)\n         * @private\n         */\n        _initRenderers() {\n            if (!this.componentRenderers) {\n                this.componentRenderers = new GeoLeaf.ComponentRenderers();\n            }\n            if (!this.fieldRenderers && GeoLeaf.POI && GeoLeaf.POI.Renderers && GeoLeaf.POI.Renderers.FieldRenderers) {\n                this.fieldRenderers = new GeoLeaf.POI.Renderers.FieldRenderers({ debug: true });\n            }\n            if (!this.mediaRenderers && GeoLeaf.POI && GeoLeaf.POI.Renderers && GeoLeaf.POI.Renderers.MediaRenderers) {\n                this.mediaRenderers = new GeoLeaf.POI.Renderers.MediaRenderers({ debug: true });\n            }\n        }\n\n        /**\n         * R√©cup√®re la valeur d'un champ avec support du dot notation\n         * @param {object} poi - POI complet\n         * @param {string} fieldPath - Chemin du champ (ex: \"attributes.address.city\")\n         * @returns {*}\n         */\n        getFieldValue(poi, fieldPath) {\n            if (!fieldPath) return null;\n\n            const resolveField = Utils.resolveField || function(obj, path) {\n                const parts = path.split('.');\n                let current = obj;\n                for (const part of parts) {\n                    if (current && typeof current === 'object' && part in current) {\n                        current = current[part];\n                    } else {\n                        return null;\n                    }\n                }\n                return current;\n            };\n\n            const value = resolveField(poi, fieldPath);\n\n            if (Log && Log.info) {\n                Log.info('[POI] getFieldValue:', fieldPath, '‚Üí',\n                    value === undefined ? 'undefined' :\n                    value === null ? 'null' :\n                    value === '' ? '\"\"(empty string)' :\n                    Array.isArray(value) ? `Array(${value.length})` :\n                    (value && typeof value === 'object') ? `Object(${Object.keys(value).length} keys)` :\n                    value);\n            }\n\n            return value;\n        }\n\n        /**\n         * Wrappe un contenu dans un accord√©on <details>\n         * @param {object} section - Configuration de section\n         * @param {HTMLElement} content - Contenu √† wrapper\n         * @param {boolean} isOpen - Ouvrir par d√©faut\n         * @returns {HTMLElement}\n         */\n        wrapInAccordion(section, content, isOpen = false) {\n            const details = document.createElement('details');\n            details.className = 'gl-accordion';\n            if (isOpen) details.setAttribute('open', '');\n\n            const summary = document.createElement('summary');\n            summary.className = 'gl-accordion__header';\n            summary.textContent = section.label || 'Section';\n\n            const arrow = document.createElement('span');\n            arrow.className = 'gl-accordion__arrow';\n            arrow.textContent = '‚ñº';\n            summary.appendChild(arrow);\n\n            const panel = document.createElement('div');\n            panel.className = 'gl-accordion__panel';\n\n            const panelContent = document.createElement('div');\n            panelContent.className = 'gl-accordion__panel-content';\n            panelContent.appendChild(content);\n\n            panel.appendChild(panelContent);\n\n            details.appendChild(summary);\n            details.appendChild(panel);\n\n            return details;\n        }\n\n        /**\n         * Rend une section compl√®te selon son type\n         * @param {object} section - Configuration de section\n         * @param {object} poi - POI complet\n         * @param {object} state - √âtat partag√© POI\n         * @returns {Promise<HTMLElement|null>}\n         */\n        async renderSection(section, poi, state) {\n            if (!section || !section.type) return null;\n\n            // Initialiser les renderers si n√©cessaire\n            this._initRenderers();\n\n            // R√©soudre la valeur du champ\n            const fieldValue = this.getFieldValue(poi, section.field);\n\n            if (Log) {\n                const valueType = Array.isArray(fieldValue) ? `Array(${fieldValue.length})` :\n                                 (fieldValue && typeof fieldValue === 'object') ? `Object(${Object.keys(fieldValue).length} keys)` :\n                                 typeof fieldValue;\n                Log.debug('[POI] Section:', section.label || section.type, '- Field:', section.field, '- ValueType:', valueType, '- Value:', fieldValue);\n            }\n\n            // Ne pas afficher si la valeur est vide, SAUF pour:\n            // - text avec style='title' (le titre est obligatoire)\n            // - badge (peut avoir un comportement par d√©faut)\n            const isRequiredField = (section.type === 'text' && section.style === 'title') || section.type === 'badge';\n\n            // V√©rifier si la valeur est vraiment vide (null, undefined, '', [], {})\n            // ATTENTION: 0 est une valeur valide (pour les prix, m√©triques, etc.)\n            const isEmpty = (fieldValue === null || fieldValue === undefined || fieldValue === '') ||\n                           (Array.isArray(fieldValue) && fieldValue.length === 0) ||\n                           (typeof fieldValue === 'object' && !Array.isArray(fieldValue) && Object.keys(fieldValue).length === 0);\n\n            if (Log) {\n                Log.info('[POI] Check isEmpty for:', section.label,\n                    '- fieldValue:', fieldValue,\n                    '- isArray:', Array.isArray(fieldValue),\n                    '- arrayLength:', Array.isArray(fieldValue) ? fieldValue.length : 'N/A',\n                    '- isEmpty:', isEmpty);\n            }\n\n            if (isEmpty && !isRequiredField) {\n                if (Log) Log.warn('[POI] Section ignor√©e (valeur vide):', section.label || section.type);\n                return null;\n            }\n\n            if (Log) Log.info('[POI] ‚Üí Appel render pour:', section.label, '- Type:', section.type, '- Value:',\n                Array.isArray(fieldValue) ? `Array(${fieldValue.length})` :\n                (fieldValue && typeof fieldValue === 'object') ? 'Object' :\n                fieldValue);\n\n            // Cr√©er l'√©l√©ment selon le type\n            let content = null;\n\n            switch (section.type) {\n                case 'text':\n                case 'longtext': // Alias pour text avec plus de contenu\n                    if (this.fieldRenderers) {\n                        content = await this.fieldRenderers.renderText(section, poi, fieldValue);\n                    }\n                    break;\n                case 'number': // Afficher un nombre simple comme du texte\n                    if (this.fieldRenderers) {\n                        content = await this.fieldRenderers.renderText(section, poi, String(fieldValue));\n                    }\n                    break;\n                case 'metric': // Nombre avec suffixe/pr√©fixe\n                    const suffix = section.suffix || '';\n                    const prefix = section.prefix || '';\n                    if (this.fieldRenderers) {\n                        content = await this.fieldRenderers.renderText(section, poi, prefix + String(fieldValue) + suffix);\n                    }\n                    break;\n                case 'image':\n                    if (this.mediaRenderers) {\n                        content = this.mediaRenderers.renderImage(section, fieldValue);\n                    }\n                    break;\n                case 'gallery':\n                    if (this.mediaRenderers) {\n                        content = this.mediaRenderers.renderGallery(section, fieldValue);\n                    }\n                    break;\n                case 'badge':\n                    content = this.componentRenderers.renderBadge(section, fieldValue, poi);\n                    break;\n                case 'link':\n                    content = this.componentRenderers.renderLink(section, fieldValue);\n                    break;\n                case 'list':\n                    content = this.componentRenderers.renderList(section, fieldValue);\n                    break;\n                case 'table':\n                    content = this.componentRenderers.renderTable(section, fieldValue);\n                    break;\n                case 'tags':\n                    content = this.componentRenderers.renderTags(section, fieldValue);\n                    break;\n                case 'reviews':\n                    content = this.componentRenderers.renderReviews(section, fieldValue);\n                    break;\n                default:\n                    if (Log) Log.warn('[POI] Type de section inconnu:', section.type);\n                    return null;\n            }\n\n            if (!content) {\n                if (Log) Log.debug('[POI] Aucun contenu g√©n√©r√© pour:', section.label || section.type);\n                return null;\n            }\n\n            if (Log) Log.debug('[POI] Contenu g√©n√©r√© pour:', section.label || section.type, '- Accordion:', section.accordion);\n\n            // Wraper dans un accord√©on si n√©cessaire\n            if (section.accordion) {\n                return this.wrapInAccordion(section, content, section.defaultOpen);\n            }\n\n            return content;\n        }\n    }\n\n    // Export global\n    GeoLeaf.SectionOrchestrator = SectionOrchestrator;\n\n})(typeof window !== \"undefined\" ? window : global);\n","/**\n * Module Renderers/Links pour POI\n * Rendu des liens\n */\n(function (global) {\n    \"use strict\";\n\n    const GeoLeaf = global.GeoLeaf = global.GeoLeaf || {};\n    const Log = GeoLeaf.Log;\n\n    /**\n     * Module Links Renderer\n     * @namespace _POIRendererLinks\n     * @private\n     */\n    const _POIRendererLinks = {\n        /**\n         * Rend un lien (website, etc.)\n         * @param {Object} section - Configuration de la section\n         * @param {string} url - URL du lien\n         * @returns {HTMLElement|null}\n         */\n        renderLink(section, url) {\n            if (!url) return null;\n\n            const container = document.createElement('div');\n            container.className = 'gl-poi-link-container';\n\n            const link = document.createElement('a');\n            link.className = 'gl-poi-website-link';\n            link.href = url;\n            link.target = '_blank';\n            link.rel = 'noopener noreferrer';\n            link.textContent = section.label || url;\n\n            container.appendChild(link);\n            return container;\n        }\n    };\n\n    // Exposer dans l'espace de noms interne\n    GeoLeaf._POIRendererLinks = _POIRendererLinks;\n\n})(window);\n","/**\r\n * GeoLeaf POI Module - Renderers Core\r\n * Orchestrateur principal pour le rendu du side panel POI\r\n * Phase 6.2 - Version refactoris√©e (837 LOC ‚Üí ~140 LOC)\r\n *\r\n * Architecture modulaire:\r\n * - lightbox-manager.js: Gestion lightbox\r\n * - ui-behaviors.js: Comportements UI (accord√©ons, galerie)\r\n * - component-renderers.js: Renderers composants (badges, links, lists, tables, tags)\r\n * - section-orchestrator.js: Dispatcher de sections + extraction valeurs\r\n * - field-renderers-v2.js: Renderers texte\r\n * - media-renderers-v2.js: Renderers media\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    const Log = GeoLeaf.Log;\r\n\r\n    GeoLeaf._POIRenderers = GeoLeaf._POIRenderers || {};\r\n\r\n    // R√©f√©rence aux modules POI\r\n    const getShared = () => GeoLeaf._POIShared;\r\n    const getNormalizers = () => GeoLeaf._POINormalizers;\r\n\r\n    // Initialiser les nouveaux modules\r\n    let sectionOrchestrator = null;\r\n    let lightboxManager = null;\r\n    let uiBehaviors = null;\r\n\r\n    /**\r\n     * Initialise les modules (lazy loading)\r\n     * @private\r\n     */\r\n    function _initModules() {\r\n        if (!sectionOrchestrator && GeoLeaf.SectionOrchestrator) {\r\n            sectionOrchestrator = new GeoLeaf.SectionOrchestrator();\r\n        }\r\n        if (!lightboxManager) {\r\n            lightboxManager = GeoLeaf._lightboxManager || (GeoLeaf.LightboxManager ? new GeoLeaf.LightboxManager() : null);\r\n        }\r\n        if (!uiBehaviors) {\r\n            uiBehaviors = GeoLeaf._POIUIBehaviors;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Peuple le side panel avec les donn√©es du POI en utilisant le layout JSON.\r\n     *\r\n     * @param {object} poi - POI normalis√©.\r\n     * @param {object} customLayout - Layout personnalis√© (optionnel).\r\n     * @returns {Promise<void>}\r\n     */\r\n    async function populateSidePanel(poi, customLayout) {\r\n        console.log('[SIDEPANEL] populateSidePanel called for POI:', poi?.title || poi?.label);\r\n        // Initialiser les modules\r\n        _initModules();\r\n\r\n        const shared = getShared();\r\n        if (!shared) {\r\n            console.log('[SIDEPANEL] ERROR: shared is null');\r\n            return;\r\n        }\r\n        const state = shared.state;\r\n\r\n        if (!state.sidePanelElement) {\r\n            console.log('[SIDEPANEL] ERROR: sidePanelElement not found');\r\n            return;\r\n        }\r\n\r\n        const contentDiv = state.sidePanelElement.querySelector('.gl-poi-sidepanel__content');\r\n        if (!contentDiv) return;\r\n\r\n        // Clear contenu pr√©c√©dent\r\n        GeoLeaf.DOMSecurity.clearElementFast(contentDiv);\r\n\r\n        // Normaliser le POI\r\n        const normalizers = getNormalizers();\r\n        const normalized = normalizers ? normalizers.normalizePoi(poi) : poi;\r\n\r\n        if (Log) {\r\n            Log.debug('[POI] POI normalis√©:', normalized.title || normalized.label);\r\n            Log.debug('[POI] Champs attributes disponibles:', Object.keys(normalized.attributes || {}));\r\n        }\r\n\r\n        // R√©cup√©rer le layout depuis la config du profile\r\n        let layout = customLayout;\r\n\r\n        // ‚úÖ PRIORIT√â 1: V√©rifier si le POI a une configuration sidepanel attach√©e (depuis sa couche)\r\n        if (!layout && normalized._sidepanelConfig && normalized._sidepanelConfig.detailLayout) {\r\n            layout = normalized._sidepanelConfig.detailLayout;\r\n            if (Log) Log.info('[POI] Layout r√©cup√©r√© depuis la configuration de couche attach√©e au POI');\r\n        }\r\n\r\n        // ‚úÖ PRIORIT√â 2: Essayer de r√©cup√©rer depuis le profil actif\r\n        if (!layout) {\r\n            const Config = GeoLeaf.Config;\r\n            if (Config && typeof Config.getActiveProfile === 'function') {\r\n                const activeProfile = Config.getActiveProfile();\r\n                if (activeProfile && activeProfile.panels && activeProfile.panels.detail) {\r\n                    layout = activeProfile.panels.detail.layout;\r\n                    if (Log) Log.info('[POI] Layout r√©cup√©r√© depuis le profil actif:', activeProfile.id || 'unknown');\r\n                }\r\n            }\r\n        }\r\n\r\n        // Fallback sur poiConfig si disponible\r\n        if (!layout && state.poiConfig?.panels?.detail?.layout) {\r\n            layout = state.poiConfig.panels.detail.layout;\r\n        }\r\n\r\n        // Si toujours pas de layout, utiliser le layout par d√©faut\r\n        if (!layout || layout.length === 0) {\r\n            if (Log) Log.warn('[POI] Aucun layout trouv√©, utilisation du layout par d√©faut');\r\n            layout = _getDefaultLayout();\r\n        }\r\n\r\n        // ‚úÖ IMPORTANT: Trier les sections par leur propri√©t√© 'order' (si d√©finie)\r\n        const sortedLayout = [...layout].sort((a, b) => {\r\n            const orderA = typeof a.order === 'number' ? a.order : 999;\r\n            const orderB = typeof b.order === 'number' ? b.order : 999;\r\n            return orderA - orderB;\r\n        });\r\n\r\n        if (Log) Log.info('[POI] G√©n√©ration du side panel avec', sortedLayout.length, 'sections');\r\n\r\n        // Body du panneau\r\n        const body = document.createElement('div');\r\n        body.className = 'gl-poi-sidepanel__body';\r\n        console.log('[SIDEPANEL] Body created, will process', sortedLayout.length, 'sections');\r\n\r\n        // G√©n√©rer chaque section selon le layout tri√© (d√©l√©guer √† SectionOrchestrator)\r\n        for (const section of sortedLayout) {\r\n            try {\r\n                const element = sectionOrchestrator\r\n                    ? await sectionOrchestrator.renderSection(section, normalized, state)\r\n                    : null;\r\n\r\n                if (element) {\r\n                    body.appendChild(element);\r\n                    console.log('[SIDEPANEL] ‚úì Section added:', section.label || section.type);\r\n                    if (Log) Log.info('[POI] ‚úì Section ajout√©e:', section.label || section.type);\r\n                } else {\r\n                    console.log('[SIDEPANEL] ‚úó Section NULL:', section.label || section.type, '- field:', section.field);\r\n                    if (Log) Log.warn('[POI] ‚úó Section ignor√©e (element null):', section.label || section.type, '- field:', section.field);\r\n                }\r\n            } catch (error) {\r\n                console.error('[SIDEPANEL] ERROR rendering section:', section.label, error);\r\n                if (Log) Log.error('[POI] Erreur lors du rendu de la section:', section.label, error);\r\n            }\r\n        }\r\n\r\n        console.log('[SIDEPANEL] Appending body to contentDiv. Body has', body.children.length, 'children');\r\n        contentDiv.appendChild(body);\r\n        console.log('[SIDEPANEL] Body appended. ContentDiv now has', contentDiv.children.length, 'children');\r\n\r\n        // G√©rer le comportement singleAccordion si configur√©\r\n        const singleAccordion = normalized._sidepanelConfig?.singleAccordion;\r\n        if (singleAccordion === true && uiBehaviors) {\r\n            uiBehaviors.attachSingleAccordionBehavior(body);\r\n        }\r\n\r\n        // Attacher les √©v√©nements apr√®s le rendu\r\n        if (uiBehaviors) {\r\n            uiBehaviors.attachGalleryEvents(state.sidePanelElement, lightboxManager);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Retourne un layout par d√©faut si aucun n'est configur√©.\r\n     * @private\r\n     */\r\n    function _getDefaultLayout() {\r\n        return [\r\n            { type: 'text', field: 'title', style: 'title', accordion: false },\r\n            { type: 'image', field: 'attributes.mainImage', variant: 'hero', accordion: false },\r\n            { type: 'text', field: 'attributes.shortDescription', variant: 'short', accordion: false },\r\n            { type: 'text', label: 'Informations', field: 'attributes.longDescription', variant: 'multiline', accordion: true, defaultOpen: true },\r\n            { type: 'text', label: 'Description', field: 'attributes.description_long', variant: 'multiline', accordion: true, defaultOpen: true },\r\n            { type: 'gallery', label: 'Galerie photos', field: 'attributes.gallery', accordion: true, defaultOpen: true },\r\n            { type: 'list', label: 'Prix', field: 'attributes.price', accordion: true, defaultOpen: false },\r\n            { type: 'reviews', label: 'Avis r√©cents', field: 'attributes.reviews.recent', maxCount: 5, accordion: true, defaultOpen: false },\r\n            { type: 'tags', label: 'Tags', field: 'attributes.tags', accordion: false },\r\n            { type: 'link', label: 'Visiter le site web ‚Üí', field: 'attributes.website', accordion: false }\r\n        ];\r\n    }\r\n\r\n    // Export public dans un namespace s√©par√© pour √©viter d'√©craser l'agr√©gateur\r\n    GeoLeaf._POIRenderersCore = {\r\n        populateSidePanel\r\n    };\r\n\r\n})(typeof window !== \"undefined\" ? window : global);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n/**\r\n * Module POI Renderers (Agr√©gateur)\r\n * Fa√ßade publique pour tous les renderers POI\r\n *\r\n * ARCHITECTURE REFACTORIS√âE :\r\n * - poi/renderers/fields.js : Champs texte et badges\r\n * - poi/renderers/media.js : Images et galeries\r\n * - poi/renderers/links.js : Liens externes\r\n * - poi/renderers/core.js : Logique de rendu principale (legacy)\r\n * - poi/renderers.js (ce fichier) : Agr√©gateur/fa√ßade publique\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = global.GeoLeaf = global.GeoLeaf || {};\r\n\r\n    /**\r\n     * Module POI Renderers\r\n     * D√©l√®gue aux sous-modules sp√©cialis√©s\r\n     * @namespace _POIRenderers\r\n     * @private\r\n     */\r\n    const _POIRenderers = {\r\n        /**\r\n         * Rend le contenu complet d'un POI\r\n         * (D√©l√©gu√© au core pour compatibilit√©)\r\n         * @param {Object} poi - Donn√©es du POI\r\n         * @param {Object} state - √âtat\r\n         * @returns {DocumentFragment}\r\n         */\r\n        renderContent(poi, state) {\r\n            // D√©l√©gation au module core (fichier original)\r\n            if (GeoLeaf._POIRenderersCore && typeof GeoLeaf._POIRenderersCore.renderContent === 'function') {\r\n                return GeoLeaf._POIRenderersCore.renderContent(poi, state);\r\n            }\r\n            if (GeoLeaf.Log) GeoLeaf.Log.error('[POI] Module _POIRenderersCore non disponible');\r\n            return document.createDocumentFragment();\r\n        },\r\n\r\n        /**\r\n         * Rend un champ texte\r\n         * (D√©l√©gu√© au module fields)\r\n         */\r\n        renderText(section, poi, value) {\r\n            if (GeoLeaf._POIRendererFields) {\r\n                return GeoLeaf._POIRendererFields.renderText(section, poi, value);\r\n            }\r\n            if (GeoLeaf.Log) GeoLeaf.Log.error('[POI] Module _POIRendererFields non disponible pour renderText');\r\n            return null;\r\n        },\r\n\r\n        /**\r\n         * Rend un badge\r\n         * (D√©l√©gu√© au module fields)\r\n         */\r\n        renderBadge(section, value, poi) {\r\n            if (GeoLeaf._POIRendererFields) {\r\n                return GeoLeaf._POIRendererFields.renderBadge(section, value, poi);\r\n            }\r\n            if (GeoLeaf.Log) GeoLeaf.Log.error('[POI] Module _POIRendererFields non disponible pour renderBadge');\r\n            return null;\r\n        },\r\n\r\n        /**\r\n         * Rend une image\r\n         * (D√©l√©gu√© au module media)\r\n         */\r\n        renderImage(section, imageUrl) {\r\n            if (GeoLeaf._POIRendererMedia) {\r\n                return GeoLeaf._POIRendererMedia.renderImage(section, imageUrl);\r\n            }\r\n            if (GeoLeaf.Log) GeoLeaf.Log.error('[POI] Module _POIRendererMedia non disponible pour renderImage');\r\n            return null;\r\n        },\r\n\r\n        /**\r\n         * Rend une galerie\r\n         * (D√©l√©gu√© au module media)\r\n         */\r\n        renderGallery(section, gallery) {\r\n            if (GeoLeaf._POIRendererMedia) {\r\n                return GeoLeaf._POIRendererMedia.renderGallery(section, gallery);\r\n            }\r\n            return null;\r\n        },\r\n\r\n        /**\r\n         * Rend un lien\r\n         * (D√©l√©gu√© au module links)\r\n         */\r\n        renderLink(section, url) {\r\n            if (GeoLeaf._POIRendererLinks) {\r\n                return GeoLeaf._POIRendererLinks.renderLink(section, url);\r\n            }\r\n            if (GeoLeaf.Log) GeoLeaf.Log.error('[POI] Module _POIRendererLinks non disponible pour renderLink');\r\n            return null;\r\n        },\r\n\r\n        /**\r\n         * Peuple le side panel avec les donn√©es du POI\r\n         * (D√©l√©gu√© au module core)\r\n         * @returns {Promise<void>}\r\n         */\r\n        async populateSidePanel(poi, customLayout) {\r\n            if (GeoLeaf._POIRenderersCore && typeof GeoLeaf._POIRenderersCore.populateSidePanel === 'function') {\r\n                return await GeoLeaf._POIRenderersCore.populateSidePanel(poi, customLayout);\r\n            }\r\n            if (GeoLeaf.Log) GeoLeaf.Log.error('[POI] Module _POIRenderersCore non disponible pour populateSidePanel');\r\n        }\r\n    };\r\n\r\n    // Exposer dans l'espace de noms interne\r\n    GeoLeaf._POIRenderers = _POIRenderers;\r\n\r\n})(window);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n/**\r\n * GeoLeaf POI Module - Side Panel\r\n * Gestion du panneau lat√©ral d'affichage d√©taill√© des POI\r\n * TODO Phase 4: D√©couper fonctions complexes en sous-fonctions <80 lignes\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    const Log = GeoLeaf.Log;\r\n\r\n    /**\r\n     * Shorthand for createElement\r\n     */\r\n    const $create = (tag, props, ...children) => {\r\n        return GeoLeaf.Utils && GeoLeaf.Utils.createElement\r\n            ? GeoLeaf.Utils.createElement(tag, props, ...children)\r\n            : document.createElement(tag);\r\n    };\r\n\r\n    GeoLeaf._POISidePanel = GeoLeaf._POISidePanel || {};\r\n\r\n    // R√©f√©rence au module shared\r\n    const getShared = () => GeoLeaf._POIShared;\r\n    const getRenderers = () => GeoLeaf._POIRenderers;\r\n\r\n    /**\r\n     * Cr√©e l'√©l√©ment DOM du panneau lat√©ral si non existant.\r\n     */\r\n    function createSidePanel() {\r\n        const shared = getShared();\r\n        if (!shared) return;\r\n        const state = shared.state;\r\n\r\n        if (state.sidePanelElement) return; // D√©j√† cr√©√©\r\n\r\n        // Cr√©er l'overlay\r\n        const overlay = $create('div', {\r\n            className: 'gl-poi-sidepanel-overlay',\r\n            attributes: { 'aria-hidden': 'true' }\r\n        });\r\n        // Ajouter √† .gl-main pour support du mode plein √©cran\r\n        const glMain = document.querySelector('.gl-main');\r\n        if (glMain) {\r\n            glMain.appendChild(overlay);\r\n        } else {\r\n            document.body.appendChild(overlay);\r\n        }\r\n        state.sidePanelOverlay = overlay;\r\n\r\n        // Cr√©er le panneau\r\n        const panel = $create('aside', {\r\n            className: 'gl-poi-sidepanel',\r\n            attributes: {\r\n                'aria-hidden': 'true',\r\n                'role': 'complementary'\r\n            }\r\n        });\r\n\r\n        // Cr√©er le header avec bouton fermer\r\n        const header = $create('div', { className: 'gl-poi-sidepanel__header' });\r\n        const closeBtn = $create('button', {\r\n            className: 'gl-poi-sidepanel__close',\r\n            attributes: { 'aria-label': 'Fermer' },\r\n            textContent: '√ó',\r\n            onClick: closeSidePanel\r\n        });\r\n        header.appendChild(closeBtn);\r\n\r\n        // Cr√©er le content\r\n        const content = $create('div', { className: 'gl-poi-sidepanel__content' });\r\n\r\n        panel.appendChild(header);\r\n        panel.appendChild(content);\r\n        // Ajouter √† .gl-main pour support du mode plein √©cran\r\n        if (glMain) {\r\n            glMain.appendChild(panel);\r\n        } else {\r\n            document.body.appendChild(panel);\r\n        }\r\n        state.sidePanelElement = panel;\r\n        state.sidePanelContent = content;\r\n\r\n        // Event listeners\r\n        overlay.addEventListener('click', closeSidePanel);\r\n\r\n        if (Log) Log.info('[POI] Side panel cr√©√©.');\r\n    }\r\n\r\n    /**\r\n     * Ouvre le panneau lat√©ral avec les infos compl√®tes du POI.\r\n     *\r\n     * @param {object} poi - Donn√©es compl√®tes du POI.\r\n     * @param {object} customLayout - Layout personnalis√© (optionnel).\r\n     * @returns {Promise<void>}\r\n     */\r\n    async function openSidePanel(poi, customLayout) {\r\n        console.log('[SIDEPANEL-OPEN] openSidePanel called for POI:', poi?.id || poi?.name);\r\n        if (!poi) {\r\n            console.log('[SIDEPANEL-OPEN] ERROR: POI is null/undefined');\r\n            if (Log) Log.warn('[POI] openSidePanel() : POI invalide.');\r\n            return;\r\n        }\r\n\r\n        if (Log) {\r\n            Log.debug('[POI] openSidePanel:', poi.id || poi.name);\r\n        }\r\n\r\n        const shared = getShared();\r\n        if (!shared) {\r\n            console.log('[SIDEPANEL-OPEN] ERROR: shared is null');\r\n            return;\r\n        }\r\n        const state = shared.state;\r\n\r\n        // S'assurer que le panneau existe\r\n        if (!state.sidePanelElement) {\r\n            console.log('[SIDEPANEL-OPEN] Creating side panel element');\r\n            createSidePanel();\r\n        }\r\n\r\n        if (!state.sidePanelElement) {\r\n            console.log('[SIDEPANEL-OPEN] ERROR: sidePanelElement still null after creation');\r\n            if (Log) Log.error('[POI] openSidePanel() : Impossible de cr√©er le panneau lat√©ral.');\r\n            return;\r\n        }\r\n\r\n        state.currentPoiInPanel = poi;\r\n        state.currentGalleryIndex = 0;\r\n\r\n        // Peupler le panneau (la lightbox sera cr√©√©e par renderers.js si n√©cessaire)\r\n        const renderers = getRenderers();\r\n        console.log('[SIDEPANEL-OPEN] renderers:', !!renderers, '- populateSidePanel:', typeof renderers?.populateSidePanel);\r\n        if (renderers && typeof renderers.populateSidePanel === 'function') {\r\n            console.log('[SIDEPANEL-OPEN] Calling renderers.populateSidePanel');\r\n            await renderers.populateSidePanel(poi, customLayout);\r\n            console.log('[SIDEPANEL-OPEN] populateSidePanel completed');\r\n        } else {\r\n            console.log('[SIDEPANEL-OPEN] ERROR: renderers.populateSidePanel not available');\r\n        }\r\n\r\n        // Afficher l'overlay et le panneau avec animation\r\n        if (state.sidePanelOverlay) {\r\n            state.sidePanelOverlay.classList.add('open');\r\n        }\r\n        state.sidePanelElement.classList.add('open');\r\n        state.sidePanelElement.setAttribute('aria-hidden', 'false');\r\n\r\n        // Ajouter classe au body pour d√©caler la carte\r\n        document.body.classList.add('gl-poi-sidepanel-open');\r\n\r\n        if (Log) Log.info('[POI] Panneau lat√©ral ouvert pour :', poi.title || poi.name || poi.label);\r\n    }\r\n\r\n    /**\r\n     * Ferme le panneau lat√©ral.\r\n     */\r\n    function closeSidePanel() {\r\n        const shared = getShared();\r\n        if (!shared) return;\r\n        const state = shared.state;\r\n\r\n        if (!state.sidePanelElement) return;\r\n\r\n        state.sidePanelElement.classList.remove('open');\r\n        state.sidePanelElement.setAttribute('aria-hidden', 'true');\r\n\r\n        if (state.sidePanelOverlay) {\r\n            state.sidePanelOverlay.classList.remove('open');\r\n        }\r\n\r\n        // Retirer classe du body\r\n        document.body.classList.remove('gl-poi-sidepanel-open');\r\n\r\n        // Nettoyer la lightbox globale\r\n        const lightbox = document.querySelector('.gl-poi-lightbox-global');\r\n        if (lightbox) {\r\n            lightbox.remove();\r\n        }\r\n\r\n        state.currentPoiInPanel = null;\r\n\r\n        if (Log) Log.info('[POI] Panneau lat√©ral ferm√©.');\r\n    }\r\n\r\n    /**\r\n     * Alias pour fermer le panneau (API publique).\r\n     */\r\n    function hideSidePanel() {\r\n        closeSidePanel();\r\n    }\r\n\r\n    // ========================================\r\n    //   EXPORT\r\n    // ========================================\r\n\r\n    GeoLeaf._POISidePanel = {\r\n        createSidePanel,\r\n        openSidePanel,\r\n        closeSidePanel,\r\n        hideSidePanel\r\n    };\r\n\r\n})(typeof window !== \"undefined\" ? window : global);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n/**\r\n * GeoLeaf POI Module - Core\r\n * Fonctions principales d'initialisation, chargement et gestion des POI\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    const Log = GeoLeaf.Log;\r\n\r\n    GeoLeaf._POICore = GeoLeaf._POICore || {};\r\n\r\n    // R√©f√©rences aux modules POI\r\n    const getShared = () => GeoLeaf._POIShared;\r\n    const getMarkers = () => GeoLeaf._POIMarkers;\r\n    const getSidePanel = () => GeoLeaf._POISidePanel;\r\n    const getNormalizers = () => GeoLeaf._POINormalizers;\r\n\r\n    /**\r\n     * Fonction principale d'initialisation du module POI.\r\n     *\r\n     * @param {L.Map|object} mapOrOptions - Instance de la carte Leaflet ou objet {map, config}.\r\n     * @param {object} config - Configuration POI depuis GeoLeaf.config.json (optionnel si premier param est objet).\r\n     */\r\n    async function init(mapOrOptions, config) {\r\n        // Support pour les deux signatures: init(map, config) et init({map, config})\r\n        let map, opts;\r\n\r\n        if (mapOrOptions && typeof mapOrOptions === 'object' && mapOrOptions.map) {\r\n            map = mapOrOptions.map;\r\n            opts = mapOrOptions.config || mapOrOptions;\r\n        } else {\r\n            map = mapOrOptions;\r\n            opts = config;\r\n        }\r\n\r\n        if (!map || typeof map.addLayer !== 'function') {\r\n            if (Log) Log.error('[POI] Aucune carte Leaflet valide fournie. Impossible d\\'initialiser le module POI.');\r\n            return;\r\n        }\r\n\r\n        const shared = getShared();\r\n        if (!shared) {\r\n            if (Log) Log.error('[POI] Module shared non charg√©.');\r\n            return;\r\n        }\r\n\r\n        const state = shared.state;\r\n        const constants = shared.constants;\r\n\r\n        state.mapInstance = map;\r\n        state.poiConfig = opts || {};\r\n\r\n        if (Log) Log.info('[POI] Initialisation du module POI...');\r\n\r\n        // Forcer un maxZoom valide sur la carte\r\n        if (shared.ensureMapMaxZoom) {\r\n            shared.ensureMapMaxZoom(map, constants.POI_MAX_ZOOM);\r\n        }\r\n\r\n        // Cr√©er le layer group principal\r\n        state.poiLayerGroup = L.layerGroup().addTo(map);\r\n\r\n        // Cr√©er le cluster group si clustering activ√©\r\n        const clustering = state.poiConfig.clustering !== false;\r\n        if (clustering && typeof L !== 'undefined' && typeof L.markerClusterGroup === 'function') {\r\n            state.poiClusterGroup = L.markerClusterGroup({\r\n                maxClusterRadius: state.poiConfig.clusterRadius || 80,\r\n                disableClusteringAtZoom: state.poiConfig.disableClusteringAtZoom || constants.POI_MAX_ZOOM,\r\n                animate: false,\r\n                showCoverageOnHover: false\r\n            });\r\n            state.mapInstance.addLayer(state.poiClusterGroup);\r\n            if (Log) Log.info('[POI] Clustering activ√© (MarkerClusterGroup cr√©√©).');\r\n        }\r\n\r\n        // Cr√©er le panneau lat√©ral (cach√© par d√©faut)\r\n        const sidePanel = getSidePanel();\r\n        if (sidePanel && typeof sidePanel.createSidePanel === 'function') {\r\n            sidePanel.createSidePanel();\r\n        }\r\n\r\n        // Charger le sprite SVG AVANT de charger les POIs\r\n        const markers = getMarkers();\r\n        if (markers && typeof markers.ensureProfileSpriteInjectedSync === 'function') {\r\n            await markers.ensureProfileSpriteInjectedSync();\r\n        }\r\n\r\n        // Charger et afficher les POIs avec d√©lai pour attendre Storage\r\n        if (state.poiConfig.enabled !== false) {\r\n            // ‚úÖ NOUVEAU: Retarder le chargement initial pour laisser le temps au Storage de s'initialiser\r\n            setTimeout(() => {\r\n                if (Log) Log.info('[POI] Chargement des POI apr√®s d√©lai d\\'initialisation');\r\n                loadAndDisplay();\r\n            }, 1000);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * ‚úÖ NOUVELLE FONCTION: Charge et fusionne les POI stock√©s localement avec les POI existants\r\n     */\r\n    function loadAndMergeStoredPois(existingPois, callback) {\r\n        if (typeof callback !== 'function') {\r\n            if (Log) Log.error('[POI] loadAndMergeStoredPois: callback requis');\r\n            return;\r\n        }\r\n\r\n        // ‚úÖ NOUVEAU: V√©rification renforc√©e de la disponibilit√© du module Storage\r\n        const checkStorageAvailable = () => {\r\n            const available = typeof GeoLeaf !== 'undefined' &&\r\n                   GeoLeaf.Storage &&\r\n                   GeoLeaf.Storage.DB &&\r\n                   typeof GeoLeaf.Storage.DB.getAllFromSyncQueue === 'function';\r\n\r\n            if (Log) {\r\n                if (!available) {\r\n                    Log.info('[POI] Debug Storage - GeoLeaf:', typeof GeoLeaf !== 'undefined');\r\n                    Log.info('[POI] Debug Storage - GeoLeaf.Storage:', !!(GeoLeaf && GeoLeaf.Storage));\r\n                    Log.info('[POI] Debug Storage - GeoLeaf.Storage.DB:', !!(GeoLeaf && GeoLeaf.Storage && GeoLeaf.Storage.DB));\r\n                    Log.info('[POI] Debug Storage - getAllFromSyncQueue:', !!(GeoLeaf && GeoLeaf.Storage && GeoLeaf.Storage.DB && typeof GeoLeaf.Storage.DB.getAllFromSyncQueue === 'function'));\r\n                }\r\n            }\r\n\r\n            return available;\r\n        };\r\n\r\n        if (!checkStorageAvailable()) {\r\n            // ‚úÖ NOUVEAU: Retry apr√®s un d√©lai si Storage pas encore pr√™t\r\n            if (Log) Log.warn('[POI] Module Storage pas encore pr√™t, retry dans 1000ms...');\r\n            setTimeout(() => {\r\n                if (checkStorageAvailable()) {\r\n                    if (Log) Log.info('[POI] Module Storage maintenant disponible, retry...');\r\n                    loadAndMergeStoredPois(existingPois, callback);\r\n                } else {\r\n                    if (Log) Log.error('[POI] Module Storage toujours non disponible apr√®s retry, abandon.');\r\n                    callback(existingPois);\r\n                }\r\n            }, 1000);\r\n            return;\r\n        }\r\n\r\n        if (Log) Log.info('[POI] Module Storage disponible, r√©cup√©ration des POI...');\r\n\r\n        // Utiliser le module de synchronisation pour r√©cup√©rer les POI du cache\r\n        GeoLeaf.Storage.DB.getAllFromSyncQueue()\r\n            .then(queueItems => {\r\n                if (Log) Log.info(`[POI] R√©cup√©ration cache: ${queueItems.length} items trouv√©s`);\r\n\r\n                if (!Array.isArray(queueItems) || queueItems.length === 0) {\r\n                    if (Log) Log.info('[POI] Aucun POI trouv√© dans la file de synchronisation.');\r\n                    callback(existingPois);\r\n                    return;\r\n                }\r\n\r\n                // D√©bugger les types d'items trouv√©s\r\n                if (Log) {\r\n                    const itemTypes = queueItems.map(item => `${item.action}:${item.data?.type || 'no-type'}`);\r\n                    Log.info(`[POI] Types d'items dans le cache: [${itemTypes.join(', ')}]`);\r\n\r\n                    // DEBUG: Structure compl√®te des premiers items\r\n                    queueItems.slice(0, 2).forEach((item, i) => {\r\n                        Log.info(`[POI] DEBUG Item ${i}:`, {\r\n                            action: item.action,\r\n                            type: item.type,\r\n                            data_type: item.data?.type,\r\n                            keys: Object.keys(item),\r\n                            data_keys: item.data ? Object.keys(item.data) : 'no data'\r\n                        });\r\n                    });\r\n                }\r\n\r\n                // Filtrer les √©l√©ments POI (action 'add' ou 'update') et extraire les donn√©es\r\n                const cachedPois = [];\r\n                const normalizers = getNormalizers();\r\n\r\n                if (!normalizers) {\r\n                    if (Log) Log.error('[POI] Module Normalizers non disponible pour les POI du cache.');\r\n                    callback(existingPois);\r\n                    return;\r\n                }\r\n\r\n                queueItems.forEach(item => {\r\n                    // Essayer diff√©rents formats de structure pour les POI\r\n                    let isPoi = false;\r\n                    let poiData = null;\r\n                    let itemAction = null;\r\n\r\n                    // Format 1: item.data.type === 'poi' && item.action contient 'add'\r\n                    if (item.data && item.data.type === 'poi' && item.action &&\r\n                        (item.action.includes('add') || item.action.includes('update'))) {\r\n                        isPoi = true;\r\n                        poiData = item.data;\r\n                        itemAction = item.action;\r\n                    }\r\n                    // Format 2: item.type === 'poi' directement\r\n                    else if (item.type === 'poi') {\r\n                        isPoi = true;\r\n                        poiData = item;\r\n                        itemAction = item.action || 'add';\r\n                    }\r\n                    // Format 3: Contient un id POI et des coordonn√©es (detection heuristique)\r\n                    else if (item.data && (item.data.id || item.data.latlng || item.data.latitude)) {\r\n                        isPoi = true;\r\n                        poiData = item.data;\r\n                        itemAction = item.action || 'add';\r\n                        if (Log) Log.info(`[POI] D√©tection heuristique POI: ${item.data.id || 'no-id'}`);\r\n                    }\r\n                    // Format 4: L'item lui-m√™me est un POI (pas d'enveloppe data)\r\n                    else if (item.id && (item.latlng || item.latitude)) {\r\n                        isPoi = true;\r\n                        poiData = item;\r\n                        itemAction = 'add';\r\n                        if (Log) Log.info(`[POI] D√©tection POI direct: ${item.id}`);\r\n                    }\r\n\r\n                    if (isPoi && poiData) {\r\n                        // Normaliser le POI stock√© comme les autres\r\n                        const normalizedPoi = normalizers.normalizePoi(poiData);\r\n                        if (normalizedPoi) {\r\n                            cachedPois.push(normalizedPoi);\r\n                            if (Log) Log.info(`[POI] POI du cache normalis√©: ${normalizedPoi.id || 'Sans ID'} (action: ${itemAction})`);\r\n                        } else {\r\n                            if (Log) Log.warn('[POI] √âchec normalisation POI du cache:', poiData);\r\n                        }\r\n                    } else {\r\n                        if (Log) Log.debug(`[POI] Item ignor√© - action: ${item.action}, type: ${item.type || item.data?.type}, keys: ${Object.keys(item).join(',')}`);\r\n                    }\r\n                });\r\n\r\n                if (cachedPois.length > 0) {\r\n                    if (Log) Log.info(`[POI] ${cachedPois.length} POI(s) r√©cup√©r√©(s) du cache local.`);\r\n\r\n                    // Fusionner avec les POI existants (√©viter les doublons par ID)\r\n                    const mergedPois = [...existingPois];\r\n                    cachedPois.forEach(cachedPoi => {\r\n                        if (!mergedPois.find(p => p.id === cachedPoi.id)) {\r\n                            mergedPois.push(cachedPoi);\r\n                        }\r\n                    });\r\n\r\n                    callback(mergedPois);\r\n                } else {\r\n                    callback(existingPois);\r\n                }\r\n            })\r\n            .catch(err => {\r\n                if (Log) Log.error('[POI] Erreur lors de la r√©cup√©ration des POI du cache :', err);\r\n                callback(existingPois);\r\n            });\r\n    }\r\n\r\n    /**\r\n     * Charge les POIs et les affiche sur la carte.\r\n     */\r\n    function loadAndDisplay() {\r\n        const shared = getShared();\r\n        if (!shared) return;\r\n        const state = shared.state;\r\n\r\n        if (state.isLoading) {\r\n            if (Log) Log.warn('[POI] Chargement d√©j√† en cours...');\r\n            return;\r\n        }\r\n\r\n        // 1) Essayer d'utiliser les POI normalis√©s du profil actif\r\n        try {\r\n            if (GeoLeaf.Config && typeof GeoLeaf.Config.getActiveProfilePoi === 'function') {\r\n                const profilePois = GeoLeaf.Config.getActiveProfilePoi();\r\n                if (Array.isArray(profilePois) && profilePois.length > 0) {\r\n                    state.allPois = profilePois;\r\n                    if (Log) Log.info(`[POI] ${state.allPois.length} POI(s) provenant du profil actif.`);\r\n\r\n                    // ‚úÖ CORRECTION: Charger aussi les POI du cache apr√®s les POI du profil\r\n                    loadAndMergeStoredPois(state.allPois, function(mergedPois) {\r\n                        state.allPois = mergedPois;\r\n                        displayPois(state.allPois);\r\n                    });\r\n                    return;\r\n                }\r\n            }\r\n        } catch (err) {\r\n            if (Log) Log.error('[POI] Erreur lors de la r√©cup√©ration des POI du profil actif :', err);\r\n        }\r\n\r\n        // ‚úÖ CORRECTION: Essayer de charger les POI stock√©s en cache AVANT le fallback dataUrl\r\n        loadAndMergeStoredPois([], function(cachedPois) {\r\n            if (cachedPois.length > 0) {\r\n                state.allPois = cachedPois;\r\n                if (Log) Log.info(`[POI] ${cachedPois.length} POI(s) charg√©(s) depuis le cache local.`);\r\n                displayPois(cachedPois);\r\n                return;\r\n            }\r\n\r\n            // 2) Fallback : charger un fichier JSON depuis dataUrl (mode historique)\r\n            const dataUrl = state.poiConfig.dataUrl;\r\n            if (!dataUrl) {\r\n                if (Log) Log.info('[POI] Aucune dataUrl sp√©cifi√©e et aucun POI en cache. Mode ajout manuel.');\r\n                return;\r\n            }\r\n\r\n            state.isLoading = true;\r\n            if (Log) Log.info('[POI] Chargement des donn√©es POI depuis :', dataUrl);\r\n\r\n            fetch(dataUrl)\r\n                .then(response => {\r\n                    if (!response.ok) {\r\n                        throw new Error(`Erreur HTTP ${response.status} lors du chargement de ${dataUrl}`);\r\n                    }\r\n                    return response.json();\r\n                })\r\n                .then(data => {\r\n                    if (Array.isArray(data)) {\r\n                        state.allPois = data;\r\n                    } else if (data && Array.isArray(data.pois)) {\r\n                        state.allPois = data.pois;\r\n                    } else {\r\n                        state.allPois = [];\r\n                    }\r\n                    if (Log) Log.info(`[POI] ${state.allPois.length} POI(s) charg√©(s) depuis dataUrl.`);\r\n                    displayPois(state.allPois);\r\n                })\r\n                .catch(err => {\r\n                    if (Log) Log.error('[POI] Erreur lors du chargement des POIs :', err);\r\n                })\r\n                .finally(() => {\r\n                    state.isLoading = false;\r\n                });\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Affiche tous les POIs pass√©s en param√®tre sur la carte.\r\n     *\r\n     * @param {array} pois - Tableau d'objets POI.\r\n     */\r\n    function displayPois(pois) {\r\n        if (!pois || !Array.isArray(pois)) {\r\n            if (Log) Log.warn('[POI] displayPois() : Aucune donn√©e POI valide √† afficher.');\r\n            return;\r\n        }\r\n\r\n        const shared = getShared();\r\n        if (!shared) return;\r\n        const state = shared.state;\r\n        const constants = shared.constants;\r\n\r\n        // Nettoyer les layers existants\r\n        if (state.poiLayerGroup) {\r\n            state.poiLayerGroup.clearLayers();\r\n        }\r\n        if (state.poiClusterGroup) {\r\n            state.poiClusterGroup.clearLayers();\r\n        }\r\n\r\n        const clustering = state.poiConfig.clustering !== false;\r\n        const markers = getMarkers();\r\n\r\n        if (!markers || typeof markers.createMarker !== 'function') {\r\n            if (Log) Log.error('[POI] Module Markers non charg√©.');\r\n            return;\r\n        }\r\n\r\n        if (clustering && state.poiClusterGroup) {\r\n            // Mode clustering\r\n            pois.forEach(poi => {\r\n                const marker = markers.createMarker(poi);\r\n                if (marker) {\r\n                    state.poiClusterGroup.addLayer(marker);\r\n                    state.poiMarkers.set(poi.id || poi.title || poi.label, marker);\r\n                }\r\n            });\r\n\r\n            if (!state.mapInstance.hasLayer(state.poiClusterGroup)) {\r\n                state.mapInstance.addLayer(state.poiClusterGroup);\r\n            }\r\n\r\n            if (Log) Log.info('[POI] Affichage avec clustering.');\r\n        } else {\r\n            // Mode sans clustering\r\n            pois.forEach(poi => {\r\n                const marker = markers.createMarker(poi);\r\n                if (marker) {\r\n                    state.poiLayerGroup.addLayer(marker);\r\n                    state.poiMarkers.set(poi.id || poi.title || poi.label, marker);\r\n                }\r\n            });\r\n\r\n            if (!state.mapInstance.hasLayer(state.poiLayerGroup)) {\r\n                state.mapInstance.addLayer(state.poiLayerGroup);\r\n            }\r\n\r\n            if (Log) Log.info('[POI] Affichage sans clustering.');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Ajoute un POI manuellement sur la carte.\r\n     * CORRIG√â V3: Normalisation syst√©matique des nouveaux POI\r\n     *\r\n     * @param {object} poi - Donn√©es du POI.\r\n     * @returns {L.Marker|null} Marqueur cr√©√© ou null.\r\n     */\r\n    function addPoi(poi) {\r\n        if (!poi) {\r\n            if (Log) Log.warn('[POI] addPoi() : POI invalide.');\r\n            return null;\r\n        }\r\n\r\n        const shared = getShared();\r\n        if (!shared) return null;\r\n        const state = shared.state;\r\n\r\n        const normalizers = getNormalizers();\r\n        const markers = getMarkers();\r\n\r\n        if (!normalizers || !markers) {\r\n            if (Log) Log.error('[POI] Modules Normalizers ou Markers non charg√©s.');\r\n            return null;\r\n        }\r\n\r\n        // ‚úÖ CORRECTION V3: NORMALISER le POI avant traitement\r\n        // Ceci garantit une structure coh√©rente avec les POI existants\r\n        const normalizedPoi = normalizers.normalizePoi(poi);\r\n        if (!normalizedPoi) {\r\n            if (Log) Log.warn('[POI] addPoi() : √âchec de la normalisation du POI.', poi);\r\n            return null;\r\n        }\r\n\r\n        // G√©n√©rer un ID si manquant apr√®s normalisation\r\n        if (!normalizedPoi.id) {\r\n            normalizedPoi.id = normalizers.generatePoiId(normalizedPoi);\r\n        }\r\n\r\n        if (Log) {\r\n            Log.info('[POI] Adding normalized POI:', normalizedPoi.id);\r\n            Log.info('[POI] - Has _layerConfig:', !!normalizedPoi._layerConfig);\r\n            Log.info('[POI] - Has _sidepanelConfig:', !!normalizedPoi._sidepanelConfig);\r\n            Log.info('[POI] - Has _popupConfig:', !!normalizedPoi._popupConfig);\r\n            Log.info('[POI] - Attributes keys:', Object.keys(normalizedPoi.attributes || {}));\r\n        }\r\n\r\n        // Cr√©er le marqueur avec le POI normalis√©\r\n        const marker = markers.createMarker(normalizedPoi);\r\n        if (!marker) {\r\n            if (Log) Log.warn('[POI] addPoi() : Impossible de cr√©er le marqueur pour ce POI normalis√©.', normalizedPoi);\r\n            return null;\r\n        }\r\n\r\n        // Ajouter au bon layer group\r\n        const clustering = state.poiConfig.clustering !== false;\r\n        if (clustering && state.poiClusterGroup) {\r\n            state.poiClusterGroup.addLayer(marker);\r\n        } else {\r\n            state.poiLayerGroup.addLayer(marker);\r\n        }\r\n\r\n        // Stocker le POI NORMALIS√â dans la liste (important pour la coh√©rence)\r\n        state.allPois.push(normalizedPoi);\r\n        state.poiMarkers.set(normalizedPoi.id, marker);\r\n\r\n        // Note: La sauvegarde en cache est g√©r√©e par le submit-handler via SyncHandler\r\n        // pour √©viter la duplication et assurer la coh√©rence\r\n\r\n        if (Log) Log.info('[POI] ‚úÖ POI normalis√© ajout√© avec succ√®s :', normalizedPoi.id);\r\n\r\n        return marker;\r\n    }\r\n\r\n    /**\r\n     * R√©cup√®re tous les POI charg√©s.\r\n     *\r\n     * @returns {array} Tableau des POI.\r\n     */\r\n    function getAllPois() {\r\n        const shared = getShared();\r\n        return shared ? shared.state.allPois : [];\r\n    }\r\n\r\n    /**\r\n     * R√©cup√®re un POI par son ID.\r\n     *\r\n     * @param {string} id - ID du POI.\r\n     * @returns {object|null} POI trouv√© ou null.\r\n     */\r\n    function getPoiById(id) {\r\n        const shared = getShared();\r\n        if (!shared) return null;\r\n        const state = shared.state;\r\n\r\n        return state.allPois.find(p => p.id === id) || null;\r\n    }\r\n\r\n    /**\r\n     * Recharge les POI (efface et r√©affiche).\r\n     *\r\n     * @param {array} pois - Nouveau tableau de POI (optionnel).\r\n     */\r\n    function reload(pois) {\r\n        const shared = getShared();\r\n        if (!shared) return;\r\n        const state = shared.state;\r\n\r\n        if (pois && Array.isArray(pois)) {\r\n            state.allPois = pois;\r\n        }\r\n\r\n        displayPois(state.allPois);\r\n\r\n        if (Log) Log.info('[POI] POI recharg√©s.');\r\n    }\r\n\r\n    // ========================================\r\n    //   EXPORT\r\n    // ========================================\r\n\r\n    GeoLeaf._POICore = {\r\n        init,\r\n        loadAndDisplay,\r\n        displayPois,\r\n        addPoi,\r\n        getAllPois,\r\n        getPoiById,\r\n        reload,\r\n        getDisplayedPoisCount: function() {\r\n            const shared = getShared();\r\n            return shared && shared.state ? (shared.state.allPois || []).length : 0;\r\n        }\r\n    };\r\n\r\n})(typeof window !== \"undefined\" ? window : global);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n/**\r\n * GeoLeaf POI Module - Aggregator\r\n *\r\n * Ce fichier est maintenant un agr√©gateur UMD qui expose l'API publique du module POI.\r\n * Les fonctionnalit√©s principales sont impl√©ment√©es dans les sous-modules :\r\n *\r\n * - poi/shared.js      : √âtat partag√© et constantes\r\n * - poi/normalizers.js : Normalisation des donn√©es POI\r\n * - poi/popup.js       : Popups et tooltips\r\n * - poi/markers.js     : Cr√©ation de marqueurs\r\n * - poi/sidepanel.js   : Panneau lat√©ral\r\n * - poi/renderers.js   : Rendu du contenu\r\n * - poi/core.js        : Fonctions principales (init, load, display)\r\n *\r\n * En production, Rollup bundle automatiquement tous les modules ensemble.\r\n * En d√©veloppement, chaque module est charg√© s√©par√©ment dans demo/index.html.\r\n *\r\n * Pour plus de d√©tails, voir docs/poi/POI_SPLIT_STRATEGY.md\r\n *\r\n * @version 2.1.0\r\n * @since 2.0.0\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    const Log = GeoLeaf.Log;\r\n\r\n    // R√©f√©rences aux sous-modules POI (charg√©s via getters pour √©viter les d√©pendances circulaires)\r\n    const POICore = () => GeoLeaf._POICore;\r\n    const POISidePanel = () => GeoLeaf._POISidePanel;\r\n    const POIShared = () => GeoLeaf._POIShared;\r\n\r\n    /**\r\n     * API publique du module POI\r\n     * Toutes les fonctions d√©l√®guent aux sous-modules appropri√©s\r\n     */\r\n    // Pr√©server GeoLeaf.POI.Renderers s'il existe d√©j√† (d√©fini par field-renderers.js, etc.)\r\n    const existingRenderers = GeoLeaf.POI && GeoLeaf.POI.Renderers;\r\n\r\n    GeoLeaf.POI = (function () {\r\n        return {\r\n            // Restaurer les Renderers d√©finis avant\r\n            Renderers: existingRenderers || {},\r\n\r\n            /**\r\n             * Initialise le module POI avec la carte et la configuration.\r\n             * Supporte deux signatures: init(map, config) et init({map, config}).\r\n             *\r\n             * @param {L.Map|object} mapOrOptions - Instance Leaflet ou objet avec {map, config}\r\n             * @param {object} [config] - Configuration POI (optionnel si premier param est objet)\r\n             */\r\n            init: function (mapOrOptions, config) {\r\n                const core = POICore();\r\n                if (!core) {\r\n                    if (Log) Log.error('[POI] Module Core non charg√©.');\r\n                    return;\r\n                }\r\n                core.init(mapOrOptions, config);\r\n            },\r\n\r\n            /**\r\n             * Charge et affiche les POIs sur la carte.\r\n             */\r\n            loadAndDisplay: function () {\r\n                const core = POICore();\r\n                if (!core) {\r\n                    if (Log) Log.error('[POI] Module Core non charg√©.');\r\n                    return;\r\n                }\r\n                core.loadAndDisplay();\r\n            },\r\n\r\n            /**\r\n             * Affiche un tableau de POIs sur la carte.\r\n             *\r\n             * @param {array} pois - Tableau d'objets POI\r\n             */\r\n            displayPois: function (pois) {\r\n                const core = POICore();\r\n                if (!core) {\r\n                    if (Log) Log.error('[POI] Module Core non charg√©.');\r\n                    return;\r\n                }\r\n                core.displayPois(pois);\r\n            },\r\n\r\n            /**\r\n             * Ajoute un POI manuellement √† la carte.\r\n             *\r\n             * @param {object} poi - Donn√©es du POI\r\n             * @returns {L.Marker|null} Marqueur cr√©√© ou null\r\n             */\r\n            addPoi: function (poi) {\r\n                const core = POICore();\r\n                if (!core) {\r\n                    if (Log) Log.error('[POI] Module Core non charg√©.');\r\n                    return null;\r\n                }\r\n                return core.addPoi(poi);\r\n            },\r\n\r\n            /**             * Ajoute un nouveau POI √† la carte.\r\n             *\r\n             * @param {object} poi - Donn√©es du POI √† ajouter\r\n             * @returns {boolean} true si ajout r√©ussi, false sinon\r\n             */\r\n            add: function (poi) {\r\n                const core = POICore();\r\n                if (!core) {\r\n                    if (Log) Log.error('[POI] Module Core non charg√©.');\r\n                    return false;\r\n                }\r\n                return core.addPoi(poi);\r\n            },\r\n\r\n            /**\r\n             * Alias pour add() - ajoute un POI.\r\n             *\r\n             * @param {object} poi - Donn√©es du POI\r\n             * @returns {boolean} true si ajout r√©ussi, false sinon\r\n             */\r\n            addPoi: function (poi) {\r\n                return this.add(poi);\r\n            },\r\n\r\n            /**             * R√©cup√®re tous les POI charg√©s.\r\n             *\r\n             * @returns {array} Tableau des POI\r\n             */\r\n            getAllPois: function () {\r\n                const core = POICore();\r\n                if (!core) return [];\r\n                return core.getAllPois();\r\n            },\r\n\r\n            /**\r\n             * R√©cup√®re un POI par son ID.\r\n             *\r\n             * @param {string} id - ID du POI\r\n             * @returns {object|null} POI trouv√© ou null\r\n             */\r\n            getPoiById: function (id) {\r\n                const core = POICore();\r\n                if (!core) return null;\r\n                return core.getPoiById(id);\r\n            },\r\n\r\n            /**\r\n             * Recharge les POIs (efface et r√©affiche).\r\n             *\r\n             * @param {array} [pois] - Nouveau tableau de POI (optionnel)\r\n             */\r\n            reload: function (pois) {\r\n                const core = POICore();\r\n                if (!core) {\r\n                    if (Log) Log.error('[POI] Module Core non charg√©.');\r\n                    return;\r\n                }\r\n                core.reload(pois);\r\n            },\r\n\r\n            /**\r\n             * Affiche le panneau lat√©ral avec les d√©tails d'un POI.\r\n             *\r\n             * @param {object} poi - Donn√©es du POI\r\n             * @param {array} [customLayout] - Layout personnalis√© (optionnel)\r\n             * @returns {Promise<void>}\r\n             */\r\n            showPoiDetails: async function (poi, customLayout) {\r\n                const sidePanel = POISidePanel();\r\n                if (!sidePanel) {\r\n                    if (Log) Log.error('[POI] Module SidePanel non charg√©.');\r\n                    return;\r\n                }\r\n                await sidePanel.openSidePanel(poi, customLayout);\r\n            },\r\n\r\n            /**\r\n             * Ferme le panneau lat√©ral.\r\n             */\r\n            hideSidePanel: function () {\r\n                const sidePanel = POISidePanel();\r\n                if (!sidePanel) {\r\n                    if (Log) Log.error('[POI] Module SidePanel non charg√©.');\r\n                    return;\r\n                }\r\n                sidePanel.closeSidePanel();\r\n            },\r\n\r\n            /**\r\n             * Alias pour showPoiDetails avec layout personnalis√©.\r\n             *\r\n             * @param {object} poi - Donn√©es du POI\r\n             * @param {array} customLayout - Layout personnalis√©\r\n             */\r\n            openSidePanelWithLayout: function (poi, customLayout) {\r\n                this.showPoiDetails(poi, customLayout);\r\n            },\r\n\r\n            /**\r\n             * R√©cup√®re le layer group Leaflet actif (cluster ou simple).\r\n             *\r\n             * @returns {L.LayerGroup|L.MarkerClusterGroup|null} Layer group ou null\r\n             */\r\n            getLayer: function () {\r\n                const shared = POIShared();\r\n                if (!shared) return null;\r\n                const state = shared.state;\r\n                return state.poiClusterGroup || state.poiLayerGroup;\r\n            },\r\n\r\n            /**\r\n             * Obtient le nombre de POI actuellement affich√©s.\r\n             *\r\n             * @returns {number} Nombre de POI affich√©s\r\n             */\r\n            getDisplayedPoisCount: function () {\r\n                const core = POICore();\r\n                if (!core) {\r\n                    if (Log) Log.error('[POI] Module Core non charg√©.');\r\n                    return 0;\r\n                }\r\n                return core.getDisplayedPoisCount();\r\n            },\r\n\r\n            /**\r\n             * Helper pour tests unitaires : efface tous les POI.\r\n             * @private\r\n             */\r\n            _clearAllForTests: function () {\r\n                const shared = POIShared();\r\n                if (!shared) return;\r\n                const state = shared.state;\r\n\r\n                if (Log) Log.info('[POI] _clearAllForTests: Suppression de', state.allPois.length, 'POI(s) et', state.poiMarkers.size, 'marqueur(s)');\r\n\r\n                state.allPois = [];\r\n                state.poiMarkers.clear();\r\n                if (state.poiClusterGroup) state.poiClusterGroup.clearLayers();\r\n                if (state.poiLayerGroup) state.poiLayerGroup.clearLayers();\r\n            }\r\n        };\r\n    })();\r\n\r\n})(typeof window !== \"undefined\" ? window : global);\r\n","/**\r\n * GeoLeaf GeoJSON Module - Shared State & Constants\r\n * √âtat partag√© et constantes pour le module GeoJSON\r\n *\r\n * @module geojson/shared\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    const Log = GeoLeaf.Log;\r\n\r\n    /**\r\n     * √âtat partag√© du module GeoJSON\r\n     * Accessible via GeoLeaf._GeoJSONShared.state\r\n     */\r\n    GeoLeaf._GeoJSONShared = GeoLeaf._GeoJSONShared || {};\r\n\r\n    /**\r\n     * √âtat interne partag√© entre les sous-modules\r\n     */\r\n    GeoLeaf._GeoJSONShared.state = {\r\n        /**\r\n         * R√©f√©rence vers la carte Leaflet.\r\n         * @type {L.Map|null}\r\n         */\r\n        map: null,\r\n\r\n        /**\r\n         * Groupe contenant toutes les couches GeoJSON (conteneur parent).\r\n         * @type {L.LayerGroup|null}\r\n         */\r\n        layerGroup: null,\r\n\r\n        /**\r\n         * LEGACY: Couche L.GeoJSON principale (pour compatibilit√© descendante).\r\n         * @deprecated Utiliser layers pour multi-couches.\r\n         * @type {L.GeoJSON|null}\r\n         */\r\n        geoJsonLayer: null,\r\n\r\n        /**\r\n         * Map des couches individuelles par ID.\r\n         * Structure: Map<layerId, {id, label, layer, visible, config, clusterGroup}>\r\n         * @type {Map<string, Object>}\r\n         */\r\n        layers: new Map(),\r\n\r\n        /**\r\n         * Compteur pour g√©n√©rer des IDs uniques si non fourni.\r\n         * @type {number}\r\n         */\r\n        layerIdCounter: 0,\r\n\r\n        /**\r\n         * Cache l√©ger des features par couche (geojson/features d√©j√† converties).\r\n         * Map<layerId, { features: Array, geometryType: string }>\r\n         * @type {Map<string, Object>}\r\n         */\r\n        featureCache: new Map(),\r\n\r\n        /**\r\n         * Options par d√©faut du module GeoJSON.\r\n         */\r\n        options: {\r\n            /**\r\n             * Style par d√©faut des g√©om√©tries (polygones / lignes).\r\n             */\r\n            defaultStyle: {\r\n                color: \"#2E7D32\",\r\n                weight: 2,\r\n                opacity: 0.9,\r\n                fillColor: \"#66BB6A\",\r\n                fillOpacity: 0.4\r\n            },\r\n            /**\r\n             * Style des points (circleMarker).\r\n             */\r\n            defaultPointStyle: {\r\n                radius: 6,\r\n                color: \"#1B5E20\",\r\n                weight: 2,\r\n                fillColor: \"#66BB6A\",\r\n                fillOpacity: 0.9\r\n            },\r\n            /**\r\n             * Fonction de rappel pour chaque feature.\r\n             * @param {Object} feature\r\n             * @param {L.Layer} layer\r\n             */\r\n            onEachFeature: null,\r\n            /**\r\n             * Fonction pointToLayer personnalis√©e (si fournie).\r\n             * @param {Object} feature\r\n             * @param {L.LatLng} latlng\r\n             * @returns {L.Layer}\r\n             */\r\n            pointToLayer: null,\r\n            /**\r\n             * Adapter automatiquement la vue sur les donn√©es charg√©es.\r\n             */\r\n            fitBoundsOnLoad: true,\r\n            /**\r\n             * ZOOM max lors du fitBounds (facultatif).\r\n             */\r\n            maxZoomOnFit: GeoLeaf.CONSTANTS ? GeoLeaf.CONSTANTS.GEOJSON_MAX_ZOOM_ON_FIT : 18\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Constantes pour la gestion des panes Leaflet et z-index\r\n     */\r\n    GeoLeaf._GeoJSONShared.PANE_CONFIG = {\r\n        BASEMAP_NAME: 'geoleaf-basemap',\r\n        BASEMAP_ZINDEX: 200,\r\n        LAYER_PREFIX: 'geoleaf-layer-',\r\n        LAYER_BASE_ZINDEX: 400,\r\n        MIN_LAYER_ZINDEX: 0,\r\n        MAX_LAYER_ZINDEX: 99\r\n    };\r\n\r\n    /**\r\n     * Helpers pour la gestion des panes\r\n     */\r\n    GeoLeaf._GeoJSONShared.PaneHelpers = {\r\n        /**\r\n         * G√©n√®re le nom du pane pour un zIndex donn√©\r\n         * @param {number} zIndex - zIndex de la couche (0-99)\r\n         * @returns {string} Nom du pane\r\n         */\r\n        getPaneName(zIndex) {\r\n            const config = GeoLeaf._GeoJSONShared.PANE_CONFIG;\r\n            return `${config.LAYER_PREFIX}${zIndex || 0}`;\r\n        },\r\n\r\n        /**\r\n         * Valide et clamp un zIndex dans la plage autoris√©e\r\n         * @param {number} zIndex - zIndex √† valider\r\n         * @returns {number} zIndex valide (0-99)\r\n         */\r\n        validateZIndex(zIndex) {\r\n            const config = GeoLeaf._GeoJSONShared.PANE_CONFIG;\r\n            return Math.max(config.MIN_LAYER_ZINDEX, Math.min(config.MAX_LAYER_ZINDEX, Math.floor(zIndex)));\r\n        },\r\n\r\n        /**\r\n         * Applique le pane √† un layer ou marker\r\n         * @param {L.Layer} layer - Layer Leaflet\r\n         * @param {number} zIndex - zIndex de la couche\r\n         */\r\n        applyPaneToLayer(layer, zIndex) {\r\n            if (layer && layer.options) {\r\n                layer.options.pane = this.getPaneName(zIndex);\r\n            }\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Map des op√©rateurs de comparaison pour styleRules.\r\n     * Supporte : >, >=, <, <=, ==, ===, eq (alias ==), !=, !==, contains, startsWith, endsWith, in, notIn, between\r\n     */\r\n    GeoLeaf._GeoJSONShared.STYLE_OPERATORS = {\r\n        '>': (a, b) => Number(a) > Number(b),\r\n        '>=': (a, b) => Number(a) >= Number(b),\r\n        '<': (a, b) => Number(a) < Number(b),\r\n        '<=': (a, b) => Number(a) <= Number(b),\r\n        '==': (a, b) => a == b,\r\n        '===': (a, b) => a === b,\r\n        'eq': (a, b) => a == b,  // Alias pour ==\r\n        '!=': (a, b) => a != b,\r\n        '!==': (a, b) => a !== b,\r\n        'neq': (a, b) => a != b, // Alias pour !=\r\n        'contains': (a, b) => String(a).toLowerCase().includes(String(b).toLowerCase()),\r\n        'startsWith': (a, b) => String(a).toLowerCase().startsWith(String(b).toLowerCase()),\r\n        'endsWith': (a, b) => String(a).toLowerCase().endsWith(String(b).toLowerCase()),\r\n        'in': (a, b) => Array.isArray(b) && b.includes(a),\r\n        'notIn': (a, b) => Array.isArray(b) && !b.includes(a),\r\n        'between': (a, b) => {\r\n            if (!Array.isArray(b) || b.length !== 2) return false;\r\n            const num = Number(a);\r\n            const min = Number(b[0]);\r\n            const max = Number(b[1]);\r\n            return num >= min && num <= max;\r\n        }\r\n    };\r\n\r\n    /**\r\n     * R√©initialise l'√©tat partag√© (utile pour les tests)\r\n     */\r\n    GeoLeaf._GeoJSONShared.reset = function () {\r\n        const state = GeoLeaf._GeoJSONShared.state;\r\n        state.map = null;\r\n        state.layerGroup = null;\r\n        state.geoJsonLayer = null;\r\n        state.layers = new Map();\r\n        state.layerIdCounter = 0;\r\n        state.featureCache = new Map();\r\n        // R√©initialiser les options par d√©faut\r\n        state.options = {\r\n            defaultStyle: {\r\n                color: \"#2E7D32\",\r\n                weight: 2,\r\n                opacity: 0.9,\r\n                fillColor: \"#66BB6A\",\r\n                fillOpacity: 0.4\r\n            },\r\n            defaultPointStyle: {\r\n                radius: 6,\r\n                color: \"#1B5E20\",\r\n                weight: 2,\r\n                fillColor: \"#66BB6A\",\r\n                fillOpacity: 0.9\r\n            },\r\n            onEachFeature: null,\r\n            pointToLayer: null,\r\n            fitBoundsOnLoad: true,\r\n            maxZoomOnFit: GeoLeaf.CONSTANTS ? GeoLeaf.CONSTANTS.GEOJSON_MAX_ZOOM_ON_FIT : 18\r\n        };\r\n    };\r\n\r\n    /**\r\n     * Getter pour le Log (lazy loading)\r\n     */\r\n    GeoLeaf._GeoJSONShared.getLog = function () {\r\n        return GeoLeaf.Log || console;\r\n    };\r\n\r\n})(window);\r\n","/**\r\n * GeoLeaf GeoJSON Module - Style Resolver\r\n * √âvaluation des r√®gles de style dynamiques (styleRules)\r\n *\r\n * @module geojson/style-resolver\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n\r\n    // D√©pendance lazy vers shared\r\n    const getShared = () => GeoLeaf._GeoJSONShared;\r\n    const getLog = () => (GeoLeaf.Log || console);\r\n\r\n    GeoLeaf._GeoJSONStyleResolver = GeoLeaf._GeoJSONStyleResolver || {};\r\n\r\n    /**\r\n     * R√©sout une valeur imbriqu√©e dans un objet via un chemin (ex: \"properties.name\").\r\n     * @param {Object} obj - Objet source\r\n     * @param {string} path - Chemin (dot notation)\r\n     * @returns {*} Valeur trouv√©e ou null\r\n     */\r\n    GeoLeaf._GeoJSONStyleResolver.getNestedValue = function (obj, path) {\r\n        if (!obj || !path) return null;\r\n        return path.split('.').reduce((current, prop) =>\r\n            current && current[prop] !== undefined ? current[prop] : null, obj);\r\n    };\r\n\r\n    /**\r\n     * √âvalue une condition simple contre une feature GeoJSON.\r\n     * @param {Object} feature - Feature GeoJSON\r\n     * @param {Object} condition - {field, operator, value}\r\n     * @param {Object} STYLE_OPERATORS - Op√©rateurs de comparaison\r\n     * @param {Object} Log - Logger\r\n     * @returns {boolean} true si la condition est remplie\r\n     */\r\n    GeoLeaf._GeoJSONStyleResolver.evaluateCondition = function (feature, condition, STYLE_OPERATORS, Log) {\r\n        const { field, operator, value } = condition;\r\n        if (!field || !operator) return false;\r\n\r\n        // R√©soudre la valeur du champ depuis la feature\r\n        const fieldValue = GeoLeaf._GeoJSONStyleResolver.getNestedValue(feature, field);\r\n\r\n        // Si le champ n'existe pas, la condition n'est pas remplie\r\n        if (fieldValue === null || fieldValue === undefined) return false;\r\n\r\n        // Obtenir la fonction de comparaison\r\n        const compareFn = STYLE_OPERATORS[operator];\r\n        if (!compareFn) {\r\n            Log.warn && Log.warn('[GeoJSON] Op√©rateur styleRules inconnu:', operator);\r\n            return false;\r\n        }\r\n\r\n        // √âvaluer la condition\r\n        try {\r\n            return compareFn(fieldValue, value);\r\n        } catch (e) {\r\n            Log.warn && Log.warn('[GeoJSON] Erreur √©valuation condition:', e.message);\r\n            return false;\r\n        }\r\n    };\r\n\r\n    /**\r\n     * √âvalue les r√®gles de style (styleRules) contre une feature GeoJSON.\r\n     * Retourne le style de la PREMI√àRE r√®gle correspondante (ordre du tableau).\r\n     * Supporte les formats:\r\n     * - Simple: {when: {field, operator, value}, style: {...}}\r\n     * - Compos√©: {when: {all: [{field, operator, value}, ...]}, style: {...}}\r\n     *\r\n     * @param {Object} feature - Feature GeoJSON\r\n     * @param {Array} styleRules - Tableau de r√®gles\r\n     * @returns {Object|null} Style de la premi√®re r√®gle correspondante, ou null\r\n     */\r\n    GeoLeaf._GeoJSONStyleResolver.evaluateStyleRules = function (feature, styleRules) {\r\n        if (!Array.isArray(styleRules) || styleRules.length === 0) {\r\n            return null;\r\n        }\r\n\r\n        const shared = getShared();\r\n        const Log = getLog();\r\n        const STYLE_OPERATORS = shared.STYLE_OPERATORS;\r\n\r\n        for (const rule of styleRules) {\r\n            if (!rule || !rule.when || !rule.style) continue;\r\n\r\n            // Support du format compos√© avec \"all\": [conditions]\r\n            if (rule.when.all && Array.isArray(rule.when.all)) {\r\n                // V√©rifier que TOUTES les conditions sont remplies\r\n                const allConditionsMet = rule.when.all.every(condition =>\r\n                    GeoLeaf._GeoJSONStyleResolver.evaluateCondition(feature, condition, STYLE_OPERATORS, Log)\r\n                );\r\n\r\n                if (allConditionsMet) {\r\n                    return rule.style;\r\n                }\r\n            }\r\n            // Format simple avec field, operator, value\r\n            else if (rule.when.field && rule.when.operator) {\r\n                const conditionMet = GeoLeaf._GeoJSONStyleResolver.evaluateCondition(\r\n                    feature,\r\n                    rule.when,\r\n                    STYLE_OPERATORS,\r\n                    Log\r\n                );\r\n\r\n                if (conditionMet) {\r\n                    return rule.style;\r\n                }\r\n            }\r\n        }\r\n\r\n        return null;\r\n    };\r\n\r\n    /**\r\n     * Construit les options Leaflet pour L.geoJSON √† partir des options GeoLeaf.\r\n     *\r\n     * @param {Object} options - Options GeoLeaf\r\n     * @returns {Object} - Options Leaflet\r\n     */\r\n    GeoLeaf._GeoJSONStyleResolver.buildLeafletOptions = function (options) {\r\n        const evaluateStyleRules = GeoLeaf._GeoJSONStyleResolver.evaluateStyleRules;\r\n\r\n        const normalizeStyle = (style) => {\r\n            if (!style || typeof style !== 'object') {\r\n                return {};\r\n            }\r\n\r\n            const normalized = {};\r\n\r\n            // Format imbriqu√© fill/stroke\r\n            if (style.fill || style.stroke) {\r\n                if (style.fill) {\r\n                    if (style.fill.color) normalized.fillColor = style.fill.color;\r\n                    if (typeof style.fill.opacity === 'number') {\r\n                        normalized.fillOpacity = style.fill.opacity;\r\n                    } else {\r\n                        normalized.fillOpacity = 1.0;\r\n                    }\r\n                }\r\n\r\n                if (style.stroke) {\r\n                    if (style.stroke.color) normalized.color = style.stroke.color;\r\n                    if (typeof style.stroke.opacity === 'number') normalized.opacity = style.stroke.opacity;\r\n                    if (typeof style.stroke.widthPx === 'number') normalized.weight = style.stroke.widthPx;\r\n                    if (style.stroke.dashArray) normalized.dashArray = style.stroke.dashArray;\r\n                    if (style.stroke.lineCap) normalized.lineCap = style.stroke.lineCap;\r\n                    if (style.stroke.lineJoin) normalized.lineJoin = style.stroke.lineJoin;\r\n                }\r\n\r\n                // Propri√©t√©s communes\r\n                if (style.shape) normalized.shape = style.shape;\r\n                if (typeof style.sizePx === 'number') {\r\n                    normalized.radius = style.sizePx;\r\n                    normalized.sizePx = style.sizePx;\r\n                }\r\n            } else {\r\n                Object.assign(normalized, style);\r\n                if (typeof normalized.fillOpacity !== 'number') {\r\n                    normalized.fillOpacity = 1.0;\r\n                }\r\n            }\r\n\r\n            return normalized;\r\n        };\r\n\r\n        const leafletOptions = {\r\n            /**\r\n             * Style pour polygones / lignes.\r\n             * Priorit√© : defaultStyle < styleRules (premi√®re correspondante) < feature.properties.style\r\n             */\r\n            style(feature) {\r\n                // 1. Commencer avec le style par d√©faut\r\n                let finalStyle = Object.assign({}, normalizeStyle(options.defaultStyle));\r\n\r\n                // 2. Appliquer les styleRules (premi√®re r√®gle correspondante gagne)\r\n                if (options.styleRules && Array.isArray(options.styleRules)) {\r\n                    const matchedStyle = evaluateStyleRules(feature, options.styleRules);\r\n                    if (matchedStyle) {\r\n                        finalStyle = Object.assign({}, finalStyle, normalizeStyle(matchedStyle));\r\n                    }\r\n                }\r\n\r\n                // 3. Mode interactif\r\n                const interactiveShapes = typeof options.interactiveShape === \"boolean\"\r\n                    ? options.interactiveShape\r\n                    : (GeoLeaf.Config && GeoLeaf.Config.get ? GeoLeaf.Config.get('ui.interactiveShapes', false) : false);\r\n                finalStyle.interactive = interactiveShapes;\r\n\r\n                return finalStyle;\r\n            },\r\n\r\n            /**\r\n             * Gestion des points (Point / MultiPoint).\r\n             */\r\n            pointToLayer: options.pointToLayer\r\n                ? function (feature, latlng) {\r\n                      return options.pointToLayer(feature, latlng);\r\n                  }\r\n                : function (feature, latlng) {\r\n                      // Utiliser le param√®tre interactiveShape d√©fini pour cette couche\r\n                      const interactiveShapes = typeof options.interactiveShape === \"boolean\"\r\n                          ? options.interactiveShape\r\n                          : (GeoLeaf.Config && GeoLeaf.Config.get ? GeoLeaf.Config.get('ui.interactiveShapes', false) : false);\r\n                      const pointStyle = GeoLeaf.Utils && GeoLeaf.Utils.mergeOptions\r\n                          ? GeoLeaf.Utils.mergeOptions(options.defaultPointStyle, { interactive: interactiveShapes })\r\n                          : Object.assign({}, options.defaultPointStyle, { interactive: interactiveShapes });\r\n                      return global.L.circleMarker(latlng, pointStyle);\r\n                  },\r\n\r\n            /**\r\n             * Callback pour chaque entit√©.\r\n             */\r\n            onEachFeature: function (feature, layer) {\r\n                // Popup simple par d√©faut si popupContent fourni\r\n                if (\r\n                    feature &&\r\n                    feature.properties &&\r\n                    typeof feature.properties.popupContent === \"string\"\r\n                ) {\r\n                    layer.bindPopup(feature.properties.popupContent);\r\n                }\r\n\r\n                // Callback custom utilisateur\r\n                if (typeof options.onEachFeature === \"function\") {\r\n                    options.onEachFeature(feature, layer);\r\n                }\r\n            }\r\n        };\r\n\r\n        return leafletOptions;\r\n    };\r\n\r\n    // Exposer aussi via _StyleRules pour compatibilit√© avec le module Themes\r\n    GeoLeaf._StyleRules = {\r\n        evaluate: GeoLeaf._GeoJSONStyleResolver.evaluateStyleRules,\r\n        operators: GeoLeaf._GeoJSONShared ? GeoLeaf._GeoJSONShared.STYLE_OPERATORS : {},\r\n        getNestedValue: GeoLeaf._GeoJSONStyleResolver.getNestedValue\r\n    };\r\n\r\n})(window);\r\n","/**\r\n * GeoLeaf GeoJSON Module - Visibility Manager\r\n * Gestionnaire centralis√© de visibilit√© des couches avec gestion des priorit√©s\r\n *\r\n * G√®re trois sources de modification de visibilit√© :\r\n * - 'user': Action manuelle de l'utilisateur (toggle, show/hide explicite)\r\n * - 'theme': Modification par application d'un th√®me\r\n * - 'zoom': Modification automatique selon le niveau de zoom\r\n *\r\n * R√®gles de priorit√© :\r\n * 1. user > theme > zoom (l'utilisateur a toujours le dernier mot)\r\n * 2. Une action 'user' annule les flags 'theme' et 'zoom'\r\n * 3. Une action 'theme' peut override 'zoom' mais pas 'user'\r\n * 4. Une action 'zoom' ne change jamais l'√©tat si 'user' ou 'theme' est actif\r\n *\r\n * @module geojson/visibility-manager\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n\r\n    // D√©pendances lazy\r\n    const getShared = () => GeoLeaf._GeoJSONShared;\r\n    const getState = () => GeoLeaf._GeoJSONShared.state;\r\n    const getLog = () => (GeoLeaf.Log || console);\r\n\r\n    GeoLeaf._LayerVisibilityManager = GeoLeaf._LayerVisibilityManager || {};\r\n\r\n    /**\r\n     * √âtats de visibilit√© possibles\r\n     * @private\r\n     */\r\n    const VisibilitySource = {\r\n        USER: 'user',\r\n        THEME: 'theme',\r\n        ZOOM: 'zoom',\r\n        SYSTEM: 'system'  // Chargement initial, etc.\r\n    };\r\n\r\n    /**\r\n     * Initialise les m√©tadonn√©es de visibilit√© pour une couche\r\n     * @param {Object} layerData - Donn√©es de la couche\r\n     * @private\r\n     */\r\n    function initVisibilityMetadata(layerData) {\r\n        if (!layerData._visibility) {\r\n            layerData._visibility = {\r\n                current: false,           // √âtat actuel physique sur la carte (true/false)\r\n                logicalState: false,      // √âtat logique (bouton ON/OFF, ind√©pendant du zoom)\r\n                source: VisibilitySource.SYSTEM,  // Derni√®re source de modification\r\n                userOverride: false,      // L'utilisateur a forc√© un √©tat\r\n                themeOverride: false,     // Un th√®me a forc√© un √©tat\r\n                themeDesired: null,       // Visibilit√© voulue par le th√®me (true/false)\r\n                zoomConstrained: false    // La couche est limit√©e par le zoom\r\n            };\r\n        }\r\n    }\r\n\r\n    /**\r\n     * D√©finit la visibilit√© d'une couche avec gestion de priorit√©\r\n     *\r\n     * @param {string} layerId - ID de la couche\r\n     * @param {boolean} visible - √âtat de visibilit√© souhait√©\r\n     * @param {string} source - Source de la modification ('user' | 'theme' | 'zoom' | 'system')\r\n     * @returns {boolean} - true si la visibilit√© a √©t√© modifi√©e, false sinon\r\n     */\r\n    GeoLeaf._LayerVisibilityManager.setVisibility = function (layerId, visible, source) {\r\n        const state = getState();\r\n        const Log = getLog();\r\n        const layerData = state.layers.get(layerId);\r\n\r\n        if (!layerData) {\r\n            Log.warn(\"[VisibilityManager] Couche introuvable:\", layerId);\r\n            return false;\r\n        }\r\n\r\n        // Initialiser les m√©tadonn√©es si n√©cessaire\r\n        initVisibilityMetadata(layerData);\r\n\r\n        const meta = layerData._visibility;\r\n        const oldVisible = meta.current;\r\n        const oldSource = meta.source;\r\n\r\n        // Appliquer les r√®gles de priorit√©\r\n        const canChange = this._canChangeVisibility(meta, source, visible);\r\n\r\n        if (!canChange) {\r\n            Log.debug(\r\n                `[VisibilityManager] Changement refus√© pour ${layerId}: ` +\r\n                `source=${source}, userOverride=${meta.userOverride}, themeOverride=${meta.themeOverride}`\r\n            );\r\n            return false;\r\n        }\r\n\r\n        // Mettre √† jour les flags selon la source\r\n        this._updateVisibilityFlags(meta, source, visible);\r\n\r\n        // Appliquer le changement effectif\r\n        const changed = this._applyVisibilityChange(layerId, layerData, visible);\r\n\r\n        if (changed) {\r\n            meta.current = visible;\r\n            meta.source = source;\r\n\r\n            Log.debug(\r\n                `[VisibilityManager] ${layerId}: ${oldVisible} ‚Üí ${visible} ` +\r\n                `(source: ${oldSource} ‚Üí ${source})`\r\n            );\r\n\r\n            // Mettre √† jour les anciens flags pour compatibilit√©\r\n            layerData.visible = visible;\r\n            layerData.userDisabled = meta.userOverride && !visible;\r\n            layerData.themeHidden = meta.themeOverride && !visible;\r\n\r\n            // Notifier la l√©gende\r\n            this._notifyLegend(layerId, visible);\r\n\r\n            // √âmettre l'√©v√©nement\r\n            this._fireVisibilityEvent(layerId, visible, source);\r\n        }\r\n\r\n        return changed;\r\n    };\r\n\r\n    /**\r\n     * V√©rifie si la visibilit√© peut √™tre modifi√©e selon les r√®gles de priorit√©\r\n     * @param {Object} meta - M√©tadonn√©es de visibilit√©\r\n     * @param {string} source - Source de la modification\r\n     * @returns {boolean}\r\n     * @private\r\n     */\r\n    GeoLeaf._LayerVisibilityManager._canChangeVisibility = function (meta, source, desiredVisible) {\r\n        // L'utilisateur peut toujours modifier\r\n        if (source === VisibilitySource.USER) {\r\n            return true;\r\n        }\r\n\r\n        // IMPORTANT: Le zoom DOIT TOUJOURS pouvoir modifier l'affichage physique (current)\r\n        // m√™me si userOverride est true. Cela permet d'afficher/masquer selon les seuils de zoom\r\n        // tout en gardant logicalState ind√©pendant.\r\n        if (source === VisibilitySource.ZOOM) {\r\n            return true;\r\n        }\r\n\r\n        // Si l'utilisateur a d√©fini un override, seul l'utilisateur peut changer l'√©tat logique\r\n        if (meta.userOverride) {\r\n            return false;\r\n        }\r\n\r\n        // Ne jamais r√©activer ce qu'un th√®me a explicitement masqu√©\r\n        if (source === VisibilitySource.ZOOM && meta.themeOverride && meta.themeDesired === false && desiredVisible === true) {\r\n            return false;\r\n        }\r\n\r\n        // Les th√®mes peuvent override le zoom mais pas l'utilisateur\r\n        if (source === VisibilitySource.THEME) {\r\n            return true;\r\n        }\r\n\r\n        // Par d√©faut, autoriser (pour 'system' et autres)\r\n        return true;\r\n    };\r\n\r\n    /**\r\n     * Met √† jour les flags de visibilit√© selon la source\r\n     * @param {Object} meta - M√©tadonn√©es de visibilit√©\r\n     * @param {string} source - Source de la modification\r\n     * @param {boolean} visible - √âtat de visibilit√©\r\n     * @private\r\n     */\r\n    GeoLeaf._LayerVisibilityManager._updateVisibilityFlags = function (meta, source, visible) {\r\n        switch (source) {\r\n            case VisibilitySource.USER:\r\n                meta.userOverride = true;\r\n                meta.themeOverride = false;  // Reset theme override\r\n                meta.zoomConstrained = false;\r\n                meta.logicalState = visible; // Mettre √† jour l'√©tat logique\r\n                break;\r\n\r\n            case VisibilitySource.THEME:\r\n                // Ne pas override userOverride si d√©j√† pr√©sent\r\n                if (!meta.userOverride) {\r\n                    meta.themeOverride = true;\r\n                    meta.themeDesired = visible;\r\n                    meta.zoomConstrained = false;\r\n                    meta.logicalState = visible; // Mettre √† jour l'√©tat logique\r\n                }\r\n                break;\r\n\r\n            case VisibilitySource.ZOOM:\r\n                // Marquer la contrainte zoom (sauf override utilisateur)\r\n                // NE PAS modifier logicalState - le zoom n'affecte pas l'√©tat logique\r\n                if (!meta.userOverride) {\r\n                    meta.zoomConstrained = true;\r\n                }\r\n                break;\r\n\r\n            case VisibilitySource.SYSTEM:\r\n                // Reset tous les overrides pour un chargement propre\r\n                meta.userOverride = false;\r\n                meta.themeOverride = false;\r\n                meta.themeDesired = null;\r\n                meta.zoomConstrained = false;\r\n                meta.logicalState = visible; // Initialiser l'√©tat logique\r\n                break;\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Applique physiquement le changement de visibilit√© (add/remove layer)\r\n     * @param {string} layerId - ID de la couche\r\n     * @param {Object} layerData - Donn√©es de la couche\r\n     * @param {boolean} visible - √âtat de visibilit√© souhait√©\r\n     * @returns {boolean} - true si un changement a √©t√© effectu√©\r\n     * @private\r\n     */\r\n    GeoLeaf._LayerVisibilityManager._applyVisibilityChange = function (layerId, layerData, visible) {\r\n        const state = getState();\r\n        const Log = getLog();\r\n\r\n        if (!layerData.layer) {\r\n            Log.warn(\"[VisibilityManager] Layer Leaflet manquant pour:\", layerId);\r\n            return false;\r\n        }\r\n\r\n        // D√©terminer quelle couche g√©rer (cluster ou layer)\r\n        const layerToManage = layerData.clusterGroup || layerData.layer;\r\n        const isCurrentlyOnMap = state.map && state.map.hasLayer(layerToManage);\r\n\r\n        // Si d√©j√† dans l'√©tat souhait√©, ne rien faire\r\n        if (visible && isCurrentlyOnMap) {\r\n            return false;\r\n        }\r\n        if (!visible && !isCurrentlyOnMap) {\r\n            return false;\r\n        }\r\n\r\n        try {\r\n            if (visible) {\r\n                // Cas 1 : Cluster partag√© avec POI\r\n                if (layerData.useSharedCluster && layerData.clusterGroup) {\r\n                    layerData.clusterGroup.addLayer(layerData.layer);\r\n                }\r\n                // Cas 2 : Cluster ind√©pendant\r\n                else if (layerData.clusterGroup) {\r\n                    state.map.addLayer(layerData.clusterGroup);\r\n                    if (layerData.clusterGroup.refreshClusters) {\r\n                        layerData.clusterGroup.refreshClusters();\r\n                    }\r\n                }\r\n                // Cas 3 : Pas de cluster - ajouter directement √† la map pour respecter le pane\r\n                else {\r\n                    state.map.addLayer(layerData.layer);\r\n                }\r\n            } else {\r\n                // Cas 1 : Cluster partag√© avec POI\r\n                if (layerData.useSharedCluster && layerData.clusterGroup) {\r\n                    layerData.clusterGroup.removeLayer(layerData.layer);\r\n                }\r\n                // Cas 2 : Cluster ind√©pendant\r\n                else if (layerData.clusterGroup) {\r\n                    state.map.removeLayer(layerData.clusterGroup);\r\n                }\r\n                // Cas 3 : Pas de cluster - retirer directement de la map\r\n                else {\r\n                    state.map.removeLayer(layerData.layer);\r\n                }\r\n            }\r\n\r\n            // Synchroniser l'UI du Layer Manager et le bouton labels apr√®s changement r√©ussi\r\n            // Utilise le refresh debounced pour grouper les changements multiples (ex: zoom)\r\n            if (GeoLeaf.LayerManager && typeof GeoLeaf.LayerManager.refresh === 'function') {\r\n                GeoLeaf.LayerManager.refresh(); // Debounced par d√©faut (100ms)\r\n            }\r\n\r\n            if (GeoLeaf._LabelButtonManager && typeof GeoLeaf._LabelButtonManager.syncImmediate === 'function') {\r\n                GeoLeaf._LabelButtonManager.syncImmediate(layerId);\r\n            }\r\n\r\n            return true;\r\n\r\n        } catch (err) {\r\n            Log.error(`[VisibilityManager] Erreur lors du changement de visibilit√© de ${layerId}:`, err);\r\n            return false;\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Notifie le module Legend d'un changement de visibilit√©\r\n     * @param {string} layerId - ID de la couche\r\n     * @param {boolean} visible - √âtat de visibilit√©\r\n     * @private\r\n     */\r\n    GeoLeaf._LayerVisibilityManager._notifyLegend = function (layerId, visible) {\r\n        if (GeoLeaf.Legend && typeof GeoLeaf.Legend.setLayerVisibility === \"function\") {\r\n            GeoLeaf.Legend.setLayerVisibility(layerId, visible);\r\n        }\r\n\r\n        // Notifier aussi le module Labels pour masquer/afficher les √©tiquettes\r\n        if (GeoLeaf.Labels) {\r\n            if (visible) {\r\n                // Si la couche devient visible, v√©rifier si les labels doivent √™tre affich√©s\r\n                // refreshLabels ne fait rien si les labels ne sont pas enabled\r\n                if (typeof GeoLeaf.Labels.refreshLabels === \"function\") {\r\n                    GeoLeaf.Labels.refreshLabels(layerId);\r\n                }\r\n            } else {\r\n                // Si la couche devient invisible, masquer les labels (sans changer enabled)\r\n                if (typeof GeoLeaf.Labels._hideLabelsForLayer === \"function\") {\r\n                    GeoLeaf.Labels._hideLabelsForLayer(layerId);\r\n                }\r\n            }\r\n        }\r\n\r\n        // Synchroniser le bouton de label pour refl√©ter la visibilit√© de la couche\r\n        if (GeoLeaf._LabelButtonManager && typeof GeoLeaf._LabelButtonManager.syncImmediate === \"function\") {\r\n            GeoLeaf._LabelButtonManager.syncImmediate(layerId);\r\n        }\r\n    };\r\n\r\n    /**\r\n     * √âmet un √©v√©nement de changement de visibilit√©\r\n     * @param {string} layerId - ID de la couche\r\n     * @param {boolean} visible - √âtat de visibilit√©\r\n     * @param {string} source - Source du changement\r\n     * @private\r\n     */\r\n    GeoLeaf._LayerVisibilityManager._fireVisibilityEvent = function (layerId, visible, source) {\r\n        const state = getState();\r\n        if (!state.map) return;\r\n\r\n        try {\r\n            state.map.fire(\"geoleaf:geojson:visibility-changed\", {\r\n                layerId: layerId,\r\n                visible: visible,\r\n                source: source\r\n            });\r\n        } catch (e) {\r\n            // Silencieux\r\n        }\r\n    };\r\n\r\n    /**\r\n     * R√©initialise les overrides utilisateur pour une couche\r\n     * Utilis√© par les th√®mes pour reprendre le contr√¥le\r\n     *\r\n     * @param {string} layerId - ID de la couche\r\n     */\r\n    GeoLeaf._LayerVisibilityManager.resetUserOverride = function (layerId) {\r\n        const state = getState();\r\n        const layerData = state.layers.get(layerId);\r\n\r\n        if (layerData && layerData._visibility) {\r\n            layerData._visibility.userOverride = false;\r\n            getLog().debug(`[VisibilityManager] User override r√©initialis√© pour ${layerId}`);\r\n        }\r\n    };\r\n\r\n    /**\r\n     * R√©initialise tous les overrides utilisateur\r\n     * Utilis√© par les th√®mes lors d'un changement complet de th√®me\r\n     */\r\n    GeoLeaf._LayerVisibilityManager.resetAllUserOverrides = function () {\r\n        const state = getState();\r\n        let count = 0;\r\n\r\n        state.layers.forEach((layerData, layerId) => {\r\n            if (layerData._visibility && layerData._visibility.userOverride) {\r\n                layerData._visibility.userOverride = false;\r\n                count++;\r\n            }\r\n        });\r\n\r\n        if (count > 0) {\r\n            getLog().debug(`[VisibilityManager] ${count} user override(s) r√©initialis√©(s)`);\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Obtient l'√©tat de visibilit√© complet d'une couche\r\n     * @param {string} layerId - ID de la couche\r\n     * @returns {Object|null} - M√©tadonn√©es de visibilit√© ou null\r\n     */\r\n    GeoLeaf._LayerVisibilityManager.getVisibilityState = function (layerId) {\r\n        const state = getState();\r\n        const layerData = state.layers.get(layerId);\r\n\r\n        if (!layerData) {\r\n            return null;\r\n        }\r\n\r\n        initVisibilityMetadata(layerData);\r\n\r\n        return {\r\n            current: layerData._visibility.current,\r\n            source: layerData._visibility.source,\r\n            userOverride: layerData._visibility.userOverride,\r\n            themeOverride: layerData._visibility.themeOverride,\r\n            zoomConstrained: layerData._visibility.zoomConstrained\r\n        };\r\n    };\r\n\r\n    /**\r\n     * Exporte les constantes pour utilisation externe\r\n     */\r\n    GeoLeaf._LayerVisibilityManager.VisibilitySource = VisibilitySource;\r\n\r\n    getLog().info(\"[GeoLeaf._LayerVisibilityManager] Module charg√©\");\r\n\r\n})(window);\r\n","/**\r\n * GeoLeaf GeoJSON Layer Manager - Store\r\n * Layer CRUD operations: get, query, remove, z-index\r\n *\r\n * @module geojson/layer-manager/store\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n\r\n    // D√©pendances lazy\r\n    const getShared = () => GeoLeaf._GeoJSONShared;\r\n    const getState = () => GeoLeaf._GeoJSONShared.state;\r\n    const getLog = () => (GeoLeaf.Log || console);\r\n\r\n    const LayerManager = GeoLeaf._GeoJSONLayerManager = GeoLeaf._GeoJSONLayerManager || {};\r\n\r\n    /**\r\n     * R√©cup√®re une couche sp√©cifique par son ID.\r\n     *\r\n     * @param {string} layerId - ID de la couche\r\n     * @returns {Object|null} - { id, label, layer, visible, config, clusterGroup } ou null\r\n     */\r\n    LayerManager.getLayerById = function (layerId) {\r\n        const state = getState();\r\n        return state.layers.get(layerId) || null;\r\n    };\r\n\r\n    /**\r\n     * R√©cup√®re les donn√©es d'une couche (geojson, geometryType, config).\r\n     * Utilis√© par le module Themes pour appliquer les styles.\r\n     *\r\n     * @param {string} layerId - ID de la couche\r\n     * @returns {Object|null} - { geojson, geometryType, config } ou null\r\n     */\r\n    LayerManager.getLayerData = function (layerId) {\r\n        const state = getState();\r\n        const layerData = state.layers.get(layerId);\r\n        if (!layerData) return null;\r\n\r\n        return {\r\n            geojson: layerData.geojson || null,\r\n            features: layerData.features || [],\r\n            geometryType: layerData.geometryType || 'unknown',\r\n            config: layerData.config || {},\r\n            layer: layerData.layer\r\n        };\r\n    };\r\n\r\n    /**\r\n     * R√©cup√®re toutes les couches charg√©es.\r\n     *\r\n     * @returns {Array<Object>} - Tableau de { id, label, visible, type, featureCount }\r\n     *\r\n     * Note: 'visible' retourne l'√©tat LOGIQUE de la couche (activ√©e/d√©sactiv√©e par l'utilisateur ou le th√®me),\r\n     * pas l'√©tat physique sur la carte (qui peut √™tre masqu√©e par le zoom).\r\n     * C'est l'√©tat qui doit √™tre refl√©t√© par le bouton ON/OFF du gestionnaire de couches.\r\n     */\r\n    LayerManager.getAllLayers = function () {\r\n        const state = getState();\r\n        const Log = getLog();\r\n        const layers = [];\r\n        state.layers.forEach((layerData, id) => {\r\n            // Utiliser logicalState qui est ind√©pendant du zoom\r\n            const meta = layerData._visibility;\r\n            const logicalVisible = meta && typeof meta.logicalState === 'boolean'\r\n                ? meta.logicalState\r\n                : (layerData.visible || false);\r\n\r\n            // DEBUG\r\n            if (Log && id === 'hebergements') {\r\n                Log.info(`[getAllLayers] ${id}: logicalState=${meta?.logicalState}, current=${meta?.current}, visible=${layerData.visible}, userOverride=${meta?.userOverride}, themeOverride=${meta?.themeOverride}`);\r\n            }\r\n\r\n            layers.push({\r\n                id: id,\r\n                label: layerData.label,\r\n                visible: logicalVisible,\r\n                type: LayerManager.detectLayerType(layerData.layer),\r\n                featureCount: layerData.layer ? layerData.layer.getLayers().length : 0\r\n            });\r\n        });\r\n        return layers;\r\n    };\r\n\r\n    /**\r\n     * D√©tecte le type de g√©om√©trie dominant d'une couche.\r\n     *\r\n     * @param {L.GeoJSON} layer\r\n     * @returns {string} - \"poi\", \"route\", \"area\", ou \"mixed\"\r\n     */\r\n    LayerManager.detectLayerType = function (layer) {\r\n        if (!layer || typeof layer.eachLayer !== 'function') return \"mixed\";\r\n\r\n        const types = { Point: 0, LineString: 0, Polygon: 0 };\r\n\r\n        layer.eachLayer((l) => {\r\n            if (l.feature && l.feature.geometry) {\r\n                const geomType = l.feature.geometry.type;\r\n                if (geomType.includes(\"Point\")) types.Point++;\r\n                else if (geomType.includes(\"LineString\")) types.LineString++;\r\n                else if (geomType.includes(\"Polygon\")) types.Polygon++;\r\n            }\r\n        });\r\n\r\n        const max = Math.max(types.Point, types.LineString, types.Polygon);\r\n        if (max === 0) return \"mixed\";\r\n        if (types.Point === max) return \"poi\";\r\n        if (types.LineString === max) return \"route\";\r\n        if (types.Polygon === max) return \"area\";\r\n        return \"mixed\";\r\n    };\r\n\r\n    /**\r\n     * Supprime une couche.\r\n     *\r\n     * @param {string} layerId - ID de la couche\r\n     */\r\n    LayerManager.removeLayer = function (layerId) {\r\n        const state = getState();\r\n        const Log = getLog();\r\n        const layerData = state.layers.get(layerId);\r\n\r\n        if (!layerData) {\r\n            Log.warn(\"[GeoLeaf.GeoJSON] removeLayer: couche introuvable :\", layerId);\r\n            return;\r\n        }\r\n\r\n        // Retirer de la carte\r\n        if (layerData.visible) {\r\n            LayerManager.hideLayer(layerId);\r\n        }\r\n\r\n        // D√©truire les objets Leaflet\r\n        if (layerData.clusterGroup) {\r\n            layerData.clusterGroup.clearLayers();\r\n        }\r\n        if (layerData.layer) {\r\n            layerData.layer.clearLayers();\r\n        }\r\n\r\n        // Retirer de la Map\r\n        state.layers.delete(layerId);\r\n        state.featureCache.delete(layerId);\r\n\r\n        Log.debug(\"[GeoLeaf.GeoJSON] Couche supprim√©e :\", layerId);\r\n    };\r\n\r\n    /**\r\n     * Met √† jour le zIndex d'une couche (ordre d'empilement sur la carte).\r\n     * Recr√©√©e la couche avec le nouveau pane si elle est visible.\r\n     *\r\n     * @param {string} layerId - ID de la couche\r\n     * @param {number} newZIndex - Nouveau zIndex (0-99)\r\n     * @returns {boolean} - true si la mise √† jour a r√©ussi\r\n     */\r\n    LayerManager.updateLayerZIndex = function (layerId, newZIndex) {\r\n        const state = getState();\r\n        const Log = getLog();\r\n        const layerData = state.layers.get(layerId);\r\n\r\n        if (!layerData) {\r\n            Log.warn(\"[GeoLeaf.GeoJSON] updateLayerZIndex: couche introuvable :\", layerId);\r\n            return false;\r\n        }\r\n\r\n        // Validation et clamping 0-99\r\n        const PaneHelpers = getShared().PaneHelpers;\r\n        newZIndex = PaneHelpers.validateZIndex(newZIndex);\r\n\r\n        const oldZIndex = layerData.config.zIndex || 0;\r\n        if (oldZIndex === newZIndex) {\r\n            Log.debug(\"[GeoLeaf.GeoJSON] updateLayerZIndex: zIndex identique, aucun changement :\", layerId);\r\n            return true;\r\n        }\r\n\r\n        Log.info(`[GeoLeaf.GeoJSON] Changement zIndex pour ${layerId}: ${oldZIndex} ‚Üí ${newZIndex}`);\r\n\r\n        // Mettre √† jour la config\r\n        layerData.config.zIndex = newZIndex;\r\n\r\n        // Si la couche n'est pas visible, juste mettre √† jour la config\r\n        const VisibilityManager = GeoLeaf._LayerVisibilityManager;\r\n        const visState = VisibilityManager ? VisibilityManager.getVisibilityState(layerId) : null;\r\n        const isVisible = visState ? visState.current : layerData.visible;\r\n\r\n        if (!isVisible) {\r\n            Log.debug(\"[GeoLeaf.GeoJSON] Couche non visible, zIndex mis √† jour dans config uniquement\");\r\n            return true;\r\n        }\r\n\r\n        // Couche visible : besoin de changer le pane\r\n        const newPaneName = PaneHelpers.getPaneName(newZIndex);\r\n        const newPane = state.map.getPane(newPaneName);\r\n\r\n        if (!newPane) {\r\n            Log.error(`[GeoLeaf.GeoJSON] Pane ${newPaneName} introuvable`);\r\n            return false;\r\n        }\r\n\r\n        try {\r\n            // Retirer temporairement de la carte\r\n            if (layerData.clusterGroup) {\r\n                state.map.removeLayer(layerData.clusterGroup);\r\n            } else {\r\n                state.map.removeLayer(layerData.layer);\r\n            }\r\n\r\n            // Changer le pane du layer Leaflet\r\n            if (layerData.layer && layerData.layer.options) {\r\n                layerData.layer.options.pane = newPaneName;\r\n\r\n                // Mettre √† jour chaque feature/layer individuelle\r\n                layerData.layer.eachLayer(function(subLayer) {\r\n                    if (subLayer.options) {\r\n                        subLayer.options.pane = newPaneName;\r\n                    }\r\n                    // Forcer le re-rendu en changeant le pane du path SVG\r\n                    if (subLayer._path && subLayer._path.parentNode) {\r\n                        const newPaneElement = state.map.getPane(newPaneName);\r\n                        if (newPaneElement) {\r\n                            newPaneElement.appendChild(subLayer._path);\r\n                        }\r\n                    }\r\n                });\r\n            }\r\n\r\n            // Changer le pane du clusterGroup si pr√©sent\r\n            if (layerData.clusterGroup && layerData.clusterGroup.options) {\r\n                layerData.clusterGroup.options.pane = newPaneName;\r\n            }\r\n\r\n            // Remettre sur la carte directement\r\n            if (layerData.clusterGroup) {\r\n                state.map.addLayer(layerData.clusterGroup);\r\n            } else {\r\n                state.map.addLayer(layerData.layer);\r\n            }\r\n\r\n            Log.debug(`[GeoLeaf.GeoJSON] Couche ${layerId} d√©plac√©e vers pane ${newPaneName}`);\r\n\r\n            // D√©clencher √©v√©nement de changement\r\n            if (state.map) {\r\n                state.map.fire(\"geoleaf:geojson:zindex-changed\", {\r\n                    layerId: layerId,\r\n                    oldZIndex: oldZIndex,\r\n                    newZIndex: newZIndex\r\n                });\r\n            }\r\n\r\n            return true;\r\n        } catch (error) {\r\n            Log.error(`[GeoLeaf.GeoJSON] Erreur lors du changement de zIndex pour ${layerId}:`, error);\r\n            return false;\r\n        }\r\n    };\r\n\r\n})(window);\r\n","/**\r\n * GeoLeaf GeoJSON Layer Manager - Visibility\r\n * Show/hide/toggle layers, zoom-based visibility\r\n *\r\n * @module geojson/layer-manager/visibility\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    const getState = () => GeoLeaf._GeoJSONShared.state;\r\n    const getLog = () => (GeoLeaf.Log || console);\r\n    const ScaleUtils = GeoLeaf.Utils && GeoLeaf.Utils.ScaleUtils;\r\n\r\n    const LayerManager = GeoLeaf._GeoJSONLayerManager = GeoLeaf._GeoJSONLayerManager || {};\r\n\r\n    /**\r\n     * Affiche une couche (rend visible).\r\n     *\r\n     * @param {string} layerId - ID de la couche\r\n     */\r\n    LayerManager.showLayer = function (layerId) {\r\n        const state = getState();\r\n        const Log = getLog();\r\n        const layerData = state.layers.get(layerId);\r\n\r\n        if (!layerData) {\r\n            Log.warn(\"[GeoLeaf.GeoJSON] showLayer: couche introuvable :\", layerId);\r\n            return;\r\n        }\r\n\r\n        // Utiliser le gestionnaire de visibilit√© centralis√©\r\n        const VisibilityManager = GeoLeaf._LayerVisibilityManager;\r\n        if (!VisibilityManager) {\r\n            Log.error(\"[GeoLeaf.GeoJSON] LayerVisibilityManager non disponible\");\r\n            return;\r\n        }\r\n\r\n        const changed = VisibilityManager.setVisibility(\r\n            layerId,\r\n            true,\r\n            VisibilityManager.VisibilitySource.USER\r\n        );\r\n\r\n        // IMPORTANT: Recalculer la visibilit√© physique en fonction du zoom\r\n        // setVisibility met √† jour logicalState (bouton), mais il faut aussi recalculer current\r\n        LayerManager.updateLayerVisibilityByZoom();\r\n\r\n        // Charger la l√©gende si disponible (uniquement si changement effectu√©)\r\n        if (changed) {\r\n            LayerManager._loadLayerLegend(layerId, layerData);\r\n\r\n            // G√©rer les labels au moment de l'activation\r\n            if (GeoLeaf.Labels && GeoLeaf.Labels.hasLabelConfig(layerId)) {\r\n                // V√©rifier si visibleByDefault est true pour les labels\r\n                const visibleByDefault = layerData.currentStyle?.label?.visibleByDefault === true;\r\n\r\n                if (visibleByDefault) {\r\n                    // Activer et afficher les labels imm√©diatement\r\n                    GeoLeaf.Labels.enableLabels(layerId, {}, true);\r\n                } else if (GeoLeaf.Labels.areLabelsEnabled(layerId)) {\r\n                    // Sinon, juste rafra√Æchir si d√©j√† activ√©s\r\n                    GeoLeaf.Labels.refreshLabels(layerId);\r\n                }\r\n            }\r\n            if (GeoLeaf._LabelButtonManager) {\r\n                GeoLeaf._LabelButtonManager.syncImmediate(layerId);\r\n            }\r\n\r\n            Log.debug(\"[GeoLeaf.GeoJSON] Couche affich√©e :\", layerId);\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Masque une couche (rend invisible).\r\n     *\r\n     * @param {string} layerId - ID de la couche\r\n     */\r\n    LayerManager.hideLayer = function (layerId) {\r\n        const state = getState();\r\n        const Log = getLog();\r\n        const layerData = state.layers.get(layerId);\r\n\r\n        if (!layerData) {\r\n            Log.warn(\"[GeoLeaf.GeoJSON] hideLayer: couche introuvable :\", layerId);\r\n            return;\r\n        }\r\n\r\n        // Utiliser le gestionnaire de visibilit√© centralis√©\r\n        const VisibilityManager = GeoLeaf._LayerVisibilityManager;\r\n        if (!VisibilityManager) {\r\n            Log.error(\"[GeoLeaf.GeoJSON] LayerVisibilityManager non disponible\");\r\n            return;\r\n        }\r\n\r\n        const changed = VisibilityManager.setVisibility(\r\n            layerId,\r\n            false,\r\n            VisibilityManager.VisibilitySource.USER\r\n        );\r\n\r\n        // IMPORTANT: Recalculer la visibilit√© physique (even on hide, to ensure consistency)\r\n        LayerManager.updateLayerVisibilityByZoom();\r\n\r\n        if (changed) {\r\n            // Masquer les labels et mettre √† jour le bouton\r\n            if (GeoLeaf.Labels) {\r\n                GeoLeaf.Labels.disableLabels(layerId);\r\n            }\r\n            if (GeoLeaf._LabelButtonManager) {\r\n                GeoLeaf._LabelButtonManager.syncImmediate(layerId);\r\n            }\r\n\r\n            Log.debug(\"[GeoLeaf.GeoJSON] Couche masqu√©e :\", layerId);\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Toggle la visibilit√© d'une couche.\r\n     *\r\n     * @param {string} layerId - ID de la couche\r\n     */\r\n    LayerManager.toggleLayer = function (layerId) {\r\n        const state = getState();\r\n        const Log = getLog();\r\n        const layerData = state.layers.get(layerId);\r\n\r\n        if (!layerData) {\r\n            Log.warn(\"[GeoLeaf.GeoJSON] toggleLayer: couche introuvable :\", layerId);\r\n            return;\r\n        }\r\n\r\n        // Obtenir l'√©tat actuel via le gestionnaire de visibilit√©\r\n        const VisibilityManager = GeoLeaf._LayerVisibilityManager;\r\n        if (!VisibilityManager) {\r\n            Log.error(\"[GeoLeaf.GeoJSON] LayerVisibilityManager non disponible\");\r\n            return;\r\n        }\r\n\r\n        const visState = VisibilityManager.getVisibilityState(layerId);\r\n        const currentlyVisible = visState ? visState.current : layerData.visible;\r\n\r\n        // Toggle\r\n        if (currentlyVisible) {\r\n            LayerManager.hideLayer(layerId);\r\n        } else {\r\n            LayerManager.showLayer(layerId);\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Affiche une couche (interne, sans v√©rifier visible).\r\n     * @deprecated Utiliser GeoLeaf._LayerVisibilityManager.setVisibility() √† la place\r\n     * @private\r\n     */\r\n    LayerManager._showLayerInternal = function (layerId, layerData) {\r\n        const Log = getLog();\r\n        Log.warn(\"[GeoLeaf.GeoJSON] _showLayerInternal() est d√©pr√©ci√©, utiliser LayerVisibilityManager\");\r\n\r\n        // Rediriger vers le gestionnaire centralis√©\r\n        const VisibilityManager = GeoLeaf._LayerVisibilityManager;\r\n        if (VisibilityManager) {\r\n            VisibilityManager.setVisibility(\r\n                layerId,\r\n                true,\r\n                VisibilityManager.VisibilitySource.SYSTEM\r\n            );\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Masque une couche (interne, sans v√©rifier visible).\r\n     * @deprecated Utiliser GeoLeaf._LayerVisibilityManager.setVisibility() √† la place\r\n     * @private\r\n     */\r\n    LayerManager._hideLayerInternal = function (layerId, layerData) {\r\n        const Log = getLog();\r\n        Log.warn(\"[GeoLeaf.GeoJSON] _hideLayerInternal() est d√©pr√©ci√©, utiliser LayerVisibilityManager\");\r\n\r\n        // Rediriger vers le gestionnaire centralis√©\r\n        const VisibilityManager = GeoLeaf._LayerVisibilityManager;\r\n        if (VisibilityManager) {\r\n            VisibilityManager.setVisibility(\r\n                layerId,\r\n                false,\r\n                VisibilityManager.VisibilitySource.SYSTEM\r\n            );\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Met √† jour la visibilit√© des couches en fonction de layerScale du style actif.\r\n     * Respecte les pr√©f√©rences utilisateur (d√©sactivation manuelle ou par th√®me).\r\n     * Utilise le gestionnaire de visibilit√© centralis√© avec source 'zoom'.\r\n     * Ex√©cution imm√©diate pour r√©activit√© pendant le zoom (le debounce LayerManager.refresh √©vite les saccades d'UI).\r\n     */\r\n    LayerManager.updateLayerVisibilityByZoom = function () {\r\n        const state = getState();\r\n        const Log = getLog();\r\n        if (!state.map) return;\r\n\r\n        const VisibilityManager = GeoLeaf._LayerVisibilityManager;\r\n        if (!VisibilityManager) {\r\n            Log.error(\"[GeoLeaf.GeoJSON] LayerVisibilityManager non disponible\");\r\n            return;\r\n        }\r\n\r\n        const currentScale = (ScaleUtils && typeof ScaleUtils.calculateMapScale === \"function\")\r\n            ? ScaleUtils.calculateMapScale(state.map, { logger: Log })\r\n            : 0;\r\n\r\n        const normalizeScaleValue = (value) => {\r\n            if (typeof value !== \"number\") return null;\r\n            return value <= 0 ? null : value;\r\n        };\r\n\r\n        state.layers.forEach((layerData, layerId) => {\r\n            const config = layerData.config;\r\n            if (!config) return;\r\n\r\n            const hasCurrentStyle = !!layerData.currentStyle;\r\n            const styleScale = hasCurrentStyle ? layerData.currentStyle.layerScale : null;\r\n            if (!styleScale && hasCurrentStyle) {\r\n                if (Log && typeof Log.warn === \"function\") {\r\n                    Log.warn(`[GeoLeaf.GeoJSON] layerScale manquant pour ${layerId}, couche laiss√©e visible par d√©faut`);\r\n                }\r\n            }\r\n\r\n            const minScale = normalizeScaleValue(styleScale && styleScale.minScale);\r\n            const maxScale = normalizeScaleValue(styleScale && styleScale.maxScale);\r\n\r\n            const shouldBeVisibleByScale = (ScaleUtils && typeof ScaleUtils.isScaleInRange === \"function\")\r\n                ? ScaleUtils.isScaleInRange(currentScale, minScale, maxScale, Log)\r\n                : true;\r\n\r\n            // Base visibility: user override > theme intent > config default\r\n            const meta = layerData._visibility;\r\n            let baseVisible;\r\n            if (meta && meta.userOverride) {\r\n                // IMPORTANT: Pour userOverride, utiliser logicalState (√©tat bouton), pas current (√©tat zoom)\r\n                baseVisible = meta.logicalState;\r\n            } else if (meta && meta.themeOverride) {\r\n                baseVisible = meta.themeDesired;\r\n            } else {\r\n                // visibility.active parameter is deprecated - now managed by layerScale in style files\r\n                baseVisible = true;\r\n            }\r\n\r\n            // R√àGLE CRITIQUE :\r\n            // - L'AFFICHAGE sur la carte RESPECTE TOUJOURS les seuils de zoom\r\n            // - Le BOUTON (via logicalState) reste ind√©pendant du zoom\r\n            // - Utilisateur voit : bouton ON, mais couche cach√©e si hors zoom\r\n            const shouldBeVisible = baseVisible && shouldBeVisibleByScale;\r\n\r\n            VisibilityManager.setVisibility(\r\n                layerId,\r\n                shouldBeVisible,\r\n                VisibilityManager.VisibilitySource.ZOOM\r\n            );\r\n        });\r\n    };\r\n\r\n    /**\r\n     * √âmet un √©v√©nement de changement de visibilit√©.\r\n     *\r\n     * @param {string} layerId\r\n     * @param {boolean} visible\r\n     * @private\r\n     */\r\n    LayerManager._fireLayerVisibilityEvent = function (layerId, visible) {\r\n        const state = getState();\r\n        if (!state.map) return;\r\n\r\n        try {\r\n            state.map.fire(\"geoleaf:geojson:visibility-changed\", {\r\n                layerId: layerId,\r\n                visible: visible\r\n            });\r\n        } catch (e) {\r\n            // Silencieux\r\n        }\r\n    };\r\n\r\n})(window);\r\n","/**\r\n * GeoLeaf GeoJSON Layer Manager - Style\r\n * Style normalization, hatch patterns, style application\r\n *\r\n * @module geojson/layer-manager/style\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    const getState = () => GeoLeaf._GeoJSONShared.state;\r\n    const getLog = () => (GeoLeaf.Log || console);\r\n\r\n    const LayerManager = GeoLeaf._GeoJSONLayerManager = GeoLeaf._GeoJSONLayerManager || {};\r\n\r\n    /**\r\n     * Cr√©e un pattern SVG pour le hachurage\r\n     * @private\r\n     * @param {string} layerId - ID de la couche (pour l'unicit√© du pattern)\r\n     * @param {Object} hatchConfig - Configuration du hachurage\r\n     * @returns {string} - ID du pattern SVG\r\n     */\r\n    function _createHatchPattern(layerId, hatchConfig) {\r\n        if (!hatchConfig || !hatchConfig.enabled) {\r\n            return null;\r\n        }\r\n\r\n        // Cr√©er un ID unique bas√© sur les param√®tres du hatch\r\n        const type = hatchConfig.type || 'diagonal';\r\n        const angle = hatchConfig.angleDeg || 0;\r\n        const spacing = hatchConfig.spacingPx || 10;\r\n        const strokeColor = (hatchConfig.stroke?.color || '#000000').replace('#', '');\r\n        const strokeWidth = hatchConfig.stroke?.widthPx || 1;\r\n        const strokeOpacity = hatchConfig.stroke?.opacity || 1;\r\n\r\n        // Hash des param√®tres pour cr√©er un ID unique\r\n        const configHash = `${type}-${angle}-${spacing}-${strokeColor}-${strokeWidth}-${strokeOpacity}`;\r\n        const patternId = `hatch-${layerId}-${configHash}`;\r\n\r\n        // Si le pattern existe d√©j√†, le r√©utiliser\r\n        const existingPattern = document.getElementById(patternId);\r\n        if (existingPattern) {\r\n            return patternId;\r\n        }\r\n\r\n        // Cr√©er le pattern SVG\r\n        const pattern = document.createElementNS('http://www.w3.org/2000/svg', 'pattern');\r\n        pattern.setAttribute('id', patternId);\r\n        pattern.setAttribute('patternUnits', 'userSpaceOnUse');\r\n        pattern.setAttribute('width', spacing);\r\n        pattern.setAttribute('height', spacing);\r\n\r\n        // Cr√©er les lignes selon le type\r\n        if (type === 'dot') {\r\n            // Pattern de points (stipple)\r\n            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');\r\n            circle.setAttribute('cx', spacing / 2);\r\n            circle.setAttribute('cy', spacing / 2);\r\n            circle.setAttribute('r', Math.max(0.5, strokeWidth / 2));\r\n            circle.setAttribute('fill', `#${strokeColor}`);\r\n            circle.setAttribute('fill-opacity', strokeOpacity);\r\n            pattern.appendChild(circle);\r\n        } else if (type === 'cross') {\r\n            // Croix (horizontal + vertical)\r\n            const lineH = document.createElementNS('http://www.w3.org/2000/svg', 'line');\r\n            lineH.setAttribute('x1', '0');\r\n            lineH.setAttribute('y1', spacing / 2);\r\n            lineH.setAttribute('x2', spacing);\r\n            lineH.setAttribute('y2', spacing / 2);\r\n            lineH.setAttribute('stroke', `#${strokeColor}`);\r\n            lineH.setAttribute('stroke-width', strokeWidth);\r\n            lineH.setAttribute('stroke-opacity', strokeOpacity);\r\n            pattern.appendChild(lineH);\r\n\r\n            const lineV = document.createElementNS('http://www.w3.org/2000/svg', 'line');\r\n            lineV.setAttribute('x1', spacing / 2);\r\n            lineV.setAttribute('y1', '0');\r\n            lineV.setAttribute('x2', spacing / 2);\r\n            lineV.setAttribute('y2', spacing);\r\n            lineV.setAttribute('stroke', `#${strokeColor}`);\r\n            lineV.setAttribute('stroke-width', strokeWidth);\r\n            lineV.setAttribute('stroke-opacity', strokeOpacity);\r\n            pattern.appendChild(lineV);\r\n        } else if (type === 'x') {\r\n            // Croix diagonale (45¬∞ + 135¬∞)\r\n            const line1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');\r\n            line1.setAttribute('x1', '0');\r\n            line1.setAttribute('y1', '0');\r\n            line1.setAttribute('x2', spacing);\r\n            line1.setAttribute('y2', spacing);\r\n            line1.setAttribute('stroke', `#${strokeColor}`);\r\n            line1.setAttribute('stroke-width', strokeWidth);\r\n            line1.setAttribute('stroke-opacity', strokeOpacity);\r\n            pattern.appendChild(line1);\r\n\r\n            const line2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');\r\n            line2.setAttribute('x1', spacing);\r\n            line2.setAttribute('y1', '0');\r\n            line2.setAttribute('x2', '0');\r\n            line2.setAttribute('y2', spacing);\r\n            line2.setAttribute('stroke', `#${strokeColor}`);\r\n            line2.setAttribute('stroke-width', strokeWidth);\r\n            line2.setAttribute('stroke-opacity', strokeOpacity);\r\n            pattern.appendChild(line2);\r\n        } else {\r\n            // Simple ligne (diagonal, horizontal, vertical)\r\n            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');\r\n\r\n            if (type === 'horizontal' || angle === 0) {\r\n                line.setAttribute('x1', '0');\r\n                line.setAttribute('y1', spacing / 2);\r\n                line.setAttribute('x2', spacing);\r\n                line.setAttribute('y2', spacing / 2);\r\n            } else if (type === 'vertical' || angle === 90) {\r\n                line.setAttribute('x1', spacing / 2);\r\n                line.setAttribute('y1', '0');\r\n                line.setAttribute('x2', spacing / 2);\r\n                line.setAttribute('y2', spacing);\r\n            } else {\r\n                // Diagonal avec angle - cr√©er une vraie diagonale\r\n                line.setAttribute('x1', '0');\r\n                line.setAttribute('y1', '0');\r\n                line.setAttribute('x2', spacing);\r\n                line.setAttribute('y2', spacing);\r\n                // Appliquer la rotation depuis le centre du pattern\r\n                if (angle != null && angle !== 45) {\r\n                    const centerX = spacing / 2;\r\n                    const centerY = spacing / 2;\r\n                    pattern.setAttribute('patternTransform', `rotate(${angle} ${centerX} ${centerY})`);\r\n                }\r\n            }\r\n\r\n            line.setAttribute('stroke', `#${strokeColor}`);\r\n            line.setAttribute('stroke-width', strokeWidth);\r\n            line.setAttribute('stroke-opacity', strokeOpacity);\r\n            pattern.appendChild(line);\r\n        }\r\n\r\n        // Retourner juste l'ID du pattern\r\n        // Les patterns seront cr√©√©s dans _applyHatchToLayer quand le SVG Leaflet existe\r\n        return patternId;\r\n    }\r\n\r\n    /**\r\n     * Applique le hachurage SVG √† un layer Leaflet\r\n     * @private\r\n     * @param {L.Layer} layer - Layer Leaflet\r\n     * @param {string} patternId - ID du pattern SVG\r\n     */\r\n    function _applyHatchToLayer(layer, patternId, hatchConfig) {\r\n        if (!layer || !patternId) return;\r\n\r\n        // Log supprim√© pour √©viter des milliers de logs dans les boucles eachLayer\r\n        // ...log supprim√© pour √©viter du bruit inutile...\r\n\r\n        // S'assurer que le pattern existe dans le SVG de Leaflet\r\n        let mapSvg = document.querySelector('.leaflet-overlay-pane svg');\r\n        if (!mapSvg) {\r\n            // Retry avec d√©lai si SVG n'existe pas encore\r\n            const retryCount = 5;\r\n            const retryDelay = 100; // ms\r\n            let attempts = 0;\r\n            const tryApplyHatch = () => {\r\n                mapSvg = document.querySelector('.leaflet-overlay-pane svg');\r\n                if (mapSvg) {\r\n                    _applyHatchToLayer(layer, patternId, hatchConfig);\r\n                    return;\r\n                }\r\n                attempts++;\r\n                if (attempts < retryCount) {\r\n                    setTimeout(tryApplyHatch, retryDelay);\r\n                }\r\n            };\r\n            setTimeout(tryApplyHatch, retryDelay);\r\n            return;\r\n        }\r\n\r\n        // V√©rifier si le pattern existe d√©j√†\r\n        let pattern = mapSvg.querySelector(`#${patternId}`);\r\n        if (!pattern && hatchConfig) {\r\n            // Cr√©er le pattern maintenant\r\n            const spacing = hatchConfig.spacingPx || 10;\r\n            const type = hatchConfig.type || 'diagonal';\r\n            const angle = hatchConfig.angleDeg;\r\n            const strokeColor = hatchConfig.stroke?.color || '#000000';\r\n            const strokeWidth = hatchConfig.stroke?.widthPx || 1;\r\n            const strokeOpacity = hatchConfig.stroke?.opacity || 1;\r\n\r\n            // Assurer que la couleur a toujours le # pour les attributs SVG\r\n            const colorWithHash = strokeColor.startsWith('#') ? strokeColor : `#${strokeColor}`;\r\n\r\n            pattern = document.createElementNS('http://www.w3.org/2000/svg', 'pattern');\r\n            pattern.setAttribute('id', patternId);\r\n            pattern.setAttribute('patternUnits', 'userSpaceOnUse');\r\n            pattern.setAttribute('width', spacing);\r\n            pattern.setAttribute('height', spacing);\r\n\r\n            // Cr√©er le contenu selon le type\r\n            if (type === 'dot') {\r\n                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');\r\n                circle.setAttribute('cx', spacing / 2);\r\n                circle.setAttribute('cy', spacing / 2);\r\n                // Rayon proportionnel au spacing:\r\n                // Plus petit spacing (plus dense) = points plus petits\r\n                // Plus grand spacing (moins dense) = points plus gros pour compenser\r\n                // spacing 6px ‚Üí r=0.42, spacing 12px ‚Üí r=0.84\r\n                circle.setAttribute('r', Math.max(0.3, spacing * 0.07));\r\n                circle.setAttribute('fill', colorWithHash);\r\n                circle.setAttribute('fill-opacity', strokeOpacity);\r\n                pattern.appendChild(circle);\r\n            } else if (type === 'diagonal') {\r\n                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');\r\n                line.setAttribute('x1', '0');\r\n                line.setAttribute('y1', '0');\r\n                line.setAttribute('x2', spacing);\r\n                line.setAttribute('y2', spacing);\r\n                line.setAttribute('stroke', colorWithHash);\r\n                line.setAttribute('stroke-width', strokeWidth);\r\n                line.setAttribute('stroke-opacity', strokeOpacity);\r\n                if (angle != null && angle !== 45) {\r\n                    const centerX = spacing / 2;\r\n                    const centerY = spacing / 2;\r\n                    pattern.setAttribute('patternTransform', `rotate(${angle} ${centerX} ${centerY})`);\r\n                }\r\n                pattern.appendChild(line);\r\n            } else if (type === 'cross') {\r\n                // Ligne horizontale\r\n                const hLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');\r\n                hLine.setAttribute('x1', '0');\r\n                hLine.setAttribute('y1', spacing / 2);\r\n                hLine.setAttribute('x2', spacing);\r\n                hLine.setAttribute('y2', spacing / 2);\r\n                hLine.setAttribute('stroke', colorWithHash);\r\n                hLine.setAttribute('stroke-width', strokeWidth);\r\n                hLine.setAttribute('stroke-opacity', strokeOpacity);\r\n                pattern.appendChild(hLine);\r\n                // Ligne verticale\r\n                const vLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');\r\n                vLine.setAttribute('x1', spacing / 2);\r\n                vLine.setAttribute('y1', '0');\r\n                vLine.setAttribute('x2', spacing / 2);\r\n                vLine.setAttribute('y2', spacing);\r\n                vLine.setAttribute('stroke', colorWithHash);\r\n                vLine.setAttribute('stroke-width', strokeWidth);\r\n                vLine.setAttribute('stroke-opacity', strokeOpacity);\r\n                pattern.appendChild(vLine);\r\n            } else if (type === 'x') {\r\n                // Diagonale principal (TL to BR)\r\n                const line1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');\r\n                line1.setAttribute('x1', '0');\r\n                line1.setAttribute('y1', '0');\r\n                line1.setAttribute('x2', spacing);\r\n                line1.setAttribute('y2', spacing);\r\n                line1.setAttribute('stroke', colorWithHash);\r\n                line1.setAttribute('stroke-width', strokeWidth);\r\n                line1.setAttribute('stroke-opacity', strokeOpacity);\r\n                pattern.appendChild(line1);\r\n                // Diagonale secondaire (TR to BL)\r\n                const line2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');\r\n                line2.setAttribute('x1', spacing);\r\n                line2.setAttribute('y1', '0');\r\n                line2.setAttribute('x2', '0');\r\n                line2.setAttribute('y2', spacing);\r\n                line2.setAttribute('stroke', colorWithHash);\r\n                line2.setAttribute('stroke-width', strokeWidth);\r\n                line2.setAttribute('stroke-opacity', strokeOpacity);\r\n                pattern.appendChild(line2);\r\n            } else if (type === 'horizontal') {\r\n                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');\r\n                line.setAttribute('x1', '0');\r\n                line.setAttribute('y1', spacing / 2);\r\n                line.setAttribute('x2', spacing);\r\n                line.setAttribute('y2', spacing / 2);\r\n                line.setAttribute('stroke', colorWithHash);\r\n                line.setAttribute('stroke-width', strokeWidth);\r\n                line.setAttribute('stroke-opacity', strokeOpacity);\r\n                pattern.appendChild(line);\r\n            } else if (type === 'vertical') {\r\n                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');\r\n                line.setAttribute('x1', spacing / 2);\r\n                line.setAttribute('y1', '0');\r\n                line.setAttribute('x2', spacing / 2);\r\n                line.setAttribute('y2', spacing);\r\n                line.setAttribute('stroke', colorWithHash);\r\n                line.setAttribute('stroke-width', strokeWidth);\r\n                line.setAttribute('stroke-opacity', strokeOpacity);\r\n                pattern.appendChild(line);\r\n            }\r\n\r\n            // Ajouter au defs du SVG\r\n            let defs = mapSvg.querySelector('defs');\r\n            if (!defs) {\r\n                defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');\r\n                mapSvg.insertBefore(defs, mapSvg.firstChild);\r\n            }\r\n            defs.appendChild(pattern);\r\n        }\r\n\r\n        // Fonction pour appliquer le pattern √† un √©l√©ment path\r\n        const applyToPath = (path) => {\r\n            if (path && path.setAttribute) {\r\n                const fillUrl = `url(#${patternId})`;\r\n                const currentFill = path.getAttribute('fill');\r\n\r\n                // N'appliquer que si diff√©rent (√©vite boucle infinie)\r\n                if (currentFill !== fillUrl) {\r\n                    path.setAttribute('fill', fillUrl);\r\n                }\r\n\r\n                // S'assurer que l'opacit√© de remplissage est visible pour les patterns\r\n                if (hatchConfig && hatchConfig.renderMode === 'pattern_only') {\r\n                    const curFillOpacity = path.getAttribute('fill-opacity');\r\n                    if (curFillOpacity == null || Number(curFillOpacity) <= 0) {\r\n                        path.setAttribute('fill-opacity', '1');\r\n                    }\r\n                }\r\n\r\n                // Observer les changements pour r√©appliquer le pattern\r\n                if (!path._hatchObserver) {\r\n                    const observer = new MutationObserver((mutations) => {\r\n                        mutations.forEach((mutation) => {\r\n                            if (mutation.type === 'attributes' && mutation.attributeName === 'fill') {\r\n                                const newFill = path.getAttribute('fill');\r\n                                // Ne r√©appliquer que si vraiment diff√©rent\r\n                                if (newFill !== fillUrl && !newFill.includes(patternId)) {\r\n                                    path.setAttribute('fill', fillUrl);\r\n                                }\r\n                            }\r\n                        });\r\n                    });\r\n                    observer.observe(path, { attributes: true, attributeFilter: ['fill'] });\r\n                    path._hatchObserver = observer;\r\n                }\r\n            }\r\n        };\r\n\r\n        // Pour les layers individuels\r\n        if (layer._path) {\r\n            applyToPath(layer._path);\r\n        }\r\n\r\n        // Pour les groupes de layers\r\n        if (typeof layer.eachLayer === 'function') {\r\n            layer.eachLayer(sublayer => {\r\n                if (sublayer._path) {\r\n                    applyToPath(sublayer._path);\r\n                }\r\n            });\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Normalise le format de style vers le format Leaflet\r\n     * @private\r\n     * @param {Object} style - Style source (format imbriqu√© ou plat)\r\n     * @param {string} layerId - ID de la couche (pour les patterns SVG)\r\n     * @returns {Object} - Style normalis√© au format Leaflet\r\n     */\r\n    function _normalizeStyleToLeaflet(style, layerId) {\r\n        if (!style || typeof style !== 'object') {\r\n            return {};\r\n        }\r\n\r\n        const normalized = {};\r\n\r\n        // Nouveau format imbriqu√© avec fill/stroke\r\n        if (style.fill || style.stroke) {\r\n            // Fill (remplissage)\r\n            if (style.fill) {\r\n                if (style.fill.color) normalized.fillColor = style.fill.color;\r\n                if (typeof style.fill.opacity === 'number') normalized.fillOpacity = style.fill.opacity;\r\n                if (style.fill.pattern) normalized.fillPattern = style.fill.pattern;\r\n            }\r\n\r\n            // Si hatch avec renderMode=\"pattern_only\", forcer un fillColor et une fillOpacity visible\r\n            // (Leaflet a besoin d'un fillColor pour appliquer un pattern et l'opacit√© doit √™tre > 0)\r\n            if (style.hatch && style.hatch.enabled && style.hatch.renderMode === 'pattern_only') {\r\n                if (!normalized.fillColor) normalized.fillColor = '#ffffff';\r\n                // Override toute valeur de fill.opacity fournie par le style (souvent 0.0) pour rendre le pattern visible\r\n                normalized.fillOpacity = 1.0;\r\n            }\r\n\r\n            // Stroke (contour)\r\n            if (style.stroke) {\r\n                if (style.stroke.color) normalized.color = style.stroke.color;\r\n                if (typeof style.stroke.opacity === 'number') normalized.opacity = style.stroke.opacity;\r\n                if (typeof style.stroke.widthPx === 'number') normalized.weight = style.stroke.widthPx;\r\n                if (style.stroke.dashArray) normalized.dashArray = style.stroke.dashArray;\r\n                if (style.stroke.lineCap) normalized.lineCap = style.stroke.lineCap;\r\n                if (style.stroke.lineJoin) normalized.lineJoin = style.stroke.lineJoin;\r\n            }\r\n\r\n            // Casing (bordure/contour pour polylines)\r\n            if (style.casing && style.casing.enabled) {\r\n                normalized._casing = {\r\n                    enabled: true,\r\n                    color: style.casing.color || '#000000',\r\n                    opacity: typeof style.casing.opacity === 'number' ? style.casing.opacity : 1.0,\r\n                    weight: typeof style.casing.widthPx === 'number' ? style.casing.widthPx : 1.0,\r\n                    dashArray: style.casing.dashArray || null,\r\n                    lineCap: style.casing.lineCap || null,\r\n                    lineJoin: style.casing.lineJoin || null\r\n                };\r\n            }\r\n\r\n            // Propri√©t√©s communes\r\n            if (style.shape) normalized.shape = style.shape;\r\n            if (typeof style.sizePx === 'number') {\r\n                normalized.radius = style.sizePx;\r\n                normalized.sizePx = style.sizePx;\r\n            }\r\n\r\n            // Hatch (hachurage) - copie de la structure compl√®te\r\n            if (style.hatch) {\r\n                normalized.hatch = { ...style.hatch };\r\n                // Normaliser le stroke du hatch si pr√©sent\r\n                if (style.hatch.stroke) {\r\n                    const hatchStroke = {};\r\n                    if (style.hatch.stroke.color) hatchStroke.color = style.hatch.stroke.color;\r\n                    if (typeof style.hatch.stroke.opacity === 'number') hatchStroke.opacity = style.hatch.stroke.opacity;\r\n                    if (typeof style.hatch.stroke.widthPx === 'number') hatchStroke.widthPx = style.hatch.stroke.widthPx;\r\n                    normalized.hatch.stroke = hatchStroke;\r\n                }\r\n\r\n                // Cr√©er le pattern SVG et l'appliquer comme fillPattern\r\n                if (style.hatch.enabled && layerId) {\r\n                    const patternId = _createHatchPattern(layerId, style.hatch);\r\n                    if (patternId) {\r\n                        // Stocker l'ID du pattern pour application ult√©rieure\r\n                        normalized._hatchPatternId = patternId;\r\n\r\n                        // Si renderMode = \"pattern_only\", on utilise le pattern comme fill\r\n                        // IMPORTANT: on NE d√©finit PAS fillOpacity=0 car cela rendrait le pattern invisible!\r\n                        // Le pattern SVG s'affichera avec son propre rendu via l'attribut fill=\"url(#pattern-id)\"\r\n                        if (style.hatch.renderMode === 'pattern_only') {\r\n                            // Rendre le pattern visible: fillOpacity doit √™tre > 0 et un fillColor doit exister\r\n                            normalized.fillColor = normalized.fillColor || '#ffffff';\r\n                            normalized.fillOpacity = 1.0;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        // Ancien format plat (r√©trocompatibilit√©)\r\n        else {\r\n            // Copier toutes les propri√©t√©s directement\r\n            Object.assign(normalized, style);\r\n        }\r\n\r\n        return normalized;\r\n    }\r\n\r\n    /**\r\n     * Applique un nouveau style √† une couche existante.\r\n     * Utilis√© par le module Themes pour changer dynamiquement l'apparence.\r\n     *\r\n     * @param {string} layerId - ID de la couche\r\n     * @param {Object} styleConfig - Configuration du style { style, styleRules }\r\n     * @returns {boolean} - true si le style a √©t√© appliqu√© avec succ√®s\r\n     */\r\n    LayerManager.setLayerStyle = function (layerId, styleConfig) {\r\n        const state = getState();\r\n        const Log = getLog();\r\n        const layerData = state.layers.get(layerId);\r\n\r\n        if (!layerData) {\r\n            Log.warn(\"[GeoLeaf.GeoJSON] setLayerStyle: couche introuvable :\", layerId);\r\n            return false;\r\n        }\r\n\r\n        const leafletLayer = layerData.layer;\r\n        if (!leafletLayer || typeof leafletLayer.setStyle !== 'function') {\r\n            Log.warn(\"[GeoLeaf.GeoJSON] setLayerStyle: couche sans m√©thode setStyle :\", layerId);\r\n            return false;\r\n        }\r\n\r\n        // Pr√©parer le style par d√©faut (ne pas utiliser defaultStyle qui peut contenir les anciennes valeurs)\r\n        const baseStyle = {\r\n            color: '#3388ff',\r\n            weight: 3,\r\n            opacity: 0.65,\r\n            fillColor: '#3388ff',\r\n            fillOpacity: 0.2\r\n        };\r\n\r\n        // Normaliser le style (defaultStyle ou style) vers format Leaflet\r\n        const rawStyle = styleConfig.defaultStyle || styleConfig.style || {};\r\n        const normalizedStyle = _normalizeStyleToLeaflet(rawStyle, layerId);\r\n        const defaultStyle = Object.assign({}, baseStyle, normalizedStyle);\r\n\r\n        // Pr√©parer les styleRules\r\n        const styleRules = Array.isArray(styleConfig.styleRules) ? styleConfig.styleRules : [];\r\n\r\n        // Fonction de style dynamique\r\n        const styleFn = (feature) => {\r\n            // 1. Commencer avec le style par d√©faut\r\n            let finalStyle = Object.assign({}, defaultStyle);\r\n\r\n            // 2. Appliquer les styleRules (premi√®re r√®gle correspondante gagne)\r\n            if (styleRules.length > 0 && GeoLeaf._GeoJSONStyleResolver) {\r\n                const matchedStyle = GeoLeaf._GeoJSONStyleResolver.evaluateStyleRules(feature, styleRules);\r\n                if (matchedStyle) {\r\n                    // Normaliser le style de la r√®gle vers format Leaflet\r\n                    const normalizedRuleStyle = _normalizeStyleToLeaflet(matchedStyle, layerId);\r\n                    finalStyle = Object.assign({}, finalStyle, normalizedRuleStyle);\r\n                }\r\n            }\r\n\r\n            // 3. NE PAS appliquer properties.style ou properties.color pour permettre aux r√®gles de s'appliquer\r\n            // Comment√© car cela √©crase les r√®gles de style\r\n            // const featureStyle = feature && feature.properties && feature.properties.style\r\n            //     ? feature.properties.style\r\n            //     : null;\r\n            // if (featureStyle) {\r\n            //     finalStyle = Object.assign({}, finalStyle, featureStyle);\r\n            // }\r\n\r\n            return finalStyle;\r\n        };\r\n\r\n        // Appliquer le style √† toutes les features de la couche\r\n        try {\r\n            let styled = 0;\r\n            let skipped = 0;\r\n            let markersRecreated = 0;\r\n            const layersToRecreate = [];\r\n\r\n            // Premi√®re passe : identifier et styler ou marquer pour recr√©ation\r\n            leafletLayer.eachLayer(function(layer) {\r\n                if (!layer.feature) {\r\n                    skipped++;\r\n                    return;\r\n                }\r\n\r\n                const style = styleFn(layer.feature);\r\n\r\n                // Cas 1: Layers avec setStyle (Path, CircleMarker, Polyline, etc.)\r\n                if (layer.setStyle && typeof layer.setStyle === 'function') {\r\n                    layer.setStyle(style);\r\n                    styled++;\r\n\r\n                    // G√©rer le casing (bordure pour polylines)\r\n                    if (style._casing && style._casing.enabled && layer instanceof global.L.Polyline && !(layer instanceof global.L.Polygon)) {\r\n                        const casingConfig = style._casing;\r\n\r\n                        // Cr√©er ou mettre √† jour la polyline de casing (dessous, plus large)\r\n                        if (!layer._casingLayer) {\r\n                            // Cr√©er une nouvelle couche de casing\r\n                            const casingStyle = {\r\n                                color: casingConfig.color,\r\n                                opacity: casingConfig.opacity,\r\n                                weight: casingConfig.weight,\r\n                                dashArray: casingConfig.dashArray,\r\n                                lineCap: casingConfig.lineCap || 'butt',\r\n                                lineJoin: casingConfig.lineJoin || 'miter',\r\n                                fill: false\r\n                            };\r\n\r\n                            layer._casingLayer = global.L.polyline(layer.getLatLngs(), casingStyle);\r\n                            // Ajouter la couche de casing au m√™me parent (group ou map)\r\n                            if (leafletLayer && leafletLayer.addLayer) {\r\n                                leafletLayer.addLayer(layer._casingLayer);\r\n                            } else if (layer._map) {\r\n                                layer._map.addLayer(layer._casingLayer);\r\n                            }\r\n                            // Mettre la couche de casing derri√®re la couche principale\r\n                            if (layer._casingLayer.setZIndex) {\r\n                                layer._casingLayer.setZIndex((layer.options.zIndex || 0) - 1);\r\n                            }\r\n                        } else {\r\n                            // Mettre √† jour le style existant\r\n                            layer._casingLayer.setStyle({\r\n                                color: casingConfig.color,\r\n                                opacity: casingConfig.opacity,\r\n                                weight: casingConfig.weight,\r\n                                dashArray: casingConfig.dashArray,\r\n                                lineCap: casingConfig.lineCap || 'butt',\r\n                                lineJoin: casingConfig.lineJoin || 'miter'\r\n                            });\r\n                        }\r\n                    } else if (!style._casing || !style._casing.enabled) {\r\n                        // Supprimer la couche de casing si elle existe mais n'est plus n√©cessaire\r\n                        if (layer._casingLayer && leafletLayer && leafletLayer.removeLayer) {\r\n                            leafletLayer.removeLayer(layer._casingLayer);\r\n                            layer._casingLayer = null;\r\n                        }\r\n                    }\r\n\r\n                    // Appliquer le hachurage si pr√©sent dans ce style\r\n                    if (style._hatchPatternId && style.hatch) {\r\n                        const patternId = style._hatchPatternId;\r\n                        const hatchConfig = style.hatch;\r\n                        // Log supprim√© pour √©viter des milliers de logs (appel√© pour chaque feature)\r\n                        // ...log supprim√© pour √©viter du bruit inutile...\r\n\r\n                        // Appliquer imm√©diatement si le path existe\r\n                        if (layer._path) {\r\n                            setTimeout(() => {\r\n                                _applyHatchToLayer(layer, patternId, hatchConfig);\r\n                            }, 0);\r\n                        }\r\n\r\n                        // Ajouter aussi un listener pour quand le layer est ajout√©/re-ajout√©\r\n                        if (!layer._hatchPatternId || layer._hatchPatternId !== patternId) {\r\n                            layer._hatchPatternId = patternId;\r\n\r\n                            // Supprimer l'ancien listener s'il existe\r\n                            if (layer._hatchListener) {\r\n                                layer.off('add', layer._hatchListener);\r\n                            }\r\n\r\n                            // Cr√©er le nouveau listener\r\n                            layer._hatchListener = function() {\r\n                                if (this._path) {\r\n                                    _applyHatchToLayer(this, patternId, hatchConfig);\r\n                                }\r\n                            };\r\n\r\n                            layer.on('add', layer._hatchListener);\r\n                        }\r\n                    }\r\n                }\r\n                // Cas 2: Markers avec ic√¥nes - besoin de recr√©er avec nouvelle ic√¥ne\r\n                else if (global.L && layer instanceof global.L.Marker) {\r\n                    layersToRecreate.push({ layer, feature: layer.feature, style });\r\n                } else {\r\n                    skipped++;\r\n                }\r\n            });\r\n\r\n            // Seconde passe : recr√©er les markers avec les nouvelles couleurs\r\n            if (layersToRecreate.length > 0) {\r\n                const POIMarkers = global.GeoLeaf && global.GeoLeaf._POIMarkers;\r\n\r\n                layersToRecreate.forEach(({ layer, feature, style }) => {\r\n                    const latlng = layer.getLatLng();\r\n\r\n                    // Utiliser le syst√®me POI pour cr√©er une nouvelle ic√¥ne color√©e\r\n                    if (POIMarkers && typeof POIMarkers.buildMarkerIcon === 'function') {\r\n                        const poiData = {\r\n                            ...feature.properties,\r\n                            latlng: [latlng.lat, latlng.lng],\r\n                            attributes: feature.properties.attributes || {},\r\n                            _layerConfig: { style: style } // Passer le style pour resolveCategoryColors\r\n                        };\r\n\r\n                        let displayConfig = {};\r\n                        if (typeof POIMarkers.resolveCategoryDisplay === 'function') {\r\n                            displayConfig = POIMarkers.resolveCategoryDisplay(poiData);\r\n                        }\r\n\r\n                        // Override avec tous les param√®tres du style\r\n                        if (style.fillColor) {\r\n                            displayConfig.colorFill = style.fillColor;\r\n                        }\r\n                        if (style.color) {\r\n                            displayConfig.colorStroke = style.color;\r\n                        }\r\n                        if (typeof style.radius === 'number') {\r\n                            displayConfig.radius = style.radius;\r\n                        }\r\n                        if (typeof style.weight === 'number') {\r\n                            displayConfig.weight = style.weight;\r\n                        }\r\n                        if (typeof style.fillOpacity === 'number') {\r\n                            displayConfig.fillOpacity = style.fillOpacity;\r\n                        }\r\n                        if (typeof style.opacity === 'number') {\r\n                            displayConfig.opacity = style.opacity;\r\n                        }\r\n\r\n                        const newIcon = POIMarkers.buildMarkerIcon(displayConfig);\r\n                        layer.setIcon(newIcon);\r\n                        markersRecreated++;\r\n                    } else {\r\n                        // Fallback: remplacer par un CircleMarker\r\n                        const newMarker = global.L.circleMarker(latlng, style);\r\n                        newMarker.feature = feature;\r\n                        leafletLayer.removeLayer(layer);\r\n                        leafletLayer.addLayer(newMarker);\r\n                        markersRecreated++;\r\n                    }\r\n                });\r\n            }\r\n\r\n            Log.debug(`[GeoLeaf.GeoJSON] Style appliqu√©: ${styled + markersRecreated} features (${styled} setStyle, ${markersRecreated} markers)`);\r\n\r\n            // Appliquer le hachurage global uniquement si pas de styleRules avec hatch\r\n            const hasHatchInRules = styleRules.some(rule => rule.style?.hatch?.enabled);\r\n\r\n            if (defaultStyle._hatchPatternId && !hasHatchInRules) {\r\n                const patternId = defaultStyle._hatchPatternId;\r\n\r\n                // Appliquer imm√©diatement\r\n                _applyHatchToLayer(leafletLayer, patternId);\r\n\r\n                // Log r√©sum√© au lieu de logs individuels\r\n                Log.debug(`[GeoLeaf.GeoJSON] Hachures appliqu√©es: pattern=${patternId}, features=${styled}`);\r\n\r\n                // Supprimer les anciens listeners pour √©viter les doublons\r\n                if (layerData._hatchListeners) {\r\n                    leafletLayer.off('add', layerData._hatchListeners.onAdd);\r\n                    if (global.L && global.L.DomEvent) {\r\n                        leafletLayer.eachLayer(layer => {\r\n                            if (layer._path) {\r\n                                layer.off('add', layerData._hatchListeners.onLayerAdd);\r\n                            }\r\n                        });\r\n                    }\r\n                }\r\n\r\n                // Cr√©er les listeners pour r√©appliquer le hachurage apr√®s les redraws\r\n                const onAdd = () => {\r\n                    setTimeout(() => _applyHatchToLayer(leafletLayer, patternId), 0);\r\n                };\r\n\r\n                const onLayerAdd = function() {\r\n                    if (this._path) {\r\n                        this._path.setAttribute('fill', `url(#${patternId})`);\r\n                    }\r\n                };\r\n\r\n                // Ajouter les listeners\r\n                leafletLayer.on('add', onAdd);\r\n                leafletLayer.eachLayer(layer => {\r\n                    if (layer._path) {\r\n                        layer.on('add', onLayerAdd);\r\n                    }\r\n                });\r\n\r\n                // Stocker les listeners pour nettoyage futur\r\n                layerData._hatchListeners = { onAdd, onLayerAdd };\r\n                layerData._hatchPatternId = patternId;\r\n            }\r\n\r\n            // Mettre √† jour la config stock√©e pour que les futures √©valuations utilisent le nouveau style\r\n            layerData.config = Object.assign({}, layerData.config, {\r\n                style: styleConfig.defaultStyle || styleConfig.style,\r\n                styleRules: styleRules\r\n            });\r\n\r\n            // Stocker currentStyle pour les labels\r\n            layerData.currentStyle = styleConfig;\r\n\r\n            // Mettre √† jour l'√©tat du bouton des labels imm√©diatement\r\n            if (GeoLeaf._LabelButtonManager) {\r\n                GeoLeaf._LabelButtonManager.syncImmediate(layerId);\r\n            }\r\n\r\n            // R√©√©valuer la visibilit√© apr√®s application du style (layerScale)\r\n            if (GeoLeaf._GeoJSONLayerManager && typeof GeoLeaf._GeoJSONLayerManager.updateLayerVisibilityByZoom === \"function\") {\r\n                GeoLeaf._GeoJSONLayerManager.updateLayerVisibilityByZoom();\r\n            }\r\n\r\n            Log.debug(\"[GeoLeaf.GeoJSON] Style appliqu√© avec succ√®s :\", layerId);\r\n            return true;\r\n        } catch (err) {\r\n            Log.error(\"[GeoLeaf.GeoJSON] Erreur setLayerStyle :\", layerId, err.message);\r\n            return false;\r\n        }\r\n    };\r\n\r\n})(window);\r\n","/**\r\n * GeoLeaf GeoJSON Layer Manager - Integration\r\n * Layer Manager UI registration, legend loading, populate with all configs\r\n *\r\n * @module geojson/layer-manager/integration\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    const getState = () => GeoLeaf._GeoJSONShared.state;\r\n    const getLog = () => (GeoLeaf.Log || console);\r\n\r\n    const LayerManager = GeoLeaf._GeoJSONLayerManager = GeoLeaf._GeoJSONLayerManager || {};\r\n\r\n    /**\r\n     * Enregistre les couches dans le module LayerManager.\r\n     */\r\n    LayerManager.registerWithLayerManager = function () {\r\n        const state = getState();\r\n        const Log = getLog();\r\n        const LMgr = GeoLeaf.LayerManager;\r\n\r\n        Log.info(`[GeoLeaf.GeoJSON] registerWithLayerManager() appel√© avec ${state.layers.size} couche(s)`);\r\n\r\n        if (!LMgr || typeof LMgr._registerGeoJsonLayer !== \"function\") {\r\n            Log.warn(\"[GeoLeaf.GeoJSON] Module LayerManager non disponible, pas d'int√©gration gestionnaire de couches\");\r\n            return;\r\n        }\r\n\r\n        // Grouper les layers par idSection\r\n        const sectionMap = new Map();\r\n\r\n        state.layers.forEach((layerData, id) => {\r\n            // Log pour debug - VOIR TOUTES LES COUCHES\r\n            // Utiliser layerManagerId d√©fini dans layer.json\r\n            const sectionId = layerData.config.layerManagerId || \"geojson-default\";\r\n\r\n            if (!sectionMap.has(sectionId)) {\r\n                sectionMap.set(sectionId, {\r\n                    id: sectionId,\r\n                    order: 99,\r\n                    items: []\r\n                });\r\n            }\r\n\r\n            const type = LayerManager.detectLayerType(layerData.layer);\r\n            let legendType = \"fill\";\r\n            if (type === \"poi\") legendType = \"circle\";\r\n            else if (type === \"route\") legendType = \"line\";\r\n            else if (type === \"area\") legendType = \"fill\";\r\n\r\n            let color = \"#3388ff\";\r\n            if (layerData.config.style) {\r\n                color = layerData.config.style.fillColor || layerData.config.style.color || color;\r\n            } else if (layerData.config.pointStyle) {\r\n                color = layerData.config.pointStyle.fillColor || color;\r\n            }\r\n\r\n            // D√©tecter si la couche a des labels (dans la config OU dans le style courant)\r\n            let hasLabels = false;\r\n            let labelsConfig = null;\r\n\r\n            // V√©rifier d'abord dans la config de la couche\r\n            if (layerData.config.labels && layerData.config.labels.enabled) {\r\n                hasLabels = true;\r\n                labelsConfig = layerData.config.labels;\r\n            }\r\n\r\n            // V√©rifier ensuite dans le style actuel (currentStyle)\r\n            if (!hasLabels && layerData.currentStyle && layerData.currentStyle.label && layerData.currentStyle.label.enabled) {\r\n                hasLabels = true;\r\n                // Cr√©er une config de labels minimale bas√©e sur le style\r\n                labelsConfig = { enabled: true };\r\n            }\r\n\r\n            // Log pour TOUTES les couches pour comprendre le probl√®me\r\n            if (Log) {\r\n                Log.info(`[GeoJSON LayerManager] üîç Pr√©paration item ${id}:`, {\r\n                    hasConfig: !!layerData.config,\r\n                    hasStyles: !!(layerData.config && layerData.config.styles),\r\n                    styles: layerData.config ? layerData.config.styles : 'NO CONFIG',\r\n                    configKeys: layerData.config ? Object.keys(layerData.config).sort() : []\r\n                });\r\n            }\r\n\r\n            sectionMap.get(sectionId).items.push({\r\n                id: id,\r\n                label: layerData.label,\r\n                type: legendType,\r\n                color: color,\r\n                visible: layerData.visible,\r\n                toggleable: true,\r\n                order: 0,\r\n                zIndex: layerData.config.zIndex || 0,\r\n                themes: layerData.config.themes || null,\r\n                labels: hasLabels ? labelsConfig : null,\r\n                styles: layerData.config.styles || null\r\n            });\r\n        });\r\n\r\n        // Ajouter chaque section au gestionnaire de couches\r\n        sectionMap.forEach((section) => {\r\n            // Trier les items par zIndex d√©croissant (zIndex √©lev√© = en haut = affich√© au-dessus)\r\n            section.items.sort((a, b) => (b.zIndex || 0) - (a.zIndex || 0));\r\n\r\n            // Enregistrer chaque couche dans le LayerManager\r\n            section.items.forEach((item) => {\r\n                Log.debug(`[GeoLeaf.GeoJSON] Enregistrement couche \"${item.id}\" dans section \"${section.id}\"`);\r\n                LMgr._registerGeoJsonLayer(item.id, {\r\n                    layerManagerId: section.id,\r\n                    label: item.label,\r\n                    themes: item.themes,\r\n                    styles: item.styles,\r\n                    labels: item.labels\r\n                });\r\n            });\r\n\r\n            Log.debug(\"[GeoLeaf.GeoJSON] Section couche '\" + section.id + \"' cr√©√©e avec \" + section.items.length + \" couche(s)\");\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Charge la l√©gende d'une couche si disponible\r\n     * @param {string} layerId - ID de la couche\r\n     * @param {Object} layerData - Donn√©es de la couche\r\n     * @private\r\n     */\r\n    LayerManager._loadLayerLegend = function (layerId, layerData) {\r\n        const Log = getLog();\r\n\r\n        const config = layerData.config || {};\r\n\r\n        // Nouveau flux : g√©n√©rer la l√©gende depuis le style JSON\r\n        if (GeoLeaf.Legend && typeof GeoLeaf.Legend.loadLayerLegend === \"function\") {\r\n            // D√©terminer le style courant\r\n            const styleSelector = GeoLeaf._LayerManagerStyleSelector;\r\n            let styleId = null;\r\n\r\n            if (styleSelector && typeof styleSelector.getCurrentStyle === \"function\") {\r\n                styleId = styleSelector.getCurrentStyle(layerId) || null;\r\n            }\r\n\r\n            // Fallback depuis metadata √©ventuelle\r\n            if (!styleId && layerData.currentStyleMetadata && layerData.currentStyleMetadata.id) {\r\n                styleId = layerData.currentStyleMetadata.id;\r\n            }\r\n\r\n            // Fallback depuis la config de styles\r\n            if (!styleId && config.styles && Array.isArray(config.styles.available)) {\r\n                const available = config.styles.available;\r\n                // Essayer de trouver l'ID correspondant au fichier default\r\n                const defaultFile = config.styles.default;\r\n                const defaultByFile = defaultFile ? available.find(s => s.file === defaultFile) : null;\r\n                styleId = (defaultByFile && defaultByFile.id) || (available[0] && available[0].id) || \"default\";\r\n            }\r\n\r\n            if (!styleId) {\r\n                styleId = \"default\";\r\n            }\r\n\r\n            GeoLeaf.Legend.loadLayerLegend(layerId, styleId, config);\r\n            return;\r\n        }\r\n\r\n        // Legacy fallback: charger un fichier de l√©gende statique si d√©clar√©\r\n        if (!GeoLeaf.Legend || typeof GeoLeaf.Legend.addLayerLegend !== \"function\") {\r\n            return;\r\n        }\r\n\r\n        if (!config.legends || !Array.isArray(config.legends.available)) {\r\n            return;\r\n        }\r\n\r\n        let activeStyle = layerData.activeStyle;\r\n        if (!activeStyle && config.styles && Array.isArray(config.styles.available)) {\r\n            const defaultStyle = config.styles.available.find(s => s.id === \"default\");\r\n            activeStyle = defaultStyle ? defaultStyle.id : (config.styles.available[0] ? config.styles.available[0].id : \"default\");\r\n        }\r\n        if (!activeStyle) {\r\n            activeStyle = \"default\";\r\n        }\r\n\r\n        const legendEntry = config.legends.available.find(l => l.id === activeStyle);\r\n        if (!legendEntry || !legendEntry.file) {\r\n            Log.warn(`[GeoLeaf.GeoJSON] Pas de l√©gende trouv√©e pour le style ${activeStyle} de la couche ${layerId}`);\r\n            return;\r\n        }\r\n\r\n        const profileId = config._profileId;\r\n        const layerDir = config._layerDirectory;\r\n        const legendDir = config.legends.directory || \"legends\";\r\n\r\n        if (!profileId || !layerDir) {\r\n            Log.warn(\"[GeoLeaf.GeoJSON] M√©tadonn√©es manquantes (profileId ou layerDirectory) pour charger la l√©gende\");\r\n            return;\r\n        }\r\n\r\n        const Config = GeoLeaf.Config;\r\n        const dataCfg = Config && Config.get ? Config.get('data') : null;\r\n        const profilesBasePath = (dataCfg && dataCfg.profilesBasePath) || \"profiles\";\r\n\r\n        const legendPath = `${profilesBasePath}/${profileId}/${layerDir}/${legendDir}/${legendEntry.file}`;\r\n\r\n        fetch(legendPath)\r\n            .then(response => {\r\n                if (!response.ok) {\r\n                    throw new Error(`HTTP ${response.status}`);\r\n                }\r\n                return response.json();\r\n            })\r\n            .then(legendData => {\r\n                GeoLeaf.Legend.addLayerLegend(layerId, activeStyle, legendData);\r\n                Log.debug(`[GeoLeaf.GeoJSON] L√©gende charg√©e pour ${layerId} (${activeStyle})`);\r\n            })\r\n            .catch(error => {\r\n                Log.warn(`[GeoLeaf.GeoJSON] Erreur chargement l√©gende pour ${layerId}:`, error.message);\r\n            });\r\n    };\r\n\r\n    /**\r\n     * Peuple le LayerManager avec TOUTES les configurations de couches disponibles.\r\n     * Contrairement √† registerWithLayerManager() qui ne montre que les couches charg√©es (th√®me actif),\r\n     * cette fonction affiche TOUTES les couches et met √† jour l'√©tat coch√© selon le th√®me actif.\r\n     *\r\n     * @param {Object} activeThemeConfig - Configuration du th√®me actif (contient liste des layers visibles)\r\n     * @returns {void}\r\n     */\r\n    LayerManager.populateLayerManagerWithAllConfigs = function(activeThemeConfig) {\r\n            // ...logs nettoy√©s...\r\n        const Log = getLog();\r\n        const LMgr = GeoLeaf.LayerManager;\r\n\r\n        if (!LMgr || typeof LMgr._registerGeoJsonLayer !== \"function\") {\r\n            Log.warn(\"[GeoLeaf.GeoJSON] populateLayerManagerWithAllConfigs: Module LayerManager non disponible\");\r\n            return;\r\n        }\r\n\r\n        if (!GeoLeaf._allLayerConfigs || !Array.isArray(GeoLeaf._allLayerConfigs)) {\r\n            Log.warn(\"[GeoLeaf.GeoJSON] populateLayerManagerWithAllConfigs: GeoLeaf._allLayerConfigs non disponible\");\r\n            return;\r\n        }\r\n\r\n        Log.info(`[GeoLeaf.GeoJSON] Peuplement LayerManager avec ${GeoLeaf._allLayerConfigs.length} configs de couches...`);\r\n        // ...log debug supprim√©...\r\n\r\n        // Obtenir la liste des couches actives du th√®me\r\n        // Les layers peuvent √™tre des objets {id, visible, style} ou des strings simples\r\n        let activeThemeLayers = [];\r\n        if (activeThemeConfig && Array.isArray(activeThemeConfig.layers)) {\r\n            activeThemeLayers = activeThemeConfig.layers.map(l => l.id || l);\r\n        }\r\n        Log.debug(`[GeoLeaf.GeoJSON] Couches actives du th√®me: ${activeThemeLayers.join(', ')}`);\r\n\r\n        // Grouper les configs par sectionId (layerManagerId)\r\n        const sectionMap = new Map();\r\n\r\n        GeoLeaf._allLayerConfigs.forEach(config => {\r\n            const sectionId = config.layerManagerId || \"geojson-default\";\r\n\r\n            if (!sectionMap.has(sectionId)) {\r\n                sectionMap.set(sectionId, {\r\n                    id: sectionId,\r\n                    items: []\r\n                });\r\n            }\r\n\r\n            // D√©terminer si la couche est active dans le th√®me courant\r\n            const isActive = activeThemeLayers.includes(config.id);\r\n\r\n            // Log pour debug - VOIR CE QUI EST DANS config POUR TOUTES LES COUCHES\r\n            // ...logs supprim√©s ([GeoJSON LayerManager] config debug)...\r\n\r\n            sectionMap.get(sectionId).items.push({\r\n                id: config.id,\r\n                label: config.label,\r\n                layerManagerId: sectionId,\r\n                themes: config.themes || null,\r\n                isActive: isActive,\r\n                zIndex: config.zIndex || 0,\r\n                styles: config.styles || null,\r\n                labels: config.labels || null\r\n            });\r\n        });\r\n\r\n        // Enregistrer chaque couche avec le LayerManager\r\n        sectionMap.forEach((section) => {\r\n            // Trier par zIndex d√©croissant\r\n            section.items.sort((a, b) => (b.zIndex || 0) - (a.zIndex || 0));\r\n\r\n            section.items.forEach((item) => {\r\n                Log.debug(`[GeoLeaf.GeoJSON] Enregistrement couche \"${item.id}\" dans section \"${section.id}\" (actif: ${item.isActive})`);\r\n                LMgr._registerGeoJsonLayer(item.id, {\r\n                    layerManagerId: section.id,\r\n                    label: item.label,\r\n                    themes: item.themes,\r\n                    checked: item.isActive,\r\n                    styles: item.styles,\r\n                    labels: item.labels\r\n                });\r\n            });\r\n\r\n            Log.debug(`[GeoLeaf.GeoJSON] Section \"${section.id}\" peupl√©e avec ${section.items.length} couche(s)`);\r\n        });\r\n\r\n        Log.info(`[GeoLeaf.GeoJSON] LayerManager peupl√© avec succ√®s`);\r\n\r\n        // Mettre √† jour l'UI du LayerManager si n√©cessaire\r\n        if (LMgr._updateUI && typeof LMgr._updateUI === \"function\") {\r\n            Log.debug(\"[GeoLeaf.GeoJSON] Appel LayerManager._updateUI()\");\r\n            LMgr._updateUI();\r\n        }\r\n    };\r\n\r\n})(window);\r\n","/**\r\n * GeoLeaf GeoJSON Module - Popup & Tooltip\r\n * Gestion des popups et tooltips unifi√©s\r\n *\r\n * @module geojson/popup-tooltip\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n\r\n    // D√©pendances lazy\r\n    const getState = () => GeoLeaf._GeoJSONShared.state;\r\n    const getLog = () => (GeoLeaf.Log || console);\r\n\r\n    GeoLeaf._GeoJSONPopupTooltip = GeoLeaf._GeoJSONPopupTooltip || {};\r\n\r\n    /**\r\n     * Convertit une feature GeoJSON en format POI pour le side panel.\r\n     * Utilise _Normalizer si disponible, sinon cr√©e un POI par d√©faut.\r\n     * Enrichissement centralis√© pour tous les POIs.\r\n     *\r\n     * @param {Object} feature - Feature GeoJSON\r\n     * @param {Object} def - D√©finition de la couche\r\n     * @returns {Object} - Objet POI format√©\r\n     */\r\n    GeoLeaf._GeoJSONPopupTooltip.convertFeatureToPOI = function (feature, def) {\r\n        let poi;\r\n\r\n        // Utiliser le Normalizer centralis√© si disponible\r\n        const Normalizer = GeoLeaf._Normalizer;\r\n        if (Normalizer && typeof Normalizer.normalizeFromGeoJSON === 'function') {\r\n            poi = Normalizer.normalizeFromGeoJSON(feature, def);\r\n        } else {\r\n            // Fallback: logique locale\r\n            const props = feature.properties || {};\r\n\r\n            poi = {\r\n                id: props.id || (\"geojson-feature-\" + Math.random().toString(36).substr(2, 9)),\r\n                // R√©solution case-insensitive du titre (28 janvier 2026)\r\n                title: props.NAME || props.Name || props.name ||\r\n                       props.TITLE || props.Title || props.title ||\r\n                       props.LABEL || props.Label || props.label || \"Sans titre\",\r\n                description: props.description || props.desc || \"\",\r\n                // Conserver properties pour compatibilit√© avec les configs qui utilisent \"properties.field\"\r\n                properties: { ...props },\r\n                attributes: {\r\n                    source: \"geojson\",\r\n                    layerId: def.id,\r\n                    layerLabel: def.label,\r\n                    ...props\r\n                }\r\n            };\r\n\r\n            // Ajouter les coordonn√©es dans tous les formats support√©s\r\n            if (feature.geometry && feature.geometry.coordinates) {\r\n                // Format latlng array [lat, lng] pour compatibilit√© POI\r\n                poi.latlng = [\r\n                    feature.geometry.coordinates[1], // lat\r\n                    feature.geometry.coordinates[0]  // lng\r\n                ];\r\n                // Format geometry pour compatibilit√© GeoJSON\r\n                poi.geometry = feature.geometry;\r\n                // Format location pour compatibilit√© legacy\r\n                poi.location = {\r\n                    lat: feature.geometry.coordinates[1],\r\n                    lng: feature.geometry.coordinates[0]\r\n                };\r\n            }\r\n        }\r\n\r\n        // Enrichissement centralis√© pour tous les POIs\r\n        if (poi) {\r\n            poi.attributes = poi.attributes || {};\r\n            poi.attributes.source = \"geojson\";\r\n            poi.attributes.layerId = def.id;\r\n            poi.attributes.layerLabel = def.label;\r\n\r\n            // Attacher la configuration de la couche\r\n            poi._layerConfig = def;\r\n\r\n            // Utiliser getSidepanelConfig pour la normalisation correcte\r\n            const Loader = GeoLeaf._GeoJSONLoader;\r\n            const sidepanelLayout = Loader && Loader.getSidepanelConfig ? Loader.getSidepanelConfig(def) : null;\r\n            if (sidepanelLayout) {\r\n                poi._sidepanelConfig = {\r\n                    detailLayout: sidepanelLayout\r\n                };\r\n            }\r\n        }\r\n\r\n        return poi;\r\n    };\r\n\r\n    /**\r\n     * Attache un popup unifi√© compatible avec le syst√®me POI.\r\n     *\r\n     * @param {Object} feature - Feature GeoJSON\r\n     * @param {L.Layer} layer - Couche Leaflet\r\n     * @param {Object} def - D√©finition de la couche\r\n     */\r\n    GeoLeaf._GeoJSONPopupTooltip.bindUnifiedPopup = function (feature, layer, def) {\r\n        const Log = getLog();\r\n\r\n        if (!feature.properties) return;\r\n\r\n        // Si interactiveShape est false, ne rien attacher (la couche est non-cliquable)\r\n        if (def.interactiveShape === false) {\r\n            return;\r\n        }\r\n\r\n        // V√©rifier le param√®tre showPopup de la couche (d√©faut: true)\r\n        const showPopup = typeof def.showPopup === 'boolean' ? def.showPopup : true;\r\n\r\n        // Si showPopup est false, mode DIRECT: toggle du panneau lat√©ral au clic (sans popup)\r\n        if (!showPopup) {\r\n            layer.on(\"click\", (e) => {\r\n                if (e && e.originalEvent) e.originalEvent.stopPropagation();\r\n\r\n                // Masquer le tooltip si pr√©sent\r\n                if (layer.getTooltip && layer.getTooltip()) {\r\n                    try {\r\n                        if (typeof layer.closeTooltip === 'function') layer.closeTooltip();\r\n                        else layer.unbindTooltip();\r\n                    } catch (err) { /* ignore */ }\r\n                }\r\n\r\n                if (GeoLeaf.POI && typeof GeoLeaf.POI.showPoiDetails === \"function\") {\r\n                    const poiData = GeoLeaf._GeoJSONPopupTooltip.convertFeatureToPOI(feature, def);\r\n                    const shared = GeoLeaf._POIShared && GeoLeaf._POIShared.state;\r\n                    const current = shared ? shared.currentPoiInPanel : null;\r\n\r\n                    // Toggle: si le m√™me POI est ouvert, fermer le panneau, sinon l'ouvrir\r\n                    if (current && poiData && current.id && poiData.id && current.id === poiData.id) {\r\n                        if (GeoLeaf.POI && typeof GeoLeaf.POI.hideSidePanel === 'function') {\r\n                            GeoLeaf.POI.hideSidePanel();\r\n                        }\r\n                    } else {\r\n                        GeoLeaf.POI.showPoiDetails(poiData);\r\n                    }\r\n                }\r\n            });\r\n            return;\r\n        }\r\n\r\n        // Si un popup existe d√©j√† (cr√©√© par POI Markers), le conserver\r\n        if (layer.getPopup()) {\r\n            return;\r\n        }\r\n\r\n        // Convertir la feature en POI normalis√©\r\n        const poiData = GeoLeaf._GeoJSONPopupTooltip.convertFeatureToPOI(feature, def);\r\n\r\n        // Utiliser ContentBuilder si disponible\r\n        const ContentBuilder = GeoLeaf._ContentBuilder;\r\n        // Utiliser le helper pour r√©cup√©rer la config popup (28 janvier 2026)\r\n        const Loader = GeoLeaf._GeoJSONLoader;\r\n\r\n        let popupConfig = null;\r\n        try {\r\n            popupConfig = Loader && Loader.getPopupConfig ? Loader.getPopupConfig(def) : null;\r\n        } catch (e) {\r\n            // ...log supprim√© ([DEBUG] bindUnifiedPopup - ERREUR getPopupConfig)...\r\n        }\r\n\r\n        // ...logs supprim√©s ([POPUP] bindUnifiedPopup)...\r\n        if (ContentBuilder && typeof ContentBuilder.buildPopupHTML === 'function') {\r\n            const markersModule = GeoLeaf._POIMarkers;\r\n            const resolveCategoryDisplay = markersModule && typeof markersModule.resolveCategoryDisplay === 'function'\r\n                ? markersModule.resolveCategoryDisplay\r\n                : null;\r\n\r\n            const popupContent = ContentBuilder.buildPopupHTML(poiData, popupConfig, {\r\n                resolveCategoryDisplay: resolveCategoryDisplay\r\n            });\r\n\r\n            if (popupContent) {\r\n                layer.bindPopup(popupContent);\r\n            }\r\n        } else {\r\n            // Fallback: utiliser POIPopup module\r\n            const popupModule = GeoLeaf._POIPopup;\r\n            if (popupModule && typeof popupModule.buildQuickPopupContent === 'function') {\r\n                const markersModule = GeoLeaf._POIMarkers;\r\n                const resolveCategoryDisplay = markersModule && typeof markersModule.resolveCategoryDisplay === 'function'\r\n                    ? markersModule.resolveCategoryDisplay\r\n                    : null;\r\n\r\n                const popupContent = popupModule.buildQuickPopupContent(poiData, resolveCategoryDisplay);\r\n                if (popupContent) {\r\n                    layer.bindPopup(popupContent);\r\n                }\r\n            } else {\r\n                // Fallback minimal sans modules\r\n                const Security = GeoLeaf.Security || {\r\n                    escapeHtml: (str) => {\r\n                        if (!str) return \"\";\r\n                        const div = document.createElement(\"div\");\r\n                        div.textContent = String(str);\r\n                        return div.innerHTML;\r\n                    }\r\n                };\r\n\r\n                const props = feature.properties;\r\n                const name = props.name || props.label || props.title || \"Sans titre\";\r\n                const description = props.description || props.desc || \"\";\r\n\r\n                let popupHtml = '<div class=\"gl-geojson-popup\">';\r\n                popupHtml += '<h3 class=\"gl-popup-title\">' + Security.escapeHtml(name) + '</h3>';\r\n\r\n                if (description) {\r\n                    popupHtml += '<p class=\"gl-popup-description\">' + Security.escapeHtml(description) + '</p>';\r\n                }\r\n\r\n                if (GeoLeaf.POI && typeof GeoLeaf.POI.showPoiDetails === \"function\") {\r\n                    popupHtml += '<a href=\"#\" class=\"gl-poi-popup__link\" data-layer-id=\"' + def.id + '\" data-feature-id=\"' + (props.id || '') + '\">Voir d√©tails ‚Üí</a>';\r\n                }\r\n\r\n                popupHtml += '</div>';\r\n                layer.bindPopup(popupHtml);\r\n            }\r\n        }\r\n\r\n        // Flag pour tracker l'√©tat du popup\r\n        layer._geoleafPopupActive = false;\r\n\r\n        // Fermer le tooltip quand le popup s'ouvre\r\n        layer.on('popupopen', () => {\r\n            layer._geoleafPopupActive = true;\r\n\r\n            // Fermer le tooltip si pr√©sent\r\n            if (layer.getTooltip && layer.getTooltip()) {\r\n                try {\r\n                    if (typeof layer.closeTooltip === 'function') {\r\n                        layer.closeTooltip();\r\n                    }\r\n                } catch (err) {\r\n                    Log.warn('[GeoJSON] Erreur fermeture tooltip:', err);\r\n                }\r\n            }\r\n\r\n            // D√©l√©gation d'√©v√©nement pour le lien \"Voir d√©tails\"\r\n            const popup = layer.getPopup();\r\n            if (!popup) return;\r\n\r\n            const popupEl = popup.getElement();\r\n            if (!popupEl) return;\r\n\r\n            const link = popupEl.querySelector('.gl-poi-popup__link');\r\n            if (link) {\r\n                link.addEventListener('click', (e) => {\r\n                    e.preventDefault();\r\n                    if (GeoLeaf.POI && typeof GeoLeaf.POI.showPoiDetails === \"function\") {\r\n                        const poiData = GeoLeaf._GeoJSONPopupTooltip.convertFeatureToPOI(feature, def);\r\n                        GeoLeaf.POI.showPoiDetails(poiData);\r\n                    }\r\n                });\r\n            }\r\n        });\r\n\r\n        // R√©activer le tooltip quand le popup se ferme\r\n        layer.on('popupclose', () => {\r\n            layer._geoleafPopupActive = false;\r\n\r\n            // R√©ouvrir le tooltip s'il est permanent (mode \"always\")\r\n            if (layer.getTooltip() && layer.getTooltip().options.permanent) {\r\n                setTimeout(() => {\r\n                    if (layer.openTooltip && !layer._geoleafPopupActive) {\r\n                        layer.openTooltip();\r\n                    }\r\n                }, 50);\r\n            }\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Attache un tooltip unifi√© √† une couche selon sa configuration.\r\n     *\r\n     * @param {Object} feature - Feature GeoJSON\r\n     * @param {L.Layer} layer - Couche Leaflet\r\n     * @param {Object} def - D√©finition de la couche\r\n     */\r\n    GeoLeaf._GeoJSONPopupTooltip.bindUnifiedTooltip = function (feature, layer, def) {\r\n        const state = getState();\r\n\r\n        if (!feature.properties || !layer) return;\r\n\r\n        // R√©cup√©rer les param√®tres de tooltip de la couche\r\n        const tooltipMode = def.tooltipMode || \"hover\"; // \"always\", \"never\", \"hover\"\r\n        const tooltipMinZoom = typeof def.tooltipMinZoom === \"number\" ? def.tooltipMinZoom : 0;\r\n\r\n        // Si mode \"never\", ne rien faire\r\n        if (tooltipMode === \"never\") {\r\n            return;\r\n        }\r\n\r\n        // Construire le texte du tooltip par d√©faut\r\n        const props = feature.properties;\r\n        const tooltipText = props.name || props.label || props.title || props.id || \"Sans titre\";\r\n\r\n        // Utiliser le helper pour r√©cup√©rer la config tooltip (28 janvier 2026)\r\n        const Loader = GeoLeaf._GeoJSONLoader;\r\n        const tooltipConfig = Loader && Loader.getTooltipConfig ? Loader.getTooltipConfig(def) : null;\r\n\r\n        // Convertir la feature en POI pour avoir access aux champs via attributes.*\r\n        const featureAsPoi = GeoLeaf._GeoJSONPopupTooltip.convertFeatureToPOI(feature, def);\r\n\r\n        // Fonction pour construire le contenu du tooltip\r\n        const buildTooltipContent = () => {\r\n            // Utiliser ContentBuilder si disponible\r\n            const ContentBuilder = GeoLeaf._ContentBuilder;\r\n            if (ContentBuilder && typeof ContentBuilder.buildTooltipHTML === 'function') {\r\n                const content = ContentBuilder.buildTooltipHTML(featureAsPoi, tooltipConfig);\r\n                return content || tooltipText;\r\n            }\r\n\r\n            // Fallback: utiliser POIPopup module\r\n            const POIPopup = GeoLeaf._POIPopup;\r\n            if (POIPopup && typeof POIPopup.buildTooltipContent === 'function') {\r\n                const content = POIPopup.buildTooltipContent(featureAsPoi);\r\n                return content || tooltipText;\r\n            }\r\n\r\n            // Fallback minimal\r\n            return tooltipText;\r\n        };\r\n\r\n        // Fonction pour g√©rer l'affichage du tooltip selon le zoom\r\n        const updateTooltipVisibility = () => {\r\n            if (!state.map) return;\r\n\r\n            // Ne pas afficher le tooltip si un popup est actif sur cette couche\r\n            if (layer._geoleafPopupActive) return;\r\n\r\n            const currentZoom = state.map.getZoom();\r\n            const shouldShow = currentZoom >= tooltipMinZoom;\r\n\r\n            const content = buildTooltipContent();\r\n\r\n            if (shouldShow) {\r\n                if (!layer.getTooltip()) {\r\n                    const opts = {\r\n                        direction: 'top',\r\n                        offset: [0, -10],\r\n                        opacity: 0.9,\r\n                        className: 'gl-geojson-tooltip',\r\n                        permanent: tooltipMode === 'always'\r\n                    };\r\n                    layer.bindTooltip(content, opts);\r\n                    if (tooltipMode === 'always' && layer.openTooltip) {\r\n                        layer.openTooltip();\r\n                    }\r\n                } else {\r\n                    // update existing tooltip content\r\n                    const tooltip = layer.getTooltip();\r\n                    if (tooltip && tooltip.setContent) tooltip.setContent(content);\r\n                }\r\n            } else {\r\n                if (layer.getTooltip()) {\r\n                    try {\r\n                        if (typeof layer.closeTooltip === 'function') {\r\n                            layer.closeTooltip();\r\n                        } else {\r\n                            layer.unbindTooltip();\r\n                        }\r\n                    } catch (err) {\r\n                        /* ignore */\r\n                    }\r\n                }\r\n            }\r\n        };\r\n\r\n        // Stocker la r√©f√©rence pour le nettoyage\r\n        layer._geoleafTooltipUpdate = updateTooltipVisibility;\r\n\r\n        // Bloquer l'ouverture du tooltip pendant que le popup est actif\r\n        layer.on('tooltipopen', (e) => {\r\n            if (layer._geoleafPopupActive) {\r\n                layer.closeTooltip();\r\n            }\r\n        });\r\n\r\n        // Attendre que la couche soit ajout√©e √† la map avant d'initialiser\r\n        layer.on('add', () => {\r\n            // Initialiser le tooltip\r\n            updateTooltipVisibility();\r\n\r\n            // Ajouter le listener sur le zoom\r\n            if (state.map) {\r\n                state.map.on('zoomend', updateTooltipVisibility);\r\n            }\r\n        });\r\n\r\n        // Nettoyer le listener quand la couche est retir√©e\r\n        layer.on('remove', () => {\r\n            if (state.map && layer._geoleafTooltipUpdate) {\r\n                state.map.off('zoomend', layer._geoleafTooltipUpdate);\r\n            }\r\n        });\r\n    };\r\n\r\n})(window);\r\n","/**\r\n * GeoLeaf GeoJSON Module - Clustering\r\n * Gestion des strat√©gies de clustering (unified, by-source, etc.)\r\n *\r\n * @module geojson/clustering\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n\r\n    // D√©pendances lazy\r\n    const getLog = () => (GeoLeaf.Log || console);\r\n\r\n    GeoLeaf._GeoJSONClustering = GeoLeaf._GeoJSONClustering || {};\r\n\r\n    /**\r\n     * R√©cup√®re la configuration POI globale.\r\n     *\r\n     * @returns {Object}\r\n     */\r\n    GeoLeaf._GeoJSONClustering.getPoiConfig = function () {\r\n        const Config = GeoLeaf.Config;\r\n        if (Config && typeof Config.get === \"function\") {\r\n            return Config.get(\"poiConfig\") || {};\r\n        }\r\n        return {};\r\n    };\r\n\r\n    /**\r\n     * R√©cup√®re le cluster partag√© du module POI s'il existe.\r\n     *\r\n     * @returns {L.MarkerClusterGroup|null}\r\n     */\r\n    GeoLeaf._GeoJSONClustering.getSharedPOICluster = function () {\r\n        const Log = getLog();\r\n\r\n        try {\r\n            const POI = GeoLeaf.POI;\r\n            if (!POI || typeof POI.getLayer !== \"function\") {\r\n                Log.info(\"[GeoLeaf.GeoJSON] ‚ùå Module POI non disponible ou getLayer() manquant\");\r\n                return null;\r\n            }\r\n\r\n            const poiLayer = POI.getLayer();\r\n\r\n            if (!poiLayer) {\r\n                Log.info(\"[GeoLeaf.GeoJSON] ‚ùå POI.getLayer() retourne null/undefined\");\r\n                return null;\r\n            }\r\n\r\n            Log.info(\"[GeoLeaf.GeoJSON] üîç POI.getLayer() retourn√©:\", {\r\n                hasAddLayer: typeof poiLayer.addLayer === \"function\",\r\n                hasRemoveLayer: typeof poiLayer.removeLayer === \"function\",\r\n                hasFeatureGroup: poiLayer._featureGroup !== undefined,\r\n                hasGroup: poiLayer._group !== undefined,\r\n                hasClusterGroup: poiLayer._markerCluster !== undefined,\r\n                isMarkerClusterGroup: poiLayer.constructor && poiLayer.constructor.name === 'MarkerClusterGroup',\r\n                constructor: poiLayer.constructor ? poiLayer.constructor.name : 'unknown'\r\n            });\r\n\r\n            // V√©rifier si c'est un markerClusterGroup ou LayerGroup valide\r\n            // Accepter tout layer avec addLayer/removeLayer (plus permissif)\r\n            if (poiLayer &&\r\n                typeof poiLayer.addLayer === \"function\" &&\r\n                typeof poiLayer.removeLayer === \"function\") {\r\n                Log.info(\"[GeoLeaf.GeoJSON] ‚úÖ Cluster/Layer POI r√©cup√©r√© avec succ√®s\");\r\n                return poiLayer;\r\n            }\r\n\r\n            Log.warn(\"[GeoLeaf.GeoJSON] ‚ùå POI.getLayer() ne retourne pas un layer valide (checks failed)\");\r\n        } catch (e) {\r\n            Log.error(\"[GeoLeaf.GeoJSON] ‚ùå Impossible de r√©cup√©rer le cluster POI :\", e);\r\n        }\r\n        return null;\r\n    };\r\n\r\n    /**\r\n     * D√©termine la strat√©gie de clustering pour une couche.\r\n     *\r\n     * @param {Object} def - D√©finition de la couche\r\n     * @param {Object} geojsonData - Donn√©es GeoJSON\r\n     * @returns {Object} - { shouldCluster: boolean, useSharedCluster: boolean }\r\n     */\r\n    GeoLeaf._GeoJSONClustering.getClusteringStrategy = function (def, geojsonData) {\r\n        const Log = getLog();\r\n        const poiConfig = GeoLeaf._GeoJSONClustering.getPoiConfig();\r\n\r\n        // Normaliser def.clustering: peut √™tre boolean ou object\r\n        const clusteringConfig = typeof def.clustering === 'object' ? def.clustering : { enabled: def.clustering };\r\n        const isClusteringEnabled = clusteringConfig.enabled === true;\r\n        const isClusteringDisabled = clusteringConfig.enabled === false;\r\n\r\n        // Override explicite dans la couche: clustering.enabled: false (priorit√© absolue)\r\n        if (isClusteringDisabled) {\r\n            return { shouldCluster: false, useSharedCluster: false };\r\n        }\r\n\r\n        // Si clustering d√©sactiv√© globalement ET pas d'override dans la couche\r\n        if (!poiConfig.clustering && !isClusteringEnabled) {\r\n            return { shouldCluster: false, useSharedCluster: false };\r\n        }\r\n\r\n        // V√©rifier si la couche contient des Points\r\n        const hasPoints = geojsonData.features && geojsonData.features.some(f =>\r\n            f.geometry && f.geometry.type && f.geometry.type.includes(\"Point\")\r\n        );\r\n\r\n        if (!hasPoints) {\r\n            return { shouldCluster: false, useSharedCluster: false };\r\n        }\r\n\r\n        // Override explicite dans la couche: clustering.enabled: true\r\n        if (isClusteringEnabled) {\r\n            // Si la couche a des param√®tres de clustering sp√©cifiques, cr√©er un cluster ind√©pendant\r\n            const clusterRadius = clusteringConfig.maxClusterRadius || (typeof def.clusterRadius === \"number\" ? def.clusterRadius : null);\r\n            const disableAtZoom = clusteringConfig.disableClusteringAtZoom || (typeof def.disableClusteringAtZoom === \"number\" ? def.disableClusteringAtZoom : null);\r\n\r\n            const hasCustomClusterParams =\r\n                (clusterRadius !== null && clusterRadius !== (poiConfig.clusterRadius || 80)) ||\r\n                (disableAtZoom !== null && disableAtZoom !== (poiConfig.disableClusteringAtZoom || 18));\r\n\r\n            if (hasCustomClusterParams) {\r\n                return {\r\n                    shouldCluster: true,\r\n                    useSharedCluster: false  // Cluster ind√©pendant avec param√®tres personnalis√©s\r\n                };\r\n            }\r\n\r\n            // Sinon, respecter la strat√©gie globale\r\n            const strategy = poiConfig.clusterStrategy || \"unified\";\r\n            return {\r\n                shouldCluster: true,\r\n                useSharedCluster: strategy === \"unified\"\r\n            };\r\n        }\r\n\r\n        // Lire la strat√©gie configur√©e\r\n        const strategy = poiConfig.clusterStrategy || \"unified\";\r\n\r\n        switch (strategy) {\r\n            case \"unified\":\r\n                // Un seul cluster partag√© pour tous\r\n                return { shouldCluster: true, useSharedCluster: true };\r\n\r\n            case \"by-layer\":\r\n                // Cluster ind√©pendant par couche: respecte clustering.enabled: true/false en config\r\n                // Par d√©faut, pas de cluster SAUF si clustering.enabled === true\r\n                return {\r\n                    shouldCluster: isClusteringEnabled,\r\n                    useSharedCluster: false  // Chaque couche a son propre cluster\r\n                };\r\n\r\n            case \"by-source\":\r\n                // Cluster s√©par√© par source\r\n                const sourceConfig = poiConfig.clusterStrategies?.[\"by-source\"]?.sources || {};\r\n                const shouldClusterGeoJSON = sourceConfig.geojson !== false;\r\n                return {\r\n                    shouldCluster: shouldClusterGeoJSON,\r\n                    useSharedCluster: false\r\n                };\r\n\r\n            case \"json-only\":\r\n                // Cluster uniquement pour JSON, pas GeoJSON\r\n                const jsonOnlyConfig = poiConfig.clusterStrategies?.[\"json-only\"] || {};\r\n                return {\r\n                    shouldCluster: jsonOnlyConfig.geojsonClustering === true,\r\n                    useSharedCluster: false\r\n                };\r\n\r\n            default:\r\n                // Par d√©faut : comportement unifi√© (r√©trocompatibilit√©)\r\n                Log.warn(\"[GeoLeaf.GeoJSON] Strat√©gie de clustering inconnue: \" + strategy + \". Utilisation de 'unified'.\");\r\n                return { shouldCluster: true, useSharedCluster: true };\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Cr√©e un cluster ind√©pendant avec les options sp√©cifi√©es.\r\n     *\r\n     * @param {Object} options - Options de clustering\r\n     * @returns {L.MarkerClusterGroup|null}\r\n     */\r\n    GeoLeaf._GeoJSONClustering.createIndependentCluster = function (options = {}) {\r\n        if (!global.L || !global.L.markerClusterGroup) {\r\n            return null;\r\n        }\r\n\r\n        return global.L.markerClusterGroup({\r\n            maxClusterRadius: options.clusterRadius || 80,\r\n            disableClusteringAtZoom: options.disableClusteringAtZoom || 18,\r\n            animate: options.animate !== undefined ? options.animate : false,\r\n            spiderfyOnMaxZoom: options.spiderfyOnMaxZoom !== undefined ? options.spiderfyOnMaxZoom : false,\r\n            showCoverageOnHover: options.showCoverageOnHover !== undefined ? options.showCoverageOnHover : false,\r\n            zoomToBoundsOnClick: options.zoomToBoundsOnClick !== undefined ? options.zoomToBoundsOnClick : true\r\n        });\r\n    };\r\n\r\n})(window);\r\n","/**\n * GeoLeaf GeoJSON Module - Layer Configuration Manager\n * Gestion de la configuration et des options des couches\n *\n * @module geojson/layer-config-manager\n */\n(function (global) {\n    \"use strict\";\n\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\n\n    // D√©pendances lazy\n    const getShared = () => GeoLeaf._GeoJSONShared;\n    const getState = () => GeoLeaf._GeoJSONShared.state;\n    const getLog = () => (GeoLeaf.Log || console);\n\n    GeoLeaf._GeoJSONLayerConfig = GeoLeaf._GeoJSONLayerConfig || {};\n\n    /**\n     * R√©sout le chemin absolu d'un fichier de donn√©es\n     *\n     * @param {string} dataFile - Nom du fichier de donn√©es\n     * @param {Object} profile - Profil actif\n     * @param {string} [layerDirectory] - Dossier de la couche\n     * @returns {string} Chemin absolu r√©solu\n     */\n    GeoLeaf._GeoJSONLayerConfig.resolveDataFilePath = function (dataFile, profile, layerDirectory) {\n        const Config = GeoLeaf.Config;\n        const dataCfg = Config && Config.get ? Config.get('data') : null;\n        const profilesBasePath = (dataCfg && dataCfg.profilesBasePath) || \"profiles\";\n        const profileId = (dataCfg && dataCfg.activeProfile) || profile.id;\n\n        // Si dataFile commence par ../, on r√©sout relativement au dossier du profil\n        if (dataFile.startsWith('../')) {\n            // dataFile = \"../raw/file.json\" -> \"profiles/tourism/raw/file.json\"\n            const relativePath = dataFile.replace('../', '');\n            return `${profilesBasePath}/${profileId}/${relativePath}`;\n        }\n\n        // Si dataFile commence par /, c'est un chemin absolu\n        if (dataFile.startsWith('/')) {\n            return dataFile;\n        }\n\n        // Sinon, relatif au dossier de la couche (layers/tourism_poi_all/data/file.json)\n        if (layerDirectory) {\n            return `${profilesBasePath}/${profileId}/${layerDirectory}/${dataFile}`;\n        }\n\n        // Fallback: relatif au dossier du profil\n        return `${profilesBasePath}/${profileId}/${dataFile}`;\n    };\n\n    /**\n     * Inf√®re le type de g√©om√©trie d'une couche\n     *\n     * @param {Object} def - D√©finition de la couche\n     * @param {Object} geojsonData - Donn√©es GeoJSON\n     * @returns {string} Type de g√©om√©trie ('point', 'line', 'polygon', 'unknown')\n     */\n    GeoLeaf._GeoJSONLayerConfig.inferGeometryType = function (def, geojsonData) {\n        if (def && typeof def.geometryType === \"string\") return def.geometryType;\n        const features = geojsonData && Array.isArray(geojsonData.features)\n            ? geojsonData.features\n            : [];\n        const first = features.find(f => f && f.geometry && f.geometry.type);\n        if (!first) return \"unknown\";\n        const geometryType = first.geometry.type.toLowerCase();\n        if (geometryType.includes(\"point\")) return \"point\";\n        if (geometryType.includes(\"line\")) return \"line\";\n        if (geometryType.includes(\"polygon\")) return \"polygon\";\n        return \"unknown\";\n    };\n\n    /**\n     * Construit les options Leaflet pour une couche sp√©cifique\n     * Configure pointToLayer, onEachFeature, styles, popups, tooltips et panes\n     *\n     * @param {Object} def - D√©finition de la couche depuis profile.json\n     * @param {string} def.id - ID unique de la couche\n     * @param {number} [def.zIndex] - Index z pour le positionnement\n     * @param {Object} [def.style] - Style par d√©faut de la couche\n     * @param {Array} [def.styleRules] - R√®gles de style conditionnelles\n     * @param {boolean} [def.interactiveShape=false] - Rendre les formes interactives\n     * @param {boolean} [def.showIconsOnMap=false] - Afficher ic√¥nes SVG pour les points\n     * @param {Object} baseOptions - Options de base du module GeoJSON\n     * @returns {Object} Options Leaflet configur√©es (pointToLayer, onEachFeature, style, etc.)\n     * @example\n     * const options = GeoLeaf._GeoJSONLayerConfig.buildLayerOptions(\n     *   { id: 'poi_tourism', zIndex: 100, showIconsOnMap: true },\n     *   { defaultPointStyle: { radius: 8 } }\n     * );\n     */\n    GeoLeaf._GeoJSONLayerConfig.buildLayerOptions = function (def, baseOptions) {\n        const state = getState();\n        const mergedOptions = Object.assign({}, state.options, baseOptions);\n\n        // Style des polygones / lignes\n        if (def.style && typeof def.style === \"object\") {\n            mergedOptions.defaultStyle = Object.assign(\n                {},\n                mergedOptions.defaultStyle,\n                def.style\n            );\n        }\n\n        // R√®gles de style dynamiques (styleRules)\n        if (Array.isArray(def.styleRules) && def.styleRules.length > 0) {\n            mergedOptions.styleRules = def.styleRules;\n        }\n\n        // D√©terminer le param√®tre interactiveShape pour cette couche\n        mergedOptions.interactiveShape = typeof def.interactiveShape === \"boolean\"\n            ? def.interactiveShape\n            : (GeoLeaf.Config && GeoLeaf.Config.get ? GeoLeaf.Config.get('ui.interactiveShapes', false) : false);\n\n        // V√©rifier si on doit afficher les ic√¥nes SVG sur la carte\n        const showIconsOnMap = typeof def.showIconsOnMap === 'boolean' ? def.showIconsOnMap : false;\n\n        // D√©terminer le pane √† utiliser pour cette couche\n        const PaneHelpers = GeoLeaf._GeoJSONShared.PaneHelpers;\n        const paneName = PaneHelpers.getPaneName(def.zIndex);\n\n        // Style des points\n        if (showIconsOnMap) {\n            // Mode IC√îNE : utiliser les ic√¥nes SVG du profil\n            mergedOptions.pointToLayer = function (feature, latlng) {\n                // Convertir la feature en POI pour obtenir les infos de cat√©gorie\n                const PopupTooltip = GeoLeaf._GeoJSONPopupTooltip;\n                const poiData = PopupTooltip ? PopupTooltip.convertFeatureToPOI(feature, def) : null;\n\n                if (poiData) {\n                    // Convertir le format ancien 'fields' au nouveau 'detailPopup'\n                    const popupConfig = def.popup || {};\n                    const convertedPopup = {\n                        enabled: popupConfig.enabled,\n                        // Format ancien: { fields: [...] } ‚Üí Format nouveau: { detailPopup: [...] }\n                        detailPopup: popupConfig.detailPopup || popupConfig.fields || [],\n                        // Aussi supporter l'ancien format de tooltip\n                        detailTooltip: popupConfig.detailTooltip || (popupConfig.tooltip && popupConfig.tooltip.fields) || []\n                    };\n\n                    // Passer toute la configuration de la couche au POI\n                    poiData._layerConfig = {\n                        style: mergedOptions.defaultStyle || {},\n                        popup: convertedPopup,\n                        tooltip: def.tooltip || {},\n                        sidepanelConfig: def.sidepanelConfig || {}\n                    };\n                }\n\n                // Utiliser le syst√®me de markers POI pour cr√©er l'ic√¥ne\n                const markers = GeoLeaf._POIMarkers;\n                if (markers && typeof markers.createMarker === 'function' && poiData) {\n                    const attachEvents = mergedOptions.interactiveShape !== false;\n                    const marker = markers.createMarker(poiData, { attachEvents, pane: paneName });\n                    // S'assurer que le pane est d√©fini sur le marker\n                    if (marker && marker.options) {\n                        marker.options.pane = paneName;\n                    }\n                    return marker;\n                }\n\n                // Fallback sur circleMarker avec pane\n                const pointStyle = Object.assign(\n                    {},\n                    mergedOptions.defaultPointStyle,\n                    def.pointStyle,\n                    { interactive: mergedOptions.interactiveShape, pane: paneName }\n                );\n                return global.L.circleMarker(latlng, pointStyle);\n            };\n        } else if (def.pointStyle && typeof def.pointStyle === \"object\") {\n            // Mode CIRCLE : utiliser circleMarker classique avec pane\n            const pointStyle = Object.assign(\n                {},\n                mergedOptions.defaultPointStyle,\n                def.pointStyle,\n                { interactive: mergedOptions.interactiveShape, pane: paneName }\n            );\n            mergedOptions.pointToLayer = function (feature, latlng) {\n                return global.L.circleMarker(latlng, pointStyle);\n            };\n        }\n\n        // Callback onEachFeature : int√©gration popups + side panel + tooltips\n        const originalOnEachFeature = typeof def.onEachFeature === \"function\" ? def.onEachFeature : null;\n\n        mergedOptions.onEachFeature = function (feature, layer) {\n            // Popup unifi√©\n            const PopupTooltip = GeoLeaf._GeoJSONPopupTooltip;\n            if (PopupTooltip) {\n                PopupTooltip.bindUnifiedPopup(feature, layer, def);\n                PopupTooltip.bindUnifiedTooltip(feature, layer, def);\n            }\n\n            // Callback custom si fourni\n            if (originalOnEachFeature) {\n                originalOnEachFeature(feature, layer);\n            }\n        };\n\n        // Ajouter le pane aux defaultPointStyle pour que le style-resolver l'utilise dans son fallback\n        if (mergedOptions.defaultPointStyle) {\n            mergedOptions.defaultPointStyle = Object.assign({}, mergedOptions.defaultPointStyle, { pane: paneName });\n        } else {\n            mergedOptions.defaultPointStyle = { pane: paneName };\n        }\n\n        // Utiliser le StyleResolver pour construire les options Leaflet finales\n        if (GeoLeaf._GeoJSONStyleResolver && GeoLeaf._GeoJSONStyleResolver.buildLeafletOptions) {\n            return GeoLeaf._GeoJSONStyleResolver.buildLeafletOptions(mergedOptions);\n        }\n\n        return mergedOptions;\n    };\n\n    /**\n     * Charge la l√©gende d'une couche depuis son fichier legends/*.json\n     * R√©sout automatiquement le chemin selon le style actif et la config du profil\n     *\n     * @param {Object} profile - Profil contenant la configuration\n     * @param {string} profile.id - ID du profil (ex: 'tourism')\n     * @param {string} [profile.basePath] - Chemin de base du profil\n     * @param {Object} layerDef - D√©finition de la couche depuis profile.json\n     * @param {string} layerDef.id - ID de la couche\n     * @param {string} [layerDef.style='default'] - Style actif de la couche\n     * @param {Object} [layerDef.legends] - Configuration des l√©gendes\n     * @param {string} [layerDef.legends.directory='legends'] - Dossier des l√©gendes\n     * @param {string} [layerDef.legends.default] - Fichier l√©gende par d√©faut\n     * @returns {void} Charge et affiche la l√©gende via GeoLeaf.Legend.loadLegend()\n     * @example\n     * GeoLeaf._GeoJSONLayerConfig.loadLayerLegend(\n     *   { id: 'tourism', basePath: '../profiles/tourism' },\n     *   { id: 'poi_all', style: 'par_categorie', legends: { directory: 'legends' } }\n     * );\n     */\n    GeoLeaf._GeoJSONLayerConfig.loadLayerLegend = function (profile, layerDef) {\n        const Log = getLog();\n\n        if (!layerDef) {\n            if (Log) Log.debug(\"[GeoLeaf.GeoJSON] Pas de d√©finition de couche\");\n            return;\n        }\n\n        // Pour v3.0, la config de la couche est d√©j√† dans layerDef (enrichie par profile.js)\n        const layerConfig = layerDef.legends ? layerDef : null;\n\n        if (!layerConfig || !layerConfig.legends) {\n            if (Log) Log.debug(\"[GeoLeaf.GeoJSON] Pas de config legends pour cette couche\");\n            return;\n        }\n\n        const legendsConfig = layerConfig.legends;\n        const legendDirectory = legendsConfig.directory || \"legends\";\n\n        // D√©terminer le style actif de la couche\n        const activeStyle = layerDef.style || \"default\";\n\n        // Construire le nom de fichier de la l√©gende\n        let legendFile;\n        if (activeStyle === \"default\" && legendsConfig.default) {\n            legendFile = legendsConfig.default;\n        } else {\n            legendFile = `${activeStyle}.legend.json`;\n        }\n\n        // Construire le chemin de la l√©gende\n        const profileBasePath = profile.basePath || \"./profiles/\" + profile.id;\n        const layerDirectory = layerDef._layerDirectory || \"layers/\" + layerDef.id;\n        const legendPath = `${profileBasePath}/${layerDirectory}/${legendDirectory}/${legendFile}`;\n\n        if (Log) Log.debug(`[GeoLeaf.GeoJSON] Chargement l√©gende pour style \"${activeStyle}\": ${legendPath}`);\n\n        // Charger et afficher la l√©gende directement\n        if (GeoLeaf.Legend && typeof GeoLeaf.Legend.loadLegend === \"function\") {\n            GeoLeaf.Legend.loadLegend(legendPath)\n                .then(success => {\n                    if (success && Log) {\n                        Log.info(`[GeoLeaf.GeoJSON] L√©gende affich√©e pour ${layerDef.id} (style: ${activeStyle})`);\n                    }\n                })\n                .catch(error => {\n                    if (Log) Log.warn(`[GeoLeaf.GeoJSON] Erreur chargement l√©gende: ${error.message}`);\n                });\n        } else {\n            if (Log) Log.warn(\"[GeoLeaf.GeoJSON] Module Legend non disponible\");\n        }\n    };\n\n    /**\n     * Charge le style par d√©faut d'une couche depuis son fichier styles/*.style.json\n     * Fonction asynchrone utilisant fetch() pour charger le JSON\n     *\n     * @async\n     * @param {string} layerId - ID de la couche (utilis√© pour le logging)\n     * @param {Object} layerDef - D√©finition de la couche\n     * @param {Object} layerDef.styles - Configuration des styles\n     * @param {string} layerDef.styles.default - Nom du fichier de style par d√©faut\n     * @param {string} [layerDef.styles.directory='styles'] - Dossier des styles\n     * @param {string} layerDef._profileId - ID du profil (m√©tadonn√©e interne)\n     * @param {string} layerDef._layerDirectory - Dossier de la couche (m√©tadonn√©e interne)\n     * @returns {Promise<Object>} Style charg√© (objet JSON pars√©)\n     * @throws {Error} \"Pas de style par d√©faut d√©fini\" si styles.default manquant\n     * @throws {Error} \"M√©tadonn√©es manquantes\" si _profileId ou _layerDirectory absent\n     * @throws {Error} \"HTTP {status}\" si le fetch √©choue\n     * @example\n     * try {\n     *   const style = await GeoLeaf._GeoJSONLayerConfig.loadDefaultStyle(\n     *     'provincia_ar',\n     *     { styles: { default: 'd√©faut.json' }, _profileId: 'tourism', _layerDirectory: 'layers/provincia_ar' }\n     *   );\n     *   console.log('Style charg√©:', style);\n     * } catch (err) {\n     *   console.error('Erreur chargement style:', err);\n     * }\n     */\n    GeoLeaf._GeoJSONLayerConfig.loadDefaultStyle = async function (layerId, layerDef) {\n        const Log = getLog();\n\n        if (!layerDef.styles || !layerDef.styles.default) {\n            throw new Error(\"Pas de style par d√©faut d√©fini\");\n        }\n\n        const profileId = layerDef._profileId;\n        const layerDirectory = layerDef._layerDirectory;\n\n        if (!profileId || !layerDirectory) {\n            throw new Error(\"M√©tadonn√©es manquantes (profileId ou layerDirectory)\");\n        }\n\n        const Config = global.GeoLeaf.Config;\n        const dataCfg = Config && Config.get ? Config.get('data') : null;\n        const profilesBasePath = (dataCfg && dataCfg.profilesBasePath) || \"profiles\";\n\n        const styleDirectory = layerDef.styles.directory || \"styles\";\n        const styleFile = layerDef.styles.default;\n        const stylePath = `${profilesBasePath}/${profileId}/${layerDirectory}/${styleDirectory}/${styleFile}`;\n\n        Log.debug(\"[GeoLeaf.GeoJSON] Chargement style par d√©faut:\", stylePath);\n\n        const response = await fetch(stylePath);\n        if (!response.ok) {\n            throw new Error(`HTTP ${response.status}`);\n        }\n\n        const styleData = await response.json();\n        Log.debug(\"[GeoLeaf.GeoJSON] Style charg√©:\", styleData);\n        return styleData;\n    };\n\n})(window);\n","/**\r\n * GeoLeaf GeoJSON Module - Feature Validator\r\n * Validation stricte des features GeoJSON selon sch√©ma centralis√©\r\n *\r\n * @module geojson/feature-validator\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n\r\n    // D√©pendances lazy\r\n    const getLog = () => (GeoLeaf.Log || console);\r\n\r\n    GeoLeaf._GeoJSONFeatureValidator = GeoLeaf._GeoJSONFeatureValidator || {};\r\n\r\n    /**\r\n     * Valide une FeatureCollection enti√®re et retourne les features valides\r\n     *\r\n     * @param {Object} collection - FeatureCollection GeoJSON\r\n     * @returns {Object} { validFeatures: Array, errors: Array }\r\n     */\r\n    GeoLeaf._GeoJSONFeatureValidator.validateFeatureCollection = function (collection) {\r\n        const Log = getLog();\r\n        const errors = [];\r\n        const validFeatures = [];\r\n\r\n        if (!collection || typeof collection !== \"object\") {\r\n            Log.warn(\"[GeoLeaf.GeoJSON.Validator] Collection non valide : type invalide\");\r\n            return { validFeatures: [], errors: [{ message: \"Collection non valide\" }] };\r\n        }\r\n\r\n        // Accepter les FeatureCollections ou les arrays de features\r\n        const features = collection.type === \"FeatureCollection\"\r\n            ? collection.features\r\n            : Array.isArray(collection)\r\n                ? collection\r\n                : [collection];\r\n\r\n        if (!Array.isArray(features)) {\r\n            Log.warn(\"[GeoLeaf.GeoJSON.Validator] Pas de features √† valider\");\r\n            return { validFeatures: [], errors: [] };\r\n        }\r\n\r\n        features.forEach((feature, index) => {\r\n            const result = GeoLeaf._GeoJSONFeatureValidator.validateFeature(feature, index);\r\n            if (result.valid) {\r\n                validFeatures.push(feature);\r\n            } else {\r\n                errors.push(...result.errors);\r\n            }\r\n        });\r\n\r\n        return { validFeatures, errors };\r\n    };\r\n\r\n    /**\r\n     * Valide une single feature\r\n     *\r\n     * @param {Object} feature - Feature GeoJSON\r\n     * @param {number} [index] - Index dans la collection (pour logging)\r\n     * @returns {Object} { valid: Boolean, errors: Array }\r\n     */\r\n    GeoLeaf._GeoJSONFeatureValidator.validateFeature = function (feature, index) {\r\n        const Log = getLog();\r\n        const errors = [];\r\n        const featureId = feature?.properties?.id || feature?.id || index || \"unknown\";\r\n\r\n        // Type feature\r\n        if (!feature || feature.type !== \"Feature\") {\r\n            errors.push({\r\n                featureId,\r\n                field: \"type\",\r\n                message: \"Feature doit avoir type='Feature'\",\r\n                severity: \"error\"\r\n            });\r\n            Log.warn(`[GeoLeaf.GeoJSON.Validator] Feature ${featureId}: type invalide`);\r\n            return { valid: false, errors };\r\n        }\r\n\r\n        // G√©om√©trie\r\n        const geomResult = GeoLeaf._GeoJSONFeatureValidator.validateGeometry(\r\n            feature.geometry,\r\n            featureId\r\n        );\r\n        if (!geomResult.valid) {\r\n            errors.push(...geomResult.errors);\r\n        }\r\n\r\n        // Propri√©t√©s\r\n        const propsResult = GeoLeaf._GeoJSONFeatureValidator.validateProperties(\r\n            feature.properties,\r\n            featureId\r\n        );\r\n        if (!propsResult.valid) {\r\n            errors.push(...propsResult.errors);\r\n        }\r\n\r\n        if (errors.length > 0) {\r\n            Log.warn(\r\n                `[GeoLeaf.GeoJSON.Validator] Feature ${featureId} rejet√©e : ${errors.map(e => e.message).join(\"; \")}`\r\n            );\r\n            return { valid: false, errors };\r\n        }\r\n\r\n        return { valid: true, errors: [] };\r\n    };\r\n\r\n    /**\r\n     * Valide la g√©om√©trie d'une feature\r\n     *\r\n     * @param {Object} geometry - Geometry GeoJSON\r\n     * @param {string|number} featureId - Feature identifier (for logging)\r\n     * @returns {Object} { valid: Boolean, errors: Array }\r\n     */\r\n    GeoLeaf._GeoJSONFeatureValidator.validateGeometry = function (geometry, featureId) {\r\n        const errors = [];\r\n        const validTypes = [\"Point\", \"LineString\", \"MultiLineString\", \"Polygon\", \"MultiPolygon\"];\r\n\r\n        if (!geometry || typeof geometry !== \"object\") {\r\n            errors.push({\r\n                featureId,\r\n                field: \"geometry\",\r\n                message: \"geometry requis et doit √™tre un objet\",\r\n                severity: \"error\"\r\n            });\r\n            return { valid: false, errors };\r\n        }\r\n\r\n        if (!geometry.type) {\r\n            errors.push({\r\n                featureId,\r\n                field: \"geometry.type\",\r\n                message: \"geometry.type requis\",\r\n                severity: \"error\"\r\n            });\r\n            return { valid: false, errors };\r\n        }\r\n\r\n        if (!validTypes.includes(geometry.type)) {\r\n            errors.push({\r\n                featureId,\r\n                field: \"geometry.type\",\r\n                message: `Type de g√©om√©trie invalide '${geometry.type}'. Doit √™tre : ${validTypes.join(\", \")}`,\r\n                severity: \"error\"\r\n            });\r\n            return { valid: false, errors };\r\n        }\r\n\r\n        if (!Array.isArray(geometry.coordinates) || geometry.coordinates.length === 0) {\r\n            errors.push({\r\n                featureId,\r\n                field: \"geometry.coordinates\",\r\n                message: \"geometry.coordinates doit √™tre un array non-vide\",\r\n                severity: \"error\"\r\n            });\r\n            return { valid: false, errors };\r\n        }\r\n\r\n        return { valid: errors.length === 0, errors };\r\n    };\r\n\r\n    /**\r\n     * Valide les propri√©t√©s d'une feature\r\n     *\r\n     * @param {Object} properties - Feature properties\r\n     * @param {string|number} featureId - Feature identifier (for logging)\r\n     * @returns {Object} { valid: Boolean, errors: Array }\r\n     */\r\n    GeoLeaf._GeoJSONFeatureValidator.validateProperties = function (properties, featureId) {\r\n        const errors = [];\r\n\r\n        if (!properties || typeof properties !== \"object\") {\r\n            errors.push({\r\n                featureId,\r\n                field: \"properties\",\r\n                message: \"properties requis et doit √™tre un objet\",\r\n                severity: \"error\"\r\n            });\r\n            return { valid: false, errors };\r\n        }\r\n\r\n        // Au moins un nom (name, title, ou autre identifier)\r\n        const hasName = properties.name || properties.title || properties.label;\r\n        if (!hasName) {\r\n            errors.push({\r\n                featureId,\r\n                field: \"properties.name\",\r\n                message: \"properties doit contenir au moins name, title ou label\",\r\n                severity: \"error\"\r\n            });\r\n        }\r\n\r\n        // Validation des types num√©riques\r\n        if (typeof properties.distance_km !== \"undefined\" && typeof properties.distance_km !== \"number\") {\r\n            errors.push({\r\n                featureId,\r\n                field: \"properties.distance_km\",\r\n                message: \"distance_km doit √™tre un nombre\",\r\n                severity: \"warning\"\r\n            });\r\n        }\r\n\r\n        if (typeof properties.distance_km === \"number\" && properties.distance_km < 0) {\r\n            errors.push({\r\n                featureId,\r\n                field: \"properties.distance_km\",\r\n                message: \"distance_km doit √™tre >= 0\",\r\n                severity: \"warning\"\r\n            });\r\n        }\r\n\r\n        if (typeof properties.duration_min !== \"undefined\" && typeof properties.duration_min !== \"number\") {\r\n            errors.push({\r\n                featureId,\r\n                field: \"properties.duration_min\",\r\n                message: \"duration_min doit √™tre un nombre\",\r\n                severity: \"warning\"\r\n            });\r\n        }\r\n\r\n        if (typeof properties.duration_min === \"number\" && properties.duration_min < 0) {\r\n            errors.push({\r\n                featureId,\r\n                field: \"properties.duration_min\",\r\n                message: \"duration_min doit √™tre >= 0\",\r\n                severity: \"warning\"\r\n            });\r\n        }\r\n\r\n        if (typeof properties.rating !== \"undefined\") {\r\n            if (typeof properties.rating !== \"number\") {\r\n                errors.push({\r\n                    featureId,\r\n                    field: \"properties.rating\",\r\n                    message: \"rating doit √™tre un nombre\",\r\n                    severity: \"warning\"\r\n                });\r\n            } else if (properties.rating < 0 || properties.rating > 5) {\r\n                errors.push({\r\n                    featureId,\r\n                    field: \"properties.rating\",\r\n                    message: \"rating doit √™tre entre 0 et 5\",\r\n                    severity: \"warning\"\r\n                });\r\n            }\r\n        }\r\n\r\n        // Validation des couleurs hex\r\n        if (typeof properties.color !== \"undefined\" && typeof properties.color === \"string\") {\r\n            if (!/^#([0-9a-fA-F]{6}|[0-9a-fA-F]{3})$/.test(properties.color)) {\r\n                errors.push({\r\n                    featureId,\r\n                    field: \"properties.color\",\r\n                    message: `color invalide '${properties.color}'. Format: #RGB ou #RRGGBB`,\r\n                    severity: \"warning\"\r\n                });\r\n            }\r\n        }\r\n\r\n        // Validation des opacity\r\n        if (typeof properties.opacity !== \"undefined\") {\r\n            if (typeof properties.opacity !== \"number\") {\r\n                errors.push({\r\n                    featureId,\r\n                    field: \"properties.opacity\",\r\n                    message: \"opacity doit √™tre un nombre\",\r\n                    severity: \"warning\"\r\n                });\r\n            } else if (properties.opacity < 0 || properties.opacity > 1) {\r\n                errors.push({\r\n                    featureId,\r\n                    field: \"properties.opacity\",\r\n                    message: \"opacity doit √™tre entre 0 et 1\",\r\n                    severity: \"warning\"\r\n                });\r\n            }\r\n        }\r\n\r\n        // Validation des weight\r\n        if (typeof properties.weight !== \"undefined\") {\r\n            if (typeof properties.weight !== \"number\") {\r\n                errors.push({\r\n                    featureId,\r\n                    field: \"properties.weight\",\r\n                    message: \"weight doit √™tre un nombre\",\r\n                    severity: \"warning\"\r\n                });\r\n            } else if (properties.weight < 0) {\r\n                errors.push({\r\n                    featureId,\r\n                    field: \"properties.weight\",\r\n                    message: \"weight doit √™tre >= 0\",\r\n                    severity: \"warning\"\r\n                });\r\n            }\r\n        }\r\n\r\n        // Validation des URLs\r\n        const urlFields = [\"link\", \"photo\", \"url\"];\r\n        urlFields.forEach(field => {\r\n            if (typeof properties[field] !== \"undefined\" && typeof properties[field] === \"string\") {\r\n                if (!GeoLeaf._GeoJSONFeatureValidator.isValidUrl(properties[field])) {\r\n                    errors.push({\r\n                        featureId,\r\n                        field: `properties.${field}`,\r\n                        message: `${field} n'est pas une URL valide`,\r\n                        severity: \"warning\"\r\n                    });\r\n                }\r\n            }\r\n        });\r\n\r\n        // Validation email\r\n        if (typeof properties.email !== \"undefined\" && typeof properties.email === \"string\") {\r\n            if (!GeoLeaf._GeoJSONFeatureValidator.isValidEmail(properties.email)) {\r\n                errors.push({\r\n                    featureId,\r\n                    field: \"properties.email\",\r\n                    message: \"email invalide\",\r\n                    severity: \"warning\"\r\n                });\r\n            }\r\n        }\r\n\r\n        // Validation tags (doit √™tre array de strings)\r\n        if (typeof properties.tags !== \"undefined\") {\r\n            if (!Array.isArray(properties.tags)) {\r\n                errors.push({\r\n                    featureId,\r\n                    field: \"properties.tags\",\r\n                    message: \"tags doit √™tre un array\",\r\n                    severity: \"warning\"\r\n                });\r\n            } else {\r\n                properties.tags.forEach((tag, idx) => {\r\n                    if (typeof tag !== \"string\") {\r\n                        errors.push({\r\n                            featureId,\r\n                            field: `properties.tags[${idx}]`,\r\n                            message: \"tag doit √™tre une string\",\r\n                            severity: \"warning\"\r\n                        });\r\n                    }\r\n                });\r\n            }\r\n        }\r\n\r\n        // V√©rifier que properties ne contient pas d'objets imbriqu√©s (√† plat obligatoirement)\r\n        Object.entries(properties).forEach(([key, value]) => {\r\n            if (value !== null && typeof value === \"object\" && !Array.isArray(value)) {\r\n                errors.push({\r\n                    featureId,\r\n                    field: `properties.${key}`,\r\n                    message: `Propri√©t√© imbriqu√©e d√©tect√©e. Les propri√©t√©s doivent √™tre plates (strings, nombres, arrays). Objet trouv√©: ${JSON.stringify(value)}`,\r\n                    severity: \"error\"\r\n                });\r\n            }\r\n        });\r\n\r\n        // Les erreurs \"error\" invalident la feature, pas les \"warning\"\r\n        const hasErrors = errors.some(e => e.severity === \"error\");\r\n        return { valid: !hasErrors, errors };\r\n    };\r\n\r\n    /**\r\n     * Valide qu'une string est une URL valide\r\n     *\r\n     * @param {string} url - URL √† valider\r\n     * @returns {Boolean}\r\n     */\r\n    GeoLeaf._GeoJSONFeatureValidator.isValidUrl = function (url) {\r\n        if (typeof url !== \"string\") return false;\r\n        try {\r\n            new URL(url);\r\n            return true;\r\n        } catch {\r\n            // Accepter aussi les URLs relatives\r\n            return /^(https?:\\/\\/|\\/|\\.\\.?\\/)/.test(url);\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Valide qu'une string est un email valide\r\n     *\r\n     * @param {string} email - Email √† valider\r\n     * @returns {Boolean}\r\n     */\r\n    GeoLeaf._GeoJSONFeatureValidator.isValidEmail = function (email) {\r\n        if (typeof email !== \"string\") return false;\r\n        return /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email);\r\n    };\r\n\r\n})(typeof window !== \"undefined\" ? window : global);\r\n","/**\r\n * GeoLeaf GeoJSON Loader - Config Helpers\r\n * Accesseurs de configuration normalis√©e + d√©l√©gu√©s d√©pr√©ci√©s\r\n *\r\n * @module geojson/loader/config-helpers\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    GeoLeaf._GeoJSONLoader = GeoLeaf._GeoJSONLoader || {};\r\n\r\n    /**\r\n     * R√©cup√®re la configuration des champs popup d'une couche.\r\n     *\r\n     * @param {Object} def - D√©finition de la couche (normalis√©e ou originale)\r\n     * @returns {Array|null} - Array de configurations de champs ou null\r\n     */\r\n    GeoLeaf._GeoJSONLoader.getPopupConfig = function(def) {\r\n        if (!def) return null;\r\n\r\n        // Structure normalis√©e (apr√®s passage dans loadProfile)\r\n        if (def.popupFields && Array.isArray(def.popupFields)) {\r\n            return def.popupFields;\r\n        }\r\n\r\n        // Structure originale (depuis config JSON)\r\n        if (def.popup && def.popup.fields && Array.isArray(def.popup.fields)) {\r\n            return def.popup.fields;\r\n        }\r\n\r\n        return null;\r\n    };\r\n\r\n    /**\r\n     * R√©cup√®re la configuration des champs tooltip d'une couche.\r\n     *\r\n     * @param {Object} def - D√©finition de la couche (normalis√©e ou originale)\r\n     * @returns {Array|null} - Array de configurations de champs ou null\r\n     */\r\n    GeoLeaf._GeoJSONLoader.getTooltipConfig = function(def) {\r\n        if (!def) return null;\r\n\r\n        // Structure normalis√©e (apr√®s passage dans loadProfile)\r\n        if (def.tooltipFields && Array.isArray(def.tooltipFields)) {\r\n            return def.tooltipFields;\r\n        }\r\n\r\n        // Structure originale (depuis config JSON)\r\n        if (def.tooltip && def.tooltip.fields && Array.isArray(def.tooltip.fields)) {\r\n            return def.tooltip.fields;\r\n        }\r\n\r\n        return null;\r\n    };\r\n\r\n    /**\r\n     * R√©cup√®re la configuration des champs sidepanel d'une couche.\r\n     *\r\n     * @param {Object} def - D√©finition de la couche (normalis√©e ou originale)\r\n     * @returns {Array|null} - Array de configurations de champs ou null\r\n     */\r\n    GeoLeaf._GeoJSONLoader.getSidepanelConfig = function(def) {\r\n        if (!def) return null;\r\n\r\n        // Structure normalis√©e (apr√®s passage dans loadProfile)\r\n        if (def.sidepanelFields && Array.isArray(def.sidepanelFields)) {\r\n            return def.sidepanelFields;\r\n        }\r\n\r\n        // Structure originale (depuis config JSON)\r\n        if (def.sidepanel && def.sidepanel.detailLayout && Array.isArray(def.sidepanel.detailLayout)) {\r\n            return def.sidepanel.detailLayout;\r\n        }\r\n\r\n        return null;\r\n    };\r\n\r\n    // ‚îÄ‚îÄ‚îÄ D√©l√©gu√©s d√©pr√©ci√©s ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n\r\n    /**\r\n     * @deprecated Utiliser GeoLeaf._GeoJSONLayerConfig.resolveDataFilePath()\r\n     */\r\n    GeoLeaf._GeoJSONLoader._resolveDataFilePath = function (dataFile, profile, layerDirectory) {\r\n        return GeoLeaf._GeoJSONLayerConfig.resolveDataFilePath(dataFile, profile, layerDirectory);\r\n    };\r\n\r\n    /**\r\n     * @deprecated Utiliser GeoLeaf._GeoJSONLayerConfig.inferGeometryType()\r\n     */\r\n    GeoLeaf._GeoJSONLoader._inferGeometryType = function (def, geojsonData) {\r\n        return GeoLeaf._GeoJSONLayerConfig.inferGeometryType(def, geojsonData);\r\n    };\r\n\r\n    /**\r\n     * @deprecated Utiliser GeoLeaf._GeoJSONLayerConfig.buildLayerOptions()\r\n     */\r\n    GeoLeaf._GeoJSONLoader._buildLayerOptions = function (def, baseOptions) {\r\n        return GeoLeaf._GeoJSONLayerConfig.buildLayerOptions(def, baseOptions);\r\n    };\r\n\r\n    /**\r\n     * @deprecated Utiliser GeoLeaf._GeoJSONLayerConfig.loadLayerLegend()\r\n     */\r\n    GeoLeaf._GeoJSONLoader._loadLayerLegend = function (profile, layerDef) {\r\n        return GeoLeaf._GeoJSONLayerConfig.loadLayerLegend(profile, layerDef);\r\n    };\r\n\r\n    /**\r\n     * @deprecated Utiliser GeoLeaf._GeoJSONLayerConfig.loadDefaultStyle()\r\n     */\r\n    GeoLeaf._GeoJSONLoader._loadDefaultStyle = function (layerId, layerDef) {\r\n        return GeoLeaf._GeoJSONLayerConfig.loadDefaultStyle(layerId, layerDef);\r\n    };\r\n\r\n})(window);\r\n","/**\r\n * GeoLeaf GeoJSON Loader - Data\r\n * Chargement direct de donn√©es GeoJSON (URL ou objet JS)\r\n *\r\n * @module geojson/loader/data\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n\r\n    // D√©pendances lazy\r\n    const getState = () => GeoLeaf._GeoJSONShared.state;\r\n    const getLog = () => (GeoLeaf.Log || console);\r\n\r\n    GeoLeaf._GeoJSONLoader = GeoLeaf._GeoJSONLoader || {};\r\n\r\n    /**\r\n     * Charge un fichier GeoJSON via une URL.\r\n     *\r\n     * @param {string} url - URL du fichier GeoJSON.\r\n     * @param {Object} [options] - Options additionnelles, fusionn√©es avec celles du module.\r\n     * @returns {Promise<L.GeoJSON|null>}\r\n     */\r\n    GeoLeaf._GeoJSONLoader.loadUrl = async function (url, options = {}) {\r\n        const state = getState();\r\n        const Log = getLog();\r\n\r\n        if (!url) {\r\n            Log.warn(\"[GeoLeaf.GeoJSON] URL GeoJSON manquante.\");\r\n            return state.geoJsonLayer;\r\n        }\r\n\r\n        if (!state.map) {\r\n            Log.error(\"[GeoLeaf.GeoJSON] Module non initialis√©. Appelle GeoLeaf.GeoJSON.init() avant loadUrl().\");\r\n            return null;\r\n        }\r\n\r\n        const mergedOptions = GeoLeaf.Utils && GeoLeaf.Utils.mergeOptions\r\n            ? GeoLeaf.Utils.mergeOptions(state.options, options)\r\n            : Object.assign({}, state.options, options);\r\n\r\n        try {\r\n            // Sprint 3.3: Use unified FetchHelper for GeoJSON loading\r\n            const FetchHelper = GeoLeaf.Utils?.FetchHelper;\r\n\r\n            let data;\r\n            if (FetchHelper) {\r\n                data = await FetchHelper.get(url, {\r\n                    timeout: 20000, // GeoJSON files can be large\r\n                    retries: 2\r\n                });\r\n            } else {\r\n                // Fallback to raw fetch\r\n                const response = await fetch(url);\r\n                if (!response.ok) {\r\n                    throw new Error(\"HTTP \" + response.status + \" pour \" + url);\r\n                }\r\n                data = await response.json();\r\n            }\r\n\r\n            GeoLeaf._GeoJSONLoader.addData(data, mergedOptions);\r\n            return state.geoJsonLayer;\r\n        } catch (err) {\r\n            Log.error(\"[GeoLeaf.GeoJSON] Erreur lors du chargement GeoJSON :\", err);\r\n            return state.geoJsonLayer;\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Ajoute des donn√©es GeoJSON pass√©es directement en objet JS.\r\n     * Valide les features selon le sch√©ma strict avant ajout.\r\n     *\r\n     * @param {Object} geojsonData - Objet GeoJSON valide.\r\n     * @param {Object} [options] - Options additionnelles, fusionn√©es avec celles du module.\r\n     */\r\n    GeoLeaf._GeoJSONLoader.addData = function (geojsonData, options = {}) {\r\n        const state = getState();\r\n        const Log = getLog();\r\n\r\n        if (!geojsonData) {\r\n            Log.warn(\"[GeoLeaf.GeoJSON] Aucune donn√©e GeoJSON fournie √† addData().\");\r\n            return;\r\n        }\r\n\r\n        if (!state.map || !state.geoJsonLayer) {\r\n            Log.error(\"[GeoLeaf.GeoJSON] Module non initialis√©. Appelle GeoLeaf.GeoJSON.init() avant addData().\");\r\n            return;\r\n        }\r\n\r\n        const mergedOptions = GeoLeaf.Utils && GeoLeaf.Utils.mergeOptions\r\n            ? GeoLeaf.Utils.mergeOptions(state.options, options)\r\n            : Object.assign({}, state.options, options);\r\n\r\n        // Met √† jour les options de la couche si besoin\r\n        if (GeoLeaf._GeoJSONStyleResolver && GeoLeaf._GeoJSONStyleResolver.buildLeafletOptions) {\r\n            state.geoJsonLayer.options = GeoLeaf._GeoJSONStyleResolver.buildLeafletOptions(mergedOptions);\r\n        }\r\n\r\n        // Validation stricte des features GeoJSON\r\n        let dataToAdd = geojsonData;\r\n        if (GeoLeaf._GeoJSONFeatureValidator && typeof GeoLeaf._GeoJSONFeatureValidator.validateFeatureCollection === \"function\") {\r\n            const validationResult = GeoLeaf._GeoJSONFeatureValidator.validateFeatureCollection(geojsonData);\r\n\r\n            if (validationResult.errors.length > 0) {\r\n                Log.warn(\r\n                    `[GeoLeaf.GeoJSON] Validation: ${validationResult.errors.length} feature(s) rejet√©e(s), ${validationResult.validFeatures.length} accept√©e(s)`\r\n                );\r\n            }\r\n\r\n            // Ajouter uniquement les features valides\r\n            if (validationResult.validFeatures.length > 0) {\r\n                if (geojsonData.type === \"FeatureCollection\") {\r\n                    dataToAdd = {\r\n                        type: \"FeatureCollection\",\r\n                        features: validationResult.validFeatures\r\n                    };\r\n                } else {\r\n                    dataToAdd = validationResult.validFeatures.length === 1\r\n                        ? validationResult.validFeatures[0]\r\n                        : { type: \"FeatureCollection\", features: validationResult.validFeatures };\r\n                }\r\n            } else {\r\n                Log.warn(\"[GeoLeaf.GeoJSON] Aucune feature valide √† ajouter apr√®s validation\");\r\n                return;\r\n            }\r\n        }\r\n\r\n        // Ajoute les donn√©es valid√©es\r\n        state.geoJsonLayer.addData(dataToAdd);\r\n\r\n        // Adapter la vue sur les donn√©es si demand√©\r\n        if (mergedOptions.fitBoundsOnLoad && state.layerGroup) {\r\n            const bounds = state.layerGroup.getBounds();\r\n            if (bounds.isValid()) {\r\n                const fitOptions = {};\r\n                if (typeof mergedOptions.maxZoomOnFit === \"number\") {\r\n                    fitOptions.maxZoom = mergedOptions.maxZoomOnFit;\r\n                }\r\n                state.map.fitBounds(bounds, fitOptions);\r\n            }\r\n        }\r\n\r\n        // √âv√©nement custom pour l'√©cosyst√®me GeoLeaf\r\n        try {\r\n            state.map.fire(\"geoleaf:geojson:loaded\", {\r\n                data: geojsonData,\r\n                layer: state.geoJsonLayer\r\n            });\r\n        } catch (e) {\r\n            // On ne bloque jamais si fire √©choue\r\n        }\r\n    };\r\n\r\n})(window);\r\n","/**\r\n * GeoLeaf GeoJSON Loader - Single Layer\r\n * Pipeline complet de chargement d'une couche individuelle\r\n *\r\n * @module geojson/loader/single-layer\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n\r\n    // D√©pendances lazy\r\n    const getState = () => GeoLeaf._GeoJSONShared.state;\r\n    const getLog = () => (GeoLeaf.Log || console);\r\n\r\n    GeoLeaf._GeoJSONLoader = GeoLeaf._GeoJSONLoader || {};\r\n\r\n    /**\r\n     * Charge une couche GeoJSON individuelle.\r\n     *\r\n     * @param {string} layerId - ID unique de la couche\r\n     * @param {string} layerLabel - Libell√© de la couche\r\n     * @param {Object} def - D√©finition de la couche depuis le profil\r\n     * @param {Object} baseOptions - Options de base\r\n     * @returns {Promise<Object>} - M√©tadonn√©es de la couche charg√©e\r\n     * @private\r\n     */\r\n    GeoLeaf._GeoJSONLoader._loadSingleLayer = function (layerId, layerLabel, def, baseOptions) {\r\n        const state = getState();\r\n        const Log = getLog();\r\n\r\n        const fromCache = !!def._cachedData;\r\n        const dataPromise = fromCache\r\n            ? Promise.resolve(def._cachedData)\r\n            : fetch(def.url).then((response) => {\r\n                if (!response.ok) {\r\n                    throw new Error(\"HTTP \" + response.status + \" pour \" + def.url);\r\n                }\r\n\r\n                if (def.type === \"gpx\" || def.url.endsWith(\".gpx\")) {\r\n                    return response.text();\r\n                }\r\n\r\n                return response.json();\r\n            });\r\n\r\n        return dataPromise\r\n            .then((rawData) => {\r\n                if (fromCache) {\r\n                    delete def._cachedData;\r\n                }\r\n\r\n                const DataConverter = GeoLeaf._DataConverter;\r\n                let geojsonData;\r\n\r\n                if (def.type === \"gpx\" || def.url.endsWith(\".gpx\")) {\r\n                    if (typeof rawData === \"string\") {\r\n                        geojsonData = DataConverter && typeof DataConverter.convertGpxToGeoJSON === \"function\"\r\n                            ? DataConverter.convertGpxToGeoJSON(rawData)\r\n                            : { type: \"FeatureCollection\", features: [] };\r\n                    } else {\r\n                        Log.warn(\"[GeoLeaf.GeoJSON._loadSingleLayer] GPX n'est pas un string\", layerId);\r\n                        geojsonData = { type: \"FeatureCollection\", features: [] };\r\n                    }\r\n                } else {\r\n                    geojsonData = DataConverter ? DataConverter.autoConvert(rawData) : rawData;\r\n                }\r\n\r\n                Log.debug(\"[GeoLeaf.GeoJSON._loadSingleLayer] Donn√©es converties\", {\r\n                    layerId: layerId,\r\n                    type: def.type,\r\n                    features: geojsonData.features ? geojsonData.features.length : 0,\r\n                    source: fromCache ? \"cache\" : \"network\"\r\n                });\r\n\r\n                const PaneHelpers = GeoLeaf._GeoJSONShared.PaneHelpers;\r\n                const PaneConfig = GeoLeaf._GeoJSONShared.PANE_CONFIG;\r\n\r\n                const layerOptions = GeoLeaf._GeoJSONLoader._buildLayerOptions(def, baseOptions);\r\n                layerOptions.pane = PaneHelpers.getPaneName(def.zIndex);\r\n                const leafletLayer = global.L.geoJSON(geojsonData, layerOptions);\r\n\r\n                // D√©terminer la strat√©gie de clustering\r\n                const ClusteringModule = GeoLeaf._GeoJSONClustering;\r\n                const clusterStrategy = ClusteringModule\r\n                    ? ClusteringModule.getClusteringStrategy(def, geojsonData)\r\n                    : { shouldCluster: false, useSharedCluster: false };\r\n\r\n                let clusterGroup = null;\r\n                let useSharedCluster = false;\r\n\r\n                if (clusterStrategy.shouldCluster) {\r\n                    if (clusterStrategy.useSharedCluster) {\r\n                        // Utiliser le cluster POI partag√©\r\n                        Log.info(\"[GeoLeaf.GeoJSON] üîÑ Tentative r√©cup√©ration cluster POI partag√© pour:\", layerId);\r\n                        let poiCluster = ClusteringModule ? ClusteringModule.getSharedPOICluster() : null;\r\n\r\n                        if (poiCluster) {\r\n                            clusterGroup = poiCluster;\r\n                            clusterGroup.addLayer(leafletLayer);\r\n                            useSharedCluster = true;\r\n                            Log.info(\"[GeoLeaf.GeoJSON] ‚úÖ Couche ajout√©e au cluster POI partag√© (strat√©gie: unified) :\", layerId);\r\n                        } else {\r\n                            // Le cluster POI n'est pas encore cr√©√©, attendre un peu et r√©essayer\r\n                            Log.debug(\"[GeoLeaf.GeoJSON] Cluster POI non disponible imm√©diatement, tentative apr√®s d√©lai :\", layerId);\r\n\r\n                            // Stocker temporairement sans cluster\r\n                            const tempLayerData = {\r\n                                id: layerId,\r\n                                label: layerLabel,\r\n                                layer: leafletLayer,\r\n                                visible: true,\r\n                                config: def,\r\n                                clusterGroup: null,\r\n                                useSharedCluster: false,\r\n                                pendingSharedCluster: true\r\n                            };\r\n\r\n                            state.layers.set(layerId, tempLayerData);\r\n\r\n                            // R√©essayer apr√®s un court d√©lai\r\n                            setTimeout(() => {\r\n                                poiCluster = ClusteringModule ? ClusteringModule.getSharedPOICluster() : null;\r\n\r\n                                if (poiCluster) {\r\n                                    poiCluster.addLayer(leafletLayer);\r\n                                    tempLayerData.clusterGroup = poiCluster;\r\n                                    tempLayerData.useSharedCluster = true;\r\n                                    tempLayerData.pendingSharedCluster = false;\r\n                                    Log.debug(\"[GeoLeaf.GeoJSON] Couche ajout√©e au cluster POI partag√© (apr√®s d√©lai) :\", layerId);\r\n                                } else {\r\n                                    Log.warn(\"[GeoLeaf.GeoJSON] Cluster POI toujours non disponible, cr√©ation cluster ind√©pendant :\", layerId);\r\n                                    if (global.L.markerClusterGroup) {\r\n                                        const independentCluster = global.L.markerClusterGroup({\r\n                                            maxClusterRadius: def.clusterRadius || 80,\r\n                                            disableClusteringAtZoom: def.disableClusteringAtZoom || 18,\r\n                                            animate: false,\r\n                                            showCoverageOnHover: false\r\n                                        });\r\n\r\n                                        // Forcer le pane sur tous les markers du cluster\r\n                                        independentCluster.on('layeradd', function(e) {\r\n                                            PaneHelpers.applyPaneToLayer(e.layer, def.zIndex || 0);\r\n                                        });\r\n\r\n                                        independentCluster.addLayer(leafletLayer);\r\n                                        tempLayerData.clusterGroup = independentCluster;\r\n                                        tempLayerData.useSharedCluster = false;\r\n                                        tempLayerData.pendingSharedCluster = false;\r\n\r\n                                        if (tempLayerData.visible) {\r\n                                            state.map.addLayer(independentCluster);\r\n                                        }\r\n                                    }\r\n                                }\r\n                            }, 500);\r\n\r\n                            return {\r\n                                id: layerId,\r\n                                label: layerLabel,\r\n                                featureCount: leafletLayer.getLayers().length\r\n                            };\r\n                        }\r\n                    } else {\r\n                        // Cr√©er un cluster ind√©pendant (by-source)\r\n                        if (global.L.markerClusterGroup) {\r\n                            clusterGroup = global.L.markerClusterGroup({\r\n                                maxClusterRadius: def.clusterRadius || 80,\r\n                                disableClusteringAtZoom: def.disableClusteringAtZoom || 18,\r\n                                animate: false,\r\n                                spiderfyOnMaxZoom: false,\r\n                                showCoverageOnHover: false,\r\n                                zoomToBoundsOnClick: true\r\n                            });\r\n\r\n                            // Forcer le pane sur tous les markers du cluster\r\n                            const paneName = PaneHelpers.getPaneName(def.zIndex);\r\n                            clusterGroup.on('layeradd', function(e) {\r\n                                PaneHelpers.applyPaneToLayer(e.layer, def.zIndex || 0);\r\n                            });\r\n\r\n                            clusterGroup.addLayer(leafletLayer);\r\n                            Log.debug(\"[GeoLeaf.GeoJSON] Couche avec cluster ind√©pendant (strat√©gie: by-source) :\", layerId);\r\n                        }\r\n                    }\r\n                } else {\r\n                    Log.debug(\"[GeoLeaf.GeoJSON] Couche sans clustering :\", layerId);\r\n                }\r\n\r\n                // Stocker la couche\r\n                const inferredGeometry = GeoLeaf._GeoJSONLoader._inferGeometryType(def, geojsonData);\r\n\r\n                // Calculer le zIndex si non d√©fini\r\n                let zIndex = def.zIndex;\r\n                if (typeof zIndex !== 'number') {\r\n                    // Calculer automatiquement bas√© sur l'ordre d'apparition\r\n                    const allLayerIds = Array.from(state.layers.keys());\r\n                    zIndex = Math.max(PaneConfig.MIN_LAYER_ZINDEX, PaneConfig.MAX_LAYER_ZINDEX - allLayerIds.length);\r\n                    Log.debug(`[GeoLeaf.GeoJSON] zIndex auto-assign√© pour ${layerId}: ${zIndex}`);\r\n                } else {\r\n                    // Validation et clamping 0-99\r\n                    const validatedZIndex = PaneHelpers.validateZIndex(zIndex);\r\n                    if (validatedZIndex !== def.zIndex) {\r\n                        Log.warn(`[GeoLeaf.GeoJSON] zIndex ${def.zIndex} clamped to ${validatedZIndex} pour ${layerId}`);\r\n                    }\r\n                    zIndex = validatedZIndex;\r\n                }\r\n                def.zIndex = zIndex;\r\n\r\n                const Config = GeoLeaf.Config;\r\n                const dataCfg = Config && Config.get ? Config.get('data') : null;\r\n                const profilesBasePath = (dataCfg && dataCfg.profilesBasePath) || \"profiles\";\r\n                const layerBasePath = `${profilesBasePath}/${def._profileId}/${def._layerDirectory}`;\r\n\r\n                const layerData = {\r\n                    id: layerId,\r\n                    label: layerLabel,\r\n                    layer: leafletLayer,\r\n                    visible: true,\r\n                    config: def,\r\n                    clusterGroup: clusterGroup,\r\n                    legendsConfig: def.legends,\r\n                    basePath: layerBasePath,\r\n                    useSharedCluster: useSharedCluster,\r\n                    geojson: geojsonData,\r\n                    features: Array.isArray(geojsonData.features) ? geojsonData.features : [],\r\n                    geometryType: def.geometryType || inferredGeometry\r\n                };\r\n\r\n                // Initialiser les m√©tadonn√©es de visibilit√© AVANT d'ajouter √† la map\r\n                layerData._visibility = {\r\n                    current: false,\r\n                    logicalState: false,\r\n                    source: 'system',\r\n                    userOverride: false,\r\n                    themeOverride: false,\r\n                    themeDesired: null,\r\n                    zoomConstrained: false\r\n                };\r\n\r\n                state.layers.set(layerId, layerData);\r\n\r\n                // Mettre en cache pour l'UI (filtre, recherche)\r\n                state.featureCache.set(layerId, {\r\n                    features: layerData.features,\r\n                    geometryType: layerData.geometryType\r\n                });\r\n\r\n                // Mettre en cache les donn√©es GeoJSON pour les chargements suivants\r\n                if (GeoLeaf.ThemeCache && typeof GeoLeaf.ThemeCache.store === 'function') {\r\n                    const profileId = def._profileId || (GeoLeaf.Config && GeoLeaf.Config.getActiveProfileId ? GeoLeaf.Config.getActiveProfileId() : null);\r\n                    GeoLeaf.ThemeCache.store(layerId, profileId, geojsonData, { contentLength: def.contentLength });\r\n                }\r\n\r\n                // Appliquer imm√©diatement les seuils de zoom pour cette couche\r\n                if (GeoLeaf._GeoJSONLayerManager) {\r\n                    GeoLeaf._GeoJSONLayerManager.updateLayerVisibilityByZoom();\r\n                }\r\n\r\n                // NE PAS ajouter automatiquement √† la carte au chargement\r\n                // Les th√®mes contr√¥leront la visibilit√© des couches\r\n                layerData.visible = false;\r\n\r\n                // FitBounds UNIQUEMENT si pas de syst√®me de th√®mes\r\n                const shouldFitBounds = def.fitBoundsOnLoad && !GeoLeaf.ThemeSelector;\r\n                if (shouldFitBounds && leafletLayer.getBounds().isValid()) {\r\n                    const fitOptions = {};\r\n                    if (typeof def.maxZoomOnFit === \"number\") {\r\n                        fitOptions.maxZoom = def.maxZoomOnFit;\r\n                    }\r\n                    state.map.fitBounds(leafletLayer.getBounds(), fitOptions);\r\n                }\r\n\r\n                // Charger le style par d√©faut si styles.default est d√©fini\r\n                if (def.styles && def.styles.default) {\r\n                    GeoLeaf._GeoJSONLoader._loadDefaultStyle(layerId, def)\r\n                        .then((styleData) => {\r\n                            if (styleData && GeoLeaf._GeoJSONLayerManager) {\r\n                                Log.debug(\"[GeoLeaf.GeoJSON] Application du style par d√©faut pour:\", layerId);\r\n\r\n                                // Stocker currentStyle dans layerData pour les labels\r\n                                const layerDataForStyle = state.layers.get(layerId);\r\n                                if (layerDataForStyle) {\r\n                                    layerDataForStyle.currentStyle = styleData;\r\n                                    Log.debug(\"[GeoLeaf.GeoJSON] currentStyle stock√© pour:\", layerId);\r\n                                }\r\n\r\n                                GeoLeaf._GeoJSONLayerManager.setLayerStyle(layerId, styleData);\r\n\r\n                                // Initialiser les labels selon le style\r\n                                if (GeoLeaf.Labels && typeof GeoLeaf.Labels.initializeLayerLabels === 'function') {\r\n                                    GeoLeaf.Labels.initializeLayerLabels(layerId);\r\n                                }\r\n\r\n                                // Synchroniser le bouton de label maintenant que currentStyle est d√©fini\r\n                                if (GeoLeaf._LabelButtonManager) {\r\n                                    GeoLeaf._LabelButtonManager.syncImmediate(layerId);\r\n                                }\r\n                            }\r\n                        })\r\n                        .catch((err) => {\r\n                            Log.warn(\"[GeoLeaf.GeoJSON] Erreur chargement style par d√©faut:\", layerId, err.message);\r\n                        });\r\n                } else {\r\n                    // Pas de style par d√©faut: initialiser les labels depuis la config legacy si pr√©sents\r\n                    if (def.labels && def.labels.enabled && GeoLeaf.Labels && typeof GeoLeaf.Labels.initializeLayerLabels === 'function') {\r\n                        GeoLeaf.Labels.initializeLayerLabels(layerId);\r\n                    }\r\n\r\n                    // Synchroniser le bouton de label\r\n                    if (GeoLeaf._LabelButtonManager) {\r\n                        GeoLeaf._LabelButtonManager.syncImmediate(layerId);\r\n                    }\r\n                }\r\n                Log.debug(\"[GeoLeaf.GeoJSON] Couche charg√©e avec succ√®s :\", layerId, \"(\" + leafletLayer.getLayers().length + \" features)\");\r\n\r\n                return {\r\n                    id: layerId,\r\n                    label: layerLabel,\r\n                    featureCount: leafletLayer.getLayers().length\r\n                };\r\n            });\r\n    };\r\n\r\n})(window);\r\n","/**\r\n * GeoLeaf GeoJSON Loader - Profile\r\n * Orchestration du chargement par profil, batch loading, LayerManager population\r\n *\r\n * @module geojson/loader/profile\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n\r\n    // D√©pendances lazy\r\n    const getState = () => GeoLeaf._GeoJSONShared.state;\r\n    const getLog = () => (GeoLeaf.Log || console);\r\n\r\n    GeoLeaf._GeoJSONLoader = GeoLeaf._GeoJSONLoader || {};\r\n\r\n    /**\r\n     * Charge automatiquement les couches GeoJSON d√©clar√©es dans le profil actif.\r\n     *\r\n     * @param {Object} [options] - Options suppl√©mentaires globales appliqu√©es √† toutes les couches.\r\n     * @returns {Promise<Array<Object>>} - Tableau des couches effectivement charg√©es avec m√©tadonn√©es.\r\n     */\r\n    GeoLeaf._GeoJSONLoader.loadFromActiveProfile = function (options = {}) {\r\n        const state = getState();\r\n        const Log = getLog();\r\n        const Config = GeoLeaf.Config;\r\n\r\n\r\n\r\n        if (!Config || typeof Config.getActiveProfile !== \"function\") {\r\n\r\n            Log.warn(\r\n                \"[GeoLeaf.GeoJSON] Module Config ou Config.getActiveProfile() non disponible ; chargement GeoJSON par profil impossible.\"\r\n            );\r\n            return Promise.resolve([]);\r\n        }\r\n\r\n        const profile = Config.getActiveProfile();\r\n\r\n\r\n        if (!profile || typeof profile !== \"object\") {\r\n\r\n            Log.warn(\"[GeoLeaf.GeoJSON] Aucun profil actif ou profil invalide ; aucun GeoJSON charg√©.\");\r\n            return Promise.resolve([]);\r\n        }\r\n\r\n        let layersDef = [];\r\n\r\n        // Format 1 : profil.geojsonLayers = [...]\r\n        if (Array.isArray(profile.geojsonLayers)) {\r\n            layersDef = profile.geojsonLayers;\r\n        }\r\n        // Format 2 : profil.geojson.layers = [...]\r\n        else if (profile.geojson && Array.isArray(profile.geojson.layers)) {\r\n            layersDef = profile.geojson.layers;\r\n        }\r\n        // Format 3 : profil.layers = [...] (nouveau mod√®le Full Layer)\r\n        else if (Array.isArray(profile.layers)) {\r\n            layersDef = profile.layers;\r\n        }\r\n        // Format 4 : v3.0 avec Config.getActiveProfileLayersConfig() (nouvelles couches modulaires)\r\n        else if (Config.Profile && typeof Config.Profile.getActiveProfileLayersConfig === \"function\") {\r\n            const layersConfig = Config.Profile.getActiveProfileLayersConfig();\r\n            if (Array.isArray(layersConfig)) {\r\n                layersDef = layersConfig;\r\n                Log.info(\"[GeoLeaf.GeoJSON] Utilisation du syst√®me v3.0 - \" + layersConfig.length + \" couches d√©tect√©es\");\r\n            }\r\n        }\r\n\r\n        if (!layersDef.length) {\r\n            Log.info(\r\n                \"[GeoLeaf.GeoJSON] Aucun bloc geojsonLayers / geojson.layers / layers d√©fini dans le profil actif ; rien √† charger.\"\r\n            );\r\n            return Promise.resolve([]);\r\n        }\r\n\r\n        // Limite de s√©curit√© : max 50 couches (augment√©e pour profils riches)\r\n        if (layersDef.length > 50) {\r\n            Log.warn(\r\n                \"[GeoLeaf.GeoJSON] Beaucoup de couches GeoJSON d√©tect√©es (\" + layersDef.length + \"). Cela peut affecter les performances.\"\r\n            );\r\n        } else if (layersDef.length > 20) {\r\n            Log.info(\r\n                \"[GeoLeaf.GeoJSON] \" + layersDef.length + \" couches GeoJSON d√©tect√©es. Profil riche d√©tect√©.\"\r\n            );\r\n        }\r\n\r\n        const baseOptions = options || {};\r\n        const batchSize = 3;\r\n        const batchDelay = 200;\r\n        const self = this;\r\n\r\n        const tasks = layersDef.map((def, index) => async () => {\r\n            if (!def || typeof def !== \"object\") {\r\n                Log.warn(\"[GeoLeaf.GeoJSON] Descripteur GeoJSON de profil invalide, ignor√© :\", { index, def });\r\n                return null;\r\n            }\r\n\r\n            if (typeof def.active === \"boolean\" && def.active === false) {\r\n                Log.debug(\"[GeoLeaf.GeoJSON] Couche d√©sactiv√©e (active: false), ignor√©e :\", def.id || \"(sans ID)\");\r\n                return null;\r\n            }\r\n\r\n            const layerDirectory = def._layerDirectory || null;\r\n            const layerUrl = def.url || (def.dataFile ? self._resolveDataFilePath(def.dataFile, profile, layerDirectory) : null);\r\n\r\n            if (!layerUrl) {\r\n                Log.warn(\"[GeoLeaf.GeoJSON] Descripteur GeoJSON sans URL ou dataFile, ignor√© :\", {\r\n                    index,\r\n                    id: def.id,\r\n                    label: def.label\r\n                });\r\n                return null;\r\n            }\r\n\r\n            const normalizedDef = { ...def, url: layerUrl };\r\n            normalizedDef._profileId = profile.id;\r\n            normalizedDef._layerDirectory = layerDirectory;\r\n\r\n            // Normalisation unifi√©e des configurations\r\n            if (def.popup && typeof def.popup === 'object') {\r\n                normalizedDef.showPopup = def.popup.enabled !== false;\r\n                if (def.popup.fields && Array.isArray(def.popup.fields)) {\r\n                    normalizedDef.popupFields = def.popup.fields;\r\n                }\r\n                normalizedDef.popup = def.popup;\r\n            }\r\n\r\n            if (def.tooltip && typeof def.tooltip === 'object') {\r\n                normalizedDef.showTooltip = def.tooltip.enabled !== false;\r\n                if (def.tooltip.fields && Array.isArray(def.tooltip.fields)) {\r\n                    normalizedDef.tooltipFields = def.tooltip.fields;\r\n                }\r\n                if (def.tooltip.mode) {\r\n                    normalizedDef.tooltipMode = def.tooltip.mode;\r\n                }\r\n                normalizedDef.tooltip = def.tooltip;\r\n            }\r\n\r\n            if (def.sidepanel && typeof def.sidepanel === 'object') {\r\n                if (def.sidepanel.detailLayout && Array.isArray(def.sidepanel.detailLayout)) {\r\n                    normalizedDef.sidepanelFields = def.sidepanel.detailLayout;\r\n                }\r\n                normalizedDef.sidepanel = def.sidepanel;\r\n            }\r\n\r\n            if (def.clustering && typeof def.clustering === 'object') {\r\n                normalizedDef.clustering = def.clustering.enabled !== false;\r\n                if (typeof def.clustering.maxClusterRadius === 'number') {\r\n                    normalizedDef.maxClusterRadius = def.clustering.maxClusterRadius;\r\n                    normalizedDef.clusterRadius = def.clustering.maxClusterRadius;\r\n                }\r\n                if (typeof def.clustering.disableClusteringAtZoom === 'number') {\r\n                    normalizedDef.disableClusteringAtZoom = def.clustering.disableClusteringAtZoom;\r\n                }\r\n            }\r\n\r\n            if (def.search && typeof def.search === 'object') {\r\n                normalizedDef.search = def.search;\r\n            }\r\n\r\n            if (def.table && typeof def.table === 'object') {\r\n                normalizedDef.table = def.table;\r\n            }\r\n\r\n            const layerId = def.id || (\"geojson-layer-\" + (state.layerIdCounter++));\r\n            const layerLabel = def.label || layerId;\r\n\r\n            Log.debug(\"[GeoLeaf.GeoJSON] Chargement couche GeoJSON :\", {\r\n                profileId: profile.id || \"(inconnu)\",\r\n                layerId: layerId,\r\n                url: layerUrl\r\n            });\r\n\r\n            try {\r\n                return await GeoLeaf._GeoJSONLoader._loadSingleLayer(layerId, layerLabel, normalizedDef, baseOptions);\r\n            } catch (err) {\r\n                Log.error(\"[GeoLeaf.GeoJSON] √âchec chargement couche :\", {\r\n                    layerId: layerId,\r\n                    url: layerUrl,\r\n                    error: err\r\n                });\r\n                return null;\r\n            }\r\n        });\r\n\r\n        return this._loadLayersByBatch(tasks, batchSize, batchDelay).then((layers) => {\r\n            const loadedLayers = layers.filter(Boolean);\r\n\r\n            Log.info(\"[GeoLeaf.GeoJSON] \" + loadedLayers.length + \" couche(s) GeoJSON charg√©e(s)\");\r\n            Log.info(`[GeoLeaf.GeoJSON] Avant v√©rif LayerManager - loadedLayers: ${loadedLayers.length}, _GeoJSONLayerManager existe: ${!!GeoLeaf._GeoJSONLayerManager}`);\r\n\r\n            // Int√©gration avec LayerManager si disponible\r\n            if (loadedLayers.length > 0 && GeoLeaf._GeoJSONLayerManager) {\r\n                GeoLeaf._GeoJSONLayerManager.registerWithLayerManager();\r\n            }\r\n\r\n            // Fit bounds sur l'ensemble des couches si demand√©\r\n            if (baseOptions.fitBoundsOnLoad !== false && state.map && state.layerGroup) {\r\n                const bounds = state.layerGroup.getBounds();\r\n                if (bounds.isValid()) {\r\n                    const fitOptions = {};\r\n                    if (typeof baseOptions.maxZoomOnFit === \"number\") {\r\n                        fitOptions.maxZoom = baseOptions.maxZoomOnFit;\r\n                    }\r\n                    state.map.fitBounds(bounds, fitOptions);\r\n                    Log.debug(\"[GeoLeaf.GeoJSON] Carte ajust√©e sur l'emprise des couches GeoJSON\");\r\n\r\n                    // √âmettre un √©v√©nement apr√®s le fitBounds\r\n                    const onMoveEnd = function() {\r\n                        state.map.off('moveend', onMoveEnd);\r\n                        try {\r\n                            const event = new CustomEvent('geoleaf:fitbounds:complete', { detail: { bounds: bounds } });\r\n                            document.dispatchEvent(event);\r\n                        } catch (e) {\r\n                            // fallback si CustomEvent n'est pas dispo\r\n                        }\r\n                    };\r\n                    state.map.on('moveend', onMoveEnd);\r\n                }\r\n            }\r\n\r\n            // √âv√©nement global\r\n            try {\r\n                state.map.fire(\"geoleaf:geojson:layers-loaded\", {\r\n                    count: loadedLayers.length,\r\n                    layers: loadedLayers.map(l => ({ id: l.id, label: l.label }))\r\n                });\r\n            } catch (e) {\r\n                // Silencieux\r\n            }\r\n\r\n            return loadedLayers;\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Ex√©cute un tableau de t√¢ches async par lots.\r\n     *\r\n     * @param {Array<Function>} tasks - Fonctions async √† ex√©cuter\r\n     * @param {number} [batchSize=3] - Taille des lots\r\n     * @param {number} [delayMs=200] - D√©lai entre les lots (non utilis√© actuellement)\r\n     * @returns {Promise<Array>}\r\n     * @private\r\n     */\r\n    GeoLeaf._GeoJSONLoader._loadLayersByBatch = async function (tasks, batchSize = 3, delayMs = 200) {\r\n        const results = [];\r\n\r\n        for (let i = 0; i < tasks.length; i += batchSize) {\r\n            const batch = tasks.slice(i, i + batchSize);\r\n            const batchStart = Date.now();\r\n            const batchResults = await Promise.all(batch.map(fn => fn()));\r\n            results.push(...batchResults);\r\n\r\n            const batchDuration = Date.now() - batchStart;\r\n            const Log = getLog();\r\n            Log.info(`[GeoLeaf.GeoJSON] Lot ${Math.floor(i / batchSize) + 1}/${Math.ceil(tasks.length / batchSize)} charg√© en ${batchDuration} ms`);\r\n        }\r\n\r\n        return results;\r\n    };\r\n\r\n    /**\r\n     * Pr√©pare les configurations de TOUTES les couches pour le LayerManager.\r\n     * Utilise les configs d√©j√† charg√©es par ProfileV3Loader et y ajoute les layerManagerId.\r\n     *\r\n     * @param {Object} profile - Profil actif enrichi par ProfileV3Loader\r\n     * @returns {Promise<Array>} - Promise r√©solvant en array des infos de couches\r\n     */\r\n    GeoLeaf._GeoJSONLoader.loadAllLayersConfigsForLayerManager = async function(profile) {\r\n        const Log = getLog();\r\n\r\n        if (!profile || !profile.layers || !Array.isArray(profile.layers)) {\r\n            Log.warn(\"[GeoLeaf.GeoJSON] loadAllLayersConfigsForLayerManager: Pas de couches dans le profil\");\r\n            return [];\r\n        }\r\n\r\n        Log.info(`[GeoLeaf.GeoJSON] Pr√©paration de ${profile.layers.length} configurations de couches pour LayerManager...`);\r\n\r\n        // Les configs sont d√©j√† charg√©es par ProfileV3Loader, il suffit d'enrichir avec layerManagerId\r\n        const allConfigs = profile.layers.map(layer => {\r\n            let styles = null;\r\n            let labels = null;\r\n            if (layer.config && layer.config.styles) {\r\n                styles = layer.config.styles;\r\n            } else if (layer.styles) {\r\n                styles = layer.styles;\r\n            }\r\n            if (layer.config && layer.config.labels) {\r\n                labels = layer.config.labels;\r\n            } else if (layer.labels) {\r\n                labels = layer.labels;\r\n            }\r\n            return {\r\n                id: layer.id,\r\n                label: layer.label,\r\n                layerManagerId: layer.layerManagerId || \"geojson-default\",\r\n                configFile: layer.configFile,\r\n                zIndex: (layer.config && layer.config.zIndex) || 0,\r\n                themes: (layer.config && layer.config.themes) || null,\r\n                styles: styles,\r\n                labels: labels\r\n            };\r\n        });\r\n\r\n        Log.info(`[GeoLeaf.GeoJSON] ${allConfigs.length} configurations pr√™tes pour LayerManager`);\r\n\r\n        // Stocker les configs pour utilisation par LayerManager\r\n        GeoLeaf._allLayerConfigs = allConfigs;\r\n\r\n        return allConfigs;\r\n    };\r\n\r\n})(window);\r\n","/**\r\n * GeoLeaf GeoJSON Module - Aggregator\r\n * Module principal qui d√©l√®gue aux sous-modules sp√©cialis√©s\r\n *\r\n * Architecture Phase 3.5:\r\n * - geojson/shared.js        : √âtat partag√©, constantes, STYLE_OPERATORS\r\n * - geojson/style-resolver.js: √âvaluation styleRules, buildLeafletOptions\r\n * - geojson/layer-manager.js : Gestion couches (show/hide/toggle/remove)\r\n * - geojson/loader.js        : Chargement (loadUrl, loadFromActiveProfile)\r\n * - geojson/popup-tooltip.js : Popups et tooltips unifi√©s\r\n * - geojson/clustering.js    : Strat√©gies de clustering\r\n *\r\n * @module geoleaf.geojson\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    const Log = GeoLeaf.Log || console;\r\n\r\n    // ========================================\r\n    //   GETTERS LAZY POUR SOUS-MODULES\r\n    // ========================================\r\n\r\n    const getShared = () => GeoLeaf._GeoJSONShared;\r\n    const getState = () => GeoLeaf._GeoJSONShared && GeoLeaf._GeoJSONShared.state;\r\n    const getStyleResolver = () => GeoLeaf._GeoJSONStyleResolver;\r\n    const getLayerManager = () => GeoLeaf._GeoJSONLayerManager;\r\n    const getLoader = () => GeoLeaf._GeoJSONLoader;\r\n    const getPopupTooltip = () => GeoLeaf._GeoJSONPopupTooltip;\r\n    const getClustering = () => GeoLeaf._GeoJSONClustering;\r\n\r\n    // ========================================\r\n    //   MODULE GEOJSON (AGR√âGATEUR)\r\n    // ========================================\r\n\r\n    const GeoJSONModule = {\r\n        /**\r\n         * Getters pour acc√®s direct √† l'√©tat (compatibilit√©)\r\n         */\r\n        get _map() { return getState() ? getState().map : null; },\r\n        get _layerGroup() { return getState() ? getState().layerGroup : null; },\r\n        get _geoJsonLayer() { return getState() ? getState().geoJsonLayer : null; },\r\n        get _layers() { return getState() ? getState().layers : new Map(); },\r\n        get _featureCache() { return getState() ? getState().featureCache : new Map(); },\r\n        get _options() { return getState() ? getState().options : {}; },\r\n\r\n        /**\r\n         * Valide les options pass√©es √† init()\r\n         * @param {Object} options\r\n         * @private\r\n         */\r\n        _validateOptions(options) {\r\n            if (options.map && typeof options.map.addLayer !== 'function') {\r\n                Log.warn(\"[GeoLeaf.GeoJSON] options.map ne semble pas √™tre une carte Leaflet valide.\");\r\n            }\r\n\r\n            if (options.defaultStyle && typeof options.defaultStyle !== 'object') {\r\n                Log.warn(\"[GeoLeaf.GeoJSON] options.defaultStyle doit √™tre un objet.\");\r\n                delete options.defaultStyle;\r\n            }\r\n\r\n            if (options.onEachFeature && typeof options.onEachFeature !== 'function') {\r\n                Log.warn(\"[GeoLeaf.GeoJSON] options.onEachFeature doit √™tre une fonction.\");\r\n                delete options.onEachFeature;\r\n            }\r\n\r\n            if (options.pointToLayer && typeof options.pointToLayer !== 'function') {\r\n                Log.warn(\"[GeoLeaf.GeoJSON] options.pointToLayer doit √™tre une fonction.\");\r\n                delete options.pointToLayer;\r\n            }\r\n\r\n            if (options.maxZoomOnFit !== undefined &&\r\n                (typeof options.maxZoomOnFit !== 'number' || options.maxZoomOnFit < 1 || options.maxZoomOnFit > 20)) {\r\n                Log.warn(\"[GeoLeaf.GeoJSON] options.maxZoomOnFit doit √™tre un nombre entre 1 et 20.\");\r\n                options.maxZoomOnFit = GeoLeaf.CONSTANTS ? GeoLeaf.CONSTANTS.GEOJSON_MAX_ZOOM_ON_FIT : 18;\r\n            }\r\n\r\n            return options;\r\n        },\r\n\r\n        /**\r\n         * Initialise le module GeoJSON.\r\n         *\r\n         * @param {Object} options\r\n         * @param {L.Map} [options.map] - Carte Leaflet. Si absent, tentative via GeoLeaf.Core.getMap().\r\n         * @param {Object} [options.defaultStyle]\r\n         * @param {Object} [options.defaultPointStyle]\r\n         * @param {Function} [options.onEachFeature]\r\n         * @param {Function} [options.pointToLayer]\r\n         * @param {boolean} [options.fitBoundsOnLoad]\r\n         * @param {number} [options.maxZoomOnFit]\r\n         * @returns {L.GeoJSON|null} - La couche GeoJSON ou null si √©chec.\r\n         */\r\n        init(options = {}) {\r\n            const state = getState();\r\n            if (!state) {\r\n                Log.error(\"[GeoLeaf.GeoJSON] Module shared.js non charg√©.\");\r\n                return null;\r\n            }\r\n\r\n            // Validation\r\n            options = this._validateOptions(options);\r\n\r\n            if (typeof global.L === \"undefined\" || !global.L || typeof global.L.geoJSON !== \"function\") {\r\n                Log.error(\"[GeoLeaf.GeoJSON] Leaflet (L) est requis mais introuvable.\");\r\n                return null;\r\n            }\r\n\r\n            // Utiliser l'helper partag√©\r\n            const map = GeoLeaf.Utils ? GeoLeaf.Utils.ensureMap(options.map) : (options.map || null);\r\n\r\n            if (!map) {\r\n                Log.error(\r\n                    \"[GeoLeaf.GeoJSON] Aucune carte Leaflet disponible. Passe une instance de carte dans init({ map }).\"\r\n                );\r\n                return null;\r\n            }\r\n\r\n            state.map = map;\r\n\r\n            // Fusionner les options\r\n            state.options = GeoLeaf.Utils && GeoLeaf.Utils.mergeOptions\r\n                ? GeoLeaf.Utils.mergeOptions(state.options, options)\r\n                : Object.assign({}, state.options, options);\r\n\r\n            // Cr√©er les panes pour contr√¥ler le z-index des couches\r\n            const PaneConfig = getShared().PANE_CONFIG;\r\n            const PaneHelpers = getShared().PaneHelpers;\r\n\r\n            // Basemap: z-index 200 (toujours en dessous)\r\n            const basemapPane = state.map.createPane(PaneConfig.BASEMAP_NAME);\r\n            basemapPane.style.zIndex = PaneConfig.BASEMAP_ZINDEX;\r\n\r\n            // Couches GeoJSON/WMS: z-index 400-499 (0-99 dans config)\r\n            for (let i = PaneConfig.MIN_LAYER_ZINDEX; i <= PaneConfig.MAX_LAYER_ZINDEX; i++) {\r\n                const pane = state.map.createPane(PaneHelpers.getPaneName(i));\r\n                pane.style.zIndex = PaneConfig.LAYER_BASE_ZINDEX + i;\r\n            }\r\n\r\n            Log.info(`[GeoLeaf.GeoJSON] Panes cr√©√©s : ${PaneConfig.BASEMAP_NAME} (z:${PaneConfig.BASEMAP_ZINDEX}), ${PaneConfig.LAYER_PREFIX}0 √† ${PaneConfig.LAYER_PREFIX}${PaneConfig.MAX_LAYER_ZINDEX} (z:${PaneConfig.LAYER_BASE_ZINDEX}-${PaneConfig.LAYER_BASE_ZINDEX + PaneConfig.MAX_LAYER_ZINDEX})`);\r\n\r\n            // Cr√©er un groupe pour encapsuler TOUTES les couches GeoJSON\r\n            state.layerGroup = global.L.featureGroup().addTo(state.map);\r\n\r\n            // Initialiser la Map des couches\r\n            state.layers = new Map();\r\n\r\n            // Ajouter un √©couteur pour g√©rer les seuils de zoom\r\n            const LayerManager = getLayerManager();\r\n            if (LayerManager) {\r\n                state.map.on('zoomend', () => {\r\n                    LayerManager.updateLayerVisibilityByZoom();\r\n                });\r\n            }\r\n\r\n            // LEGACY: Cr√©er la couche GeoJSON vide (pour compatibilit√©)\r\n            const StyleResolver = getStyleResolver();\r\n            const leafletOptions = StyleResolver\r\n                ? StyleResolver.buildLeafletOptions(state.options)\r\n                : {};\r\n\r\n            state.geoJsonLayer = global.L.geoJSON(null, leafletOptions);\r\n            state.geoJsonLayer.addTo(state.layerGroup);\r\n\r\n            Log.info(\"[GeoLeaf.GeoJSON] Module initialis√© en mode multi-couches\");\r\n\r\n            return state.geoJsonLayer;\r\n        },\r\n\r\n        /**\r\n         * Retourne la couche GeoJSON principale (LEGACY).\r\n         * @returns {L.GeoJSON|null}\r\n         */\r\n        getLayer() {\r\n            const state = getState();\r\n            return state ? state.geoJsonLayer : null;\r\n        },\r\n\r\n        // ========================================\r\n        //   D√âL√âGATION VERS LAYER MANAGER\r\n        // ========================================\r\n\r\n        getLayerById(layerId) {\r\n            const LayerManager = getLayerManager();\r\n            return LayerManager ? LayerManager.getLayerById(layerId) : null;\r\n        },\r\n\r\n        getLayerData(layerId) {\r\n            const LayerManager = getLayerManager();\r\n            return LayerManager ? LayerManager.getLayerData(layerId) : null;\r\n        },\r\n\r\n        getAllLayers() {\r\n            const LayerManager = getLayerManager();\r\n            return LayerManager ? LayerManager.getAllLayers() : [];\r\n        },\r\n\r\n        showLayer(layerId) {\r\n            const LayerManager = getLayerManager();\r\n            if (LayerManager) LayerManager.showLayer(layerId);\r\n        },\r\n\r\n        hideLayer(layerId) {\r\n            const LayerManager = getLayerManager();\r\n            if (LayerManager) LayerManager.hideLayer(layerId);\r\n        },\r\n\r\n        toggleLayer(layerId) {\r\n            const LayerManager = getLayerManager();\r\n            if (LayerManager) LayerManager.toggleLayer(layerId);\r\n        },\r\n\r\n        removeLayer(layerId) {\r\n            const LayerManager = getLayerManager();\r\n            if (LayerManager) LayerManager.removeLayer(layerId);\r\n        },\r\n\r\n        updateLayerZIndex(layerId, newZIndex) {\r\n            const LayerManager = getLayerManager();\r\n            return LayerManager ? LayerManager.updateLayerZIndex(layerId, newZIndex) : false;\r\n        },\r\n\r\n        setLayerStyle(layerId, styleConfig) {\r\n            const LayerManager = getLayerManager();\r\n            return LayerManager ? LayerManager.setLayerStyle(layerId, styleConfig) : false;\r\n        },\r\n\r\n        // ========================================\r\n        //   D√âL√âGATION VERS LOADER\r\n        // ========================================\r\n\r\n        loadUrl(url, options = {}) {\r\n            const Loader = getLoader();\r\n            return Loader ? Loader.loadUrl(url, options) : Promise.resolve(null);\r\n        },\r\n\r\n        addData(geojsonData, options = {}) {\r\n            const Loader = getLoader();\r\n            if (Loader) Loader.addData(geojsonData, options);\r\n        },\r\n\r\n        loadFromActiveProfile(options = {}) {\r\n            const Loader = getLoader();\r\n            return Loader ? Loader.loadFromActiveProfile(options) : Promise.resolve([]);\r\n        },\r\n\r\n        // ========================================\r\n        //   FILTRAGE DES FEATURES\r\n        // ========================================\r\n\r\n        /**\r\n         * Filtre les features de toutes les couches GeoJSON.\r\n         * Montre uniquement les features qui passent le pr√©dicat.\r\n         *\r\n         * @param {Function} filterFn - Fonction (feature, layerId) => boolean\r\n         * @param {Object} [options] - Options suppl√©mentaires\r\n         * @returns {Object} - { filtered: number, total: number, visible: number }\r\n         */\r\n        filterFeatures(filterFn, options = {}) {\r\n            const state = getState();\r\n            if (typeof filterFn !== 'function') {\r\n                Log.warn(\"[GeoLeaf.GeoJSON] filterFeatures: filterFn doit √™tre une fonction\");\r\n                return { filtered: 0, total: 0, visible: 0 };\r\n            }\r\n\r\n            const stats = { filtered: 0, total: 0, visible: 0 };\r\n\r\n            // D√©terminer les couches √† filtrer\r\n            let layerIds = [];\r\n            if (options.layerIds) {\r\n                layerIds = Array.isArray(options.layerIds) ? options.layerIds : [options.layerIds];\r\n            } else {\r\n                layerIds = Array.from(state.layers.keys());\r\n            }\r\n\r\n            // Filtrer par type de g√©om√©trie si sp√©cifi√© (avec aliases)\r\n            if (options.geometryType) {\r\n                const geoType = options.geometryType.toLowerCase();\r\n                const typeAliases = {\r\n                    'poi': 'point',\r\n                    'route': 'line',\r\n                    'linestring': 'line',\r\n                    'area': 'polygon'\r\n                };\r\n                const normalizedType = typeAliases[geoType] || geoType;\r\n\r\n                layerIds = layerIds.filter(id => {\r\n                    const data = state.layers.get(id);\r\n                    if (!data) return false;\r\n                    const layerGeoType = (data.geometryType || '').toLowerCase();\r\n                    const normalizedLayerType = typeAliases[layerGeoType] || layerGeoType;\r\n                    return normalizedLayerType === normalizedType;\r\n                });\r\n            }\r\n\r\n            layerIds.forEach(layerId => {\r\n                const layerData = state.layers.get(layerId);\r\n                if (!layerData || !layerData.layer) return;\r\n\r\n                // Si search.enabled === false, la couche n'est pas concern√©e par le filtrage\r\n                const bypassFilter = layerData.config?.search?.enabled === false;\r\n\r\n                // Initialiser le Set des layers filtr√©es si pas encore fait\r\n                if (!layerData._filteredOutLayers) {\r\n                    layerData._filteredOutLayers = new Set();\r\n                }\r\n\r\n                const toShow = [];\r\n                const toHide = [];\r\n\r\n                // It√©rer sur chaque feature\r\n                layerData.layer.eachLayer(leafletLayer => {\r\n                    if (!leafletLayer.feature) return;\r\n\r\n                    stats.total++;\r\n\r\n                    const shouldShow = bypassFilter || filterFn(leafletLayer.feature, layerId);\r\n\r\n                    if (shouldShow) {\r\n                        toShow.push(leafletLayer);\r\n                        stats.visible++;\r\n                    } else {\r\n                        toHide.push(leafletLayer);\r\n                        stats.filtered++;\r\n                    }\r\n                });\r\n\r\n                // Appliquer les changements de visibilit√©\r\n                const clusterGroup = layerData.clusterGroup;\r\n\r\n                toHide.forEach(leafletLayer => {\r\n                    leafletLayer._geoleafFiltered = true;\r\n\r\n                    if (clusterGroup) {\r\n                        if (!layerData._filteredOutLayers.has(leafletLayer)) {\r\n                            clusterGroup.removeLayer(leafletLayer);\r\n                            layerData._filteredOutLayers.add(leafletLayer);\r\n                        }\r\n                    } else {\r\n                        if (leafletLayer.getElement) {\r\n                            const layerElement = leafletLayer.getElement();\r\n                            if (layerElement) layerElement.style.display = 'none';\r\n                        } else if (leafletLayer.setStyle) {\r\n                            if (leafletLayer.options._originalOpacity === undefined) {\r\n                                leafletLayer.options._originalOpacity = leafletLayer.options.opacity;\r\n                                leafletLayer.options._originalFillOpacity = leafletLayer.options.fillOpacity;\r\n                            }\r\n                            leafletLayer.setStyle({ opacity: 0, fillOpacity: 0 });\r\n                        }\r\n                    }\r\n                });\r\n\r\n                toShow.forEach(leafletLayer => {\r\n                    leafletLayer._geoleafFiltered = false;\r\n\r\n                    if (clusterGroup) {\r\n                        if (layerData._filteredOutLayers.has(leafletLayer)) {\r\n                            clusterGroup.addLayer(leafletLayer);\r\n                            layerData._filteredOutLayers.delete(leafletLayer);\r\n                        }\r\n                    } else {\r\n                        if (leafletLayer.getElement) {\r\n                            const layerElement = leafletLayer.getElement();\r\n                            if (layerElement) layerElement.style.display = '';\r\n                        } else if (leafletLayer.setStyle) {\r\n                            leafletLayer.setStyle({\r\n                                opacity: leafletLayer.options._originalOpacity !== undefined\r\n                                    ? leafletLayer.options._originalOpacity : 1,\r\n                                fillOpacity: leafletLayer.options._originalFillOpacity !== undefined\r\n                                    ? leafletLayer.options._originalFillOpacity : 0.4\r\n                            });\r\n                        }\r\n                    }\r\n                });\r\n            });\r\n\r\n            Log.debug(`[GeoLeaf.GeoJSON] filterFeatures: ${stats.visible}/${stats.total} features visibles`);\r\n            return stats;\r\n        },\r\n\r\n        /**\r\n         * R√©initialise le filtre sur les features (montre tout).\r\n         *\r\n         * @param {Object} [options] - M√™mes options que filterFeatures\r\n         */\r\n        clearFeatureFilter(options = {}) {\r\n            return this.filterFeatures(() => true, options);\r\n        },\r\n\r\n        /**\r\n         * Retourne toutes les features charg√©es.\r\n         * @param {Object} [options]\r\n         * @returns {Array<Object>} features GeoJSON enrichies de { _layerId }\r\n         */\r\n        getFeatures(options = {}) {\r\n            const state = getState();\r\n            if (!state) return [];\r\n\r\n            const geometrySet = Array.isArray(options.geometryTypes)\r\n                ? new Set(options.geometryTypes.map(t => t.toLowerCase()))\r\n                : null;\r\n            const layerSet = Array.isArray(options.layerIds) ? new Set(options.layerIds) : null;\r\n\r\n            const result = [];\r\n            state.featureCache.forEach((entry, layerId) => {\r\n                if (layerSet && !layerSet.has(layerId)) return;\r\n                const geoType = (entry.geometryType || \"\").toLowerCase();\r\n                if (geometrySet && !geometrySet.has(geoType)) return;\r\n\r\n                (entry.features || []).forEach((f) => {\r\n                    if (f && typeof f === \"object\") {\r\n                        const clone = Object.assign({}, f, { _layerId: layerId });\r\n                        result.push(clone);\r\n                    }\r\n                });\r\n            });\r\n            return result;\r\n        },\r\n\r\n        /**\r\n         * Supprime toutes les entit√©s GeoJSON de la couche legacy.\r\n         */\r\n        clear() {\r\n            const state = getState();\r\n            if (state && state.geoJsonLayer) {\r\n                state.geoJsonLayer.clearLayers();\r\n            }\r\n        },\r\n\r\n        // ========================================\r\n        //   M√âTHODES INTERNES EXPOS√âES\r\n        // ========================================\r\n\r\n        _updateLayerVisibilityByZoom() {\r\n            const LayerManager = getLayerManager();\r\n            if (LayerManager) LayerManager.updateLayerVisibilityByZoom();\r\n        },\r\n\r\n        _registerWithLayerManager() {\r\n            const LayerManager = getLayerManager();\r\n            if (LayerManager) LayerManager.registerWithLayerManager();\r\n        },\r\n\r\n        _convertFeatureToPOI(feature, def) {\r\n            const PopupTooltip = getPopupTooltip();\r\n            return PopupTooltip ? PopupTooltip.convertFeatureToPOI(feature, def) : null;\r\n        },\r\n\r\n        _getClusteringStrategy(def, geojsonData) {\r\n            const Clustering = getClustering();\r\n            return Clustering\r\n                ? Clustering.getClusteringStrategy(def, geojsonData)\r\n                : { shouldCluster: false, useSharedCluster: false };\r\n        },\r\n\r\n        _getSharedPOICluster() {\r\n            const Clustering = getClustering();\r\n            return Clustering ? Clustering.getSharedPOICluster() : null;\r\n        },\r\n\r\n        _getPoiConfig() {\r\n            const Clustering = getClustering();\r\n            return Clustering ? Clustering.getPoiConfig() : {};\r\n        },\r\n\r\n        _detectLayerType(layer) {\r\n            const LayerManager = getLayerManager();\r\n            return LayerManager ? LayerManager.detectLayerType(layer) : \"mixed\";\r\n        },\r\n\r\n        _buildLeafletOptions(options) {\r\n            const StyleResolver = getStyleResolver();\r\n            return StyleResolver ? StyleResolver.buildLeafletOptions(options) : {};\r\n        }\r\n    };\r\n\r\n    // Exposer _StyleRules pour compatibilit√© avec le module Themes\r\n    // (d√©j√† fait dans style-resolver.js, mais on s'assure que c'est accessible)\r\n    if (!GeoLeaf._StyleRules && getStyleResolver()) {\r\n        GeoLeaf._StyleRules = {\r\n            evaluate: getStyleResolver().evaluateStyleRules,\r\n            operators: getShared() ? getShared().STYLE_OPERATORS : {},\r\n            getNestedValue: getStyleResolver().getNestedValue\r\n        };\r\n    }\r\n\r\n    // Expose le module dans l'espace de nom GeoLeaf\r\n    GeoLeaf.GeoJSON = GeoJSONModule;\r\n\r\n})(window);\r\n","/**\r\n * GeoLeaf Route Style Resolver Module\r\n * R√©solution des styles d'itin√©raires (couleurs, endpoints)\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    GeoLeaf._RouteStyleResolver = GeoLeaf._RouteStyleResolver || {};\r\n\r\n    const Log = GeoLeaf.Log || console;\r\n\r\n    /**\r\n     * D√©termine la couleur d'un itin√©raire selon la priorit√© :\r\n     *  1. colorRoute de la sous-cat√©gorie (si d√©finie)\r\n     *  2. colorRoute de la cat√©gorie (si d√©finie)\r\n     *  3. couleur par d√©faut de routeConfig.default.color\r\n     *\r\n     * @param {Object} route - L'itin√©raire\r\n     * @param {Object} profile - Le profil actif\r\n     * @param {Object} routeConfigDefault - La config par d√©faut (defaultSettings.routeConfig.default)\r\n     * @returns {string|null} La couleur √† utiliser ou null\r\n     */\r\n    GeoLeaf._RouteStyleResolver.getRouteColor = function (route, profile, routeConfigDefault) {\r\n        if (!route || !route.attributes) {\r\n            return routeConfigDefault?.color || null;\r\n        }\r\n\r\n        const attrs = route.attributes;\r\n        const categoryId = attrs.categoryId;\r\n        const subCategoryId = attrs.subCategoryId;\r\n\r\n        // R√©cup√©rer la taxonomie du profil\r\n        const taxonomy = profile?.taxonomy?.categories || {};\r\n\r\n        // 1. V√©rifier colorRoute de la sous-cat√©gorie\r\n        if (categoryId && subCategoryId) {\r\n            const category = taxonomy[categoryId];\r\n            if (category && category.subcategories) {\r\n                const subCategory = category.subcategories[subCategoryId];\r\n                if (subCategory && subCategory.colorRoute) {\r\n                    return subCategory.colorRoute;\r\n                }\r\n            }\r\n        }\r\n\r\n        // 2. V√©rifier colorRoute de la cat√©gorie\r\n        if (categoryId) {\r\n            const category = taxonomy[categoryId];\r\n            if (category && category.colorRoute) {\r\n                return category.colorRoute;\r\n            }\r\n        }\r\n\r\n        // 3. Couleur par d√©faut\r\n        return routeConfigDefault?.color || null;\r\n    };\r\n\r\n    /**\r\n     * Calcule le style final d'un itin√©raire en combinant :\r\n     *  - le style par d√©faut du module,\r\n     *  - la config par d√©faut du profil (defaultSettings.routeConfig.default),\r\n     *  - la couleur bas√©e sur la taxonomie (colorRoute),\r\n     *  - les surcharges au niveau de l'itin√©raire (properties.*).\r\n     *\r\n     * @param {Object} route - L'itin√©raire\r\n     * @param {Object} activeProfile - Le profil actif\r\n     * @param {Object} routeConfigDefault - Config par d√©faut du profil\r\n     * @param {Object} defaultStyle - Style par d√©faut du module\r\n     * @returns {Object} Style final r√©solu\r\n     */\r\n    GeoLeaf._RouteStyleResolver.resolveRouteStyle = function (route, activeProfile, routeConfigDefault, defaultStyle) {\r\n        const finalStyle = Object.assign({}, defaultStyle || {});\r\n\r\n        // 1) Appliquer le style par d√©faut du profil (routeConfig.default)\r\n        if (routeConfigDefault && typeof routeConfigDefault === \"object\") {\r\n            Object.assign(finalStyle, routeConfigDefault);\r\n        }\r\n\r\n        // 2) Couleur bas√©e sur la taxonomie (subcategory > category > default)\r\n        const taxonomyColor = GeoLeaf._RouteStyleResolver.getRouteColor(route, activeProfile, routeConfigDefault);\r\n        if (taxonomyColor) {\r\n            finalStyle.color = taxonomyColor;\r\n        }\r\n\r\n        // 3) Surcharges au niveau de la route (properties.*)\r\n        if (route.properties && typeof route.properties === \"object\") {\r\n            const p = route.properties;\r\n\r\n            if (typeof p.color === \"string\" && p.color.trim() !== \"\") {\r\n                finalStyle.color = p.color.trim();\r\n            }\r\n            if (typeof p.weight === \"number\") {\r\n                finalStyle.weight = p.weight;\r\n            }\r\n            if (typeof p.opacity === \"number\") {\r\n                finalStyle.opacity = p.opacity;\r\n            }\r\n            if (typeof p.dashArray === \"string\" && p.dashArray.trim() !== \"\") {\r\n                finalStyle.dashArray = p.dashArray.trim();\r\n            }\r\n        }\r\n\r\n        return finalStyle;\r\n    };\r\n\r\n    /**\r\n     * Calcule la configuration d'affichage des points d√©part / arriv√©e\r\n     * en combinant :\r\n     *  - les options par d√©faut du module (_options),\r\n     *  - les endpoints d√©finis dans le profil actif (defaultSettings.routeConfig.endpoints),\r\n     *  - les surcharges √©ventuelles au niveau de l'itin√©raire\r\n     *    (properties.showStart, properties.showEnd, startStyle, endStyle).\r\n     *\r\n     * @param {Object} route - L'itin√©raire\r\n     * @param {Object} profileEndpoints - Config endpoints du profil\r\n     * @param {Object} moduleOptions - Options du module Route\r\n     * @returns {Object} Configuration des endpoints {showStart, showEnd, startStyle, endStyle}\r\n     */\r\n    GeoLeaf._RouteStyleResolver.resolveEndpointConfig = function (route, profileEndpoints, moduleOptions) {\r\n        const opt = moduleOptions || {};\r\n\r\n        const baseStartStyle =\r\n            opt.startWaypointStyle || opt.waypointStyle || {\r\n                radius: 6,\r\n                color: \"#ffffff\",\r\n                fillColor: \"#2b7cff\",\r\n                fillOpacity: 1,\r\n                weight: 2\r\n            };\r\n\r\n        const baseEndStyle =\r\n            opt.endWaypointStyle || opt.waypointStyle || {\r\n                radius: 6,\r\n                color: \"#ffffff\",\r\n                fillColor: \"#ff7b32\",\r\n                fillOpacity: 1,\r\n                weight: 2\r\n            };\r\n\r\n        const cfg = {\r\n            showStart: typeof opt.showStart === \"boolean\" ? opt.showStart : true,\r\n            showEnd: typeof opt.showEnd === \"boolean\" ? opt.showEnd : true,\r\n            startStyle: Object.assign({}, baseStartStyle),\r\n            endStyle: Object.assign({}, baseEndStyle)\r\n        };\r\n\r\n        // 1) Profil actif (defaultSettings.routeConfig.endpoints)\r\n        if (profileEndpoints && typeof profileEndpoints === \"object\") {\r\n            if (typeof profileEndpoints.showStart === \"boolean\") {\r\n                cfg.showStart = profileEndpoints.showStart;\r\n            }\r\n            if (typeof profileEndpoints.showEnd === \"boolean\") {\r\n                cfg.showEnd = profileEndpoints.showEnd;\r\n            }\r\n            if (\r\n                profileEndpoints.start &&\r\n                typeof profileEndpoints.start === \"object\"\r\n            ) {\r\n                Object.assign(cfg.startStyle, profileEndpoints.start);\r\n            }\r\n            if (profileEndpoints.end && typeof profileEndpoints.end === \"object\") {\r\n                Object.assign(cfg.endStyle, profileEndpoints.end);\r\n            }\r\n        }\r\n\r\n        // 2) Surcharges au niveau de l'itin√©raire\r\n        if (route && route.properties && typeof route.properties === \"object\") {\r\n            const p = route.properties;\r\n\r\n            if (typeof p.showStart === \"boolean\") {\r\n                cfg.showStart = p.showStart;\r\n            }\r\n            if (typeof p.showEnd === \"boolean\") {\r\n                cfg.showEnd = p.showEnd;\r\n            }\r\n            if (p.startStyle && typeof p.startStyle === \"object\") {\r\n                Object.assign(cfg.startStyle, p.startStyle);\r\n            }\r\n            if (p.endStyle && typeof p.endStyle === \"object\") {\r\n                Object.assign(cfg.endStyle, p.endStyle);\r\n            }\r\n        }\r\n\r\n        return cfg;\r\n    };\r\n\r\n    Log.info(\"[GeoLeaf._RouteStyleResolver] Module Style Resolver charg√©\");\r\n\r\n})(window);\r\n","/**\r\n * GeoLeaf Route Popup Builder Module\r\n * Construction des popups/tooltips et panneau lat√©ral pour les itin√©raires.\r\n * D√©l√®gue le rendu au module _ContentBuilder centralis√©.\r\n *\r\n * @module route/popup-builder\r\n * @version 2.0.0\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    GeoLeaf._RoutePopupBuilder = GeoLeaf._RoutePopupBuilder || {};\r\n\r\n    const Log = GeoLeaf.Log || console;\r\n\r\n    // ========================================\r\n    //   UTILITAIRES\r\n    // ========================================\r\n\r\n    /**\r\n     * R√©cup√®re le ContentBuilder\r\n     * @returns {Object|null}\r\n     */\r\n    function getContentBuilder() {\r\n        return GeoLeaf._ContentBuilder || null;\r\n    }\r\n\r\n    /**\r\n     * R√©cup√®re le Normalizer\r\n     * @returns {Object|null}\r\n     */\r\n    function getNormalizer() {\r\n        return GeoLeaf._Normalizer || null;\r\n    }\r\n\r\n    /**\r\n     * √âchappe le HTML\r\n     * @param {string} str - Cha√Æne √† √©chapper\r\n     * @returns {string}\r\n     */\r\n    function escapeHtml(str) {\r\n        if (GeoLeaf.Security && typeof GeoLeaf.Security.escapeHtml === 'function') {\r\n            return GeoLeaf.Security.escapeHtml(str);\r\n        }\r\n        if (str == null) return '';\r\n        const div = document.createElement('div');\r\n        div.textContent = String(str);\r\n        return div.innerHTML;\r\n    }\r\n\r\n    /**\r\n     * Convertit une route en POI normalis√©\r\n     * @param {Object} route - Donn√©es de la route\r\n     * @returns {Object} POI normalis√©\r\n     */\r\n    function convertRouteToPOI(route) {\r\n        const Normalizer = getNormalizer();\r\n        if (Normalizer && typeof Normalizer.normalizeFromRoute === 'function') {\r\n            return Normalizer.normalizeFromRoute(route);\r\n        }\r\n\r\n        // Fallback: conversion manuelle\r\n        const attrs = route.attributes || {};\r\n        return {\r\n            id: route.id,\r\n            sourceType: 'route',\r\n            geometryType: 'LineString',\r\n            title: route.label || route.name || 'Itin√©raire',\r\n            description: attrs.description || route.description || '',\r\n            lat: null,\r\n            lng: null,\r\n            categoryId: attrs.categoryId || null,\r\n            subCategoryId: attrs.subCategoryId || null,\r\n            attributes: {\r\n                ...attrs,\r\n                label: route.label || route.name,\r\n                photo: attrs.photo,\r\n                distance_km: attrs.distance_km,\r\n                duration_min: attrs.duration_min,\r\n                difficulty: attrs.difficulty,\r\n                tags: attrs.tags\r\n            },\r\n            rawData: route\r\n        };\r\n    }\r\n\r\n    // ========================================\r\n    //   CONFIGURATION\r\n    // ========================================\r\n\r\n    /**\r\n     * R√©cup√®re la configuration de popup pour les routes\r\n     * @returns {Array|null}\r\n     */\r\n    function getRoutePopupConfig() {\r\n        const Config = GeoLeaf.Config;\r\n        if (Config && typeof Config.getActiveProfile === 'function') {\r\n            const profile = Config.getActiveProfile();\r\n            if (profile?.panels?.route?.popup?.detailPopup) {\r\n                return profile.panels.route.popup.detailPopup;\r\n            }\r\n        }\r\n        return null;\r\n    }\r\n\r\n    /**\r\n     * R√©cup√®re la configuration du layout pour le side panel des routes\r\n     * @returns {Array|null}\r\n     */\r\n    function getRouteLayoutConfig() {\r\n        const Config = GeoLeaf.Config;\r\n        if (Config && typeof Config.getActiveProfile === 'function') {\r\n            const profile = Config.getActiveProfile();\r\n            if (profile?.panels?.route?.layout) {\r\n                return profile.panels.route.layout;\r\n            }\r\n        }\r\n        return null;\r\n    }\r\n\r\n    // ========================================\r\n    //   TOOLTIP\r\n    // ========================================\r\n\r\n    /**\r\n     * Ajoute un tooltip √† une polyline d'itin√©raire\r\n     * @param {L.Polyline} polyline - Polyline Leaflet\r\n     * @param {Object} route - Donn√©es de l'itin√©raire\r\n     */\r\n    GeoLeaf._RoutePopupBuilder.addRouteTooltip = function (polyline, route) {\r\n        const label = route.label || route.name || 'Itin√©raire';\r\n\r\n        polyline.bindTooltip(escapeHtml(label), {\r\n            sticky: true,\r\n            className: 'gl-route-tooltip'\r\n        });\r\n    };\r\n\r\n    // ========================================\r\n    //   POPUP\r\n    // ========================================\r\n\r\n    /**\r\n     * Ajoute un popup √† une polyline d'itin√©raire\r\n     * @param {L.Polyline} polyline - Polyline Leaflet\r\n     * @param {Object} route - Donn√©es de l'itin√©raire\r\n     * @param {Object} routeModule - R√©f√©rence au module GeoLeaf.Route\r\n     */\r\n    GeoLeaf._RoutePopupBuilder.addRoutePopup = function (polyline, route, routeModule) {\r\n        const popupContent = GeoLeaf._RoutePopupBuilder.buildRoutePopupContent(route);\r\n        polyline.bindPopup(popupContent, { maxWidth: 300 });\r\n\r\n        // Attacher le handler pour le bouton \"Voir plus\"\r\n        polyline.on('popupopen', () => {\r\n            Log.info && Log.info('[Route Popup] Popup opened for route:', route.id);\r\n            setTimeout(() => {\r\n                const selector = '.gl-poi-popup__link[data-route-id=\"' + route.id + '\"]';\r\n                const linkEl = document.querySelector(selector);\r\n                if (linkEl) {\r\n                    linkEl.addEventListener('click', (e) => {\r\n                        e.preventDefault();\r\n                        GeoLeaf._RoutePopupBuilder.openRouteSidePanel(route);\r\n                    });\r\n                }\r\n            }, 50);\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Construit le contenu HTML d'un popup pour une route\r\n     * @param {Object} route - Donn√©es de l'itin√©raire\r\n     * @returns {string} Contenu HTML\r\n     */\r\n    GeoLeaf._RoutePopupBuilder.buildRoutePopupContent = function (route) {\r\n        const ContentBuilder = getContentBuilder();\r\n        const config = getRoutePopupConfig();\r\n        const routeAsPoi = convertRouteToPOI(route);\r\n\r\n        // Utiliser ContentBuilder si disponible et configur√©\r\n        if (ContentBuilder && typeof ContentBuilder.buildPopupHTML === 'function' && config) {\r\n            return ContentBuilder.buildPopupHTML(routeAsPoi, config, {\r\n                resolveCategoryDisplay: null\r\n            });\r\n        }\r\n\r\n        // Fallback: construction manuelle du popup\r\n        return buildFallbackRoutePopup(route);\r\n    };\r\n\r\n    /**\r\n     * Construit un popup de route par d√©faut (fallback)\r\n     * @param {Object} route - Donn√©es de l'itin√©raire\r\n     * @returns {string} HTML du popup\r\n     */\r\n    function buildFallbackRoutePopup(route) {\r\n        const attrs = route.attributes || {};\r\n        const label = escapeHtml(route.label || route.name || 'Itin√©raire');\r\n        const description = escapeHtml(attrs.description || route.description || '');\r\n        const photo = attrs.photo || route.photo || null;\r\n        const routeId = escapeHtml(String(route.id || ''));\r\n\r\n        // R√©solution des ic√¥nes depuis la taxonomie\r\n        const categoryId = attrs.categoryId || null;\r\n        const subCategoryId = attrs.subCategoryId || null;\r\n\r\n        const activeProfile = (GeoLeaf.Config && typeof GeoLeaf.Config.getActiveProfile === 'function')\r\n            ? (GeoLeaf.Config.getActiveProfile() || {})\r\n            : {};\r\n\r\n        const categories = activeProfile?.taxonomy?.categories || {};\r\n        const catData = categoryId ? categories[categoryId] : null;\r\n        const subCatData = (catData && subCategoryId) ? catData.subcategories?.[subCategoryId] : null;\r\n\r\n        const iconId = subCatData?.icon || catData?.icon || activeProfile?.icons?.defaultIcon || 'activity-generic';\r\n        const colorFill = subCatData?.colorFill || catData?.colorFill || '#666666';\r\n        const colorStroke = subCatData?.colorStroke || catData?.colorStroke || '#222222';\r\n\r\n        // Construction de l'ic√¥ne\r\n        let iconHtml = '';\r\n        if (iconId) {\r\n            const iconPrefix = activeProfile?.icons?.symbolPrefix || 'gl-poi-cat-';\r\n            const iconIdNormalized = String(iconId).trim().toLowerCase().replace(/\\s+/g, '-');\r\n            const symbolId = iconPrefix + iconIdNormalized;\r\n\r\n            iconHtml = '<svg class=\"gl-poi-popup__icon\" aria-hidden=\"true\" focusable=\"false\" viewBox=\"0 0 24 24\">' +\r\n                '<circle cx=\"12\" cy=\"12\" r=\"10\" fill=\"' + colorFill + '\" stroke=\"' + colorStroke + '\" stroke-width=\"1.5\"/>' +\r\n                '<svg x=\"4\" y=\"4\" width=\"16\" height=\"16\"><use href=\"#' + symbolId + '\" style=\"color: #ffffff\"/></svg>' +\r\n                '</svg>';\r\n        }\r\n\r\n        // M√©tadonn√©es (distance, dur√©e, difficult√©)\r\n        let metaText = '';\r\n        const metaItems = [];\r\n        if (attrs.distance_km) {\r\n            metaItems.push('üìè ' + attrs.distance_km + ' km');\r\n        }\r\n        if (attrs.duration_min) {\r\n            metaItems.push('‚è±Ô∏è ' + attrs.duration_min + ' min');\r\n        }\r\n        if (attrs.difficulty) {\r\n            const diffLabels = { easy: 'Facile', medium: 'Moyen', hard: 'Difficile' };\r\n            metaItems.push('‚ö° ' + (diffLabels[attrs.difficulty] || attrs.difficulty));\r\n        }\r\n        if (metaItems.length > 0) {\r\n            metaText = '<p class=\"gl-poi-popup__meta-text\">' + metaItems.join(' ‚Ä¢ ') + '</p>';\r\n        }\r\n\r\n        // Tags\r\n        const tagBadges = [];\r\n        if (Array.isArray(attrs.tags)) {\r\n            attrs.tags.forEach(tag => {\r\n                if (tag && typeof tag === 'string') {\r\n                    tagBadges.push('<span class=\"gl-poi-badge gl-poi-badge--tag\">' + escapeHtml(tag) + '</span>');\r\n                }\r\n            });\r\n        }\r\n\r\n        // Construction du popup\r\n        return '<div class=\"gl-poi-popup\">' +\r\n            (photo ? '<div class=\"gl-poi-popup__photo\"><img src=\"' + photo + '\" alt=\"' + label + '\" /></div>' : '') +\r\n            '<div class=\"gl-poi-popup__body\">' +\r\n                '<div class=\"gl-poi-popup__title-wrapper\">' +\r\n                    '<h3 class=\"gl-poi-popup__title\">' + iconHtml + '<span class=\"gl-poi-popup__title-text\">' + label + '</span></h3>' +\r\n                '</div>' +\r\n                (description ? '<p class=\"gl-poi-popup__desc\">' + description + '</p>' : '') +\r\n                metaText +\r\n                (tagBadges.length ? '<div class=\"gl-poi-popup__badges\">' + tagBadges.join('') + '</div>' : '') +\r\n                '<a class=\"gl-poi-popup__link\" href=\"#\" data-route-id=\"' + routeId + '\">Voir plus >>></a>' +\r\n            '</div>' +\r\n        '</div>';\r\n    }\r\n\r\n    // ========================================\r\n    //   SIDE PANEL\r\n    // ========================================\r\n\r\n    /**\r\n     * Ouvre le panneau lat√©ral avec les d√©tails d'un itin√©raire\r\n     * @param {Object} route - Donn√©es de l'itin√©raire\r\n     */\r\n    GeoLeaf._RoutePopupBuilder.openRouteSidePanel = function (route) {\r\n        // V√©rifier que le module POI est disponible\r\n        if (!GeoLeaf.POI || typeof GeoLeaf.POI.openSidePanelWithLayout !== 'function') {\r\n            Log.warn && Log.warn('[Route Popup] Cannot open side panel: POI.openSidePanelWithLayout not available');\r\n            return;\r\n        }\r\n\r\n        const attrs = route.attributes || {};\r\n        const layout = getRouteLayoutConfig();\r\n\r\n        // Construire les m√©tadonn√©es\r\n        const metadata = [];\r\n        if (attrs.distance_km) {\r\n            metadata.push('üìè Distance : ' + attrs.distance_km + ' km');\r\n        }\r\n        if (attrs.duration_min) {\r\n            metadata.push('‚è±Ô∏è Dur√©e : ' + attrs.duration_min + ' minutes');\r\n        }\r\n        if (attrs.difficulty) {\r\n            const diffLabels = { easy: 'Facile', medium: 'Moyen', hard: 'Difficile' };\r\n            metadata.push('‚ö° Difficult√© : ' + (diffLabels[attrs.difficulty] || attrs.difficulty));\r\n        }\r\n\r\n        // Transformer la route en structure POI pour le rendu\r\n        const routeAsPoi = {\r\n            id: route.id,\r\n            label: route.label || route.name,\r\n            title: route.label || route.name,\r\n            name: route.label || route.name,\r\n            description: attrs.description || route.description,\r\n            attributes: {\r\n                ...attrs,\r\n                metadata: metadata.length > 0 ? metadata : null,\r\n                photo: attrs.photo,\r\n                mainImage: attrs.photo,\r\n                description: attrs.description,\r\n                shortDescription: attrs.description,\r\n                description_long: attrs.description_long,\r\n                longDescription: attrs.description_long,\r\n                categoryId: attrs.categoryId,\r\n                subCategoryId: attrs.subCategoryId,\r\n                difficulty: attrs.difficulty,\r\n                distance_km: attrs.distance_km,\r\n                duration_min: attrs.duration_min,\r\n                tags: attrs.tags,\r\n                link: attrs.link\r\n            }\r\n        };\r\n\r\n        // Ouvrir le panneau lat√©ral\r\n        GeoLeaf.POI.openSidePanelWithLayout(routeAsPoi, layout);\r\n    };\r\n\r\n    Log.info && Log.info(\"[GeoLeaf._RoutePopupBuilder] Module Popup Builder charg√© (v2.0.0)\");\r\n\r\n})(typeof window !== 'undefined' ? window : global);\r\n","/**\r\n * GeoLeaf Route Loaders Module\r\n * Chargement d'itin√©raires depuis diff√©rentes sources (GPX, GeoJSON, Config)\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    GeoLeaf._RouteLoaders = GeoLeaf._RouteLoaders || {};\r\n\r\n    const Log = GeoLeaf.Log || console;\r\n\r\n    /**\r\n     * Charger un fichier GPX depuis une URL\r\n     * @param {string} url - URL du fichier GPX\r\n     * @param {Function} applyRouteCallback - Callback pour appliquer les coordonn√©es\r\n     * @returns {Promise}\r\n     */\r\n    GeoLeaf._RouteLoaders.loadGPX = async function (url, applyRouteCallback) {\r\n        if (!url) {\r\n            Log.warn(\"[GeoLeaf.Route] URL GPX manquante.\");\r\n            return;\r\n        }\r\n\r\n        try {\r\n            const res = await fetch(url);\r\n            const xmlText = await res.text();\r\n            const gpx = new DOMParser().parseFromString(xmlText, \"application/xml\");\r\n\r\n            const coords = Array.from(gpx.getElementsByTagName(\"trkpt\")).map(\r\n                (pt) => [\r\n                    parseFloat(pt.getAttribute(\"lat\") || \"0\"),\r\n                    parseFloat(pt.getAttribute(\"lon\") || \"0\")\r\n                ]\r\n            );\r\n\r\n            if (typeof applyRouteCallback === \"function\") {\r\n                applyRouteCallback(coords);\r\n            }\r\n        } catch (err) {\r\n            Log.error(\"[GeoLeaf.Route] Erreur GPX :\", err);\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Charger un itin√©raire GeoJSON (LineString)\r\n     * @param {Object} geojson - Objet GeoJSON\r\n     * @param {Function} applyRouteCallback - Callback pour appliquer les coordonn√©es\r\n     */\r\n    GeoLeaf._RouteLoaders.loadGeoJSON = function (geojson, applyRouteCallback) {\r\n        if (!geojson || !geojson.type) {\r\n            Log.error(\"[GeoLeaf.Route] GeoJSON invalide.\");\r\n            return;\r\n        }\r\n\r\n        let coords = [];\r\n\r\n        if (geojson.type === \"Feature\" && geojson.geometry.type === \"LineString\") {\r\n            coords = geojson.geometry.coordinates.map((c) => [c[1], c[0]]);\r\n        } else if (geojson.type === \"LineString\") {\r\n            coords = geojson.coordinates.map((c) => [c[1], c[0]]);\r\n        } else {\r\n            Log.warn(\"[GeoLeaf.Route] Format GeoJSON non g√©r√©.\");\r\n        }\r\n\r\n        if (typeof applyRouteCallback === \"function\") {\r\n            applyRouteCallback(coords);\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Extraire un tableau de [lat, lng] √† partir d'un item de cfg.routes.\r\n     * @param {Object} route - Route data\r\n     * @returns {number[][]} Coordinates array\r\n     */\r\n    GeoLeaf._RouteLoaders.extractCoordsFromRouteItem = function (route) {\r\n        // Cas 1 : tableau direct de [lat, lng]\r\n        if (Array.isArray(route.geometry) && route.geometry.length > 0) {\r\n            if (\r\n                Array.isArray(route.geometry[0]) &&\r\n                typeof route.geometry[0][0] === \"number\" &&\r\n                typeof route.geometry[0][1] === \"number\"\r\n            ) {\r\n                return route.geometry.map((pair) => [pair[0], pair[1]]);\r\n            }\r\n\r\n            // Cas 2 : GeoJSON-like dans un tableau\r\n            if (\r\n                route.geometry[0] &&\r\n                typeof route.geometry[0] === \"object\" &&\r\n                route.geometry[0].type === \"LineString\" &&\r\n                Array.isArray(route.geometry[0].coordinates)\r\n            ) {\r\n                return route.geometry[0].coordinates.map((c) => [c[1], c[0]]);\r\n            }\r\n        }\r\n\r\n        // Cas 3 : objet GeoJSON LineString\r\n        if (\r\n            route.geometry &&\r\n            typeof route.geometry === \"object\" &&\r\n            route.geometry.type === \"LineString\" &&\r\n            Array.isArray(route.geometry.coordinates) &&\r\n            route.geometry.coordinates.length > 0\r\n        ) {\r\n            return route.geometry.coordinates.map((c) => [c[1], c[0]]);\r\n        }\r\n\r\n        // Cas 4 : objet GeoJSON MultiLineString - fusionner tous les segments\r\n        if (\r\n            route.geometry &&\r\n            typeof route.geometry === \"object\" &&\r\n            route.geometry.type === \"MultiLineString\" &&\r\n            Array.isArray(route.geometry.coordinates) &&\r\n            route.geometry.coordinates.length > 0\r\n        ) {\r\n            // Prendre le premier segment (lin√©aire le plus long) ou fusionner tous\r\n            const allCoords = route.geometry.coordinates.reduce((acc, segment) => {\r\n                if (Array.isArray(segment) && segment.length > 0) {\r\n                    return acc.concat(segment.map((c) => [c[1], c[0]]));\r\n                }\r\n                return acc;\r\n            }, []);\r\n\r\n            if (allCoords.length > 0) {\r\n                return allCoords;\r\n            }\r\n        }\r\n\r\n        // Aucune g√©om√©trie valide trouv√©e - DEBUG au lieu de WARN\r\n        // car il peut y avoir des features sans coordonn√©es valides\r\n        return [];\r\n    };\r\n\r\n    Log.info(\"[GeoLeaf._RouteLoaders] Module Loaders charg√©\");\r\n\r\n})(window);\r\n","/**\n * GeoLeaf Route Layer Manager Module\n * Gestion des layers Leaflet pour les itin√©raires\n */\n(function (global) {\n    \"use strict\";\n\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\n    GeoLeaf._RouteLayerManager = GeoLeaf._RouteLayerManager || {};\n\n    const Log = GeoLeaf.Log || console;\n\n    /**\n     * Appliquer un itin√©raire complet (remplacement)\n     * @param {Object} context - Context object with map, layerGroup, routeLayer, options\n     * @param {number[][]} coords - Coordinates array\n     * @param {Function} clearCallback - Callback to clear existing routes\n     * @param {Function} fireEventsCallback - Callback to fire route loaded events\n     */\n    GeoLeaf._RouteLayerManager.applyRoute = function (context, coords, clearCallback, fireEventsCallback) {\n        if (!Array.isArray(coords)) {\n            coords = [];\n        }\n\n        if (typeof clearCallback === \"function\") {\n            clearCallback();\n        }\n\n        if (!context.routeLayer && context.layerGroup && context.map) {\n            // Applique le param√®tre interactiveShapes de la config\n            const interactiveShapes = GeoLeaf.Config.get('ui.interactiveShapes', false);\n            const lineStyle = Object.assign({}, context.options.lineStyle, { interactive: interactiveShapes });\n            context.routeLayer = global.L.polyline([], lineStyle).addTo(\n                context.layerGroup\n            );\n        }\n\n        if (context.routeLayer) {\n            context.routeLayer.setLatLngs(coords);\n        }\n\n        if (context.options.fitBoundsOnLoad && coords.length > 1 && context.map) {\n            const bounds = context.routeLayer.getBounds();\n            const fitOpt = {};\n            if (context.options.maxZoomOnFit) {\n                fitOpt.maxZoom = context.options.maxZoomOnFit;\n            }\n            context.map.fitBounds(bounds, fitOpt);\n        }\n\n        if (typeof fireEventsCallback === \"function\") {\n            fireEventsCallback(coords);\n        }\n    };\n\n    /**\n     * Ajouter un waypoint manuel\n     * @param {L.LayerGroup} layerGroup - Layer group\n     * @param {number[]} latlng - Coordinates [lat, lng]\n     * @param {Object} waypointStyle - Waypoint style\n     */\n    GeoLeaf._RouteLayerManager.addWaypoint = function (layerGroup, latlng, waypointStyle) {\n        if (!layerGroup) return;\n        const interactiveShapes = GeoLeaf.Config.get('ui.interactiveShapes', false);\n        const style = Object.assign({}, waypointStyle, { interactive: interactiveShapes });\n        global.L.circleMarker(latlng, style).addTo(layerGroup);\n    };\n\n    /**\n     * Ajouter un segment manuel\n     * @param {L.Polyline} routeLayer - Route polyline\n     * @param {number[][]} coords - Coordinates to add\n     */\n    GeoLeaf._RouteLayerManager.addSegment = function (routeLayer, coords) {\n        if (!routeLayer) return;\n        const current = routeLayer.getLatLngs();\n        routeLayer.setLatLngs([...current, ...coords]);\n    };\n\n    /**\n     * √âmet les √©v√©nements \"geoleaf:route:loaded\" (Leaflet + DOM)\n     * @param {L.Map} map - Leaflet map\n     * @param {L.Polyline} routeLayer - Route polyline\n     * @param {number[][]} coords - Coordinates\n     */\n    GeoLeaf._RouteLayerManager.fireRouteLoadedEvents = function (map, routeLayer, coords) {\n        // √âv√©nement Leaflet sur la carte\n        try {\n            if (map && typeof map.fire === \"function\") {\n                map.fire(\"geoleaf:route:loaded\", {\n                    coords,\n                    layer: routeLayer,\n                    source: \"geoleaf.route\"\n                });\n            }\n        } catch (e) {\n            Log.warn(\n                \"[GeoLeaf.Route] Impossible d'√©mettre l'√©v√©nement Leaflet geoleaf:route:loaded.\",\n                e\n            );\n        }\n\n        // CustomEvent DOM\n        if (typeof document !== \"undefined\" && typeof document.dispatchEvent === \"function\") {\n            const detail = {\n                coords: Array.isArray(coords) ? coords.slice() : [],\n                map: map,\n                layer: routeLayer,\n                source: \"geoleaf.route\"\n            };\n\n            try {\n                if (typeof CustomEvent === \"function\") {\n                    const event = new CustomEvent(\"geoleaf:route:loaded\", { detail });\n                    document.dispatchEvent(event);\n                } else {\n                    const legacyEvent = document.createEvent(\"CustomEvent\");\n                    legacyEvent.initCustomEvent(\n                        \"geoleaf:route:loaded\",\n                        true,\n                        true,\n                        detail\n                    );\n                    document.dispatchEvent(legacyEvent);\n                }\n            } catch (err) {\n                Log.warn(\n                    \"[GeoLeaf.Route] Impossible d'√©mettre le CustomEvent geoleaf:route:loaded.\",\n                    err\n                );\n            }\n        }\n    };\n\n    Log.info(\"[GeoLeaf._RouteLayerManager] Module Layer Manager charg√©\");\n\n})(window);\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    /**\r\n     * Namespace global GeoLeaf\r\n     */\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n\r\n    /**\r\n     * Logger unifi√© (d√©fini par geoleaf.log.js / logger-shim)\r\n     */\r\n    const Log = GeoLeaf.Log || console;\r\n\r\n    /**\r\n     * Module GeoLeaf.Route\r\n     * - Charge et affiche des itin√©raires (GPX, GeoJSON, profils GeoLeaf)\r\n     * - G√®re une couche d√©di√©e (polyline + points √©ventuels)\r\n     * - Offre une API de visibilit√© pour la L√©gende (getLayer)\r\n     * - Prend en compte les styles et les points d√©part/arriv√©e d√©finis\r\n     *   dans le profil actif (profile.json).\r\n     */\r\n    const RouteModule = {\r\n        _map: null,\r\n        _layerGroup: null,\r\n        _routeLayer: null,\r\n\r\n        _initialized: false,\r\n        _visible: true,\r\n\r\n        /**\r\n         * Options par d√©faut\r\n         */\r\n        _options: {\r\n            lineStyle: {\r\n                color: \"#1E88E5\",\r\n                weight: 4,\r\n                opacity: 0.9,\r\n                interactive: false\r\n            },\r\n            waypointStyle: {\r\n                radius: 5,\r\n                color: \"#0D47A1\",\r\n                fillColor: \"#42A5F5\",\r\n                fillOpacity: 0.9,\r\n                weight: 2\r\n            },\r\n            // Affichage des points de d√©part / arriv√©e\r\n            showStart: true,\r\n            showEnd: true,\r\n            startWaypointStyle: null, // si null => waypointStyle\r\n            endWaypointStyle: null,   // si null => waypointStyle\r\n\r\n            fitBoundsOnLoad: true,\r\n            maxZoomOnFit: 14\r\n        },\r\n\r\n        /**\r\n         * Valide les options pass√©es √† init()\r\n         * @param {Object} options\r\n         * @private\r\n         */\r\n        _validateOptions(options) {\r\n            if (options.map && typeof options.map.addLayer !== \"function\") {\r\n                Log.warn(\"[GeoLeaf.Route] options.map ne semble pas √™tre une carte Leaflet valide.\");\r\n            }\r\n\r\n            if (options.lineStyle && typeof options.lineStyle !== \"object\") {\r\n                Log.warn(\"[GeoLeaf.Route] options.lineStyle doit √™tre un objet.\");\r\n                delete options.lineStyle;\r\n            }\r\n\r\n            if (options.waypointStyle && typeof options.waypointStyle !== \"object\") {\r\n                Log.warn(\"[GeoLeaf.Route] options.waypointStyle doit √™tre un objet.\");\r\n                delete options.waypointStyle;\r\n            }\r\n\r\n            if (\r\n                options.maxZoomOnFit !== undefined &&\r\n                (typeof options.maxZoomOnFit !== \"number\" ||\r\n                    options.maxZoomOnFit < 1 ||\r\n                    options.maxZoomOnFit > 20)\r\n            ) {\r\n                Log.warn(\"[GeoLeaf.Route] options.maxZoomOnFit doit √™tre entre 1 et 20.\");\r\n                options.maxZoomOnFit = 14;\r\n            }\r\n\r\n            return options;\r\n        },\r\n\r\n        /**\r\n         * Retourne le layerGroup contenant les itin√©raires\r\n         * (utilis√© par la L√©gende pour afficher/masquer la couche)\r\n         * @returns {L.LayerGroup|null}\r\n         */\r\n        getLayer() {\r\n            return this._layerGroup || null;\r\n        },\r\n\r\n        /**\r\n         * Initialisation du module Route\r\n         * @param {Object} options\r\n         * @param {L.Map} [options.map] - Carte Leaflet\r\n         * @returns {L.LayerGroup|null}\r\n         */\r\n        init(options = {}) {\r\n            options = this._validateOptions(options);\r\n\r\n            if (typeof global.L === \"undefined\") {\r\n                Log.error(\"[GeoLeaf.Route] Leaflet introuvable.\");\r\n                return null;\r\n            }\r\n\r\n            // Utilise un helper commun si disponible\r\n            let map = options.map || null;\r\n            if (!map && GeoLeaf.Core && typeof GeoLeaf.Core.getMap === \"function\") {\r\n                map = GeoLeaf.Core.getMap();\r\n            }\r\n            if (GeoLeaf.Utils && typeof GeoLeaf.Utils.ensureMap === \"function\") {\r\n                map = GeoLeaf.Utils.ensureMap(map);\r\n            }\r\n\r\n            if (!map) {\r\n                Log.error(\"[GeoLeaf.Route] Aucune carte disponible pour init().\");\r\n                return null;\r\n            }\r\n\r\n            this._map = map;\r\n\r\n            // Fusion des options\r\n            if (GeoLeaf.Utils && typeof GeoLeaf.Utils.mergeOptions === \"function\") {\r\n                this._options = GeoLeaf.Utils.mergeOptions(this._options, options);\r\n            } else {\r\n                this._options = Object.assign({}, this._options, options);\r\n            }\r\n\r\n            // Applique le param√®tre interactiveShapes de la config\r\n            const interactiveShapes = GeoLeaf.Config.get('ui.interactiveShapes', false);\r\n            if (this._options.lineStyle) {\r\n                this._options.lineStyle.interactive = interactiveShapes;\r\n            }\r\n\r\n            this._layerGroup = global.L.layerGroup().addTo(this._map);\r\n            this._routeLayer = global.L.polyline([], this._options.lineStyle).addTo(\r\n                this._layerGroup\r\n            );\r\n\r\n            this._initialized = true;\r\n            this._visible = true;\r\n\r\n            return this._layerGroup;\r\n        },\r\n\r\n        /**\r\n         * Indique si le module est initialis√©.\r\n         * @returns {boolean}\r\n         */\r\n        isInitialized() {\r\n            return this._initialized === true && !!this._map && !!this._layerGroup;\r\n        },\r\n\r\n        /**\r\n         * Indique si la couche d'itin√©raires est actuellement visible.\r\n         * @returns {boolean}\r\n         */\r\n        isVisible() {\r\n            return this._visible === true;\r\n        },\r\n\r\n        /**\r\n         * Affiche la couche d'itin√©raires.\r\n         */\r\n        show() {\r\n            if (!this._map || !this._layerGroup) return;\r\n            if (!this._map.hasLayer(this._layerGroup)) {\r\n                this._layerGroup.addTo(this._map);\r\n            }\r\n            this._visible = true;\r\n        },\r\n\r\n        /**\r\n         * Masque la couche d'itin√©raires.\r\n         */\r\n        hide() {\r\n            if (!this._map || !this._layerGroup) return;\r\n            if (this._map.hasLayer(this._layerGroup)) {\r\n                this._map.removeLayer(this._layerGroup);\r\n            }\r\n            this._visible = false;\r\n        },\r\n\r\n        /**\r\n         * Bascule la visibilit√© (utile √©ventuellement en dehors de la L√©gende).\r\n         */\r\n        toggleVisibility() {\r\n            if (!this.isInitialized()) {\r\n                Log.warn(\"[GeoLeaf.Route] toggleVisibility() appel√© sans init().\");\r\n                return;\r\n            }\r\n            if (this.isVisible()) {\r\n                this.hide();\r\n            } else {\r\n                this.show();\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Vider tous les itin√©raires de la couche\r\n         */\r\n        clear() {\r\n            if (this._layerGroup) {\r\n                this._layerGroup.clearLayers();\r\n            }\r\n            if (this._map && this._layerGroup) {\r\n                this._routeLayer = global.L.polyline([], this._options.lineStyle).addTo(\r\n                    this._layerGroup\r\n                );\r\n            } else {\r\n                this._routeLayer = null;\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Charger un fichier GPX (via fetch)\r\n         * @param {string} url\r\n         * @returns {Promise<void>}\r\n         */\r\n        loadGPX(url) {\r\n            if (!url) {\r\n                Log.warn(\"[GeoLeaf.Route] URL GPX manquante.\");\r\n                return Promise.resolve();\r\n            }\r\n\r\n            // Sprint 3.3: Use unified FetchHelper with timeout for GPX loading\r\n            const FetchHelper = GeoLeaf.Utils?.FetchHelper;\r\n\r\n            if (FetchHelper) {\r\n                return FetchHelper.fetch(url, {\r\n                    timeout: 15000, // GPX files can be larger, allow more time\r\n                    retries: 2,\r\n                    parseResponse: false // We need raw text\r\n                })\r\n                .then((response) => response.text())\r\n                .then((xmlText) =>\r\n                    new DOMParser().parseFromString(xmlText, \"application/xml\")\r\n                )\r\n                .then((gpx) => {\r\n                    const coords = Array.from(gpx.getElementsByTagName(\"trkpt\")).map(\r\n                        (pt) => [\r\n                            parseFloat(pt.getAttribute(\"lat\") || \"0\"),\r\n                            parseFloat(pt.getAttribute(\"lon\") || \"0\")\r\n                        ]\r\n                    );\r\n                    this._applyRoute(coords);\r\n                })\r\n                .catch((err) => Log.error(\"[GeoLeaf.Route] Erreur GPX :\", err));\r\n            }\r\n\r\n            // Fallback to raw fetch\r\n            return fetch(url)\r\n                .then((res) => res.text())\r\n                .then((xmlText) =>\r\n                    new DOMParser().parseFromString(xmlText, \"application/xml\")\r\n                )\r\n                .then((gpx) => {\r\n                    const coords = Array.from(gpx.getElementsByTagName(\"trkpt\")).map(\r\n                        (pt) => [\r\n                            parseFloat(pt.getAttribute(\"lat\") || \"0\"),\r\n                            parseFloat(pt.getAttribute(\"lon\") || \"0\")\r\n                        ]\r\n                    );\r\n                    this._applyRoute(coords);\r\n                })\r\n                .catch((err) => Log.error(\"[GeoLeaf.Route] Erreur GPX :\", err));\r\n        },\r\n\r\n        /**\r\n         * Charger un itin√©raire GeoJSON (LineString)\r\n         * @param {Object} geojson\r\n         */\r\n        loadGeoJSON(geojson) {\r\n            if (!GeoLeaf._RouteLoaders || typeof GeoLeaf._RouteLoaders.loadGeoJSON !== \"function\") {\r\n                Log.error(\"[GeoLeaf.Route.loadGeoJSON] GeoLeaf._RouteLoaders.loadGeoJSON() non disponible.\");\r\n                return;\r\n            }\r\n            GeoLeaf._RouteLoaders.loadGeoJSON(geojson, this._applyRoute.bind(this));\r\n        },\r\n\r\n        /**\r\n         * Charge un tableau d‚Äôitin√©raires d√©j√† normalis√©s depuis cfg.routes\r\n         * (profil GeoLeaf) et les dessine sur la carte.\r\n         *\r\n         * Format attendu pour chaque item :\r\n         * {\r\n         *   id: \"route-id\",\r\n         *   label: \"Nom\",\r\n         *   type: \"walking\" | \"trekking\" | ... (optionnel)\r\n         *   geometry: [ [lat, lng], ... ]  // OU GeoJSON LineString\r\n         *   properties: {\r\n         *     type?: \"walking\" | \"trekking\" | ...,\r\n         *     color?: \"#hex\",\r\n         *     weight?: number,\r\n         *     opacity?: number,\r\n         *     dashArray?: string,\r\n         *     showStart?: boolean,\r\n         *     showEnd?: boolean,\r\n         *     startStyle?: {...},\r\n         *     endStyle?: {...},\r\n         *     ...\r\n         *   }\r\n         * }\r\n         *\r\n         * Les styles et endpoints par d√©faut peuvent √™tre d√©finis\r\n         * dans le profil actif (profile.json) :\r\n         *\r\n         * \"defaultSettings\": {\r\n         *   \"routeConfig\": {\r\n         *     \"default\": { \"color\": \"#ff6600\", \"weight\": 4, \"opacity\": 0.9 },\r\n         *     \"endpoints\": {\r\n         *       \"showStart\": true,\r\n         *       \"showEnd\": true,\r\n         *       \"start\": { \"radius\": 6, \"color\": \"#ffffff\", \"fillColor\": \"#2b7cff\" },\r\n         *       \"end\":   { \"radius\": 6, \"color\": \"#ffffff\", \"fillColor\": \"#ff7b32\" }\r\n         *     }\r\n         *   }\r\n         * }\r\n         *\r\n         * La couleur des routes est d√©termin√©e par priorit√© :\r\n         * 1. colorRoute de la sous-cat√©gorie (taxonomy.categories[cat].subcategories[subcat].colorRoute)\r\n         * 2. colorRoute de la cat√©gorie (taxonomy.categories[cat].colorRoute)\r\n         * 3. defaultSettings.routeConfig.default.color\r\n         *\r\n         * @param {Array} routes\r\n         */\r\n        loadFromConfig(routes) {\r\n            if (!this.isInitialized()) {\r\n                Log.warn(\r\n                    \"[GeoLeaf.Route] loadFromConfig() appel√© alors que le module n'est pas initialis√©.\"\r\n                );\r\n                return;\r\n            }\r\n\r\n            if (!Array.isArray(routes) || routes.length === 0) {\r\n                this.clear();\r\n                Log.info(\"[GeoLeaf.Route] Aucun itin√©raire dans cfg.routes ; couche vid√©e.\");\r\n                return;\r\n            }\r\n\r\n            this.clear();\r\n\r\n            const allCoords = [];\r\n            const defaultStyle = this._options.lineStyle || {};\r\n\r\n            // R√©cup√©rer config + endpoints d√©finis dans le profil actif\r\n            let activeProfile = null;\r\n            let routeConfigDefault = null;\r\n            let profileEndpoints = null;\r\n\r\n            try {\r\n                if (\r\n                    GeoLeaf.Config &&\r\n                    typeof GeoLeaf.Config.getActiveProfile === \"function\"\r\n                ) {\r\n                    activeProfile = GeoLeaf.Config.getActiveProfile();\r\n                    if (activeProfile && activeProfile.defaultSettings && activeProfile.defaultSettings.routeConfig) {\r\n                        if (\r\n                            activeProfile.defaultSettings.routeConfig.default &&\r\n                            typeof activeProfile.defaultSettings.routeConfig.default === \"object\" &&\r\n                            !Array.isArray(activeProfile.defaultSettings.routeConfig.default)\r\n                        ) {\r\n                            routeConfigDefault = activeProfile.defaultSettings.routeConfig.default;\r\n                        }\r\n                        if (\r\n                            activeProfile.defaultSettings.routeConfig.endpoints &&\r\n                            typeof activeProfile.defaultSettings.routeConfig.endpoints === \"object\" &&\r\n                            !Array.isArray(activeProfile.defaultSettings.routeConfig.endpoints)\r\n                        ) {\r\n                            profileEndpoints = activeProfile.defaultSettings.routeConfig.endpoints;\r\n                        }\r\n                    }\r\n                }\r\n            } catch (e) {\r\n                Log.warn(\r\n                    \"[GeoLeaf.Route] Impossible de lire la config/endpoints depuis le profil actif.\",\r\n                    e\r\n                );\r\n            }\r\n\r\n            routes.forEach((route) => {\r\n                if (!route || typeof route !== \"object\") {\r\n                    return;\r\n                }\r\n\r\n                const coords = this._extractCoordsFromRouteItem(route);\r\n                if (!coords || coords.length === 0) {\r\n                    return;\r\n                }\r\n\r\n                // Style de la polyline\r\n                const routeStyle = this._resolveRouteStyle(\r\n                    route,\r\n                    activeProfile,\r\n                    routeConfigDefault,\r\n                    defaultStyle\r\n                );\r\n\r\n                // Applique le param√®tre interactiveShapes\r\n                const interactiveShapes = GeoLeaf.Config.get('ui.interactiveShapes', false);\r\n                routeStyle.interactive = interactiveShapes;\r\n\r\n                const polyline = global.L.polyline(coords, routeStyle).addTo(\r\n                    this._layerGroup\r\n                );\r\n\r\n                // Attach route data to polyline for popup/tooltip access\r\n                polyline._geoleafRouteData = route;\r\n\r\n                // Add tooltip with route label\r\n                this._addRouteTooltip(polyline, route);\r\n\r\n                // Add popup with route details\r\n                this._addRoutePopup(polyline, route);\r\n\r\n                // Premi√®re polyline = \"routeLayer\" principal\r\n                if (!this._routeLayer) {\r\n                    this._routeLayer = polyline;\r\n                }\r\n\r\n                allCoords.push(...coords);\r\n\r\n                // Points de d√©part / arriv√©e\r\n                const endpointCfg = this._resolveEndpointConfig(\r\n                    route,\r\n                    profileEndpoints,\r\n                    this._options\r\n                );\r\n\r\n                if (coords.length > 0) {\r\n                    const startLatLng = coords[0];\r\n                    const endLatLng = coords[coords.length - 1];\r\n\r\n                    if (endpointCfg.showStart) {\r\n                        const startStyle = Object.assign({}, endpointCfg.startStyle, { interactive: interactiveShapes });\r\n                        global.L.circleMarker(startLatLng, startStyle).addTo(\r\n                            this._layerGroup\r\n                        );\r\n                    }\r\n\r\n                    if (\r\n                        endpointCfg.showEnd &&\r\n                        endLatLng &&\r\n                        (endLatLng[0] !== startLatLng[0] ||\r\n                            endLatLng[1] !== startLatLng[1])\r\n                    ) {\r\n                        const endStyle = Object.assign({}, endpointCfg.endStyle, { interactive: interactiveShapes });\r\n                        global.L.circleMarker(endLatLng, endStyle).addTo(\r\n                            this._layerGroup\r\n                        );\r\n                    }\r\n                }\r\n            });\r\n\r\n            if (allCoords.length === 0) {\r\n                Log.warn(\r\n                    \"[GeoLeaf.Route] loadFromConfig() n'a trouv√© aucun itin√©raire valide dans cfg.routes.\"\r\n                );\r\n                return;\r\n            }\r\n\r\n            // Ajuster l'emprise globale si option activ√©e\r\n            if (this._options.fitBoundsOnLoad) {\r\n                try {\r\n                    const bounds = this._layerGroup.getBounds();\r\n                    const fitOpt = {};\r\n                    if (this._options.maxZoomOnFit) {\r\n                        fitOpt.maxZoom = this._options.maxZoomOnFit;\r\n                    }\r\n                    this._map.fitBounds(bounds, fitOpt);\r\n                } catch (e) {\r\n                    Log.warn(\r\n                        \"[GeoLeaf.Route] Erreur lors du fitBounds sur les itin√©raires :\",\r\n                        e\r\n                    );\r\n                }\r\n            }\r\n\r\n            // √âv√©nements \"route loaded\" (Leaflet + DOM)\r\n            this._fireRouteLoadedEvents(allCoords);\r\n        },\r\n\r\n        /**\r\n         * Filtrer la visibilit√© des routes d√©j√† charg√©es sans les recharger.\r\n         * Pr√©serve les styles originaux des routes.\r\n         * @param {Array<Object>} filteredRoutes - Liste des routes √† afficher (apr√®s filtrage)\r\n         * @public\r\n         */\r\n        filterVisibility: function (filteredRoutes) {\r\n            if (!this._initialized) {\r\n                Log.warn(\"[GeoLeaf.Route] Module non initialis√© - filterVisibility ignor√©.\");\r\n                return;\r\n            }\r\n\r\n            if (!Array.isArray(filteredRoutes)) {\r\n                Log.warn(\"[GeoLeaf.Route] filterVisibility : filteredRoutes doit √™tre un tableau.\");\r\n                return;\r\n            }\r\n\r\n            // Cr√©er un Set des IDs des routes √† afficher pour une recherche rapide\r\n            const visibleRouteIds = new Set(filteredRoutes.map(r => r.id));\r\n\r\n            // Parcourir toutes les couches actuellement affich√©es\r\n            this._layerGroup.eachLayer(function (layer) {\r\n                // V√©rifier si cette couche a un ID de route\r\n                const routeId = layer.options && layer.options.routeId;\r\n\r\n                if (routeId !== undefined) {\r\n                    // Afficher ou masquer selon si l'ID est dans la liste filtr√©e\r\n                    if (visibleRouteIds.has(routeId)) {\r\n                        if (!this._map.hasLayer(layer)) {\r\n                            this._map.addLayer(layer);\r\n                        }\r\n                    } else {\r\n                        if (this._map.hasLayer(layer)) {\r\n                            this._map.removeLayer(layer);\r\n                        }\r\n                    }\r\n                }\r\n            }.bind(this));\r\n\r\n            Log.info(\"[GeoLeaf.Route] Visibilit√© filtr√©e : \" + filteredRoutes.length + \" routes visibles.\");\r\n        },\r\n\r\n        /**\r\n         * Extraire un tableau de [lat, lng] √† partir d'un item de cfg.routes.\r\n         * @param {Object} route\r\n         * @returns {number[][]}\r\n         * @private\r\n         */\r\n        _extractCoordsFromRouteItem(route) {\r\n            if (!GeoLeaf._RouteLoaders || typeof GeoLeaf._RouteLoaders.extractCoordsFromRouteItem !== \"function\") {\r\n                Log.error(\"[GeoLeaf.Route._extractCoordsFromRouteItem] GeoLeaf._RouteLoaders.extractCoordsFromRouteItem() non disponible.\");\r\n                return [];\r\n            }\r\n            return GeoLeaf._RouteLoaders.extractCoordsFromRouteItem(route);\r\n        },\r\n\r\n        /**\r\n         * D√©termine la couleur d'un itin√©raire selon la priorit√© :\r\n         *  1. colorRoute de la sous-cat√©gorie (si d√©finie)\r\n         *  2. colorRoute de la cat√©gorie (si d√©finie)\r\n         *  3. couleur par d√©faut de routeConfig.default.color\r\n         *\r\n         * @param {Object} route - L'itin√©raire\r\n         * @param {Object} profile - Le profil actif\r\n         * @param {Object} routeConfigDefault - La config par d√©faut (defaultSettings.routeConfig.default)\r\n         * @returns {string|null} La couleur √† utiliser ou null\r\n         * @private\r\n         */\r\n        _getRouteColor(route, profile, routeConfigDefault) {\r\n            if (!GeoLeaf._RouteStyleResolver || typeof GeoLeaf._RouteStyleResolver.getRouteColor !== \"function\") {\r\n                Log.error(\"[GeoLeaf.Route._getRouteColor] GeoLeaf._RouteStyleResolver.getRouteColor() non disponible.\");\r\n                return routeConfigDefault?.color || null;\r\n            }\r\n            return GeoLeaf._RouteStyleResolver.getRouteColor(route, profile, routeConfigDefault);\r\n        },\r\n\r\n        /**\r\n         * Calcule le style final d'un itin√©raire en combinant :\r\n         *  - le style par d√©faut du module,\r\n         *  - la config par d√©faut du profil (defaultSettings.routeConfig.default),\r\n         *  - la couleur bas√©e sur la taxonomie (colorRoute),\r\n         *  - les surcharges au niveau de l'itin√©raire (properties.*).\r\n         *\r\n         * @private\r\n         */\r\n        _resolveRouteStyle(route, activeProfile, routeConfigDefault, defaultStyle) {\r\n            if (!GeoLeaf._RouteStyleResolver || typeof GeoLeaf._RouteStyleResolver.resolveRouteStyle !== \"function\") {\r\n                Log.error(\"[GeoLeaf.Route._resolveRouteStyle] GeoLeaf._RouteStyleResolver.resolveRouteStyle() non disponible.\");\r\n                return Object.assign({}, defaultStyle || {});\r\n            }\r\n            return GeoLeaf._RouteStyleResolver.resolveRouteStyle(route, activeProfile, routeConfigDefault, defaultStyle);\r\n        },\r\n\r\n        /**\r\n         * Calcule la configuration d'affichage des points d√©part / arriv√©e\r\n         * en combinant :\r\n         *  - les options par d√©faut du module (_options),\r\n         *  - les endpoints d√©finis dans le profil actif (defaultSettings.routeConfig.endpoints),\r\n         *  - les surcharges √©ventuelles au niveau de l'itin√©raire\r\n         *    (properties.showStart, properties.showEnd, startStyle, endStyle).\r\n         *\r\n         * @private\r\n         */\r\n        _resolveEndpointConfig(route, profileEndpoints, moduleOptions) {\r\n            if (!GeoLeaf._RouteStyleResolver || typeof GeoLeaf._RouteStyleResolver.resolveEndpointConfig !== \"function\") {\r\n                Log.error(\"[GeoLeaf.Route._resolveEndpointConfig] GeoLeaf._RouteStyleResolver.resolveEndpointConfig() non disponible.\");\r\n                return {\r\n                    showStart: true,\r\n                    showEnd: true,\r\n                    startStyle: { radius: 6, color: \"#ffffff\", fillColor: \"#2b7cff\", fillOpacity: 1, weight: 2 },\r\n                    endStyle: { radius: 6, color: \"#ffffff\", fillColor: \"#ff7b32\", fillOpacity: 1, weight: 2 }\r\n                };\r\n            }\r\n            return GeoLeaf._RouteStyleResolver.resolveEndpointConfig(route, profileEndpoints, moduleOptions);\r\n        },\r\n\r\n        /**\r\n         * Ajouter un waypoint manuel\r\n         * @param {number[]} latlng\r\n         */\r\n        addWaypoint(latlng) {\r\n            if (!GeoLeaf._RouteLayerManager || typeof GeoLeaf._RouteLayerManager.addWaypoint !== \"function\") {\r\n                Log.error(\"[GeoLeaf.Route.addWaypoint] GeoLeaf._RouteLayerManager.addWaypoint() non disponible.\");\r\n                return;\r\n            }\r\n            GeoLeaf._RouteLayerManager.addWaypoint(this._layerGroup, latlng, this._options.waypointStyle);\r\n        },\r\n\r\n        /**\r\n         * Ajouter un segment manuel\r\n         * @param {number[][]} coords\r\n         */\r\n        addSegment(coords) {\r\n            if (!this._routeLayer) return;\r\n            const current = this._routeLayer.getLatLngs();\r\n            this._routeLayer.setLatLngs([...current, ...coords]);\r\n        },\r\n\r\n        /**\r\n         * Appliquer un itin√©raire complet (remplacement)\r\n         * @param {number[][]} coords\r\n         * @private\r\n         */\r\n        _applyRoute(coords) {\r\n            if (!GeoLeaf._RouteLayerManager || typeof GeoLeaf._RouteLayerManager.applyRoute !== \"function\") {\r\n                Log.error(\"[GeoLeaf.Route._applyRoute] GeoLeaf._RouteLayerManager.applyRoute() non disponible.\");\r\n                return;\r\n            }\r\n            const context = {\r\n                map: this._map,\r\n                layerGroup: this._layerGroup,\r\n                routeLayer: this._routeLayer,\r\n                options: this._options\r\n            };\r\n            GeoLeaf._RouteLayerManager.applyRoute(context, coords, this.clear.bind(this), this._fireRouteLoadedEvents.bind(this));\r\n            this._routeLayer = context.routeLayer;\r\n        },\r\n\r\n        /**\r\n         * Add tooltip to route polyline\r\n         * @param {L.Polyline} polyline\r\n         * @param {Object} route\r\n         * @private\r\n         */\r\n        _addRouteTooltip(polyline, route) {\r\n            if (!GeoLeaf._RoutePopupBuilder || typeof GeoLeaf._RoutePopupBuilder.addRouteTooltip !== \"function\") {\r\n                Log.error(\"[GeoLeaf.Route._addRouteTooltip] GeoLeaf._RoutePopupBuilder.addRouteTooltip() non disponible.\");\r\n                return;\r\n            }\r\n            GeoLeaf._RoutePopupBuilder.addRouteTooltip(polyline, route);\r\n        },\r\n\r\n        /**\r\n         * Add popup to route polyline with \"Voir plus\" button\r\n         * @param {L.Polyline} polyline\r\n         * @param {Object} route\r\n         * @private\r\n         */\r\n        _addRoutePopup(polyline, route) {\r\n            if (!GeoLeaf._RoutePopupBuilder || typeof GeoLeaf._RoutePopupBuilder.addRoutePopup !== \"function\") {\r\n                Log.error(\"[GeoLeaf.Route._addRoutePopup] GeoLeaf._RoutePopupBuilder.addRoutePopup() non disponible.\");\r\n                return;\r\n            }\r\n            GeoLeaf._RoutePopupBuilder.addRoutePopup(polyline, route, this);\r\n        },\r\n\r\n        /**\r\n         * Build popup content for route (same structure as POI popup)\r\n         * @param {Object} route\r\n         * @returns {string} HTML content\r\n         * @private\r\n         */\r\n        _buildRoutePopupContent(route) {\r\n            if (!GeoLeaf._RoutePopupBuilder || typeof GeoLeaf._RoutePopupBuilder.buildRoutePopupContent !== \"function\") {\r\n                Log.error(\"[GeoLeaf.Route._buildRoutePopupContent] GeoLeaf._RoutePopupBuilder.buildRoutePopupContent() non disponible.\");\r\n                return \"<div>Route popup non disponible</div>\";\r\n            }\r\n            return GeoLeaf._RoutePopupBuilder.buildRoutePopupContent(route);\r\n        },        /**\r\n         * Open side panel with route details\r\n         * @param {Object} route\r\n         * @private\r\n         */\r\n        _openRouteSidePanel(route) {\r\n            if (!GeoLeaf._RoutePopupBuilder || typeof GeoLeaf._RoutePopupBuilder.openRouteSidePanel !== \"function\") {\r\n                Log.error(\"[GeoLeaf.Route._openRouteSidePanel] GeoLeaf._RoutePopupBuilder.openRouteSidePanel() non disponible.\");\r\n                return;\r\n            }\r\n            GeoLeaf._RoutePopupBuilder.openRouteSidePanel(route);\r\n        },\r\n\r\n        /**\r\n         * √âmet les √©v√©nements \"geoleaf:route:loaded\" (Leaflet + DOM)\r\n         * @param {number[][]} coords\r\n         * @private\r\n         */\r\n        _fireRouteLoadedEvents(coords) {\r\n            // √âv√©nement Leaflet sur la carte\r\n            try {\r\n                if (this._map && typeof this._map.fire === \"function\") {\r\n                    this._map.fire(\"geoleaf:route:loaded\", {\r\n                        coords,\r\n                        layer: this._routeLayer,\r\n                        source: \"geoleaf.route\"\r\n                    });\r\n                }\r\n            } catch (e) {\r\n                Log.warn(\r\n                    \"[GeoLeaf.Route] Impossible d'√©mettre l'√©v√©nement Leaflet geoleaf:route:loaded.\",\r\n                    e\r\n                );\r\n            }\r\n\r\n            // CustomEvent DOM\r\n            if (typeof document !== \"undefined\" && typeof document.dispatchEvent === \"function\") {\r\n                const detail = {\r\n                    coords: Array.isArray(coords) ? coords.slice() : [],\r\n                    map: this._map,\r\n                    layer: this._routeLayer,\r\n                    source: \"geoleaf.route\"\r\n                };\r\n\r\n                try {\r\n                    if (typeof CustomEvent === \"function\") {\r\n                        const event = new CustomEvent(\"geoleaf:route:loaded\", { detail });\r\n                        document.dispatchEvent(event);\r\n                    } else {\r\n                        const legacyEvent = document.createEvent(\"CustomEvent\");\r\n                        legacyEvent.initCustomEvent(\r\n                            \"geoleaf:route:loaded\",\r\n                            true,\r\n                            true,\r\n                            detail\r\n                        );\r\n                        document.dispatchEvent(legacyEvent);\r\n                    }\r\n                } catch (err) {\r\n                    Log.warn(\r\n                        \"[GeoLeaf.Route] Impossible d'√©mettre le CustomEvent geoleaf:route:loaded.\",\r\n                        err\r\n                    );\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    GeoLeaf.Route = RouteModule;\r\n})(window);\r\n","/**\r\n * Module partag√© pour LayerManager\r\n * √âtat et utilitaires communs entre les sous-modules\r\n *\r\n * D√âPENDANCES:\r\n * - GeoLeaf.Log (optionnel)\r\n *\r\n * EXPOSE:\r\n * - GeoLeaf._LayerManagerShared\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = global.GeoLeaf = global.GeoLeaf || {};\r\n    const Log = GeoLeaf.Log;\r\n\r\n    /**\r\n     * √âtat partag√© pour LayerManager (priv√© interne)\r\n     * @private\r\n     */\r\n    const _LayerManagerShared = {\r\n        /**\r\n         * R√©f√©rence √† la carte Leaflet\r\n         * @type {L.Map|null}\r\n         */\r\n        map: null,\r\n\r\n        /**\r\n         * R√©f√©rence au contr√¥le Leaflet\r\n         * @type {L.Control|null}\r\n         */\r\n        control: null,\r\n\r\n        /**\r\n         * Options internes du module\r\n         * @type {Object}\r\n         */\r\n        options: {\r\n            position: \"bottomright\",\r\n            title: \"L√©gende\",\r\n            collapsible: true,\r\n            collapsed: false,\r\n            sections: []\r\n        }\r\n    };\r\n\r\n    // Exposer dans l'espace de noms interne\r\n    GeoLeaf._LayerManagerShared = _LayerManagerShared;\r\n\r\n})(window);\r\n","/**\r\n * Module Renderer pour LayerManager\r\n * Logique de rendu des sections et items de la l√©gende\r\n *\r\n * D√âPENDANCES:\r\n * - Leaflet (L.DomUtil, L.DomEvent)\r\n * - GeoLeaf.Log (optionnel)\r\n * - GeoLeaf._LayerManagerBasemapSelector (pour section basemap)\r\n * - GeoLeaf._LayerManagerThemeSelector (pour th√®mes)\r\n * - GeoLeaf.Themes (pour getAvailableThemes)\r\n * - GeoLeaf.GeoJSON (pour setTheme)\r\n *\r\n * EXPOSE:\r\n * - GeoLeaf._LayerManagerRenderer\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = global.GeoLeaf = global.GeoLeaf || {};\r\n    const Log = GeoLeaf.Log;\r\n\r\n    /**\r\n     * Module Renderer pour LayerManager\r\n     * @namespace _LayerManagerRenderer\r\n     * @private\r\n     */\r\n    const _LayerManagerRenderer = {\r\n        /**\r\n         * Rend les sections de la l√©gende\r\n         * @param {HTMLElement} bodyEl - √âl√©ment body de la l√©gende\r\n         * @param {Array} sections - Liste des sections √† rendre\r\n         */\r\n        renderSections(bodyEl, sections) {\r\n            if (!bodyEl) {\r\n                return;\r\n            }\r\n\r\n            // Clear content sans innerHTML\r\n            if (GeoLeaf._UIComponents && typeof GeoLeaf._UIComponents.clearElement === 'function') {\r\n                GeoLeaf._UIComponents.clearElement(bodyEl);\r\n            } else {\r\n                while (bodyEl.firstChild) {\r\n                    bodyEl.removeChild(bodyEl.firstChild);\r\n                }\r\n            }\r\n\r\n            if (!Array.isArray(sections) || sections.length === 0) {\r\n                if (GeoLeaf._UIComponents && typeof GeoLeaf._UIComponents.createEmptyMessage === 'function') {\r\n                    GeoLeaf._UIComponents.createEmptyMessage(bodyEl, \"Aucune couche √† afficher.\", \"gl-layer-manager__empty\");\r\n                } else {\r\n                    const emptyEl = global.L.DomUtil.create(\"div\", \"gl-layer-manager__empty\", bodyEl);\r\n                    emptyEl.textContent = \"Aucune couche √† afficher.\";\r\n                }\r\n                return;\r\n            }\r\n\r\n            // Filtrer les sections legacy \"poi\" et \"route\" (obsol√®tes)\r\n            const filteredSections = sections.filter(s => s.id !== \"poi\" && s.id !== \"route\");\r\n\r\n            filteredSections.forEach((section) => {\r\n                const isCollapsible = typeof section.collapsedByDefault === 'boolean';\r\n                const isCollapsed = section.collapsedByDefault === true;\r\n\r\n                const sectionEl = global.L.DomUtil.create(\r\n                    \"div\",\r\n                    isCollapsible ? \"gl-layer-manager__section gl-layer-manager__section--accordion\" : \"gl-layer-manager__section\",\r\n                    bodyEl\r\n                );\r\n\r\n                if (isCollapsed) {\r\n                    sectionEl.classList.add(\"gl-layer-manager__section--collapsed\");\r\n                }\r\n\r\n                if (section.label) {\r\n                    if (isCollapsible) {\r\n                        // En-t√™te cliquable pour accord√©on\r\n                        const accordionHeader = global.L.DomUtil.create(\r\n                            \"div\",\r\n                            \"gl-layer-manager__accordion-header\",\r\n                            sectionEl\r\n                        );\r\n\r\n                        const sectionTitle = global.L.DomUtil.create(\r\n                            \"div\",\r\n                            \"gl-layer-manager__section-title\",\r\n                            accordionHeader\r\n                        );\r\n                        sectionTitle.textContent = section.label;\r\n\r\n                        const accordionArrow = global.L.DomUtil.create(\r\n                            \"span\",\r\n                            \"gl-layer-manager__accordion-arrow\",\r\n                            accordionHeader\r\n                        );\r\n                        accordionArrow.textContent = \"‚ñ∂\";\r\n\r\n                        // Gestionnaire de clic pour l'accord√©on\r\n                        global.L.DomEvent.on(accordionHeader, \"click\", function(ev) {\r\n                            global.L.DomEvent.stopPropagation(ev);\r\n                            global.L.DomEvent.preventDefault(ev);\r\n\r\n                            const wasCollapsed = sectionEl.classList.contains(\"gl-layer-manager__section--collapsed\");\r\n                            sectionEl.classList.toggle(\"gl-layer-manager__section--collapsed\");\r\n\r\n                            // Mettre √† jour la fl√®che avec animation\r\n                            accordionArrow.textContent = wasCollapsed ? \"‚ñº\" : \"‚ñ∂\";\r\n\r\n                            // Mettre √† jour l'√©tat dans la section\r\n                            section._isExpanded = wasCollapsed;\r\n\r\n                            if (Log) Log.debug(\"[LayerManager] Accord√©on\", section.id, wasCollapsed ? \"ouvert\" : \"ferm√©\");\r\n                        });\r\n                    } else {\r\n                        // Titre simple pour section non-accord√©on\r\n                        const sectionTitle = global.L.DomUtil.create(\r\n                            \"div\",\r\n                            \"gl-layer-manager__section-title\",\r\n                            sectionEl\r\n                        );\r\n                        sectionTitle.textContent = section.label;\r\n                    }\r\n                }\r\n\r\n                // Si pas d'items, garder la section visible avec son titre seulement\r\n                if (!Array.isArray(section.items) || section.items.length === 0) {\r\n                    return;\r\n                }\r\n\r\n                // Cr√©er le corps de la section (accord√©on ou simple)\r\n                const sectionBody = isCollapsible ?\r\n                    global.L.DomUtil.create(\"div\", \"gl-layer-manager__accordion-body\", sectionEl) :\r\n                    sectionEl;\r\n\r\n                // Section basemap : d√©l√©guer au BasemapSelector\r\n                if (section.id === \"basemap\") {\r\n                    if (GeoLeaf._LayerManagerBasemapSelector) {\r\n                        GeoLeaf._LayerManagerBasemapSelector.render(section, sectionBody);\r\n                    }\r\n                } else {\r\n                    // Autres sections : rendre les items\r\n                    this._renderItems(section, sectionBody);\r\n                }\r\n            });\r\n\r\n            // Synchroniser imm√©diatement les boutons de labels apr√®s re-render\r\n            if (GeoLeaf._LabelButtonManager && GeoLeaf._GeoJSONLayerManager) {\r\n                const allLayers = GeoLeaf._GeoJSONLayerManager._layers || new Map();\r\n                allLayers.forEach((layerData, layerId) => {\r\n                    if (layerData.currentStyle) {\r\n                        GeoLeaf._LabelButtonManager.syncImmediate(layerId);\r\n                    }\r\n                });\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Synchronise l'√©tat des toggles existants sans re-g√©n√©rer le DOM\r\n         * Utilis√© apr√®s l'application d'un th√®me pour mettre √† jour les toggles\r\n         * @public\r\n         */\r\n        syncToggles() {\r\n            // Trouver tous les items de couche dans le DOM\r\n            const layerItems = document.querySelectorAll('[data-layer-id]');\r\n\r\n            if (Log) Log.debug(`[LayerManager Renderer] Synchronisation de ${layerItems.length} toggles`);\r\n\r\n            layerItems.forEach(itemEl => {\r\n                const layerId = itemEl.getAttribute('data-layer-id');\r\n                if (!layerId) return;\r\n\r\n                // R√©cup√©rer les infos de visibilit√© pour le log\r\n                const layerData = global.GeoLeaf?.GeoJSON?.getLayerById(layerId);\r\n                const isVisible = this._checkLayerVisibility(layerId);\r\n\r\n                if (Log) Log.debug(`[LayerManager Renderer] Couche ${layerId}:`, {\r\n                    isVisible,\r\n                    hasLayerData: !!layerData,\r\n                    hasVisibility: !!(layerData && layerData._visibility),\r\n                    currentValue: layerData?._visibility?.current,\r\n                    onMap: layerData?.layer ? global.GeoLeaf._GeoJSONShared?.state?.map?.hasLayer(layerData.layer) : false\r\n                });\r\n\r\n                // Mettre √† jour la classe gl-layer--hidden\r\n                if (isVisible) {\r\n                    itemEl.classList.remove('gl-layer--hidden');\r\n                } else {\r\n                    itemEl.classList.add('gl-layer--hidden');\r\n                }\r\n\r\n                // Trouver et mettre √† jour le toggle button\r\n                const toggleBtn = itemEl.querySelector('.gl-layer-manager__item-toggle');\r\n                if (toggleBtn) {\r\n                    toggleBtn.setAttribute('aria-pressed', isVisible ? 'true' : 'false');\r\n\r\n                    // Harmoniser avec createToggleButton: suffixe \"--on\"\r\n                    const onClass = 'gl-layer-manager__item-toggle--on';\r\n                    if (isVisible) {\r\n                        toggleBtn.classList.add(onClass);\r\n                    } else {\r\n                        toggleBtn.classList.remove(onClass);\r\n                    }\r\n                }\r\n            });\r\n\r\n            if (Log) Log.debug(\"[LayerManager Renderer] √âtats des toggles synchronis√©s\");\r\n        },\r\n\r\n        /**\r\n         * Rend les items d'une section\r\n         * @private\r\n         */\r\n        _renderItems(section, sectionEl) {\r\n            const listEl = global.L.DomUtil.create(\r\n                \"div\",\r\n                \"gl-layer-manager__items\",\r\n                sectionEl\r\n            );\r\n\r\n            section.items.forEach((item) => {\r\n                const itemEl = global.L.DomUtil.create(\r\n                    \"div\",\r\n                    \"gl-layer-manager__item\",\r\n                    listEl\r\n                );\r\n\r\n                // Ajouter l'attribut data-layer-id pour faciliter la recherche DOM\r\n                if (item.id) {\r\n                    itemEl.setAttribute(\"data-layer-id\", item.id);\r\n\r\n                    // Ajouter la classe gl-layer--hidden si la couche n'est pas visible au chargement\r\n                    const isVisible = this._checkLayerVisibility(item.id);\r\n                    if (!isVisible) {\r\n                        itemEl.classList.add(\"gl-layer--hidden\");\r\n                    }\r\n                }\r\n\r\n                // Conteneur de la ligne principale (toujours cr√©√© pour le layout en colonne)\r\n                const mainRow = global.L.DomUtil.create(\"div\", \"gl-layer-manager__item-row\", itemEl);\r\n\r\n                // Libell√©\r\n                const labelEl = global.L.DomUtil.create(\r\n                    \"span\",\r\n                    \"gl-layer-manager__label\",\r\n                    mainRow\r\n                );\r\n                labelEl.textContent = item.label || \"\";\r\n\r\n                // Toggle d'affichage pour les couches toggleable\r\n                if (item.toggleable && item.id) {\r\n                    this._renderToggleControls(item, mainRow, itemEl);\r\n                } else if (item.id) {\r\n                    // M√™me pour les couches non-toggleable, cr√©er le bouton label\r\n                    const controlsContainer = global.L.DomUtil.create(\r\n                        \"div\",\r\n                        \"gl-layer-manager__item-controls\",\r\n                        mainRow\r\n                    );\r\n\r\n                    // Cr√©er le bouton de label\r\n                    if (global.GeoLeaf && global.GeoLeaf._LabelButtonManager) {\r\n                        global.GeoLeaf._LabelButtonManager.createButton(item.id, controlsContainer);\r\n                        global.GeoLeaf._LabelButtonManager.syncImmediate(item.id);\r\n                    }\r\n                } else {\r\n                    // Valeur/info compl√©mentaire pour items sans ID\r\n                    if (typeof item.value !== \"undefined\") {\r\n                        const valueEl = global.L.DomUtil.create(\r\n                            \"span\",\r\n                            \"gl-layer-manager__value\",\r\n                            itemEl\r\n                        );\r\n                        valueEl.textContent = String(item.value);\r\n                    }\r\n                }\r\n            });\r\n        },\r\n\r\n        /**\r\n         * Rend les contr√¥les toggle pour un item\r\n         * @private\r\n         */\r\n        _renderToggleControls(item, mainRow, itemEl) {\r\n            // Conteneur des contr√¥les (toggle + fl√®che th√®me)\r\n            const controlsContainer = global.L.DomUtil.create(\r\n                \"div\",\r\n                \"gl-layer-manager__item-controls\",\r\n                mainRow\r\n            );\r\n\r\n            // Cr√©er le bouton de label via le gestionnaire centralis√©\r\n            if (global.GeoLeaf && global.GeoLeaf._LabelButtonManager) {\r\n                global.GeoLeaf._LabelButtonManager.createButton(item.id, controlsContainer);\r\n                global.GeoLeaf._LabelButtonManager.syncImmediate(item.id);\r\n            }\r\n\r\n            // V√©rifier l'√©tat initial\r\n            const isActive = this._checkLayerVisibility(item.id);\r\n\r\n            const toggleBtn = GeoLeaf._UIComponents && typeof GeoLeaf._UIComponents.createToggleButton === 'function'\r\n                ? GeoLeaf._UIComponents.createToggleButton(controlsContainer, {\r\n                    isActive: isActive,\r\n                    className: \"gl-layer-manager__item-toggle\",\r\n                    title: \"Afficher / masquer la couche\"\r\n                })\r\n                : this._createToggleFallback(controlsContainer, isActive);\r\n\r\n            // Attacher le gestionnaire de toggle\r\n            this._attachToggleHandler(toggleBtn, item.id);\r\n\r\n            // S√©lecteur de styles si disponible\r\n            if (item.styles && GeoLeaf._LayerManagerStyleSelector) {\r\n                const styleElement = GeoLeaf._LayerManagerStyleSelector.renderDOM(item);\r\n                if (styleElement) {\r\n                    itemEl.appendChild(styleElement);\r\n                    GeoLeaf._LayerManagerStyleSelector.bindEvents(styleElement, item);\r\n                }\r\n            }\r\n        },\r\n\r\n        /**\r\n         * V√©rifie si une couche est visible\r\n         * @private\r\n         */\r\n        _checkLayerVisibility(layerId) {\r\n            try {\r\n                if (layerId && global.GeoLeaf && global.GeoLeaf.GeoJSON && typeof global.GeoLeaf.GeoJSON.getLayerById === \"function\") {\r\n                    const layerData = global.GeoLeaf.GeoJSON.getLayerById(layerId);\r\n\r\n                    // IMPORTANT: Utiliser logicalState (√©tat du bouton ON/OFF) au lieu de current (√©tat physique sur carte)\r\n                    // Le bouton doit refl√©ter l'intention de l'utilisateur/th√®me, pas les contraintes de zoom\r\n                    const logicalState = layerData && layerData._visibility && typeof layerData._visibility.logicalState === 'boolean'\r\n                        ? layerData._visibility.logicalState\r\n                        : (layerData && layerData.visible === true);\r\n\r\n                    const result = logicalState;\r\n\r\n                    if (Log) {\r\n                        Log.debug(`[LayerManager Renderer] _checkLayerVisibility(${layerId}): logicalState=${logicalState}`);\r\n                    }\r\n\r\n                    return result;\r\n                }\r\n            } catch (e) {\r\n                if (Log) Log.error(\"[LayerManager Renderer] Erreur dans _checkLayerVisibility:\", e);\r\n            }\r\n            return false;\r\n        },\r\n\r\n        /**\r\n         * Attache le gestionnaire de toggle pour une couche\r\n         * @private\r\n         */\r\n        _attachToggleHandler(toggleBtn, itemId) {\r\n            // GUARD: V√©rifier si un gestionnaire est d√©j√† attach√©\r\n            if (toggleBtn._toggleHandlerAttached) {\r\n                return;\r\n            }\r\n\r\n            // Marquer comme attach√© AVANT de cr√©er le gestionnaire\r\n            toggleBtn._toggleHandlerAttached = true;\r\n\r\n            const self = this;\r\n\r\n            const onToggle = function (ev) {\r\n                // EMP√äCHER LES MULTIPLES CLICS EN PREMIER\r\n                if (toggleBtn._isToggling) {\r\n                    if (Log) Log.warn(\"[LayerManager] ‚è∏Ô∏è Toggle D√âJ√Ä en cours, BLOQU√â:\", itemId);\r\n                    if (global.L && global.L.DomEvent) {\r\n                        global.L.DomEvent.stopPropagation(ev);\r\n                        global.L.DomEvent.preventDefault(ev);\r\n                    }\r\n                    return; // SORTIR IMM√âDIATEMENT\r\n                }\r\n\r\n                // Marquer comme en cours IMM√âDIATEMENT\r\n                toggleBtn._isToggling = true;\r\n\r\n                // Arr√™ter la propagation\r\n                if (global.L && global.L.DomEvent) {\r\n                    global.L.DomEvent.stopPropagation(ev);\r\n                    global.L.DomEvent.preventDefault(ev);\r\n                }\r\n\r\n                // R√©initialiser apr√®s 100ms (juste pour emp√™cher les double-clics rapides)\r\n                setTimeout(() => {\r\n                    toggleBtn._isToggling = false;\r\n                }, 100);\r\n\r\n                try {\r\n                    if (itemId && global.GeoLeaf && global.GeoLeaf.GeoJSON) {\r\n                        const layerData = global.GeoLeaf.GeoJSON.getLayerById(itemId);\r\n\r\n                        // Si la couche n'est pas encore charg√©e, la charger √† la demande\r\n                        if (!layerData) {\r\n                            if (Log) Log.info(\"[LayerManager] ‚è≥ Couche non charg√©e, chargement √† la demande:\", itemId);\r\n\r\n                            // Indicateur visuel de chargement\r\n                            toggleBtn.classList.add(\"gl-layer-manager__item-toggle--loading\");\r\n                            toggleBtn.disabled = true;\r\n\r\n                            const ThemeApplier = global.GeoLeaf._ThemeApplier;\r\n                            if (ThemeApplier && typeof ThemeApplier._loadLayerFromProfile === \"function\") {\r\n                                ThemeApplier._loadLayerFromProfile(itemId).then(function (loadedLayer) {\r\n                                    // Retirer l'indicateur de chargement\r\n                                    toggleBtn.classList.remove(\"gl-layer-manager__item-toggle--loading\");\r\n                                    toggleBtn.disabled = false;\r\n\r\n                                    if (loadedLayer) {\r\n                                        if (Log) Log.info(\"[LayerManager] ‚úÖ Couche charg√©e avec succ√®s:\", itemId);\r\n\r\n                                        // Afficher la couche via le gestionnaire standard\r\n                                        global.GeoLeaf.GeoJSON.showLayer(itemId);\r\n\r\n                                        // Mettre √† jour l'UI du toggle\r\n                                        toggleBtn.setAttribute(\"aria-pressed\", \"true\");\r\n                                        toggleBtn.classList.add(\"gl-layer-manager__item-toggle--on\");\r\n\r\n                                        const layerItem = document.querySelector('[data-layer-id=\"' + itemId + '\"]');\r\n                                        if (layerItem) {\r\n                                            layerItem.classList.remove(\"gl-layer--hidden\");\r\n                                        }\r\n\r\n                                        // R√©activer le bouton label si applicable\r\n                                        let labelBtn = null;\r\n                                        if (layerItem) {\r\n                                            labelBtn = layerItem.querySelector('.gl-layer-manager__label-toggle');\r\n                                        }\r\n                                        if (!labelBtn && toggleBtn.parentElement) {\r\n                                            labelBtn = toggleBtn.parentElement.querySelector('.gl-layer-manager__label-toggle');\r\n                                        }\r\n                                        if (labelBtn) {\r\n                                            const ld = global.GeoLeaf?.GeoJSON?.getLayerById?.(itemId);\r\n                                            const labelEnabled = ld?.currentStyle?.label?.enabled === true;\r\n                                            if (labelEnabled) {\r\n                                                labelBtn.disabled = false;\r\n                                                labelBtn.classList.remove(\"gl-layer-manager__label-toggle--disabled\");\r\n                                            }\r\n                                        }\r\n                                    } else {\r\n                                        if (Log) Log.warn(\"[LayerManager] ‚ùå √âchec du chargement de la couche:\", itemId);\r\n                                    }\r\n                                }).catch(function (err) {\r\n                                    toggleBtn.classList.remove(\"gl-layer-manager__item-toggle--loading\");\r\n                                    toggleBtn.disabled = false;\r\n                                    if (Log) Log.error(\"[LayerManager] Erreur lors du chargement de la couche:\", itemId, err);\r\n                                });\r\n                            } else {\r\n                                toggleBtn.classList.remove(\"gl-layer-manager__item-toggle--loading\");\r\n                                toggleBtn.disabled = false;\r\n                                if (Log) Log.warn(\"[LayerManager] ThemeApplier non disponible pour charger:\", itemId);\r\n                            }\r\n                            return;\r\n                        }\r\n\r\n                        const isCurrentlyVisible = self._checkLayerVisibility(itemId);\r\n\r\n                        // Trouver le layerItem pour ajouter/retirer la classe CSS\r\n                        const layerItem = document.querySelector(`[data-layer-id=\"${itemId}\"]`);\r\n\r\n                        if (isCurrentlyVisible) {\r\n                            // Masquer la couche\r\n                            global.GeoLeaf.GeoJSON.hideLayer(itemId);\r\n                            toggleBtn.setAttribute(\"aria-pressed\", \"false\");\r\n                            toggleBtn.classList.remove(\"gl-layer-manager__item-toggle--on\");\r\n\r\n                            // Ajouter la classe gl-layer--hidden\r\n                            if (layerItem) {\r\n                                layerItem.classList.add(\"gl-layer--hidden\");\r\n                            }\r\n\r\n                            // D√©sactiver imm√©diatement le bouton label (couche cach√©e)\r\n                            // Chercher dans tout le layerItem, pas juste les enfants directs\r\n                            let labelBtn = null;\r\n                            if (layerItem) {\r\n                                labelBtn = layerItem.querySelector('.gl-layer-manager__label-toggle');\r\n                            }\r\n                            // Fallback: chercher via le sibling du toggle button (m√™me container)\r\n                            if (!labelBtn && toggleBtn.parentElement) {\r\n                                labelBtn = toggleBtn.parentElement.querySelector('.gl-layer-manager__label-toggle');\r\n                            }\r\n                            if (labelBtn) {\r\n                                labelBtn.disabled = true;\r\n                                labelBtn.classList.add(\"gl-layer-manager__label-toggle--disabled\");\r\n                                labelBtn.classList.remove(\"gl-layer-manager__label-toggle--on\");\r\n                                labelBtn.setAttribute(\"aria-pressed\", \"false\");\r\n                            } else {\r\n                                if (Log) Log.warn(\"[LayerManager] Bouton label NON TROUV√â pour d√©sactivation:\", itemId);\r\n                            }\r\n                        } else {\r\n                            // Afficher la couche\r\n                            global.GeoLeaf.GeoJSON.showLayer(itemId);\r\n                            toggleBtn.setAttribute(\"aria-pressed\", \"true\");\r\n                            toggleBtn.classList.add(\"gl-layer-manager__item-toggle--on\");\r\n\r\n                            // Retirer la classe gl-layer--hidden\r\n                            if (layerItem) {\r\n                                layerItem.classList.remove(\"gl-layer--hidden\");\r\n                            }\r\n\r\n                            // R√©activer le bouton label\r\n                            let labelBtn = null;\r\n                            if (layerItem) {\r\n                                labelBtn = layerItem.querySelector('.gl-layer-manager__label-toggle');\r\n                            }\r\n                            if (!labelBtn && toggleBtn.parentElement) {\r\n                                labelBtn = toggleBtn.parentElement.querySelector('.gl-layer-manager__label-toggle');\r\n                            }\r\n                            if (labelBtn) {\r\n                                // V√©rifier si label.enabled dans le style avant de r√©activer\r\n                                const ld = global.GeoLeaf?.GeoJSON?.getLayerById?.(itemId);\r\n                                const labelEnabled = ld?.currentStyle?.label?.enabled === true;\r\n                                if (labelEnabled) {\r\n                                    labelBtn.disabled = false;\r\n                                    labelBtn.classList.remove(\"gl-layer-manager__label-toggle--disabled\");\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                } catch (err) {\r\n                    if (Log) Log.warn(\"Erreur toggle l√©gende :\", err);\r\n                }\r\n            };\r\n\r\n            // TEMPORAIREMENT: utiliser uniquement L.DomEvent pour d√©boguer\r\n            if (global.L && global.L.DomEvent) {\r\n                global.L.DomEvent.on(toggleBtn, \"click\", onToggle);\r\n                global.L.DomEvent.disableClickPropagation(toggleBtn);\r\n            } else {\r\n                toggleBtn.addEventListener(\"click\", onToggle);\r\n            }\r\n\r\n            // Ancienne version avec _UIComponents (d√©sactiv√© pour debug)\r\n            // if (GeoLeaf._UIComponents && typeof GeoLeaf._UIComponents.attachEventHandler === 'function') {\r\n            //     GeoLeaf._UIComponents.attachEventHandler(toggleBtn, \"click\", onToggle);\r\n            // } else if (global.L && global.L.DomEvent) {\r\n            //     global.L.DomEvent.on(toggleBtn, \"click\", onToggle);\r\n            // } else {\r\n            //     toggleBtn.addEventListener(\"click\", onToggle);\r\n            // }\r\n        },\r\n\r\n        /**\r\n         * Fallback pour cr√©er un toggle button si _UIComponents non disponible\r\n         * @private\r\n         */\r\n        _createToggleFallback(container, isActive) {\r\n            const toggleBtn = global.L.DomUtil.create(\"button\", \"gl-layer-manager__item-toggle\", container);\r\n            toggleBtn.type = \"button\";\r\n            toggleBtn.setAttribute(\"aria-pressed\", isActive ? \"true\" : \"false\");\r\n            toggleBtn.title = \"Afficher / masquer la couche\";\r\n            if (isActive) {\r\n                toggleBtn.classList.add(\"gl-layer-manager__item-toggle--on\");\r\n            }\r\n            return toggleBtn;\r\n        },\r\n\r\n        /**\r\n         * Cr√©e le bouton de labels pour une couche (appel√© lors de l'application d'un style)\r\n         * @param {string} layerId - ID de la couche\r\n         */\r\n    };\r\n\r\n    // Exposer dans l'espace de noms interne\r\n    GeoLeaf._LayerManagerRenderer = _LayerManagerRenderer;\r\n\r\n})(window);\r\n","/**\r\n * Module LayerManager - Cache Section\r\n *\r\n * Ajoute une section de gestion du cache offline dans le gestionnaire de couches.\r\n * Permet de t√©l√©charger/effacer le cache du profil actif.\r\n *\r\n * @module GeoLeaf.LayerManager.CacheSection\r\n * @version 3.0.0\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    const Log = GeoLeaf.Log;\r\n\r\n    /**\r\n     * Module de section cache pour la l√©gende\r\n     */\r\n    const CacheSection = {\r\n        /**\r\n         * G√©n√®re la section HTML du cache\r\n         *\r\n         * @returns {Object} Section configuration\r\n         */\r\n        generateSection() {\r\n            return {\r\n                id: \"offline-cache\",\r\n                label: \"üì• Cache Hors Ligne\",\r\n                order: 98,\r\n                collapsedByDefault: false,\r\n                customContent: this._generateContent(),\r\n                init: () => this._attachEventListeners()\r\n            };\r\n        },\r\n\r\n        /**\r\n         * G√©n√®re le contenu HTML\r\n         * @private\r\n         */\r\n        _generateContent() {\r\n            return `\r\n                <div class=\"gl-cache-section\">\r\n                    <div class=\"gl-cache-status\">\r\n                        <div class=\"gl-cache-status__header\">\r\n                            <span class=\"gl-cache-status__icon\">üíæ</span>\r\n                            <span class=\"gl-cache-status__label\">Statut</span>\r\n                        </div>\r\n                        <div class=\"gl-cache-status__info\">\r\n                            <div class=\"gl-cache-status__row\">\r\n                                <span class=\"gl-cache-status__key\">Profil:</span>\r\n                                <span class=\"gl-cache-status__value\" id=\"gl-cache-profile\">-</span>\r\n                            </div>\r\n                            <div class=\"gl-cache-status__row\">\r\n                                <span class=\"gl-cache-status__key\">√âtat:</span>\r\n                                <span class=\"gl-cache-status__value\" id=\"gl-cache-state\">Non t√©l√©charg√©</span>\r\n                            </div>\r\n                            <div class=\"gl-cache-status__row\">\r\n                                <span class=\"gl-cache-status__key\">Taille:</span>\r\n                                <span class=\"gl-cache-status__value\" id=\"gl-cache-size\">0 MB</span>\r\n                            </div>\r\n                            <div class=\"gl-cache-status__row\">\r\n                                <span class=\"gl-cache-status__key\">Quota:</span>\r\n                                <span class=\"gl-cache-status__value\" id=\"gl-cache-quota\">0 MB disponible</span>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div class=\"gl-cache-actions\">\r\n                        <button\r\n                            id=\"gl-cache-download\"\r\n                            class=\"gl-btn gl-btn--primary gl-cache-btn\"\r\n                            title=\"T√©l√©charger le profil pour usage offline\">\r\n                            <span class=\"gl-btn__icon\">‚¨áÔ∏è</span>\r\n                            <span class=\"gl-btn__text\">T√©l√©charger profil</span>\r\n                        </button>\r\n\r\n                        <button\r\n                            id=\"gl-cache-clear\"\r\n                            class=\"gl-btn gl-btn--secondary gl-cache-btn\"\r\n                            title=\"Effacer le cache du profil\"\r\n                            disabled>\r\n                            <span class=\"gl-btn__icon\">üóëÔ∏è</span>\r\n                            <span class=\"gl-btn__text\">Vider cache</span>\r\n                        </button>\r\n                    </div>\r\n\r\n                    <div class=\"gl-cache-progress\" id=\"gl-cache-progress\" style=\"display: none;\">\r\n                        <div class=\"gl-cache-progress__bar\">\r\n                            <div class=\"gl-cache-progress__fill\" id=\"gl-cache-progress-fill\"></div>\r\n                        </div>\r\n                        <div class=\"gl-cache-progress__text\" id=\"gl-cache-progress-text\">\r\n                            T√©l√©chargement en cours...\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            `;\r\n        },\r\n\r\n        /**\r\n         * Attache les event listeners\r\n         * @private\r\n         */\r\n        _attachEventListeners() {\r\n            const downloadBtn = document.getElementById(\"gl-cache-download\");\r\n            const clearBtn = document.getElementById(\"gl-cache-clear\");\r\n\r\n            if (downloadBtn) {\r\n                downloadBtn.addEventListener(\"click\", () => this._handleDownload());\r\n            }\r\n\r\n            if (clearBtn) {\r\n                clearBtn.addEventListener(\"click\", () => this._handleClear());\r\n            }\r\n\r\n            // Mettre √† jour le statut initial\r\n            this._updateStatus();\r\n\r\n            // √âcouter les √©v√©nements de cache\r\n            document.addEventListener(\"geoleaf:cache:completed\", () => this._updateStatus());\r\n            document.addEventListener(\"geoleaf:cache:cleared\", () => this._updateStatus());\r\n            document.addEventListener(\"geoleaf:profile:loaded\", () => this._updateStatus());\r\n        },\r\n\r\n        /**\r\n         * Met √† jour l'affichage du statut\r\n         * @private\r\n         */\r\n        async _updateStatus() {\r\n            if (!GeoLeaf.Storage || !GeoLeaf.Storage.isAvailable()) {\r\n                return;\r\n            }\r\n\r\n            try {\r\n                const profileId = GeoLeaf.Config.get(\"data.activeProfile\", \"\");\r\n                const status = await GeoLeaf.Storage.CacheManager.getCacheStatus(profileId);\r\n                const quota = await GeoLeaf.Storage.CacheManager.getStorageQuota();\r\n\r\n                // Mettre √† jour les √©l√©ments DOM\r\n                const profileEl = document.getElementById(\"gl-cache-profile\");\r\n                const stateEl = document.getElementById(\"gl-cache-state\");\r\n                const sizeEl = document.getElementById(\"gl-cache-size\");\r\n                const quotaEl = document.getElementById(\"gl-cache-quota\");\r\n                const clearBtn = document.getElementById(\"gl-cache-clear\");\r\n\r\n                if (profileEl) profileEl.textContent = profileId || \"-\";\r\n\r\n                if (status && status.resourcesCount > 0) {\r\n                    if (stateEl) {\r\n                        stateEl.textContent = \"‚úÖ T√©l√©charg√©\";\r\n                        stateEl.style.color = \"#22c55e\";\r\n                    }\r\n                    if (sizeEl) {\r\n                        sizeEl.textContent = `${(status.totalSize / 1024 / 1024).toFixed(2)} MB`;\r\n                    }\r\n                    if (clearBtn) clearBtn.disabled = false;\r\n                } else {\r\n                    if (stateEl) {\r\n                        stateEl.textContent = \"‚ùå Non t√©l√©charg√©\";\r\n                        stateEl.style.color = \"#ef4444\";\r\n                    }\r\n                    if (sizeEl) sizeEl.textContent = \"0 MB\";\r\n                    if (clearBtn) clearBtn.disabled = true;\r\n                }\r\n\r\n                if (quotaEl) {\r\n                    quotaEl.textContent = `${(quota.available / 1024 / 1024).toFixed(2)} MB disponible`;\r\n                }\r\n\r\n            } catch (error) {\r\n                Log.error(`[CacheSection] Failed to update status: ${error.message}`);\r\n            }\r\n        },\r\n\r\n        /**\r\n         * G√®re le t√©l√©chargement du profil\r\n         * @private\r\n         */\r\n        async _handleDownload() {\r\n            if (!GeoLeaf.Storage || !GeoLeaf.Storage.isAvailable()) {\r\n                if (GeoLeaf.UI && GeoLeaf.UI.Notifications) {\r\n                    GeoLeaf.UI.Notifications.error(\r\n                        \"Stockage offline non disponible\",\r\n                        5000\r\n                    );\r\n                }\r\n                return;\r\n            }\r\n\r\n            const profileId = GeoLeaf.Config.get(\"data.activeProfile\", \"\");\r\n            if (!profileId) {\r\n                if (GeoLeaf.UI && GeoLeaf.UI.Notifications) {\r\n                    GeoLeaf.UI.Notifications.error(\r\n                        \"Aucun profil actif\",\r\n                        3000\r\n                    );\r\n                }\r\n                return;\r\n            }\r\n\r\n            const downloadBtn = document.getElementById(\"gl-cache-download\");\r\n            const progressEl = document.getElementById(\"gl-cache-progress\");\r\n            const progressText = document.getElementById(\"gl-cache-progress-text\");\r\n\r\n            try {\r\n                // D√©sactiver le bouton\r\n                if (downloadBtn) {\r\n                    downloadBtn.disabled = true;\r\n                    downloadBtn.querySelector(\".gl-btn__text\").textContent = \"T√©l√©chargement...\";\r\n                }\r\n\r\n                // Afficher la barre de progression\r\n                if (progressEl) progressEl.style.display = \"block\";\r\n                if (progressText) progressText.textContent = \"Pr√©paration...\";\r\n\r\n                Log.info(`[CacheSection] Starting download for profile: ${profileId}`);\r\n\r\n                // T√©l√©charger le profil\r\n                const result = await GeoLeaf.Storage.downloadProfileForOffline(profileId);\r\n\r\n                if (progressText) {\r\n                    progressText.textContent = `‚úÖ ${result.resourcesCount} ressources t√©l√©charg√©es`;\r\n                }\r\n\r\n                // Notification de succ√®s\r\n                if (GeoLeaf.UI && GeoLeaf.UI.Notifications) {\r\n                    GeoLeaf.UI.Notifications.success(\r\n                        `Profil t√©l√©charg√© : ${(result.totalSize / 1024 / 1024).toFixed(2)} MB`,\r\n                        4000\r\n                    );\r\n                }\r\n\r\n                // Masquer la progression apr√®s 2s\r\n                setTimeout(() => {\r\n                    if (progressEl) progressEl.style.display = \"none\";\r\n                }, 2000);\r\n\r\n                await this._updateStatus();\r\n\r\n            } catch (error) {\r\n                Log.error(`[CacheSection] Download failed: ${error.message}`);\r\n\r\n                if (progressText) progressText.textContent = `‚ùå Erreur: ${error.message}`;\r\n\r\n                if (GeoLeaf.UI && GeoLeaf.UI.Notifications) {\r\n                    GeoLeaf.UI.Notifications.error(\r\n                        `Erreur t√©l√©chargement: ${error.message}`,\r\n                        5000\r\n                    );\r\n                }\r\n\r\n                setTimeout(() => {\r\n                    if (progressEl) progressEl.style.display = \"none\";\r\n                }, 3000);\r\n\r\n            } finally {\r\n                // R√©activer le bouton\r\n                if (downloadBtn) {\r\n                    downloadBtn.disabled = false;\r\n                    downloadBtn.querySelector(\".gl-btn__text\").textContent = \"T√©l√©charger profil\";\r\n                }\r\n            }\r\n        },\r\n\r\n        /**\r\n         * G√®re l'effacement du cache\r\n         * @private\r\n         */\r\n        async _handleClear() {\r\n            if (!GeoLeaf.Storage || !GeoLeaf.Storage.isAvailable()) {\r\n                return;\r\n            }\r\n\r\n            const profileId = GeoLeaf.Config.get(\"data.activeProfile\", \"\");\r\n            if (!profileId) {\r\n                return;\r\n            }\r\n\r\n            // Confirmation\r\n            if (!confirm(`Voulez-vous vraiment effacer le cache du profil \"${profileId}\" ?`)) {\r\n                return;\r\n            }\r\n\r\n            const clearBtn = document.getElementById(\"gl-cache-clear\");\r\n\r\n            try {\r\n                if (clearBtn) {\r\n                    clearBtn.disabled = true;\r\n                    clearBtn.querySelector(\".gl-btn__text\").textContent = \"Effacement...\";\r\n                }\r\n\r\n                Log.info(`[CacheSection] Clearing cache for profile: ${profileId}`);\r\n\r\n                const deleted = await GeoLeaf.Storage.CacheManager.clearCache(profileId);\r\n\r\n                if (GeoLeaf.UI && GeoLeaf.UI.Notifications) {\r\n                    GeoLeaf.UI.Notifications.success(\r\n                        `Cache effac√© : ${deleted} ressources supprim√©es`,\r\n                        3000\r\n                    );\r\n                }\r\n\r\n                await this._updateStatus();\r\n\r\n            } catch (error) {\r\n                Log.error(`[CacheSection] Clear failed: ${error.message}`);\r\n\r\n                if (GeoLeaf.UI && GeoLeaf.UI.Notifications) {\r\n                    GeoLeaf.UI.Notifications.error(\r\n                        `Erreur effacement: ${error.message}`,\r\n                        5000\r\n                    );\r\n                }\r\n            } finally {\r\n                if (clearBtn) {\r\n                    clearBtn.querySelector(\".gl-btn__text\").textContent = \"Vider cache\";\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    // Exposer le module\r\n    GeoLeaf._LayerManagerCacheSection = CacheSection;\r\n\r\n})(window);\r\n","/**\r\n * Module Basemap Selector pour LayerManager\r\n * Gestion du s√©lecteur de fonds de carte\r\n *\r\n * D√âPENDANCES:\r\n * - Leaflet (L.DomUtil, L.DomEvent)\r\n * - GeoLeaf.Log (optionnel)\r\n * - GeoLeaf.Baselayers (optionnel, pour getActiveId et setBaseLayer)\r\n *\r\n * EXPOSE:\r\n * - GeoLeaf._LayerManagerBasemapSelector\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = global.GeoLeaf = global.GeoLeaf || {};\r\n    const Log = GeoLeaf.Log;\r\n\r\n    /**\r\n     * Module Basemap Selector\r\n     * @namespace _LayerManagerBasemapSelector\r\n     * @private\r\n     */\r\n    const _LayerManagerBasemapSelector = {\r\n        /**\r\n         * Rend le s√©lecteur de basemap\r\n         * @param {Object} section - Section basemap avec items\r\n         * @param {HTMLElement} sectionEl - √âl√©ment DOM de la section\r\n         */\r\n        render(section, sectionEl) {\r\n            // Validation des param√®tres\r\n            if (!section || !sectionEl) {\r\n                return;\r\n            }\r\n\r\n            const container = global.L.DomUtil.create(\r\n                \"div\",\r\n                \"gl-layer-manager__items gl-layer-manager__basemap-select\",\r\n                sectionEl\r\n            );\r\n\r\n            const select = global.L.DomUtil.create(\"select\", \"gl-layer-manager__basemap-select__select\", container);\r\n\r\n            // Remplir les options\r\n            if (Array.isArray(section.items)) {\r\n                section.items.forEach(function (item) {\r\n                    if (!item || !item.id) return;\r\n                    const opt = document.createElement(\"option\");\r\n                    opt.value = item.id;\r\n                    opt.textContent = item.label || item.id;\r\n                    select.appendChild(opt);\r\n                });\r\n            }\r\n\r\n            // Valeur initiale -> ID actif des basemaps\r\n            try {\r\n                const activeId = global.GeoLeaf && global.GeoLeaf.Baselayers && typeof global.GeoLeaf.Baselayers.getActiveId === \"function\"\r\n                    ? global.GeoLeaf.Baselayers.getActiveId()\r\n                    : null;\r\n                if (activeId) {\r\n                    select.value = activeId;\r\n                }\r\n            } catch (e) {\r\n                // ignore\r\n            }\r\n\r\n            // Changement par l'utilisateur\r\n            this._attachChangeHandler(select);\r\n\r\n            // √âcouter les changements externes\r\n            this._attachExternalListener(select);\r\n        },\r\n\r\n        /**\r\n         * Attache le gestionnaire de changement au select\r\n         * @private\r\n         */\r\n        _attachChangeHandler(select) {\r\n            const handler = function (ev) {\r\n                if (global.L && global.L.DomEvent) {\r\n                    global.L.DomEvent.stopPropagation(ev);\r\n                }\r\n                try {\r\n                    const val = select.value;\r\n                    if (global.GeoLeaf && global.GeoLeaf.Baselayers && typeof global.GeoLeaf.Baselayers.setBaseLayer === \"function\") {\r\n                        global.GeoLeaf.Baselayers.setBaseLayer(val);\r\n                    }\r\n                } catch (err) {\r\n                    if (Log) Log.warn(\"Erreur lors du changement de basemap depuis la l√©gende:\", err);\r\n                }\r\n            };\r\n\r\n            if (global.L && global.L.DomEvent) {\r\n                global.L.DomEvent.on(select, \"change\", handler);\r\n            } else {\r\n                select.addEventListener(\"change\", handler);\r\n            }\r\n        },\r\n\r\n        /**\r\n         * √âcoute les √©v√©nements de changement de basemap externe\r\n         * @private\r\n         */\r\n        _attachExternalListener(select) {\r\n            if (typeof document !== \"undefined\") {\r\n                document.addEventListener(\"geoleaf:basemap-changed\", function (e) {\r\n                    try {\r\n                        if (e && e.detail && e.detail.id) {\r\n                            select.value = e.detail.id;\r\n                        }\r\n                    } catch (err) {\r\n                        // ignore\r\n                    }\r\n                });\r\n            }\r\n        }\r\n    };\r\n\r\n    // Exposer dans l'espace de noms interne\r\n    GeoLeaf._LayerManagerBasemapSelector = _LayerManagerBasemapSelector;\r\n\r\n})(window);\r\n","/**\r\n * @module _LayerManagerStyleSelector\r\n * @description S√©lecteur de styles pour le gestionnaire de couches.\r\n * Permet de changer dynamiquement le style appliqu√© √† une couche.\r\n * Utilise le nouveau style-loader pour charger et valider les styles.\r\n * @version 3.1.0\r\n */\r\n\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n\r\n    /**\r\n     * √âtat interne du s√©lecteur de styles\r\n     * @private\r\n     */\r\n    const state = {\r\n        currentStyles: new Map() // layerId -> styleId\r\n    };\r\n\r\n    /**\r\n     * Module s√©lecteur de styles pour le gestionnaire de couches\r\n     * @namespace\r\n     */\r\n    GeoLeaf._LayerManagerStyleSelector = {\r\n        /**\r\n         * R√©cup√®re le style actuel d'une couche\r\n         * @param {string} layerId - Identifiant de la couche\r\n         * @returns {string|null} Identifiant du style actuel\r\n         */\r\n        getCurrentStyle: function (layerId) {\r\n            return state.currentStyles.get(layerId) || null;\r\n        },\r\n\r\n        /**\r\n         * D√©finit le style actuel d'une couche\r\n         * @param {string} layerId - Identifiant de la couche\r\n         * @param {string} styleId - Identifiant du style\r\n         */\r\n        setCurrentStyle: function (layerId, styleId) {\r\n            state.currentStyles.set(layerId, styleId);\r\n        },\r\n\r\n        /**\r\n         * G√©n√®re le HTML du s√©lecteur de styles\r\n         * @param {Object} item - Configuration de l'item de couche\r\n         * @param {string} item.id - Identifiant de la couche\r\n         * @param {Object} item.styles - Configuration des styles disponibles\r\n         * @param {Array} item.styles.available - Tableau des styles disponibles\r\n         * @param {string} item.styles.default - Style par d√©faut\r\n         * @returns {string} HTML du s√©lecteur\r\n         * @deprecated Utiliser renderDOM() √† la place\r\n         */\r\n        render: function (item) {\r\n            if (!item.styles || !Array.isArray(item.styles.available) || item.styles.available.length <= 1) {\r\n                return \"\";\r\n            }\r\n\r\n            const currentStyle = this.getCurrentStyle(item.id) || item.styles.default || item.styles.available[0].id;\r\n            const selectId = \"style-selector-\" + item.id;\r\n\r\n            let html = '<div class=\"gl-layer-manager__style-selector\">';\r\n            html += '<select id=\"' + selectId + '\" class=\"gl-layer-manager__style-select\" data-layer-id=\"' + item.id + '\">';\r\n\r\n            item.styles.available.forEach(function (style) {\r\n                const selected = style.id === currentStyle ? ' selected' : '';\r\n                html += '<option value=\"' + style.id + '\"' + selected + '>' + style.label + '</option>';\r\n            });\r\n\r\n            html += '</select>';\r\n            html += '</div>';\r\n\r\n            return html;\r\n        },\r\n\r\n        /**\r\n         * G√©n√®re l'√©l√©ment DOM du s√©lecteur de styles\r\n         * @param {Object} item - Configuration de l'item de couche\r\n         * @param {string} item.id - Identifiant de la couche\r\n         * @param {Object} item.styles - Configuration des styles disponibles\r\n         * @param {Array} item.styles.available - Tableau des styles disponibles\r\n         * @param {string} item.styles.default - Style par d√©faut\r\n         * @returns {HTMLElement|null} √âl√©ment DOM du s√©lecteur ou null\r\n         */\r\n        renderDOM: function (item) {\r\n\t\t\tconst Log = global.GeoLeaf && global.GeoLeaf.Log;\r\n\r\n\t\t\t// ...log supprim√© ([StyleSelector] renderDOM)...\r\n\r\n            if (!item.styles || !Array.isArray(item.styles.available) || item.styles.available.length <= 1) {\r\n                // ...log supprim√© ([StyleSelector] Pas de s√©lecteur n√©cessaire)...\r\n                return null;\r\n            }\r\n\r\n            const currentStyle = this.getCurrentStyle(item.id) || item.styles.default || item.styles.available[0].id;\r\n            const selectId = \"style-selector-\" + item.id;\r\n\r\n            // Cr√©er le conteneur\r\n            const container = document.createElement(\"div\");\r\n            container.className = \"gl-layer-manager__style-selector\";\r\n\r\n            // Cr√©er le select\r\n            const select = document.createElement(\"select\");\r\n            select.id = selectId;\r\n            select.className = \"gl-layer-manager__style-select\";\r\n            select.setAttribute(\"data-layer-id\", item.id);\r\n\r\n            // Ajouter les options\r\n            item.styles.available.forEach(function (style) {\r\n                const option = document.createElement(\"option\");\r\n                option.value = style.id;\r\n                option.textContent = style.label;\r\n                if (style.id === currentStyle) {\r\n                    option.selected = true;\r\n                }\r\n                select.appendChild(option);\r\n            });\r\n\r\n            container.appendChild(select);\r\n            return container;\r\n        },\r\n\r\n        /**\r\n         * Initialise les √©v√©nements du s√©lecteur de styles\r\n         * @param {HTMLElement} container - Conteneur des contr√¥les\r\n         * @param {Object} item - Configuration de l'item de couche\r\n         */\r\n        bindEvents: function (container, item) {\r\n            if (!item.styles || !Array.isArray(item.styles.available) || item.styles.available.length <= 1) {\r\n                return;\r\n            }\r\n\r\n            const selectId = \"style-selector-\" + item.id;\r\n            const select = container.querySelector(\"#\" + selectId);\r\n\r\n            if (!select) {\r\n                return;\r\n            }\r\n\r\n            const self = this;\r\n\r\n            select.addEventListener(\"change\", function () {\r\n                const styleId = this.value;\r\n                const layerId = this.getAttribute(\"data-layer-id\");\r\n\r\n                // Enregistrer le style actuel\r\n                self.setCurrentStyle(layerId, styleId);\r\n\r\n                // Appliquer le style √† la couche\r\n                self.applyStyle(layerId, styleId);\r\n            });\r\n        },\r\n\r\n        /**\r\n         * Applique un style √† une couche\r\n         * Utilise le style-loader pour charger, valider et appliquer le style\r\n         * @param {string} layerId - Identifiant de la couche\r\n         * @param {string} styleId - Identifiant du style\r\n         */\r\n        applyStyle: async function (layerId, styleId) {\r\n\t\t\tconst Log = global.GeoLeaf.Log;\r\n\r\n\t\t\tif (!global.GeoLeaf._GeoJSONLayerManager) {\r\n\t\t\t\t// ...log supprim√© ([StyleSelector] Module GeoJSON non disponible)...\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\t// R√©cup√©rer les donn√©es de la couche\r\n\t\t\tconst layerManager = global.GeoLeaf._GeoJSONLayerManager;\r\n\t\t\tconst layerData = layerManager.getLayerData(layerId);\r\n\r\n\t\t\tif (!layerData) {\r\n\t\t\t\t// ...log supprim√© ([StyleSelector] Couche non trouv√©e)...\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tif (!layerData.config.styles || !Array.isArray(layerData.config.styles.available)) {\r\n\t\t\t\t// ...log supprim√© ([StyleSelector] Aucun style disponible pour la couche)...\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\t// Trouver la configuration du style\r\n\t\t\tconst styleConfig = layerData.config.styles.available.find(function (s) {\r\n\t\t\t\treturn s.id === styleId;\r\n\t\t\t});\r\n\r\n\t\t\tif (!styleConfig) {\r\n\t\t\t\t// ...log supprim√© ([StyleSelector] Style non trouv√©)...\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\t// ...log supprim√© ([StyleSelector] Application du style)...\r\n\r\n            try {\r\n                // V√©rifier que le style-loader est disponible\r\n                const StyleLoader = global.GeoLeaf._StyleLoader;\r\n                if (!StyleLoader) {\r\n                    // ...log supprim√© ([StyleSelector] GeoLeaf._StyleLoader non disponible)...\r\n                    // Fallback vers ancien syst√®me si n√©cessaire\r\n                    this._applyStyleLegacy(layerId, styleId, layerData, styleConfig);\r\n                    return;\r\n                }\r\n\r\n                // R√©cup√©rer les m√©tadonn√©es n√©cessaires\r\n                const profileId = layerData.config._profileId;\r\n                const layerDirectory = layerData.config._layerDirectory;\r\n\r\n                if (!profileId || !layerDirectory) {\r\n                    // ...log supprim√© ([StyleSelector] M√©tadonn√©es manquantes)...\r\n                    return;\r\n                }\r\n\r\n                // Charger et valider le style avec le style-loader\r\n                // ...log supprim√© ([StyleSelector] Chargement du style via style-loader)...\r\n\r\n                const result = await StyleLoader.loadAndValidateStyle(\r\n                    profileId,\r\n                    layerId,\r\n                    styleId,\r\n                    styleConfig.file,\r\n                    layerDirectory\r\n                );\r\n\r\n                // ...log supprim√© ([StyleSelector] Style charg√© et valid√©)...\r\n\r\n                // Stocker le style actuel dans layerData pour que les labels puissent y acc√©der\r\n                layerData.currentStyle = result.styleData;\r\n                layerData.currentStyleMetadata = result.metadata;\r\n\r\n                // Appliquer le style via le GeoJSONLayerManager\r\n                if (typeof layerManager.setLayerStyle === \"function\") {\r\n                    layerManager.setLayerStyle(layerId, result.styleData);\r\n                    // ...log supprim√© ([StyleSelector] Style appliqu√© avec succ√®s)...\r\n                } else {\r\n                    // ...log supprim√© ([StyleSelector] Fonction setLayerStyle non disponible)...\r\n                }\r\n\r\n                // R√©initialiser les labels selon le nouveau style et visibleByDefault\r\n                if (global.GeoLeaf.Labels && typeof global.GeoLeaf.Labels.initializeLayerLabels === 'function') {\r\n                    global.GeoLeaf.Labels.initializeLayerLabels(layerId);\r\n                }\r\n\r\n                // Mettre √† jour l'√©tat du bouton des labels selon le nouveau style\r\n                // Utiliser syncImmediate car currentStyle vient d'√™tre mis √† jour\r\n                if (global.GeoLeaf._LabelButtonManager) {\r\n                    // ...log supprim√© ([StyleSelector] Synchronisation du bouton label)...\r\n                    global.GeoLeaf._LabelButtonManager.syncImmediate(layerId);\r\n                }\r\n\r\n                // Charger la l√©gende correspondante\r\n                if (global.GeoLeaf.Legend && typeof global.GeoLeaf.Legend.loadLayerLegend === \"function\") {\r\n                    global.GeoLeaf.Legend.loadLayerLegend(layerData.config.id, styleId, layerData.config);\r\n                }\r\n\r\n            } catch (error) {\r\n                // ...log supprim√© ([StyleSelector] Erreur lors du chargement/application du style)...\r\n                // ...log supprim√© ([StyleSelector] Stack trace)...\r\n            }\r\n        },\r\n\r\n        /**\r\n         * M√©thode legacy de chargement de style (fallback)\r\n         * @private\r\n         * @deprecated Utiliser applyStyle() avec style-loader √† la place\r\n         */\r\n        _applyStyleLegacy: function (layerId, styleId, layerData, styleConfig) {\r\n            const Log = global.GeoLeaf.Log;\r\n            const layerManager = global.GeoLeaf._GeoJSONLayerManager;\r\n\r\n            // ...log supprim√© ([StyleSelector] Utilisation de la m√©thode legacy)...\r\n\r\n            const profileId = layerData.config._profileId;\r\n            const layerDirectory = layerData.config._layerDirectory;\r\n\r\n            if (!profileId || !layerDirectory) {\r\n                // ...log supprim√© ([StyleSelector] M√©tadonn√©es manquantes)...\r\n                return;\r\n            }\r\n\r\n            const Config = global.GeoLeaf.Config;\r\n            const dataCfg = Config && Config.get ? Config.get('data') : null;\r\n            const profilesBasePath = (dataCfg && dataCfg.profilesBasePath) || \"profiles\";\r\n\r\n            const styleDirectory = layerData.config.styles.directory || \"styles\";\r\n            const stylePath = profilesBasePath + \"/\" + profileId + \"/\" + layerDirectory + \"/\" + styleDirectory + \"/\" + styleConfig.file;\r\n\r\n            // ...log supprim√© ([StyleSelector] Chargement du fichier de style (legacy))...\r\n\r\n            fetch(stylePath)\r\n                .then(function (response) {\r\n                    if (!response.ok) {\r\n                        throw new Error(\"Erreur HTTP \" + response.status);\r\n                    }\r\n                    return response.json();\r\n                })\r\n                .then(function (styleData) {\r\n                    if (typeof layerManager.setLayerStyle === \"function\") {\r\n                        layerManager.setLayerStyle(layerId, styleData);\r\n                        // ...log supprim√© ([StyleSelector] Style appliqu√© avec succ√®s (legacy))...\r\n                    }\r\n\r\n                    if (global.GeoLeaf.Legend && typeof global.GeoLeaf.Legend.loadLayerLegend === \"function\") {\r\n                        global.GeoLeaf.Legend.loadLayerLegend(layerData.config.id, styleId, layerData.config);\r\n                    }\r\n                })\r\n                .catch(function (error) {\r\n                    // ...log supprim√© ([StyleSelector] Erreur lors du chargement du style (legacy))...\r\n                });\r\n        }\r\n    };\r\n\r\n})(window);\r\n","/**\r\n * Module Control pour LayerManager\r\n * D√©finition du contr√¥le Leaflet personnalis√©\r\n *\r\n * D√âPENDANCES:\r\n * - Leaflet (L.Control, L.DomUtil, L.DomEvent, L.setOptions)\r\n * - GeoLeaf.Log (optionnel)\r\n * - GeoLeaf._LayerManagerRenderer (pour renderSections)\r\n *\r\n * EXPOSE:\r\n * - GeoLeaf._LayerManagerControl\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = global.GeoLeaf = global.GeoLeaf || {};\r\n    const Log = GeoLeaf.Log;\r\n\r\n    /**\r\n     * Cr√©e un contr√¥le Leaflet pour le gestionnaire de couches\r\n     * @param {Object} options - Options du contr√¥le\r\n     * @returns {L.Control} - Instance du contr√¥le Leaflet\r\n     */\r\n    function createLayerManagerControl(options) {\r\n        if (!global.L || !global.L.Control) {\r\n            if (Log) Log.error(\"[LayerManager] Leaflet L.Control non disponible\");\r\n            return null;\r\n        }\r\n\r\n        const LayerManagerControl = global.L.Control.extend({\r\n            options: {\r\n                position: options.position || \"bottomright\"\r\n            },\r\n\r\n            initialize: function (controlOptions) {\r\n                global.L.setOptions(this, controlOptions || {});\r\n                this._glOptions = controlOptions._glOptions;\r\n            },\r\n\r\n            onAdd: function (mapInstance) {\r\n                this._map = mapInstance;\r\n                this._container = global.L.DomUtil.create(\"div\", \"gl-layer-manager\");\r\n\r\n                // Emp√™cher les interactions carte\r\n                if (global.L.DomEvent) {\r\n                    global.L.DomEvent.disableClickPropagation(this._container);\r\n                    global.L.DomEvent.disableScrollPropagation(this._container);\r\n                }\r\n\r\n                this._buildStructure();\r\n                return this._container;\r\n            },\r\n\r\n            onRemove: function () {\r\n                this._map = null;\r\n                this._container = null;\r\n            },\r\n\r\n            /**\r\n             * Construit la structure DOM de la l√©gende\r\n             * @private\r\n             */\r\n            _buildStructure: function () {\r\n                const opts = this._glOptions;\r\n\r\n                // Conteneur principal (flex container)\r\n                const mainWrapper = global.L.DomUtil.create(\"div\", \"gl-layer-manager__main-wrapper\", this._container);\r\n\r\n                // Wrapper du header (reste fixe)\r\n                const headerWrapper = global.L.DomUtil.create(\"div\", \"gl-layer-manager__header-wrapper\", mainWrapper);\r\n\r\n                // En-t√™te : titre + bouton collapse\r\n                const header = global.L.DomUtil.create(\"div\", \"gl-layer-manager__header\", headerWrapper);\r\n\r\n                const titleEl = global.L.DomUtil.create(\r\n                    \"div\",\r\n                    \"gl-layer-manager__title\",\r\n                    header\r\n                );\r\n                titleEl.textContent = opts.title || \"L√©gende\";\r\n\r\n                let toggleEl = null;\r\n                if (opts.collapsible) {\r\n                    toggleEl = global.L.DomUtil.create(\r\n                        \"button\",\r\n                        \"gl-layer-manager__toggle\",\r\n                        header\r\n                    );\r\n                    toggleEl.type = \"button\";\r\n                    toggleEl.setAttribute(\"aria-label\", \"Basculer la l√©gende\");\r\n                    toggleEl.textContent = \"‚ü±\";\r\n\r\n                    const self = this;\r\n                    global.L.DomEvent.on(toggleEl, \"click\", function (ev) {\r\n                        global.L.DomEvent.stopPropagation(ev);\r\n                        self._toggleCollapsed();\r\n                    });\r\n                }\r\n\r\n                // Wrapper du body avec scrollbar\r\n                const bodyWrapper = global.L.DomUtil.create(\"div\", \"gl-layer-manager__body-wrapper\", mainWrapper);\r\n\r\n                // Corps de la l√©gende\r\n                this._bodyEl = global.L.DomUtil.create(\r\n                    \"div\",\r\n                    \"gl-layer-manager__body\",\r\n                    bodyWrapper\r\n                );\r\n\r\n                // Appliquer l'√©tat collapsed initial (depuis options ou collapsedByDefault)\r\n                const initialCollapsed = opts.collapsed || opts.collapsedByDefault || false;\r\n                if (initialCollapsed) {\r\n                    this._container.classList.add(\"gl-layer-manager--collapsed\");\r\n                    opts.collapsed = true; // Synchroniser l'√©tat\r\n                }\r\n\r\n                // Rendu des sections via le renderer\r\n                this._renderSections(opts.sections || []);\r\n            },\r\n\r\n            /**\r\n             * Rend les sections (d√©l√®gue au renderer)\r\n             * @private\r\n             */\r\n            _renderSections: function (sections) {\r\n                if (GeoLeaf._LayerManagerRenderer) {\r\n                    GeoLeaf._LayerManagerRenderer.renderSections(this._bodyEl, sections);\r\n                } else {\r\n                    if (Log) Log.error(\"[LayerManager] _LayerManagerRenderer non disponible\");\r\n                }\r\n            },\r\n\r\n            /**\r\n             * Mise √† jour des sections\r\n             * @param {Array} sections - Nouvelles sections\r\n             */\r\n            updateSections: function (sections) {\r\n                this._glOptions.sections = Array.isArray(sections) ? sections : [];\r\n                this._renderSections(this._glOptions.sections);\r\n            },\r\n\r\n            /**\r\n             * Rafra√Æchit l'affichage pour mettre √† jour l'√©tat des boutons toggle\r\n             * Utilis√© notamment apr√®s l'application d'un th√®me\r\n             * @public\r\n             */\r\n            refresh: function () {\r\n                // Synchroniser uniquement les toggles au lieu de re-g√©n√©rer tout le DOM\r\n                if (GeoLeaf._LayerManagerRenderer && typeof GeoLeaf._LayerManagerRenderer.syncToggles === 'function') {\r\n                    GeoLeaf._LayerManagerRenderer.syncToggles();\r\n                } else if (this._glOptions && this._glOptions.sections) {\r\n                    // Fallback: re-g√©n√©rer les sections si syncToggles n'est pas disponible\r\n                    this._renderSections(this._glOptions.sections);\r\n                }\r\n            },\r\n\r\n            /**\r\n             * Bascule l'√©tat collapsed\r\n             * @private\r\n             */\r\n            _toggleCollapsed: function () {\r\n                const isCollapsed = this._container.classList.toggle(\"gl-layer-manager--collapsed\");\r\n                this._glOptions.collapsed = isCollapsed;\r\n            }\r\n        });\r\n\r\n        return new LayerManagerControl({\r\n            position: options.position,\r\n            _glOptions: options\r\n        });\r\n    }\r\n\r\n    // Exposer dans l'espace de noms interne\r\n    GeoLeaf._LayerManagerControl = {\r\n        create: createLayerManagerControl\r\n    };\r\n\r\n})(window);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    /**\r\n     * Namespace global GeoLeaf\r\n     */\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n\r\n    /**\r\n     * Logger unifi√©\r\n     */\r\n    const Log = GeoLeaf.Log;\r\n\r\n    /**\r\n     * Module GeoLeaf.LayerManager (REFACTORIS√â v3.0)\r\n     *\r\n     * ARCHITECTURE MODULAIRE :\r\n     * - layer-manager/shared.js : √âtat partag√©\r\n     * - layer-manager/control.js : Contr√¥le Leaflet (L.Control)\r\n     * - layer-manager/renderer.js : Rendu des sections et items\r\n     * - layer-manager/basemap-selector.js : S√©lecteur de fonds de carte\r\n     * - layer-manager/theme-selector.js : S√©lecteur de th√®mes\r\n     * - geoleaf.layer-manager.js (ce fichier) : Agr√©gateur/fa√ßade publique\r\n     *\r\n     * D√âPENDANCES REQUISES (charg√©es avant ce module) :\r\n     * - layer-manager/shared.js ‚Üí GeoLeaf._LayerManagerShared\r\n     * - layer-manager/renderer.js ‚Üí GeoLeaf._LayerManagerRenderer\r\n     * - layer-manager/basemap-selector.js ‚Üí GeoLeaf._LayerManagerBasemapSelector\r\n     * - layer-manager/theme-selector.js ‚Üí GeoLeaf._LayerManagerThemeSelector\r\n     * - layer-manager/control.js ‚Üí GeoLeaf._LayerManagerControl\r\n     *\r\n     * R√¥le :\r\n     * - Cr√©er un contr√¥le Leaflet de gestionnaire de couches pour GeoLeaf\r\n     * - Afficher des sections structur√©es (basemaps, couches, cat√©gories)\r\n     * - G√©rer un mode repliable (collapsible)\r\n     * - Pr√©paration pour l'int√©gration avec le module Legend (Phase 6)\r\n     */\r\n    const LayerManagerModule = {\r\n        /**\r\n         * R√©f√©rence √† la carte Leaflet\r\n         * @type {L.Map|null}\r\n         * @private\r\n         */\r\n        _map: null,\r\n\r\n        /**\r\n         * R√©f√©rence au contr√¥le Leaflet de l√©gende\r\n         * @type {L.Control|null}\r\n         * @private\r\n         */\r\n        _control: null,\r\n\r\n        /**\r\n         * Timeout pour le debounce du refresh\r\n         * @type {number|null}\r\n         * @private\r\n         */\r\n        _refreshTimeout: null,\r\n\r\n        /**\r\n         * Options internes du module\r\n         * @type {Object}\r\n         * @private\r\n         */\r\n        _options: {\r\n            position: \"bottomright\",\r\n            title: \"Gestionnaire de couches\",\r\n            collapsible: true,\r\n            collapsed: false,\r\n            sections: []\r\n        },\r\n\r\n        /**\r\n         * Initialisation du module LayerManager\r\n         *\r\n         * @param {Object} options\r\n         * @param {L.Map} [options.map] - Carte Leaflet (si absent, tentative via GeoLeaf.Core.getMap())\r\n         * @param {string} [options.position]\r\n         * @param {string} [options.title]\r\n         * @param {boolean} [options.collapsible]\r\n         * @param {boolean} [options.collapsed]\r\n         * @param {Array} [options.sections]\r\n         * @returns {L.Control|null} - Le contr√¥le LayerManager ou null\r\n         */\r\n        init(options = {}) {\r\n            if (typeof global.L === \"undefined\" || !global.L || !global.L.Control) {\r\n                if (Log) Log.error(\"[GeoLeaf.LayerManager] Leaflet (L.Control) est requis mais introuvable.\");\r\n                return null;\r\n            }\r\n\r\n            let map = options.map || null;\r\n\r\n            // Tentative de r√©cup√©ration via GeoLeaf.Core\r\n            if (!map && GeoLeaf.Core && typeof GeoLeaf.Core.getMap === \"function\") {\r\n                map = GeoLeaf.Core.getMap();\r\n            }\r\n\r\n            if (!map) {\r\n                if (Log) Log.error(\"[GeoLeaf.LayerManager] Aucune carte Leaflet disponible. Passe une instance dans init({ map }).\");\r\n                return null;\r\n            }\r\n\r\n            this._map = map;\r\n            if (Log) Log.info(\"[GeoLeaf.LayerManager] init: map assigned\");\r\n\r\n            this._options = this._mergeOptions(this._options, options);\r\n\r\n            // Charger les sections depuis layerManagerConfig si disponibles\r\n            this._loadConfigSections();\r\n\r\n            // Remplir automatiquement la section basemap\r\n            this._autoPopulateBasemap();\r\n\r\n            // Autoremplissage minimal si aucune section\r\n            this._autoPopulateSections();\r\n\r\n            // Cr√©er le contr√¥le Leaflet via le sous-module\r\n            if (!GeoLeaf._LayerManagerControl) {\r\n                if (Log) Log.error(\"[GeoLeaf.LayerManager] Module _LayerManagerControl non charg√©\");\r\n                return null;\r\n            }\r\n\r\n            this._control = GeoLeaf._LayerManagerControl.create(this._options);\r\n\r\n            if (!this._control) {\r\n                if (Log) Log.error(\"[GeoLeaf.LayerManager] √âchec cr√©ation contr√¥le\");\r\n                return null;\r\n            }\r\n\r\n            this._control.addTo(this._map);\r\n\r\n            if (Log) Log.info(\"[GeoLeaf.LayerManager] Contr√¥le cr√©√© et ajout√© √† la carte\");\r\n            return this._control;\r\n        },\r\n\r\n        /**\r\n         * Charge les sections depuis la configuration\r\n         * @private\r\n         */\r\n        _loadConfigSections() {\r\n            if (GeoLeaf.Config && typeof GeoLeaf.Config.get === \"function\") {\r\n                const layerManagerConfig = GeoLeaf.Config.get('layerManagerConfig');\r\n                if (GeoLeaf.Log) GeoLeaf.Log.debug(\"[LayerManager] Configuration charg√©e:\", {\r\n                    title: layerManagerConfig?.title,\r\n                    collapsed: layerManagerConfig?.collapsedByDefault,\r\n                    sectionsCount: layerManagerConfig?.sections?.length || 0\r\n                });\r\n                if (layerManagerConfig) {\r\n                    if (layerManagerConfig.title) {\r\n                        this._options.title = layerManagerConfig.title;\r\n                    }\r\n\r\n                    // Param√®tre global collapsed/collapsedByDefault\r\n                    if (typeof layerManagerConfig.collapsedByDefault === 'boolean') {\r\n                        this._options.collapsed = layerManagerConfig.collapsedByDefault;\r\n                    }\r\n\r\n                    if (Array.isArray(layerManagerConfig.sections) && layerManagerConfig.sections.length > 0) {\r\n                        const configSections = layerManagerConfig.sections\r\n                            .slice()\r\n                            .sort((a, b) => (a.order || 0) - (b.order || 0))\r\n                            .map(s => ({\r\n                                id: s.id,\r\n                                label: s.label,\r\n                                order: s.order,\r\n                                collapsedByDefault: s.collapsedByDefault,\r\n                                items: []\r\n                            }));\r\n\r\n                        if (!Array.isArray(this._options.sections)) {\r\n                            this._options.sections = [];\r\n                        }\r\n\r\n                        configSections.forEach(configSection => {\r\n                            const existingSection = this._options.sections.find(s => s.id === configSection.id);\r\n                            if (!existingSection) {\r\n                                this._options.sections.push(configSection);\r\n                            } else if (configSection.label && !existingSection.label) {\r\n                                existingSection.label = configSection.label;\r\n                            }\r\n                        });\r\n\r\n                        this._options.sections.sort((a, b) => (a.order || 0) - (b.order || 0));\r\n\r\n                        if (Log) Log.info(\"[GeoLeaf.LayerManager] Sections fusionn√©es avec layerManagerConfig\");\r\n                    }\r\n                }\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Remplit automatiquement la section basemap\r\n         * @private\r\n         */\r\n        _autoPopulateBasemap() {\r\n            if (!Array.isArray(this._options.sections)) return;\r\n\r\n            const basemapSection = this._options.sections.find(s => s.id === \"basemap\");\r\n            if (basemapSection && (!basemapSection.items || basemapSection.items.length === 0)) {\r\n                try {\r\n                    let basemapDefs = null;\r\n                    if (global.GeoLeaf && global.GeoLeaf.Baselayers && typeof global.GeoLeaf.Baselayers.getBaseLayers === \"function\") {\r\n                        basemapDefs = global.GeoLeaf.Baselayers.getBaseLayers() || {};\r\n                    } else if (GeoLeaf.Config && typeof GeoLeaf.Config.get === \"function\") {\r\n                        basemapDefs = GeoLeaf.Config.get('basemaps') || {};\r\n                    }\r\n\r\n                    if (basemapDefs && Object.keys(basemapDefs).length > 0) {\r\n                        basemapSection.items = Object.keys(basemapDefs).map(k => {\r\n                            const d = basemapDefs[k] || {};\r\n                            return { id: d.id || k, label: d.label || k };\r\n                        });\r\n                        if (Log) Log.info(\"[GeoLeaf.LayerManager] Section basemap remplie automatiquement\");\r\n                    }\r\n                } catch (e) {\r\n                    if (Log) Log.warn(\"[GeoLeaf.LayerManager] Erreur lors du remplissage automatique des basemaps:\", e);\r\n                }\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Autoremplissage minimal des sections\r\n         * @private\r\n         */\r\n        _autoPopulateSections() {\r\n            if (Array.isArray(this._options.sections) && this._options.sections.length > 0) return;\r\n\r\n            const autoSections = [];\r\n            try {\r\n                if (global.GeoLeaf && global.GeoLeaf.Baselayers && typeof global.GeoLeaf.Baselayers.getBaseLayers === \"function\") {\r\n                    const defs = global.GeoLeaf.Baselayers.getBaseLayers() || {};\r\n                    const baseItems = Object.keys(defs).map(k => {\r\n                        const d = defs[k] || {};\r\n                        return { id: k, label: d.label || k };\r\n                    });\r\n                    if (baseItems.length) {\r\n                        autoSections.push({ id: \"basemap\", label: \"Fond de carte\", items: baseItems });\r\n                    }\r\n                }\r\n            } catch (e) {\r\n                // ignore\r\n            }\r\n\r\n            if (autoSections.length) {\r\n                this._options.sections = autoSections;\r\n                if (Log) Log.info(\"[GeoLeaf.LayerManager] auto-populated sections from Baselayers\");\r\n            } else {\r\n                if (Log) Log.warn(\"[GeoLeaf.LayerManager] Aucune section fournie et autoremplissage impossible.\");\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Enregistre une couche GeoJSON dans la l√©gende\r\n         * @param {string} layerId - ID de la couche\r\n         * @param {Object} options - Options de la couche\r\n         */\r\n        _registerGeoJsonLayer(layerId, options = {}) {\r\n            // ...log supprim√© ([LayerManager] _registerGeoJsonLayer appel√© pour)...\r\n\r\n            if (!this._options.sections) {\r\n                this._options.sections = [];\r\n            }\r\n\r\n            // Utiliser layerManagerId ou legendSection (r√©trocompatibilit√©)\r\n            const sectionId = options.layerManagerId || options.legendSection || \"geojson-default\";\r\n            let section = this._options.sections.find(s => s.id === sectionId);\r\n\r\n            if (!section) {\r\n                section = {\r\n                    id: sectionId,\r\n                    label: options.legendSectionLabel || \"Couches GeoJSON\",\r\n                    order: 10,\r\n                    items: []\r\n                };\r\n                this._options.sections.push(section);\r\n                this._options.sections.sort((a, b) => (a.order || 0) - (b.order || 0));\r\n            }\r\n\r\n            const existingItem = section.items.find(item => item.id === layerId);\r\n            if (!existingItem) {\r\n                section.items.push({\r\n                    id: layerId,\r\n                    label: options.label || layerId,\r\n                    toggleable: true,\r\n                    themes: options.themes || null,\r\n                    styles: options.styles || null,\r\n                    labels: options.labels || null\r\n                });\r\n\r\n                this._updateContent();\r\n                if (Log) Log.debug(`[LayerManager] Couche \"${layerId}\" enregistr√©e dans section \"${sectionId}\"`);\r\n            }\r\n        },\r\n\r\n        /**\r\n         * D√©senregistre une couche GeoJSON de la l√©gende\r\n         * @param {string} layerId - ID de la couche\r\n         */\r\n        _unregisterGeoJsonLayer(layerId) {\r\n            if (!Array.isArray(this._options.sections)) return;\r\n\r\n            this._options.sections.forEach(section => {\r\n                if (Array.isArray(section.items)) {\r\n                    section.items = section.items.filter(item => item.id !== layerId);\r\n                }\r\n            });\r\n\r\n            this._options.sections = this._options.sections.filter(\r\n                section => section.id === \"basemap\" || (Array.isArray(section.items) && section.items.length > 0)\r\n            );\r\n\r\n            this._updateContent();\r\n            if (Log) Log.debug(`[LayerManager] Couche \"${layerId}\" d√©senregistr√©e`);\r\n        },\r\n\r\n        /**\r\n         * Met √† jour les sections de la l√©gende\r\n         * @param {Array} sections - Nouvelles sections\r\n         */\r\n        updateSections(sections) {\r\n            if (!Array.isArray(sections)) {\r\n                if (Log) Log.warn(\"[GeoLeaf.LayerManager] updateSections: sections doit √™tre un tableau\");\r\n                return;\r\n            }\r\n            this._options.sections = sections;\r\n            this._updateContent();\r\n        },\r\n\r\n        /**\r\n         * Ajoute ou met √† jour une section dans la l√©gende\r\n         * @param {Object} section - Section √† ajouter {id, label, order, items}\r\n         */\r\n        addSection(section) {\r\n            if (!section || !section.id) {\r\n                if (Log) Log.warn(\"[GeoLeaf.LayerManager] addSection: section invalide (id manquant)\");\r\n                return;\r\n            }\r\n\r\n            if (!Array.isArray(this._options.sections)) {\r\n                this._options.sections = [];\r\n            }\r\n\r\n            // Chercher une section existante avec le m√™me id\r\n            const existingIndex = this._options.sections.findIndex(s => s.id === section.id);\r\n\r\n            if (existingIndex !== -1) {\r\n                // Fusionner avec la section existante\r\n                const existing = this._options.sections[existingIndex];\r\n\r\n                // Fusionner les items\r\n                if (Array.isArray(section.items)) {\r\n                    if (!Array.isArray(existing.items)) {\r\n                        existing.items = [];\r\n                    }\r\n\r\n                    section.items.forEach(newItem => {\r\n                        const existingItemIndex = existing.items.findIndex(i => i.id === newItem.id);\r\n                        if (existingItemIndex !== -1) {\r\n                            // Mettre √† jour l'item existant\r\n                            existing.items[existingItemIndex] = Object.assign({}, existing.items[existingItemIndex], newItem);\r\n                        } else {\r\n                            // Ajouter le nouvel item\r\n                            existing.items.push(newItem);\r\n                        }\r\n                    });\r\n\r\n                    // Trier les items par order\r\n                    existing.items.sort((a, b) => (a.order || 0) - (b.order || 0));\r\n                }\r\n\r\n                // Mettre √† jour les autres propri√©t√©s si fournies\r\n                if (section.label) existing.label = section.label;\r\n                if (section.order !== undefined) existing.order = section.order;\r\n                if (section.collapsedByDefault !== undefined) existing.collapsedByDefault = section.collapsedByDefault;\r\n            } else {\r\n                // Ajouter la nouvelle section\r\n                this._options.sections.push({\r\n                    id: section.id,\r\n                    label: section.label || section.id,\r\n                    order: section.order || 99,\r\n                    collapsedByDefault: section.collapsedByDefault || false,\r\n                    items: section.items || []\r\n                });\r\n\r\n                // Trier les sections par order\r\n                this._options.sections.sort((a, b) => (a.order || 0) - (b.order || 0));\r\n            }\r\n\r\n            this._updateContent();\r\n            if (Log) Log.debug(`[LayerManager] Section \"${section.id}\" ajout√©e/mise √† jour`);\r\n        },\r\n\r\n        /**\r\n         * Bascule l'√©tat repli√©/d√©pli√© de la l√©gende\r\n         */\r\n        toggleCollapse() {\r\n            this._options.collapsed = !this._options.collapsed;\r\n            if (!this._control) return;\r\n            if (this._options.collapsed) {\r\n                this._control._container.classList.add(\"gl-layer-manager--collapsed\");\r\n            } else {\r\n                this._control._container.classList.remove(\"gl-layer-manager--collapsed\");\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Indique si la l√©gende est repli√©e\r\n         * @returns {boolean}\r\n         */\r\n        isCollapsed() {\r\n            return !!this._options.collapsed;\r\n        },\r\n\r\n        /**\r\n         * Force le re-rendu du contenu\r\n         * @private\r\n         */\r\n        _updateContent() {\r\n            if (!this._control || typeof this._control.updateSections !== \"function\") {\r\n                return;\r\n            }\r\n            this._control.updateSections(this._options.sections || []);\r\n        },\r\n\r\n        /**\r\n         * Rafra√Æchit l'affichage du LayerManager\r\n         * Utilis√© notamment apr√®s l'application d'un th√®me pour mettre √† jour l'√©tat des boutons toggle\r\n         * Version debounced pour grouper les appels multiples (ex: plusieurs couches changent de visibilit√© au zoom)\r\n         * @public\r\n         * @param {boolean} [immediate=false] - Si true, force le refresh imm√©diat sans debounce\r\n         */\r\n        refresh(immediate = false) {\r\n            if (!this._control || typeof this._control.refresh !== \"function\") {\r\n                if (Log) Log.warn(\"[LayerManager] refresh(): contr√¥le non disponible ou m√©thode refresh manquante\");\r\n                return;\r\n            }\r\n\r\n            // Si refresh imm√©diat demand√©, annuler le debounce et ex√©cuter\r\n            if (immediate) {\r\n                if (this._refreshTimeout) {\r\n                    clearTimeout(this._refreshTimeout);\r\n                    this._refreshTimeout = null;\r\n                }\r\n                this._control.refresh();\r\n                if (Log) Log.debug(\"[LayerManager] Affichage rafra√Æchi (imm√©diat)\");\r\n                return;\r\n            }\r\n\r\n            // Debounce: annuler le timeout pr√©c√©dent et programmer un nouveau refresh\r\n            if (this._refreshTimeout) {\r\n                clearTimeout(this._refreshTimeout);\r\n            }\r\n\r\n            this._refreshTimeout = setTimeout(() => {\r\n                this._refreshTimeout = null;\r\n                this._control.refresh();\r\n                if (Log) Log.debug(\"[LayerManager] Affichage rafra√Æchi (debounced)\");\r\n            }, 250);\r\n        },\r\n\r\n        /**\r\n         * Fusion d'options (shallow + fusion l√©g√®re pour sous-objets)\r\n         * @param {Object} base\r\n         * @param {Object} override\r\n         * @returns {Object}\r\n         * @private\r\n         */\r\n        _mergeOptions(base, override) {\r\n            const result = Object.assign({}, base || {});\r\n            if (!override) return result;\r\n\r\n            Object.keys(override).forEach((key) => {\r\n                const value = override[key];\r\n\r\n                if (\r\n                    value &&\r\n                    typeof value === \"object\" &&\r\n                    !Array.isArray(value) &&\r\n                    base &&\r\n                    typeof base[key] === \"object\" &&\r\n                    !Array.isArray(base[key])\r\n                ) {\r\n                    result[key] = Object.assign({}, base[key], value);\r\n                } else {\r\n                    result[key] = value;\r\n                }\r\n            });\r\n\r\n            return result;\r\n        }\r\n    };\r\n\r\n    // Exposer le module dans l'espace de nom GeoLeaf\r\n    GeoLeaf.LayerManager = LayerManagerModule;\r\n})(window);\r\n","/**\r\n * Module Legend Generator\r\n * G√©n√®re automatiquement les l√©gendes depuis les fichiers de style\r\n *\r\n * D√âPENDANCES:\r\n * - GeoLeaf.Log (optionnel)\r\n *\r\n * EXPOSE:\r\n * - GeoLeaf._LegendGenerator\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = global.GeoLeaf = global.GeoLeaf || {};\r\n    const Log = GeoLeaf.Log;\r\n\r\n    /**\r\n     * R√©cup√®re l'ic√¥ne depuis taxonomy pour une r√®gle donn√©e\r\n     * @param {Object} rule - R√®gle de style avec condition when\r\n     * @param {Object} taxonomyData - Donn√©es de taxonomy\r\n     * @param {string} symbolPrefix - Pr√©fixe des symboles (ex: \"tourism-poi-cat-\")\r\n     * @returns {string|null} - ID de l'ic√¥ne sprite ou null\r\n     * @private\r\n     */\r\n    function getIconFromTaxonomy(rule, taxonomyData, symbolPrefix) {\r\n        if (!rule.when || !taxonomyData || !taxonomyData.categories) {\r\n            if (Log) Log.debug(\"[LegendGenerator] Donn√©es insuffisantes pour r√©cup√©rer ic√¥ne:\", {\r\n                hasRule: !!rule.when,\r\n                hasTaxonomy: !!taxonomyData,\r\n                hasCategories: !!(taxonomyData && taxonomyData.categories)\r\n            });\r\n            return null;\r\n        }\r\n\r\n        const field = rule.when.field;\r\n        const value = rule.when.value;\r\n        const categories = taxonomyData.categories;\r\n\r\n        if (Log) Log.debug(`[LegendGenerator] Recherche ic√¥ne pour ${field}=${value}`);\r\n\r\n        // D√©terminer le type de recherche\r\n        const isSubCategory = field === \"properties.subCategoryId\" || field === \"attributes.subCategoryId\";\r\n        const isCategoryId = field === \"properties.categoryId\" || field === \"attributes.categoryId\";\r\n\r\n        // Recherche dans subCategoryId\r\n        if (isSubCategory) {\r\n            for (const categoryKey in categories) {\r\n                const subcategories = categories[categoryKey].subcategories;\r\n                if (subcategories && subcategories[value] && subcategories[value].icon) {\r\n                    const iconId = symbolPrefix + subcategories[value].icon;\r\n                    if (Log) Log.debug(`[LegendGenerator] Ic√¥ne trouv√©e (subcat): ${iconId}`);\r\n                    return iconId;\r\n                }\r\n            }\r\n        }\r\n\r\n        // Recherche dans categoryId\r\n        if (isCategoryId && categories[value] && categories[value].icon) {\r\n            const iconId = symbolPrefix + categories[value].icon;\r\n            if (Log) Log.debug(`[LegendGenerator] Ic√¥ne trouv√©e (cat): ${iconId}`);\r\n            return iconId;\r\n        }\r\n\r\n        if (Log) Log.warn(`[LegendGenerator] Aucune ic√¥ne trouv√©e pour ${field}=${value}`);\r\n        return null;\r\n    }\r\n\r\n    // Fonction utilitaire pour d√©terminer si les ic√¥nes doivent √™tre affich√©es\r\n    // Copie exactement la logique de markers.js resolveCategoryDisplay()\r\n    function shouldUseIcons() {\r\n        try {\r\n            // R√©cup√©rer l'√©tat partag√© (comme dans markers.js)\r\n            const shared = (GeoLeaf && GeoLeaf._POIShared) ? GeoLeaf._POIShared : null;\r\n            const poiConfig = shared ? shared.state.poiConfig : {};\r\n            const showIconsOnMap = (poiConfig.showIconsOnMap !== false);\r\n\r\n            if (showIconsOnMap) {\r\n                // V√©rifier la config d'ic√¥nes (comme dans markers.js)\r\n                const iconsConfig = (GeoLeaf.Config && typeof GeoLeaf.Config.getIconsConfig === \"function\")\r\n                    ? GeoLeaf.Config.getIconsConfig()\r\n                    : null;\r\n\r\n                if (iconsConfig && iconsConfig.showOnMap !== false) {\r\n                    return true;\r\n                }\r\n            }\r\n        } catch (e) {\r\n            // Ignorer les erreurs silencieusement\r\n        }\r\n\r\n        return false;\r\n    }\r\n\r\n    /**\r\n     * G√©n√®re les donn√©es de l√©gende depuis un fichier de style\r\n     * @param {Object} styleData - Donn√©es du style (JSON pars√©)\r\n     * @param {string} geometryType - Type de g√©om√©trie (point, line, polygon)\r\n     * @param {Object} taxonomyData - Donn√©es de taxonomy (pour les ic√¥nes POI)\r\n     * @returns {Object} - Donn√©es de l√©gende format√©es\r\n     */\r\n    function generateLegendFromStyle(styleData, geometryType, taxonomyData) {\r\n        if (!styleData) {\r\n            if (Log) Log.warn(\"[LegendGenerator] Style data manquant\");\r\n            return null;\r\n        }\r\n\r\n        const legendData = {\r\n            version: \"3.0\",\r\n            id: styleData.id,\r\n            title: styleData.label || \"Sans titre\",\r\n            description: styleData.description || \"\",\r\n            sections: []\r\n        };\r\n\r\n        const items = [];\r\n        const symbolPrefix = taxonomyData?.icons?.symbolPrefix || \"tourism-poi-cat-\";\r\n\r\n        // Cas 1 : Style avec styleRules\r\n        if (Array.isArray(styleData.styleRules) && styleData.styleRules.length > 0) {\r\n            styleData.styleRules.forEach(rule => {\r\n                if (!rule.legend) {\r\n                    if (Log) Log.warn(\"[LegendGenerator] R√®gle sans propri√©t√© legend:\", rule);\r\n                    return;\r\n                }\r\n\r\n                const item = generateLegendItem(\r\n                    rule.style,\r\n                    rule.legend,\r\n                    geometryType,\r\n                    styleData.style, // style de base\r\n                    rule,\r\n                    taxonomyData,\r\n                    symbolPrefix\r\n                );\r\n\r\n                if (item) {\r\n                    items.push(item);\r\n                }\r\n            });\r\n\r\n            // Trier par order\r\n            items.sort((a, b) => (a.order || 999) - (b.order || 999));\r\n\r\n        // Cas 2 : Style simple sans r√®gles ou avec styleRules vide\r\n        }\r\n\r\n        // Si pas d'items g√©n√©r√©s √† partir des styleRules (ou pas de styleRules)\r\n        // essayer d'utiliser la l√©gende au niveau racine\r\n        if (items.length === 0 && styleData.style && styleData.legend) {\r\n            const item = generateLegendItem(\r\n                styleData.style,\r\n                styleData.legend,\r\n                geometryType,\r\n                null,\r\n                null,\r\n                taxonomyData,\r\n                symbolPrefix\r\n            );\r\n\r\n            if (item) {\r\n                items.push(item);\r\n            }\r\n        }\r\n\r\n        // Cr√©er une section par d√©faut avec tous les items\r\n        if (items.length > 0) {\r\n            legendData.sections.push({\r\n                title: \"\",\r\n                items: items\r\n            });\r\n        }\r\n\r\n        return legendData;\r\n    }\r\n\r\n    /**\r\n     * G√©n√®re un item de l√©gende selon le type de g√©om√©trie\r\n     * @param {Object} style - Style de l'entit√©\r\n     * @param {Object} legend - Propri√©t√©s legend (label, order, description)\r\n     * @param {string} geometryType - Type de g√©om√©trie\r\n     * @param {Object} baseStyle - Style de base (pour h√©ritage)\r\n     * @param {Object} rule - R√®gle compl√®te (pour extraction ic√¥ne)\r\n     * @param {Object} taxonomyData - Donn√©es taxonomy\r\n     * @param {string} symbolPrefix - Pr√©fixe symboles\r\n     * @param {boolean} showIconsOnMap - Si true, g√©n√®re les ic√¥nes\r\n     * @returns {Object|null} - Item de l√©gende\r\n     * @private\r\n     */\r\n    function generateLegendItem(style, legend, geometryType, baseStyle, rule, taxonomyData, symbolPrefix) {\r\n        if (!style || !legend) {\r\n            return null;\r\n        }\r\n\r\n        // Fusionner avec le style de base si pr√©sent\r\n        const mergedStyle = baseStyle ? Object.assign({}, baseStyle, style) : style;\r\n\r\n        const item = {\r\n            label: legend.label || \"Sans label\",\r\n            order: legend.order || 999\r\n        };\r\n\r\n        if (legend.description) {\r\n            item.description = legend.description;\r\n        }\r\n\r\n        // G√©n√©ration du symbole selon le type de g√©om√©trie\r\n        switch (geometryType) {\r\n            case \"point\":\r\n                item.symbol = generatePointSymbol(mergedStyle, rule, taxonomyData, symbolPrefix);\r\n                break;\r\n\r\n            case \"line\":\r\n                item.symbol = generateLineSymbol(mergedStyle);\r\n                break;\r\n\r\n            case \"polygon\":\r\n                item.symbol = generatePolygonSymbol(mergedStyle);\r\n                break;\r\n\r\n            default:\r\n                if (Log) Log.warn(\"[LegendGenerator] Type de g√©om√©trie non reconnu:\", geometryType);\r\n                item.symbol = generatePointSymbol(mergedStyle, rule, taxonomyData, symbolPrefix);\r\n        }\r\n\r\n        return item;\r\n    }\r\n\r\n    /**\r\n     * Ajoute les propri√©t√©s communes d'opacit√© √† un symbole\r\n     * @param {Object} symbol - Objet symbole\r\n     * @param {Object} style - Style source\r\n     * @param {Array<string>} opacityProps - Propri√©t√©s d'opacit√© √† copier\r\n     * @private\r\n     */\r\n    function applyOpacityProperties(symbol, style, opacityProps) {\r\n        opacityProps.forEach(prop => {\r\n            if (style[prop] !== undefined) {\r\n                symbol[prop] = style[prop];\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * R√©sout les ic√¥nes d'une r√®gle selon la configuration showIconsOnMap\r\n     * @param {Object} rule - R√®gle de style\r\n     * @returns {Object} - {useIcon: boolean, iconId: string|null}\r\n     * @private\r\n     */\r\n    function resolveRuleIcons(rule) {\r\n        // Utiliser la m√™me logique que markers.js\r\n        if (!shouldUseIcons()) {\r\n            return { useIcon: false, iconId: null };\r\n        }\r\n        // R√©cup√©rer la configuration des cat√©gories\r\n        const categoriesConfig = (GeoLeaf.Config && typeof GeoLeaf.Config.getCategories === \"function\")\r\n            ? GeoLeaf.Config.getCategories()\r\n            : {};\r\n\r\n        if (!categoriesConfig || Object.keys(categoriesConfig).length === 0) {\r\n            return { useIcon: false, iconId: null };\r\n        }\r\n\r\n        // Mappage de fclass vers categoryId/subCategoryId pour les ic√¥nes\r\n        // Permet de r√©soudre les ic√¥nes pour les r√®gles qui utilisent fclass au lieu de categoryId\r\n        const fclassMappings = {\r\n            // Cultures\r\n            'archaeological': { categoryId: 'CULTURES', subCategoryId: 'SITE ARCHEOLOGIQUE' },\r\n            'museum': { categoryId: 'CULTURES', subCategoryId: 'MUSEE' },\r\n            // H√©bergements\r\n            'camp_site': { categoryId: 'HEBERGEMENT', subCategoryId: 'CAMPING' },\r\n            'hotel': { categoryId: 'HEBERGEMENT', subCategoryId: 'HOTEL' }\r\n        };\r\n\r\n        // Extraire categoryId et subCategoryId depuis la r√®gle\r\n        let categoryId = null;\r\n        let subCategoryId = null;\r\n\r\n        // Format v3 : rule.when avec field/value\r\n        if (rule.when && rule.when.field && rule.when.value !== undefined) {\r\n            // NOUVEAU: Cas sp√©cial pour fclass (r√©soudre via mapping)\r\n            if (rule.when.field === 'properties.fclass' || rule.when.field === 'fclass') {\r\n                const mapping = fclassMappings[rule.when.value];\r\n                if (mapping) {\r\n                    categoryId = mapping.categoryId;\r\n                    subCategoryId = mapping.subCategoryId;\r\n                }\r\n            } else if (rule.when.field === 'properties.categoryId' || rule.when.field === 'categoryId') {\r\n                categoryId = rule.when.value;\r\n            } else if (rule.when.field === 'properties.subCategoryId' || rule.when.field === 'subCategoryId') {\r\n                subCategoryId = rule.when.value;\r\n            } else if (rule.when.field === 'properties.category' || rule.when.field === 'category') {\r\n                categoryId = rule.when.value;\r\n            } else if (rule.when.field === 'properties.subCategory' || rule.when.field === 'subCategory') {\r\n                subCategoryId = rule.when.value;\r\n            }\r\n        }\r\n        // Format legacy : rule.condition\r\n        else if (rule.condition) {\r\n            if (typeof rule.condition.categoryId !== 'undefined') {\r\n                categoryId = rule.condition.categoryId;\r\n            }\r\n            if (typeof rule.condition.subCategoryId !== 'undefined') {\r\n                subCategoryId = rule.condition.subCategoryId;\r\n            }\r\n            if (typeof rule.condition.category !== 'undefined') {\r\n                categoryId = rule.condition.category;\r\n            }\r\n            if (typeof rule.condition.subCategory !== 'undefined') {\r\n                subCategoryId = rule.condition.subCategory;\r\n            }\r\n        }\r\n\r\n        // Pour les subCategoryId, il faut deviner la categoryId depuis la taxonomie\r\n        if (subCategoryId && !categoryId) {\r\n            // Chercher dans quelle cat√©gorie se trouve cette sous-cat√©gorie\r\n            Object.keys(categoriesConfig).forEach(catKey => {\r\n                const cat = categoriesConfig[catKey];\r\n                if (cat.subcategories && cat.subcategories[subCategoryId]) {\r\n                    categoryId = catKey;\r\n                }\r\n            });\r\n        }\r\n\r\n        if (!categoryId && !subCategoryId) {\r\n            return { useIcon: false, iconId: null };\r\n        }\r\n\r\n        // R√©solution de l'ic√¥ne depuis la taxonomie\r\n        let iconId = null;\r\n        if (subCategoryId && categoriesConfig[categoryId]?.subcategories) {\r\n            const subCat = categoriesConfig[categoryId].subcategories[subCategoryId];\r\n            const cat = categoriesConfig[categoryId];\r\n\r\n            if (subCat) {\r\n                iconId = subCat.icon || subCat.iconId || cat.icon || cat.iconId || null;\r\n            } else {\r\n                iconId = cat.icon || cat.iconId || null;\r\n            }\r\n        } else if (categoriesConfig[categoryId]) {\r\n            const cat = categoriesConfig[categoryId];\r\n            iconId = cat.icon || cat.iconId || null;\r\n        }\r\n\r\n        return {\r\n            useIcon: iconId !== null,\r\n            iconId: iconId\r\n        };\r\n    }\r\n\r\n    /**\r\n     * G√©n√®re un symbole pour les points (POI)\r\n     * @param {Object} style - Style du point\r\n     * @param {Object} rule - R√®gle compl√®te (pour extraction ic√¥ne)\r\n     * @param {Object} taxonomyData - Donn√©es taxonomy\r\n     * @param {string} symbolPrefix - Pr√©fixe symboles\r\n     * @param {boolean} showIconsOnMap - Si true, g√©n√®re les ic√¥nes\r\n     * @returns {Object} - Configuration du symbole\r\n     * @private\r\n     */\r\n    function generatePointSymbol(style, rule, taxonomyData, symbolPrefix) {\r\n        const fill = style.fill || {};\r\n        const stroke = style.stroke || {};\r\n\r\n        const resolvedRadius = style.radius || style.size || (style.sizePx ? style.sizePx / 2 : undefined);\r\n\r\n        // Taille par d√©faut plus grande pour que les ic√¥nes soient visibles dans la l√©gende\r\n        // Utiliser 24px pour les ic√¥nes, 16px pour les cercles simples\r\n        const defaultRadius = 24;\r\n\r\n        const symbol = {\r\n            type: \"circle\",\r\n            radius: resolvedRadius || defaultRadius,\r\n            fillColor: style.fillColor || style.color || fill.color || \"#3388ff\",\r\n            fillOpacity: style.fillOpacity !== undefined ? style.fillOpacity : (fill.opacity !== undefined ? fill.opacity : 1),\r\n            color: style.color || stroke.color || \"#ffffff\",\r\n            weight: style.weight || stroke.widthPx || 2,\r\n            opacity: style.opacity !== undefined ? style.opacity : (stroke.opacity !== undefined ? stroke.opacity : 1)\r\n        };\r\n\r\n        // Priorit√© 1 : V√©rifier si l'ic√¥ne est directement dans le style (showIconsOnMap)\r\n        if (style.useIcon && style.iconId) {\r\n            symbol.icon = style.iconId;\r\n            symbol.iconColor = \"#ffffff\"; // Couleur par d√©faut pour ic√¥nes\r\n            if (Log) Log.debug(`[LegendGenerator] Ic√¥ne trouv√©e dans le style: ${style.iconId}`);\r\n        }\r\n        // Priorit√© 2 : R√©soudre l'ic√¥ne depuis la configuration showIconsOnMap\r\n        else if (rule && shouldUseIcons()) {\r\n            const iconResolution = resolveRuleIcons(rule);\r\n\r\n            if (iconResolution.useIcon && iconResolution.iconId) {\r\n                // Ajouter le pr√©fixe sprite si n√©cessaire\r\n                const fullIconId = iconResolution.iconId.startsWith('#') ?\r\n                    iconResolution.iconId :\r\n                    (symbolPrefix ? symbolPrefix + iconResolution.iconId : '#sprite-' + iconResolution.iconId);\r\n\r\n                symbol.icon = fullIconId;\r\n                symbol.iconColor = \"#ffffff\";\r\n                if (Log) Log.debug(`[LegendGenerator] Ic√¥ne r√©solue depuis la config: ${fullIconId}`);\r\n            }\r\n        }\r\n        // Priorit√© 3 : Tenter de r√©cup√©rer l'ic√¥ne depuis taxonomy (m√©thode legacy)\r\n        if (!symbol.icon && rule && taxonomyData && shouldUseIcons()) {\r\n            const icon = getIconFromTaxonomy(rule, taxonomyData, symbolPrefix);\r\n            if (icon) {\r\n                symbol.icon = icon;\r\n                symbol.iconColor = \"#ffffff\"; // Couleur par d√©faut pour ic√¥nes\r\n                if (Log) Log.debug(\"[LegendGenerator] Ic√¥ne taxonomy ajout√©e:\", icon);\r\n            }\r\n        }\r\n\r\n        return symbol;\r\n    }\r\n\r\n    /**\r\n     * G√©n√®re un symbole pour les lignes\r\n     * @param {Object} style - Style de la ligne\r\n     * @returns {Object} - Configuration du symbole\r\n     * @private\r\n     */\r\n    function generateLineSymbol(style) {\r\n        const stroke = style.stroke || {};\r\n        const casing = style.casing || {};\r\n\r\n        // Strat√©gie : afficher le casing comme contour/bordure du stroke\r\n        // Si casing existe, utiliser la couleur du casing comme contour\r\n        // et le stroke comme couleur principale\r\n        const symbol = {\r\n            type: \"line\",\r\n            color: stroke.color || style.color || \"#3388ff\",\r\n            width: stroke.widthPx || style.weight || 3,\r\n            style: \"solid\" // Par d√©faut\r\n        };\r\n\r\n        // Si casing est activ√©, ajouter une bordure/outline fine\r\n        // Limiter l'√©paisseur pour la l√©gende (r√©duit d'un facteur)\r\n        if (casing.enabled && casing.color) {\r\n            symbol.outlineColor = casing.color;\r\n            // Utiliser une fraction de la largeur du casing pour la l√©gende\r\n            symbol.outlineWidth = Math.max(0.5, (casing.widthPx || 1) * 0.4);\r\n            symbol.outlineOpacity = casing.opacity || 1;\r\n        }\r\n\r\n        // Appliquer l'opacit√©\r\n        if (stroke.opacity !== undefined) {\r\n            symbol.opacity = stroke.opacity;\r\n        }\r\n\r\n        // Support pour dashArray - passer la valeur compl√®te\r\n        const dashArray = style.dashArray || stroke.dashArray;\r\n        if (dashArray) {\r\n            symbol.dashArray = dashArray;\r\n            // Garder le style pour la r√©trocompatibilit√©\r\n            if (dashArray === \"5, 5\" || dashArray === \"10, 10\") {\r\n                symbol.style = \"dashed\";\r\n            } else if (dashArray === \"1, 3\" || dashArray === \"2, 4\") {\r\n                symbol.style = \"dotted\";\r\n            }\r\n        }\r\n\r\n        return symbol;\r\n    }\r\n\r\n    /**\r\n     * G√©n√®re un symbole pour les polygones\r\n     * @param {Object} style - Style du polygone\r\n     * @returns {Object} - Configuration du symbole\r\n     * @private\r\n     */\r\n    function generatePolygonSymbol(style) {\r\n        const fill = style.fill || {};\r\n        const stroke = style.stroke || {};\r\n\r\n        const symbol = {\r\n            type: \"polygon\",\r\n            fillColor: style.fillColor || style.color || fill.color || \"#3388ff\",\r\n            color: style.color || stroke.color || \"#333\",\r\n            weight: style.weight || stroke.widthPx || 1\r\n        };\r\n\r\n        // Appliquer l'opacit√© du fill (pas du stroke qui √©crase)\r\n        applyOpacityProperties(symbol, style, ['fillOpacity']);\r\n        // Si pas de fillOpacity, prendre l'opacity directement du fill\r\n        if (fill.opacity !== undefined) {\r\n            symbol.opacity = fill.opacity;\r\n        }\r\n        // Puis v√©rifier style.opacity en dernier (peut √™tre au niveau racine)\r\n        if (style.opacity !== undefined) {\r\n            symbol.opacity = style.opacity;\r\n        }\r\n\r\n        // Support pour dashArray sur le contour\r\n        const dashArray = style.dashArray || stroke.dashArray;\r\n        if (dashArray) {\r\n            symbol.dashArray = dashArray;\r\n        }\r\n\r\n        // Support pour patterns de hachures\r\n        if (style.fillPattern) {\r\n            symbol.fillPattern = style.fillPattern;\r\n        }\r\n\r\n        // Support pour les hachures (format moderne)\r\n        if (style.hatch) {\r\n            symbol.hatch = style.hatch;\r\n        }\r\n\r\n        return symbol;\r\n    }\r\n\r\n    // Exposer le module\r\n    GeoLeaf._LegendGenerator = {\r\n        generateLegendFromStyle: generateLegendFromStyle,\r\n        generateLegendItem: generateLegendItem\r\n    };\r\n\r\n})(window);\r\n","/**\r\n * Module Legend Renderer\r\n * Rendu des symboles de l√©gende cartographique\r\n *\r\n * D√âPENDANCES:\r\n * - Leaflet (L.DomUtil)\r\n * - GeoLeaf.Log (optionnel)\r\n *\r\n * EXPOSE:\r\n * - GeoLeaf._LegendRenderer\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = global.GeoLeaf = global.GeoLeaf || {};\r\n    const Log = GeoLeaf.Log;\r\n\r\n    /**\r\n     * Rendu d'une section de l√©gende\r\n     * @param {HTMLElement} container - Conteneur parent\r\n     * @param {Object} section - Section de l√©gende\r\n     */\r\n    function renderSection(container, section) {\r\n        const sectionEl = global.L.DomUtil.create(\"div\", \"gl-legend__section\", container);\r\n\r\n        // Titre de section\r\n        if (section.title) {\r\n            const titleEl = global.L.DomUtil.create(\"h3\", \"gl-legend__section-title\", sectionEl);\r\n            titleEl.textContent = section.title;\r\n        }\r\n\r\n        // Items\r\n        const itemsContainer = global.L.DomUtil.create(\"div\", \"gl-legend__items\", sectionEl);\r\n        if (Array.isArray(section.items)) {\r\n            section.items.forEach(item => renderItem(itemsContainer, item));\r\n        }\r\n\r\n        return sectionEl;\r\n    }\r\n\r\n    /**\r\n     * Rendu d'un item de l√©gende\r\n     * @param {HTMLElement} container - Conteneur parent\r\n     * @param {Object} item - Item de l√©gende\r\n     */\r\n    function renderItem(container, item) {\r\n        const itemEl = global.L.DomUtil.create(\"div\", \"gl-legend__item\", container);\r\n\r\n        // Symbole\r\n        const symbolEl = global.L.DomUtil.create(\"div\", \"gl-legend__symbol\", itemEl);\r\n        renderSymbol(symbolEl, item);\r\n\r\n        // Texte\r\n        const textContainer = global.L.DomUtil.create(\"div\", \"gl-legend__text\", itemEl);\r\n\r\n        const labelEl = global.L.DomUtil.create(\"span\", \"gl-legend__label\", textContainer);\r\n        labelEl.textContent = item.label || \"\";\r\n\r\n        if (item.description) {\r\n            const descEl = global.L.DomUtil.create(\"span\", \"gl-legend__description\", textContainer);\r\n            descEl.textContent = item.description;\r\n        }\r\n\r\n        return itemEl;\r\n    }\r\n\r\n    /**\r\n     * Rendu d'un symbole selon son type\r\n     * @param {HTMLElement} container - Conteneur du symbole\r\n     * @param {Object} item - Configuration du symbole\r\n     */\r\n    function renderSymbol(container, item) {\r\n        // D√©l√©guer au module commun\r\n        if (GeoLeaf._UIComponents && typeof GeoLeaf._UIComponents.renderSymbol === 'function') {\r\n            GeoLeaf._UIComponents.renderSymbol(container, item);\r\n        } else {\r\n            // Fallback si module non charg√©\r\n            if (Log) Log.error(\"[LegendRenderer] Module _UIComponents non disponible\");\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Rendu d'un symbole cercle simple\r\n     */\r\n    /**\r\n     * Rendu d'un symbole cercle simple\r\n     * @deprecated Utiliser GeoLeaf._UIComponents.renderCircleSymbol()\r\n     */\r\n    function renderCircleSymbol(container, item) {\r\n        if (GeoLeaf._UIComponents) {\r\n            GeoLeaf._UIComponents.renderCircleSymbol(container, item);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Rendu d'un symbole ligne\r\n     * @deprecated Utiliser GeoLeaf._UIComponents.renderLineSymbol()\r\n     */\r\n    function renderLineSymbol(container, item) {\r\n        if (GeoLeaf._UIComponents) {\r\n            GeoLeaf._UIComponents.renderLineSymbol(container, item);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Rendu d'un symbole polygone/remplissage\r\n     * @deprecated Utiliser GeoLeaf._UIComponents.renderPolygonSymbol()\r\n     */\r\n    function renderPolygonSymbol(container, item) {\r\n        if (GeoLeaf._UIComponents) {\r\n            GeoLeaf._UIComponents.renderPolygonSymbol(container, item);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Rendu d'un symbole √©toile (rating)\r\n     * @deprecated Utiliser GeoLeaf._UIComponents.renderStarSymbol()\r\n     */\r\n    function renderStarSymbol(container, item) {\r\n        if (GeoLeaf._UIComponents) {\r\n            GeoLeaf._UIComponents.renderStarSymbol(container, item);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Rendu du footer\r\n     * @param {HTMLElement} container - Conteneur parent\r\n     * @param {Object} footer - Configuration du footer\r\n     */\r\n    function renderFooter(container, footer) {\r\n        if (!footer || !footer.text) return;\r\n\r\n        const footerEl = global.L.DomUtil.create(\"div\", \"gl-legend__footer\", container);\r\n        footerEl.textContent = footer.text;\r\n\r\n        if (footer.style === \"italic\") {\r\n            footerEl.style.fontStyle = \"italic\";\r\n        }\r\n    }\r\n\r\n    // Exposer dans l'espace de noms interne\r\n    GeoLeaf._LegendRenderer = {\r\n        renderSection: renderSection,\r\n        renderItem: renderItem,\r\n        renderSymbol: renderSymbol,\r\n        renderFooter: renderFooter,\r\n        renderAccordion: renderAccordion\r\n    };\r\n\r\n    /**\r\n     * Rendu d'un accord√©on pour une couche\r\n     * @param {HTMLElement} container - Conteneur parent\r\n     * @param {Object} accordionData - Configuration de l'accord√©on\r\n     * @param {string} accordionData.layerId - ID de la couche\r\n     * @param {string} accordionData.label - Titre de l'accord√©on\r\n     * @param {boolean} accordionData.collapsed - √âtat initial\r\n     * @param {boolean} accordionData.visible - Couche visible ou non (pour grisage)\r\n     * @param {Array} accordionData.sections - Sections de l√©gende\r\n     */\r\n    function renderAccordion(container, accordionData) {\r\n        // Utiliser le module commun pour cr√©er l'accord√©on\r\n        if (!GeoLeaf._UIComponents) {\r\n            if (Log) Log.error(\"[LegendRenderer] Module _UIComponents non disponible\");\r\n            return;\r\n        }\r\n\r\n        const { bodyEl } = GeoLeaf._UIComponents.createAccordion(container, {\r\n            layerId: accordionData.layerId,\r\n            label: accordionData.label,\r\n            collapsed: accordionData.collapsed !== false,\r\n            visible: accordionData.visible,\r\n            onToggle: (layerId, expanded) => {\r\n                // Notifier le module Legend du changement\r\n                if (global.GeoLeaf && global.GeoLeaf.Legend && typeof global.GeoLeaf.Legend.toggleAccordion === \"function\") {\r\n                    global.GeoLeaf.Legend.toggleAccordion(layerId);\r\n                }\r\n            }\r\n        });\r\n\r\n        // Rendre les sections √† l'int√©rieur du body\r\n        if (Array.isArray(accordionData.sections)) {\r\n            accordionData.sections.forEach(section => {\r\n                renderSection(bodyEl, section);\r\n            });\r\n        }\r\n    }\r\n\r\n})(window);\r\n","/**\r\n * Module Legend Control\r\n * Contr√¥le Leaflet pour afficher une l√©gende cartographique\r\n *\r\n * D√âPENDANCES:\r\n * - Leaflet (L.Control, L.DomUtil, L.DomEvent)\r\n * - GeoLeaf.Log (optionnel)\r\n * - GeoLeaf._LegendRenderer\r\n *\r\n * EXPOSE:\r\n * - GeoLeaf._LegendControl\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = global.GeoLeaf = global.GeoLeaf || {};\r\n    const Log = GeoLeaf.Log;\r\n\r\n    /**\r\n     * S'assure que le sprite SVG des ic√¥nes est charg√© avec v√©rification robuste\r\n     * @private\r\n     * @param {Function} [callback] - Fonction √† appeler une fois le sprite charg√©\r\n     */\r\n    async function ensureSpriteLoaded(callback) {\r\n        if (GeoLeaf._POIMarkers && typeof GeoLeaf._POIMarkers.ensureProfileSpriteInjectedSync === \"function\") {\r\n            // √âviter les logs r√©p√©titifs - log seulement la premi√®re fois\r\n            if (!ensureSpriteLoaded._alreadyLogged) {\r\n                if (Log) Log.debug(\"[Legend] Chargement du sprite SVG pour les ic√¥nes...\");\r\n                ensureSpriteLoaded._alreadyLogged = true;\r\n            }\r\n\r\n            // Attendre que le sprite soit charg√© de mani√®re asynchrone\r\n            await GeoLeaf._POIMarkers.ensureProfileSpriteInjectedSync();\r\n\r\n            // V√©rification avec retry pour s'assurer que le sprite est charg√©\r\n            let attempts = 0;\r\n            const maxAttempts = 20; // 2 secondes max\r\n            const checkInterval = 100;\r\n\r\n            function checkSprite() {\r\n                const spriteEl = document.querySelector('svg[data-geoleaf-sprite=\"profile\"]');\r\n                attempts++;\r\n\r\n                if (spriteEl) {\r\n                    // Log seulement la premi√®re d√©tection r√©ussie\r\n                    if (!ensureSpriteLoaded._spriteDetected) {\r\n                        if (Log) Log.info(\"[Legend] Sprite SVG d√©tect√© et pr√™t pour utilisation\");\r\n                        ensureSpriteLoaded._spriteDetected = true;\r\n                    }\r\n                    if (typeof callback === 'function') {\r\n                        callback(true);\r\n                    }\r\n                } else if (attempts < maxAttempts) {\r\n                    setTimeout(checkSprite, checkInterval);\r\n                } else {\r\n                    if (Log) Log.warn(\"[Legend] Sprite SVG non trouv√© apr√®s\", maxAttempts * checkInterval, \"ms\");\r\n                    if (typeof callback === 'function') {\r\n                        callback(false);\r\n                    }\r\n                }\r\n            }\r\n\r\n            checkSprite();\r\n        } else {\r\n            if (Log) Log.debug(\"[Legend] GeoLeaf._POIMarkers.ensureProfileSpriteInjectedSync non disponible\");\r\n            if (typeof callback === 'function') {\r\n                callback(false);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Cr√©e un contr√¥le Leaflet pour la l√©gende cartographique\r\n     * @param {Object} options - Options du contr√¥le\r\n     * @returns {L.Control} - Instance du contr√¥le Leaflet\r\n     */\r\n    function createLegendControl(options) {\r\n        if (!global.L || !global.L.Control) {\r\n            if (Log) Log.error(\"[Legend] Leaflet L.Control non disponible\");\r\n            return null;\r\n        }\r\n\r\n        const LegendControl = global.L.Control.extend({\r\n            options: {\r\n                position: options.position || \"bottomleft\"\r\n            },\r\n\r\n            initialize: function (controlOptions) {\r\n                global.L.setOptions(this, controlOptions || {});\r\n                this._glOptions = controlOptions._glOptions;\r\n            },\r\n\r\n            onAdd: function (mapInstance) {\r\n                this._map = mapInstance;\r\n                this._container = global.L.DomUtil.create(\"div\", \"gl-map-legend\");\r\n\r\n                // Emp√™cher les interactions carte\r\n                if (global.L.DomEvent) {\r\n                    global.L.DomEvent.disableClickPropagation(this._container);\r\n                    global.L.DomEvent.disableScrollPropagation(this._container);\r\n                }\r\n\r\n                this._buildStructure();\r\n                return this._container;\r\n            },\r\n\r\n            onRemove: function () {\r\n                this._map = null;\r\n                this._container = null;\r\n            },\r\n\r\n            /**\r\n             * Construit la structure DOM de la l√©gende\r\n             * @private\r\n             */\r\n            _buildStructure: function () {\r\n                const opts = this._glOptions;\r\n\r\n                // Wrapper principal\r\n                const wrapper = global.L.DomUtil.create(\"div\", \"gl-map-legend__wrapper\", this._container);\r\n\r\n                // En-t√™te : titre + bouton collapse\r\n                if (opts.title) {\r\n                    const header = global.L.DomUtil.create(\"div\", \"gl-map-legend__header\", wrapper);\r\n\r\n                    const titleEl = global.L.DomUtil.create(\"h2\", \"gl-map-legend__title\", header);\r\n                    titleEl.textContent = opts.title;\r\n\r\n                    if (opts.collapsible) {\r\n                        const toggleEl = global.L.DomUtil.create(\"button\", \"gl-map-legend__toggle\", header);\r\n                        toggleEl.type = \"button\";\r\n                        toggleEl.setAttribute(\"aria-label\", \"Basculer la l√©gende\");\r\n                        toggleEl.textContent = \"‚ü±\";\r\n\r\n                        const self = this;\r\n                        global.L.DomEvent.on(toggleEl, \"click\", function (ev) {\r\n                            global.L.DomEvent.stopPropagation(ev);\r\n                            self._toggleCollapsed();\r\n                        });\r\n                    }\r\n                }\r\n\r\n                // Corps de la l√©gende\r\n                this._bodyEl = global.L.DomUtil.create(\"div\", \"gl-map-legend__body\", wrapper);\r\n\r\n                // Appliquer l'√©tat collapsed initial\r\n                if (opts.collapsed) {\r\n                    this._container.classList.add(\"gl-map-legend--collapsed\");\r\n                }\r\n\r\n                // Rendu des sections via le renderer\r\n                this._renderContent();\r\n            },\r\n\r\n            /**\r\n             * Rend le contenu de la l√©gende\r\n             * @private\r\n             */\r\n            _renderContent: function () {\r\n                if (!this._bodyEl) return;\r\n\r\n                // Vider le contenu existant\r\n                if (GeoLeaf._UIComponents && typeof GeoLeaf._UIComponents.clearElement === 'function') {\r\n                    GeoLeaf._UIComponents.clearElement(this._bodyEl);\r\n                } else {\r\n                    GeoLeaf.DOMSecurity.clearElementFast(this._bodyEl);\r\n                }\r\n\r\n                const opts = this._glOptions;\r\n                const renderer = GeoLeaf._LegendRenderer;\r\n\r\n                if (!renderer) {\r\n                    if (Log) Log.error(\"[Legend] _LegendRenderer non disponible\");\r\n                    return;\r\n                }\r\n\r\n                // S'assurer que le sprite SVG est charg√© pour les ic√¥nes\r\n                ensureSpriteLoaded();\r\n\r\n                // Rendu des sections (ancien mode pour compatibilit√©)\r\n                if (Array.isArray(opts.sections)) {\r\n                    opts.sections.forEach(section => {\r\n                        renderer.renderSection(this._bodyEl, section);\r\n                    });\r\n                }\r\n\r\n                // Rendu du footer\r\n                if (opts.footer) {\r\n                    renderer.renderFooter(this._bodyEl, opts.footer);\r\n                }\r\n            },\r\n\r\n            /**\r\n             * Mise √† jour du contenu multi-couches avec accord√©ons\r\n             * @param {Array} legendsArray - Tableau d'accord√©ons √† afficher\r\n             */\r\n            updateMultiLayerContent: function (legendsArray) {\r\n                if (!this._bodyEl) return;\r\n\r\n                // Vider le contenu existant\r\n                if (GeoLeaf._UIComponents && typeof GeoLeaf._UIComponents.clearElement === 'function') {\r\n                    GeoLeaf._UIComponents.clearElement(this._bodyEl);\r\n                } else {\r\n                    GeoLeaf.DOMSecurity.clearElementFast(this._bodyEl);\r\n                }\r\n\r\n                const renderer = GeoLeaf._LegendRenderer;\r\n\r\n                if (!renderer || typeof renderer.renderAccordion !== \"function\") {\r\n                    if (Log) Log.error(\"[Legend] Renderer.renderAccordion non disponible\");\r\n                    return;\r\n                }\r\n\r\n                // S'assurer que le sprite SVG est charg√© avant le rendu\r\n                const self = this;\r\n                ensureSpriteLoaded(function(spriteLoaded) {\r\n                    if (Log) Log.debug(\"[Legend] Sprite charg√©:\", spriteLoaded, \"- Rendu des accord√©ons\");\r\n\r\n                    // Rendre chaque accord√©on (m√™me si le sprite n'est pas charg√© pour √©viter une interface vide)\r\n                    if (Array.isArray(legendsArray)) {\r\n                        legendsArray.forEach(accordionData => {\r\n                            renderer.renderAccordion(self._bodyEl, accordionData);\r\n                        });\r\n                    }\r\n\r\n                    // Si le sprite n'√©tait pas charg√©, r√©essayer dans 1 seconde\r\n                    if (!spriteLoaded) {\r\n                        setTimeout(function() {\r\n                            const spriteEl = document.querySelector('svg[data-geoleaf-sprite=\"profile\"]');\r\n                            if (spriteEl && Log) {\r\n                                Log.info(\"[Legend] Sprite charg√© tardivement - Re-rendu des accord√©ons\");\r\n                                self.updateMultiLayerContent(legendsArray);\r\n                            }\r\n                        }, 1000);\r\n                    }\r\n                });\r\n            },\r\n\r\n            /**\r\n             * Mise √† jour du contenu de la l√©gende (ancien mode)\r\n             * @param {Object} legendData - Nouvelles donn√©es de l√©gende\r\n             */\r\n            updateContent: function (legendData) {\r\n                if (legendData.title) this._glOptions.title = legendData.title;\r\n                if (legendData.sections) this._glOptions.sections = legendData.sections;\r\n                if (legendData.footer) this._glOptions.footer = legendData.footer;\r\n\r\n                this._renderContent();\r\n            },\r\n\r\n            /**\r\n             * Bascule l'√©tat collapsed\r\n             * @private\r\n             */\r\n            _toggleCollapsed: function () {\r\n                const isCollapsed = this._container.classList.toggle(\"gl-map-legend--collapsed\");\r\n                this._glOptions.collapsed = isCollapsed;\r\n            },\r\n\r\n            /**\r\n             * Montre la l√©gende\r\n             * @public\r\n             */\r\n            show: function () {\r\n                if (this._container) {\r\n                    this._container.style.display = \"block\";\r\n                }\r\n            },\r\n\r\n            /**\r\n             * Cache la l√©gende\r\n             * @public\r\n             */\r\n            hide: function () {\r\n                if (this._container) {\r\n                    this._container.style.display = \"none\";\r\n                }\r\n            }\r\n        });\r\n\r\n        return new LegendControl({\r\n            position: options.position,\r\n            _glOptions: options\r\n        });\r\n    }\r\n\r\n    // Exposer dans l'espace de noms interne\r\n    GeoLeaf._LegendControl = {\r\n        create: createLegendControl\r\n    };\r\n\r\n})(window);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n/**\r\n * Module principal GeoLeaf.Legend\r\n * Gestionnaire de l√©gende cartographique multi-couches avec accord√©ons\r\n * G√©n√®re automatiquement les l√©gendes depuis les styles\r\n *\r\n * D√âPENDANCES:\r\n * - Leaflet (map instance)\r\n * - GeoLeaf.Log (optionnel)\r\n * - GeoLeaf._LegendControl\r\n * - GeoLeaf._LegendRenderer\r\n * - GeoLeaf._LegendGenerator (nouveau)\r\n * - GeoLeaf.Config (pour chargement configuration)\r\n *\r\n * EXPOSE:\r\n * - GeoLeaf.Legend\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = global.GeoLeaf = global.GeoLeaf || {};\r\n    const Log = GeoLeaf.Log;\r\n\r\n    let _map = null;\r\n    let _control = null;\r\n    let _options = {};\r\n    let _profileConfig = null;\r\n    let _taxonomyData = null;\r\n\r\n    // Timers and UI helpers\r\n    let _rebuildTimer = null;\r\n    const REBUILD_DEBOUNCE_MS = 150;\r\n    let _loadingOverlayEl = null;\r\n    let _loadingOverlayTimer = null;\r\n    const LOADING_OVERLAY_TIMEOUT_MS = 12000;\r\n\r\n    // Map<layerId, {label, styleId, legendData, visible, order, geometryType}>\r\n    const _allLayers = new Map();\r\n\r\n    function _normalizeGeometryType(rawGeometry) {\r\n        const value = (rawGeometry || \"\").toLowerCase();\r\n        if (value === \"polyline\" || value === \"line\") return \"line\";\r\n        if (value === \"polygon\") return \"polygon\";\r\n        return \"point\";\r\n    }\r\n\r\n    function _scheduleRebuild() {\r\n        if (_rebuildTimer) {\r\n            clearTimeout(_rebuildTimer);\r\n        }\r\n        _rebuildTimer = setTimeout(() => {\r\n            _rebuildTimer = null;\r\n            LegendModule._rebuildDisplay();\r\n        }, REBUILD_DEBOUNCE_MS);\r\n    }\r\n\r\n    function _ensureSpinnerStyles() {\r\n        if (document.getElementById(\"gl-legend-spinner-style\")) return;\r\n        const styleEl = document.createElement(\"style\");\r\n        styleEl.id = \"gl-legend-spinner-style\";\r\n        styleEl.textContent = \"@keyframes gl-legend-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }\";\r\n        document.head.appendChild(styleEl);\r\n    }\r\n\r\n    function _clearOverlayTimeout() {\r\n        if (_loadingOverlayTimer) {\r\n            clearTimeout(_loadingOverlayTimer);\r\n            _loadingOverlayTimer = null;\r\n        }\r\n    }\r\n\r\n    function _showLoadingOverlay() {\r\n        if (!_control || !_control._container) return;\r\n\r\n        _ensureSpinnerStyles();\r\n        _clearOverlayTimeout();\r\n\r\n        const container = _control._container;\r\n        if (!container.style.position) {\r\n            container.style.position = \"relative\";\r\n        }\r\n\r\n        if (!_loadingOverlayEl) {\r\n            const overlay = document.createElement(\"div\");\r\n            overlay.className = \"gl-map-legend__loading-overlay\";\r\n            overlay.style.position = \"absolute\";\r\n            overlay.style.inset = \"0\";\r\n            overlay.style.background = \"rgba(255,255,255,0.6)\";\r\n            overlay.style.display = \"flex\";\r\n            overlay.style.alignItems = \"center\";\r\n            overlay.style.justifyContent = \"center\";\r\n            overlay.style.pointerEvents = \"auto\";\r\n            overlay.style.zIndex = \"2\";\r\n            overlay.setAttribute(\"aria-hidden\", \"false\");\r\n\r\n            const spinner = document.createElement(\"div\");\r\n            spinner.className = \"gl-map-legend__spinner\";\r\n            spinner.style.width = \"34px\";\r\n            spinner.style.height = \"34px\";\r\n            spinner.style.border = \"3px solid rgba(0,0,0,0.12)\";\r\n            spinner.style.borderTop = \"3px solid rgba(0,0,0,0.55)\";\r\n            spinner.style.borderRadius = \"50%\";\r\n            spinner.style.animation = \"gl-legend-spin 1s linear infinite\";\r\n\r\n            overlay.appendChild(spinner);\r\n            _loadingOverlayEl = overlay;\r\n        }\r\n\r\n        if (!_loadingOverlayEl.parentElement) {\r\n            container.appendChild(_loadingOverlayEl);\r\n        }\r\n\r\n        container.setAttribute(\"aria-busy\", \"true\");\r\n        container.setAttribute(\"aria-live\", \"polite\");\r\n\r\n        _loadingOverlayTimer = setTimeout(() => {\r\n            _loadingOverlayTimer = null;\r\n            _hideLoadingOverlay();\r\n        }, LOADING_OVERLAY_TIMEOUT_MS);\r\n    }\r\n\r\n    function _hideLoadingOverlay() {\r\n        _clearOverlayTimeout();\r\n        if (_loadingOverlayEl && _loadingOverlayEl.parentElement) {\r\n            _loadingOverlayEl.parentElement.removeChild(_loadingOverlayEl);\r\n        }\r\n        if (_control && _control._container) {\r\n            _control._container.removeAttribute(\"aria-busy\");\r\n            _control._container.removeAttribute(\"aria-live\");\r\n        }\r\n    }\r\n\r\n    const LegendModule = {\r\n        /**\r\n         * Initialise le module Legend\r\n         * @param {L.Map} mapInstance - Instance de la carte Leaflet\r\n         * @param {Object} options - Options du module\r\n         * @param {string} [options.position=\"bottomleft\"] - Position du contr√¥le\r\n         * @param {boolean} [options.collapsible=true] - L√©gende repliable\r\n         * @param {boolean} [options.collapsed=false] - √âtat repli√© initial\r\n         */\r\n        init: function (mapInstance, options) {\r\n            if (!mapInstance) {\r\n                if (Log) Log.error(\"[Legend] Carte Leaflet requise pour initialiser Legend\");\r\n                return false;\r\n            }\r\n\r\n            _map = mapInstance;\r\n\r\n            // Charger la configuration depuis le profil\r\n            if (GeoLeaf.Config && typeof GeoLeaf.Config.get === \"function\") {\r\n                const legendConfig = GeoLeaf.Config.get(\"legendConfig\");\r\n\r\n                _options = Object.assign({\r\n                    position: (legendConfig && legendConfig.position) || \"bottomleft\",\r\n                    collapsible: true,\r\n                    collapsed: (legendConfig && legendConfig.collapsedByDefault) || false,\r\n                    title: (legendConfig && legendConfig.title) || \"L√©gende\"\r\n                }, options || {});\r\n\r\n                // R√©cup√©rer le profil actif complet\r\n                if (typeof GeoLeaf.Config.getActiveProfile === \"function\") {\r\n                    _profileConfig = GeoLeaf.Config.getActiveProfile();\r\n                } else {\r\n                    // Fallback : essayer de r√©cup√©rer depuis getAll\r\n                    const allConfig = GeoLeaf.Config.getAll();\r\n                    _profileConfig = {\r\n                        id: allConfig.id || GeoLeaf.Config.get('id'),\r\n                        layers: allConfig.layers || GeoLeaf.Config.get('layers') || []\r\n                    };\r\n                }\r\n            } else {\r\n                _options = Object.assign({\r\n                    position: \"bottomleft\",\r\n                    collapsible: true,\r\n                    collapsed: false,\r\n                    title: \"L√©gende\"\r\n                }, options || {});\r\n            }\r\n\r\n            // Charger la taxonomy pour les ic√¥nes\r\n            this._loadTaxonomy();\r\n\r\n            // Initialiser toutes les couches du profil\r\n            this._initializeAllLayers();\r\n\r\n            if (Log) Log.info(\"[Legend] Module Legend initialis√© avec g√©n√©ration automatique depuis styles\");\r\n            return true;\r\n        },\r\n\r\n        /**\r\n         * Charge la taxonomy pour la correspondance cat√©gories ‚Üí ic√¥nes\r\n         * @private\r\n         */\r\n        _loadTaxonomy: function () {\r\n            if (!_profileConfig) return;\r\n\r\n            const Config = GeoLeaf.Config;\r\n            const dataCfg = Config && Config.get ? Config.get('data') : null;\r\n            const profilesBasePath = (dataCfg && dataCfg.profilesBasePath) || \"profiles\";\r\n            const profileId = _profileConfig.id;\r\n\r\n            if (!profileId) {\r\n                if (Log) Log.warn(\"[Legend] Impossible de charger taxonomy sans profileId\");\r\n                return;\r\n            }\r\n\r\n            const taxonomyPath = `${profilesBasePath}/${profileId}/taxonomy.json`;\r\n\r\n            fetch(taxonomyPath)\r\n                .then(response => {\r\n                    if (!response.ok) throw new Error(`HTTP ${response.status}`);\r\n                    return response.json();\r\n                })\r\n                .then(data => {\r\n                    _taxonomyData = data;\r\n                    if (Log) Log.debug(\"[Legend] Taxonomy charg√©e\");\r\n                })\r\n                .catch(err => {\r\n                    if (Log) Log.warn(`[Legend] Erreur chargement taxonomy: ${err.message}`);\r\n                });\r\n        },\r\n\r\n        /**\r\n         * Initialise toutes les couches d√©finies dans le profil\r\n         * @private\r\n         */\r\n        _initializeAllLayers: function () {\r\n            if (!_profileConfig || !Array.isArray(_profileConfig.layers)) {\r\n                if (Log) Log.warn(\"[Legend] Aucune couche d√©finie dans le profil\");\r\n                return;\r\n            }\r\n\r\n            _profileConfig.layers.forEach((layerDef, index) => {\r\n                _allLayers.set(layerDef.id, {\r\n                    label: layerDef.id, // Sera mis √† jour lors du chargement du config\r\n                    styleId: null,\r\n                    legendData: null,\r\n                    visible: false,\r\n                    order: index + 1,\r\n                    geometryType: null,\r\n                    configFile: layerDef.configFile\r\n                });\r\n            });\r\n\r\n            if (Log) Log.debug(`[Legend] ${_allLayers.size} couche(s) initialis√©e(s)`);\r\n        },\r\n\r\n        /**\r\n         * Charge et g√©n√®re la l√©gende pour une couche\r\n         * @param {string} layerId - ID de la couche\r\n         * @param {string} styleId - ID du style √† appliquer\r\n         * @param {Object} layerConfig - Configuration de la couche\r\n         */\r\n        loadLayerLegend: function (layerId, styleId, layerConfig) {\r\n            if (!_map) {\r\n                if (Log) Log.warn(\"[Legend] Module non initialis√©\");\r\n                return;\r\n            }\r\n\r\n            const layerInfo = _allLayers.get(layerId);\r\n            if (!layerInfo) {\r\n                if (Log) Log.warn(`[Legend] Couche ${layerId} non trouv√©e dans le profil`);\r\n                return;\r\n            }\r\n\r\n            // S'assurer que le sprite SVG est disponible d√®s le d√©but\r\n            if (GeoLeaf._POIMarkers && typeof GeoLeaf._POIMarkers.ensureProfileSpriteInjectedSync === \"function\") {\r\n                GeoLeaf._POIMarkers.ensureProfileSpriteInjectedSync();\r\n                if (Log) Log.debug(`[Legend] Sprite SVG demand√© pour couche ${layerId}`);\r\n            }\r\n\r\n            // Mettre √† jour les informations de la couche\r\n            layerInfo.label = layerConfig.label || layerId;\r\n            layerInfo.geometryType = _normalizeGeometryType(layerConfig.geometryType || layerConfig.geometry || layerInfo.geometryType || \"point\");\r\n            layerInfo.styleId = styleId;\r\n\r\n            // Charger le fichier de style\r\n            const Config = GeoLeaf.Config;\r\n            const dataCfg = Config && Config.get ? Config.get('data') : null;\r\n            const profilesBasePath = (dataCfg && dataCfg.profilesBasePath) || \"profiles\";\r\n            const profileId = layerConfig._profileId || _profileConfig.id;\r\n            const layerDir = layerConfig._layerDirectory;\r\n\r\n            if (!layerConfig.styles || !layerConfig.styles.directory) {\r\n                if (Log) Log.warn(`[Legend] Configuration styles manquante pour ${layerId}`);\r\n                return;\r\n            }\r\n\r\n            const stylesDir = layerConfig.styles.directory;\r\n            const styleFile = layerConfig.styles.available?.find(s => s.id === styleId)?.file\r\n                            || layerConfig.styles.default;\r\n\r\n            const stylePath = `${profilesBasePath}/${profileId}/${layerDir}/${stylesDir}/${styleFile}`;\r\n\r\n            if (Log) Log.debug(`[Legend] Chargement style: ${stylePath}`);\r\n\r\n            fetch(stylePath)\r\n                .then(response => {\r\n                    if (!response.ok) throw new Error(`HTTP ${response.status}`);\r\n                    return response.json();\r\n                })\r\n                .then(styleData => {\r\n                    // G√©n√©rer la l√©gende depuis le style\r\n                    if (!GeoLeaf._LegendGenerator) {\r\n                        if (Log) Log.error(\"[Legend] LegendGenerator non disponible\");\r\n                        return;\r\n                    }\r\n\r\n                    // Temporairement stocker la config de couche pour le g√©n√©rateur (comme dans markers.js)\r\n                    const originalPOIShared = GeoLeaf._POIShared;\r\n                    if (layerConfig.showIconsOnMap !== undefined) {\r\n                        // Cr√©er un √©tat temporaire pour cette couche\r\n                        GeoLeaf._POIShared = {\r\n                            state: {\r\n                                poiConfig: {\r\n                                    showIconsOnMap: layerConfig.showIconsOnMap\r\n                                }\r\n                            }\r\n                        };\r\n                    }\r\n\r\n                    const legendData = GeoLeaf._LegendGenerator.generateLegendFromStyle(\r\n                        styleData,\r\n                        layerInfo.geometryType,\r\n                        _taxonomyData\r\n                    );\r\n\r\n                    // Restaurer l'√©tat POI original\r\n                    if (layerConfig.showIconsOnMap !== undefined) {\r\n                        GeoLeaf._POIShared = originalPOIShared;\r\n                    }\r\n\r\n                    if (legendData) {\r\n                        layerInfo.legendData = legendData;\r\n                        _allLayers.set(layerId, layerInfo);\r\n                        if (Log) Log.debug(`[Legend] L√©gende g√©n√©r√©e pour ${layerId}`);\r\n\r\n                        // Reconstruire l'affichage\r\n                        _scheduleRebuild();\r\n                    }\r\n                })\r\n                .catch(err => {\r\n                    if (Log) Log.warn(`[Legend] Erreur chargement style: ${err.message}`);\r\n                });\r\n        },\r\n\r\n        /**\r\n         * Met √† jour la visibilit√© d'une couche dans la l√©gende\r\n         * @param {string} layerId - ID de la couche\r\n         * @param {boolean} visible - Visible ou non\r\n         */\r\n        setLayerVisibility: function (layerId, visible) {\r\n            const layerInfo = _allLayers.get(layerId);\r\n            if (layerInfo) {\r\n                layerInfo.visible = visible;\r\n                _allLayers.set(layerId, layerInfo);\r\n                _scheduleRebuild();\r\n                if (Log) Log.debug(`[Legend] Visibilit√© de ${layerId}: ${visible}`);\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Reconstruit l'affichage de toutes les l√©gendes\r\n         * @private\r\n         */\r\n        _rebuildDisplay: function () {\r\n            if (!_map) return;\r\n\r\n            // Si aucune couche, supprimer le contr√¥le\r\n            if (_allLayers.size === 0) {\r\n                if (_control && _map) {\r\n                    _map.removeControl(_control);\r\n                    _control = null;\r\n                }\r\n                return;\r\n            }\r\n\r\n            // Cr√©er le contr√¥le si n√©cessaire\r\n            if (!_control) {\r\n                _control = GeoLeaf._LegendControl.create(_options);\r\n                if (_control) {\r\n                    _map.addControl(_control);\r\n                }\r\n            }\r\n\r\n            // Pr√©parer les donn√©es pour le rendu (afficher toutes les couches)\r\n            if (_control && typeof _control.updateMultiLayerContent === \"function\") {\r\n                const visibilityManager = GeoLeaf._LayerVisibilityManager;\r\n                const legendsArray = [];\r\n\r\n                _allLayers.forEach((data, layerId) => {\r\n                    if (!data.legendData) return;\r\n\r\n                    const visState = visibilityManager && typeof visibilityManager.getVisibilityState === \"function\"\r\n                        ? visibilityManager.getVisibilityState(layerId)\r\n                        : null;\r\n\r\n                    const isVisible = visState ? visState.current : data.visible;\r\n                    if (!isVisible) return;\r\n\r\n                    legendsArray.push({\r\n                        layerId: layerId,\r\n                        label: data.label,\r\n                        collapsed: true,\r\n                        order: data.order,\r\n                        visible: true,\r\n                        sections: data.legendData.sections || []\r\n                    });\r\n                });\r\n\r\n                // Trier par ordre\r\n                legendsArray.sort((a, b) => a.order - b.order);\r\n\r\n                _control.updateMultiLayerContent(legendsArray);\r\n\r\n                // Si nous avons des ic√¥nes mais pas de sprite, programmer un retry\r\n                const hasIcons = legendsArray.some(legend =>\r\n                    legend.sections.some(section =>\r\n                        section.items && section.items.some(item => item.icon)\r\n                    )\r\n                );\r\n\r\n                if (hasIcons) {\r\n                    const sprite = document.querySelector('svg[data-geoleaf-sprite=\"profile\"]');\r\n                    if (!sprite) {\r\n                        if (Log) Log.info(\"[Legend] Ic√¥nes d√©tect√©es mais sprite manquant - programmation retry\");\r\n                        // Programmer un nouveau rendu dans 2 secondes\r\n                        setTimeout(() => {\r\n                            const spriteCheck = document.querySelector('svg[data-geoleaf-sprite=\"profile\"]');\r\n                            if (spriteCheck && Log) {\r\n                                Log.info(\"[Legend] Sprite disponible - nouveau rendu de la l√©gende\");\r\n                                this._rebuildDisplay();\r\n                            }\r\n                        }, 2000);\r\n                    }\r\n                }\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Bascule l'√©tat d'un accord√©on\r\n         * @param {string} layerId - ID de la couche\r\n         */\r\n        toggleAccordion: function (layerId) {\r\n            // G√©r√© visuellement par le renderer\r\n        },\r\n\r\n        /**\r\n         * R√©cup√®re toutes les couches\r\n         * @returns {Map}\r\n         */\r\n        getAllLayers: function () {\r\n            return _allLayers;\r\n        },\r\n\r\n        // ===== Anciennes m√©thodes pour compatibilit√© =====\r\n\r\n        /**\r\n         * @deprecated Utiliser loadLayerLegend √† la place\r\n         */\r\n        addLayerLegend: function (layerId, styleId, legendData) {\r\n            if (Log) Log.warn(\"[Legend] addLayerLegend() est d√©pr√©ci√© avec donn√©es JSON, utiliser loadLayerLegend avec style\");\r\n            // Ajouter quand m√™me pour compatibilit√©\r\n            const layerInfo = _allLayers.get(layerId);\r\n            if (layerInfo) {\r\n                layerInfo.legendData = legendData;\r\n                layerInfo.styleId = styleId;\r\n                _allLayers.set(layerId, layerInfo);\r\n                this._rebuildDisplay();\r\n            }\r\n        },\r\n\r\n        /**\r\n         * @deprecated Utiliser setLayerVisibility √† la place\r\n         */\r\n        removeLayerLegend: function (layerId) {\r\n            if (Log) Log.warn(\"[Legend] removeLayerLegend() est d√©pr√©ci√©, utiliser setLayerVisibility(id, false)\");\r\n            this.setLayerVisibility(layerId, false);\r\n        },\r\n\r\n        /**\r\n         * @deprecated Utiliser loadLayerLegend √† la place\r\n         */\r\n        updateLayerLegend: function (layerId, styleId, legendData) {\r\n            if (Log) Log.warn(\"[Legend] updateLayerLegend() avec JSON est d√©pr√©ci√©, utiliser loadLayerLegend\");\r\n            this.addLayerLegend(layerId, styleId, legendData);\r\n        },\r\n\r\n        /**\r\n         * @deprecated\r\n         */\r\n        loadLegend: function (legendFilePath) {\r\n            if (Log) Log.warn(\"[Legend] loadLegend() est d√©pr√©ci√©\");\r\n            return Promise.resolve(false);\r\n        },\r\n\r\n        /**\r\n         * @deprecated\r\n         */\r\n        showLegend: function (legendData) {\r\n            if (Log) Log.warn(\"[Legend] showLegend() est d√©pr√©ci√©\");\r\n        },\r\n\r\n        /**\r\n         * Cache la l√©gende\r\n         */\r\n        hideLegend: function () {\r\n            if (_control) {\r\n                _control.hide();\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Supprime toutes les l√©gendes\r\n         */\r\n        removeLegend: function () {\r\n            _allLayers.forEach((layerInfo, layerId) => {\r\n                layerInfo.legendData = null;\r\n                layerInfo.visible = false;\r\n            });\r\n\r\n            if (_control && _map) {\r\n                _map.removeControl(_control);\r\n                _control = null;\r\n                if (Log) Log.debug(\"[Legend] Toutes les l√©gendes supprim√©es\");\r\n            }\r\n        },\r\n\r\n        /**\r\n         * V√©rifie si des l√©gendes sont affich√©es\r\n         * @returns {boolean}\r\n         */\r\n        isLegendVisible: function () {\r\n            return _control !== null && _allLayers.size > 0;\r\n        },\r\n\r\n        showLoadingOverlay: function () {\r\n            _showLoadingOverlay();\r\n        },\r\n\r\n        hideLoadingOverlay: function () {\r\n            _hideLoadingOverlay();\r\n        }\r\n    };\r\n\r\n    // Exposer le module public\r\n    GeoLeaf.Legend = LegendModule;\r\n\r\n})(window);\r\n","/**\r\n * Module Label Renderer pour GeoLeaf\r\n * Cr√©e et g√®re les tooltips permanents Leaflet pour les √©tiquettes\r\n *\r\n * D√âPENDANCES:\r\n * - Leaflet (L.Tooltip, L.LatLng)\r\n * - GeoLeaf.Log (optionnel)\r\n *\r\n * EXPOSE:\r\n * - GeoLeaf._LabelRenderer\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = global.GeoLeaf = global.GeoLeaf || {};\r\n    const Log = GeoLeaf.Log;\r\n\r\n    /**\r\n     * Module Label Renderer\r\n     * @namespace _LabelRenderer\r\n     * @private\r\n     */\r\n    const _LabelRenderer = {\r\n        /**\r\n         * Cr√©e les tooltips permanents pour toutes les features d'une couche\r\n         * @param {string} layerId - ID de la couche\r\n         * @param {L.LayerGroup} leafletLayer - Couche Leaflet (LayerGroup ou FeatureGroup)\r\n         * @param {Object} labelConfig - Configuration des labels\r\n         * @param {Object} style - Style des labels (extrait de currentStyle.label)\r\n         * @param {Map} tooltipsMap - Map pour stocker les tooltips cr√©√©s\r\n         */\r\n        createTooltipsForLayer(layerId, leafletLayer, labelConfig, style, tooltipsMap) {\r\n            if (!leafletLayer || !labelConfig || !labelConfig.labelId) {\r\n                if (Log) Log.warn(\"[LabelRenderer] Param√®tres invalides pour createTooltipsForLayer\", {\r\n                    layerId,\r\n                    hasLeafletLayer: !!leafletLayer,\r\n                    hasLabelConfig: !!labelConfig,\r\n                    labelId: labelConfig?.labelId,\r\n                    labelConfigKeys: labelConfig ? Object.keys(labelConfig) : null\r\n                });\r\n                return;\r\n            }\r\n\r\n            const labelField = labelConfig.labelId;\r\n\r\n            if (Log) Log.debug(`[LabelRenderer] Cr√©ation tooltips pour ${layerId}, champ: ${labelField}`);\r\n\r\n            // Parcourir toutes les features de la couche\r\n            let featureCount = 0;\r\n\r\n            leafletLayer.eachLayer((featureLayer) => {\r\n                featureCount++;\r\n                try {\r\n                    this._createTooltipForFeature(\r\n                        featureLayer,\r\n                        labelField,\r\n                        style,\r\n                        tooltipsMap\r\n                    );\r\n                } catch (err) {\r\n                    if (Log) Log.warn(\"[LabelRenderer] Erreur cr√©ation tooltip:\", err);\r\n                }\r\n            });\r\n\r\n            if (Log) Log.debug(`[LabelRenderer] ${tooltipsMap.size} tooltips cr√©√©s pour ${layerId} (${featureCount} features parcourues)`);\r\n        },\r\n\r\n        /**\r\n         * Cr√©e un marker texte (label) pour une feature\r\n         * @private\r\n         * @param {L.Layer} featureLayer - Layer Leaflet de la feature\r\n         * @param {string} labelField - Nom du champ √† afficher\r\n         * @param {Object} style - Style du label\r\n         * @param {Map} tooltipsMap - Map pour stocker le marker\r\n         */\r\n        _createTooltipForFeature(featureLayer, labelField, style, tooltipsMap) {\r\n            // R√©cup√©rer les donn√©es GeoJSON de la feature\r\n            const feature = featureLayer.feature;\r\n            if (!feature || !feature.properties) {\r\n                if (Log) Log.debug(\"[LabelRenderer] Feature ou properties manquant\");\r\n                return;\r\n            }\r\n\r\n            // Extraire la valeur du champ label\r\n            const labelValue = this._extractFieldValue(feature.properties, labelField);\r\n            if (!labelValue) {\r\n                return;\r\n            }\r\n\r\n            // R√©cup√©rer la position (centre de la g√©om√©trie)\r\n            let position = null;\r\n\r\n            if (typeof featureLayer.getLatLng === \"function\") {\r\n                // Pour les points\r\n                position = featureLayer.getLatLng();\r\n            } else if (typeof featureLayer.getBounds === \"function\") {\r\n                // Pour les polygones (Polygon, MultiPolygon) - centre du bounding box\r\n                // IMPORTANT: V√©rifier getBounds AVANT getLatLngs car les polygones ont les deux!\r\n                const bounds = featureLayer.getBounds();\r\n                if (bounds && typeof bounds.getCenter === \"function\") {\r\n                    position = bounds.getCenter();\r\n                    if (Log) Log.info(\"[LabelRenderer] Position polygone calcul√©e:\", {\r\n                        labelValue,\r\n                        position: position,\r\n                        positionType: typeof position,\r\n                        hasLat: 'lat' in position,\r\n                        hasLng: 'lng' in position,\r\n                        latType: typeof position.lat,\r\n                        lngType: typeof position.lng,\r\n                        positionKeys: Object.keys(position)\r\n                    });\r\n                } else {\r\n                    if (Log) Log.warn(\"[LabelRenderer] getBounds ne retourne pas getCenter pour:\", labelValue);\r\n                }\r\n            } else if (typeof featureLayer.getLatLngs === \"function\") {\r\n                // Pour les lignes - prendre le point du milieu de la ligne\r\n                const latlngs = featureLayer.getLatLngs();\r\n                if (latlngs && latlngs.length > 0) {\r\n                    // Si c'est un MultiLineString ou une ligne complexe\r\n                    const flatLatlngs = Array.isArray(latlngs[0]) ? latlngs[0] : latlngs;\r\n                    if (flatLatlngs && flatLatlngs.length > 0) {\r\n                        const middleIndex = Math.floor(flatLatlngs.length / 2);\r\n                        position = flatLatlngs[middleIndex];\r\n                    }\r\n                }\r\n            }\r\n\r\n            // V√©rifier que position est valide\r\n            // Note: Leaflet LatLng peut avoir lat/lng comme propri√©t√©s OU comme m√©thodes\r\n            if (!position) {\r\n                if (Log) Log.debug(\"[LabelRenderer] Position null pour feature, skipping label. Label:\", labelValue);\r\n                return;\r\n            }\r\n\r\n            const lat = typeof position.lat === 'function' ? position.lat() : position.lat;\r\n            const lng = typeof position.lng === 'function' ? position.lng() : position.lng;\r\n\r\n            if (!lat || !lng || isNaN(lat) || isNaN(lng)) {\r\n                return;\r\n            }\r\n\r\n            // Cr√©er un divIcon avec le texte du label\r\n            const htmlContent = this._formatLabelContent(labelValue, style);\r\n\r\n            const labelIcon = global.L.divIcon({\r\n                html: htmlContent,\r\n                className: this._buildClassName(style),\r\n                iconSize: null, // Auto-size\r\n                iconAnchor: [0, 0] // Position relative au point\r\n            });\r\n\r\n            // Cr√©er un marker avec cet ic√¥ne texte\r\n            const labelMarker = global.L.marker([lat, lng], {\r\n                icon: labelIcon,\r\n                interactive: false, // Ne pas intercepter les clics\r\n                keyboard: false\r\n            });\r\n\r\n            // Ajouter au map\r\n            const map = GeoLeaf.Core && GeoLeaf.Core.getMap ? GeoLeaf.Core.getMap() : null;\r\n            if (map) {\r\n                labelMarker.addTo(map);\r\n\r\n                // Stocker dans la map\r\n                const featureId = feature.id || feature.properties.id || `feature_${Date.now()}_${Math.random()}`;\r\n                tooltipsMap.set(featureId, labelMarker);\r\n            } else {\r\n                if (Log) Log.warn(\"[LabelRenderer] Carte non disponible pour\", labelValue);\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Extrait la valeur d'un champ depuis les propri√©t√©s\r\n         * Supporte la notation point√©e (ex: \"attributes.name\")\r\n         * @private\r\n         */\r\n        _extractFieldValue(properties, fieldPath) {\r\n            if (!properties || !fieldPath) return null;\r\n\r\n            // Si pas de point, acc√®s direct\r\n            if (!fieldPath.includes(\".\")) {\r\n                return properties[fieldPath];\r\n            }\r\n\r\n            // Notation point√©e\r\n            const parts = fieldPath.split(\".\");\r\n            let value = properties;\r\n\r\n            for (const part of parts) {\r\n                if (value && typeof value === \"object\" && part in value) {\r\n                    value = value[part];\r\n                } else {\r\n                    return null;\r\n                }\r\n            }\r\n\r\n            return value;\r\n        },\r\n\r\n        /**\r\n         * Parse l'offset depuis le style\r\n         * @private\r\n         */\r\n        _parseOffset(offset) {\r\n            if (!offset) return [0, 0];\r\n\r\n            if (Array.isArray(offset) && offset.length === 2) {\r\n                return [\r\n                    typeof offset[0] === \"number\" ? offset[0] : 0,\r\n                    typeof offset[1] === \"number\" ? offset[1] : 0\r\n                ];\r\n            }\r\n\r\n            return [0, 0];\r\n        },\r\n\r\n        /**\r\n         * Construit le nom de classe CSS pour le tooltip\r\n         * @private\r\n         */\r\n        _buildClassName(style) {\r\n            const classes = [\"gl-label\"];\r\n\r\n            if (style) {\r\n                if (style.className) {\r\n                    classes.push(style.className);\r\n                }\r\n\r\n                // Ajouter des classes bas√©es sur les propri√©t√©s de style\r\n                if (style.variant) {\r\n                    classes.push(`gl-label--${style.variant}`);\r\n                }\r\n            }\r\n\r\n            return classes.join(\" \");\r\n        },\r\n\r\n        /**\r\n         * Formate le contenu du label\r\n         * @private\r\n         */\r\n        _formatLabelContent(value, style) {\r\n            if (!value) return \"\";\r\n\r\n            let content = String(value);\r\n\r\n            // Appliquer un pr√©fixe/suffixe si d√©fini\r\n            if (style) {\r\n                if (style.prefix) {\r\n                    content = style.prefix + content;\r\n                }\r\n                if (style.suffix) {\r\n                    content = content + style.suffix;\r\n                }\r\n            }\r\n\r\n            // Cr√©er le HTML du label\r\n            const div = global.document.createElement(\"div\");\r\n            div.className = \"gl-label__content\";\r\n            div.textContent = content;\r\n\r\n            // Appliquer les styles inline si d√©finis\r\n            if (style) {\r\n                this._applyInlineStyles(div, style);\r\n            }\r\n\r\n            // Retourner le HTML string, pas l'√©l√©ment DOM\r\n            return div.outerHTML;\r\n        },\r\n\r\n        /**\r\n         * Applique les styles inline au contenu du label\r\n         * @private\r\n         */\r\n        _applyInlineStyles(element, style) {\r\n            if (!element || !style) return;\r\n\r\n            // Appliquer les styles de police et couleur avec setProperty + important pour forcer la priorit√© sur le CSS\r\n            if (style.font) {\r\n                if (style.font.family) {\r\n                    // Ajouter un fallback pour assurer la lisibilit√© si la police demand√©e n'est pas disponible\r\n                    const fontFamily = `\"${style.font.family}\", -apple-system, BlinkMacSystemFont, \"Segoe UI\", Arial, sans-serif`;\r\n                    element.style.setProperty('font-family', fontFamily, 'important');\r\n                }\r\n                if (style.font.sizePt) {\r\n                    element.style.setProperty('font-size', `${style.font.sizePt}pt`, 'important');\r\n                }\r\n                if (style.font.bold) {\r\n                    element.style.setProperty('font-weight', 'bold', 'important');\r\n                } else if (style.font.weight) {\r\n                    // Pour am√©liorer la lisibilit√©, forcer un poids minimum de 500 si < 400\r\n                    const weight = style.font.weight < 400 ? 500 : style.font.weight;\r\n                    element.style.setProperty('font-weight', weight, 'important');\r\n                }\r\n                if (style.font.italic) {\r\n                    element.style.setProperty('font-style', 'italic', 'important');\r\n                }\r\n            }\r\n\r\n            // Appliquer la couleur du texte avec !important\r\n            if (style.color) {\r\n                element.style.setProperty('color', style.color, 'important');\r\n            }\r\n\r\n            // Appliquer l'opacit√© du texte\r\n            if (style.opacity !== undefined) {\r\n                element.style.setProperty('opacity', style.opacity, 'important');\r\n            }\r\n\r\n            // Appliquer le buffer (text-shadow pour contour) avec !important\r\n            if (style.buffer && style.buffer.enabled) {\r\n                const bufferColor = style.buffer.color || '#ffffff';\r\n                const bufferOpacity = style.buffer.opacity !== undefined ? style.buffer.opacity : 1;\r\n                const bufferSize = style.buffer.sizePx || 2;\r\n\r\n                // Convertir la couleur hex + opacit√© en rgba\r\n                const rgba = this._hexToRgba(bufferColor, bufferOpacity);\r\n\r\n                // Cr√©er un text-shadow multi-couches pour un contour plus net et visible\r\n                const shadowParts = [];\r\n\r\n                // Couche 1: Contour net avec de nombreux angles pour une couverture compl√®te\r\n                for (let angle = 0; angle < 360; angle += 30) {\r\n                    const rad = angle * Math.PI / 180;\r\n                    const x = Math.cos(rad) * bufferSize;\r\n                    const y = Math.sin(rad) * bufferSize;\r\n                    shadowParts.push(`${x.toFixed(2)}px ${y.toFixed(2)}px 0 ${rgba}`);\r\n                }\r\n\r\n                // Couche 2: Contour interm√©diaire pour plus de densit√© (meilleure couverture)\r\n                for (let angle = 15; angle < 360; angle += 30) {\r\n                    const rad = angle * Math.PI / 180;\r\n                    const x = Math.cos(rad) * bufferSize * 0.7;\r\n                    const y = Math.sin(rad) * bufferSize * 0.7;\r\n                    shadowParts.push(`${x.toFixed(2)}px ${y.toFixed(2)}px 0 ${rgba}`);\r\n                }\r\n\r\n                // Couche 3: Effet glow plus prononc√© pour renforcer le contraste\r\n                shadowParts.push(`0 0 ${bufferSize * 0.8}px ${rgba}`);\r\n                shadowParts.push(`0 0 ${bufferSize * 1.5}px ${rgba}`);\r\n\r\n                element.style.setProperty('text-shadow', shadowParts.join(', '), 'important');\r\n            }\r\n\r\n            // Appliquer textTransform\r\n            if (style.textTransform) {\r\n                element.style.setProperty('text-transform', style.textTransform, 'important');\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Convertit une couleur hex en rgba\r\n         * @private\r\n         */\r\n        _hexToRgba(hex, opacity) {\r\n            if (!hex) return `rgba(0, 0, 0, ${opacity})`;\r\n\r\n            // Enlever le # si pr√©sent\r\n            hex = hex.replace('#', '');\r\n\r\n            // G√©rer les formats courts (#RGB) et longs (#RRGGBB)\r\n            if (hex.length === 3) {\r\n                hex = hex.split('').map(c => c + c).join('');\r\n            }\r\n\r\n            const r = parseInt(hex.substring(0, 2), 16);\r\n            const g = parseInt(hex.substring(2, 4), 16);\r\n            const b = parseInt(hex.substring(4, 6), 16);\r\n\r\n            return `rgba(${r}, ${g}, ${b}, ${opacity})`;\r\n        }\r\n    };\r\n\r\n    // Exposer dans l'espace de noms interne\r\n    GeoLeaf._LabelRenderer = _LabelRenderer;\r\n\r\n})(window);\r\n","/**\r\n * Gestionnaire centralis√© pour le bouton de label dans le Layer Manager\r\n *\r\n * RESPONSABILIT√âS:\r\n * - Cr√©er le bouton de label lors du premier render d'une couche\r\n * - Synchroniser l'√©tat du bouton (activ√©/d√©sactiv√©, actif/inactif)\r\n * - Source unique de v√©rit√© pour la logique de d√©cision\r\n *\r\n * LOGIQUE SIMPLIFI√âE:\r\n * - Le bouton est TOUJOURS visible pour toutes les couches\r\n * - Si couche visible ET label.enabled: true ‚Üí bouton cliquable\r\n * - Sinon ‚Üí bouton d√©sactiv√© (gris√©)\r\n * - √âtat actif/inactif selon si les labels sont actuellement affich√©s\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = global.GeoLeaf = global.GeoLeaf || {};\r\n    const Log = GeoLeaf.Log;\r\n\r\n    /**\r\n     * Gestionnaire de boutons de label\r\n     */\r\n    const LabelButtonManager = {\r\n        /**\r\n         * Cr√©e le bouton de label pour une couche\r\n         * Appel√© uniquement lors du premier render du layer manager\r\n         * @param {string} layerId - ID de la couche\r\n         * @param {HTMLElement} controlsContainer - Conteneur des contr√¥les\r\n         * @returns {HTMLElement|null} Le bouton cr√©√© ou null si √©chec\r\n         */\r\n        createButton(layerId, controlsContainer) {\r\n            if (!layerId || !controlsContainer) {\r\n                if (Log) Log.warn(\"[LabelButtonManager] createButton: param√®tres manquants\", {layerId, hasContainer: !!controlsContainer});\r\n                return null;\r\n            }\r\n\r\n            // V√©rifier si le bouton existe d√©j√†\r\n            const existingButton = controlsContainer.querySelector('.gl-layer-manager__label-toggle');\r\n            if (existingButton) {\r\n                if (Log) Log.debug(\"[LabelButtonManager] Bouton d√©j√† existant pour:\", layerId);\r\n                return existingButton;\r\n            }\r\n\r\n            if (Log) Log.debug(\"[LabelButtonManager] Cr√©ation du bouton pour:\", layerId);\r\n\r\n            // Cr√©er le bouton (toujours visible, sera activ√©/d√©sactiv√© selon label.enabled)\r\n            const labelToggle = global.L.DomUtil.create(\"button\", \"gl-layer-manager__label-toggle\");\r\n            labelToggle.type = \"button\";\r\n            labelToggle.setAttribute(\"aria-label\", \"Afficher/masquer les √©tiquettes\");\r\n            // D√©sactiv√© par d√©faut jusqu'√† la synchronisation\r\n            labelToggle.disabled = true;\r\n            labelToggle.classList.add(\"gl-layer-manager__label-toggle--disabled\");\r\n\r\n            const iconSpan = document.createElement(\"span\");\r\n            iconSpan.className = \"gl-layer-manager__label-toggle-icon\";\r\n            iconSpan.textContent = \"üè∑Ô∏è\";\r\n            labelToggle.appendChild(iconSpan);\r\n            labelToggle.title = \"Afficher/masquer les √©tiquettes\";\r\n\r\n            // Gestionnaire de clic\r\n            const onLabelToggle = function (ev) {\r\n                if (global.L && global.L.DomEvent) global.L.DomEvent.stopPropagation(ev);\r\n                ev.preventDefault();\r\n\r\n                if (labelToggle.disabled) return;\r\n\r\n                try {\r\n                    // V√©rifier que le style actuel autorise les labels\r\n                    const layerData = global.GeoLeaf?.GeoJSON?.getLayerById?.(layerId);\r\n                    const labelEnabled = layerData?.currentStyle?.label?.enabled === true;\r\n\r\n                    if (!labelEnabled) {\r\n                        if (Log) Log.warn(\"[LabelButtonManager] Impossible d'afficher les labels: le style actuel a label.enabled=false\");\r\n                        return;\r\n                    }\r\n\r\n                    // Toggle les labels\r\n                    if (global.GeoLeaf?.Labels?.toggleLabels) {\r\n                        const newState = global.GeoLeaf.Labels.toggleLabels(layerId);\r\n\r\n                        // Mettre √† jour l'√©tat visuel du bouton IMM√âDIATEMENT\r\n                        if (newState) {\r\n                            labelToggle.classList.add(\"gl-layer-manager__label-toggle--on\");\r\n                            labelToggle.setAttribute(\"aria-pressed\", \"true\");\r\n                        } else {\r\n                            labelToggle.classList.remove(\"gl-layer-manager__label-toggle--on\");\r\n                            labelToggle.setAttribute(\"aria-pressed\", \"false\");\r\n                        }\r\n                    }\r\n                } catch (err) {\r\n                    if (Log) Log.warn(\"[LabelButtonManager] Erreur lors du toggle des labels:\", err);\r\n                }\r\n            };\r\n\r\n            // Attacher le gestionnaire\r\n            if (GeoLeaf._UIComponents && typeof GeoLeaf._UIComponents.attachEventHandler === 'function') {\r\n                GeoLeaf._UIComponents.attachEventHandler(labelToggle, \"click\", onLabelToggle);\r\n            } else if (global.L && global.L.DomEvent) {\r\n                global.L.DomEvent.on(labelToggle, \"click\", onLabelToggle);\r\n                global.L.DomEvent.disableClickPropagation(labelToggle);\r\n            } else {\r\n                labelToggle.addEventListener(\"click\", onLabelToggle);\r\n            }\r\n\r\n            // Ins√©rer le bouton avant le toggle de visibilit√©\r\n            const visibilityToggle = controlsContainer.querySelector('.gl-layer-manager__item-toggle');\r\n            if (visibilityToggle) {\r\n                controlsContainer.insertBefore(labelToggle, visibilityToggle);\r\n            } else {\r\n                controlsContainer.appendChild(labelToggle);\r\n            }\r\n\r\n            if (Log) Log.debug(\"[LabelButtonManager] Bouton cr√©√© avec succ√®s:\", layerId);\r\n\r\n            return labelToggle;\r\n        },\r\n\r\n        /**\r\n         * Synchronise l'√©tat du bouton de label\r\n         * UNIQUE POINT D'ENTR√âE pour mettre √† jour le bouton\r\n         * @param {string} layerId - ID de la couche\r\n         */\r\n        sync(layerId) {\r\n            if (!layerId) return;\r\n\r\n            // D√©bounce pour √©viter les mises √† jour trop fr√©quentes\r\n            if (this._syncTimeouts && this._syncTimeouts.has(layerId)) {\r\n                clearTimeout(this._syncTimeouts.get(layerId));\r\n            }\r\n\r\n            if (!this._syncTimeouts) {\r\n                this._syncTimeouts = new Map();\r\n            }\r\n\r\n            const timeout = setTimeout(() => {\r\n                this._syncTimeouts.delete(layerId);\r\n                this._doSync(layerId);\r\n            }, 300);\r\n\r\n            this._syncTimeouts.set(layerId, timeout);\r\n        },\r\n\r\n        /**\r\n         * Ex√©cute la synchronisation imm√©diate (m√©thode interne)\r\n         * @private\r\n         */\r\n        _doSync(layerId) {\r\n            if (!layerId) return;\r\n\r\n            // Trouver le bouton - chercher directement dans tout le document\r\n            // car le Layer Manager peut recr√©er des √©l√©ments\r\n            let button = document.querySelector(`[data-layer-id=\"${layerId}\"] .gl-layer-manager__label-toggle`);\r\n\r\n            if (!button) {\r\n                // Fallback: chercher le layerItem et cr√©er le bouton si n√©cessaire\r\n                const layerItem = document.querySelector(`[data-layer-id=\"${layerId}\"]`);\r\n                if (!layerItem) {\r\n                    if (Log) Log.debug(\"[LabelButtonManager] LayerItem non trouv√© (pas encore rendu):\", layerId);\r\n                    return;\r\n                }\r\n\r\n                const controlsContainer = layerItem.querySelector('.gl-layer-manager__item-controls');\r\n                if (controlsContainer) {\r\n                    // V√©rifier si le bouton existe d√©j√† dans controls\r\n                    button = controlsContainer.querySelector('.gl-layer-manager__label-toggle');\r\n                    if (!button) {\r\n                        if (Log) Log.debug(\"[LabelButtonManager] Bouton manquant dans controls, cr√©ation √† la vol√©e pour:\", layerId);\r\n                        button = this.createButton(layerId, controlsContainer);\r\n                    }\r\n                } else {\r\n                    if (Log) Log.debug(\"[LabelButtonManager] Bouton et controlsContainer non trouv√©s pour:\", layerId);\r\n                    return;\r\n                }\r\n            }\r\n\r\n            if (!button) {\r\n                if (Log) Log.debug(\"[LabelButtonManager] Bouton non trouv√© apr√®s toutes tentatives:\", layerId);\r\n                return;\r\n            }\r\n\r\n            // Collecter l'√©tat actuel\r\n            const state = this._getState(layerId);\r\n\r\n            // Appliquer la logique de d√©cision\r\n            this._applyState(button, state);\r\n        },\r\n\r\n        /**\r\n         * Collecte l'√©tat actuel de tous les composants\r\n         * @private\r\n         */\r\n        _getState(layerId) {\r\n            const layerData = global.GeoLeaf?.GeoJSON?.getLayerById?.(layerId);\r\n\r\n            const state = {\r\n                layerId: layerId,\r\n                layerExists: !!layerData,\r\n                layerVisible: layerData?._visibility?.current === true,\r\n                labelEnabled: layerData?.currentStyle?.label?.enabled === true,\r\n                areLabelsActive: global.GeoLeaf?.Labels?.areLabelsEnabled?.(layerId) || false\r\n            };\r\n\r\n            return state;\r\n        },\r\n\r\n        /**\r\n         * Applique l'√©tat au bouton selon la logique simplifi√©e\r\n         * R√àGLES:\r\n         * - Bouton TOUJOURS visible\r\n         * - Si label.enabled: true ET couche visible ‚Üí bouton activ√©\r\n         * - Sinon ‚Üí bouton d√©sactiv√© (gris√©)\r\n         * - √âtat actif/inactif selon si les labels sont affich√©s\r\n         * @private\r\n         */\r\n        _applyState(button, state) {\r\n            // Bouton cliquable uniquement si la couche est visible et que le style autorise les labels\r\n            const canUseLabels = state.labelEnabled && state.layerVisible;\r\n\r\n            if (canUseLabels) {\r\n                // Activer le bouton\r\n                button.disabled = false;\r\n                button.classList.remove(\"gl-layer-manager__label-toggle--disabled\");\r\n\r\n                // Appliquer l'√©tat actif/inactif\r\n                const shouldAppearOn = state.areLabelsActive && state.layerVisible;\r\n\r\n                if (shouldAppearOn) {\r\n                    button.classList.add(\"gl-layer-manager__label-toggle--on\");\r\n                    button.setAttribute(\"aria-pressed\", \"true\");\r\n                } else {\r\n                    button.classList.remove(\"gl-layer-manager__label-toggle--on\");\r\n                    button.setAttribute(\"aria-pressed\", \"false\");\r\n                }\r\n            } else {\r\n                // D√©sactiver le bouton\r\n                button.disabled = true;\r\n                button.classList.add(\"gl-layer-manager__label-toggle--disabled\");\r\n                button.classList.remove(\"gl-layer-manager__label-toggle--on\");\r\n                button.setAttribute(\"aria-pressed\", \"false\");\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Synchronise imm√©diatement sans debouncing\r\n         * Utilis√© pour les cas o√π une r√©ponse imm√©diate est n√©cessaire\r\n         * @param {string} layerId - ID de la couche\r\n         */\r\n        syncImmediate(layerId) {\r\n            if (!layerId) return;\r\n\r\n            // Annuler tout debounce en cours\r\n            if (this._syncTimeouts && this._syncTimeouts.has(layerId)) {\r\n                clearTimeout(this._syncTimeouts.get(layerId));\r\n                this._syncTimeouts.delete(layerId);\r\n            }\r\n\r\n            // Ex√©cuter imm√©diatement\r\n            this._doSync(layerId);\r\n        }\r\n    };\r\n\r\n    // Exposer dans l'espace de noms interne\r\n    GeoLeaf._LabelButtonManager = LabelButtonManager;\r\n\r\n    if (Log) Log.debug(\"[LabelButtonManager] Module initialis√©\");\r\n\r\n})(window);\r\n","/**\r\n * Module Labels pour GeoLeaf\r\n * Gestion des √©tiquettes flottantes sur les entit√©s\r\n *\r\n * D√âPENDANCES:\r\n * - Leaflet (L.Tooltip, L.DomUtil)\r\n * - GeoLeaf.Log (optionnel)\r\n * - GeoLeaf.GeoJSON (pour acc√©der aux layers)\r\n * - labels/label-renderer.js (pour le rendu des tooltips)\r\n * - loaders/style-loader.js (pour extraire les labels depuis les styles)\r\n *\r\n * EXPOSE:\r\n * - GeoLeaf.Labels\r\n *\r\n * MIGRATION V3:\r\n * - Les labels sont maintenant int√©gr√©s dans les fichiers style.json\r\n * - Plus de fichiers styleLabel.json s√©par√©s\r\n * - Les labels sont extraits depuis layerData.currentStyle.label\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = global.GeoLeaf = global.GeoLeaf || {};\r\n    const Log = GeoLeaf.Log;\r\n    const ScaleUtils = GeoLeaf.Utils && GeoLeaf.Utils.ScaleUtils;\r\n\r\n    /**\r\n     * √âtat interne du module Labels\r\n     * @private\r\n     */\r\n    const _state = {\r\n        // Map: layerId -> { enabled, config, tooltips }\r\n        layers: new Map(),\r\n        // Flag pour savoir si l'√©couteur de zoom est attach√©\r\n        zoomListenerAttached: false\r\n    };\r\n\r\n    /**\r\n     * Module Labels\r\n     * @namespace Labels\r\n     */\r\n    const Labels = {\r\n        /**\r\n         * Initialise le syst√®me de labels\r\n         * @param {Object} options - Options d'initialisation\r\n         */\r\n        init(options = {}) {\r\n            if (Log) Log.debug(\"[Labels] Initialisation du module Labels\");\r\n\r\n            // √âcouter les √©v√©nements de chargement de couches\r\n            this._attachLayerEvents();\r\n\r\n            if (Log) Log.debug(\"[Labels] Module Labels initialis√©\");\r\n        },\r\n\r\n        /**\r\n         * Initialise les labels pour une couche au chargement\r\n         * Charge les labels UNIQUEMENT si:\r\n         * - Le style contient label.enabled === true\r\n         * - label.visibleByDefault === true\r\n         * - La couche est visible\r\n         *\r\n         * POINT D'ENTR√âE UNIQUE pour l'initialisation au chargement\r\n         * @param {string} layerId - ID de la couche\r\n         */\r\n        initializeLayerLabels(layerId) {\r\n            if (!layerId) return;\r\n\r\n            const layerData = this._getLayerData(layerId);\r\n            if (!layerData) return;\r\n\r\n            // D'ABORD masquer les labels existants pour r√©initialiser lors du changement de style\r\n            this._hideLabelsForLayer(layerId);\r\n\r\n            // R√©initialiser l'√©tat interne des labels pour cette couche\r\n            _state.layers.delete(layerId);\r\n\r\n            // V√©rifier si le style a des labels activ√©s\r\n            if (layerData.currentStyle?.label?.enabled !== true) {\r\n                if (Log) Log.debug(\"[Labels.initialize] Style sans labels ou labels d√©sactiv√©s pour\", layerId);\r\n                return;\r\n            }\r\n\r\n            // V√©rifier visibleByDefault\r\n            const visibleByDefault = layerData.currentStyle.label.visibleByDefault === true;\r\n\r\n            if (!visibleByDefault) {\r\n                if (Log) Log.debug(\"[Labels.initialize] Labels d√©sactiv√©s par d√©faut pour\", layerId);\r\n                // Toujours initialiser la config, mais sans les afficher\r\n                return this.enableLabels(layerId, {}, false);\r\n            }\r\n\r\n            // Afficher les labels uniquement si couche visible ET visibleByDefault = true\r\n            const isLayerVisible = layerData._visibility?.current === true;\r\n            if (!isLayerVisible) {\r\n                if (Log) Log.debug(\"[Labels.initialize] Labels configur√©s mais couche invisible pour\", layerId);\r\n                // Initialiser la config sans afficher\r\n                return this.enableLabels(layerId, {}, false);\r\n            }\r\n\r\n            if (Log) Log.debug(\"[Labels.initialize] Initialisation labels visibles pour\", layerId);\r\n            return this.enableLabels(layerId, {}, true);\r\n        },\r\n\r\n        /**\r\n         * Active les labels pour une couche\r\n         * Les labels sont extraits depuis le style actuel de la couche (layerData.currentStyle.label)\r\n         * @param {string} layerId - ID de la couche\r\n         * @param {Object} labelConfig - Configuration des labels depuis layer.json (legacy, peut √™tre vide)\r\n         * @param {boolean} showImmediately - Si true, affiche les labels imm√©diatement (visibleByDefault)\r\n         * @returns {Promise<void>}\r\n         */\r\n        async enableLabels(layerId, labelConfig = {}, showImmediately = true) {\r\n            if (!layerId) {\r\n                if (Log) Log.warn(\"[Labels] enableLabels: layerId manquant\");\r\n                return;\r\n            }\r\n\r\n            // V√âRIFICATION: D√©tecter les r√©f√©rences obsol√®tes √† styleFile\r\n            if (labelConfig && labelConfig.styleFile) {\r\n                const errorMessage =\r\n                    `‚ùå CONFIGURATION OBSOL√àTE D√âTECT√âE\\n` +\r\n                    `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\\n` +\r\n                    `La couche \"${layerId}\" utilise une r√©f√©rence obsol√®te √† un fichier\\n` +\r\n                    `de labels s√©par√© via \"labelConfig.styleFile\".\\n\\n` +\r\n                    `GeoLeaf ne supporte plus les fichiers de labels s√©par√©s (styleLabel.json).\\n` +\r\n                    `Les labels doivent √™tre int√©gr√©s dans les fichiers de style.\\n\\n` +\r\n                    `Valeur d√©tect√©e: ${labelConfig.styleFile}\\n` +\r\n                    `Couche: ${layerId}\\n\\n` +\r\n                    `Action requise:\\n` +\r\n                    `1. Supprimez la propri√©t√© \"labels.styleFile\" de la configuration\\n` +\r\n                    `2. Les labels sont maintenant extraits depuis layerData.currentStyle.label\\n` +\r\n                    `3. Consultez docs/STYLE_FORMAT_SPEC.md pour la syntaxe\\n` +\r\n                    `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`;\r\n\r\n                console.error(errorMessage);\r\n                throw new Error(`Configuration obsol√®te: labels.styleFile d√©tect√© dans la couche ${layerId}`);\r\n            }\r\n\r\n            if (Log) Log.debug(\"[Labels] Pr√©paration labels pour\", layerId, \"showImmediately:\", showImmediately);\r\n\r\n            try {\r\n                // R√©cup√©rer le style actuel de la couche pour extraire les labels int√©gr√©s\r\n                const layerData = this._getLayerData(layerId);\r\n                let labelStyleConfig = null;\r\n\r\n                if (layerData && layerData.currentStyle && layerData.currentStyle.label) {\r\n                    // Labels int√©gr√©s dans le style\r\n                    const integratedLabel = layerData.currentStyle.label;\r\n\r\n                    if (integratedLabel.enabled === true) {\r\n                        labelStyleConfig = integratedLabel;\r\n\r\n                        // IMPORTANT: Copier aussi labelScale depuis le style\r\n                        if (layerData.currentStyle.labelScale) {\r\n                            labelStyleConfig.labelScale = layerData.currentStyle.labelScale;\r\n                        }\r\n\r\n                        if (Log) {\r\n                            Log.debug(\"[Labels] Labels int√©gr√©s d√©tect√©s pour\", layerId);\r\n                            Log.debug(\"[Labels] labelScale:\", labelStyleConfig.labelScale);\r\n                        }\r\n                    } else {\r\n                        if (Log) Log.debug(\"[Labels] Labels int√©gr√©s d√©sactiv√©s (enabled=false) pour\", layerId);\r\n                        return;\r\n                    }\r\n                } else {\r\n                    // Pas de labels int√©gr√©s dans le style - v√©rifier config legacy\r\n                    if (labelConfig && labelConfig.enabled && labelConfig.labelId) {\r\n                        // Utiliser la config legacy du fichier de config de la couche\r\n                        labelStyleConfig = {\r\n                            enabled: true,\r\n                            field: labelConfig.labelId,\r\n                            font: labelConfig.font || {\r\n                                family: \"Arial\",\r\n                                sizePt: 10,\r\n                                weight: 50,\r\n                                bold: false,\r\n                                italic: false\r\n                            },\r\n                            color: labelConfig.color || \"#000000\",\r\n                            opacity: labelConfig.opacity || 1.0,\r\n                            buffer: labelConfig.buffer || { enabled: false },\r\n                            background: labelConfig.background || { enabled: false },\r\n                            offset: labelConfig.offset || { distancePx: 0 }\r\n                        };\r\n                        if (Log) Log.debug(\"[Labels] Utilisation config legacy pour\", layerId);\r\n                    } else {\r\n                        // Pas de labels du tout\r\n                        if (Log) Log.debug(\"[Labels] Aucun label configur√© pour\", layerId);\r\n                        return;\r\n                    }\r\n                }\r\n\r\n                // Stocker la configuration (enabled d√©termine si on affiche)\r\n                // showImmediately est d√©termin√© par visibleByDefault du style en priorit√©\r\n                const effectiveShowImmediately = labelStyleConfig.visibleByDefault !== undefined\r\n                    ? labelStyleConfig.visibleByDefault\r\n                    : showImmediately;\r\n\r\n                _state.layers.set(layerId, {\r\n                    enabled: effectiveShowImmediately, // true si visibleByDefault, false sinon\r\n                    config: labelConfig, // Configuration legacy (minZoom, maxZoom, etc.)\r\n                    labelStyle: labelStyleConfig, // Configuration de style extraite du style\r\n                    tooltips: new Map() // Map: featureId -> L.Marker\r\n                });\r\n\r\n                // V√©rifier si la couche est visible avant de cr√©er les labels\r\n                let shouldShowLabels = effectiveShowImmediately;\r\n\r\n                // V√©rifier l'√©tat de visibilit√© de la couche dans GeoJSON\r\n                if (layerData) {\r\n                    // Utiliser _visibility.current pour v√©rifier l'√©tat r√©el\r\n                    const isLayerVisible = layerData._visibility && layerData._visibility.current === true;\r\n                    shouldShowLabels = effectiveShowImmediately && isLayerVisible;\r\n\r\n                    if (effectiveShowImmediately && !isLayerVisible) {\r\n                        if (Log) Log.debug(\"[Labels] Labels configur√©s pour affichage mais couche invisible:\", layerId);\r\n                    }\r\n                }\r\n\r\n                // Cr√©er les markers seulement si la couche est visible ET showImmediately\r\n                if (shouldShowLabels) {\r\n                    await this._createLabelsForLayer(layerId);\r\n                }\r\n\r\n                // Attacher l'√©couteur de zoom si ce n'est pas d√©j√† fait\r\n                this._ensureZoomListener();\r\n\r\n                if (Log) Log.debug(\"[Labels] Config labels pr√©par√©e pour\", layerId, \"visible:\", showImmediately);\r\n            } catch (err) {\r\n                if (Log) Log.error(\"[Labels] Erreur pr√©paration labels:\", err);\r\n                console.error(\"[Labels] Stack trace:\", err.stack);\r\n            }\r\n        },\r\n\r\n        /**\r\n         * D√©sactive les labels pour une couche\r\n         * @param {string} layerId - ID de la couche\r\n         */\r\n        disableLabels(layerId) {\r\n            if (!layerId) return;\r\n\r\n            const layerState = _state.layers.get(layerId);\r\n            if (!layerState) return;\r\n\r\n            if (Log) Log.debug(\"[Labels] D√©sactivation des labels pour\", layerId);\r\n\r\n            // Supprimer tous les tooltips\r\n            if (layerState.tooltips) {\r\n                layerState.tooltips.forEach(tooltip => {\r\n                    try {\r\n                        if (tooltip && tooltip.remove) {\r\n                            tooltip.remove();\r\n                        }\r\n                    } catch (e) {\r\n                        // Ignore\r\n                    }\r\n                });\r\n                layerState.tooltips.clear();\r\n            }\r\n\r\n            // Marquer comme d√©sactiv√©\r\n            layerState.enabled = false;\r\n\r\n            if (Log) Log.debug(\"[Labels] Labels d√©sactiv√©s pour\", layerId);\r\n        },\r\n\r\n        /**\r\n         * Cache temporairement les labels d'une couche sans changer l'√©tat enabled\r\n         * Utilis√© quand la couche est d√©sactiv√©e mais qu'on veut garder la config\r\n         * @param {string} layerId - ID de la couche\r\n         * @private\r\n         */\r\n        _hideLabelsForLayer(layerId) {\r\n            if (!layerId) return;\r\n\r\n            const layerState = _state.layers.get(layerId);\r\n            if (!layerState) return;\r\n\r\n            if (Log) Log.debug(\"[Labels] Masquage temporaire des labels pour\", layerId);\r\n\r\n            // Supprimer tous les markers de la map\r\n            if (layerState.tooltips) {\r\n                layerState.tooltips.forEach(tooltip => {\r\n                    try {\r\n                        if (tooltip && tooltip.remove) {\r\n                            tooltip.remove();\r\n                        }\r\n                    } catch (e) {\r\n                        // Ignore\r\n                    }\r\n                });\r\n                layerState.tooltips.clear();\r\n            }\r\n\r\n            // NE PAS changer layerState.enabled - on garde la config\r\n            if (Log) Log.debug(\"[Labels] Labels masqu√©s (enabled reste:\", layerState.enabled, \")\");\r\n        },\r\n\r\n        /**\r\n         * Bascule l'affichage des labels pour une couche\r\n         * @param {string} layerId - ID de la couche\r\n         * @returns {boolean} Nouvel √©tat (true = activ√©)\r\n         */\r\n        toggleLabels(layerId) {\r\n            if (!layerId) return false;\r\n\r\n            const layerState = _state.layers.get(layerId);\r\n            if (!layerState) return false;\r\n\r\n            // V√âRIFICATION CRITIQUE: Le style actuel doit autoriser les labels\r\n            const layerData = this._getLayerData(layerId);\r\n            const currentLabelEnabled = layerData?.currentStyle?.label?.enabled === true;\r\n\r\n            if (!currentLabelEnabled) {\r\n                return false;\r\n            }\r\n\r\n            if (layerState.enabled) {\r\n                // D√©sactiver : masquer sans perdre la config\r\n                this._hideLabelsForLayer(layerId);\r\n                layerState.enabled = false;\r\n                return false;\r\n            } else {\r\n                // Activer : changer l'√©tat et rafra√Æchir (refreshLabels v√©rifiera la visibilit√©)\r\n                layerState.enabled = true;\r\n                this.refreshLabels(layerId);\r\n                return true;\r\n            }\r\n        },\r\n\r\n        /**\r\n         * V√©rifie si la config labels existe pour une couche\r\n         * @param {string} layerId - ID de la couche\r\n         * @returns {boolean}\r\n         */\r\n        hasLabelConfig(layerId) {\r\n            return _state.layers.has(layerId);\r\n        },\r\n\r\n        /**\r\n         * V√©rifie si les labels sont actifs pour une couche\r\n         * @param {string} layerId - ID de la couche\r\n         * @returns {boolean}\r\n         */\r\n        areLabelsEnabled(layerId) {\r\n            const layerState = _state.layers.get(layerId);\r\n            return layerState ? layerState.enabled : false;\r\n        },\r\n\r\n        /**\r\n         * Rafra√Æchit les labels d'une couche (apr√®s zoom, filtre, etc.)\r\n         * @param {string} layerId - ID de la couche\r\n         */\r\n        refreshLabels(layerId) {\r\n            if (!layerId) return;\r\n\r\n            const layerState = _state.layers.get(layerId);\r\n            if (!layerState || !layerState.enabled) return;\r\n\r\n            // V√©rifier si la couche est visible avant de cr√©er les labels\r\n            // Priorit√©: visibilit√© de couche prime sur les param√®tres d'√©chelle\r\n            const layerData = this._getLayerData(layerId);\r\n            if (!layerData || !layerData._visibility || !layerData._visibility.current) {\r\n                if (Log) Log.debug(\"[Labels] Couche invisible, skip refresh pour\", layerId);\r\n                return;\r\n            }\r\n\r\n            if (Log) Log.debug(\"[Labels] Rafra√Æchissement des labels pour\", layerId);\r\n\r\n            // Supprimer les anciens tooltips\r\n            if (layerState.tooltips) {\r\n                layerState.tooltips.forEach(tooltip => {\r\n                    try {\r\n                        if (tooltip && tooltip.remove) tooltip.remove();\r\n                    } catch (e) {\r\n                        // Ignore\r\n                    }\r\n                });\r\n                layerState.tooltips.clear();\r\n            }\r\n\r\n            // Recr√©er les tooltips\r\n            this._createLabelsForLayer(layerId);\r\n        },\r\n\r\n        /**\r\n         * Cr√©e les tooltips permanents pour toutes les features d'une couche\r\n         * @private\r\n         * @param {string} layerId - ID de la couche\r\n         * @returns {Promise<void>}\r\n         */\r\n        async _createLabelsForLayer(layerId) {\r\n            const layerState = _state.layers.get(layerId);\r\n            if (!layerState || !layerState.enabled) {\r\n                if (Log) Log.debug(\"[Labels] _createLabelsForLayer: layerState non trouv√© ou d√©sactiv√© pour\", layerId);\r\n                return;\r\n            }\r\n\r\n            // PRIORIT√â: V√©rifier la visibilit√© de la couche AVANT les calculs d'√©chelle\r\n            const layerData = this._getLayerData(layerId);\r\n            if (!layerData || !layerData._visibility || !layerData._visibility.current) {\r\n                if (Log) Log.debug(\"[Labels] Couche invisible, abandon cr√©ation labels pour\", layerId);\r\n                return;\r\n            }\r\n\r\n            if (!layerData.layer) {\r\n                if (Log) Log.warn(\"[Labels] Couche GeoJSON non trouv√©e:\", layerId);\r\n                return;\r\n            }\r\n\r\n            const { config, labelStyle } = layerState;\r\n\r\n            if (Log) Log.debug(\"[Labels] Cr√©ation labels pour\", layerId, \"labelStyle:\", labelStyle);\r\n\r\n            // V√©rifier l'√©chelle actuelle si labelScale est d√©fini\r\n            const map = GeoLeaf.Core && GeoLeaf.Core.getMap ? GeoLeaf.Core.getMap() : null;\r\n\r\n            if (map && labelStyle.labelScale) {\r\n                const { minScale, maxScale } = labelStyle.labelScale;\r\n\r\n                if (minScale !== null || maxScale !== null) {\r\n                    // Calculer l'√©chelle actuelle de la carte\r\n                    const currentScale = this._calculateMapScale(map);\r\n\r\n                    if (Log) Log.debug(\"[Labels] V√©rification √©chelle:\", {\r\n                        currentScale,\r\n                        minScale,\r\n                        maxScale,\r\n                        visible: this._isScaleInRange(currentScale, minScale, maxScale)\r\n                    });\r\n\r\n                    if (!this._isScaleInRange(currentScale, minScale, maxScale)) {\r\n                        if (Log) Log.debug(\"[Labels] √âchelle hors limites pour\", layerId, `(√©chelle: 1:${currentScale})`);\r\n                        return;\r\n                    }\r\n                }\r\n            } else if (map && config.minZoom !== undefined && config.maxZoom !== undefined) {\r\n                // Fallback sur minZoom/maxZoom legacy\r\n                const currentZoom = map.getZoom();\r\n                if (currentZoom < config.minZoom || currentZoom > config.maxZoom) {\r\n                    if (Log) Log.debug(\"[Labels] Zoom hors limites pour\", layerId);\r\n                    return;\r\n                }\r\n            }\r\n\r\n            // Cr√©er les tooltips via le renderer\r\n            if (GeoLeaf._LabelRenderer) {\r\n                // Adapter le format nouveau (field) vers ancien (labelId) pour le renderer\r\n                const rendererConfig = {\r\n                    labelId: labelStyle.field || config.labelId,\r\n                    minZoom: config.minZoom,\r\n                    maxZoom: config.maxZoom\r\n                };\r\n\r\n                if (Log) Log.debug(\"[Labels] Appel renderer avec:\", {\r\n                    layerId,\r\n                    labelId: rendererConfig.labelId,\r\n                    hasLayer: !!layerData.layer,\r\n                    hasStyle: !!labelStyle\r\n                });\r\n\r\n                GeoLeaf._LabelRenderer.createTooltipsForLayer(\r\n                    layerId,\r\n                    layerData.layer,\r\n                    rendererConfig,\r\n                    labelStyle, // Passe le style de label extrait du style actuel\r\n                    layerState.tooltips\r\n                );\r\n\r\n                if (Log) Log.debug(\"[Labels] Renderer termin√©, tooltips cr√©√©s:\", layerState.tooltips.size);\r\n            } else {\r\n                if (Log) Log.error(\"[Labels] GeoLeaf._LabelRenderer non disponible!\");\r\n            }\r\n        },\r\n\r\n        /**\r\n         * R√©cup√®re les donn√©es de la couche depuis GeoLeaf.GeoJSON\r\n         * @private\r\n         * @param {string} layerId - ID de la couche\r\n         * @returns {Object|null} Layer data ou null si non trouv√©\r\n         */\r\n        _getLayerData(layerId) {\r\n            if (!GeoLeaf.GeoJSON || typeof GeoLeaf.GeoJSON.getLayerById !== \"function\") {\r\n                if (Log) Log.warn(\"[Labels] GeoLeaf.GeoJSON non disponible\");\r\n                return null;\r\n            }\r\n\r\n            return GeoLeaf.GeoJSON.getLayerById(layerId);\r\n        },\r\n\r\n        /**\r\n         * S'assure que l'√©couteur de zoom est attach√©\r\n         * @private\r\n         */\r\n        _ensureZoomListener() {\r\n            if (_state.zoomListenerAttached) return;\r\n\r\n            const map = GeoLeaf.Core && GeoLeaf.Core.getMap ? GeoLeaf.Core.getMap() : null;\r\n            if (map) {\r\n                map.on('zoomend', () => {\r\n                    const zoom = map.getZoom();\r\n                    if (Log) Log.debug(\"[Labels] Zoom chang√©:\", zoom);\r\n                    this._handleZoomChange({ zoom: zoom });\r\n                });\r\n                _state.zoomListenerAttached = true;\r\n                if (Log) Log.debug(\"[Labels] √âcouteur zoom attach√© √† la carte\");\r\n            } else {\r\n                if (Log) Log.warn(\"[Labels] Carte non disponible pour attacher l'√©couteur de zoom\");\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Attache les √©couteurs d'√©v√©nements pour les couches\r\n         * @private\r\n         */\r\n        _attachLayerEvents() {\r\n            // Les √©couteurs de zoom sont maintenant attach√©s dans _ensureZoomListener()\r\n\r\n            // √âcouter les √©v√©nements personnalis√©s (si disponibles)\r\n            if (typeof global.addEventListener === \"function\") {\r\n                // √âcouter les √©v√©nements de chargement de couches\r\n                global.addEventListener(\"geoleaf:layer-loaded\", (evt) => {\r\n                    if (evt.detail && evt.detail.layerId) {\r\n                        this._handleLayerLoaded(evt.detail.layerId);\r\n                    }\r\n                });\r\n            }\r\n        },\r\n\r\n        /**\r\n         * G√®re le changement de zoom/√©chelle\r\n         * @private\r\n         */\r\n        _handleZoomChange(detail) {\r\n            if (!detail) return;\r\n\r\n            const map = GeoLeaf.Core && GeoLeaf.Core.getMap ? GeoLeaf.Core.getMap() : null;\r\n            if (!map) return;\r\n\r\n            // Calculer l'√©chelle actuelle\r\n            const currentScale = this._calculateMapScale(map);\r\n\r\n            // Parcourir toutes les couches avec labels\r\n            _state.layers.forEach((layerState, layerId) => {\r\n                if (!layerState.enabled) return;\r\n\r\n                // PRIORIT√â: V√©rifier visibilit√© couche AVANT calculs d'√©chelle (performance)\r\n                const layerData = this._getLayerData(layerId);\r\n                if (!layerData || !layerData._visibility || !layerData._visibility.current) {\r\n                    // Couche invisible - masquer labels imm√©diatement, ignorer √©chelle\r\n                    const isShowing = layerState.tooltips && layerState.tooltips.size > 0;\r\n                    if (isShowing) {\r\n                        layerState.tooltips.forEach(tooltip => {\r\n                            if (tooltip && tooltip.remove) tooltip.remove();\r\n                        });\r\n                        layerState.tooltips.clear();\r\n                    }\r\n                    return;\r\n                }\r\n\r\n                // Couche visible: v√©rifier les contraintes d'√©chelle\r\n                const { labelStyle, config } = layerState;\r\n                let shouldShow = true;\r\n\r\n                // V√©rifier avec labelScale si disponible\r\n                if (labelStyle && labelStyle.labelScale) {\r\n                    const { minScale, maxScale } = labelStyle.labelScale;\r\n                    shouldShow = this._isScaleInRange(currentScale, minScale, maxScale);\r\n                } else if (config.minZoom !== undefined && config.maxZoom !== undefined) {\r\n                    // Fallback sur minZoom/maxZoom legacy\r\n                    const zoom = detail.zoom !== undefined ? detail.zoom : map.getZoom();\r\n                    const minZoom = config.minZoom;\r\n                    const maxZoom = config.maxZoom;\r\n                    shouldShow = zoom >= minZoom && zoom <= maxZoom;\r\n                }\r\n\r\n                const isShowing = layerState.tooltips && layerState.tooltips.size > 0;\r\n\r\n                if (shouldShow && !isShowing) {\r\n                    // Afficher les labels\r\n                    this._createLabelsForLayer(layerId);\r\n                } else if (!shouldShow && isShowing) {\r\n                    // Masquer les labels\r\n                    layerState.tooltips.forEach(tooltip => {\r\n                        if (tooltip && tooltip.remove) tooltip.remove();\r\n                    });\r\n                    layerState.tooltips.clear();\r\n                }\r\n            });\r\n        },\r\n\r\n        /**\r\n         * G√®re le chargement d'une couche\r\n         * @private\r\n         */\r\n        async _handleLayerLoaded(layerId) {\r\n            const layerState = _state.layers.get(layerId);\r\n            if (layerState && layerState.enabled) {\r\n                await this._createLabelsForLayer(layerId);\r\n            }\r\n        },\r\n\r\n        /**\r\n         * R√©cup√®re l'ID du profil actif\r\n         * @private\r\n         */\r\n        _getProfileId() {\r\n            if (GeoLeaf.Config && typeof GeoLeaf.Config.get === \"function\") {\r\n                return GeoLeaf.Config.get(\"id\") || \"default\";\r\n            }\r\n            return \"default\";\r\n        },\r\n\r\n        /**\r\n         * Calcule l'√©chelle actuelle de la carte (1:X format)\r\n         * @private\r\n         * @param {L.Map} map - Instance de la carte Leaflet\r\n         * @returns {number} √âchelle (ex: 5000000 pour 1:5M)\r\n         */\r\n        _calculateMapScale(map) {\r\n            if (ScaleUtils && typeof ScaleUtils.calculateMapScale === \"function\") {\r\n                return ScaleUtils.calculateMapScale(map, { logger: Log });\r\n            }\r\n\r\n            if (!map) return 0;\r\n\r\n            const center = map.getCenter();\r\n            const zoom = map.getZoom();\r\n\r\n            const METERS_PER_PIXEL_AT_ZOOM_0 = 156543.04;\r\n            const metersPerPixel = METERS_PER_PIXEL_AT_ZOOM_0 * Math.cos(center.lat * Math.PI / 180) / Math.pow(2, zoom);\r\n\r\n            const METERS_PER_INCH = 0.0254;\r\n            const DPI = 96;\r\n            const metersPerInch = metersPerPixel * DPI;\r\n\r\n            const scale = Math.round(metersPerInch / METERS_PER_INCH);\r\n\r\n            if (Log) {\r\n                Log.debug(`[Labels] Calcul √©chelle (fallback): zoom=${zoom}, lat=${center.lat.toFixed(2)}, √©chelle=1:${scale.toLocaleString()}`);\r\n            }\r\n\r\n            return scale;\r\n        },\r\n\r\n        /**\r\n         * V√©rifie si une √©chelle est dans la plage min/max\r\n         * @private\r\n         * @param {number} currentScale - √âchelle actuelle (ex: 5000000)\r\n         * @param {number|null} minScale - √âchelle minimale (plus grand nombre = plus d√©zoom√©)\r\n         * @param {number|null} maxScale - √âchelle maximale (plus petit nombre = plus zoom√©)\r\n         * @returns {boolean} True si l'√©chelle est dans la plage\r\n         *\r\n         * Logique:\r\n         * - minScale est l'√©chelle la plus \"large\" (ex: 15000000 = 1:15M, vue d'ensemble)\r\n         * - maxScale est l'√©chelle la plus \"d√©taill√©e\" (ex: 1000 = 1:1k, vue rapproch√©e)\r\n         * - Labels visibles si: maxScale <= currentScale <= minScale\r\n         */\r\n        _isScaleInRange(currentScale, minScale, maxScale) {\r\n            if (ScaleUtils && typeof ScaleUtils.isScaleInRange === \"function\") {\r\n                return ScaleUtils.isScaleInRange(currentScale, minScale, maxScale, Log);\r\n            }\r\n\r\n            if (typeof minScale === \"number\" && currentScale > minScale) {\r\n                if (Log) {\r\n                    Log.debug(`[Labels] Test √©chelle (fallback): ${currentScale} > minScale ${minScale} ‚Üí ‚úó CACH√â (trop d√©zoom√©)`);\r\n                }\r\n                return false;\r\n            }\r\n\r\n            if (typeof maxScale === \"number\" && currentScale < maxScale) {\r\n                if (Log) {\r\n                    Log.debug(`[Labels] Test √©chelle (fallback): ${currentScale} < maxScale ${maxScale} ‚Üí ‚úó CACH√â (trop zoom√©)`);\r\n                }\r\n                return false;\r\n            }\r\n\r\n            if (Log) {\r\n                Log.debug(`[Labels] Test √©chelle (fallback): ${currentScale} dans [${maxScale} - ${minScale}] ‚Üí ‚úì VISIBLE`);\r\n            }\r\n\r\n            return true;\r\n        },\r\n\r\n        /**\r\n         * Nettoie toutes les ressources du module\r\n         */\r\n        destroy() {\r\n            if (Log) Log.debug(\"[Labels] Destruction du module Labels\");\r\n\r\n            _state.layers.forEach((layerState, layerId) => {\r\n                this.disableLabels(layerId);\r\n            });\r\n\r\n            _state.layers.clear();\r\n        }\r\n    };\r\n\r\n    // Exposer le module\r\n    GeoLeaf.Labels = Labels;\r\n\r\n})(window);\r\n","/**\r\n * Module Theme Loader\r\n * Charge et met en cache le fichier themes.json\r\n *\r\n * D√âPENDANCES:\r\n * - GeoLeaf.Log (optionnel)\r\n * - GeoLeaf.Core.getActiveProfile()\r\n *\r\n * EXPOSE:\r\n * - GeoLeaf._ThemeLoader\r\n *\r\n * @module _ThemeLoader\r\n * @private\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = global.GeoLeaf = global.GeoLeaf || {};\r\n    const Log = GeoLeaf.Log;\r\n\r\n    /**\r\n     * Cache pour les configurations de th√®mes\r\n     * @type {Map<string, Object>}\r\n     */\r\n    const _cache = new Map();\r\n\r\n    /**\r\n     * Promises en cours de chargement\r\n     * @type {Map<string, Promise>}\r\n     */\r\n    const _loadingPromises = new Map();\r\n\r\n    /**\r\n     * Module Theme Loader\r\n     * @namespace _ThemeLoader\r\n     * @private\r\n     */\r\n    const _ThemeLoader = {\r\n        /**\r\n         * Charge le fichier themes.json pour un profil\r\n         * @param {string} profileId - ID du profil\r\n         * @returns {Promise<Object>} Configuration des th√®mes\r\n         */\r\n        loadThemesConfig(profileId) {\r\n            if (Log) Log.debug(\"[ThemeLoader] loadThemesConfig appel√© pour:\", profileId);\r\n\r\n            // V√©rifier le cache\r\n            if (_cache.has(profileId)) {\r\n                if (Log) Log.debug(\"[ThemeLoader] Config en cache pour:\", profileId);\r\n                return Promise.resolve(_cache.get(profileId));\r\n            }\r\n\r\n            // V√©rifier si d√©j√† en cours de chargement\r\n            if (_loadingPromises.has(profileId)) {\r\n                if (Log) Log.debug(\"[ThemeLoader] Chargement d√©j√† en cours pour:\", profileId);\r\n                return _loadingPromises.get(profileId);\r\n            }\r\n\r\n            // Construire le chemin du fichier\r\n            // Utiliser un chemin relatif depuis la racine du projet\r\n            // Si on est dans /demo/, on remonte avec ../\r\n            const isInDemo = window.location.pathname.includes('/demo/');\r\n            const basePath = isInDemo ? '../' : '';\r\n            const themesPath = `${basePath}profiles/${profileId}/themes.json`;\r\n\r\n            // Sprint 3.3: Unified fetch using FetchHelper with timeout and retry\r\n            const FetchHelper = GeoLeaf.Utils?.FetchHelper;\r\n            let loadPromise;\r\n\r\n            if (FetchHelper) {\r\n                // Use enhanced FetchHelper with timeout and retry\r\n                loadPromise = FetchHelper.get(themesPath, {\r\n                    timeout: 8000,\r\n                    retries: 1,\r\n                    parseResponse: true\r\n                })\r\n                .then((data) => {\r\n                    if (Log) Log.debug(\"[ThemeLoader] Fichier charg√©:\", themesPath);\r\n\r\n                    // Valider la structure\r\n                    const validated = this._validateConfig(data);\r\n\r\n                    // Mettre en cache\r\n                    _cache.set(profileId, validated);\r\n                    _loadingPromises.delete(profileId);\r\n\r\n                    return validated;\r\n                })\r\n                .catch((err) => {\r\n                    if (Log) Log.warn(\"[ThemeLoader] Erreur chargement themes.json:\", err.message);\r\n                    _loadingPromises.delete(profileId);\r\n                    throw err;\r\n                });\r\n            } else {\r\n                // Fallback to raw fetch if FetchHelper not available\r\n                loadPromise = fetch(themesPath)\r\n                    .then((response) => {\r\n                        if (!response.ok) {\r\n                            throw new Error(`Erreur HTTP ${response.status} lors du chargement de ${themesPath}`);\r\n                        }\r\n                        return response.json();\r\n                    })\r\n                    .then((data) => {\r\n                        if (Log) Log.debug(\"[ThemeLoader] Fichier charg√©:\", themesPath);\r\n\r\n                        // Valider la structure\r\n                        const validated = this._validateConfig(data);\r\n\r\n                        // Mettre en cache\r\n                        _cache.set(profileId, validated);\r\n                        _loadingPromises.delete(profileId);\r\n\r\n                        return validated;\r\n                    })\r\n                    .catch((err) => {\r\n                        if (Log) Log.warn(\"[ThemeLoader] Erreur chargement themes.json:\", err.message);\r\n                        _loadingPromises.delete(profileId);\r\n                        throw err;\r\n                    });\r\n            }\r\n\r\n            // Stocker la promesse en cours\r\n            _loadingPromises.set(profileId, loadPromise);\r\n\r\n            return loadPromise;\r\n        },\r\n\r\n        /**\r\n         * Valide et normalise la configuration des th√®mes\r\n         * @param {Object} config - Configuration brute\r\n         * @returns {Object} Configuration valid√©e\r\n         * @private\r\n         */\r\n        _validateConfig(config) {\r\n            if (!config || typeof config !== 'object') {\r\n                throw new Error(\"Configuration de th√®mes invalide\");\r\n            }\r\n\r\n            // Valeurs par d√©faut pour config\r\n            const validatedConfig = {\r\n                config: {\r\n                    primaryThemes: {\r\n                        enabled: true,\r\n                        position: \"top-map\",\r\n                        ...(config.config?.primaryThemes || {})\r\n                    },\r\n                    secondaryThemes: {\r\n                        enabled: true,\r\n                        placeholder: \"S√©lectionner un th√®me...\",\r\n                        showNavigationButtons: true,\r\n                        position: \"top-layermanager\",\r\n                        ...(config.config?.secondaryThemes || {})\r\n                    }\r\n                },\r\n                themes: [],\r\n                defaultTheme: config.defaultTheme || null\r\n            };\r\n\r\n            // Valider les th√®mes\r\n            if (!Array.isArray(config.themes)) {\r\n                if (Log) Log.warn(\"[ThemeLoader] Aucun th√®me d√©fini dans la configuration\");\r\n                return validatedConfig;\r\n            }\r\n\r\n            // Normaliser chaque th√®me\r\n            validatedConfig.themes = config.themes.map((theme) => {\r\n                if (!theme.id) {\r\n                    if (Log) Log.warn(\"[ThemeLoader] Th√®me sans ID ignor√©\");\r\n                    return null;\r\n                }\r\n\r\n                return {\r\n                    id: theme.id,\r\n                    label: theme.label || theme.id,\r\n                    type: theme.type || \"secondary\", // Par d√©faut: secondary\r\n                    description: theme.description || \"\",\r\n                    icon: theme.icon || \"\",\r\n                    layers: Array.isArray(theme.layers) ? theme.layers : []\r\n                };\r\n            }).filter(Boolean); // Supprimer les th√®mes invalides\r\n\r\n            // V√©rifier qu'il y a au moins un th√®me\r\n            if (validatedConfig.themes.length === 0) {\r\n                throw new Error(\"Aucun th√®me valide trouv√© dans la configuration\");\r\n            }\r\n\r\n            // V√©rifier que le defaultTheme existe\r\n            if (validatedConfig.defaultTheme) {\r\n                const defaultExists = validatedConfig.themes.some(\r\n                    (t) => t.id === validatedConfig.defaultTheme\r\n                );\r\n                if (!defaultExists) {\r\n                    if (Log) Log.warn(\"[ThemeLoader] defaultTheme introuvable, utilisation du premier th√®me\");\r\n                    validatedConfig.defaultTheme = validatedConfig.themes[0].id;\r\n                }\r\n            } else {\r\n                // Pas de defaultTheme d√©fini, utiliser le premier\r\n                validatedConfig.defaultTheme = validatedConfig.themes[0].id;\r\n            }\r\n\r\n            if (Log) Log.debug(\"[ThemeLoader] Configuration valid√©e:\", validatedConfig.themes.length, \"th√®mes\");\r\n\r\n            return validatedConfig;\r\n        },\r\n\r\n        /**\r\n         * Vide le cache (pour tests ou rechargement)\r\n         * @param {string} [profileId] - ID du profil (optionnel, vide tout si non sp√©cifi√©)\r\n         */\r\n        clearCache(profileId) {\r\n            if (profileId) {\r\n                _cache.delete(profileId);\r\n                _loadingPromises.delete(profileId);\r\n                if (Log) Log.debug(\"[ThemeLoader] Cache vid√© pour:\", profileId);\r\n            } else {\r\n                _cache.clear();\r\n                _loadingPromises.clear();\r\n                if (Log) Log.debug(\"[ThemeLoader] Cache complet vid√©\");\r\n            }\r\n        }\r\n    };\r\n\r\n    // Exposer dans l'espace de noms\r\n    GeoLeaf._ThemeLoader = _ThemeLoader;\r\n\r\n})(window);\r\n","/**\r\n * GeoLeaf Theme Applier - Core\r\n * Module state, init/cleanup, applyTheme orchestration, getCurrentThemeId\r\n *\r\n * @module themes/theme-applier/core\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = global.GeoLeaf = global.GeoLeaf || {};\r\n\r\n    /**\r\n     * Module Theme Applier\r\n     * @namespace _ThemeApplier\r\n     * @private\r\n     */\r\n    const _ThemeApplier = {\r\n        /** @type {string|null} Th√®me actuellement actif */\r\n        _currentThemeId: null,\r\n\r\n        /** @type {boolean} Flag pour savoir si c'est le premier chargement */\r\n        _isFirstLoad: true,\r\n\r\n        /**\r\n         * Initialise le ThemeApplier\r\n         * @private\r\n         */\r\n        _init() {\r\n            this._pendingLayerConfigs = new Map();\r\n            this._pendingCheckTimer = null;\r\n        },\r\n\r\n        /**\r\n         * Nettoie les ressources\r\n         * @private\r\n         */\r\n        _cleanup() {\r\n            if (this._pendingCheckTimer) {\r\n                clearTimeout(this._pendingCheckTimer);\r\n                this._pendingCheckTimer = null;\r\n            }\r\n            if (this._pendingLayerConfigs) {\r\n                this._pendingLayerConfigs.clear();\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Applique un th√®me\r\n         * @param {Object} theme - Configuration du th√®me\r\n         * @param {Object} [options] - Options d'application\r\n         * @param {boolean} [options.fitBounds] - Force le fitBounds\r\n         * @returns {Promise<void>}\r\n         */\r\n        applyTheme(theme, options = {}) {\r\n            // Initialiser si n√©cessaire\r\n            if (!this._pendingLayerConfigs) {\r\n                this._init();\r\n            }\r\n\r\n            if (GeoLeaf.Legend && typeof GeoLeaf.Legend.showLoadingOverlay === \"function\") {\r\n                GeoLeaf.Legend.showLoadingOverlay();\r\n            }\r\n\r\n            if (!theme || !theme.id) {\r\n                return Promise.reject(new Error(\"Th√®me invalide\"));\r\n            }\r\n\r\n            // V√©rifier les d√©pendances\r\n            if (!GeoLeaf.GeoJSON || !GeoLeaf.LayerManager) {\r\n                return Promise.reject(new Error(\"Modules GeoJSON ou LayerManager non disponibles\"));\r\n            }\r\n\r\n            // Notifier le d√©but du chargement du th√®me\r\n            try {\r\n                document.dispatchEvent(new CustomEvent('geoleaf:theme:applying', {\r\n                    detail: {\r\n                        themeId: theme.id,\r\n                        themeName: theme.name || theme.label || theme.id\r\n                    }\r\n                }));\r\n            } catch (e) { /* silencieux */ }\r\n\r\n            // D√©sactiver toutes les couches d'abord\r\n            this._hideAllLayers();\r\n\r\n            // Appliquer les couches du th√®me avec chargement optimis√© par lots\r\n            const layerConfigs = theme.layers || [];\r\n\r\n            // R√©cup√©rer la configuration de performance depuis le profil\r\n            const profileConfig = GeoLeaf.Config?.Profile?.getActiveProfileConfig();\r\n            const perfConfig = profileConfig?.performance || {};\r\n            const maxLayers = perfConfig.maxConcurrentLayers || 10;\r\n            // fitBounds d√©sactiv√© : le positionnement se fait via map.bounds du profil\r\n            const enableFitBounds = false;\r\n\r\n            // S√©parer les couches visibles et invisibles\r\n            const visibleLayers = layerConfigs.filter(config => config.visible !== false);\r\n            const hiddenLayers = layerConfigs.filter(config => config.visible === false);\r\n\r\n            // Charger d'abord les couches visibles par lots\r\n            const BATCH_SIZE = perfConfig.themeBatchSize || 3;\r\n\r\n            // Helper progression pour l'√©cran de chargement (97‚Üí99)\r\n            const updateProgress = (p) => {\r\n                try {\r\n                    if (typeof window !== 'undefined' && window._glLoadingScreen && typeof window._glLoadingScreen.updateProgress === 'function') {\r\n                        window._glLoadingScreen.updateProgress(p);\r\n                    }\r\n                } catch (e) { /* ignore */ }\r\n            };\r\n\r\n            const loadInBatches = async (layers) => {\r\n                for (let i = 0; i < layers.length; i += BATCH_SIZE) {\r\n                    const batch = layers.slice(i, i + BATCH_SIZE);\r\n                    await Promise.all(batch.map(layerConfig => this._applyLayerConfig(layerConfig)));\r\n\r\n                    if (i === 0) {\r\n                        updateProgress(98);\r\n                    }\r\n                }\r\n            };\r\n\r\n            const self = this;\r\n\r\n            return loadInBatches(visibleLayers)\r\n                .then(() => {\r\n                    updateProgress(98);\r\n                    return Promise.resolve();\r\n                })\r\n                .then(() => {\r\n                    updateProgress(99);\r\n                    self._currentThemeId = theme.id;\r\n\r\n                    // Rafra√Æchir le LayerManager\r\n                    if (GeoLeaf.LayerManager && GeoLeaf.LayerManager.refresh) {\r\n                        GeoLeaf.LayerManager.refresh();\r\n                    }\r\n\r\n                    // Synchroniser l'√©tat de visibilit√© dans la l√©gende\r\n                    self._syncLegendVisibility();\r\n\r\n                    // √âv√©nement de th√®me appliqu√©\r\n                    try {\r\n                        const themeNotificationEvent = new CustomEvent('geoleaf:theme:applied', {\r\n                            detail: {\r\n                                themeId: theme.id,\r\n                                themeName: theme.name || theme.label || theme.id,\r\n                                layerCount: visibleLayers.length,\r\n                                totalLayersInTheme: layerConfigs.length,\r\n                                timestamp: new Date().toISOString()\r\n                            }\r\n                        });\r\n                        document.dispatchEvent(themeNotificationEvent);\r\n                    } catch (e) {\r\n                        // Silencieux\r\n                    }\r\n\r\n                    // FitBounds selon la configuration\r\n                    const shouldFitBounds = options.fitBounds === true ||\r\n                                           (self._isFirstLoad && enableFitBounds);\r\n                    if (shouldFitBounds) {\r\n                        setTimeout(() => {\r\n                            self._fitBoundsOnAllLayers();\r\n                        }, 1000);\r\n                        self._isFirstLoad = false;\r\n                    }\r\n                })\r\n                .catch((err) => {\r\n                    throw err;\r\n                })\r\n                .finally(() => {\r\n                    if (GeoLeaf.Legend && typeof GeoLeaf.Legend.hideLoadingOverlay === \"function\") {\r\n                        GeoLeaf.Legend.hideLoadingOverlay();\r\n                    }\r\n                });\r\n        },\r\n\r\n        /**\r\n         * R√©cup√®re l'ID du th√®me actuellement actif\r\n         * @returns {string|null}\r\n         */\r\n        getCurrentThemeId() {\r\n            return this._currentThemeId;\r\n        }\r\n    };\r\n\r\n    // Exposer dans l'espace de noms\r\n    GeoLeaf._ThemeApplier = _ThemeApplier;\r\n\r\n})(window);\r\n","/**\r\n * GeoLeaf Theme Applier - Visibility\r\n * Gestion de la visibilit√© des couches et application des styles\r\n *\r\n * @module themes/theme-applier/visibility\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = global.GeoLeaf = global.GeoLeaf || {};\r\n    const Log = GeoLeaf.Log;\r\n\r\n    const TA = GeoLeaf._ThemeApplier;\r\n\r\n    /**\r\n     * D√©sactive toutes les couches GeoJSON\r\n     * @private\r\n     */\r\n    TA._hideAllLayers = function () {\r\n        if (!GeoLeaf._GeoJSONShared?.state?.layers) {\r\n            return;\r\n        }\r\n\r\n        const VisibilityManager = GeoLeaf._LayerVisibilityManager;\r\n        if (!VisibilityManager) {\r\n            return;\r\n        }\r\n\r\n        // R√©initialiser tous les overrides utilisateur pour laisser le th√®me prendre le contr√¥le\r\n        VisibilityManager.resetAllUserOverrides();\r\n\r\n        let hiddenCount = 0;\r\n\r\n        // Parcourir toutes les couches enregistr√©es\r\n        GeoLeaf._GeoJSONShared.state.layers.forEach((layerData, layerId) => {\r\n            const changed = VisibilityManager.setVisibility(\r\n                layerId,\r\n                false,\r\n                VisibilityManager.VisibilitySource.THEME\r\n            );\r\n\r\n            if (changed) {\r\n                hiddenCount++;\r\n            }\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Applique la configuration d'une couche (visible/masqu√©e + style)\r\n     * @param {Object} layerConfig - Configuration { id, visible, style }\r\n     * @returns {Promise<void>}\r\n     * @private\r\n     */\r\n    TA._applyLayerConfig = function (layerConfig) {\r\n        if (!layerConfig?.id) {\r\n            return Promise.resolve();\r\n        }\r\n\r\n        const layerId = layerConfig.id;\r\n        const visible = layerConfig.visible !== false;\r\n        const styleId = layerConfig.style ? String(layerConfig.style).trim() : undefined;\r\n\r\n        // R√©cup√©rer la couche depuis le registre\r\n        let layerData = GeoLeaf._GeoJSONShared?.state?.layers?.get(layerId);\r\n\r\n        // Si la couche n'existe pas, essayer de la charger automatiquement\r\n        if (!layerData) {\r\n            return TA._loadLayerFromProfile(layerId).then((loadedLayer) => {\r\n                if (loadedLayer) {\r\n                    return TA._setLayerVisibilityAndStyle(layerId, visible, styleId);\r\n                } else {\r\n                    return TA._scheduleLayerConfig(layerId, visible, styleId);\r\n                }\r\n            });\r\n        }\r\n\r\n        // La couche existe d√©j√†, appliquer directement la visibilit√©\r\n        return TA._setLayerVisibilityAndStyle(layerId, visible, styleId);\r\n    };\r\n\r\n    /**\r\n     * D√©finit la visibilit√© et le style d'une couche\r\n     * @param {string} layerId - ID de la couche\r\n     * @param {boolean} visible - Visibilit√© souhait√©e\r\n     * @param {string} styleId - ID du style √† appliquer\r\n     * @returns {Promise<void>}\r\n     * @private\r\n     */\r\n    TA._setLayerVisibilityAndStyle = function (layerId, visible, styleId) {\r\n        const layerData = GeoLeaf._GeoJSONShared?.state?.layers?.get(layerId);\r\n        if (!layerData) {\r\n            return Promise.resolve();\r\n        }\r\n\r\n        const VisibilityManager = GeoLeaf._LayerVisibilityManager;\r\n        if (!VisibilityManager) {\r\n            return Promise.resolve();\r\n        }\r\n\r\n        if (visible) {\r\n            // Utiliser le gestionnaire centralis√© avec source THEME\r\n            VisibilityManager.setVisibility(\r\n                layerId,\r\n                true,\r\n                VisibilityManager.VisibilitySource.THEME\r\n            );\r\n\r\n            // Appliquer le style si sp√©cifi√©\r\n            if (styleId && GeoLeaf._GeoJSONLayerManager?.setLayerStyle) {\r\n                const availableStyles = layerData.config?.styles?.available || [];\r\n                let effectiveStyleId = styleId;\r\n                let styleExists = availableStyles.some(s => s.id === styleId);\r\n\r\n                // Fallback: si 'default' n'existe pas, essayer 'd√©faut' (et vice-versa)\r\n                if (!styleExists) {\r\n                    const fallbackMap = {\r\n                        'default': 'd√©faut',\r\n                        'd√©faut': 'default'\r\n                    };\r\n                    const fallbackStyleId = fallbackMap[styleId];\r\n                    if (fallbackStyleId) {\r\n                        const fallbackExists = availableStyles.some(s => s.id === fallbackStyleId);\r\n                        if (fallbackExists) {\r\n                            effectiveStyleId = fallbackStyleId;\r\n                            styleExists = true;\r\n                        }\r\n                    }\r\n                }\r\n\r\n                if (styleExists) {\r\n                    const styleFile = availableStyles.find(s => s.id === effectiveStyleId)?.file;\r\n                    if (styleFile) {\r\n                        let profileId = 'default';\r\n                        if (GeoLeaf.Config && typeof GeoLeaf.Config.getActiveProfile === 'function') {\r\n                            const activeProfile = GeoLeaf.Config.getActiveProfile();\r\n                            profileId = activeProfile?.id || 'default';\r\n                        }\r\n\r\n                        const layerDirectory = layerData._layerDirectory || layerId;\r\n\r\n                        const StyleLoader = GeoLeaf._StyleLoader;\r\n                        if (!StyleLoader) {\r\n                            if (Log) Log.error(`[ThemeApplier] GeoLeaf._StyleLoader non disponible`);\r\n                            return Promise.resolve();\r\n                        }\r\n\r\n                        return StyleLoader.loadAndValidateStyle(\r\n                            profileId,\r\n                            layerId,\r\n                            effectiveStyleId,\r\n                            styleFile,\r\n                            `layers/${layerDirectory}`\r\n                        )\r\n                            .then(result => {\r\n                                const styleConfig = result.styleData;\r\n                                GeoLeaf._GeoJSONLayerManager.setLayerStyle(layerId, styleConfig);\r\n\r\n                                // Stocker currentStyle pour les labels\r\n                                const layerDataForStyle = GeoLeaf._GeoJSONShared?.state?.layers?.get(layerId);\r\n                                if (layerDataForStyle) {\r\n                                    layerDataForStyle.currentStyle = styleConfig;\r\n                                }\r\n\r\n                                // Initialiser les labels si configur√©s\r\n                                if (GeoLeaf.Labels && typeof GeoLeaf.Labels.initializeLayerLabels === 'function') {\r\n                                    GeoLeaf.Labels.initializeLayerLabels(layerId);\r\n                                }\r\n\r\n                                // Mettre √† jour l'√©tat du bouton des labels\r\n                                if (GeoLeaf._LabelButtonManager) {\r\n                                    GeoLeaf._LabelButtonManager.syncImmediate(layerId);\r\n                                }\r\n\r\n                                // Synchroniser l'UI du Layer Manager\r\n                                if (GeoLeaf.LayerManager && typeof GeoLeaf.LayerManager.refresh === 'function') {\r\n                                    GeoLeaf.LayerManager.refresh();\r\n                                }\r\n\r\n                                // Mettre √† jour le style actuel dans le s√©lecteur\r\n                                if (GeoLeaf._LayerManagerStyleSelector) {\r\n                                    GeoLeaf._LayerManagerStyleSelector.setCurrentStyle(layerId, styleId);\r\n                                }\r\n\r\n                                // Rafra√Æchir le s√©lecteur dans l'UI\r\n                                TA._updateStyleSelector(layerId, styleId);\r\n\r\n                                // Charger la l√©gende correspondante\r\n                                TA._loadLegendForStyle(layerId, styleId);\r\n\r\n                                return result;\r\n                            })\r\n                            .catch(err => {\r\n                                // Silencieux ‚Äî erreur d√©j√† logu√©e par StyleLoader\r\n                            });\r\n                    }\r\n                }\r\n            }\r\n        } else {\r\n            // Masquer la couche avec source THEME\r\n            VisibilityManager.setVisibility(\r\n                layerId,\r\n                false,\r\n                VisibilityManager.VisibilitySource.THEME\r\n            );\r\n\r\n            // D√©sactiver les labels et mettre √† jour le bouton\r\n            if (GeoLeaf.Labels) {\r\n                GeoLeaf.Labels.disableLabels(layerId);\r\n            }\r\n            if (GeoLeaf._LabelButtonManager) {\r\n                GeoLeaf._LabelButtonManager.syncImmediate(layerId);\r\n            }\r\n        }\r\n\r\n        return Promise.resolve();\r\n    };\r\n\r\n})(window);\r\n","/**\r\n * GeoLeaf Theme Applier - Deferred\r\n * Chargement diff√©r√© de couches, r√©solution de profil, gestion du cache\r\n *\r\n * @module themes/theme-applier/deferred\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = global.GeoLeaf = global.GeoLeaf || {};\r\n\r\n    const TA = GeoLeaf._ThemeApplier;\r\n\r\n    /**\r\n     * Programme l'application d'une configuration de couche pour plus tard\r\n     * @param {string} layerId - ID de la couche\r\n     * @param {boolean} visible - Visibilit√© souhait√©e\r\n     * @param {string} styleId - ID du style √† appliquer\r\n     * @returns {Promise<void>}\r\n     * @private\r\n     */\r\n    TA._scheduleLayerConfig = function (layerId, visible, styleId) {\r\n        if (!TA._pendingLayerConfigs) {\r\n            TA._pendingLayerConfigs = new Map();\r\n        }\r\n\r\n        TA._pendingLayerConfigs.set(layerId, { visible, styleId });\r\n\r\n        // Programmer une v√©rification p√©riodique\r\n        TA._schedulePendingCheck();\r\n\r\n        return Promise.resolve();\r\n    };\r\n\r\n    /**\r\n     * Planifie une v√©rification des couches en attente\r\n     * @private\r\n     */\r\n    TA._schedulePendingCheck = function () {\r\n        if (TA._pendingCheckTimer) {\r\n            return; // D√©j√† planifi√©\r\n        }\r\n\r\n        TA._pendingCheckTimer = setTimeout(() => {\r\n            TA._checkPendingLayerConfigs();\r\n            TA._pendingCheckTimer = null;\r\n        }, 1000);\r\n    };\r\n\r\n    /**\r\n     * V√©rifie et applique les configurations de couches en attente\r\n     * @private\r\n     */\r\n    TA._checkPendingLayerConfigs = function () {\r\n        if (!TA._pendingLayerConfigs || TA._pendingLayerConfigs.size === 0) {\r\n            return;\r\n        }\r\n\r\n        const appliedLayers = [];\r\n\r\n        for (const [layerId, config] of TA._pendingLayerConfigs) {\r\n            const layerData = GeoLeaf._GeoJSONShared?.state?.layers?.get(layerId);\r\n            if (layerData) {\r\n                TA._setLayerVisibilityAndStyle(layerId, config.visible, config.styleId);\r\n                appliedLayers.push(layerId);\r\n            }\r\n        }\r\n\r\n        // Supprimer les couches trait√©es\r\n        appliedLayers.forEach(layerId => {\r\n            TA._pendingLayerConfigs.delete(layerId);\r\n        });\r\n\r\n        // S'il reste des couches en attente, programmer une nouvelle v√©rification\r\n        if (TA._pendingLayerConfigs.size > 0) {\r\n            TA._schedulePendingCheck();\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Charge une couche depuis le profil actif (avec tol√©rance aux erreurs)\r\n     * @param {string} layerId - ID de la couche √† charger\r\n     * @returns {Promise<Object|null>} - Couche charg√©e ou null si erreur\r\n     * @private\r\n     */\r\n    TA._loadLayerFromProfile = async function (layerId) {\r\n        const Config = GeoLeaf.Config;\r\n        if (!Config || typeof Config.getActiveProfile !== 'function') {\r\n            return null;\r\n        }\r\n\r\n        try {\r\n            const activeProfile = Config.getActiveProfile();\r\n\r\n            if (!activeProfile || typeof activeProfile !== 'object') {\r\n                return null;\r\n            }\r\n\r\n            const profileId = activeProfile.id || null;\r\n\r\n            // Get layers config from profile\r\n            let profileLayersConfig = [];\r\n            if (Array.isArray(activeProfile.geojsonLayers)) {\r\n                profileLayersConfig = activeProfile.geojsonLayers;\r\n            } else if (activeProfile.geojson && Array.isArray(activeProfile.geojson.layers)) {\r\n                profileLayersConfig = activeProfile.geojson.layers;\r\n            } else if (Array.isArray(activeProfile.layers)) {\r\n                profileLayersConfig = activeProfile.layers;\r\n            } else if (Array.isArray(activeProfile.Layers)) {\r\n                profileLayersConfig = activeProfile.Layers;\r\n            }\r\n\r\n            if (!Array.isArray(profileLayersConfig) || profileLayersConfig.length === 0) {\r\n                return null;\r\n            }\r\n\r\n            const layerConfig = profileLayersConfig.find(config => config.id === layerId);\r\n\r\n            if (!layerConfig) {\r\n                return null;\r\n            }\r\n\r\n            const dataUrl = TA._resolveDataFilePath(layerConfig);\r\n\r\n            if (!dataUrl) {\r\n                return null;\r\n            }\r\n\r\n            const layerLabel = layerConfig.label || layerId;\r\n            const baseOptions = {};\r\n\r\n            const loader = GeoLeaf._GeoJSONLoader?._loadSingleLayer;\r\n\r\n            if (!loader) {\r\n                return null;\r\n            }\r\n\r\n            // Tentative cache avant r√©seau\r\n            let cachedData = null;\r\n            if (GeoLeaf.ThemeCache?.get) {\r\n                cachedData = await GeoLeaf.ThemeCache.get(layerId, profileId);\r\n            }\r\n\r\n            // Transmettre TOUTE la configuration de la couche\r\n            const layerDef = {\r\n                ...layerConfig,\r\n                url: dataUrl,\r\n                type: layerConfig.geometryType || layerConfig.type || 'geojson',\r\n                _profileId: profileId,\r\n                _layerDirectory: layerConfig._layerDirectory\r\n            };\r\n\r\n            // Normaliser les champs popup/tooltip/sidepanel\r\n            const normalizedDef = { ...layerDef };\r\n\r\n            if (layerDef.popup && layerDef.popup.fields) {\r\n                normalizedDef.popupFields = layerDef.popup.fields;\r\n            }\r\n\r\n            if (layerDef.tooltip && layerDef.tooltip.fields) {\r\n                normalizedDef.tooltipFields = layerDef.tooltip.fields;\r\n            }\r\n\r\n            if (layerDef.sidepanel && layerDef.sidepanel.detailLayout) {\r\n                normalizedDef.sidepanelFields = layerDef.sidepanel.detailLayout;\r\n            }\r\n\r\n            if (cachedData) {\r\n                normalizedDef._cachedData = cachedData;\r\n            }\r\n\r\n            try {\r\n                const layer = await loader.call(GeoLeaf._GeoJSONLoader, layerId, layerLabel, normalizedDef, baseOptions);\r\n                // Rafra√Æchir le cache pour prolonger la dur√©e de vie\r\n                if (cachedData && GeoLeaf.ThemeCache?.store) {\r\n                    GeoLeaf.ThemeCache.store(layerId, profileId, cachedData);\r\n                }\r\n                return layer;\r\n            } catch (err) {\r\n                return null;\r\n            }\r\n        } catch (error) {\r\n            return null;\r\n        }\r\n    };\r\n\r\n    /**\r\n     * R√©sout le chemin du fichier de donn√©es d'une couche\r\n     * @param {Object} layerConfig - Configuration de la couche\r\n     * @returns {string|null} - URL compl√®te du fichier de donn√©es\r\n     * @private\r\n     */\r\n    TA._resolveDataFilePath = function (layerConfig) {\r\n        if (!layerConfig.dataFile || !layerConfig._layerDirectory) {\r\n            return null;\r\n        }\r\n\r\n        const Config = GeoLeaf.Config;\r\n        if (!Config || !Config.getActiveProfile) {\r\n            return null;\r\n        }\r\n\r\n        const activeProfile = Config.getActiveProfile();\r\n        if (!activeProfile) {\r\n            return null;\r\n        }\r\n\r\n        const profileId = activeProfile.id;\r\n        const profileBasePath = TA._getProfilesBasePath(activeProfile);\r\n\r\n        return `${profileBasePath}/${profileId}/${layerConfig._layerDirectory}/${layerConfig.dataFile}`;\r\n    };\r\n\r\n    /**\r\n     * R√©sout le chemin de base des profils\r\n     * @private\r\n     */\r\n    TA._getProfilesBasePath = function (activeProfile) {\r\n        const Config = GeoLeaf.Config;\r\n        const configured = Config?.get?.(\"data.profilesBasePath\");\r\n\r\n        if (typeof configured === \"string\" && configured.trim().length > 0) {\r\n            return TA._normalizeBasePath(configured);\r\n        }\r\n\r\n        if (activeProfile && typeof activeProfile.profilesBasePath === \"string\") {\r\n            return TA._normalizeBasePath(activeProfile.profilesBasePath);\r\n        }\r\n\r\n        return \"profiles\";\r\n    };\r\n\r\n    /**\r\n     * Normalise un chemin (trim + supprime le / final)\r\n     * @private\r\n     */\r\n    TA._normalizeBasePath = function (path) {\r\n        const trimmed = path.trim();\r\n        return trimmed.endsWith(\"/\") ? trimmed.slice(0, -1) : trimmed;\r\n    };\r\n\r\n})(window);\r\n","/**\r\n * GeoLeaf Theme Applier - UI Sync\r\n * Synchronisation de l'UI : s√©lecteur de style, l√©gende, fitBounds\r\n *\r\n * @module themes/theme-applier/ui-sync\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = global.GeoLeaf = global.GeoLeaf || {};\r\n\r\n    const TA = GeoLeaf._ThemeApplier;\r\n\r\n    /**\r\n     * Met √† jour le s√©lecteur de style dans l'UI\r\n     * @param {string} layerId - Identifiant de la couche\r\n     * @param {string} styleId - Identifiant du style\r\n     * @private\r\n     */\r\n    TA._updateStyleSelector = function (layerId, styleId) {\r\n        const selectId = \"style-selector-\" + layerId;\r\n        const select = document.getElementById(selectId);\r\n\r\n        if (select) {\r\n            select.value = styleId;\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Charge la l√©gende correspondant au style appliqu√©\r\n     * @param {string} layerId - ID de la couche\r\n     * @param {string} styleId - ID du style\r\n     * @private\r\n     */\r\n    TA._loadLegendForStyle = function (layerId, styleId) {\r\n        if (!GeoLeaf.Legend || typeof GeoLeaf.Legend.loadLayerLegend !== \"function\") {\r\n            return;\r\n        }\r\n\r\n        // R√©cup√©rer les informations de la couche\r\n        const layersMap = GeoLeaf._GeoJSONShared?.state?.layers;\r\n        const layerInfo = layersMap instanceof Map ? layersMap.get(layerId) : layersMap?.[layerId];\r\n\r\n        if (!layerInfo || !layerInfo.config) {\r\n            return;\r\n        }\r\n\r\n        // Utiliser la nouvelle API qui g√©n√®re la l√©gende depuis le style\r\n        GeoLeaf.Legend.loadLayerLegend(layerId, styleId, layerInfo.config);\r\n    };\r\n\r\n    /**\r\n     * Zoom sur l'emprise de toutes les couches charg√©es\r\n     * @private\r\n     */\r\n    TA._fitBoundsOnAllLayers = function () {\r\n        const map = GeoLeaf.Core?.getMap();\r\n        if (!map) {\r\n            return;\r\n        }\r\n\r\n        // Mettre √† jour la progression (99%)\r\n        if (window._glLoadingScreen && typeof window._glLoadingScreen.updateProgress === 'function') {\r\n            window._glLoadingScreen.updateProgress(99);\r\n        }\r\n\r\n        // Cr√©er un groupe temporaire avec toutes les couches pour calculer les bounds\r\n        const tempGroup = global.L.featureGroup();\r\n        let layerCount = 0;\r\n\r\n        // Ajouter les couches GeoJSON\r\n        if (GeoLeaf._GeoJSONShared?.state?.layers) {\r\n            GeoLeaf._GeoJSONShared.state.layers.forEach((layerData, layerId) => {\r\n                if (layerData.layer) {\r\n                    try {\r\n                        tempGroup.addLayer(layerData.layer);\r\n                        layerCount++;\r\n                    } catch (e) {\r\n                        // Silencieux\r\n                    }\r\n                }\r\n            });\r\n        }\r\n\r\n        // Ajouter les POI s'ils existent\r\n        if (GeoLeaf._POIShared?.state?.markerLayer) {\r\n            try {\r\n                tempGroup.addLayer(GeoLeaf._POIShared.state.markerLayer);\r\n                layerCount++;\r\n            } catch (e) {\r\n                // Silencieux\r\n            }\r\n        }\r\n\r\n        // Ajouter les Routes s'elles existent\r\n        if (GeoLeaf.Route?.getLayerGroup) {\r\n            try {\r\n                const routeGroup = GeoLeaf.Route.getLayerGroup();\r\n                if (routeGroup) {\r\n                    tempGroup.addLayer(routeGroup);\r\n                    layerCount++;\r\n                }\r\n            } catch (e) {\r\n                // Silencieux\r\n            }\r\n        }\r\n\r\n        // Zoomer sur l'emprise\r\n        if (layerCount > 0) {\r\n            const bounds = tempGroup.getBounds();\r\n            if (bounds.isValid()) {\r\n                // Afficher la carte AVANT le fitBounds pour √©viter l'√©cran noir\r\n                const mapContainer = document.getElementById('geoleaf-map') ||\r\n                                   document.querySelector('.leaflet-container')?.parentElement;\r\n                if (mapContainer) {\r\n                    mapContainer.style.opacity = '1';\r\n                }\r\n\r\n                map.fitBounds(bounds, { maxZoom: 12, padding: [50, 50], animate: false });\r\n\r\n                // Attendre que les tuiles soient charg√©es avant de fermer le spinner\r\n                setTimeout(() => {\r\n                    try {\r\n                        const event = new CustomEvent('geoleaf:map:ready', { detail: { time: Date.now() } });\r\n                        document.dispatchEvent(event);\r\n                    } catch (e) {\r\n                        // fallback\r\n                    }\r\n                }, 800);\r\n            }\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Synchronise l'√©tat de visibilit√© de toutes les couches dans la l√©gende\r\n     * @private\r\n     */\r\n    TA._syncLegendVisibility = function () {\r\n        if (!GeoLeaf.Legend || typeof GeoLeaf.Legend.setLayerVisibility !== \"function\") {\r\n            return;\r\n        }\r\n\r\n        if (!GeoLeaf._GeoJSONShared?.state?.layers) {\r\n            return;\r\n        }\r\n\r\n        const VisibilityManager = GeoLeaf._LayerVisibilityManager;\r\n        if (!VisibilityManager) {\r\n            return;\r\n        }\r\n\r\n        // Parcourir toutes les couches et synchroniser leur √©tat\r\n        GeoLeaf._GeoJSONShared.state.layers.forEach((layerData, layerId) => {\r\n            const visState = VisibilityManager.getVisibilityState(layerId);\r\n            const isVisible = visState ? visState.current : layerData.visible;\r\n            GeoLeaf.Legend.setLayerVisibility(layerId, isVisible);\r\n        });\r\n    };\r\n\r\n})(window);\r\n","/**\r\n * Module Theme Selector\r\n * S√©lecteur de th√®mes global (principaux + secondaires)\r\n *\r\n * D√âPENDANCES:\r\n * - Leaflet (L.DomUtil, L.DomEvent)\r\n * - GeoLeaf.Log (optionnel)\r\n * - GeoLeaf._ThemeLoader\r\n * - GeoLeaf._ThemeApplier\r\n * - GeoLeaf.Core.getActiveProfile()\r\n *\r\n * EXPOSE:\r\n * - GeoLeaf.ThemeSelector\r\n *\r\n * @module ThemeSelector\r\n * @public\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = global.GeoLeaf = global.GeoLeaf || {};\r\n    const Log = GeoLeaf.Log;\r\n\r\n    // Helper pour utiliser createElement unifi√©\r\n    const $create = (tag, props, ...children) => {\r\n        return GeoLeaf.Utils && GeoLeaf.Utils.createElement\r\n            ? GeoLeaf.Utils.createElement(tag, props, ...children)\r\n            : document.createElement(tag);\r\n    };\r\n\r\n    /**\r\n     * √âtat du module\r\n     */\r\n    const _state = {\r\n        initialized: false,\r\n        profileId: null,\r\n        config: null,\r\n        themes: [],\r\n        primaryThemes: [],\r\n        secondaryThemes: [],\r\n        currentTheme: null,\r\n        // R√©f√©rences UI\r\n        primaryContainer: null,\r\n        secondaryContainer: null,\r\n        dropdown: null,\r\n        // Event listener cleanup tracking\r\n        _eventCleanups: []\r\n    };\r\n\r\n    /**\r\n     * Module Theme Selector\r\n     * @namespace ThemeSelector\r\n     * @public\r\n     */\r\n    const ThemeSelector = {\r\n        /**\r\n         * Initialise le s√©lecteur de th√®mes\r\n         * @param {Object} options - Options d'initialisation\r\n         * @param {string} options.profileId - ID du profil\r\n         * @param {HTMLElement} [options.primaryContainer] - Conteneur pour boutons principaux\r\n         * @param {HTMLElement} [options.secondaryContainer] - Conteneur pour dropdown secondaire\r\n         * @returns {Promise<void>}\r\n         */\r\n        init(options) {\r\n            if (!options || !options.profileId) {\r\n                return Promise.reject(new Error(\"profileId requis pour ThemeSelector.init\"));\r\n            }\r\n\r\n            if (Log) Log.debug(\"[ThemeSelector] Initialisation pour profil:\", options.profileId);\r\n\r\n            _state.profileId = options.profileId;\r\n            _state.primaryContainer = options.primaryContainer || null;\r\n            _state.secondaryContainer = options.secondaryContainer || null;\r\n\r\n            // Charger la configuration des th√®mes\r\n            if (!GeoLeaf._ThemeLoader) {\r\n                return Promise.reject(new Error(\"Module _ThemeLoader non disponible\"));\r\n            }\r\n\r\n            return GeoLeaf._ThemeLoader.loadThemesConfig(options.profileId)\r\n                .then((themesConfig) => {\r\n                    _state.config = themesConfig.config;\r\n                    _state.themes = themesConfig.themes;\r\n                    _state.primaryThemes = themesConfig.themes.filter((t) => t.type === \"primary\");\r\n                    _state.secondaryThemes = themesConfig.themes.filter((t) => t.type === \"secondary\");\r\n                    _state.currentTheme = themesConfig.defaultTheme;\r\n\r\n                    if (Log) Log.debug(\"[ThemeSelector] Configuration charg√©e:\", {\r\n                        total: _state.themes.length,\r\n                        primary: _state.primaryThemes.length,\r\n                        secondary: _state.secondaryThemes.length\r\n                    });\r\n\r\n                    // Cr√©er l'UI\r\n                    this._createUI();\r\n\r\n                    // Marquer comme initialis√© AVANT d'appliquer le th√®me\r\n                    _state.initialized = true;\r\n\r\n                    // Appliquer le th√®me par d√©faut\r\n                    return this.setTheme(_state.currentTheme);\r\n                })\r\n                .then(() => {\r\n                    if (Log) Log.debug(\"[ThemeSelector] Initialisation termin√©e\");\r\n                    // √âmettre l'√©v√©nement de fin de chargement des th√®mes\r\n                    const event = new CustomEvent('geoleaf:themes:ready', { detail: { time: Date.now() } });\r\n                    document.dispatchEvent(event);\r\n                })\r\n                .catch((err) => {\r\n                    if (Log) Log.warn(\"[ThemeSelector] Erreur initialisation:\", err.message);\r\n                    // √âmettre l'√©v√©nement m√™me en cas d'erreur\r\n                    const event = new CustomEvent('geoleaf:themes:ready', { detail: { time: Date.now(), error: err.message } });\r\n                    document.dispatchEvent(event);\r\n                    throw err;\r\n                });\r\n        },\r\n\r\n        /**\r\n         * Cr√©e l'interface utilisateur\r\n         * @private\r\n         */\r\n        _createUI() {\r\n            // V√©rifier si le s√©lecteur de th√®mes est activ√© globalement\r\n            const uiConfig = GeoLeaf.Config && GeoLeaf.Config.get ? GeoLeaf.Config.get('ui') : null;\r\n            const showThemeSelector = uiConfig ? (uiConfig.showThemeSelector === true) : false;\r\n\r\n            if (!showThemeSelector) {\r\n                if (Log) Log.debug(\"[ThemeSelector] showThemeSelector est false, UI non cr√©√©e\");\r\n                return;\r\n            }\r\n\r\n            // Cr√©er l'UI des th√®mes principaux\r\n            if (_state.config.primaryThemes.enabled && _state.primaryContainer) {\r\n                this._createPrimaryUI();\r\n            }\r\n\r\n            // Cr√©er l'UI des th√®mes secondaires\r\n            if (_state.config.secondaryThemes.enabled && _state.secondaryContainer) {\r\n                this._createSecondaryUI();\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Cr√©e l'UI des th√®mes principaux (boutons)\r\n         * @private\r\n         */\r\n        _createPrimaryUI() {\r\n            if (!_state.primaryContainer) {\r\n                return;\r\n            }\r\n\r\n            // Vider le conteneur\r\n            GeoLeaf.DOMSecurity.clearElementFast(_state.primaryContainer);\r\n\r\n            // Ajouter la classe CSS\r\n            _state.primaryContainer.classList.add(\"gl-theme-selector-primary\");\r\n\r\n            // Cr√©er un bouton pour chaque th√®me principal\r\n            _state.primaryThemes.forEach((theme) => {\r\n                const btn = global.L.DomUtil.create(\"button\", \"gl-theme-btn\", _state.primaryContainer);\r\n                btn.type = \"button\";\r\n                btn.dataset.themeId = theme.id;\r\n                btn.title = theme.description || theme.label;\r\n\r\n                // Contenu du bouton: ic√¥ne + label\r\n                const iconSpan = global.L.DomUtil.create(\"span\", \"gl-theme-btn__icon\", btn);\r\n                iconSpan.textContent = theme.icon || \"üìç\";\r\n\r\n                const labelSpan = global.L.DomUtil.create(\"span\", \"gl-theme-btn__label\", btn);\r\n                labelSpan.textContent = theme.label;\r\n\r\n                // Marquer le th√®me actif\r\n                if (theme.id === _state.currentTheme) {\r\n                    btn.classList.add(\"gl-theme-btn--active\");\r\n                }\r\n\r\n                // Gestionnaire de clic\r\n                this._attachPrimaryButtonHandler(btn, theme);\r\n            });\r\n\r\n            if (Log) Log.debug(\"[ThemeSelector] UI primaire cr√©√©e:\", _state.primaryThemes.length, \"boutons\");\r\n        },\r\n\r\n        /**\r\n         * Attache le gestionnaire de clic sur un bouton de th√®me principal\r\n         * @param {HTMLElement} btn - Bouton\r\n         * @param {Object} theme - Configuration du th√®me\r\n         * @private\r\n         */\r\n        _attachPrimaryButtonHandler(btn, theme) {\r\n            const onClick = (ev) => {\r\n                if (global.L && global.L.DomEvent) {\r\n                    global.L.DomEvent.stopPropagation(ev);\r\n                }\r\n                ev.preventDefault();\r\n\r\n                this.setTheme(theme.id);\r\n            };\r\n\r\n            const events = GeoLeaf.Utils?.events;\r\n            if (global.L && global.L.DomEvent) {\r\n                global.L.DomEvent.on(btn, \"click\", onClick);\r\n                global.L.DomEvent.disableClickPropagation(btn);\r\n                // Store cleanup for L.DomEvent.off\r\n                _state._eventCleanups.push(() => {\r\n                    if (global.L && global.L.DomEvent) {\r\n                        global.L.DomEvent.off(btn, \"click\", onClick);\r\n                    }\r\n                });\r\n            } else if (events) {\r\n                _state._eventCleanups.push(\r\n                    events.on(\r\n                        btn,\r\n                        \"click\",\r\n                        onClick,\r\n                        false,\r\n                        'ThemeSelector.primaryButton'\r\n                    )\r\n                );\r\n            } else {\r\n                btn.addEventListener(\"click\", onClick);\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Cr√©e l'UI des th√®mes secondaires (dropdown + boutons prev/next)\r\n         * @private\r\n         */\r\n        _createSecondaryUI() {\r\n            if (!_state.secondaryContainer) {\r\n                if (Log) Log.warn(\"[ThemeSelector] Conteneur secondaire introuvable\");\r\n                return;\r\n            }\r\n\r\n            if (Log) Log.debug(\"[ThemeSelector] Cr√©ation UI secondaire:\", _state.secondaryThemes.length, \"th√®mes\");\r\n            if (Log) Log.debug(\"[ThemeSelector] IDs des th√®mes secondaires:\", _state.secondaryThemes.map(t => t.id));\r\n\r\n            // Vider le conteneur\r\n            GeoLeaf.DOMSecurity.clearElementFast(_state.secondaryContainer);\r\n\r\n            // Ajouter la classe CSS\r\n            _state.secondaryContainer.classList.add(\"gl-theme-selector-secondary\");\r\n\r\n            // Cr√©er le wrapper\r\n            const wrapper = global.L.DomUtil.create(\"div\", \"gl-theme-selector-secondary__wrapper\", _state.secondaryContainer);\r\n\r\n            // Bouton pr√©c√©dent (si activ√©)\r\n            if (_state.config.secondaryThemes.showNavigationButtons) {\r\n                const prevBtn = global.L.DomUtil.create(\"button\", \"gl-theme-nav gl-theme-nav--prev\", wrapper);\r\n                prevBtn.type = \"button\";\r\n                prevBtn.textContent = \"‚óÄ\";\r\n                prevBtn.title = \"Th√®me pr√©c√©dent\";\r\n                this._attachNavButtonHandler(prevBtn, \"prev\");\r\n            }\r\n\r\n            // Dropdown\r\n            const select = global.L.DomUtil.create(\"select\", \"gl-theme-dropdown\", wrapper);\r\n            _state.dropdown = select;\r\n\r\n            // Option placeholder\r\n            const placeholder = $create(\"option\", {\r\n                value: \"\",\r\n                textContent: _state.config.secondaryThemes.placeholder,\r\n                disabled: true\r\n            });\r\n            select.appendChild(placeholder);\r\n\r\n            // Options pour les th√®mes secondaires\r\n            _state.secondaryThemes.forEach((theme) => {\r\n                const opt = $create(\"option\", {\r\n                    value: theme.id,\r\n                    textContent: theme.label\r\n                });\r\n                select.appendChild(opt);\r\n            });\r\n\r\n            // S√©lectionner le th√®me actif si c'est un th√®me secondaire\r\n            const currentIsSecondary = _state.secondaryThemes.some((t) => t.id === _state.currentTheme);\r\n            if (currentIsSecondary) {\r\n                select.value = _state.currentTheme;\r\n            } else {\r\n                select.value = \"\";\r\n            }\r\n\r\n            // Gestionnaire de changement\r\n            this._attachDropdownHandler(select);\r\n\r\n            // Bouton suivant (si activ√©)\r\n            if (_state.config.secondaryThemes.showNavigationButtons) {\r\n                const nextBtn = global.L.DomUtil.create(\"button\", \"gl-theme-nav gl-theme-nav--next\", wrapper);\r\n                nextBtn.type = \"button\";\r\n                nextBtn.textContent = \"‚ñ∂\";\r\n                nextBtn.title = \"Th√®me suivant\";\r\n                this._attachNavButtonHandler(nextBtn, \"next\");\r\n            }\r\n\r\n            if (Log) Log.debug(\"[ThemeSelector] UI secondaire cr√©√©e:\", _state.secondaryThemes.length, \"th√®mes\");\r\n        },\r\n\r\n        /**\r\n         * Attache le gestionnaire de changement sur le dropdown\r\n         * @param {HTMLSelectElement} select - Dropdown\r\n         * @private\r\n         */\r\n        _attachDropdownHandler(select) {\r\n            const onChange = (ev) => {\r\n                if (global.L && global.L.DomEvent) {\r\n                    global.L.DomEvent.stopPropagation(ev);\r\n                }\r\n\r\n                const themeId = select.value;\r\n                if (Log) Log.info(`[ThemeSelector] Dropdown chang√©: ${themeId}`);\r\n\r\n                if (themeId) {\r\n                    this.setTheme(themeId);\r\n                } else {\r\n                    if (Log) Log.warn(\"[ThemeSelector] Dropdown: themeId vide\");\r\n                }\r\n            };\r\n\r\n            const events = GeoLeaf.Utils?.events;\r\n            if (global.L && global.L.DomEvent) {\r\n                global.L.DomEvent.on(select, \"change\", onChange);\r\n                global.L.DomEvent.disableClickPropagation(select);\r\n                // Store cleanup for L.DomEvent.off\r\n                _state._eventCleanups.push(() => {\r\n                    if (global.L && global.L.DomEvent) {\r\n                        global.L.DomEvent.off(select, \"change\", onChange);\r\n                    }\r\n                });\r\n            } else if (events) {\r\n                _state._eventCleanups.push(\r\n                    events.on(\r\n                        select,\r\n                        \"change\",\r\n                        onChange,\r\n                        false,\r\n                        'ThemeSelector.dropdown'\r\n                    )\r\n                );\r\n            } else {\r\n                select.addEventListener(\"change\", onChange);\r\n            }\r\n\r\n            if (Log) Log.debug(\"[ThemeSelector] Gestionnaire dropdown attach√©\");\r\n        },\r\n\r\n        /**\r\n         * Attache le gestionnaire sur un bouton de navigation (prev/next)\r\n         * @param {HTMLElement} btn - Bouton\r\n         * @param {string} direction - \"prev\" | \"next\"\r\n         * @private\r\n         */\r\n        _attachNavButtonHandler(btn, direction) {\r\n            const onClick = (ev) => {\r\n                if (global.L && global.L.DomEvent) {\r\n                    global.L.DomEvent.stopPropagation(ev);\r\n                }\r\n                ev.preventDefault();\r\n\r\n                if (direction === \"next\") {\r\n                    this.nextTheme();\r\n                } else {\r\n                    this.previousTheme();\r\n                }\r\n            };\r\n\r\n            const events = GeoLeaf.Utils?.events;\r\n            if (global.L && global.L.DomEvent) {\r\n                global.L.DomEvent.on(btn, \"click\", onClick);\r\n                global.L.DomEvent.disableClickPropagation(btn);\r\n                // Store cleanup for L.DomEvent.off\r\n                _state._eventCleanups.push(() => {\r\n                    if (global.L && global.L.DomEvent) {\r\n                        global.L.DomEvent.off(btn, \"click\", onClick);\r\n                    }\r\n                });\r\n            } else if (events) {\r\n                _state._eventCleanups.push(\r\n                    events.on(\r\n                        btn,\r\n                        \"click\",\r\n                        onClick,\r\n                        false,\r\n                        'ThemeSelector.navButton'\r\n                    )\r\n                );\r\n            } else {\r\n                btn.addEventListener(\"click\", onClick);\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Active un th√®me par son ID\r\n         * @param {string} themeId - ID du th√®me\r\n         * @returns {Promise<void>}\r\n         */\r\n        setTheme(themeId) {\r\n            if (!_state.initialized) {\r\n                return Promise.reject(new Error(\"ThemeSelector non initialis√©\"));\r\n            }\r\n\r\n            const theme = _state.themes.find((t) => t.id === themeId);\r\n            if (!theme) {\r\n                return Promise.reject(new Error(`Th√®me introuvable: ${themeId}`));\r\n            }\r\n\r\n            if (Log) Log.debug(\"[ThemeSelector] setTheme:\", themeId);\r\n\r\n            // Appliquer le th√®me\r\n            if (!GeoLeaf._ThemeApplier) {\r\n                return Promise.reject(new Error(\"Module _ThemeApplier non disponible\"));\r\n            }\r\n\r\n            return GeoLeaf._ThemeApplier.applyTheme(theme)\r\n                .then(() => {\r\n                    _state.currentTheme = themeId;\r\n\r\n                    // Mettre √† jour l'UI\r\n                    this._updateUIState(themeId);\r\n\r\n                    if (Log) Log.debug(\"[ThemeSelector] Th√®me activ√©:\", themeId);\r\n                })\r\n                .catch((err) => {\r\n                    if (Log) Log.warn(\"[ThemeSelector] Erreur activation th√®me:\", err.message);\r\n                    throw err;\r\n                });\r\n        },\r\n\r\n        /**\r\n         * Met √† jour l'√©tat visuel de l'UI apr√®s un changement de th√®me\r\n         * @param {string} themeId - ID du th√®me actif\r\n         * @private\r\n         */\r\n        _updateUIState(themeId) {\r\n            // Mettre √† jour les boutons principaux\r\n            if (_state.primaryContainer) {\r\n                const buttons = _state.primaryContainer.querySelectorAll(\".gl-theme-btn\");\r\n                buttons.forEach((btn) => {\r\n                    if (btn.dataset.themeId === themeId) {\r\n                        btn.classList.add(\"gl-theme-btn--active\");\r\n                    } else {\r\n                        btn.classList.remove(\"gl-theme-btn--active\");\r\n                    }\r\n                });\r\n            }\r\n\r\n            // Mettre √† jour le dropdown\r\n            if (_state.dropdown) {\r\n                const isSecondary = _state.secondaryThemes.some((t) => t.id === themeId);\r\n                if (isSecondary) {\r\n                    _state.dropdown.value = themeId;\r\n                } else {\r\n                    _state.dropdown.value = \"\";\r\n                }\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Active le th√®me secondaire suivant\r\n         */\r\n        nextTheme() {\r\n            if (!_state.initialized || _state.secondaryThemes.length === 0) {\r\n                return;\r\n            }\r\n\r\n            const currentIsSecondary = _state.secondaryThemes.some((t) => t.id === _state.currentTheme);\r\n            let nextIndex = 0;\r\n\r\n            if (currentIsSecondary) {\r\n                const currentIndex = _state.secondaryThemes.findIndex((t) => t.id === _state.currentTheme);\r\n                nextIndex = (currentIndex + 1) % _state.secondaryThemes.length;\r\n            }\r\n\r\n            const nextTheme = _state.secondaryThemes[nextIndex];\r\n            if (nextTheme) {\r\n                this.setTheme(nextTheme.id);\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Active le th√®me secondaire pr√©c√©dent\r\n         */\r\n        previousTheme() {\r\n            if (!_state.initialized || _state.secondaryThemes.length === 0) {\r\n                return;\r\n            }\r\n\r\n            const currentIsSecondary = _state.secondaryThemes.some((t) => t.id === _state.currentTheme);\r\n            let prevIndex = _state.secondaryThemes.length - 1;\r\n\r\n            if (currentIsSecondary) {\r\n                const currentIndex = _state.secondaryThemes.findIndex((t) => t.id === _state.currentTheme);\r\n                prevIndex = (currentIndex - 1 + _state.secondaryThemes.length) % _state.secondaryThemes.length;\r\n            }\r\n\r\n            const prevTheme = _state.secondaryThemes[prevIndex];\r\n            if (prevTheme) {\r\n                this.setTheme(prevTheme.id);\r\n            }\r\n        },\r\n\r\n        /**\r\n         * R√©cup√®re le th√®me actuellement actif\r\n         * @returns {string|null}\r\n         */\r\n        getCurrentTheme() {\r\n            return _state.currentTheme;\r\n        },\r\n\r\n        /**\r\n         * R√©cup√®re tous les th√®mes\r\n         * @returns {Array}\r\n         */\r\n        getThemes() {\r\n            return _state.themes;\r\n        },\r\n\r\n        /**\r\n         * R√©cup√®re les th√®mes principaux\r\n         * @returns {Array}\r\n         */\r\n        getPrimaryThemes() {\r\n            return _state.primaryThemes;\r\n        },\r\n\r\n        /**\r\n         * R√©cup√®re les th√®mes secondaires\r\n         * @returns {Array}\r\n         */\r\n        getSecondaryThemes() {\r\n            return _state.secondaryThemes;\r\n        },\r\n\r\n        /**\r\n         * V√©rifie si le module est initialis√©\r\n         * @returns {boolean}\r\n         */\r\n        isInitialized() {\r\n            return _state.initialized;\r\n        },\r\n\r\n        /**\r\n         * Cleanup method for event listeners\r\n         * Call this when destroying the theme selector\r\n         */\r\n        destroy() {\r\n            if (Log) Log.debug(\"[ThemeSelector] Cleaning up event listeners\");\r\n\r\n            if (_state._eventCleanups) {\r\n                _state._eventCleanups.forEach(cleanup => {\r\n                    if (typeof cleanup === 'function') {\r\n                        cleanup();\r\n                    }\r\n                });\r\n                _state._eventCleanups = [];\r\n            }\r\n\r\n            _state.initialized = false;\r\n        }\r\n    };\r\n\r\n    // Exposer dans l'espace de noms\r\n    GeoLeaf.ThemeSelector = ThemeSelector;\r\n\r\n})(window);\r\n","/**\r\n * GeoLeaf Table - Panel Module\r\n * Construction du bottom-sheet drawer pour le tableau\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    const Log = GeoLeaf.Log;\r\n\r\n    GeoLeaf._TablePanel = GeoLeaf._TablePanel || {};\r\n    GeoLeaf._TablePanel._eventCleanups = [];\r\n\r\n    /**\r\n     * Cr√©e le conteneur principal du tableau (bottom-sheet)\r\n     * @param {L.Map} map - Instance de la carte Leaflet\r\n     * @param {Object} config - Configuration du tableau\r\n     * @returns {HTMLElement} Conteneur du tableau\r\n     */\r\n    GeoLeaf._TablePanel.create = function (map, config) {\r\n        // V√©rifier si le conteneur existe d√©j√†\r\n        let container = document.querySelector(\".gl-table-panel\");\r\n        if (container) {\r\n            Log.debug(\"[TablePanel] Conteneur existant r√©utilis√©\");\r\n            return container;\r\n        }\r\n\r\n        // Cr√©er le conteneur principal\r\n        container = document.createElement(\"div\");\r\n        container.className = \"gl-table-panel\";\r\n        container.style.height = config.defaultHeight || \"40%\";\r\n\r\n        // Ajouter la barre de redimensionnement si resizable\r\n        if (config.resizable) {\r\n            const resizeHandle = createResizeHandle(container, config);\r\n            container.appendChild(resizeHandle);\r\n        }\r\n\r\n        // Cr√©er la barre d'outils (header)\r\n        const toolbar = createToolbar(map, config);\r\n        container.appendChild(toolbar);\r\n\r\n        // Cr√©er le wrapper du tableau avec scroll\r\n        const tableWrapper = document.createElement(\"div\");\r\n        tableWrapper.className = \"gl-table-panel__wrapper\";\r\n        container.appendChild(tableWrapper);\r\n\r\n        // Cr√©er le tableau vide (sera rempli par le renderer)\r\n        const table = document.createElement(\"table\");\r\n        table.className = \"gl-table-panel__table\";\r\n        tableWrapper.appendChild(table);\r\n\r\n        // Ajouter au body\r\n        document.body.appendChild(container);\r\n\r\n        // Cr√©er le bouton flottant pour afficher le tableau (quand masqu√©)\r\n        createFloatingShowButton();\r\n\r\n        Log.info(\"[TablePanel] Panneau cr√©√© avec succ√®s\");\r\n        return container;\r\n    };\r\n\r\n    /**\r\n     * Cr√©e la barre de redimensionnement\r\n     * @param {HTMLElement} container - Conteneur du tableau\r\n     * @param {Object} config - Configuration\r\n     * @returns {HTMLElement}\r\n     * @private\r\n     */\r\n    function createResizeHandle(container, config) {\r\n        const handle = document.createElement(\"div\");\r\n        handle.className = \"gl-table-panel__resize-handle\";\r\n        const resizeBar = document.createElement(\"div\");\r\n        resizeBar.className = \"gl-table-panel__resize-bar\";\r\n        handle.appendChild(resizeBar);\r\n\r\n        let isResizing = false;\r\n        let startY = 0;\r\n        let startHeight = 0;\r\n\r\n        const events = GeoLeaf.Utils?.events;\r\n\r\n        const mouseDownHandler = (e) => {\r\n            isResizing = true;\r\n            startY = e.clientY;\r\n            startHeight = container.offsetHeight;\r\n            document.body.style.cursor = \"ns-resize\";\r\n            document.body.style.userSelect = \"none\";\r\n            e.preventDefault();\r\n        };\r\n\r\n        const mouseMoveHandler = (e) => {\r\n            if (!isResizing) return;\r\n            const delta = startY - e.clientY;\r\n            let newHeight = startHeight + delta;\r\n            const viewportHeight = window.innerHeight;\r\n            const minHeightPx = parseHeight(config.minHeight || \"20%\", viewportHeight);\r\n            const maxHeightPx = parseHeight(config.maxHeight || \"80%\", viewportHeight);\r\n            newHeight = Math.max(minHeightPx, Math.min(maxHeightPx, newHeight));\r\n            container.style.height = newHeight + \"px\";\r\n        };\r\n\r\n        const mouseUpHandler = () => {\r\n            if (isResizing) {\r\n                isResizing = false;\r\n                document.body.style.cursor = \"\";\r\n                document.body.style.userSelect = \"\";\r\n            }\r\n        };\r\n\r\n        if (events) {\r\n            GeoLeaf._TablePanel._eventCleanups.push(\r\n                events.on(handle, \"mousedown\", mouseDownHandler, false, 'TablePanel.resizeMouseDown')\r\n            );\r\n            GeoLeaf._TablePanel._eventCleanups.push(\r\n                events.on(document, \"mousemove\", mouseMoveHandler, false, 'TablePanel.resizeMouseMove')\r\n            );\r\n            GeoLeaf._TablePanel._eventCleanups.push(\r\n                events.on(document, \"mouseup\", mouseUpHandler, false, 'TablePanel.resizeMouseUp')\r\n            );\r\n        } else {\r\n            handle.addEventListener(\"mousedown\", mouseDownHandler);\r\n            document.addEventListener(\"mousemove\", mouseMoveHandler);\r\n            document.addEventListener(\"mouseup\", mouseUpHandler);\r\n        }\r\n\r\n        return handle;\r\n    }\r\n\r\n    /**\r\n     * Parse une valeur de hauteur (%, px, vh) en pixels\r\n     * @param {string} value - Valeur √† parser (\"40%\", \"300px\", \"50vh\")\r\n     * @param {number} referenceHeight - Hauteur de r√©f√©rence pour les %\r\n     * @returns {number} Hauteur en pixels\r\n     * @private\r\n     */\r\n    function parseHeight(value, referenceHeight) {\r\n        if (typeof value === \"number\") return value;\r\n        if (typeof value !== \"string\") return 300;\r\n\r\n        if (value.endsWith(\"%\")) {\r\n            const percent = parseFloat(value);\r\n            return (referenceHeight * percent) / 100;\r\n        } else if (value.endsWith(\"px\")) {\r\n            return parseFloat(value);\r\n        } else if (value.endsWith(\"vh\")) {\r\n            const vh = parseFloat(value);\r\n            return (window.innerHeight * vh) / 100;\r\n        }\r\n        return 300; // D√©faut\r\n    }\r\n\r\n    /**\r\n     * Cr√©e la barre d'outils du tableau\r\n     * @param {L.Map} map - Instance de la carte\r\n     * @param {Object} config - Configuration\r\n     * @returns {HTMLElement}\r\n     * @private\r\n     */\r\n    function createToolbar(map, config) {\r\n        const toolbar = document.createElement(\"div\");\r\n        toolbar.className = \"gl-table-panel__toolbar\";\r\n\r\n        // S√©lecteur de couche\r\n        const layerSelect = createLayerSelector();\r\n        toolbar.appendChild(layerSelect);\r\n\r\n        // Champ de recherche\r\n        const searchInput = createSearchInput();\r\n        toolbar.appendChild(searchInput);\r\n\r\n        // Bouton Zoom sur la s√©lection\r\n        const zoomButton = createButton(\"Zoom sur s√©lection\", \"zoom\", () => {\r\n            if (GeoLeaf.Table && typeof GeoLeaf.Table.zoomToSelection === \"function\") {\r\n                GeoLeaf.Table.zoomToSelection();\r\n            }\r\n        });\r\n        zoomButton.disabled = true;\r\n        zoomButton.setAttribute(\"data-table-btn\", \"zoom\");\r\n        toolbar.appendChild(zoomButton);\r\n\r\n        // Bouton Surbrillance\r\n        const highlightButton = createButton(\"Surbrillance\", \"highlight\", () => {\r\n            const isActive = highlightButton.classList.toggle(\"is-active\");\r\n            if (GeoLeaf.Table && typeof GeoLeaf.Table.highlightSelection === \"function\") {\r\n                GeoLeaf.Table.highlightSelection(isActive);\r\n            }\r\n        });\r\n        highlightButton.disabled = true;\r\n        highlightButton.setAttribute(\"data-table-btn\", \"highlight\");\r\n        toolbar.appendChild(highlightButton);\r\n\r\n        // Bouton Export (si activ√©)\r\n        if (config.enableExportButton) {\r\n            const exportButton = createButton(\"Exporter\", \"export\", () => {\r\n                if (GeoLeaf.Table && typeof GeoLeaf.Table.exportSelection === \"function\") {\r\n                    GeoLeaf.Table.exportSelection();\r\n                }\r\n            });\r\n            exportButton.disabled = true;\r\n            exportButton.setAttribute(\"data-table-btn\", \"export\");\r\n            toolbar.appendChild(exportButton);\r\n        }\r\n\r\n        // Spacer pour pousser le bouton toggle √† droite\r\n        const spacer = document.createElement(\"div\");\r\n        spacer.style.flex = \"1\";\r\n        toolbar.appendChild(spacer);\r\n\r\n        // Bouton toggle (masquer/afficher le tableau)\r\n        const toggleBtn = createToggleButton();\r\n        toolbar.appendChild(toggleBtn);\r\n\r\n        return toolbar;\r\n    }\r\n\r\n    /**\r\n     * Cr√©e le s√©lecteur de couche\r\n     * @returns {HTMLElement}\r\n     * @private\r\n     */\r\n    function createLayerSelector() {\r\n        const wrapper = document.createElement(\"div\");\r\n        wrapper.className = \"gl-table-panel__layer-selector\";\r\n\r\n        const select = document.createElement(\"select\");\r\n        select.id = \"geoleaf-table-layer-selector\";\r\n        select.name = \"geoleaf-table-layer-selector\";\r\n        select.className = \"gl-table-panel__select\";\r\n        select.setAttribute(\"data-table-layer-select\", \"\");\r\n\r\n        // Option par d√©faut\r\n        const defaultOption = document.createElement(\"option\");\r\n        defaultOption.value = \"\";\r\n        defaultOption.textContent = \"S√©lectionner une couche...\";\r\n        select.appendChild(defaultOption);\r\n\r\n        // Peupler avec les couches disponibles\r\n        populateLayerSelector(select);\r\n\r\n        // √âv√©nement de changement - avec cleanup tracking\r\n        const changeHandler = (e) => {\r\n            const layerId = e.target.value;\r\n            Log.debug(\"[TablePanel] S√©lecteur chang√©, layerId:\", layerId);\r\n            Log.debug(\"[TablePanel] GeoLeaf.Table existe:\", !!GeoLeaf.Table);\r\n            Log.debug(\"[TablePanel] setLayer existe:\", typeof GeoLeaf.Table?.setLayer);\r\n            if (GeoLeaf.Table && typeof GeoLeaf.Table.setLayer === \"function\") {\r\n                GeoLeaf.Table.setLayer(layerId);\r\n            } else {\r\n                Log.error(\"[TablePanel] GeoLeaf.Table.setLayer non disponible!\");\r\n            }\r\n        };\r\n\r\n        const events = GeoLeaf.Utils?.events;\r\n        if (events) {\r\n            GeoLeaf._TablePanel._eventCleanups.push(\r\n                events.on(select, \"change\", changeHandler, false, 'TablePanel.layerSelect')\r\n            );\r\n        } else {\r\n            select.addEventListener(\"change\", changeHandler);\r\n        }\r\n\r\n        Log.debug(\"[TablePanel] √âv√©nement 'change' attach√© au s√©lecteur\");\r\n\r\n        wrapper.appendChild(select);\r\n        return wrapper;\r\n    }\r\n\r\n    /**\r\n     * Peuple le s√©lecteur avec les couches disponibles\r\n     * @param {HTMLSelectElement} select - √âl√©ment select\r\n     * @private\r\n     */\r\n    function populateLayerSelector(select) {\r\n        Log.debug(\"[TablePanel] populateLayerSelector appel√©\");\r\n\r\n        if (!GeoLeaf.GeoJSON || typeof GeoLeaf.GeoJSON.getAllLayers !== \"function\") {\r\n            Log.warn(\"[TablePanel] Module GeoJSON non disponible\");\r\n            return;\r\n        }\r\n\r\n        const allLayers = GeoLeaf.GeoJSON.getAllLayers();\r\n        Log.debug(\"[TablePanel] getAllLayers retourne:\", allLayers.length, \"couches\");\r\n\r\n        if (allLayers.length === 0) {\r\n            Log.debug(\"[TablePanel] Aucune couche charg√©e, le s√©lecteur sera rafra√Æchi par l'√©v√©nement layers-loaded\");\r\n            return;\r\n        }\r\n\r\n        const VisibilityManager = GeoLeaf._LayerVisibilityManager;\r\n\r\n        // V√©rifier les options existantes pour √©viter les doublons\r\n        const existingValues = new Set();\r\n        for (let i = 1; i < select.options.length; i++) {\r\n            existingValues.add(select.options[i].value);\r\n        }\r\n\r\n        let addedCount = 0;\r\n        allLayers.forEach(layer => {\r\n            const layerData = GeoLeaf.GeoJSON.getLayerData(layer.id);\r\n            Log.debug(\"[TablePanel] V√©rification couche:\", layer.id, \"table enabled:\", layerData?.config?.table?.enabled);\r\n\r\n            if (layerData && layerData.config && layerData.config.table && layerData.config.table.enabled) {\r\n                // V√©rifier que la couche est visible sur la carte\r\n                let isVisible = true;\r\n                if (VisibilityManager && typeof VisibilityManager.getVisibilityState === \"function\") {\r\n                    const visState = VisibilityManager.getVisibilityState(layer.id);\r\n                    isVisible = visState && visState.current === true;\r\n                } else if (layerData._visibility) {\r\n                    isVisible = layerData._visibility.current === true;\r\n                }\r\n\r\n                if (!isVisible) {\r\n                    Log.debug(\"[TablePanel] Couche\", layer.id, \"masqu√©e, ignor√©e dans le s√©lecteur\");\r\n                    return;\r\n                }\r\n\r\n                // N'ajouter que si pas d√©j√† pr√©sent\r\n                if (!existingValues.has(layer.id)) {\r\n                    const option = document.createElement(\"option\");\r\n                    option.value = layer.id;\r\n                    option.textContent = layer.label || layer.id;\r\n                    select.appendChild(option);\r\n                    addedCount++;\r\n                }\r\n            }\r\n        });\r\n\r\n        if (addedCount > 0) {\r\n            Log.info(\"[TablePanel] S√©lecteur de couche peupl√©:\", addedCount, \"couches ajout√©es\");\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Cr√©e le champ de recherche\r\n     * @returns {HTMLElement}\r\n     * @private\r\n     */\r\n    function createSearchInput() {\r\n        const wrapper = document.createElement(\"div\");\r\n        wrapper.className = \"gl-table-panel__search\";\r\n\r\n        const input = document.createElement(\"input\");\r\n        input.type = \"text\";\r\n        input.id = \"geoleaf-table-search-input\";\r\n        input.name = \"geoleaf-table-search-input\";\r\n        input.placeholder = \"Rechercher...\";\r\n        input.className = \"gl-table-panel__search-input\";\r\n        input.setAttribute(\"data-table-search\", \"\");\r\n\r\n        // Debounce la recherche pour √©viter les appels trop fr√©quents\r\n        let timeout;\r\n        const inputHandler = (e) => {\r\n            clearTimeout(timeout);\r\n            timeout = setTimeout(() => {\r\n                const searchText = e.target.value.trim().toLowerCase();\r\n                filterTableRows(searchText);\r\n            }, 300);\r\n        };\r\n\r\n        wrapper.appendChild(input);\r\n        return wrapper;\r\n    }\r\n\r\n    /**\r\n     * Filtre les lignes du tableau selon le texte de recherche\r\n     * @param {string} searchText - Texte √† rechercher\r\n     * @private\r\n     */\r\n    function filterTableRows(searchText) {\r\n        const table = document.querySelector(\".gl-table-panel__table tbody\");\r\n        if (!table) return;\r\n\r\n        const rows = table.querySelectorAll(\"tr\");\r\n        let visibleCount = 0;\r\n\r\n        rows.forEach(row => {\r\n            if (!searchText) {\r\n                row.style.display = \"\";\r\n                visibleCount++;\r\n                return;\r\n            }\r\n\r\n            const cells = row.querySelectorAll(\"td\");\r\n            let match = false;\r\n\r\n            cells.forEach(cell => {\r\n                const text = cell.textContent.toLowerCase();\r\n                if (text.includes(searchText)) {\r\n                    match = true;\r\n                }\r\n            });\r\n\r\n            row.style.display = match ? \"\" : \"none\";\r\n            if (match) visibleCount++;\r\n        });\r\n\r\n        Log.debug(\"[TablePanel] Recherche:\", visibleCount, \"r√©sultats pour\", searchText);\r\n    }\r\n\r\n    /**\r\n     * Cr√©e un bouton g√©n√©rique\r\n     * @param {string} label - Libell√© du bouton\r\n     * @param {string} icon - Classe d'ic√¥ne (optionnel)\r\n     * @param {Function} onClick - Callback au clic\r\n     * @returns {HTMLElement}\r\n     * @private\r\n     */\r\n    function createButton(label, icon, onClick) {\r\n        const button = document.createElement(\"button\");\r\n        button.className = \"gl-table-panel__btn\";\r\n        button.textContent = label;\r\n\r\n        if (icon) {\r\n            button.classList.add(\"gl-table-panel__btn--\" + icon);\r\n        }\r\n\r\n        if (onClick) {\r\n            const events = GeoLeaf.Utils?.events;\r\n            if (events) {\r\n                GeoLeaf._TablePanel._eventCleanups.push(\r\n                    events.on(button, \"click\", onClick, false, 'TablePanel.button')\r\n                );\r\n            } else {\r\n                button.addEventListener(\"click\", onClick);\r\n            }\r\n        }\r\n\r\n        return button;\r\n    }\r\n\r\n    /**\r\n     * Met √† jour la position du bouton toggle en fonction de la hauteur du conteneur\r\n     * @param {HTMLElement} container - Conteneur du tableau\r\n     * @private\r\n     */\r\n    function updateToggleButtonPosition(container) {\r\n        const button = document.querySelector(\".gl-table-panel__toggle-btn\");\r\n        if (button && container.classList.contains(\"is-visible\")) {\r\n            const height = container.offsetHeight;\r\n            button.style.bottom = height + \"px\";\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Cr√©e le bouton toggle pour masquer le tableau (int√©gr√© dans le toolbar)\r\n     * @returns {HTMLElement}\r\n     * @private\r\n     */\r\n    function createToggleButton() {\r\n        const button = document.createElement(\"button\");\r\n        button.className = \"gl-table-panel__toggle-btn\";\r\n        button.title = \"Masquer le tableau\";\r\n        button.setAttribute(\"aria-label\", \"Masquer tableau\");\r\n\r\n        // Cr√©er l'ic√¥ne SVG (fl√®che vers le bas)\r\n        const icon = document.createElement(\"span\");\r\n        icon.className = \"gl-table-panel__toggle-btn__icon\";\r\n        // SAFE: SVG statique hardcod√©, pas de donn√©es utilisateur\r\n        const downSvg = GeoLeaf.DOMSecurity.createSVGIcon(16, 16, 'M6 9l6 6 6-6', {\r\n            stroke: 'currentColor',\r\n            strokeWidth: '6',\r\n            fill: 'none'\r\n        });\r\n        icon.appendChild(downSvg);\r\n        button.appendChild(icon);\r\n\r\n        const clickHandler = () => {\r\n            if (GeoLeaf.Table && typeof GeoLeaf.Table.toggle === \"function\") {\r\n                GeoLeaf.Table.toggle();\r\n            }\r\n        };\r\n\r\n        const events = GeoLeaf.Utils?.events;\r\n        if (events) {\r\n            GeoLeaf._TablePanel._eventCleanups.push(\r\n                events.on(button, \"click\", clickHandler, false, 'TablePanel.toggleBtn')\r\n            );\r\n        } else {\r\n            button.addEventListener(\"click\", clickHandler);\r\n        }\r\n\r\n        return button;\r\n        Log.debug(\"[TablePanel] Bouton toggle cr√©√©\");\r\n    }\r\n\r\n    /**\r\n     * Cr√©e le bouton flottant pour afficher le tableau (visible quand tableau masqu√©)\r\n     * @private\r\n     */\r\n    function createFloatingShowButton() {\r\n        const button = document.createElement(\"button\");\r\n        button.className = \"gl-table-panel__floating-show-btn\";\r\n        button.title = \"Afficher le tableau\";\r\n        button.setAttribute(\"aria-label\", \"Afficher tableau\");\r\n\r\n        // Cr√©er l'ic√¥ne SVG (fl√®che vers le haut)\r\n        const icon = document.createElement(\"span\");\r\n        icon.className = \"gl-table-panel__toggle-btn__icon\";\r\n        // SAFE: SVG statique hardcod√©, pas de donn√©es utilisateur\r\n        const upSvg = GeoLeaf.DOMSecurity.createSVGIcon(16, 16, 'M18 15l-6-6-6 6', {\r\n            stroke: 'currentColor',\r\n            strokeWidth: '6',\r\n            fill: 'none'\r\n        });\r\n        icon.appendChild(upSvg);\r\n        button.appendChild(icon);\r\n\r\n        const clickHandler = () => {\r\n            if (GeoLeaf.Table && typeof GeoLeaf.Table.show === \"function\") {\r\n                GeoLeaf.Table.show();\r\n            }\r\n        };\r\n\r\n        const events = GeoLeaf.Utils?.events;\r\n        if (events) {\r\n            GeoLeaf._TablePanel._eventCleanups.push(\r\n                events.on(button, \"click\", clickHandler, false, 'TablePanel.floatingShowBtn')\r\n            );\r\n        } else {\r\n            button.addEventListener(\"click\", clickHandler);\r\n        }\r\n\r\n        document.body.appendChild(button);\r\n        Log.debug(\"[TablePanel] Bouton flottant cr√©√©\");\r\n    }\r\n\r\n    /**\r\n     * Met √† jour l'√©tat des boutons de la toolbar selon la s√©lection\r\n     * @param {number} selectedCount - Nombre d'entit√©s s√©lectionn√©es\r\n     */\r\n    GeoLeaf._TablePanel.updateToolbarButtons = function (selectedCount) {\r\n        const hasSelection = selectedCount > 0;\r\n\r\n        const zoomBtn = document.querySelector(\"[data-table-btn='zoom']\");\r\n        const highlightBtn = document.querySelector(\"[data-table-btn='highlight']\");\r\n        const exportBtn = document.querySelector(\"[data-table-btn='export']\");\r\n\r\n        if (zoomBtn) zoomBtn.disabled = !hasSelection;\r\n        if (highlightBtn) {\r\n            highlightBtn.disabled = !hasSelection;\r\n            // Si plus aucune s√©lection, d√©sactiver la surbrillance\r\n            if (!hasSelection && highlightBtn.classList.contains(\"is-active\")) {\r\n                highlightBtn.classList.remove(\"is-active\");\r\n                if (GeoLeaf.Table && typeof GeoLeaf.Table.highlightSelection === \"function\") {\r\n                    GeoLeaf.Table.highlightSelection(false);\r\n                }\r\n            }\r\n        }\r\n        if (exportBtn) exportBtn.disabled = !hasSelection;\r\n\r\n        Log.debug(\"[TablePanel] Boutons mis √† jour. S√©lection:\", selectedCount);\r\n    };\r\n\r\n    /**\r\n     * Rafra√Æchit le s√©lecteur de couche (utile apr√®s chargement de nouvelles couches)\r\n     */\r\n    GeoLeaf._TablePanel.refreshLayerSelector = function () {\r\n        const select = document.querySelector(\"[data-table-layer-select]\");\r\n        if (!select) return;\r\n\r\n        // Sauvegarder la valeur actuelle\r\n        const currentValue = select.value;\r\n\r\n        // Vider les options (sauf la premi√®re)\r\n        while (select.options.length > 1) {\r\n            select.remove(1);\r\n        }\r\n\r\n        // Re-peupler\r\n        populateLayerSelector(select);\r\n\r\n        // V√©rifier si la valeur actuelle est toujours disponible\r\n        const optionValues = Array.from(select.options).map(o => o.value);\r\n        if (currentValue && optionValues.includes(currentValue)) {\r\n            select.value = currentValue;\r\n        } else if (currentValue && !optionValues.includes(currentValue)) {\r\n            // La couche active a √©t√© retir√©e (masqu√©e) ‚Äî basculer sur la premi√®re disponible\r\n            if (select.options.length > 1) {\r\n                select.value = select.options[1].value;\r\n                if (GeoLeaf.Table && typeof GeoLeaf.Table.setLayer === \"function\") {\r\n                    GeoLeaf.Table.setLayer(select.options[1].value);\r\n                }\r\n            } else {\r\n                // Aucune couche visible ‚Äî vider le tableau\r\n                select.value = \"\";\r\n                if (GeoLeaf.Table && typeof GeoLeaf.Table.setLayer === \"function\") {\r\n                    GeoLeaf.Table.setLayer(\"\");\r\n                }\r\n            }\r\n        }\r\n\r\n        // Mettre √† jour le placeholder si aucune couche visible\r\n        const defaultOption = select.options[0];\r\n        if (defaultOption) {\r\n            defaultOption.textContent = select.options.length > 1\r\n                ? \"S√©lectionner une couche...\"\r\n                : \"Aucune couche visible\";\r\n        }\r\n\r\n        Log.debug(\"[TablePanel] S√©lecteur de couche rafra√Æchi,\", (select.options.length - 1), \"couches disponibles\");\r\n    };\r\n\r\n    /**\r\n     * Cleanup all event listeners\r\n     */\r\n    GeoLeaf._TablePanel.destroy = function() {\r\n        if (GeoLeaf._TablePanel._eventCleanups && GeoLeaf._TablePanel._eventCleanups.length > 0) {\r\n            GeoLeaf._TablePanel._eventCleanups.forEach(cleanup => {\r\n                if (typeof cleanup === 'function') cleanup();\r\n            });\r\n            GeoLeaf._TablePanel._eventCleanups = [];\r\n            Log.info('[TablePanel] Event listeners cleaned up');\r\n        }\r\n    };\r\n\r\n})(typeof window !== \"undefined\" ? window : global);\r\n","/**\r\n * GeoLeaf Table - Renderer Module\r\n * Rendu des colonnes, lignes et pagination avec virtual scrolling\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    const Log = GeoLeaf.Log;\r\n\r\n    /**\r\n     * Shorthand for createElement\r\n     */\r\n    const $create = (tag, props, ...children) => {\r\n        return GeoLeaf.Utils && GeoLeaf.Utils.createElement\r\n            ? GeoLeaf.Utils.createElement(tag, props, ...children)\r\n            : document.createElement(tag);\r\n    };\r\n\r\n    GeoLeaf._TableRenderer = GeoLeaf._TableRenderer || {};\r\n    GeoLeaf._TableRenderer._eventCleanups = [];\r\n\r\n    /**\r\n     * Rend le tableau avec les donn√©es fournies\r\n     * @param {HTMLElement} container - Conteneur du tableau\r\n     * @param {Object} options - Options de rendu\r\n     * @param {string} options.layerId - ID de la couche\r\n     * @param {Array} options.features - Features √† afficher\r\n     * @param {Set} options.selectedIds - IDs des entit√©s s√©lectionn√©es\r\n     * @param {Object} options.sortState - √âtat du tri\r\n     * @param {Object} options.config - Configuration du tableau\r\n     */\r\n    GeoLeaf._TableRenderer.render = function (container, options) {\r\n        Log.debug(\"[TableRenderer] render() - D√©but, options:\", options);\r\n\r\n        if (!container) {\r\n            Log.error(\"[TableRenderer] Conteneur invalide\");\r\n            return;\r\n        }\r\n\r\n        // R√©initialiser le compteur d'IDs synth√©tiques √† chaque rendu\r\n        _syntheticIdCounter = 0;\r\n\r\n        const { layerId, features, selectedIds, sortState, config } = options;\r\n        Log.debug(\"[TableRenderer] render() - layerId:\", layerId, \"features:\", features ? features.length : 0);\r\n\r\n        const table = container.querySelector(\".gl-table-panel__table\");\r\n        if (!table) {\r\n            Log.error(\"[TableRenderer] √âl√©ment table introuvable\");\r\n            return;\r\n        }\r\n\r\n        // Si pas de layerId, vider le tableau\r\n        if (!layerId) {\r\n            // SAFE: Cha√Æne vide pour nettoyer le contenu\r\n            GeoLeaf.DOMSecurity.clearElementFast(table);\r\n            Log.debug(\"[TableRenderer] Tableau vid√© (aucune couche s√©lectionn√©e)\");\r\n            return;\r\n        }\r\n\r\n        // R√©cup√©rer la config du layer\r\n        const layerData = GeoLeaf.GeoJSON ? GeoLeaf.GeoJSON.getLayerData(layerId) : null;\r\n        const layerConfig = layerData && layerData.config && layerData.config.table ? layerData.config.table : null;\r\n\r\n        if (!layerConfig || !layerConfig.columns) {\r\n            Log.warn(\"[TableRenderer] Aucune configuration de colonne pour\", layerId);\r\n            // SAFE: Cha√Æne vide pour nettoyer le contenu\r\n            GeoLeaf.DOMSecurity.clearElementFast(table);\r\n            return;\r\n        }\r\n\r\n        Log.debug(\"[TableRenderer] Colonnes:\", layerConfig.columns);\r\n\r\n        // Vider le tableau\r\n        // SAFE: Cha√Æne vide pour nettoyer le contenu avant reconstruction\r\n        GeoLeaf.DOMSecurity.clearElementFast(table);\r\n\r\n        // Cr√©er le thead\r\n        const thead = createTableHead(layerConfig.columns, sortState);\r\n        table.appendChild(thead);\r\n\r\n        // Cr√©er le tbody\r\n        const tbody = createTableBody(features, layerConfig.columns, selectedIds);\r\n        table.appendChild(tbody);\r\n\r\n        // Appliquer virtual scrolling si activ√©\r\n        if (config.virtualScrolling && features.length > config.pageSize) {\r\n            applyVirtualScrolling(container, features, config.pageSize);\r\n        }\r\n\r\n        Log.debug(\"[TableRenderer] Tableau rendu:\", features.length, \"lignes\");\r\n    };\r\n\r\n    /**\r\n     * Cr√©e l'en-t√™te du tableau (thead)\r\n     * @param {Array} columns - Configuration des colonnes\r\n     * @param {Object} sortState - √âtat du tri actuel\r\n     * @returns {HTMLElement}\r\n     * @private\r\n     */\r\n    function createTableHead(columns, sortState) {\r\n        const thead = $create(\"thead\");\r\n        const tr = $create(\"tr\");\r\n\r\n        // Colonne checkbox (s√©lection)\r\n        const thCheckbox = $create(\"th\", { className: \"gl-table-panel__th gl-table-panel__th--checkbox\" });\r\n\r\n        const checkboxAll = $create(\"input\", {\r\n            type: \"checkbox\",\r\n            className: \"gl-table-panel__checkbox-all\",\r\n            title: \"Tout s√©lectionner / Tout d√©s√©lectionner\"\r\n        });\r\n\r\n        const checkboxAllHandler = (e) => {\r\n            toggleAllRows(e.target.checked);\r\n        };\r\n\r\n        const events = GeoLeaf.Utils?.events;\r\n        if (events) {\r\n            GeoLeaf._TableRenderer._eventCleanups.push(\r\n                events.on(checkboxAll, \"change\", checkboxAllHandler, false, 'TableRenderer.checkboxAll')\r\n            );\r\n        } else {\r\n            checkboxAll.addEventListener(\"change\", checkboxAllHandler);\r\n        }\r\n\r\n        thCheckbox.appendChild(checkboxAll);\r\n        tr.appendChild(thCheckbox);\r\n\r\n        // Colonnes de donn√©es\r\n        columns.forEach(col => {\r\n            const th = $create(\"th\", { className: \"gl-table-panel__th\" });\r\n            th.textContent = col.label || col.field;\r\n\r\n            if (col.width) {\r\n                th.style.width = col.width;\r\n            }\r\n\r\n            // Rendre la colonne triable (par d√©faut toutes les colonnes sont triables)\r\n            const isSortable = col.sortable !== false;\r\n            if (isSortable) {\r\n                th.classList.add(\"gl-table-panel__th--sortable\");\r\n                th.setAttribute(\"data-field\", col.field);\r\n\r\n                // Ajouter les indicateurs de tri\r\n                const sortIcon = $create(\"span\", { className: \"gl-table-panel__sort-icon\" });\r\n\r\n                if (sortState.field === col.field) {\r\n                    if (sortState.direction === \"asc\") {\r\n                        sortIcon.textContent = \" ‚ñ≤\";\r\n                        th.classList.add(\"is-sorted-asc\");\r\n                    } else if (sortState.direction === \"desc\") {\r\n                        sortIcon.textContent = \" ‚ñº\";\r\n                        th.classList.add(\"is-sorted-desc\");\r\n                    }\r\n                } else {\r\n                    sortIcon.textContent = \" ‚áÖ\";\r\n                }\r\n\r\n                th.appendChild(sortIcon);\r\n\r\n                // √âv√©nement de tri - avec cleanup tracking\r\n                const sortHandler = () => {\r\n                    if (GeoLeaf.Table && typeof GeoLeaf.Table.sortByField === \"function\") {\r\n                        GeoLeaf.Table.sortByField(col.field);\r\n                    }\r\n                };\r\n\r\n                const events = GeoLeaf.Utils?.events;\r\n                if (events) {\r\n                    GeoLeaf._TableRenderer._eventCleanups.push(\r\n                        events.on(th, \"click\", sortHandler, false, 'TableRenderer.sort')\r\n                    );\r\n                } else {\r\n                    th.addEventListener(\"click\", sortHandler);\r\n                }\r\n            }\r\n\r\n            tr.appendChild(th);\r\n        });\r\n\r\n        thead.appendChild(tr);\r\n        return thead;\r\n    }\r\n\r\n    /**\r\n     * Cr√©e le corps du tableau (tbody)\r\n     * @param {Array} features - Features √† afficher\r\n     * @param {Array} columns - Configuration des colonnes\r\n     * @param {Set} selectedIds - IDs s√©lectionn√©s\r\n     * @returns {HTMLElement}\r\n     * @private\r\n     */\r\n    function createTableBody(features, columns, selectedIds) {\r\n        Log.debug(\"[TableRenderer] createTableBody() - features:\", features.length);\r\n\r\n        const tbody = $create(\"tbody\");\r\n\r\n        // Sprint 3.2: Use DocumentFragment for batch DOM operations\r\n        const fragment = document.createDocumentFragment();\r\n\r\n        features.forEach((feature, index) => {\r\n            const tr = createTableRow(feature, columns, selectedIds);\r\n            fragment.appendChild(tr);\r\n        });\r\n\r\n        tbody.appendChild(fragment);\r\n\r\n        Log.debug(\"[TableRenderer] tbody cr√©√© avec\", tbody.children.length, \"lignes\");\r\n        return tbody;\r\n    }\r\n\r\n    /**\r\n     * Cr√©e une ligne du tableau\r\n     * @param {Object} feature - Feature GeoJSON\r\n     * @param {Array} columns - Configuration des colonnes\r\n     * @param {Set} selectedIds - IDs s√©lectionn√©s\r\n     * @returns {HTMLElement}\r\n     * @private\r\n     */\r\n    function createTableRow(feature, columns, selectedIds) {\r\n        const tr = $create(\"tr\");\r\n        const featureId = getFeatureId(feature);\r\n        tr.setAttribute(\"data-feature-id\", featureId);\r\n\r\n        const isSelected = selectedIds.has(String(featureId));\r\n        if (isSelected) {\r\n            tr.classList.add(\"is-selected\");\r\n        }\r\n\r\n        // Cellule checkbox\r\n        const tdCheckbox = $create(\"td\", { className: \"gl-table-panel__td gl-table-panel__td--checkbox\" });\r\n\r\n        const checkbox = $create(\"input\", {\r\n            type: \"checkbox\",\r\n            className: \"gl-table-panel__checkbox\",\r\n            checked: isSelected\r\n        });\r\n\r\n        const checkboxHandler = (e) => {\r\n            // Pour les checkboxes, toujours traiter comme multi-s√©lection\r\n            handleRowSelection(featureId, e.target.checked, false, true, true);\r\n        };\r\n\r\n        const events = GeoLeaf.Utils?.events;\r\n        if (events) {\r\n            GeoLeaf._TableRenderer._eventCleanups.push(\r\n                events.on(checkbox, \"change\", checkboxHandler, false, 'TableRenderer.checkbox')\r\n            );\r\n        } else {\r\n            checkbox.addEventListener(\"change\", checkboxHandler);\r\n        }\r\n\r\n        tdCheckbox.appendChild(checkbox);\r\n        tr.appendChild(tdCheckbox);\r\n\r\n        // Cellules de donn√©es\r\n        columns.forEach((col, colIndex) => {\r\n            const td = $create(\"td\", { className: \"gl-table-panel__td\" });\r\n\r\n            const value = getNestedValue(feature, col.field);\r\n            const formattedValue = formatValue(value, col.type);\r\n\r\n            td.textContent = formattedValue;\r\n\r\n            // Aligner les nombres √† droite\r\n            if (col.type === \"number\") {\r\n                td.classList.add(\"gl-table-panel__td--number\");\r\n            }\r\n\r\n            tr.appendChild(td);\r\n        });\r\n\r\n        // √âv√©nement clic sur la ligne (s√©lection simple) - avec cleanup tracking\r\n        const rowClickHandler = (e) => {\r\n            // Ignorer si c'est le checkbox qui a √©t√© cliqu√©\r\n            if (e.target.type === \"checkbox\") return;\r\n            const currentState = tr.classList.contains(\"is-selected\");\r\n            handleRowSelection(featureId, !currentState, e.shiftKey, e.ctrlKey || e.metaKey);\r\n        };\r\n\r\n        // Reuse EventListenerManager from outer scope\r\n        if (events) {\r\n            GeoLeaf._TableRenderer._eventCleanups.push(\r\n                events.on(tr, \"click\", rowClickHandler, false, 'TableRenderer.rowClick')\r\n            );\r\n        } else {\r\n            tr.addEventListener(\"click\", rowClickHandler);\r\n        }\r\n\r\n        return tr;\r\n    }\r\n\r\n    /**\r\n     * G√®re la s√©lection d'une ligne\r\n     * @param {string} featureId - ID de la feature\r\n     * @param {boolean} selected - S√©lectionn√© ou non\r\n     * @param {boolean} shiftKey - Touche Shift enfonc√©e\r\n     * @param {boolean} ctrlKey - Touche Ctrl/Cmd enfonc√©e\r\n     * @param {boolean} isCheckbox - Si l'action vient d'une checkbox\r\n     * @private\r\n     */\r\n    function handleRowSelection(featureId, selected, shiftKey, ctrlKey, isCheckbox = false) {\r\n        Log.debug(\"[TableRenderer] handleRowSelection - featureId:\", featureId, \"selected:\", selected);\r\n\r\n        if (!GeoLeaf.Table) {\r\n            Log.error(\"[TableRenderer] GeoLeaf.Table non disponible\");\r\n            return;\r\n        }\r\n\r\n        const currentSelection = GeoLeaf.Table.getSelectedIds();\r\n\r\n        if (shiftKey && currentSelection.length > 0) {\r\n            // S√©lection par plage (Shift+clic)\r\n            Log.debug(\"[TableRenderer] Mode SHIFT - S√©lection par plage\");\r\n            selectRange(featureId);\r\n        } else if (ctrlKey || isCheckbox) {\r\n            // Multi-s√©lection (Ctrl+clic ou checkbox)\r\n            Log.debug(\"[TableRenderer] Mode MULTI - Multi-s√©lection\" + (isCheckbox ? \" (checkbox)\" : \" (Ctrl)\"));\r\n            if (selected) {\r\n                const newSelection = [...currentSelection, featureId];\r\n                GeoLeaf.Table.setSelection(newSelection, false);\r\n            } else {\r\n                const newSelection = currentSelection.filter(id => id !== featureId);\r\n                GeoLeaf.Table.setSelection(newSelection, false);\r\n            }\r\n        } else {\r\n            // S√©lection simple\r\n            Log.debug(\"[TableRenderer] Mode SIMPLE - S√©lection unique\");\r\n            if (selected) {\r\n                GeoLeaf.Table.setSelection([featureId], false);\r\n            } else {\r\n                GeoLeaf.Table.clearSelection();\r\n            }\r\n        }\r\n\r\n        // Mettre √† jour l'√©tat des boutons\r\n        updateToolbarButtonsState();\r\n    }\r\n\r\n    /**\r\n     * S√©lectionne une plage de lignes (Shift+clic)\r\n     * @param {string} targetId - ID de la feature cible\r\n     * @private\r\n     */\r\n    function selectRange(targetId) {\r\n        const tbody = document.querySelector(\".gl-table-panel__table tbody\");\r\n        if (!tbody) return;\r\n\r\n        const rows = Array.from(tbody.querySelectorAll(\"tr\"));\r\n        const currentSelection = GeoLeaf.Table.getSelectedIds();\r\n        const lastSelected = currentSelection[currentSelection.length - 1];\r\n\r\n        const targetIndex = rows.findIndex(r => r.getAttribute(\"data-feature-id\") === targetId);\r\n        const lastIndex = rows.findIndex(r => r.getAttribute(\"data-feature-id\") === lastSelected);\r\n\r\n        if (targetIndex === -1 || lastIndex === -1) return;\r\n\r\n        const start = Math.min(targetIndex, lastIndex);\r\n        const end = Math.max(targetIndex, lastIndex);\r\n\r\n        const rangeIds = [];\r\n        for (let i = start; i <= end; i++) {\r\n            const id = rows[i].getAttribute(\"data-feature-id\");\r\n            if (id) rangeIds.push(id);\r\n        }\r\n\r\n        GeoLeaf.Table.setSelection(rangeIds, false);\r\n        updateToolbarButtonsState();\r\n    }\r\n\r\n    /**\r\n     * Toggle toutes les lignes (checkbox \"tout s√©lectionner\")\r\n     * @param {boolean} checked - √âtat du checkbox\r\n     * @private\r\n     */\r\n    function toggleAllRows(checked) {\r\n        const tbody = document.querySelector(\".gl-table-panel__table tbody\");\r\n        if (!tbody) return;\r\n\r\n        const rows = tbody.querySelectorAll(\"tr\");\r\n        const ids = [];\r\n\r\n        rows.forEach(row => {\r\n            const id = row.getAttribute(\"data-feature-id\");\r\n            if (id) {\r\n                ids.push(id);\r\n                row.classList.toggle(\"is-selected\", checked);\r\n                const checkbox = row.querySelector(\".gl-table-panel__checkbox\");\r\n                if (checkbox) checkbox.checked = checked;\r\n            }\r\n        });\r\n\r\n        if (checked) {\r\n            GeoLeaf.Table.setSelection(ids, false);\r\n        } else {\r\n            GeoLeaf.Table.clearSelection();\r\n        }\r\n\r\n        updateToolbarButtonsState();\r\n    }\r\n\r\n    /**\r\n     * Met √† jour la s√©lection visuelle dans le tableau\r\n     * @param {HTMLElement} container - Conteneur du tableau\r\n     * @param {Set} selectedIds - IDs s√©lectionn√©s\r\n     */\r\n    GeoLeaf._TableRenderer.updateSelection = function (container, selectedIds) {\r\n        const tbody = container.querySelector(\".gl-table-panel__table tbody\");\r\n        if (!tbody) return;\r\n\r\n        const rows = tbody.querySelectorAll(\"tr\");\r\n\r\n        rows.forEach(row => {\r\n            const id = row.getAttribute(\"data-feature-id\");\r\n            const isSelected = selectedIds.has(String(id));\r\n\r\n            row.classList.toggle(\"is-selected\", isSelected);\r\n\r\n            const checkbox = row.querySelector(\".gl-table-panel__checkbox\");\r\n            if (checkbox) {\r\n                checkbox.checked = isSelected;\r\n            }\r\n        });\r\n\r\n        // Mettre √† jour le checkbox \"tout s√©lectionner\"\r\n        const checkboxAll = container.querySelector(\".gl-table-panel__checkbox-all\");\r\n        if (checkboxAll) {\r\n            const totalRows = rows.length;\r\n            const selectedCount = selectedIds.size;\r\n            checkboxAll.checked = totalRows > 0 && selectedCount === totalRows;\r\n            checkboxAll.indeterminate = selectedCount > 0 && selectedCount < totalRows;\r\n        }\r\n\r\n        updateToolbarButtonsState();\r\n    };\r\n\r\n    /**\r\n     * Applique le virtual scrolling pour de grandes listes\r\n     * @param {HTMLElement} container - Conteneur\r\n     * @param {Array} features - Features compl√®tes\r\n     * @param {number} pageSize - Taille de page\r\n     * @private\r\n     */\r\n    function applyVirtualScrolling(container, features, pageSize) {\r\n        // Implementation simple : pagination au scroll\r\n        // Pour un vrai virtual scrolling, utiliser IntersectionObserver\r\n        Log.debug(\"[TableRenderer] Virtual scrolling activ√© pour\", features.length, \"entit√©s\");\r\n        // TODO(v3.2): Implement custom cell renderers if necessary for advanced use cases\r\n    }\r\n\r\n    /**\r\n     * Met √† jour l'√©tat des boutons de la toolbar\r\n     * @private\r\n     */\r\n    function updateToolbarButtonsState() {\r\n        if (!GeoLeaf.Table) return;\r\n\r\n        const selectedCount = GeoLeaf.Table.getSelectedIds().length;\r\n\r\n        if (GeoLeaf._TablePanel && typeof GeoLeaf._TablePanel.updateToolbarButtons === \"function\") {\r\n            GeoLeaf._TablePanel.updateToolbarButtons(selectedCount);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Compteur interne pour g√©n√©rer des IDs synth√©tiques\r\n     * @type {number}\r\n     * @private\r\n     */\r\n    let _syntheticIdCounter = 0;\r\n\r\n    /**\r\n     * R√©cup√®re l'ID d'une feature de mani√®re fiable\r\n     * Parcourt plusieurs propri√©t√©s candidates puis g√©n√®re un ID synth√©tique si n√©cessaire\r\n     * @param {Object} feature - Feature GeoJSON\r\n     * @returns {string}\r\n     * @private\r\n     */\r\n    function getFeatureId(feature) {\r\n        // 1. ID standard GeoJSON\r\n        if (feature.id != null && feature.id !== \"\") return String(feature.id);\r\n\r\n        const p = feature.properties;\r\n        if (!p) return \"__gl_row_\" + (_syntheticIdCounter++);\r\n\r\n        // 2. Propri√©t√©s d'identifiant courantes\r\n        if (p.id != null && p.id !== \"\") return String(p.id);\r\n        if (p.fid != null && p.fid !== \"\") return String(p.fid);\r\n        if (p.osm_id != null && p.osm_id !== \"\") return String(p.osm_id);\r\n        if (p.OBJECTID != null && p.OBJECTID !== \"\") return String(p.OBJECTID);\r\n        if (p.SITE_ID != null && p.SITE_ID !== \"\") return String(p.SITE_ID);\r\n        if (p.code != null && p.code !== \"\") return String(p.code);\r\n        if (p.IN1 != null && p.IN1 !== \"\") return String(p.IN1);\r\n\r\n        // 3. Fallback : ID synth√©tique bas√© sur un compteur\r\n        return \"__gl_row_\" + (_syntheticIdCounter++);\r\n    }\r\n\r\n    /**\r\n     * R√©cup√®re une valeur imbriqu√©e dans un objet\r\n     * @param {Object} obj - Objet source\r\n     * @param {string} path - Chemin avec notation point\r\n     * @returns {*}\r\n     * @private\r\n     */\r\n    function getNestedValue(obj, path) {\r\n        if (!obj || !path) return null;\r\n        return path.split('.').reduce((current, prop) =>\r\n            current && current[prop] !== undefined ? current[prop] : null, obj);\r\n    }\r\n\r\n    /**\r\n     * Formate une valeur selon son type\r\n     * @param {*} value - Valeur √† formater\r\n     * @param {string} type - Type de donn√©es (string, number, date)\r\n     * @returns {string}\r\n     * @private\r\n     */\r\n    function formatValue(value, type) {\r\n        if (value == null || value === \"\") return \"‚Äì\";\r\n\r\n        if (type === \"number\") {\r\n            const num = Number(value);\r\n            if (isNaN(num)) return String(value);\r\n            // Formater avec s√©parateurs de milliers\r\n            return num.toLocaleString(\"fr-FR\");\r\n        }\r\n\r\n        if (type === \"date\") {\r\n            const date = new Date(value);\r\n            if (isNaN(date.getTime())) return String(value);\r\n            return date.toLocaleDateString(\"fr-FR\");\r\n        }\r\n\r\n        return String(value);\r\n    }\r\n\r\n})(typeof window !== \"undefined\" ? window : global);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n/**\r\n * GeoLeaf Table Module\r\n * Affichage tabulaire des donn√©es cartographiques avec tri, recherche et s√©lection\r\n * Version: 1.0.0\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    const Log = GeoLeaf.Log;\r\n\r\n    /**\r\n     * Module GeoLeaf.Table\r\n     * Vue tabulaire compl√©mentaire √† la carte\r\n     */\r\n    const TableModule = {\r\n        /**\r\n         * R√©f√©rence vers la carte Leaflet\r\n         * @type {L.Map|null}\r\n         */\r\n        _map: null,\r\n\r\n        /**\r\n         * Configuration du module table depuis geoleaf.config.json\r\n         * @type {Object|null}\r\n         */\r\n        _config: null,\r\n\r\n        /**\r\n         * Couche actuellement affich√©e dans le tableau\r\n         * @type {string|null}\r\n         */\r\n        _currentLayerId: null,\r\n\r\n        /**\r\n         * IDs des entit√©s s√©lectionn√©es\r\n         * @type {Set<string>}\r\n         */\r\n        _selectedIds: new Set(),\r\n\r\n        /**\r\n         * Donn√©es en cache (features filtr√©es)\r\n         * @type {Array}\r\n         */\r\n        _cachedData: [],\r\n\r\n        /**\r\n         * Mapping featureId ‚Üí index dans _cachedData (synchronis√© avec le renderer)\r\n         * @type {Map<string, number>}\r\n         */\r\n        _featureIdMap: new Map(),\r\n\r\n        /**\r\n         * Couches Leaflet de surbrillance actuellement actives\r\n         * @type {Array<L.Layer>}\r\n         */\r\n        _highlightLayers: [],\r\n\r\n        /**\r\n         * Indique si la surbrillance est activ√©e\r\n         * @type {boolean}\r\n         */\r\n        _highlightActive: false,\r\n\r\n        /**\r\n         * √âtat actuel du tri\r\n         * @type {Object}\r\n         */\r\n        _sortState: {\r\n            field: null,\r\n            direction: null // 'asc' | 'desc' | null\r\n        },\r\n\r\n        /**\r\n         * Conteneur DOM du tableau\r\n         * @type {HTMLElement|null}\r\n         */\r\n        _container: null,\r\n\r\n        /**\r\n         * Indique si le tableau est visible\r\n         * @type {boolean}\r\n         */\r\n        _isVisible: false,\r\n\r\n        /**\r\n         * Initialise le module Table\r\n         * @param {Object} options - Options d'initialisation\r\n         * @param {L.Map} options.map - Instance de la carte Leaflet\r\n         * @param {Object} [options.config] - Configuration personnalis√©e\r\n         */\r\n        init(options) {\r\n            if (!options || !options.map) {\r\n                Log.error(\"[Table] init() n√©cessite une instance de carte Leaflet\");\r\n                return;\r\n            }\r\n\r\n            this._map = options.map;\r\n\r\n            // R√©cup√©rer la config depuis GeoLeaf.Config\r\n            const globalConfig = GeoLeaf.Config ? GeoLeaf.Config.get(\"tableConfig\") : null;\r\n            this._config = Object.assign({\r\n                enabled: true,\r\n                defaultVisible: false,\r\n                pageSize: 50,\r\n                maxRowsPerLayer: 1000,\r\n                enableExportButton: true,\r\n                virtualScrolling: true,\r\n                defaultHeight: \"40%\",\r\n                minHeight: \"20%\",\r\n                maxHeight: \"60%\",\r\n                resizable: false\r\n            }, globalConfig, options.config);\r\n\r\n            if (!this._config.enabled) {\r\n                Log.info(\"[Table] Module d√©sactiv√© via configuration\");\r\n                return;\r\n            }\r\n\r\n            Log.info(\"[Table] Initialisation du module Table\", this._config);\r\n\r\n            // Cr√©er le panel si besoin\r\n            if (GeoLeaf._TablePanel && typeof GeoLeaf._TablePanel.create === \"function\") {\r\n                this._container = GeoLeaf._TablePanel.create(this._map, this._config);\r\n            } else {\r\n                Log.error(\"[Table] Module table/panel.js non charg√©\");\r\n                return;\r\n            }\r\n\r\n            // D√©finir la visibilit√© initiale\r\n            if (this._config.defaultVisible) {\r\n                this.show();\r\n            }\r\n\r\n            // √âcouter les √©v√©nements carte\r\n            this._attachMapEvents();\r\n\r\n            Log.info(\"[Table] Module Table initialis√© avec succ√®s\");\r\n        },\r\n\r\n        /**\r\n         * Attache les listeners d'√©v√©nements Leaflet\r\n         * @private\r\n         */\r\n        _attachMapEvents() {\r\n            if (!this._map) return;\r\n\r\n            // Timer pour debounce du rafra√Æchissement du s√©lecteur\r\n            let refreshSelectorTimer = null;\r\n            const debouncedRefreshSelector = () => {\r\n                if (refreshSelectorTimer) clearTimeout(refreshSelectorTimer);\r\n                refreshSelectorTimer = setTimeout(() => {\r\n                    if (GeoLeaf._TablePanel && typeof GeoLeaf._TablePanel.refreshLayerSelector === \"function\") {\r\n                        GeoLeaf._TablePanel.refreshLayerSelector();\r\n                    }\r\n                }, 150);\r\n            };\r\n\r\n            // Synchroniser avec les changements de filtres\r\n            this._map.on(\"geoleaf:filters:changed\", () => {\r\n                if (this._isVisible && this._currentLayerId) {\r\n                    this.refresh();\r\n                }\r\n            });\r\n\r\n            // Rafra√Æchir le s√©lecteur quand les couches GeoJSON sont charg√©es\r\n            this._map.on(\"geoleaf:geojson:layers-loaded\", () => {\r\n                Log.debug(\"[Table] √âv√©nement layers-loaded re√ßu, rafra√Æchissement du s√©lecteur\");\r\n                debouncedRefreshSelector();\r\n            });\r\n\r\n            // Rafra√Æchir le s√©lecteur quand un th√®me est appliqu√©\r\n            // (c'est √† ce moment que la visibilit√© est r√©ellement d√©finie)\r\n            document.addEventListener(\"geoleaf:theme:applied\", () => {\r\n                Log.debug(\"[Table] √âv√©nement theme:applied re√ßu, rafra√Æchissement du s√©lecteur\");\r\n                debouncedRefreshSelector();\r\n            });\r\n\r\n            // Synchroniser avec les changements de visibilit√© des couches\r\n            this._map.on(\"geoleaf:geojson:visibility-changed\", (e) => {\r\n                // Rafra√Æchir le s√©lecteur (debounced pour grouper les changements multiples)\r\n                debouncedRefreshSelector();\r\n\r\n                // Si la couche active est celle qui a chang√© de visibilit√©\r\n                if (this._currentLayerId === e.layerId) {\r\n                    if (e.visible) {\r\n                        this.refresh();\r\n                    } else {\r\n                        // La couche active a √©t√© masqu√©e : basculer sur la premi√®re couche visible\r\n                        // Attendre le debounce pour que le s√©lecteur soit √† jour\r\n                        setTimeout(() => {\r\n                            const available = this._getAvailableVisibleLayers();\r\n                            if (available.length > 0) {\r\n                                this.setLayer(available[0].id);\r\n                                const select = document.querySelector(\"[data-table-layer-select]\");\r\n                                if (select) select.value = available[0].id;\r\n                            } else {\r\n                                this.setLayer(\"\");\r\n                            }\r\n                        }, 200);\r\n                    }\r\n                }\r\n            });\r\n        },\r\n\r\n        /**\r\n         * Affiche le tableau\r\n         */\r\n        show() {\r\n            if (!this._container) {\r\n                Log.warn(\"[Table] Conteneur non initialis√©\");\r\n                return;\r\n            }\r\n\r\n            this._container.classList.add(\"is-visible\");\r\n            this._isVisible = true;\r\n\r\n            this._fireEvent(\"table:opened\", {});\r\n            Log.debug(\"[Table] Tableau affich√©\");\r\n        },\r\n\r\n        /**\r\n         * Masque le tableau\r\n         */\r\n        hide() {\r\n            if (!this._container) return;\r\n\r\n            // Nettoyer la surbrillance\r\n            this._clearHighlightLayers();\r\n            this._highlightActive = false;\r\n\r\n            this._container.classList.remove(\"is-visible\");\r\n            this._isVisible = false;\r\n\r\n            this._fireEvent(\"table:closed\", {});\r\n            Log.debug(\"[Table] Tableau masqu√©\");\r\n        },\r\n\r\n        /**\r\n         * Toggle la visibilit√© du tableau\r\n         */\r\n        toggle() {\r\n            if (this._isVisible) {\r\n                this.hide();\r\n            } else {\r\n                this.show();\r\n            }\r\n        },\r\n\r\n        /**\r\n         * D√©finit la couche √† afficher dans le tableau\r\n         * @param {string} layerId - ID de la couche\r\n         */\r\n        setLayer(layerId) {\r\n            Log.debug(\"[Table] setLayer appel√© avec:\", layerId);\r\n\r\n            // Si layerId est vide, vider le tableau\r\n            if (!layerId) {\r\n                this._currentLayerId = null;\r\n                this._selectedIds.clear();\r\n                this._clearHighlightLayers();\r\n                this._highlightActive = false;\r\n                this._featureIdMap.clear();\r\n                this._sortState = { field: null, direction: null };\r\n                this._cachedData = [];\r\n\r\n                // Vider le tableau visuellement\r\n                if (GeoLeaf._TableRenderer && this._container) {\r\n                    GeoLeaf._TableRenderer.render(this._container, {\r\n                        layerId: null,\r\n                        features: [],\r\n                        selectedIds: this._selectedIds,\r\n                        sortState: this._sortState,\r\n                        config: this._config\r\n                    });\r\n                }\r\n\r\n                this._fireEvent(\"table:layerChanged\", { layerId: null });\r\n                Log.debug(\"[Table] Tableau vid√© (aucune couche s√©lectionn√©e)\");\r\n                return;\r\n            }\r\n\r\n            const layers = this._getAvailableLayers();\r\n            const layer = layers.find(l => l.id === layerId);\r\n\r\n            if (!layer) {\r\n                Log.warn(\"[Table] Couche introuvable ou non activ√©e pour le tableau:\", layerId);\r\n                return;\r\n            }\r\n\r\n            this._currentLayerId = layerId;\r\n            this._selectedIds.clear();\r\n            this._clearHighlightLayers();\r\n            this._highlightActive = false;\r\n            this._sortState = { field: null, direction: null };\r\n\r\n            // D√©finir le tri par d√©faut depuis la config du layer\r\n            const layerData = GeoLeaf.GeoJSON ? GeoLeaf.GeoJSON.getLayerData(layerId) : null;\r\n            if (layerData && layerData.config && layerData.config.table && layerData.config.table.defaultSort) {\r\n                this._sortState.field = layerData.config.table.defaultSort.field;\r\n                this._sortState.direction = layerData.config.table.defaultSort.direction || layerData.config.table.defaultSort.order || \"asc\";\r\n            }\r\n\r\n            this.refresh();\r\n\r\n            this._fireEvent(\"table:layerChanged\", { layerId });\r\n            Log.debug(\"[Table] Couche chang√©e:\", layerId);\r\n        },\r\n\r\n        /**\r\n         * Rafra√Æchit les donn√©es affich√©es dans le tableau\r\n         */\r\n        refresh() {\r\n            if (!this._currentLayerId) {\r\n                Log.debug(\"[Table] Aucune couche s√©lectionn√©e, impossible de rafra√Æchir\");\r\n                return;\r\n            }\r\n\r\n            // R√©cup√©rer les donn√©es depuis GeoJSON\r\n            const features = this._getLayerFeatures(this._currentLayerId);\r\n            this._cachedData = features;\r\n\r\n            // Construire le mapping ID‚Üíindex (miroir de la logique du renderer)\r\n            this._featureIdMap.clear();\r\n            let syntheticCounter = 0;\r\n            features.forEach((feature, index) => {\r\n                const id = this._resolveFeatureId(feature, syntheticCounter);\r\n                if (id.startsWith(\"__gl_row_\")) syntheticCounter++;\r\n                this._featureIdMap.set(id, index);\r\n            });\r\n\r\n            Log.debug(\"[Table] Features r√©cup√©r√©es:\", features.length);\r\n\r\n            // Appliquer le tri si d√©fini\r\n            if (this._sortState.field && this._sortState.direction) {\r\n                this._applySorting();\r\n            }\r\n\r\n            // Rafra√Æchir le rendu\r\n            if (GeoLeaf._TableRenderer && typeof GeoLeaf._TableRenderer.render === \"function\") {\r\n                GeoLeaf._TableRenderer.render(this._container, {\r\n                    layerId: this._currentLayerId,\r\n                    features: this._cachedData,\r\n                    selectedIds: this._selectedIds,\r\n                    sortState: this._sortState,\r\n                    config: this._config\r\n                });\r\n            } else {\r\n                Log.error(\"[Table] Renderer non disponible\");\r\n            }\r\n\r\n            Log.debug(\"[Table] Donn√©es rafra√Æchies:\", features.length, \"entit√©s\");\r\n        },\r\n\r\n        /**\r\n         * R√©cup√®re les features d'une couche avec les filtres appliqu√©s\r\n         * @param {string} layerId - ID de la couche\r\n         * @returns {Array} Features\r\n         * @private\r\n         */\r\n        _getLayerFeatures(layerId) {\r\n            if (!GeoLeaf.GeoJSON || typeof GeoLeaf.GeoJSON.getLayerData !== \"function\") {\r\n                Log.warn(\"[Table] Module GeoJSON non disponible\");\r\n                return [];\r\n            }\r\n\r\n            const layerData = GeoLeaf.GeoJSON.getLayerData(layerId);\r\n\r\n            if (!layerData || !layerData.features) {\r\n                Log.warn(\"[Table] Aucune donn√©e pour la couche:\", layerId);\r\n                return [];\r\n            }\r\n\r\n            Log.debug(\"[Table] _getLayerFeatures - Nombre de features:\", layerData.features.length);\r\n\r\n            // Appliquer la limite de lignes\r\n            const maxRows = this._config.maxRowsPerLayer || 1000;\r\n            if (layerData.features.length > maxRows) {\r\n                Log.warn(\"[Table] Donn√©es volumineuses (\" + layerData.features.length + \" entit√©s). Limit√© √† \" + maxRows);\r\n                return layerData.features.slice(0, maxRows);\r\n            }\r\n\r\n            return layerData.features || [];\r\n        },\r\n\r\n        /**\r\n         * R√©cup√®re les couches disponibles pour le tableau (table.enabled)\r\n         * @returns {Array} Liste des couches avec table.enabled = true\r\n         * @private\r\n         */\r\n        _getAvailableLayers() {\r\n            if (!GeoLeaf.GeoJSON || typeof GeoLeaf.GeoJSON.getAllLayers !== \"function\") {\r\n                return [];\r\n            }\r\n\r\n            const allLayers = GeoLeaf.GeoJSON.getAllLayers();\r\n            const availableLayers = [];\r\n\r\n            allLayers.forEach(layer => {\r\n                const layerData = GeoLeaf.GeoJSON.getLayerData(layer.id);\r\n                if (layerData && layerData.config && layerData.config.table && layerData.config.table.enabled) {\r\n                    availableLayers.push({\r\n                        id: layer.id,\r\n                        label: layer.label || layer.id,\r\n                        config: layerData.config.table\r\n                    });\r\n                }\r\n            });\r\n\r\n            return availableLayers;\r\n        },\r\n\r\n        /**\r\n         * R√©cup√®re les couches disponibles ET visibles pour le tableau\r\n         * @returns {Array} Liste des couches avec table.enabled = true et visibles sur la carte\r\n         * @private\r\n         */\r\n        _getAvailableVisibleLayers() {\r\n            const available = this._getAvailableLayers();\r\n            const VisibilityManager = GeoLeaf._LayerVisibilityManager;\r\n\r\n            return available.filter(layer => {\r\n                if (VisibilityManager && typeof VisibilityManager.getVisibilityState === \"function\") {\r\n                    const visState = VisibilityManager.getVisibilityState(layer.id);\r\n                    return visState && visState.current === true;\r\n                }\r\n                // Fallback : v√©rifier via layerData\r\n                const layerData = GeoLeaf.GeoJSON.getLayerData(layer.id);\r\n                return layerData && layerData._visibility && layerData._visibility.current === true;\r\n            });\r\n        },\r\n\r\n        /**\r\n         * Applique le tri sur les donn√©es en cache\r\n         * @private\r\n         */\r\n        _applySorting() {\r\n            if (!this._sortState.field || !this._sortState.direction) return;\r\n\r\n            const field = this._sortState.field;\r\n            const direction = this._sortState.direction;\r\n\r\n            this._cachedData.sort((a, b) => {\r\n                const valA = this._getNestedValue(a, field);\r\n                const valB = this._getNestedValue(b, field);\r\n\r\n                // Gestion des valeurs nulles\r\n                if (valA == null && valB == null) return 0;\r\n                if (valA == null) return direction === \"asc\" ? 1 : -1;\r\n                if (valB == null) return direction === \"asc\" ? -1 : 1;\r\n\r\n                // Comparaison\r\n                let result = 0;\r\n                if (typeof valA === \"number\" && typeof valB === \"number\") {\r\n                    result = valA - valB;\r\n                } else {\r\n                    result = String(valA).localeCompare(String(valB));\r\n                }\r\n\r\n                return direction === \"asc\" ? result : -result;\r\n            });\r\n\r\n            Log.debug(\"[Table] Tri appliqu√©:\", field, direction);\r\n        },\r\n\r\n        /**\r\n         * Change le tri sur une colonne\r\n         * @param {string} field - Chemin du champ\r\n         */\r\n        sortByField(field) {\r\n            if (this._sortState.field === field) {\r\n                // Cycle : asc ‚Üí desc ‚Üí null\r\n                if (this._sortState.direction === \"asc\") {\r\n                    this._sortState.direction = \"desc\";\r\n                } else if (this._sortState.direction === \"desc\") {\r\n                    this._sortState.field = null;\r\n                    this._sortState.direction = null;\r\n                } else {\r\n                    this._sortState.direction = \"asc\";\r\n                }\r\n            } else {\r\n                this._sortState.field = field;\r\n                this._sortState.direction = \"asc\";\r\n            }\r\n\r\n            this.refresh();\r\n            this._fireEvent(\"table:sortChanged\", this._sortState);\r\n        },\r\n\r\n        /**\r\n         * S√©lectionne ou d√©s√©lectionne des entit√©s\r\n         * @param {Array<string>} ids - IDs √† s√©lectionner\r\n         * @param {boolean} [add=false] - Ajouter √† la s√©lection existante ou remplacer\r\n         */\r\n        setSelection(ids, add = false) {\r\n            if (!add) {\r\n                this._selectedIds.clear();\r\n            }\r\n\r\n            ids.forEach(id => this._selectedIds.add(String(id)));\r\n\r\n            this._fireEvent(\"table:selectionChanged\", {\r\n                layerId: this._currentLayerId,\r\n                selectedIds: Array.from(this._selectedIds)\r\n            });\r\n\r\n            // Rafra√Æchir le rendu pour mettre √† jour les cases coch√©es\r\n            if (GeoLeaf._TableRenderer && typeof GeoLeaf._TableRenderer.updateSelection === \"function\") {\r\n                GeoLeaf._TableRenderer.updateSelection(this._container, this._selectedIds);\r\n            }\r\n\r\n            Log.debug(\"[Table] S√©lection mise √† jour:\", this._selectedIds.size, \"entit√©s\");\r\n        },\r\n\r\n        /**\r\n         * Retourne les IDs des entit√©s s√©lectionn√©es\r\n         * @returns {Array<string>}\r\n         */\r\n        getSelectedIds() {\r\n            return Array.from(this._selectedIds);\r\n        },\r\n\r\n        /**\r\n         * Efface la s√©lection\r\n         */\r\n        clearSelection() {\r\n            this._selectedIds.clear();\r\n            this._fireEvent(\"table:selectionChanged\", {\r\n                layerId: this._currentLayerId,\r\n                selectedIds: []\r\n            });\r\n\r\n            if (GeoLeaf._TableRenderer && typeof GeoLeaf._TableRenderer.updateSelection === \"function\") {\r\n                GeoLeaf._TableRenderer.updateSelection(this._container, this._selectedIds);\r\n            }\r\n\r\n            Log.debug(\"[Table] S√©lection effac√©e\");\r\n        },\r\n\r\n        /**\r\n         * Zoom sur les entit√©s s√©lectionn√©es\r\n         */\r\n        zoomToSelection() {\r\n            if (this._selectedIds.size === 0) {\r\n                Log.warn(\"[Table] Aucune entit√© s√©lectionn√©e pour le zoom\");\r\n                return;\r\n            }\r\n\r\n            const selectedFeatures = this._getSelectedFeatures();\r\n            if (selectedFeatures.length === 0) {\r\n                Log.warn(\"[Table] Aucune feature trouv√©e pour les IDs s√©lectionn√©s\");\r\n                return;\r\n            }\r\n\r\n            const bounds = L.latLngBounds([]);\r\n\r\n            selectedFeatures.forEach(feature => {\r\n                if (feature.geometry && feature.geometry.coordinates) {\r\n                    this._extendBoundsFromGeometry(bounds, feature.geometry);\r\n                }\r\n            });\r\n\r\n            if (bounds.isValid()) {\r\n                this._map.fitBounds(bounds, { padding: [50, 50], maxZoom: 16 });\r\n                this._fireEvent(\"table:zoomToSelection\", {\r\n                    layerId: this._currentLayerId,\r\n                    selectedIds: Array.from(this._selectedIds)\r\n                });\r\n                Log.debug(\"[Table] Zoom sur la s√©lection (\", selectedFeatures.length, \"entit√©s)\");\r\n            } else {\r\n                Log.warn(\"[Table] Bounds invalides pour la s√©lection\");\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Active/d√©sactive la surbrillance des entit√©s s√©lectionn√©es sur la carte\r\n         * @param {boolean} active - Activer ou non\r\n         */\r\n        highlightSelection(active) {\r\n            // Toujours nettoyer les anciennes surbrillances\r\n            this._clearHighlightLayers();\r\n\r\n            this._highlightActive = active;\r\n\r\n            if (!active) {\r\n                Log.debug(\"[Table] Surbrillance d√©sactiv√©e\");\r\n                this._fireEvent(\"table:highlightSelection\", {\r\n                    layerId: this._currentLayerId,\r\n                    selectedIds: Array.from(this._selectedIds),\r\n                    active: false\r\n                });\r\n                return;\r\n            }\r\n\r\n            if (this._selectedIds.size === 0) {\r\n                Log.warn(\"[Table] Aucune entit√© s√©lectionn√©e pour la surbrillance\");\r\n                return;\r\n            }\r\n\r\n            const selectedFeatures = this._getSelectedFeatures();\r\n            if (selectedFeatures.length === 0) {\r\n                Log.warn(\"[Table] Aucune feature trouv√©e pour la surbrillance\");\r\n                return;\r\n            }\r\n\r\n            // Style de surbrillance (contour jaune √©pais)\r\n            const highlightStyle = {\r\n                color: \"#FFD600\",\r\n                weight: 4,\r\n                opacity: 1,\r\n                fillOpacity: 0.15,\r\n                fillColor: \"#FFD600\",\r\n                dashArray: \"\",\r\n                interactive: false\r\n            };\r\n\r\n            selectedFeatures.forEach(feature => {\r\n                try {\r\n                    if (feature.geometry) {\r\n                        const geomType = feature.geometry.type;\r\n                        if (geomType === \"Point\") {\r\n                            // Pour les points, cr√©er un cercle de surbrillance\r\n                            const coords = feature.geometry.coordinates;\r\n                            const circle = L.circleMarker(\r\n                                [coords[1], coords[0]],\r\n                                {\r\n                                    radius: 14,\r\n                                    color: \"#FFD600\",\r\n                                    weight: 4,\r\n                                    opacity: 1,\r\n                                    fillOpacity: 0.25,\r\n                                    fillColor: \"#FFD600\",\r\n                                    interactive: false\r\n                                }\r\n                            );\r\n                            circle.addTo(this._map);\r\n                            this._highlightLayers.push(circle);\r\n                        } else {\r\n                            // Pour les polygones/polylines, superposer le contour\r\n                            const highlightLayer = L.geoJSON(feature, {\r\n                                style: function() { return highlightStyle; },\r\n                                interactive: false,\r\n                                pointToLayer: function(f, latlng) {\r\n                                    return L.circleMarker(latlng, highlightStyle);\r\n                                }\r\n                            });\r\n                            highlightLayer.addTo(this._map);\r\n                            this._highlightLayers.push(highlightLayer);\r\n                        }\r\n                    }\r\n                } catch (e) {\r\n                    Log.warn(\"[Table] Erreur surbrillance feature:\", e);\r\n                }\r\n            });\r\n\r\n            this._fireEvent(\"table:highlightSelection\", {\r\n                layerId: this._currentLayerId,\r\n                selectedIds: Array.from(this._selectedIds),\r\n                active: true\r\n            });\r\n\r\n            Log.debug(\"[Table] Surbrillance activ√©e pour\", selectedFeatures.length, \"entit√©s\");\r\n        },\r\n\r\n        /**\r\n         * Supprime toutes les couches de surbrillance de la carte\r\n         * @private\r\n         */\r\n        _clearHighlightLayers() {\r\n            this._highlightLayers.forEach(layer => {\r\n                try {\r\n                    if (this._map && this._map.hasLayer(layer)) {\r\n                        this._map.removeLayer(layer);\r\n                    }\r\n                } catch (e) {\r\n                    // Silencieux\r\n                }\r\n            });\r\n            this._highlightLayers = [];\r\n        },\r\n\r\n        /**\r\n         * Exporte les entit√©s s√©lectionn√©es au format GeoJSON (t√©l√©chargement)\r\n         */\r\n        exportSelection() {\r\n            if (this._selectedIds.size === 0) {\r\n                Log.warn(\"[Table] Aucune entit√© s√©lectionn√©e pour l'export\");\r\n                return;\r\n            }\r\n\r\n            const selectedFeatures = this._getSelectedFeatures();\r\n\r\n            if (selectedFeatures.length === 0) {\r\n                Log.warn(\"[Table] Aucune feature trouv√©e pour l'export\");\r\n                return;\r\n            }\r\n\r\n            // Construire le GeoJSON FeatureCollection\r\n            const geojson = {\r\n                type: \"FeatureCollection\",\r\n                features: selectedFeatures.map(f => ({\r\n                    type: \"Feature\",\r\n                    properties: f.properties || {},\r\n                    geometry: f.geometry || null\r\n                }))\r\n            };\r\n\r\n            // T√©l√©charger le fichier\r\n            try {\r\n                const json = JSON.stringify(geojson, null, 2);\r\n                const blob = new Blob([json], { type: \"application/geo+json\" });\r\n                const url = URL.createObjectURL(blob);\r\n                const a = document.createElement(\"a\");\r\n                a.href = url;\r\n                a.download = (this._currentLayerId || \"export\") + \"_selection.geojson\";\r\n                document.body.appendChild(a);\r\n                a.click();\r\n                document.body.removeChild(a);\r\n                URL.revokeObjectURL(url);\r\n\r\n                Log.info(\"[Table] Export GeoJSON:\", selectedFeatures.length, \"entit√©s export√©es\");\r\n            } catch (e) {\r\n                Log.error(\"[Table] Erreur lors de l'export:\", e);\r\n            }\r\n\r\n            this._fireEvent(\"table:exportSelection\", {\r\n                layerId: this._currentLayerId,\r\n                selectedIds: Array.from(this._selectedIds),\r\n                rows: selectedFeatures\r\n            });\r\n        },\r\n\r\n        /**\r\n         * R√©cup√®re les features s√©lectionn√©es √† partir du cache via le mapping d'IDs\r\n         * @returns {Array} Features GeoJSON correspondant √† la s√©lection\r\n         * @private\r\n         */\r\n        _getSelectedFeatures() {\r\n            const result = [];\r\n            this._selectedIds.forEach(id => {\r\n                const index = this._featureIdMap.get(id);\r\n                if (index != null && this._cachedData[index]) {\r\n                    result.push(this._cachedData[index]);\r\n                }\r\n            });\r\n            return result;\r\n        },\r\n\r\n        /**\r\n         * R√©sout l'ID d'une feature en miroir de la logique du renderer\r\n         * @param {Object} feature - Feature GeoJSON\r\n         * @param {number} syntheticIndex - Index pour les IDs synth√©tiques\r\n         * @returns {string}\r\n         * @private\r\n         */\r\n        _resolveFeatureId(feature, syntheticIndex) {\r\n            // 1. ID standard GeoJSON\r\n            if (feature.id != null && feature.id !== \"\") return String(feature.id);\r\n\r\n            const p = feature.properties;\r\n            if (!p) return \"__gl_row_\" + syntheticIndex;\r\n\r\n            // 2. Propri√©t√©s d'identifiant courantes (miroir exact du renderer)\r\n            if (p.id != null && p.id !== \"\") return String(p.id);\r\n            if (p.fid != null && p.fid !== \"\") return String(p.fid);\r\n            if (p.osm_id != null && p.osm_id !== \"\") return String(p.osm_id);\r\n            if (p.OBJECTID != null && p.OBJECTID !== \"\") return String(p.OBJECTID);\r\n            if (p.SITE_ID != null && p.SITE_ID !== \"\") return String(p.SITE_ID);\r\n            if (p.code != null && p.code !== \"\") return String(p.code);\r\n            if (p.IN1 != null && p.IN1 !== \"\") return String(p.IN1);\r\n\r\n            // 3. Fallback : ID synth√©tique (miroir du renderer)\r\n            return \"__gl_row_\" + syntheticIndex;\r\n        },\r\n\r\n        /**\r\n         * √âtend les bounds √† partir d'une g√©om√©trie GeoJSON\r\n         * @param {L.LatLngBounds} bounds - Bounds √† √©tendre\r\n         * @param {Object} geometry - G√©om√©trie GeoJSON\r\n         * @private\r\n         */\r\n        _extendBoundsFromGeometry(bounds, geometry) {\r\n            const coords = geometry.coordinates;\r\n            const type = geometry.type;\r\n\r\n            if (type === \"Point\") {\r\n                bounds.extend([coords[1], coords[0]]);\r\n            } else if (type === \"LineString\") {\r\n                coords.forEach(c => bounds.extend([c[1], c[0]]));\r\n            } else if (type === \"MultiLineString\") {\r\n                coords.forEach(line => line.forEach(c => bounds.extend([c[1], c[0]])));\r\n            } else if (type === \"Polygon\") {\r\n                coords[0].forEach(c => bounds.extend([c[1], c[0]]));\r\n            } else if (type === \"MultiPolygon\") {\r\n                coords.forEach(poly => {\r\n                    poly[0].forEach(c => bounds.extend([c[1], c[0]]));\r\n                });\r\n            } else if (type === \"MultiPoint\") {\r\n                coords.forEach(c => bounds.extend([c[1], c[0]]));\r\n            }\r\n        },\r\n\r\n        /**\r\n         * R√©cup√®re une valeur imbriqu√©e dans un objet\r\n         * @param {Object} obj - Objet source\r\n         * @param {string} path - Chemin avec notation point\r\n         * @returns {*}\r\n         * @private\r\n         */\r\n        _getNestedValue(obj, path) {\r\n            if (!obj || !path) return null;\r\n            return path.split('.').reduce((current, prop) =>\r\n                current && current[prop] !== undefined ? current[prop] : null, obj);\r\n        },\r\n\r\n        /**\r\n         * √âmet un √©v√©nement personnalis√©\r\n         * @param {string} eventName - Nom de l'√©v√©nement\r\n         * @param {Object} detail - Donn√©es de l'√©v√©nement\r\n         * @private\r\n         */\r\n        _fireEvent(eventName, detail) {\r\n            if (this._map && typeof this._map.fire === \"function\") {\r\n                this._map.fire(\"geoleaf:\" + eventName, detail);\r\n            }\r\n\r\n            if (typeof document !== \"undefined\" && document.dispatchEvent) {\r\n                document.dispatchEvent(new CustomEvent(\"geoleaf:\" + eventName, { detail }));\r\n            }\r\n        }\r\n    };\r\n\r\n    // Exposer le module\r\n    GeoLeaf.Table = TableModule;\r\n\r\n})(typeof window !== \"undefined\" ? window : global);\r\n","/**\r\n * API Module Manager - Sprint 4.3 (Version Robuste)\r\n * Gestionnaire centralis√© d'acc√®s aux modules GeoLeaf\r\n * @module APIModuleManager\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    const Log = GeoLeaf.Log || console;\r\n\r\n    /**\r\n     * Gestionnaire d'acc√®s aux modules GeoLeaf\r\n     */\r\n    class APIModuleManager {\r\n        constructor() {\r\n            this.modules = new Map();\r\n            this.aliases = new Map();\r\n            this.isInitialized = false;\r\n            this.stats = {\r\n                totalModules: 0,\r\n                accessCount: 0,\r\n                errors: 0\r\n            };\r\n        }\r\n\r\n        /**\r\n         * Initialise le gestionnaire avec les modules existants\r\n         * @returns {boolean} Succ√®s de l'initialisation\r\n         */\r\n        init() {\r\n            try {\r\n                if (this.isInitialized) {\r\n                    if (Log) Log.debug('[APIModuleManager] Already initialized');\r\n                    return true;\r\n                }\r\n\r\n                if (Log) Log.info('[APIModuleManager] Initializing module manager');\r\n\r\n                // Scanner tous les modules disponibles dans le namespace GeoLeaf\r\n                this._scanExistingModules();\r\n\r\n                // Configurer les alias pour compatibilit√©\r\n                this._setupAliases();\r\n\r\n                this.isInitialized = true;\r\n\r\n                if (Log) Log.info(`[APIModuleManager] Initialized with ${this.stats.totalModules} modules`);\r\n                return true;\r\n\r\n            } catch (error) {\r\n                this.stats.errors++;\r\n                if (Log) Log.error('[APIModuleManager] Initialization failed:', error);\r\n                return false;\r\n            }\r\n        }\r\n\r\n        /**\r\n         * Scanner les modules existants dans GeoLeaf\r\n         * @private\r\n         */\r\n        _scanExistingModules() {\r\n            if (!global.GeoLeaf) return;\r\n\r\n            const moduleList = [\r\n                'Core', 'UI', 'Config', 'Baselayers', 'BaseLayers',\r\n                'POI', 'GeoJSON', 'Route', 'Legend', 'LayerManager',\r\n                'Storage', 'Filters', 'Log', 'Security', 'Utils',\r\n                'Constants', 'Validators', 'Errors'\r\n            ];\r\n\r\n            moduleList.forEach(name => {\r\n                if (global.GeoLeaf[name]) {\r\n                    this.modules.set(name, global.GeoLeaf[name]);\r\n                    this.stats.totalModules++;\r\n                }\r\n            });\r\n\r\n            // Scanner les modules priv√©s (pr√©fixe _)\r\n            Object.keys(global.GeoLeaf).forEach(key => {\r\n                if (key.startsWith('_') && !this.modules.has(key)) {\r\n                    this.modules.set(key, global.GeoLeaf[key]);\r\n                    this.stats.totalModules++;\r\n                }\r\n            });\r\n        }\r\n\r\n        /**\r\n         * Configure les alias pour compatibilit√©\r\n         * @private\r\n         */\r\n        _setupAliases() {\r\n            const aliases = {\r\n                'Baselayers': 'BaseLayers',\r\n                'BaseLayers': 'Baselayers',\r\n                'Logger': 'Log',\r\n                'Log': 'Logger'\r\n            };\r\n\r\n            Object.entries(aliases).forEach(([alias, target]) => {\r\n                if (this.modules.has(target)) {\r\n                    this.aliases.set(alias, target);\r\n                }\r\n            });\r\n        }\r\n\r\n        /**\r\n         * Obtient un module par nom\r\n         * @param {string} name - Nom du module\r\n         * @returns {*} Module ou null si non trouv√©\r\n         */\r\n        getModule(name) {\r\n            try {\r\n                this.stats.accessCount++;\r\n\r\n                if (!name || typeof name !== 'string') {\r\n                    if (Log) Log.warn(`[APIModuleManager] Invalid module name:`, name);\r\n                    this.stats.errors++;\r\n                    return null;\r\n                }\r\n\r\n                // Recherche directe\r\n                if (this.modules.has(name)) {\r\n                    return this.modules.get(name);\r\n                }\r\n\r\n                // Recherche par alias\r\n                if (this.aliases.has(name)) {\r\n                    const targetName = this.aliases.get(name);\r\n                    return this.modules.get(targetName);\r\n                }\r\n\r\n                // Fallback vers acc√®s global direct\r\n                if (global.GeoLeaf && global.GeoLeaf[name]) {\r\n                    // Ajouter √† notre cache pour les prochains acc√®s\r\n                    this.modules.set(name, global.GeoLeaf[name]);\r\n                    this.stats.totalModules++;\r\n                    return global.GeoLeaf[name];\r\n                }\r\n\r\n                // Module non trouv√©\r\n                if (Log) Log.debug(`[APIModuleManager] Module '${name}' not found`);\r\n                return null;\r\n\r\n            } catch (error) {\r\n                this.stats.errors++;\r\n                if (Log) Log.error(`[APIModuleManager] Error accessing module '${name}':`, error);\r\n                return null;\r\n            }\r\n        }\r\n\r\n        /**\r\n         * Enregistre manuellement un module\r\n         * @param {string} name - Nom du module\r\n         * @param {*} module - Instance du module\r\n         */\r\n        registerModule(name, module) {\r\n            try {\r\n                if (!name || typeof name !== 'string') {\r\n                    throw new Error('Module name must be a non-empty string');\r\n                }\r\n\r\n                if (!module) {\r\n                    throw new Error('Module cannot be null or undefined');\r\n                }\r\n\r\n                this.modules.set(name, module);\r\n                this.stats.totalModules++;\r\n\r\n                if (Log) Log.debug(`[APIModuleManager] Module '${name}' registered`);\r\n                return true;\r\n\r\n            } catch (error) {\r\n                this.stats.errors++;\r\n                if (Log) Log.error(`[APIModuleManager] Failed to register module '${name}':`, error);\r\n                return false;\r\n            }\r\n        }\r\n\r\n        /**\r\n         * V√©rifie si un module existe\r\n         * @param {string} name - Nom du module\r\n         * @returns {boolean}\r\n         */\r\n        hasModule(name) {\r\n            try {\r\n                return this.modules.has(name) ||\r\n                       this.aliases.has(name) ||\r\n                       !!(global.GeoLeaf && global.GeoLeaf[name]);\r\n            } catch (error) {\r\n                if (Log) Log.error(`[APIModuleManager] Error checking module '${name}':`, error);\r\n                return false;\r\n            }\r\n        }\r\n\r\n        /**\r\n         * Obtient la liste des modules disponibles\r\n         * @returns {Array<string>}\r\n         */\r\n        getModuleList() {\r\n            const moduleNames = Array.from(this.modules.keys());\r\n\r\n            // Ajouter les modules du namespace global non encore dans notre cache\r\n            if (global.GeoLeaf) {\r\n                Object.keys(global.GeoLeaf).forEach(key => {\r\n                    if (!moduleNames.includes(key)) {\r\n                        moduleNames.push(key);\r\n                    }\r\n                });\r\n            }\r\n\r\n            return moduleNames.sort();\r\n        }\r\n\r\n        /**\r\n         * Obtient les statistiques d'usage\r\n         * @returns {Object}\r\n         */\r\n        getStats() {\r\n            return {\r\n                ...this.stats,\r\n                cachedModules: this.modules.size,\r\n                aliases: this.aliases.size,\r\n                isInitialized: this.isInitialized\r\n            };\r\n        }\r\n\r\n        /**\r\n         * Rafra√Æchit le cache des modules\r\n         */\r\n        refresh() {\r\n            if (Log) Log.info('[APIModuleManager] Refreshing module cache');\r\n\r\n            this.modules.clear();\r\n            this.aliases.clear();\r\n            this.stats.totalModules = 0;\r\n\r\n            this._scanExistingModules();\r\n            this._setupAliases();\r\n        }\r\n\r\n        /**\r\n         * R√©initialise le gestionnaire\r\n         */\r\n        reset() {\r\n            this.modules.clear();\r\n            this.aliases.clear();\r\n            this.isInitialized = false;\r\n            this.stats = {\r\n                totalModules: 0,\r\n                accessCount: 0,\r\n                errors: 0\r\n            };\r\n\r\n            if (Log) Log.info('[APIModuleManager] Manager reset');\r\n        }\r\n    }\r\n\r\n    // Export vers le namespace GeoLeaf\r\n    GeoLeaf.API = GeoLeaf.API || {};\r\n    GeoLeaf.API.APIModuleManager = APIModuleManager; // Nom correct pour controller\r\n    GeoLeaf.API.ModuleManager = APIModuleManager; // Alias pour compatibilit√©\r\n\r\n    if (Log) Log.info('[APIModuleManager] Module manager loaded (Sprint 4.3 - Robust)');\r\n\r\n})(window);\r\n","/**\r\n * API Initialization Manager - Sprint 4.3 (Version Robuste)\r\n * Gestionnaire des op√©rations d'initialisation GeoLeaf\r\n * @module APIInitializationManager\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    const Log = GeoLeaf.Log || console;\r\n\r\n    /**\r\n     * Gestionnaire d'initialisation pour GeoLeaf\r\n     */\r\n    class APIInitializationManager {\r\n        constructor() {\r\n            this.isReady = true; // Manager pr√™t sans init s√©par√©e\r\n            this.pendingPromise = null;\r\n            this.cancelled = false;\r\n            this.stats = {\r\n                initCalls: 0,\r\n                configLoads: 0,\r\n                errors: 0\r\n            };\r\n        }\r\n\r\n        /**\r\n         * Initialise GeoLeaf avec les options fournies\r\n         * @param {Object} options - Options d'initialisation\r\n         * @param {Function} getModule - Fonction d'acc√®s aux modules\r\n         * @returns {*} R√©sultat de l'initialisation\r\n         */\r\n        init(options, getModule) {\r\n            try {\r\n                this.stats.initCalls++;\r\n\r\n                if (Log) Log.info('[APIInitializationManager] Initializing GeoLeaf');\r\n\r\n                // Validation des param√®tres\r\n                const validationResult = this._validateInitParams(options, getModule);\r\n                if (!validationResult.valid) {\r\n                    throw new Error(validationResult.error);\r\n                }\r\n\r\n                // Obtenir le module Core\r\n                const Core = getModule(\"Core\");\r\n                if (!Core || typeof Core.init !== \"function\") {\r\n                    throw new Error(\"[GeoLeaf.init] GeoLeaf.Core.init() is not available. Core module must be loaded before API.\");\r\n                }\r\n\r\n                // Normaliser les options\r\n                const normalizedOptions = this._normalizeInitOptions(options);\r\n                if (Log) Log.info('[APIInitializationManager] Initializing with options:', normalizedOptions);\r\n\r\n                // Appeler l'initialisation du Core\r\n                const result = Core.init(normalizedOptions);\r\n\r\n                if (Log) Log.info('[APIInitializationManager] Initialization completed successfully');\r\n                return result;\r\n\r\n            } catch (error) {\r\n                this.stats.errors++;\r\n                if (Log) Log.error('[APIInitializationManager] Initialization failed:', error);\r\n                throw error;\r\n            }\r\n        }\r\n\r\n        /**\r\n         * Charge une configuration depuis URL ou donn√©es\r\n         * @param {string|Object} input - Source de configuration\r\n         * @param {Function} getModule - Fonction d'acc√®s aux modules\r\n         * @returns {Promise<Object>} Donn√©es de configuration\r\n         */\r\n        async loadConfig(input, getModule) {\r\n            try {\r\n                this.stats.configLoads++;\r\n\r\n                if (Log) Log.info('[APIInitializationManager] Loading configuration');\r\n\r\n                // Validation des param√®tres\r\n                if (!input) {\r\n                    throw new Error('Configuration input is required');\r\n                }\r\n\r\n                if (!getModule || typeof getModule !== 'function') {\r\n                    throw new Error('getModule function is required');\r\n                }\r\n\r\n                // Obtenir le module Config\r\n                const Config = getModule(\"Config\");\r\n                if (!Config || typeof Config.init !== \"function\") {\r\n                    throw new Error(\"[GeoLeaf.loadConfig] GeoLeaf.Config.init() is not available. Config module must be loaded.\");\r\n                }\r\n\r\n                // Normaliser les options de configuration\r\n                const options = this._normalizeConfigOptions(input);\r\n\r\n                // Annuler la requ√™te pr√©c√©dente si elle existe\r\n                if (this.pendingPromise) {\r\n                    this.cancelled = true;\r\n                    if (Log) Log.info('[APIInitializationManager] Cancelling previous config load request');\r\n                }\r\n\r\n                this.cancelled = false;\r\n\r\n                // Charger la configuration\r\n                this.pendingPromise = Config.init(options);\r\n                const result = await this.pendingPromise;\r\n\r\n                this.pendingPromise = null;\r\n\r\n                if (this.cancelled) {\r\n                    if (Log) Log.info('[APIInitializationManager] Config load was cancelled');\r\n                    return null;\r\n                }\r\n\r\n                if (Log) Log.info('[APIInitializationManager] Configuration loaded successfully');\r\n                return result;\r\n\r\n            } catch (error) {\r\n                this.stats.errors++;\r\n                this.pendingPromise = null;\r\n                if (Log) Log.error('[APIInitializationManager] Config loading failed:', error);\r\n                throw error;\r\n            }\r\n        }\r\n\r\n        /**\r\n         * Change le th√®me de l'interface\r\n         * @param {string} theme - Nom du th√®me\r\n         * @param {Function} getModule - Fonction d'acc√®s aux modules\r\n         * @returns {boolean} Succ√®s du changement\r\n         */\r\n        setTheme(theme, getModule) {\r\n            try {\r\n                if (Log) Log.info(`[APIInitializationManager] Setting theme: ${theme}`);\r\n\r\n                // Validation\r\n                if (!theme || typeof theme !== 'string') {\r\n                    throw new Error('Theme name must be a non-empty string');\r\n                }\r\n\r\n                if (!getModule || typeof getModule !== 'function') {\r\n                    throw new Error('getModule function is required');\r\n                }\r\n\r\n                // Obtenir le module UI\r\n                const UI = getModule(\"UI\");\r\n                if (!UI) {\r\n                    throw new Error(\"[GeoLeaf.setTheme] GeoLeaf.UI is not available. UI module must be loaded.\");\r\n                }\r\n\r\n                // Appliquer le th√®me - utilise applyTheme comme dans geoleaf.ui.js\r\n                let result = false;\r\n                if (typeof UI.applyTheme === 'function') {\r\n                    result = UI.applyTheme(theme);\r\n                } else if (typeof UI.setTheme === 'function') {\r\n                    result = UI.setTheme(theme);\r\n                } else if (typeof UI.theme === 'function') {\r\n                    result = UI.theme(theme);\r\n                } else {\r\n                    throw new Error('UI module does not provide applyTheme, setTheme or theme method');\r\n                }\r\n\r\n                if (Log) Log.info(`[APIInitializationManager] Theme '${theme}' applied successfully`);\r\n                return result;\r\n\r\n            } catch (error) {\r\n                this.stats.errors++;\r\n                if (Log) Log.error(`[APIInitializationManager] Failed to set theme '${theme}':`, error);\r\n                return false;\r\n            }\r\n        }\r\n\r\n        /**\r\n         * Valide les param√®tres d'initialisation\r\n         * @private\r\n         */\r\n        _validateInitParams(options, getModule) {\r\n            if (!options || typeof options !== \"object\") {\r\n                return { valid: false, error: \"[GeoLeaf.init] An options object is required.\" };\r\n            }\r\n\r\n            if (!getModule || typeof getModule !== 'function') {\r\n                return { valid: false, error: \"getModule function is required\" };\r\n            }\r\n\r\n            return { valid: true };\r\n        }\r\n\r\n        /**\r\n         * Normalise les options d'initialisation\r\n         * @private\r\n         */\r\n        _normalizeInitOptions(options) {\r\n            // Mode \"structur√©\" (recommand√©) : options.map / options.ui\r\n            let mapOpts = options.map || {};\r\n            let uiOpts = options.ui || {};\r\n\r\n            // Mode \"aplati\" (legacy) : target/mapId / center / zoom / theme √† la racine\r\n            if (!options.map) {\r\n                mapOpts = {\r\n                    target: options.target || options.mapId,\r\n                    center: options.center,\r\n                    zoom: options.zoom\r\n                };\r\n                uiOpts = {\r\n                    theme: options.theme\r\n                };\r\n            }\r\n\r\n            // Validation du target\r\n            const target = mapOpts.target || mapOpts.mapId;\r\n            if (!target) {\r\n                throw new Error(\"[GeoLeaf.init] The 'map.target' (or 'target'/'mapId') option is required.\");\r\n            }\r\n\r\n            // R√©cup√©rer les constantes par d√©faut\r\n            const CONSTANTS = global.GeoLeaf.CONSTANTS || {};\r\n            const center = Array.isArray(mapOpts.center) ? mapOpts.center : CONSTANTS.DEFAULT_CENTER || [0, 0];\r\n            const zoom = Number.isFinite(mapOpts.zoom) ? mapOpts.zoom : CONSTANTS.DEFAULT_ZOOM || 12;\r\n            const theme = uiOpts.theme || mapOpts.theme || \"light\";\r\n\r\n            // Adapter √† la signature Core.init\r\n            return {\r\n                mapId: String(target), // Core.init attend 'mapId' pas 'target'\r\n                center,\r\n                zoom,\r\n                theme\r\n            };\r\n        }\r\n\r\n        /**\r\n         * Normalise les options de configuration\r\n         * @private\r\n         */\r\n        _normalizeConfigOptions(input) {\r\n            if (typeof input === 'string') {\r\n                // URL string\r\n                return {\r\n                    source: 'url',\r\n                    url: input,\r\n                    autoEvent: true\r\n                };\r\n            } else if (input && typeof input === 'object') {\r\n                // Configuration object\r\n                return {\r\n                    source: input.url ? 'url' : 'data',\r\n                    url: input.url,\r\n                    data: input.data,\r\n                    profileId: input.profileId,\r\n                    autoEvent: input.autoEvent !== false, // true par d√©faut\r\n                    ...input\r\n                };\r\n            } else {\r\n                throw new Error('Configuration input must be a URL string or options object');\r\n            }\r\n        }\r\n\r\n        /**\r\n         * Obtient les statistiques du manager\r\n         * @returns {Object}\r\n         */\r\n        getStats() {\r\n            return {\r\n                ...this.stats,\r\n                isReady: this.isReady,\r\n                hasPendingRequest: !!this.pendingPromise\r\n            };\r\n        }\r\n\r\n        /**\r\n         * R√©initialise le manager\r\n         */\r\n        reset() {\r\n            if (this.pendingPromise) {\r\n                this.cancelled = true;\r\n            }\r\n\r\n            this.pendingPromise = null;\r\n            this.cancelled = false;\r\n            this.stats = {\r\n                initCalls: 0,\r\n                configLoads: 0,\r\n                errors: 0\r\n            };\r\n\r\n            if (Log) Log.info('[APIInitializationManager] Manager reset');\r\n        }\r\n    }\r\n\r\n    // Export vers le namespace GeoLeaf\r\n    GeoLeaf.API = GeoLeaf.API || {};\r\n    GeoLeaf.API.APIInitializationManager = APIInitializationManager; // Nom correct pour controller\r\n    GeoLeaf.API.InitializationManager = APIInitializationManager; // Alias pour compatibilit√©\r\n\r\n    if (Log) Log.info('[APIInitializationManager] Initialization manager loaded (Sprint 4.3 - Robust)');\r\n\r\n})(window);\r\n","/**\r\n * API Namespace Manager - Sprint 4.3 (Version Robuste)\r\n * Gestionnaire des op√©rations sur les namespaces GeoLeaf\r\n * @module APINamespaceManager\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    const Log = GeoLeaf.Log || console;\r\n\r\n    /**\r\n     * Gestionnaire des namespaces GeoLeaf\r\n     */\r\n    class APINamespaceManager {\r\n        constructor() {\r\n            this.isReady = true;\r\n            this.stats = {\r\n                operations: 0,\r\n                errors: 0\r\n            };\r\n        }\r\n\r\n        /**\r\n         * Initialise le gestionnaire avec la fonction d'acc√®s aux modules\r\n         * @param {Function} getModule - Fonction d'acc√®s aux modules\r\n         * @returns {boolean} Succ√®s\r\n         */\r\n        init(getModule) {\r\n            try {\r\n                if (!getModule || typeof getModule !== 'function') {\r\n                    throw new Error('getModule function is required');\r\n                }\r\n\r\n                this.getModule = getModule;\r\n\r\n                if (Log) Log.info('[APINamespaceManager] Namespace manager initialized');\r\n                return true;\r\n\r\n            } catch (error) {\r\n                this.stats.errors++;\r\n                if (Log) Log.error('[APINamespaceManager] Initialization failed:', error);\r\n                return false;\r\n            }\r\n        }\r\n\r\n        /**\r\n         * Obtient les statistiques\r\n         */\r\n        getStats() {\r\n            return {\r\n                ...this.stats,\r\n                isReady: this.isReady\r\n            };\r\n        }\r\n\r\n        /**\r\n         * R√©initialise le gestionnaire\r\n         */\r\n        reset() {\r\n            this.getModule = null;\r\n            this.stats = {\r\n                operations: 0,\r\n                errors: 0\r\n            };\r\n\r\n            if (Log) Log.info('[APINamespaceManager] Manager reset');\r\n        }\r\n    }\r\n\r\n    // Export vers le namespace GeoLeaf\r\n    GeoLeaf.API = GeoLeaf.API || {};\r\n    GeoLeaf.API.APINamespaceManager = APINamespaceManager; // Nom correct pour controller\r\n    GeoLeaf.API.NamespaceManager = APINamespaceManager; // Alias pour compatibilit√©\r\n\r\n    if (Log) Log.info('[APINamespaceManager] Namespace manager loaded (Sprint 4.3 - Robust)');\r\n\r\n})(window);\r\n","/**\r\n * API Factory Manager - Sprint 4.3 (Version Robuste)\r\n * Gestionnaire pour la cr√©ation d'instances multi-cartes\r\n * @module APIFactoryManager\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    const Log = GeoLeaf.Log || console;\r\n\r\n    /**\r\n     * Gestionnaire de factory pour multi-cartes\r\n     */\r\n    class APIFactoryManager {\r\n        constructor() {\r\n            this.isReady = true;\r\n            this.mapInstances = new Map();\r\n            this.stats = {\r\n                mapsCreated: 0,\r\n                errors: 0\r\n            };\r\n        }\r\n\r\n        /**\r\n         * Initialise le gestionnaire avec la fonction d'acc√®s aux modules\r\n         * @param {Function} getModule - Fonction d'acc√®s aux modules\r\n         * @returns {boolean} Succ√®s\r\n         */\r\n        init(getModule) {\r\n            try {\r\n                if (!getModule || typeof getModule !== 'function') {\r\n                    throw new Error('getModule function is required');\r\n                }\r\n\r\n                this.getModule = getModule;\r\n\r\n                if (Log) Log.info('[APIFactoryManager] Factory manager initialized');\r\n                return true;\r\n\r\n            } catch (error) {\r\n                this.stats.errors++;\r\n                if (Log) Log.error('[APIFactoryManager] Initialization failed:', error);\r\n                return false;\r\n            }\r\n        }\r\n\r\n        /**\r\n         * Cr√©e une nouvelle instance de carte\r\n         * @param {string} targetId - ID de l'√©l√©ment cible\r\n         * @param {Object} options - Options de configuration\r\n         * @param {Function} getModule - Fonction d'acc√®s aux modules\r\n         * @returns {*} Instance de carte ou null\r\n         */\r\n        createMap(targetId, options, getModule) {\r\n            try {\r\n                this.stats.mapsCreated++;\r\n\r\n                if (!targetId) {\r\n                    throw new Error('Target ID is required');\r\n                }\r\n\r\n                const Core = getModule('Core');\r\n                if (!Core || typeof Core.init !== 'function') {\r\n                    throw new Error('Core module not available for map creation');\r\n                }\r\n\r\n                // Cr√©er la carte avec les options fournies\r\n                const mapOptions = {\r\n                    target: targetId,\r\n                    ...options\r\n                };\r\n\r\n                const mapInstance = Core.init(mapOptions);\r\n\r\n                if (mapInstance) {\r\n                    this.mapInstances.set(targetId, mapInstance);\r\n                    if (Log) Log.info(`[APIFactoryManager] Map created for target: ${targetId}`);\r\n                }\r\n\r\n                return mapInstance;\r\n\r\n            } catch (error) {\r\n                this.stats.errors++;\r\n                if (Log) Log.error(`[APIFactoryManager] Failed to create map for ${targetId}:`, error);\r\n                return null;\r\n            }\r\n        }\r\n\r\n        /**\r\n         * Obtient une instance de carte par ID\r\n         * @param {string} targetId - ID de l'√©l√©ment cible\r\n         * @returns {*} Instance de carte ou null\r\n         */\r\n        getMapInstance(targetId) {\r\n            return this.mapInstances.get(targetId) || null;\r\n        }\r\n\r\n        /**\r\n         * Obtient toutes les instances de carte\r\n         * @returns {Array} Liste des instances\r\n         */\r\n        getAllMapInstances() {\r\n            return Array.from(this.mapInstances.values());\r\n        }\r\n\r\n        /**\r\n         * Obtient les statistiques\r\n         */\r\n        getStats() {\r\n            return {\r\n                ...this.stats,\r\n                activeInstances: this.mapInstances.size,\r\n                isReady: this.isReady\r\n            };\r\n        }\r\n\r\n        /**\r\n         * R√©initialise le gestionnaire\r\n         */\r\n        reset() {\r\n            this.mapInstances.clear();\r\n            this.getModule = null;\r\n            this.stats = {\r\n                mapsCreated: 0,\r\n                errors: 0\r\n            };\r\n\r\n            if (Log) Log.info('[APIFactoryManager] Manager reset');\r\n        }\r\n    }\r\n\r\n    // Export vers le namespace GeoLeaf\r\n    GeoLeaf.API = GeoLeaf.API || {};\r\n    GeoLeaf.API.APIFactoryManager = APIFactoryManager; // Nom correct pour controller\r\n    GeoLeaf.API.FactoryManager = APIFactoryManager; // Alias pour compatibilit√©\r\n\r\n    if (Log) Log.info('[APIFactoryManager] Factory manager loaded (Sprint 4.3 - Robust)');\r\n\r\n})(window);\r\n","/**\r\n * API Controller - Sprint 4.3 (Version Robuste)\r\n * Orchestrateur principal pour les op√©rations API GeoLeaf\r\n * Architecture modulaire avec validation renforc√©e\r\n * @module APIController\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    const Log = GeoLeaf.Log || console;\r\n\r\n    /**\r\n     * Contr√¥leur principal pour l'API GeoLeaf\r\n     * G√®re l'orchestration des managers sp√©cialis√©s\r\n     */\r\n    class APIController {\r\n        constructor() {\r\n            this.isInitialized = false;\r\n            this.managers = {};\r\n            this.moduleAccessFn = null;\r\n\r\n            // √âtat de sanit√© du contr√¥leur\r\n            this.healthStatus = {\r\n                managers: 0,\r\n                errors: [],\r\n                lastUpdate: null\r\n            };\r\n        }\r\n\r\n        /**\r\n         * Initialise le contr√¥leur et tous ses managers\r\n         * @returns {boolean} Succ√®s de l'initialisation\r\n         */\r\n        init() {\r\n            try {\r\n                if (this.isInitialized) {\r\n                    if (Log) Log.debug('[APIController] Already initialized');\r\n                    return true;\r\n                }\r\n\r\n                if (Log) Log.info('[APIController] Initializing API controller (Sprint 4.3 - Robust)');\r\n\r\n                // Initialiser les managers dans l'ordre\r\n                this._initializeManagers();\r\n\r\n                // Configurer l'acc√®s aux modules\r\n                const success = this._setupModuleAccess();\r\n                if (!success) {\r\n                    throw new Error('Module access setup failed');\r\n                }\r\n\r\n                // Valider l'√©tat final\r\n                this._validateInitialization();\r\n\r\n                this.isInitialized = true;\r\n                this.healthStatus.lastUpdate = new Date().toISOString();\r\n\r\n                if (Log) Log.info('[APIController] API controller initialized successfully');\r\n                return true;\r\n\r\n            } catch (error) {\r\n                this.healthStatus.errors.push({\r\n                    message: error.message,\r\n                    timestamp: new Date().toISOString(),\r\n                    stack: error.stack\r\n                });\r\n\r\n                if (Log) Log.error('[APIController] Initialization failed:', error);\r\n                return false;\r\n            }\r\n        }\r\n\r\n        /**\r\n         * Initialise tous les managers disponibles\r\n         * @private\r\n         */\r\n        _initializeManagers() {\r\n            const managerTypes = ['module', 'initialization', 'namespace', 'factory'];\r\n\r\n            managerTypes.forEach(type => {\r\n                const ManagerClass = this._getManagerClass(type);\r\n                if (ManagerClass) {\r\n                    try {\r\n                        this.managers[type] = new ManagerClass();\r\n                        this.healthStatus.managers++;\r\n                        if (Log) Log.debug(`[APIController] ${type} manager loaded`);\r\n                    } catch (error) {\r\n                        if (Log) Log.warn(`[APIController] Failed to load ${type} manager:`, error);\r\n                        this.healthStatus.errors.push({\r\n                            manager: type,\r\n                            error: error.message\r\n                        });\r\n                    }\r\n                }\r\n            });\r\n\r\n            if (Log) Log.info(`[APIController] Loaded ${this.healthStatus.managers} managers`);\r\n        }\r\n\r\n        /**\r\n         * Obtient la classe d'un manager\r\n         * @private\r\n         */\r\n        _getManagerClass(type) {\r\n            const classNames = {\r\n                module: 'APIModuleManager',\r\n                initialization: 'APIInitializationManager',\r\n                namespace: 'APINamespaceManager',\r\n                factory: 'APIFactoryManager'\r\n            };\r\n\r\n            const className = classNames[type];\r\n            return GeoLeaf.API && GeoLeaf.API[className] ? GeoLeaf.API[className] : null;\r\n        }\r\n\r\n        /**\r\n         * Configure l'acc√®s aux modules\r\n         * @private\r\n         */\r\n        _setupModuleAccess() {\r\n            // Le module manager doit √™tre initialis√© en premier\r\n            if (!this.managers.module) {\r\n                if (Log) Log.error('[APIController] Module manager not available');\r\n                return false;\r\n            }\r\n\r\n            // Initialiser le module manager avec les modules existants\r\n            const initSuccess = this.managers.module.init ? this.managers.module.init() : true;\r\n            if (!initSuccess) {\r\n                if (Log) Log.error('[APIController] Module manager initialization failed');\r\n                return false;\r\n            }\r\n\r\n            // Cr√©er la fonction d'acc√®s aux modules avec validation\r\n            this.moduleAccessFn = (name) => {\r\n                try {\r\n                    if (!name || typeof name !== 'string') {\r\n                        if (Log) Log.warn('[APIController] Invalid module name:', name);\r\n                        return null;\r\n                    }\r\n\r\n                    if (this.managers.module && typeof this.managers.module.getModule === 'function') {\r\n                        return this.managers.module.getModule(name);\r\n                    }\r\n\r\n                    // Fallback vers l'acc√®s global\r\n                    if (global.GeoLeaf && global.GeoLeaf[name]) {\r\n                        return global.GeoLeaf[name];\r\n                    }\r\n\r\n                    return null;\r\n                } catch (error) {\r\n                    if (Log) Log.warn(`[APIController] Error accessing module ${name}:`, error);\r\n                    return null;\r\n                }\r\n            };\r\n\r\n            if (Log) Log.info('[APIController] Module access configured');\r\n            return true;\r\n        }\r\n\r\n        /**\r\n         * Valide l'√©tat de l'initialisation\r\n         * @private\r\n         */\r\n        _validateInitialization() {\r\n            const checks = [\r\n                { name: 'moduleAccessFn', value: this.moduleAccessFn, type: 'function' },\r\n                { name: 'managers', value: this.managers, type: 'object' },\r\n                { name: 'moduleManager', value: this.managers.module, type: 'object' }\r\n            ];\r\n\r\n            const failures = checks.filter(check => {\r\n                return !check.value || typeof check.value !== check.type;\r\n            });\r\n\r\n            if (failures.length > 0) {\r\n                const failureNames = failures.map(f => f.name).join(', ');\r\n                throw new Error(`Validation failed for: ${failureNames}`);\r\n            }\r\n\r\n            if (Log) Log.debug('[APIController] Validation passed');\r\n        }\r\n\r\n        /**\r\n         * GeoLeaf.init() - Initialisation de carte\r\n         */\r\n        geoleafInit(options) {\r\n            if (!this._ensureInitialized()) return null;\r\n\r\n            try {\r\n                if (!this.managers.initialization) {\r\n                    throw new Error('Initialization manager not available');\r\n                }\r\n\r\n                return this.managers.initialization.init(options, this.moduleAccessFn);\r\n            } catch (error) {\r\n                if (Log) Log.error('[APIController] geoleafInit failed:', error);\r\n                return null;\r\n            }\r\n        }\r\n\r\n        /**\r\n         * GeoLeaf.loadConfig() - Chargement configuration\r\n         */\r\n        geoleafLoadConfig(input) {\r\n            if (!this._ensureInitialized()) return Promise.resolve(null);\r\n\r\n            try {\r\n                if (!this.managers.initialization) {\r\n                    throw new Error('Initialization manager not available');\r\n                }\r\n\r\n                return this.managers.initialization.loadConfig(input, this.moduleAccessFn);\r\n            } catch (error) {\r\n                if (Log) Log.error('[APIController] geoleafLoadConfig failed:', error);\r\n                return Promise.resolve(null);\r\n            }\r\n        }\r\n\r\n        /**\r\n         * GeoLeaf.setTheme() - Changement de th√®me\r\n         */\r\n        geoleafSetTheme(theme) {\r\n            if (!this._ensureInitialized()) return false;\r\n\r\n            try {\r\n                if (!this.managers.initialization) {\r\n                    throw new Error('Initialization manager not available');\r\n                }\r\n\r\n                return this.managers.initialization.setTheme(theme, this.moduleAccessFn);\r\n            } catch (error) {\r\n                if (Log) Log.error('[APIController] geoleafSetTheme failed:', error);\r\n                return false;\r\n            }\r\n        }\r\n\r\n        /**\r\n         * GeoLeaf.createMap() - Cr√©ation multi-cartes\r\n         */\r\n        geoleafCreateMap(targetId, options) {\r\n            if (!this._ensureInitialized()) return null;\r\n\r\n            try {\r\n                if (!this.managers.factory) {\r\n                    throw new Error('Factory manager not available');\r\n                }\r\n\r\n                return this.managers.factory.createMap(targetId, options, this.moduleAccessFn);\r\n            } catch (error) {\r\n                if (Log) Log.error('[APIController] geoleafCreateMap failed:', error);\r\n                return null;\r\n            }\r\n        }\r\n\r\n        /**\r\n         * S'assure que le contr√¥leur est initialis√©\r\n         * @private\r\n         */\r\n        _ensureInitialized() {\r\n            if (!this.isInitialized) {\r\n                if (Log) Log.error('[APIController] Controller not initialized');\r\n                return false;\r\n            }\r\n            return true;\r\n        }\r\n\r\n        /**\r\n         * Obtient l'√©tat de sant√© du contr√¥leur\r\n         */\r\n        getHealthStatus() {\r\n            return {\r\n                ...this.healthStatus,\r\n                isInitialized: this.isInitialized,\r\n                managersCount: Object.keys(this.managers).length,\r\n                hasModuleAccess: !!this.moduleAccessFn\r\n            };\r\n        }\r\n\r\n        /**\r\n         * R√©initialise le contr√¥leur\r\n         */\r\n        reset() {\r\n            this.isInitialized = false;\r\n            this.managers = {};\r\n            this.moduleAccessFn = null;\r\n            this.healthStatus = {\r\n                managers: 0,\r\n                errors: [],\r\n                lastUpdate: null\r\n            };\r\n\r\n            if (Log) Log.info('[APIController] Controller reset');\r\n        }\r\n    }\r\n\r\n    // Export vers le namespace GeoLeaf\r\n    GeoLeaf.API = GeoLeaf.API || {};\r\n    GeoLeaf.API.Controller = APIController;\r\n\r\n    // Cr√©er et exposer une instance globale _APIController\r\n    if (!GeoLeaf._APIController) {\r\n        const controllerInstance = new APIController();\r\n\r\n        // Tentative d'initialisation automatique\r\n        const initSuccess = controllerInstance.init();\r\n        if (initSuccess) {\r\n            GeoLeaf._APIController = controllerInstance;\r\n            if (Log) Log.info('[APIController] Global instance created and initialized successfully');\r\n        } else {\r\n            if (Log) Log.warn('[APIController] Failed to auto-initialize - will try manual init later');\r\n            GeoLeaf._APIController = controllerInstance; // Exposer quand m√™me pour debug\r\n        }\r\n    }\r\n\r\n    if (Log) Log.info('[APIController] Controller class loaded (Sprint 4.3 - Robust)');\r\n\r\n})(window);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n/*!\r\n * GeoLeaf ‚Äì API publique unifi√©e\r\n * Point d'entr√©e pour futurs bundles (CDN / UMD / ESM)\r\n * Phase 4.3 ‚Äî Architecture Controller refactoris√©e robuste\r\n */\r\n/* global define */\r\n(function (root, factory) {\r\n    \"use strict\";\r\n\r\n    // UMD minimal : AMD, CommonJS, global\r\n    if (typeof define === \"function\" && define.amd) {\r\n        define([], function () {\r\n            return factory(root);\r\n        });\r\n    } else if (typeof module === \"object\" && module.exports) {\r\n        module.exports = factory(root);\r\n    } else {\r\n        root.GeoLeaf = factory(root);\r\n    }\r\n}(typeof self !== \"undefined\" ? self : this, function (root) {\r\n    \"use strict\";\r\n\r\n    // ---------------------------------------------------------------------\r\n    // Architecture Controller - D√©l√©gation robuste vers APIController\r\n    // ---------------------------------------------------------------------\r\n\r\n    // R√©cup√©ration de l'√©ventuel GeoLeaf d√©j√† attach√© par les modules\r\n    const existing = root.GeoLeaf || {};\r\n\r\n    // Logger unifi√© (d√©fini par geoleaf.logger-shim.js)\r\n    const Log = existing.Log;\r\n\r\n    // V√©rification de la disponibilit√© d'APIController\r\n    const APIController = existing._APIController;\r\n\r\n    if (!APIController) {\r\n        Log.error(\"[GeoLeaf.API] APIController non disponible. Les modules API Controller doivent √™tre charg√©s avant geoleaf.api.js\");\r\n        throw new Error(\"APIController manquant - v√©rifiez que les modules API sont charg√©s\");\r\n    }\r\n\r\n    // Validation de l'√©tat de l'APIController\r\n    if (!APIController.isInitialized) {\r\n        Log.error(\"[GeoLeaf.API] APIController en √©tat d√©faillant. V√©rification de l'√©tat :\", APIController.getHealthStatus());\r\n        throw new Error(\"APIController en √©tat d√©faillant\");\r\n    }\r\n\r\n    // ---------------------------------------------------------------------\r\n    // API publique d√©l√©gu√©e vers APIController\r\n    // ---------------------------------------------------------------------\r\n\r\n    /**\r\n     * GeoLeaf.init(options) - Initialisation compl√®te\r\n     * D√©l√®gue vers APIController.geoleafInit()\r\n     */\r\n    function geoleafInit(options) {\r\n        try {\r\n            return APIController.geoleafInit(options);\r\n        } catch (error) {\r\n            Log.error(\"[GeoLeaf.init] Erreur lors de l'initialisation :\", error);\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * GeoLeaf.setTheme(theme) - Application de th√®me\r\n     * D√©l√®gue vers APIController.geoleafSetTheme()\r\n     */\r\n    function geoleafSetTheme(theme) {\r\n        try {\r\n            return APIController.geoleafSetTheme(theme);\r\n        } catch (error) {\r\n            Log.error(\"[GeoLeaf.setTheme] Erreur lors de l'application du th√®me :\", error);\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * GeoLeaf.loadConfig(input) - Chargement de configuration\r\n     * D√©l√®gue vers APIController.geoleafLoadConfig()\r\n     */\r\n    function geoleafLoadConfig(input) {\r\n        try {\r\n            return APIController.geoleafLoadConfig(input);\r\n        } catch (error) {\r\n            Log.error(\"[GeoLeaf.loadConfig] Erreur lors du chargement de configuration :\", error);\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    // ---------------------------------------------------------------------\r\n    // Constantes et utilitaires\r\n    // ---------------------------------------------------------------------\r\n\r\n    const CONSTANTS = {\r\n        VERSION: \"4.3.0-robust\",\r\n        DEFAULT_CENTER: [0, 0],\r\n        DEFAULT_ZOOM: 3,\r\n        THEMES: [\"light\", \"dark\", \"satellite\", \"custom\"]\r\n    };\r\n\r\n    // ---------------------------------------------------------------------\r\n    // Construction de l'API finale\r\n    // ---------------------------------------------------------------------\r\n\r\n    const GeoLeaf = Object.assign(existing, {\r\n        // M√©thodes principales\r\n        init: geoleafInit,\r\n        setTheme: geoleafSetTheme,\r\n        loadConfig: geoleafLoadConfig,\r\n\r\n        // Constantes\r\n        CONSTANTS,\r\n\r\n        // Acc√®s aux modules via APIController\r\n        getModule: function(name) {\r\n            return APIController.moduleAccessFn ? APIController.moduleAccessFn(name) : null;\r\n        },\r\n\r\n        hasModule: function(name) {\r\n            const module = APIController.moduleAccessFn ? APIController.moduleAccessFn(name) : null;\r\n            return !!module;\r\n        },\r\n\r\n        // Acc√®s aux namespaces via APIController\r\n        getNamespace: function(name) {\r\n            return APIController.managers && APIController.managers.namespace ?\r\n                APIController.managers.namespace.get(name) : null;\r\n        },\r\n\r\n        // Gestion des instances de cartes via APIController\r\n        createMap: function(id, options) {\r\n            return APIController.geoleafCreateMap ? APIController.geoleafCreateMap(id, options) : null;\r\n        },\r\n\r\n        getMap: function(id) {\r\n            return APIController.managers && APIController.managers.factory ?\r\n                APIController.managers.factory.get(id) : null;\r\n        },\r\n\r\n        getAllMaps: function() {\r\n            return APIController.managers && APIController.managers.factory ?\r\n                APIController.managers.factory.getAll() : {};\r\n        },\r\n\r\n        removeMap: function(id) {\r\n            return APIController.managers && APIController.managers.factory ?\r\n                APIController.managers.factory.remove(id) : false;\r\n        },\r\n\r\n        // M√©triques et monitoring\r\n        getHealth: function() {\r\n            return APIController.getHealthStatus ? APIController.getHealthStatus() : null;\r\n        },\r\n\r\n        getMetrics: function() {\r\n            return APIController.getHealthStatus ? APIController.getHealthStatus() : null;\r\n        },\r\n\r\n        // Acc√®s interne pour modules (ne pas utiliser publiquement)\r\n        _APIController: APIController\r\n    });\r\n\r\n    // Log de l'initialisation r√©ussie\r\n    if (Log) {\r\n        Log.info(`[GeoLeaf.API] API publique v${CONSTANTS.VERSION} initialis√©e avec succ√®s`);\r\n        Log.info(`[GeoLeaf.API] Sant√© APIController :`, APIController.getHealthStatus());\r\n    }\r\n\r\n    return GeoLeaf;\r\n}));\r\n","/*!\r\n * GeoLeaf Core ‚Äì App / Helpers\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n/**\r\n * GeoLeaf Application Helpers\r\n * Syst√®me de logs production, d√©tection de chemin, v√©rification des plugins,\r\n * et helper de notification.\r\n *\r\n * Ce fichier cr√©e le namespace partag√© GeoLeaf._app utilis√© par\r\n * app/init.js et app/boot.js.\r\n *\r\n * @module app/helpers\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n\r\n    /**\r\n     * Namespace interne pour le module Application Bootstrap.\r\n     * Partag√© entre app/helpers.js, app/init.js et app/boot.js.\r\n     * @namespace GeoLeaf._app\r\n     * @private\r\n     */\r\n    const _app = GeoLeaf._app = GeoLeaf._app || {};\r\n\r\n    // ============================================================\r\n    // Syst√®me de logs production\r\n    // ============================================================\r\n    _app.AppLog = {\r\n        log(...args) {\r\n            if (location.search.includes('debug=true')) {\r\n                console.log('[GeoLeaf]', ...args);\r\n            }\r\n        },\r\n        info(...args) {\r\n            console.info('[GeoLeaf]', ...args);\r\n        },\r\n        error(...args) {\r\n            console.error('[GeoLeaf]', ...args);\r\n        },\r\n        warn(...args) {\r\n            console.warn('[GeoLeaf]', ...args);\r\n        }\r\n    };\r\n\r\n    // ============================================================\r\n    // D√©tection automatique du chemin vers profiles/\r\n    // ============================================================\r\n    /**\r\n     * D√©tecte automatiquement le chemin de base vers le dossier profiles/\r\n     * en fonction de l'URL courante.\r\n     * @returns {string} Chemin relatif vers profiles/\r\n     */\r\n    _app.getProfilesBasePath = function () {\r\n        const currentPath = global.location.pathname;\r\n        if (currentPath.includes('/demo/')) {\r\n            return '../profiles/';\r\n        }\r\n        return './profiles/';\r\n    };\r\n\r\n    // ============================================================\r\n    // V√©rification des plugins au boot\r\n    // ============================================================\r\n    /**\r\n     * V√©rifie que les plugins requis par la configuration sont bien charg√©s\r\n     * et affiche des avertissements dans la console si ce n'est pas le cas.\r\n     * @param {Object} cfg - Configuration du profil actif\r\n     */\r\n    _app.checkPlugins = function (cfg) {\r\n        const AppLog = _app.AppLog;\r\n\r\n        // Avertissement si config attend AddPOI mais plugin non charg√©\r\n        if (cfg && cfg.ui && cfg.ui.showAddPoi === true) {\r\n            if (!GeoLeaf.POI || !GeoLeaf.POI.AddForm) {\r\n                AppLog.warn(\r\n                    '‚ö†Ô∏è Config has showAddPoi=true but AddPOI plugin is not loaded. ' +\r\n                    'Load geoleaf-addpoi.plugin.js before calling GeoLeaf.boot().'\r\n                );\r\n            }\r\n        }\r\n\r\n        // Avertissement si config attend Storage mais plugin non charg√©\r\n        if (cfg && cfg.storage) {\r\n            if (!GeoLeaf.Storage) {\r\n                AppLog.warn(\r\n                    '‚ö†Ô∏è Config references storage but Storage plugin is not loaded. ' +\r\n                    'Load geoleaf-storage.plugin.js before calling GeoLeaf.boot().'\r\n                );\r\n            }\r\n\r\n            // Avertissement si enableServiceWorker mais sw-register absent\r\n            if (cfg.storage.enableServiceWorker && !GeoLeaf._SWRegister) {\r\n                AppLog.warn(\r\n                    '‚ö†Ô∏è Config has enableServiceWorker=true but SW Register module is not available. ' +\r\n                    'Ensure sw-register.js is included in the Storage plugin bundle.'\r\n                );\r\n            }\r\n        }\r\n\r\n        // Avertissement si SyncHandler est charg√© sans Storage\r\n        if (GeoLeaf.POI && GeoLeaf.POI.SyncHandler && !GeoLeaf.Storage) {\r\n            AppLog.warn(\r\n                '‚ö†Ô∏è SyncHandler loaded without Storage plugin ‚Äî sync operations will be disabled. ' +\r\n                'POI add/edit/delete will work in online-only mode.'\r\n            );\r\n        }\r\n    };\r\n\r\n    // ============================================================\r\n    // Helper : afficher une notification\r\n    // ============================================================\r\n    /**\r\n     * Affiche une notification via le syst√®me UI de GeoLeaf.\r\n     * Tente d'abord GeoLeaf.UI.Notifications, puis GeoLeaf._UINotifications.\r\n     * @param {string} message - Message √† afficher\r\n     * @param {number} [duration=3500] - Dur√©e d'affichage en millisecondes\r\n     * @returns {boolean} true si la notification a √©t√© affich√©e\r\n     */\r\n    _app.showNotification = function (message, duration) {\r\n        duration = duration || 3500;\r\n        if (GeoLeaf.UI && GeoLeaf.UI.Notifications && typeof GeoLeaf.UI.Notifications.success === \"function\") {\r\n            try { GeoLeaf.UI.Notifications.success(message, duration); return true; } catch (e) {}\r\n        }\r\n        if (GeoLeaf._UINotifications && typeof GeoLeaf._UINotifications.success === \"function\") {\r\n            try { GeoLeaf._UINotifications.success(message, duration); return true; } catch (e) {}\r\n        }\r\n        _app.AppLog.log(message + \" (notifications indisponibles)\");\r\n        return false;\r\n    };\r\n\r\n})(window);\r\n","/*!\r\n * GeoLeaf Core ‚Äì App / Init\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n/**\r\n * GeoLeaf Application Init\r\n * Fonction principale d'initialisation de l'application :\r\n * - Initialisation de la carte\r\n * - Chargement des modules (POI, Routes, GeoJSON, etc.)\r\n * - Configuration des composants UI\r\n * - M√©canisme de reveal (loader / spinner)\r\n *\r\n * @module app/init\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    const _app = GeoLeaf._app = GeoLeaf._app || {};\r\n\r\n    // ============================================================\r\n    // Fonction principale : initialiser l'application\r\n    // ============================================================\r\n    _app.initApp = function (cfg) {\r\n        cfg = cfg || {};\r\n        const AppLog = _app.AppLog;\r\n        AppLog.log(\"Initialisation avec config:\", cfg);\r\n\r\n        // V√©rifier les plugins\r\n        _app.checkPlugins(cfg);\r\n\r\n        // ========================================================\r\n        // Initialisation de la carte\r\n        // La carte est cr√©√©e directement sur l'emprise du profil\r\n        // (map.bounds obligatoire dans le profil).\r\n        // ========================================================\r\n        const mapTarget = (cfg.map && (cfg.map.target || cfg.map.id)) || \"geoleaf-map\";\r\n        const uiTheme = (cfg.ui && cfg.ui.theme) || \"light\";\r\n\r\n        // Bounds obligatoires ‚Äî pas de fallback carte monde\r\n        if (!cfg.map || !Array.isArray(cfg.map.bounds) || cfg.map.bounds.length !== 2) {\r\n            AppLog.error(\r\n                \"[GeoLeaf] Le profil actif ne d√©finit pas de map.bounds valide. \" +\r\n                \"L'emprise (map.bounds) est obligatoire dans le fichier profile.json. \" +\r\n                \"Exemple : \\\"bounds\\\": [[43.0, 1.0], [44.0, 2.0]]\"\r\n            );\r\n            return;\r\n        }\r\n\r\n        // Calculer le centre depuis les bounds pour √©viter le flash carte monde\r\n        const profileBounds = cfg.map.bounds;\r\n        const profileMaxZoom = cfg.map.maxZoom || 12;\r\n        const profilePadding = cfg.map.padding || [50, 50];\r\n        const mapCenter = [\r\n            (profileBounds[0][0] + profileBounds[1][0]) / 2,\r\n            (profileBounds[0][1] + profileBounds[1][1]) / 2\r\n        ];\r\n\r\n        let map = null;\r\n\r\n        try {\r\n            map = GeoLeaf.init({\r\n                map: {\r\n                    target: mapTarget,\r\n                    center: mapCenter,\r\n                    zoom: profileMaxZoom\r\n                },\r\n                ui: {\r\n                    theme: uiTheme\r\n                }\r\n            });\r\n        } catch (e) {\r\n            AppLog.error(\"GeoLeaf.init() a lev√© une erreur :\", e);\r\n            return;\r\n        }\r\n\r\n        if (!map) {\r\n            AppLog.error(\"GeoLeaf.init() n'a pas renvoy√© de carte valide.\");\r\n            return;\r\n        }\r\n\r\n        // Positionnement pr√©cis via fitBounds (ajuste le zoom aux dimensions r√©elles du conteneur)\r\n        try {\r\n            map.fitBounds(profileBounds, {\r\n                maxZoom: profileMaxZoom,\r\n                padding: profilePadding,\r\n                animate: false\r\n            });\r\n            AppLog.log(\"Carte positionn√©e via map.bounds du profil.\");\r\n        } catch (e) {\r\n            AppLog.warn(\"Erreur fitBounds depuis profile.map.bounds :\", e);\r\n        }\r\n\r\n        // ========================================================\r\n        // Initialiser le Storage avec la config du profil (si plugin charg√©)\r\n        // ========================================================\r\n        if (GeoLeaf.Storage && typeof GeoLeaf.Storage.init === \"function\") {\r\n            try {\r\n                const storageConfig = cfg.storage || {};\r\n                AppLog.log(\"Initialisation du Storage avec config:\", storageConfig);\r\n\r\n                GeoLeaf.Storage.init({\r\n                    indexedDB: { name: 'geoleaf-db', version: 2 },\r\n                    cache: storageConfig.cache || {\r\n                        enableProfileCache: true,\r\n                        enableTileCache: true\r\n                    },\r\n                    offline: {},\r\n                    enableOfflineDetector: !!(storageConfig.enableOfflineDetector),\r\n                    enableServiceWorker: !!(storageConfig.enableServiceWorker)\r\n                }).then(() => {\r\n                    AppLog.log(\"Storage initialis√© avec succ√®s\");\r\n                }).catch(err => {\r\n                    AppLog.warn(\"Erreur initialisation Storage:\", err);\r\n                });\r\n            } catch (e) {\r\n                AppLog.warn(\"Erreur lors de l'initialisation du Storage:\", e);\r\n            }\r\n        } else {\r\n            AppLog.log(\"Plugin Storage non charg√© ‚Äî fonctionnement en mode cache navigateur standard.\");\r\n        }\r\n\r\n        // ========================================================\r\n        // Initialiser le syst√®me de notifications UI\r\n        // ========================================================\r\n        if (GeoLeaf._UINotifications && typeof GeoLeaf._UINotifications.init === \"function\") {\r\n            try {\r\n                let notificationContainer = document.getElementById('gl-notifications');\r\n                if (!notificationContainer) {\r\n                    notificationContainer = document.createElement('div');\r\n                    notificationContainer.id = 'gl-notifications';\r\n                    notificationContainer.className = 'gl-notifications gl-notifications--bottom-center';\r\n                    document.body.appendChild(notificationContainer);\r\n                }\r\n\r\n                GeoLeaf._UINotifications.init({\r\n                    container: '#gl-notifications',\r\n                    position: 'bottom-center',\r\n                    maxVisible: 3,\r\n                    animations: true\r\n                });\r\n\r\n                AppLog.log(\"Syst√®me de notifications initialis√©\");\r\n            } catch (e) {\r\n                AppLog.warn(\"Erreur lors de l'initialisation des notifications:\", e);\r\n            }\r\n        }\r\n\r\n        // ========================================================\r\n        // Toast de chargement persistant pendant le chargement des couches\r\n        // Affich√© d√®s que le ThemeApplier commence √† charger un th√®me,\r\n        // ferm√© quand geoleaf:theme:applied est √©mis.\r\n        // ========================================================\r\n        let _loadingToast = null;\r\n\r\n        document.addEventListener('geoleaf:theme:applying', function(event) {\r\n            // Afficher un toast persistant si le syst√®me de notifications est pr√™t\r\n            if (GeoLeaf._UINotifications && GeoLeaf._UINotifications.container) {\r\n                _loadingToast = GeoLeaf._UINotifications.info(\r\n                    'Chargement des donn√©es en cours, patientez‚Ä¶',\r\n                    { persistent: true, dismissible: false }\r\n                );\r\n            }\r\n        });\r\n\r\n        // ========================================================\r\n        // √âcouteurs d'√©v√©nements (notifications profile & theme)\r\n        // ========================================================\r\n        let pendingProfileToastDetail = null;\r\n\r\n        function notificationsReady() {\r\n            try {\r\n                if (GeoLeaf.UI && GeoLeaf.UI.Notifications && typeof GeoLeaf.UI.Notifications.getStatus === \"function\") {\r\n                    return !!GeoLeaf.UI.Notifications.getStatus().initialized;\r\n                }\r\n                if (GeoLeaf._UINotifications && GeoLeaf._UINotifications.container) {\r\n                    return true;\r\n                }\r\n            } catch (e) {}\r\n            return false;\r\n        }\r\n\r\n        function tryShowProfileToast(detail) {\r\n            if (!detail || !detail.data) return false;\r\n            const profile = detail.data.profile || {};\r\n            const profileName = profile.label || profile.name || profile.title || detail.profileId || 'Profil';\r\n            const message = profileName + \" charg√©\";\r\n            if (!notificationsReady()) {\r\n                pendingProfileToastDetail = detail;\r\n                return false;\r\n            }\r\n            const shown = _app.showNotification(message);\r\n            if (shown) pendingProfileToastDetail = null;\r\n            else pendingProfileToastDetail = detail;\r\n            return shown;\r\n        }\r\n\r\n        document.addEventListener(\"geoleaf:profile:loaded\", function(event) {\r\n            if (event && event.detail) {\r\n                pendingProfileToastDetail = event.detail;\r\n                tryShowProfileToast(event.detail);\r\n            }\r\n        });\r\n\r\n        document.addEventListener(\"geoleaf:theme:applied\", function(event) {\r\n            // Fermer le toast de chargement persistant\r\n            if (_loadingToast && GeoLeaf._UINotifications && typeof GeoLeaf._UINotifications.dismiss === 'function') {\r\n                GeoLeaf._UINotifications.dismiss(_loadingToast);\r\n                _loadingToast = null;\r\n            }\r\n            if (event && event.detail) {\r\n                const detail = event.detail;\r\n                _app.showNotification(`Th√®me \"${detail.themeName}\" charg√© (${detail.layerCount} couches visibles)`, 3500);\r\n            }\r\n        });\r\n\r\n        // √âcouter la fin de chargement pour les notifications en attente\r\n        document.addEventListener(\"geoleaf:map:ready\", function() {\r\n            if (pendingProfileToastDetail) {\r\n                tryShowProfileToast(pendingProfileToastDetail);\r\n            }\r\n        });\r\n\r\n        // ========================================================\r\n        // Th√®me UI via GeoLeaf.setTheme() + initialisation UI\r\n        // ========================================================\r\n        try {\r\n            if (typeof GeoLeaf.setTheme === \"function\") {\r\n                GeoLeaf.setTheme(uiTheme);\r\n            }\r\n        } catch (e) {\r\n            AppLog.warn(\"Erreur lors de l'appel √† GeoLeaf.setTheme :\", e);\r\n        }\r\n\r\n        if (GeoLeaf.UI && typeof GeoLeaf.UI.init === \"function\") {\r\n            try {\r\n                const mapContainer = document.querySelector('.gl-main') || document.getElementById(mapTarget);\r\n                GeoLeaf.UI.init({\r\n                    buttonSelector: '[data-gl-role=\"theme-toggle\"]',\r\n                    map: map,\r\n                    mapContainer: mapContainer,\r\n                    config: cfg\r\n                });\r\n            } catch (e) {\r\n                AppLog.warn(\"GeoLeaf.UI.init() a lev√© une erreur :\", e);\r\n            }\r\n        }\r\n\r\n        // Construction du panneau de filtres\r\n        if (GeoLeaf.UI && typeof GeoLeaf.UI.buildFilterPanelFromActiveProfile === \"function\") {\r\n            try {\r\n                let filterContainer = document.getElementById(\"gl-filter-panel\");\r\n                if (!filterContainer) {\r\n                    filterContainer = document.createElement(\"div\");\r\n                    filterContainer.id = \"gl-filter-panel\";\r\n                    filterContainer.setAttribute(\"data-gl-role\", \"filter-panel\");\r\n                    const glMain = document.querySelector('.gl-main');\r\n                    if (glMain) glMain.appendChild(filterContainer);\r\n                    else document.body.appendChild(filterContainer);\r\n                }\r\n\r\n                GeoLeaf.UI.buildFilterPanelFromActiveProfile({ container: filterContainer });\r\n\r\n                if (typeof GeoLeaf.UI.initFilterToggle === \"function\") {\r\n                    GeoLeaf.UI.initFilterToggle();\r\n                }\r\n                if (typeof GeoLeaf.UI.initProximityFilter === \"function\") {\r\n                    GeoLeaf.UI.initProximityFilter(map);\r\n                }\r\n            } catch (e) {\r\n                AppLog.warn(\"Erreur lors de la construction du panneau de filtres :\", e);\r\n            }\r\n        }\r\n\r\n        // Initialisation du module Table\r\n        if (GeoLeaf.Table && typeof GeoLeaf.Table.init === \"function\" && cfg.tableConfig && cfg.tableConfig.enabled) {\r\n            try {\r\n                GeoLeaf.Table.init({ map: map, config: cfg.tableConfig });\r\n                AppLog.log(\"Module Table initialis√©.\");\r\n            } catch (e) {\r\n                AppLog.warn(\"Erreur lors de l'initialisation du module Table :\", e);\r\n            }\r\n        }\r\n\r\n        // Initialisation du bouton de cache offline (si plugin Storage charg√©)\r\n        if (GeoLeaf.UI && GeoLeaf.UI.CacheButton && typeof GeoLeaf.UI.CacheButton.init === \"function\") {\r\n            try {\r\n                GeoLeaf.UI.CacheButton.init(map, cfg);\r\n                AppLog.log(\"Bouton de cache initialis√©.\");\r\n            } catch (e) {\r\n                AppLog.warn(\"Erreur lors de l'initialisation du bouton de cache :\", e);\r\n            }\r\n        }\r\n\r\n        // ========================================================\r\n        // Basemaps via GeoLeaf.BaseLayers\r\n        // ========================================================\r\n        (function initBasemaps() {\r\n            const baseLayersModule = GeoLeaf.BaseLayers || GeoLeaf.Baselayers;\r\n            if (!baseLayersModule || typeof baseLayersModule.init !== \"function\") {\r\n                AppLog.warn(\"Module BaseLayers introuvable.\");\r\n                return;\r\n            }\r\n\r\n            let activeKey = \"street\";\r\n            const basemapsFromConfig = {};\r\n            if (cfg.basemaps && typeof cfg.basemaps === 'object') {\r\n                Object.keys(cfg.basemaps).forEach(function(key) {\r\n                    const def = cfg.basemaps[key];\r\n                    if (def.defaultBasemap === true) activeKey = def.id || key;\r\n                    basemapsFromConfig[key] = {\r\n                        id: def.id || key,\r\n                        label: def.label || key,\r\n                        url: def.url,\r\n                        options: {\r\n                            minZoom: def.minZoom || 0,\r\n                            maxZoom: def.maxZoom || 19,\r\n                            attribution: def.attribution || ''\r\n                        }\r\n                    };\r\n                });\r\n            }\r\n\r\n            try {\r\n                baseLayersModule.init({\r\n                    map: map,\r\n                    baselayers: basemapsFromConfig,\r\n                    activeKey: activeKey,\r\n                    ui: cfg.ui,\r\n                    basemaps: cfg.basemaps\r\n                });\r\n            } catch (e) {\r\n                AppLog.warn(\"BaseLayers.init a lev√© une exception :\", e);\r\n            }\r\n        })();\r\n\r\n        // ========================================================\r\n        // POI via GeoLeaf.POI\r\n        // ========================================================\r\n        (function initPOI() {\r\n            const poiApi = GeoLeaf.POI;\r\n            if (!poiApi || typeof poiApi.add !== \"function\") {\r\n                AppLog.warn(\"GeoLeaf.POI.add() indisponible, aucun POI ne sera affich√©.\");\r\n                return;\r\n            }\r\n\r\n            try {\r\n                if (typeof poiApi.init === \"function\") {\r\n                    poiApi.init({ map: map, config: cfg.poiConfig || {} });\r\n\r\n                    // Chargement des l√©gendes POI\r\n                    if (GeoLeaf.Legend && typeof GeoLeaf.Legend.loadLayerLegend === \"function\" && cfg.layers && Array.isArray(cfg.layers)) {\r\n                        cfg.layers.forEach(function(layerRef) {\r\n                            if (layerRef.id && layerRef.id.includes('poi') && layerRef.configFile) {\r\n                                fetch(layerRef.configFile)\r\n                                    .then(response => response.json())\r\n                                    .then(layerConfig => {\r\n                                        let styleId = 'default';\r\n                                        if (layerConfig.styles && layerConfig.styles.available && layerConfig.styles.available.length > 0) {\r\n                                            styleId = layerConfig.styles.available[0].id || 'default';\r\n                                        }\r\n                                        GeoLeaf.Legend.loadLayerLegend(layerRef.id, styleId, layerConfig);\r\n                                        if (typeof GeoLeaf.Legend.setLayerVisibility === \"function\") {\r\n                                            GeoLeaf.Legend.setLayerVisibility(layerRef.id, true);\r\n                                        }\r\n                                    })\r\n                                    .catch(err => AppLog.warn(`Erreur chargement config couche ${layerRef.id}:`, err));\r\n                            }\r\n                        });\r\n                    }\r\n                }\r\n            } catch (e) {\r\n                AppLog.warn(\"GeoLeaf.POI.init() a lev√© une erreur :\", e);\r\n            }\r\n\r\n            const showFilterPanel = cfg.ui && cfg.ui.showFilterPanel === true;\r\n            if (showFilterPanel) {\r\n                AppLog.info(\"Panneau de filtres activ√© : les POI seront charg√©s via le syst√®me de filtres.\");\r\n                if (GeoLeaf.UI && typeof GeoLeaf.UI.applyFiltersInitial === \"function\") {\r\n                    GeoLeaf.UI.applyFiltersInitial();\r\n                }\r\n                return;\r\n            }\r\n\r\n            if (!Array.isArray(cfg.poi) || cfg.poi.length === 0) {\r\n                return;\r\n            }\r\n\r\n            const bounds = [];\r\n            cfg.poi.forEach(function (poiItem) {\r\n                let latlng = null;\r\n                if (poiItem.latlng && Array.isArray(poiItem.latlng) && poiItem.latlng.length === 2) {\r\n                    latlng = poiItem.latlng;\r\n                } else if (poiItem.location && typeof poiItem.location.lat === \"number\" && typeof poiItem.location.lng === \"number\") {\r\n                    latlng = [poiItem.location.lat, poiItem.location.lng];\r\n                }\r\n                if (latlng) bounds.push(latlng);\r\n            });\r\n\r\n            if (bounds.length > 0) {\r\n                // fitBounds POI uniquement si pas de bounds dans le profil ET pas de couches GeoJSON\r\n                const hasBoundsFromProfile = cfg.map && Array.isArray(cfg.map.bounds) && cfg.map.bounds.length === 2;\r\n                const hasGeoJSONLayers = cfg.layers && Array.isArray(cfg.layers) && cfg.layers.length > 0;\r\n                if (!hasBoundsFromProfile && !hasGeoJSONLayers) {\r\n                    try {\r\n                        map.fitBounds(L.latLngBounds(bounds), { padding: [80, 80], maxZoom: 12, animate: false });\r\n                    } catch (e) {\r\n                        AppLog.warn(\"Erreur lors de fitBounds :\", e);\r\n                    }\r\n                }\r\n                if (GeoLeaf.UI && typeof GeoLeaf.UI.refreshFilterTags === \"function\") {\r\n                    GeoLeaf.UI.refreshFilterTags();\r\n                }\r\n            }\r\n        })();\r\n\r\n        // ========================================================\r\n        // Itin√©raires via GeoLeaf.Route\r\n        // ========================================================\r\n        (function initRoute() {\r\n            const routeApi = GeoLeaf.Route;\r\n            if (!routeApi || typeof routeApi.init !== \"function\" || typeof routeApi.loadFromConfig !== \"function\") {\r\n                return;\r\n            }\r\n            try {\r\n                routeApi.init({ map: map, fitBoundsOnLoad: false, maxZoomOnFit: 12 });\r\n            } catch (e) {\r\n                AppLog.warn(\"GeoLeaf.Route.init() a lev√© une erreur :\", e);\r\n                return;\r\n            }\r\n            if (Array.isArray(cfg.routes) && cfg.routes.length > 0) {\r\n                try {\r\n                    routeApi.loadFromConfig(cfg.routes);\r\n                    AppLog.log(\"Itin√©raires charg√©s.\");\r\n                } catch (e) {\r\n                    AppLog.warn(\"GeoLeaf.Route.loadFromConfig() a lev√© une erreur :\", e);\r\n                }\r\n            }\r\n        })();\r\n\r\n        // ========================================================\r\n        // Couches GeoJSON via GeoLeaf.GeoJSON\r\n        // ========================================================\r\n        (function initGeoJSON() {\r\n            const geoJsonApi = GeoLeaf.GeoJSON;\r\n            if (!geoJsonApi || typeof geoJsonApi.init !== \"function\") {\r\n                AppLog.log(\"GeoLeaf.GeoJSON.init() indisponible ‚Äî pas de couches GeoJSON.\");\r\n                return;\r\n            }\r\n\r\n            try {\r\n                geoJsonApi.init({ map: map, fitBoundsOnLoad: false, maxZoomOnFit: 12 });\r\n            } catch (e) {\r\n                AppLog.warn(\"GeoLeaf.GeoJSON.init() a lev√© une erreur :\", e);\r\n                return;\r\n            }\r\n\r\n            if (map && typeof map.on === \"function\") {\r\n                map.on(\"geoleaf:geojson:layers-loaded\", function(event) {\r\n                    if (event && event.detail && typeof event.detail.count === \"number\") {\r\n                        const count = event.detail.count;\r\n                        const message = count === 1 ? \"1 couche GeoJSON charg√©e\" : count + \" couches GeoJSON charg√©es\";\r\n                        _app.showNotification(message, 3000);\r\n                    }\r\n                });\r\n            }\r\n\r\n            // Initialisation du syst√®me de th√®mes\r\n            const loadAllConfigsPromise = (function() {\r\n                if (GeoLeaf._GeoJSONLoader && typeof GeoLeaf._GeoJSONLoader.loadAllLayersConfigsForLayerManager === \"function\") {\r\n                    const activeProfile = GeoLeaf.Config && typeof GeoLeaf.Config.getActiveProfile === \"function\"\r\n                        ? GeoLeaf.Config.getActiveProfile() : null;\r\n                    if (activeProfile) {\r\n                        return GeoLeaf._GeoJSONLoader.loadAllLayersConfigsForLayerManager(activeProfile)\r\n                            .catch(err => { AppLog.warn(\"Erreur chargement configs couches:\", err); return []; });\r\n                    }\r\n                }\r\n                return Promise.resolve();\r\n            })();\r\n\r\n            loadAllConfigsPromise.then(function() {\r\n                if (!GeoLeaf.ThemeSelector || typeof GeoLeaf.ThemeSelector.init !== \"function\") {\r\n                    AppLog.warn(\"ThemeSelector non disponible\");\r\n                    return;\r\n                }\r\n\r\n                let currentProfileId = null;\r\n                if (GeoLeaf.Config && typeof GeoLeaf.Config.getActiveProfileId === \"function\") {\r\n                    currentProfileId = GeoLeaf.Config.getActiveProfileId();\r\n                }\r\n\r\n                const primaryContainer = document.getElementById(\"gl-theme-primary-container\");\r\n                const secondaryContainer = document.getElementById(\"gl-theme-secondary-container\");\r\n\r\n                if (!currentProfileId || !primaryContainer || !secondaryContainer) {\r\n                    AppLog.warn(\"ThemeSelector : conteneurs ou profil manquants\");\r\n                    return;\r\n                }\r\n\r\n                GeoLeaf.ThemeSelector.init({\r\n                    profileId: currentProfileId,\r\n                    primaryContainer: primaryContainer,\r\n                    secondaryContainer: secondaryContainer\r\n                }).then(function() {\r\n                    AppLog.log(\"ThemeSelector initialis√© et th√®me appliqu√©\");\r\n\r\n                    if (GeoLeaf._GeoJSONLayerManager && typeof GeoLeaf._GeoJSONLayerManager.populateLayerManagerWithAllConfigs === \"function\") {\r\n                        const activeThemeConfig = GeoLeaf.ThemeSelector.getActiveTheme ? GeoLeaf.ThemeSelector.getActiveTheme() : null;\r\n                        GeoLeaf._GeoJSONLayerManager.populateLayerManagerWithAllConfigs(activeThemeConfig);\r\n                    }\r\n\r\n                    document.addEventListener('geoleaf:theme:applied', function() {\r\n                        if (GeoLeaf._GeoJSONLayerManager && typeof GeoLeaf._GeoJSONLayerManager.populateLayerManagerWithAllConfigs === \"function\") {\r\n                            const activeThemeConfig = GeoLeaf.ThemeSelector.getActiveTheme ? GeoLeaf.ThemeSelector.getActiveTheme() : null;\r\n                            GeoLeaf._GeoJSONLayerManager.populateLayerManagerWithAllConfigs(activeThemeConfig);\r\n                        }\r\n                    });\r\n                }).catch(function(e) {\r\n                    AppLog.warn(\"Erreur initialisation ThemeSelector:\", e);\r\n                });\r\n            });\r\n        })();\r\n\r\n        // ========================================================\r\n        // Branding\r\n        // ========================================================\r\n        if (GeoLeaf.UI && GeoLeaf.UI.Branding && typeof GeoLeaf.UI.Branding.init === \"function\") {\r\n            try {\r\n                GeoLeaf.UI.Branding.init(map);\r\n            } catch (e) {\r\n                AppLog.warn(\"GeoLeaf.UI.Branding.init() a lev√© une erreur :\", e);\r\n            }\r\n        }\r\n\r\n        // ========================================================\r\n        // L√©gende et gestionnaire de couches\r\n        // ========================================================\r\n        if (cfg.ui && cfg.ui.showLegend !== false && GeoLeaf.Legend && typeof GeoLeaf.Legend.init === \"function\") {\r\n            try {\r\n                GeoLeaf.Legend.init(map, {\r\n                    position: \"bottomleft\",\r\n                    collapsible: true,\r\n                    collapsed: false,\r\n                    title: \"L√©gende\"\r\n                });\r\n            } catch (e) {\r\n                AppLog.warn(\"Erreur lors de l'initialisation du module Legend:\", e);\r\n            }\r\n        }\r\n\r\n        if (cfg.ui && cfg.ui.showLayerManager !== false && GeoLeaf.LayerManager && typeof GeoLeaf.LayerManager.init === \"function\") {\r\n            try {\r\n                GeoLeaf.LayerManager.init({ map: map, position: \"bottomright\" });\r\n            } catch (e) {\r\n                AppLog.warn(\"GeoLeaf.LayerManager.init() a lev√© une erreur :\", e);\r\n            }\r\n        }\r\n\r\n        // ========================================================\r\n        // Contr√¥le d'√©chelle\r\n        // ========================================================\r\n        if (GeoLeaf.initScaleControl && typeof GeoLeaf.initScaleControl === \"function\") {\r\n            try { GeoLeaf.initScaleControl(map); } catch (e) {\r\n                AppLog.warn(\"GeoLeaf.initScaleControl() a lev√© une erreur :\", e);\r\n            }\r\n        }\r\n\r\n        // ========================================================\r\n        // Syst√®me de labels\r\n        // ========================================================\r\n        if (GeoLeaf.Labels && typeof GeoLeaf.Labels.init === \"function\") {\r\n            try { GeoLeaf.Labels.init({ map: map }); } catch (e) {\r\n                AppLog.warn(\"GeoLeaf.Labels.init() a lev√© une erreur :\", e);\r\n            }\r\n        }\r\n\r\n        // ========================================================\r\n        // Affichage des coordonn√©es\r\n        // ========================================================\r\n        if (cfg.ui && cfg.ui.showCoordinates !== false && GeoLeaf.UI && GeoLeaf.UI.CoordinatesDisplay && typeof GeoLeaf.UI.CoordinatesDisplay.init === \"function\") {\r\n            try {\r\n                GeoLeaf.UI.CoordinatesDisplay.init(map, { position: \"bottomleft\", decimals: 6 });\r\n            } catch (e) {\r\n                AppLog.warn(\"GeoLeaf.UI.CoordinatesDisplay.init() a lev√© une erreur :\", e);\r\n            }\r\n        }\r\n\r\n        // ========================================================\r\n        // R√©v√©ler l'application quand les couches sont pr√™tes\r\n        // Le spinner #gl-loader reste opaque pendant que la carte\r\n        // et les couches GeoJSON se chargent derri√®re.\r\n        // On attend l'√©v√©nement geoleaf:theme:applied (= toutes\r\n        // les couches visibles sont charg√©es) avant de r√©v√©ler.\r\n        // ========================================================\r\n        let _appRevealed = false;\r\n        function revealApp(reason) {\r\n            if (_appRevealed) return;\r\n            _appRevealed = true;\r\n            const loader = document.getElementById('gl-loader');\r\n            if (loader) {\r\n                loader.classList.add('gl-loader--fade');\r\n                // Supprimer du DOM apr√®s la transition CSS (400ms)\r\n                loader.addEventListener('transitionend', function() {\r\n                    loader.style.display = 'none';\r\n                }, { once: true });\r\n                // Fallback si transitionend ne se d√©clenche pas\r\n                setTimeout(function() { loader.style.display = 'none'; }, 500);\r\n            }\r\n\r\n            // Correctif : le loader (#gl-loader) recouvrait la carte (position: fixed; inset: 0)\r\n            // ‚Üí Leaflet calculait fitBounds sur un conteneur de dimensions incorrectes.\r\n            // On recalcule apr√®s le retrait du loader.\r\n            if (map) {\r\n                map.invalidateSize({ pan: false });\r\n                setTimeout(function() {\r\n                    try {\r\n                        map.fitBounds(profileBounds, {\r\n                            maxZoom:  profileMaxZoom,\r\n                            padding:  profilePadding,\r\n                            animate:  true,\r\n                            duration: 0.6\r\n                        });\r\n                    } catch (e) {\r\n                        AppLog.warn(\"[GeoLeaf] Correctif fitBounds au reveal :\", e);\r\n                    }\r\n                }, 120);\r\n            }\r\n\r\n            document.dispatchEvent(new CustomEvent(\"geoleaf:map:ready\"));\r\n            AppLog.info(\"Application pr√™te ‚Äî \" + reason);\r\n        }\r\n\r\n        // Attendre que toutes les couches du th√®me soient charg√©es\r\n        document.addEventListener('geoleaf:theme:applied', function() {\r\n            revealApp('th√®me appliqu√©, couches charg√©es');\r\n        }, { once: true });\r\n\r\n        // S√©curit√© : r√©v√©ler apr√®s 15s max (r√©seau lent, erreur‚Ä¶)\r\n        setTimeout(function() { revealApp('timeout s√©curit√© 15s'); }, 15000);\r\n\r\n        AppLog.info(\"Application initialis√©e, chargement des couches en arri√®re-plan‚Ä¶\");\r\n    };\r\n\r\n})(window);\r\n","/*!\r\n * GeoLeaf Core ‚Äì App / Boot\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n/**\r\n * GeoLeaf Application Boot\r\n * Chargement de la configuration et lancement de l'initialisation.\r\n * Expose l'API publique GeoLeaf.boot().\r\n *\r\n * Usage : <script>GeoLeaf.boot();</script>\r\n *\r\n * @module app/boot\r\n */\r\n(function (global) {\r\n    \"use strict\";\r\n\r\n    const GeoLeaf = (global.GeoLeaf = global.GeoLeaf || {});\r\n    const _app = GeoLeaf._app = GeoLeaf._app || {};\r\n\r\n    // ============================================================\r\n    // Fonction startApp : chargement config + lancement initApp\r\n    // ============================================================\r\n    _app.startApp = function () {\r\n        const AppLog = _app.AppLog;\r\n\r\n        if (!GeoLeaf) {\r\n            AppLog.error(\"GeoLeaf global introuvable. Le bundle core doit √™tre charg√© avant GeoLeaf.boot().\");\r\n            return;\r\n        }\r\n\r\n        if (typeof GeoLeaf.loadConfig !== \"function\") {\r\n            AppLog.error(\"GeoLeaf.loadConfig() est introuvable. V√©rifiez que le bundle core est complet.\");\r\n            return;\r\n        }\r\n\r\n        AppLog.info(\"D√©marrage de l'application...\");\r\n\r\n        let selectedProfile = null;\r\n        try {\r\n            selectedProfile = sessionStorage.getItem('gl-selected-profile');\r\n            if (selectedProfile) {\r\n                AppLog.log('Profil s√©lectionn√© depuis sessionStorage:', selectedProfile);\r\n                sessionStorage.removeItem('gl-selected-profile');\r\n            }\r\n        } catch (e) {\r\n            AppLog.warn('Impossible de lire sessionStorage:', e);\r\n        }\r\n\r\n        const profilesPath = _app.getProfilesBasePath();\r\n\r\n        GeoLeaf.loadConfig({\r\n            url: profilesPath + \"geoleaf.config.json\",\r\n            profileId: selectedProfile,\r\n            autoEvent: true,\r\n\r\n            onLoaded: function (cfg) {\r\n                AppLog.log(\"Configuration charg√©e via GeoLeaf.loadConfig :\", cfg || {});\r\n\r\n                if (GeoLeaf.Config && typeof GeoLeaf.Config.getCategories === \"function\") {\r\n                    try { GeoLeaf.Config.getCategories(); } catch (e) {\r\n                        AppLog.warn(\"Erreur lors de la lecture du mapping cat√©gories :\", e);\r\n                    }\r\n                }\r\n\r\n                const baseCfg = cfg || {};\r\n\r\n                if (GeoLeaf.Config && typeof GeoLeaf.Config.loadActiveProfileResources === \"function\") {\r\n                    GeoLeaf.Config.loadActiveProfileResources()\r\n                        .then(function (profileCfg) {\r\n                            AppLog.info(\"Ressources du profil actif charg√©es.\");\r\n                            _app.initApp(profileCfg || baseCfg);\r\n                        })\r\n                        .catch(function (err) {\r\n                            AppLog.warn(\"Erreur lors du chargement des ressources de profil :\", err);\r\n                            _app.initApp(baseCfg);\r\n                        });\r\n                } else {\r\n                    _app.initApp(baseCfg);\r\n                }\r\n            },\r\n\r\n            onError: function (err) {\r\n                AppLog.error(\"Erreur chargement config via GeoLeaf.loadConfig :\", err);\r\n            }\r\n        });\r\n    };\r\n\r\n    // ============================================================\r\n    // Exposer GeoLeaf.boot() ‚Äî API publique\r\n    // ============================================================\r\n\r\n    /**\r\n     * D√©marre l'application GeoLeaf.\r\n     * Charge la configuration, initialise la carte et tous les modules.\r\n     * Les plugins optionnels (Storage, AddPOI) doivent √™tre charg√©s avant cet appel.\r\n     *\r\n     * @example\r\n     * <script src=\"dist/geoleaf.umd.js\"></script>\r\n     * <script src=\"dist/geoleaf-storage.plugin.js\"></script>  <!-- optionnel -->\r\n     * <script src=\"dist/geoleaf-addpoi.plugin.js\"></script>   <!-- optionnel -->\r\n     * <script>GeoLeaf.boot();</script>\r\n     */\r\n    GeoLeaf.boot = function() {\r\n        if (document.readyState === 'loading') {\r\n            document.addEventListener('DOMContentLoaded', _app.startApp);\r\n        } else {\r\n            _app.startApp();\r\n        }\r\n    };\r\n\r\n})(window);\r\n","/*!\r\n * GeoLeaf Core\r\n * ¬© 2026 Mattieu Pottier\r\n * Released under the MIT License\r\n * https://geoleaf.dev\r\n */\r\n\r\n/**\r\n * GeoLeaf Bundle Entry Point\r\n * Point d'entr√©e pour la g√©n√©ration du bundle UMD via Rollup\r\n *\r\n * Ce fichier charge tous les modules GeoLeaf dans l'ordre correct des d√©pendances.\r\n * Chaque module est un IIFE qui attache ses exports sur window.GeoLeaf.\r\n *\r\n * @version 3.1.0\r\n */\r\n\r\n// Import des modules dans l'ordre des d√©pendances (identique √† main.js ligne par ligne)\r\n\r\n// Modules utilitaires (doivent √™tre charg√©s en premier)\r\nimport './static/js/geoleaf.log.js';\r\nimport './static/js/geoleaf.log.config.js';\r\nimport './static/js/geoleaf.security.js';\r\nimport './static/js/geoleaf.constants.js';\r\nimport './static/js/geoleaf.utils.js';\r\nimport './static/js/utils/dom-security.js';\r\nimport './static/js/utils/dom-helpers.js';\r\nimport './static/js/utils/event-listener-manager.js';\r\nimport './static/js/utils/timer-manager.js';\r\nimport './static/js/utils/scale-utils.js';\r\n\r\n// Helpers\r\nimport './static/js/helpers/style-resolver.js';\r\n\r\n// Validators\r\nimport './static/js/validators/style-validator-rules.js';\r\nimport './static/js/validators/style-validator.js';\r\n\r\n// Modules principaux\r\nimport './static/js/geoleaf.core.js';\r\n\r\n// UI - Sous-modules\r\nimport './static/js/ui/theme.js';\r\nimport './static/js/ui/controls.js';\r\nimport './static/js/ui/panel-builder.js';\r\nimport './static/js/ui/dom-utils.js';\r\nimport './static/js/ui/coordinates-display.js';\r\nimport './static/js/ui/branding.js';\r\n\r\n// UI - Content Builder\r\nimport './static/js/ui/content-builder/core.js';\r\nimport './static/js/ui/content-builder/templates.js';\r\nimport './static/js/ui/content-builder/assemblers.js';\r\nimport './static/js/ui/content-builder.js';\r\nimport './static/js/ui/components.js';\r\nimport './static/js/ui/notifications.js';\r\n\r\n// UI - Sprint 4.4\r\nimport './static/js/ui/event-delegation.js';\r\nimport './static/js/ui/filter-state-manager.js';\r\n\r\n// Map\r\nimport './static/js/map/scale-control.js';\r\n\r\n// UI - Filter Control Builder\r\nimport './static/js/ui/filter-control-builder.js';\r\n\r\n// UI - Filter Panel\r\nimport './static/js/ui/filter-panel/shared.js';\r\nimport './static/js/ui/filter-panel/state-reader.js';\r\nimport './static/js/ui/filter-panel/lazy-loader.js';\r\nimport './static/js/ui/filter-panel/applier.js';\r\nimport './static/js/ui/filter-panel/renderer.js';\r\nimport './static/js/ui/filter-panel/proximity.js';\r\nimport './static/js/ui/filter-panel/core.js';\r\nimport './static/js/ui/filter-panel.js';\r\n\r\n// Main UI\r\nimport './static/js/geoleaf.ui.js';\r\n\r\n// Data\r\nimport './static/js/data/normalizer.js';\r\n\r\n// Loaders\r\nimport './static/js/loaders/style-loader.js';\r\n\r\n// Config - Sous-modules\r\nimport './static/js/config/loader.js';\r\nimport './static/js/config/storage.js';\r\nimport './static/js/config/normalization.js';\r\nimport './static/js/config/taxonomy.js';\r\nimport './static/js/config/profile-v3-loader.js';\r\nimport './static/js/config/profile.js';\r\nimport './static/js/config/data-converter.js';\r\n// Config - GeoLeaf.Config (√©clat√© en 4 sous-modules)\r\nimport './static/js/config/geoleaf-config/config-core.js';\r\nimport './static/js/config/geoleaf-config/config-validation.js';\r\nimport './static/js/config/geoleaf-config/config-loaders.js';\r\nimport './static/js/config/geoleaf-config/config-accessors.js';\r\n\r\n// Autres modules\r\nimport './static/js/geoleaf.baselayers.js';\r\nimport './static/js/geoleaf.filters.js';\r\n\r\n// POI - Sous-modules\r\nimport './static/js/poi/shared.js';\r\nimport './static/js/poi/normalizers.js';\r\nimport './static/js/poi/popup.js';\r\nimport './static/js/poi/markers.js';\r\n\r\n// POI Renderers\r\nimport './static/js/renderers/abstract-renderer.js';\r\nimport './static/js/poi/renderers/field-renderers.js';\r\nimport './static/js/poi/renderers/media-renderers.js';\r\nimport './static/js/poi/renderers/lightbox-manager.js';\r\nimport './static/js/poi/renderers/ui-behaviors.js';\r\nimport './static/js/poi/renderers/component-renderers.js';\r\nimport './static/js/poi/renderers/section-orchestrator.js';\r\nimport './static/js/poi/renderers/links.js';\r\nimport './static/js/poi/renderers/core.js';\r\nimport './static/js/poi/renderers.js';\r\nimport './static/js/poi/sidepanel.js';\r\nimport './static/js/poi/core.js';\r\nimport './static/js/geoleaf.poi.js';\r\n\r\n// POI Sync Handler + Placement Mode ‚Üí charg√©s via geoleaf-addpoi.plugin.js (optionnel)\r\n\r\n// GeoJSON - Sous-modules\r\nimport './static/js/geojson/shared.js';\r\nimport './static/js/geojson/style-resolver.js';\r\nimport './static/js/geojson/visibility-manager.js';\r\n\r\n// GeoJSON Layer Manager (√©clat√© en 4 sous-modules)\r\nimport './static/js/geojson/layer-manager/store.js';\r\nimport './static/js/geojson/layer-manager/visibility.js';\r\nimport './static/js/geojson/layer-manager/style.js';\r\nimport './static/js/geojson/layer-manager/integration.js';\r\nimport './static/js/geojson/popup-tooltip.js';\r\nimport './static/js/geojson/clustering.js';\r\nimport './static/js/geojson/layer-config-manager.js';\r\nimport './static/js/geojson/feature-validator.js';\r\n// GeoJSON Loader (√©clat√© en 4 sous-modules)\r\nimport './static/js/geojson/loader/config-helpers.js';\r\nimport './static/js/geojson/loader/data.js';\r\nimport './static/js/geojson/loader/single-layer.js';\r\nimport './static/js/geojson/loader/profile.js';\r\nimport './static/js/geojson/core.js';\r\n\r\n// Route - Sous-modules\r\nimport './static/js/route/style-resolver.js';\r\nimport './static/js/route/popup-builder.js';\r\nimport './static/js/route/loaders.js';\r\nimport './static/js/route/layer-manager.js';\r\nimport './static/js/geoleaf.route.js';\r\n\r\n// LayerManager - Sous-modules\r\nimport './static/js/layer-manager/shared.js';\r\nimport './static/js/layer-manager/renderer.js';\r\nimport './static/js/layer-manager/cache-section.js';\r\nimport './static/js/layer-manager/basemap-selector.js';\r\nimport './static/js/layer-manager/style-selector.js';\r\nimport './static/js/layer-manager/control.js';\r\nimport './static/js/geoleaf.layer-manager.js';\r\n\r\n// Legend\r\nimport './static/js/legend/legend-generator.js';\r\nimport './static/js/legend/legend-renderer.js';\r\nimport './static/js/legend/legend-control.js';\r\nimport './static/js/geoleaf.legend.js';\r\n\r\n// Labels\r\nimport './static/js/labels/label-renderer.js';\r\nimport './static/js/labels/label-button-manager.js';\r\nimport './static/js/labels/labels.js';\r\n\r\n// Themes\r\nimport './static/js/themes/theme-loader.js';\r\n\r\n// Theme Applier (√©clat√© en 4 sous-modules)\r\nimport './static/js/themes/theme-applier/core.js';\r\nimport './static/js/themes/theme-applier/visibility.js';\r\nimport './static/js/themes/theme-applier/deferred.js';\r\nimport './static/js/themes/theme-applier/ui-sync.js';\r\n\r\nimport './static/js/themes/theme-selector.js';\r\n\r\n// Table\r\nimport './static/js/table/panel.js';\r\nimport './static/js/table/renderer.js';\r\nimport './static/js/geoleaf.table.js';\r\n\r\n// Storage + Cache Button ‚Üí charg√©s via geoleaf-storage.plugin.js (optionnel)\r\n\r\n// POI Add Form ‚Üí charg√© via geoleaf-addpoi.plugin.js (optionnel)\r\n\r\n// API Controller\r\nimport './static/js/api/module-manager.js';\r\nimport './static/js/api/initialization-manager.js';\r\nimport './static/js/api/namespace-manager.js';\r\nimport './static/js/api/factory-manager.js';\r\nimport './static/js/api/controller.js';\r\n\r\n// API publique - Doit √™tre charg√© en dernier\r\nimport './static/js/geoleaf.api.js';\r\n\r\n// Application bootstrap (√©clat√© en 3 sous-modules)\r\nimport './app/helpers.js';\r\nimport './app/init.js';\r\nimport './app/boot.js';\r\n\r\n// Export du namespace global GeoLeaf\r\nexport default (typeof window !== 'undefined' ? window.GeoLeaf : {});\r\n"],"names":["global","GeoLeaf","currentLevel","quietMode","groupedMessageCounts","Map","formatPrefix","type","isRepetitiveMessage","message","some","pattern","test","isCriticalMessage","handleGroupedMessage","key","replace","count","get","set","console","info","substring","Log","setLevel","level","String","toLowerCase","warn","setQuietMode","enabled","showSummary","size","group","groupEnd","debug","args","join","error","globalThis","window","configureLogging","setTimeout","isProduction","location","hostname","includes","search","isDebug","endTime","performance","now","Math","round","document","readyState","addEventListener","Security","escapeHtml","str","div","createElement","textContent","innerHTML","escapeAttribute","validateUrl","url","baseUrl","TypeError","trim","base","origin","parsed","URL","ALLOWED_PROTOCOLS","protocol","Error","allowedDataTypes","mimeMatch","split","match","mimeType","href","e","validateCoordinates","lat","lng","Number","isFinite","RangeError","sanitizePoiProperties","props","sanitized","textFields","urlFields","value","Object","entries","this","Array","isArray","map","item","containsDangerousHtml","stripHtml","html","doc","DOMParser","parseFromString","body","innerText","createSafeElement","tagName","options","element","className","id","attributes","keys","forEach","setAttribute","children","child","Element","appendChild","sanitizeSvgContent","svgContent","parserError","querySelector","svgEl","documentElement","selector","querySelectorAll","el","remove","from","attr","name","startsWith","removeAttribute","validateNumber","min","max","Infinity","num","parseHtmlSafely","allowedTags","fragment","createDocumentFragment","cleanNode","node","nodeType","Node","TEXT_NODE","createTextNode","ELEMENT_NODE","cleanElement","hasAttribute","getAttribute","childNodes","cleanChild","CONSTANTS","DEFAULT_ZOOM","DEFAULT_CENTER","MAX_ZOOM_ON_FIT","POI_MARKER_SIZE","POI_MAX_ZOOM","POI_SWIPE_THRESHOLD","POI_LIGHTBOX_TRANSITION_MS","POI_SIDEPANEL_DEFAULT_WIDTH","ROUTE_MAX_ZOOM_ON_FIT","ROUTE_WAYPOINT_RADIUS","GEOJSON_MAX_ZOOM_ON_FIT","GEOJSON_POINT_RADIUS","FULLSCREEN_TRANSITION_MS","Utils","text","s","allowedProtocols","deepMerge","target","source","output","assign","ensureMap","explicitMap","Core","getMap","mergeOptions","defaults","override","fireMapEvent","eventName","payload","fire","err","debounce","func","wait","timeout","clearTimeout","throttle","limit","inThrottle","apply","getDistance","lat1","lng1","lat2","lng2","dLat","PI","dLng","a","sin","cos","atan2","sqrt","resolveField","obj","paths","path","DOMSecurity","createSVGIcon","width","height","pathData","svg","createElementNS","viewBox","fill","stroke","strokeWidth","strokeLinecap","strokeLinejoin","SVG_ICONS","close","check","star","home","layers","marker","download","upload","trash","copy","sync","setTextContent","setSafeHTML","clearElement","firstChild","removeChild","clearElementFast","getIcon","style","module","exports","tag","dataset","_eventContext","_cleanupArray","otherProps","events","event","cleanup","on","push","attrName","undefined","parent","DomHelpers","getElementById","required","toggleClass","force","classList","toggle","addClass","classNames","add","removeClass","hasClass","contains","setData","EventListenerManager","constructor","listeners","_nextId","handler","label","createdAt","Date","addLeafletListener","removeListener","index","findIndex","l","listener","off","removeEventListener","splice","removeListenersForTarget","matchingListeners","filter","length","removeAll","getCount","listActiveListeners","age","destroy","globalEventManager","onLeaflet","offTarget","offAll","listActive","createManager","TimerManager","timers","intervals","callback","delay","timerId","delete","setInterval","interval","intervalId","timer","clearInterval","clearAll","totalCleared","clear","getStats","timeouts","total","listActiveTimers","list","globalTimerManager","stats","_scaleCache","zoom","scale","ScaleUtils","calculateMapScale","logger","center","getCenter","getZoom","metersPerInch","pow","toFixed","toLocaleString","isScaleInRange","currentScale","minScale","maxScale","normalizedMin","normalizedMax","clearScaleCache","getColorsFromLayerStyle","poi","layerId","layerData","_GeoJSONShared","state","styleConfig","currentStyle","styleRules","categoryId","category","properties","subCategoryId","subCategory","sub_category","rule","find","r","when","field","fillColor","color","colorFill","colorStroke","defaultStyle","Helpers","StyleResolver","resolvePoiColors","colors","colorRoute","_layerConfig","styleColors","_StyleValidatorRules","validateStyleRules","rules","errors","warnings","context","ruleContext","ruleIndex","validateWhenCondition","received","legend","all","condition","condIndex","validateSimpleCondition","prefix","validOperators","operator","allowed","validateScales","styleData","scaleField","isRequired","prop","validateLegend","isInteger","order","StyleValidationError","super","validateLabelComponent","component","fieldPath","isValidHexColor","opacity","sizePx","StyleValidator","validateStyle","valid","availableFields","hasStyle","hasDefaultStyle","validateRequiredFields","idPattern","toString","validateId","labelConfig","font","sizePt","weight","validateFont","buffer","background","offset","distancePx","validateLabel","colorField","opacityField","sizeField","shape","dashArray","validateStroke","casing","validateCasing","fillPattern","validateFillPattern","validateBaseStyle","stack","formatValidationErrors","validationResult","styleFilePath","lines","JSON","stringify","slice","warning","_StyleValidator","_mapInstance","root","_map","_theme","init","L","mapId","targetEl","theme","leafletMapOptions","mapOptions","zoomControl","attributionControl","zoomSnap","zoomDelta","wheelPxPerZoomLevel","UI","applyTheme","themeError","uiConfig","Config","showLegend","Legend","position","collapsible","collapsed","legendError","onError","cbErr","initMap","b","c","d","mapCfg","uiCfg","setTheme","_applyThemeToBody","getTheme","_UITheme","THEME_KEY","THEME_LIGHT","THEME_DARK","_currentTheme","getCurrentTheme","normalized","mapContainer","StorageHelper","ThemeValidator","Validators","Theme","setItem","localStorage","updateToggleButton","dispatchEvent","CustomEvent","detail","toggleTheme","current","next","btn","isDark","title","initThemeToggle","cfg","buttonSelector","autoInitOnDomReady","doInit","initialTheme","stored","getItem","bodyTheme","resolveInitialTheme","evt","preventDefault","once","_UIControls","initFullscreenControl","Control","Fullscreen","extend","onAdd","container","DomUtil","create","link","svgEnter","svgExit","display","DomEvent","disableClickPropagation","disableScrollPropagation","debouncedInvalidateSize","invalidateSize","updateIcon","isFullscreen","toggleFullscreen","fullscreenElement","exitFullscreen","then","catch","requestFullscreen","fullscreenChangeHandler","_fullscreenChangeHandler","_toggleFullscreen","_link","_mapContainer","_debouncedInvalidateSize","onRemove","addTo","initGeolocationControl","config","ui","enableGeolocation","navigator","geolocation","userMarker","accuracyCircle","Geolocation","geoSvg","toggleGeolocation","_geolocationActive","_geolocationWatchId","clearWatch","removeLayer","_userPosition","watchPosition","latitude","longitude","accuracy","coords","setView","animate","duration","icon","divIcon","iconSize","iconAnchor","zIndexOffset","interactiveShapes","circle","radius","fillOpacity","interactive","timestamp","errorMessage","code","PERMISSION_DENIED","POSITION_UNAVAILABLE","TIMEOUT","alert","enableHighAccuracy","maximumAge","_userMarker","initPoiAddControl","showAddPoi","POI","AddForm","PlacementMode","PoiAdd","poiSvg","handleAddPoi","openForm","latlng","openAddForm","userPosition","poiAddConfig","defaultPosition","activate","result","PanelBuilder","$create","parts","i","renderText","variant","renderList","items","entry","val","line","trimmed","ul","li","renderTable","columns","wrapper","borders","borderClasses","outer","row","column","table","thead","headRow","col","th","tbody","rowObj","tr","cellVal","td","renderGallery","img","figure","imgEl","src","alt","caption","figCap","renderReviews","reviewsArray","recent","review","itemEl","header","nameSpan","authorName","rating","ratingSpan","sourceSpan","titleEl","reviewText","comment","textEl","reviewDate","date","dateEl","footer","helpfulCount","helpfulSpan","rel","createPlainSection","innerContent","extraClass","section","createAccordionSection","isOpen","Boolean","defaultOpen","titleSpan","iconSpan","p","buildLayoutItemContent","_UIDomUtils","attachAccordionBehavior","_glAccordionBound","closest","getActiveProfileConfig","getActiveProfile","profile","populateSelectOptionsFromTaxonomy","selectEl","optionsFrom","taxonomy","emptyOpt","categories","catId","cat","opt","subs","subcategories","subId","sub","catLabel","subLabel","CONTEXT","DEFAULT_COORDS_TEXT","CoordinatesDisplay","_control","_coordsElement","_boundMouseMoveHandler","_options","decimals","showCoordinates","_onMouseMove","bind","_createControl","scaleWrapper","_createStandaloneControl","CoordinatesControl","parentNode","removeControl","Branding","brandingConfig","BrandingControl","show","hasControl","hide","setText","getContainer","brandingElement","getResolveField","found","part","getLog","parseFloat","isNaN","_ContentBuilder","getEscapeHtml","validateImageUrl","validateRating","resolveBadge","displayValue","attrs","catData","subCatData","resolveBadgeTooltip","formatNumber","formatCoordinates","precision","formatRating","CSS_CLASSES","longtext","number","metric","badge","image","tags","coordinates","gallery","badgeDefault","badgeStatus","badgePriority","badgeCategory","starFull","starHalf","starEmpty","buildClassAttr","baseClass","customClass","classes","buildStyleAttr","buildLabel","wrapInParagraph","content","wrapInDiv","createStar","charAt","toUpperCase","createTag","Templates","createTextElement","createLongtextElement","createNumberElement","formatted","suffix","createMetricElement","createBadge","createRatingElement","stars","fullStars","floor","hasHalfStar","emptyStars","ratingText","createImageElement","createLinkElement","createListElement","createTableElement","data","keyLabel","createTagsElement","createCoordinatesElement","createGalleryElement","photos","photo","getHelpers","getCore","helpers","core","Logger","renderItem","enableDebug","__GEOLEAF_DEBUG_POPUP__","renderers","renderer","Assemblers","buildPopupHTML","getDefaultTitle","debugLog","sortedConfig","sortConfigByOrder","sort","renderOptions","includeIcon","resolveCategoryDisplay","sections","badgeGroup","isHeroImage","isBadge","nextItem","nextIsBadge","itemHtml","groupPopupSections","inBody","badgeHtml","assemblePopupHTML","buildTooltipHTML","resolveBadgeLabel","numValue","contentUnion","buildPanelItems","itemConfig","accordion","escaped","iconHtml","displayConfig","iconId","iconsConfig","getIconsConfig","symbolId","symbolPrefix","renderLongtext","renderNumber","renderBadge","renderImage","photoUrl","renderLink","k","v","tableStyle","tableClass","cellValue","renderTags","validTags","renderCoordinates","validPhotos","imgUrl","RENDERERS","starsHtml","getAssemblers","existingAssemblers","_UIComponents","createAccordion","accordionEl","visible","headerEl","toggleEl","bodyEl","attachEventHandler","ev","stopPropagation","isCollapsed","onToggle","renderCircleSymbol","circleEl","strokeColor","borderColor","backgroundColor","borderRadius","border","alignItems","justifyContent","iconColor","pointerEvents","use","iconHref","spriteExists","renderLineSymbol","outlineColor","outlineWidth","totalHeight","outlineLine","outlineOpacity","lineEl","backgroundImage","backgroundSize","renderPolygonSymbol","borderWidth","hasHatch","hatch","renderMode","hatchCfg","spacing","spacingPx","hatchColor","hatchOpacity","hatchWidth","widthPx","patternId","random","substr","defs","hLine","vLine","line1","line2","rect","polygonEl","renderStarSymbol","starContainer","starEl","fontSize","renderSymbol","symbolConfig","symbol","iconUrl","createToggleButton","isActive","active","toggleBtn","PRIORITY","ERROR","WARNING","SUCCESS","INFO","_UINotifications","NotificationSystem","maxVisible","maxPersistent","durations","success","animations","_eventManager","_timerManager","_activeToasts","_queue","_maxQueueSize","_metricsBuffer","_metricsBufferTimeout","_telemetryAvailable","_startMetricsBufferTimeout","_flushMetricsBuffer","typeOrOptions","_enqueue","durationOrOptions","priority","persistent","dismissible","action","lowestPriorityIndex","reduce","minIdx","idx","arr","minItem","_recordMetric","_processQueue","visibleToasts","temporaryToasts","t","persistentToasts","lastToast","isPersistent","toastToRemove","_remove","shift","_showImmediate","toast","role","messageSpan","closeBtn","onClick","requestAnimationFrame","autoRemove","timeoutId","isReorganization","parseInt","removeDelay","dismiss","toastEl","disable","enable","Storage","Telemetry","recordMetric","_escapeHtml","getStatus","initialized","activeToasts","queued","telemetryAvailable","metricsBuffered","_UIEventDelegation","_activeListeners","_listenerIdCounter","attachTrackedListener","listenerId","wrappedHandler","call","originalHandler","detachTrackedListener","has","cleanupAllListeners","cleaned","attachFilterInputEvents","filterContainer","onFilterChange","debounceMs","listenerIds","debounceTimer","matches","attachAccordionEvents","accordionButton","panel","isExpanded","attachMapControlEvents","handlers","getActiveListenersCount","getActiveListeners","_UIFilterStateManager","_filterState","values","metadata","activeProfile","observers","Set","_debounceTimers","_notifyObservers","filterId","newValue","oldValue","allValues","fromEntries","initializeFromProfile","filters","defaultValue","default","updateFilterValue","skipNotify","validatedValue","_validateFilterValue","_notifyWithDebounce","getFilterValue","getAllFilterValues","getFilterMetadata","resetAllFilters","oldState","resetValue","addObserver","hasActiveFilters","defaultVal","abs","getActiveFiltersSummary","summary","defineProperty","enumerable","ScaleControl","_config","_container","_scaleLineMetric","_numericElement","_zoomElement","_inputElement","_scalePrefix","_mainWrapper","_eventHandlers","_createMainContainer","scaleGraphic","graphicWrapper","_addGraphicScaleToContainer","scaleNumeric","scaleNivel","_createCustomScaleBlock","scaleDiv","scaleLineMetric","updateScale","y","getSize","maxMeters","distance","containerPointToLatLng","_updateScaleLine","graphicScaleUpdate","scaleLine","maxKm","ratio","maxNiceKm","_getRoundNum","maxNiceM","pow10","parentContainer","scaleNumericEditable","_createEditableScale","_createReadOnlyScale","_createZoomLevel","updateHandler","_updateScale","numericScaleUpdate","placeholder","_switchToEditMode","_onScaleInputChange","_switchToDisplayMode","focus","select","_calculateScale","_formatNumber","input","cleanedInput","targetScale","targetZoom","_calculateZoomFromScale","metersPerPixel","log2","diff","preciseZoom","initScaleControl","checked","multiple","step","_buildFilterControl","filterDef","skipLabel","labelEl","control","_populateSelectOptionsFromTaxonomy","valueLabel","initialValue","groupContainer","checkbox","searchInput","searchFields","proximityContainer","button","buttonLabel","rangeWrapper","rangeLabel","for","rangeContainer","minRadius","maxRadius","stepRadius","defaultRadius","searchConfig","panels","radiusMin","radiusMax","radiusStep","radiusDefault","rangeInput","rangeValue","instruction","instructionText","HTMLElement","controlId","_buildCategoryTreeContent","scanResult","usedCategoryIds","usedIds","esc","usedLower","catIds","subKeys","hasSubcategories","_buildTagsListContent","_attachCategoryTreeListeners","arrow","inputCat","subCb","indeterminate","inputSub","liCat","categoryCheckbox","subCheckboxes","checkedCount","cb","totalCount","_attachTagsListeners","_UIFilterPanelShared","featureToPoiLike","feature","geometry","geom","indexOf","featureToRouteLike","fid","Name","route","getBasePois","GeoJSON","getFeatures","pois","geometryTypes","fromGet","_activeProfileData","getBaseRoutes","routes","getFilterPanelElement","getNestedValue","getRepresentativePoint","midIndex","collectAllTags","tagSet","_UIFilterPanelStateReader","getDefaultState","categoriesTree","subCategoriesTree","minRating","NaN","hasMinRating","selectedTags","hasTags","dataTypes","searchText","hasSearchText","proximity","readFiltersFromPanel","panelEl","poiCheckbox","routesCheckbox","ratingInput","tagsContainer","selectedBadges","selected","resetControls","proximityWrapper","_proximityCircle","_proximityMap","_proximityMarker","_proximityMode","sel","ratingLabel","_UIFilterPanelLazyLoader","_cache","_openAccordions","loadCategories","themeId","cacheKey","_scanCategories","loadTags","_scanTags","startTime","visibleLayerIds","_getVisibleLayerIds","allFeatures","visibleFeatures","_layerId","subcategoryId","elapsed","tagsArray","totalFeatures","tagsFound","getAllLayers","layer","markAccordionOpen","markAccordionClosed","invalidateCacheForTheme","clearCache","refreshOpenAccordions","currentTheme","ThemeSelector","savedStates","_saveCheckboxStates","contentArea","lazyLoaded","_rerenderCategories","_rerenderTags","_restoreCheckboxStates","states","glFilterCategoryId","glFilterSubcategoryId","checkboxes","restoredCount","allAccordions","acc","getShared","getStateReader","_UIFilterPanelApplier","_lastApplyTime","_applyFiltersTimeout","_lastSkipRoutes","refreshPoiLayer","filteredPois","poiConfig","_clearAllForTests","addPoi","filterGeoJSONLayers","Shared","filterFeatures","hasCats","hasSubs","hasProximity","createFilterFunction","getLayerData","indexingFields","searchFilter","f","getLayerSearchFields","searchLower","propertiesFieldPath","matchesSearchText","subcategory","featureTags","point","geometryType","applyFiltersNow","skipRoutes","_applyFiltersImmediate","_debouncedApplyFilters","StateReader","basePois","baseRoutes","Route","isInitialized","filteredRoutes","Filters","filterRouteList","filterVisibility","loadFromConfig","filtered","filterPoiList","filterState","applyFiltersInitial","_UIFilterPanelRenderer","_eventCleanups","buildFilterPanelFromActiveProfile","Applier","_getActiveProfileConfig","searchPanel","toggleIcon","bodyFragment","groupEl","accordionGroup","accordionHeader","accordionTitle","accordionArrow","accordionBody","accordionWrapper","accordionClickHandler","_loadAccordionContentIfNeeded","LazyLoader","applyBtn","actions","applyLabel","resetBtn","resetLabel","_glFilterHandlersBound","containerClickHandler","toggleFilterPanelVisibility","containerKeydownHandler","keyCode","forceState","nextState","initFilterToggle","toggleClickHandler","refreshFilterTags","allItems","concat","allTags","populateTagsBadges","tagsFragment","badgeClickHandler","lazyType","themes","defautTheme","htmlContent","errDiv","_UIFilterPanelProximity","initProximityFilter","_proximityClickHandler","inputHandler","slider","proximityControl","newRadius","radiusMeters","setRadius","clickHandler","toggleProximityMode","activateGPSMode","activateManualMode","deactivateProximityMode","radiusInput","gpsLatLng","latLng","draggable","newLatLng","getLatLng","setLatLng","cursor","getApplier","getRenderer","_UIFilterPanel","Renderer","Proximity","_getFilterPanelElement","_getBasePois","_getBaseRoutes","_readFiltersFromPanel","_filterPoiList","_filterRouteList","_refreshPoiLayer","missingModules","m","checkModuleAvailability","modules","controls","panelBuilder","_UIPanelBuilder","filterPanel","notifications","eventDelegation","filterStateManager","missing","available","allAvailable","buildSidePanel","renderPoiSidePanel","renderPoiPanelWithLayout","layout","_resolveField","_createPlainSection","_createAccordionSection","getActiveFilters","Notifications","showNotification","showSuccess","showError","showWarning","showInfo","clearNotifications","_delegationInitialized","enableEventDelegation","initializeEventDelegation","getModuleStatus","_attachAccordionBehavior","VERSION","BUILD","_Normalizer","SOURCE_TYPES","GEOJSON","GPX","ROUTE","generateUniqueId","detectGeometryType","getLatLngs","latLngs","extractCoordinates","ll","getBounds","bounds","isValid","normalizeFromJSON","layerConfig","uid","guid","dataMapping","nom","description","shortDescription","latField","lngField","x","catField","subCatField","sourceType","rawData","normalizeFromGeoJSON","titleField","pop","descField","flatCoords","flat","flatten","flattenCoordinates","sumLat","sumLng","catPath","subCatPath","normalizeFromGPX","waypoint","sym","cmt","desc","lon","normalizeFromRoute","routePoint","placeId","address","normalizeFeature","autoDetectAndNormalize","normalizeCollection","dataArray","styleCache","loaderConfig","throwOnValidationError","async","loadAndValidateStyle","profileId","styleId","styleFileName","layerDirectory","stylePath","configured","endsWith","getProfilesBasePath","response","fetch","ok","status","statusText","json","jsonError","errorContext","httpStatus","parseError","visibleByDefault","extractLabelConfig","hasIntegratedLabels","loadedAt","toISOString","originalError","isIntegrated","StyleLoader","initStyleLoader","loadStyleLenient","previousThrowSetting","preloadStyles","styleConfigs","promises","results","Promise","clearStyleCache","getCacheStats","cacheEnabled","loadStyleFromLayerConfig","styleIdOrFileName","_layerDirectory","labels","styleFile","styles","file","getStylePath","_StyleLoader","LoaderModule","loadUrl","resolve","headers","strictContentType","errMsg","reject","fetchOptions","method","Accept","contentType","parseErr","jsonCfg","fetchJson","_ConfigLoader","StorageModule","getAll","segments","prototype","hasOwnProperty","getSection","sectionName","srcVal","tgtVal","getValueByPath","setValueByPath","_ConfigStorage","NormalizationModule","_safeAssign","dangerousKeys","isPoiStructNormalized","hasTitle","hasLabel","mapRawPoiToNormalized","rawPoi","mappingDef","targetPath","sourcePath","normalizePoiWithMapping","rawPoiArray","mappingConfig","mapping","poiIndex","poiId","normalizePoiArray","poiArray","baseAttributes","reviews","reviewsType","attributesReviewsType","_ConfigNormalization","TaxonomyModule","loadTaxonomy","Loader","getCategories","cats","getCategory","getSubcategory","_ConfigTaxonomy","ProfileV3Loader","loadV3Profile","taxonomyData","themesData","layersFileData","_loadTaxonomy","_loadThemes","_loadLayersFile","layersSource","layersConfigs","_loadLayerConfigs","enrichedProfile","_buildEnrichedProfile","hasTaxonomy","hasThemes","layersCount","_shouldLoadTaxonomy","taxonomyFile","Files","themesFile","layersFile","layerRef","configFile","layerManagerId","params","basePath","_profileId","dataFile","dataDir","directory","isV3Profile","version","versionMatch","_ProfileV3Loader","ProfileModule","_activeProfileId","_activeProfile","isProfilePoiMappingEnabled","dataCfg","enableProfilePoiMapping","useProfilePoiMapping","useMapping","loadActiveProfileResources","useLegacyProfileData","profilesBasePath","configData","Normalization","isPoiMappingEnabled","mappingPromise","routesPromise","_finalizeProfileLoad","mappingEnabled","_loadV3Profile","requiresMapping","profileLoaded","profileKeys","categoriesCount","profiles","_fireProfileLoadedEvent","mappingForNormalization","structurallyNormalizedPoi","normalizedPoi","safeMapping","safeRoutes","getActiveProfileId","getActiveProfilePoi","getActiveProfileRoutes","getActiveProfileMapping","icons","getActiveProfileLayersConfig","legacyEvent","createEvent","initCustomEvent","_ConfigProfile","DataConverterModule","convertPoiArrayToGeoJSON","features","convertRouteArrayToGeoJSON","routeArray","convertZoneArrayToGeoJSON","zoneArray","zone","siteName","convertGpxToGeoJSON","gpxString","gpxDoc","parseErrors","getElementsByTagName","waypoints","wpt","nameElem","descElem","symElem","geoLeafExt","tagsList","extensions","ext","j","nodeName","localName","namespaceURI","tracks","trk","trkGeoLeafExt","trkTagsList","trkExtensions","trkpts","trkpt","segmentIndex","pointCount","autoConvert","firstItem","_DataConverter","_isLoaded","_source","autoEvent","_applyConfig","_maybeFireLoadedEvent","onLoaded","loadOptions","mappingUrl","mappingOptions","mappingHeaders","mappingStrictContentType","_initSubModules","Taxonomy","Profile","_validateConfig","loggingCfg","logging","debugFlag","isLoaded","getSource","basemaps","geojson","hasOldFormat","hasNewFormat","subData","hasOldFormatSub","hasNewFormatSub","Baselayers","_activeKey","_uiBound","_baseLayers","DEFAULT_BASELAYERS","street","maxZoom","attribution","topo","satellite","_ensureMap","gl","registerBaseLayer","definition","actualKey","layerInstance","TileLayer","opts","minZoom","_normalizeOptions","tileLayer","registerBaseLayers","definitions","_refreshUI","elements","leftPanel","activeElement","activeButton","panelRect","getBoundingClientRect","buttonRect","left","setProperty","_updateActiveIndicator","setBaseLayer","previousKey","fallbackKey","silent","prev","hasLayer","nextLayer","getBaseLayers","getActiveKey","baselayers","activeKey","defaultKey","showControls","showBaseLayerControls","def","_createBaseLayerControlsUI","resizeTimeout","_bindUIOnce","setActive","getActiveLayer","BaseLayers","getSearchFieldsFromProfile","searchableFieldsSet","searchableFields","defaultFields","catsSel","subsSel","totalPOI","proximityActive","poiType","matchFound","avg","hasRating","reviewsObj","poiTags","totalRoutes","routeTags","pair","extractRouteCoords","isInRadius","_POIShared","Constants","poiLayerGroup","poiClusterGroup","allPois","poiMarkers","mapInstance","isLoading","sidePanelElement","currentPoiInPanel","sidePanelOverlay","currentGalleryIndex","constants","freeze","defaultIconUrl","ensureMapMaxZoom","fallback","_POINormalizers","normalizePoi","sanitizeUrl","longDescription","mainImage","images","price","openingHours","opening_hours","openingHoursTable","website","phone","email","services","raw","day","rest","open","hoursParts","_sidepanelConfig","getFieldValue","generatePoiId","getContentBuilder","getPopupConfig","popup","detailPopup","getTooltipConfig","detailTooltip","tooltip","buildTooltipContent","ContentBuilder","attachTooltip","bindTooltip","finalOptions","direction","_POIPopup","buildQuickPopupContent","buildFallbackPopup","manageTooltip","tooltipMode","tooltipText","permanent","attachPopup","bindPopup","maxWidth","minWidth","closeButton","autoPan","_POIMarkers","getPoiBaseConfig","showIconsOnMap","poiCfg","appearance","getComputedStyle","fillCss","getPropertyValue","strokeCss","categoriesConfig","shared","baseConfig","layerStyle","resolveCategoryColors","useIcon","showOnMap","subCat","extractMarkerCoordinates","normalizers","buildMarkerIcon","strokeOpacity","iconSizeCircle","iconSizeIcon","g","htmlIcon","popupAnchor","htmlCircle","attachMarkerEvents","_geoleafPoiData","popupModule","showPopup","popupContent","_geoleafPopupActive","closeTooltip","newLink","cloneNode","replaceChild","closePopup","showPoiDetails","getTooltip","openTooltip","originalEvent","ensureProfileSpriteInjectedSync","iconsCfg","_lastConfig","spriteUrl","svgText","overflow","insertBefore","symbolCount","createMarker","attachEvents","pane","markerOptions","_Renderers","AbstractRenderer","_name","_debug","_eventListeners","_initialized","_stateMap","WeakMap","getSecurity","getUtils","log","createHTMLElement","appendChildren","boundHandler","removeAllEventListeners","setState","getState","updateState","updates","currentState","deleteState","render","FieldRenderers","_renderTitleWithIcon","whiteSpace","lineHeight","titleH2","markers","_getMarkers","displayInfo","svgIcon","_createCategoryIcon","iconPrefix","sprite","spriteSymbol","availableSymbols","marginRight","flexShrink","innerSvg","setAttributeNS","linkP","anchor","linkText","tagsDiv","tagSpan","Renderers","instance","getInstance","MediaRenderers","imageUrl","photoDiv","loading","galleryDiv","mainDiv","_createMainImage","thumbsDiv","_createThumbnails","mainImg","thumbDiv","_createThumbnail","imgThumb","LightboxManager","currentLightbox","closeHandler","imageSrc","lightbox","cssText","_lightboxManager","UIBehaviors","attachSingleAccordionBehavior","accordions","otherAccordion","attachGalleryEvents","lightboxManager","thumbs","thumb","imgSrc","setupAll","_POIUIBehaviors","ComponentRenderers","getMarkers","to","strong","safeFrom","safeTo","safeCurrency","currency","listStyleType","tableData","separators","sep","padding","textAlign","fontWeight","borderBottom","borderLeft","rowIndex","colIndex","flexWrap","gap","maxCount","reviewDiv","paddingLeft","marginBottom","safeAuthor","safeRating","verifiedMark","verified","SectionOrchestrator","componentRenderers","fieldRenderers","mediaRenderers","_initRenderers","wrapInAccordion","details","panelContent","renderSection","fieldValue","valueType","isRequiredField","isEmpty","_POIRendererLinks","_POIRenderers","sectionOrchestrator","uiBehaviors","_POIRenderersCore","populateSidePanel","customLayout","contentDiv","detailLayout","sortedLayout","singleAccordion","renderContent","_POIRendererFields","_POIRendererMedia","_POISidePanel","createSidePanel","overlay","glMain","closeSidePanel","sidePanelContent","openSidePanel","hideSidePanel","_POICore","getNormalizers","loadAndMergeStoredPois","existingPois","checkStorageAvailable","DB","getAllFromSyncQueue","queueItems","itemTypes","data_type","data_keys","cachedPois","isPoi","poiData","itemAction","mergedPois","cachedPoi","loadAndDisplay","profilePois","displayPois","dataUrl","finally","clearLayers","clustering","addLayer","mapOrOptions","layerGroup","markerClusterGroup","maxClusterRadius","clusterRadius","disableClusteringAtZoom","showCoverageOnHover","sidePanel","_popupConfig","getAllPois","getPoiById","reload","getDisplayedPoisCount","POICore","POISidePanel","POIShared","existingRenderers","openSidePanelWithLayout","getLayer","geoJsonLayer","layerIdCounter","featureCache","defaultPointStyle","onEachFeature","pointToLayer","fitBoundsOnLoad","maxZoomOnFit","PANE_CONFIG","BASEMAP_NAME","BASEMAP_ZINDEX","LAYER_PREFIX","LAYER_BASE_ZINDEX","MIN_LAYER_ZINDEX","MAX_LAYER_ZINDEX","PaneHelpers","getPaneName","zIndex","validateZIndex","applyPaneToLayer","STYLE_OPERATORS","eq","neq","in","notIn","between","reset","_GeoJSONStyleResolver","evaluateCondition","compareFn","evaluateStyleRules","every","buildLeafletOptions","normalizeStyle","lineCap","lineJoin","finalStyle","matchedStyle","interactiveShape","pointStyle","circleMarker","_StyleRules","evaluate","operators","_LayerVisibilityManager","VisibilitySource","USER","THEME","ZOOM","SYSTEM","initVisibilityMetadata","_visibility","logicalState","userOverride","themeOverride","themeDesired","zoomConstrained","setVisibility","meta","oldVisible","oldSource","_canChangeVisibility","_updateVisibilityFlags","changed","_applyVisibilityChange","userDisabled","themeHidden","_notifyLegend","_fireVisibilityEvent","desiredVisible","layerToManage","clusterGroup","isCurrentlyOnMap","useSharedCluster","refreshClusters","LayerManager","refresh","_LabelButtonManager","syncImmediate","setLayerVisibility","Labels","refreshLabels","_hideLabelsForLayer","resetUserOverride","resetAllUserOverrides","getVisibilityState","_GeoJSONLayerManager","getLayerById","logicalVisible","detectLayerType","featureCount","getLayers","eachLayer","types","Point","LineString","Polygon","geomType","hideLayer","updateLayerZIndex","newZIndex","oldZIndex","VisibilityManager","visState","newPaneName","getPane","subLayer","_path","newPaneElement","showLayer","updateLayerVisibilityByZoom","_loadLayerLegend","hasLabelConfig","enableLabels","areLabelsEnabled","disableLabels","toggleLayer","_showLayerInternal","_hideLayerInternal","normalizeScaleValue","hasCurrentStyle","styleScale","layerScale","shouldBeVisibleByScale","baseVisible","shouldBeVisible","_fireLayerVisibilityEvent","_applyHatchToLayer","hatchConfig","mapSvg","retryCount","retryDelay","attempts","tryApplyHatch","angle","angleDeg","colorWithHash","centerX","centerY","applyToPath","fillUrl","curFillOpacity","_hatchObserver","observer","MutationObserver","mutations","mutation","attributeName","newFill","observe","attributeFilter","sublayer","_normalizeStyleToLeaflet","_casing","hatchStroke","lineH","lineV","_createHatchPattern","_hatchPatternId","setLayerStyle","leafletLayer","setStyle","normalizedStyle","styled","markersRecreated","layersToRecreate","normalizedRuleStyle","styleFn","Polyline","casingConfig","_casingLayer","casingStyle","polyline","setZIndex","_hatchListener","Marker","POIMarkers","newIcon","setIcon","newMarker","hasHatchInRules","_hatchListeners","onLayerAdd","registerWithLayerManager","LMgr","_registerGeoJsonLayer","sectionMap","sectionId","legendType","hasLabels","labelsConfig","hasConfig","hasStyles","configKeys","toggleable","loadLayerLegend","styleSelector","_LayerManagerStyleSelector","getCurrentStyle","currentStyleMetadata","defaultFile","defaultByFile","addLayerLegend","legends","activeStyle","legendEntry","layerDir","legendDir","legendPath","legendData","populateLayerManagerWithAllConfigs","activeThemeConfig","_allLayerConfigs","activeThemeLayers","_updateUI","_GeoJSONPopupTooltip","convertFeatureToPOI","Normalizer","NAME","TITLE","Title","LABEL","Label","layerLabel","_GeoJSONLoader","sidepanelLayout","getSidepanelConfig","bindUnifiedPopup","unbindTooltip","getPopup","popupConfig","markersModule","popupHtml","popupEl","getElement","bindUnifiedTooltip","tooltipMinZoom","tooltipConfig","featureAsPoi","updateTooltipVisibility","shouldShow","POIPopup","setContent","_geoleafTooltipUpdate","_GeoJSONClustering","getPoiConfig","getSharedPOICluster","poiLayer","hasAddLayer","hasRemoveLayer","hasFeatureGroup","_featureGroup","hasGroup","_group","hasClusterGroup","_markerCluster","isMarkerClusterGroup","getClusteringStrategy","geojsonData","clusteringConfig","isClusteringEnabled","shouldCluster","disableAtZoom","clusterStrategy","strategy","clusterStrategies","sources","geojsonClustering","createIndependentCluster","spiderfyOnMaxZoom","zoomToBoundsOnClick","_GeoJSONLayerConfig","resolveDataFilePath","inferGeometryType","first","buildLayerOptions","baseOptions","mergedOptions","paneName","PopupTooltip","convertedPopup","fields","sidepanelConfig","originalOnEachFeature","layerDef","legendsConfig","legendDirectory","legendFile","loadLegend","loadDefaultStyle","_GeoJSONFeatureValidator","validateFeatureCollection","collection","validFeatures","validateFeature","featureId","severity","geomResult","validateGeometry","propsResult","validateProperties","validTypes","distance_km","duration_min","isValidUrl","isValidEmail","popupFields","tooltipFields","sidepanelFields","sidepanel","_resolveDataFilePath","_inferGeometryType","_buildLayerOptions","_loadDefaultStyle","FetchHelper","retries","addData","dataToAdd","fitOptions","fitBounds","_loadSingleLayer","fromCache","_cachedData","DataConverter","PaneConfig","layerOptions","geoJSON","ClusteringModule","poiCluster","tempLayerData","pendingSharedCluster","independentCluster","inferredGeometry","allLayerIds","validatedZIndex","layerBasePath","ThemeCache","store","contentLength","layerDataForStyle","initializeLayerLabels","loadFromActiveProfile","layersDef","geojsonLayers","layersConfig","self","tasks","layerUrl","normalizedDef","showTooltip","mode","_loadLayersByBatch","loadedLayers","onMoveEnd","batchSize","batch","batchStart","batchResults","fn","batchDuration","ceil","loadAllLayersConfigsForLayerManager","allConfigs","getStyleResolver","getLayerManager","getLoader","getClustering","GeoJSONModule","_layerGroup","_geoJsonLayer","_layers","_featureCache","_validateOptions","createPane","featureGroup","leafletOptions","filterFn","layerIds","geoType","typeAliases","linestring","area","normalizedType","layerGeoType","bypassFilter","_filteredOutLayers","toShow","toHide","_geoleafFiltered","layerElement","_originalOpacity","_originalFillOpacity","clearFeatureFilter","geometrySet","layerSet","clone","_updateLayerVisibilityByZoom","_registerWithLayerManager","_convertFeatureToPOI","_getClusteringStrategy","Clustering","_getSharedPOICluster","_getPoiConfig","_detectLayerType","_buildLeafletOptions","_RouteStyleResolver","getRouteColor","routeConfigDefault","resolveRouteStyle","taxonomyColor","resolveEndpointConfig","profileEndpoints","moduleOptions","baseStartStyle","startWaypointStyle","waypointStyle","baseEndStyle","endWaypointStyle","showStart","showEnd","startStyle","endStyle","start","end","_RoutePopupBuilder","addRouteTooltip","sticky","addRoutePopup","buildRoutePopupContent","linkEl","openRouteSidePanel","getRoutePopupConfig","routeAsPoi","difficulty","convertRouteToPOI","routeId","defaultIcon","metaText","metaItems","diffLabels","easy","medium","hard","tagBadges","buildFallbackRoutePopup","getRouteLayoutConfig","description_long","_RouteLoaders","loadGPX","applyRouteCallback","res","xmlText","gpx","pt","loadGeoJSON","extractCoordsFromRouteItem","allCoords","segment","_RouteLayerManager","applyRoute","clearCallback","fireEventsCallback","routeLayer","lineStyle","setLatLngs","fitOpt","addWaypoint","addSegment","fireRouteLoadedEvents","RouteModule","_routeLayer","_visible","isVisible","toggleVisibility","parseResponse","_applyRoute","defaultSettings","routeConfig","endpoints","_extractCoordsFromRouteItem","routeStyle","_resolveRouteStyle","_geoleafRouteData","_addRouteTooltip","_addRoutePopup","endpointCfg","_resolveEndpointConfig","startLatLng","endLatLng","_fireRouteLoadedEvents","visibleRouteIds","_getRouteColor","_buildRoutePopupContent","_openRouteSidePanel","_LayerManagerShared","_LayerManagerRenderer","renderSections","isCollapsible","collapsedByDefault","sectionEl","wasCollapsed","_isExpanded","sectionBody","_LayerManagerBasemapSelector","_renderItems","createEmptyMessage","syncToggles","layerItems","_checkLayerVisibility","hasLayerData","hasVisibility","currentValue","onMap","onClass","listEl","mainRow","_renderToggleControls","controlsContainer","createButton","_createToggleFallback","_attachToggleHandler","styleElement","renderDOM","bindEvents","itemId","_toggleHandlerAttached","_isToggling","disabled","ThemeApplier","_ThemeApplier","_loadLayerFromProfile","loadedLayer","layerItem","labelBtn","parentElement","ld","isCurrentlyVisible","CacheSection","generateSection","customContent","_generateContent","_attachEventListeners","downloadBtn","clearBtn","_handleDownload","_handleClear","_updateStatus","isAvailable","CacheManager","getCacheStatus","quota","getStorageQuota","profileEl","stateEl","sizeEl","quotaEl","resourcesCount","totalSize","progressEl","progressText","downloadProfileForOffline","confirm","deleted","_LayerManagerCacheSection","activeId","getActiveId","_attachChangeHandler","_attachExternalListener","currentStyles","setCurrentStyle","selectId","option","applyStyle","layerManager","_applyStyleLegacy","_LayerManagerControl","initialize","controlOptions","setOptions","_glOptions","_buildStructure","mainWrapper","headerWrapper","_toggleCollapsed","bodyWrapper","_bodyEl","_renderSections","updateSections","LayerManagerModule","_refreshTimeout","_mergeOptions","_loadConfigSections","_autoPopulateBasemap","_autoPopulateSections","layerManagerConfig","sectionsCount","configSections","configSection","existingSection","basemapSection","basemapDefs","autoSections","baseItems","legendSection","legendSectionLabel","_updateContent","_unregisterGeoJsonLayer","addSection","existingIndex","existing","newItem","existingItemIndex","toggleCollapse","immediate","shouldUseIcons","generateLegendItem","baseStyle","mergedStyle","generatePointSymbol","generateLineSymbol","applyOpacityProperties","generatePolygonSymbol","iconResolution","fclassMappings","archaeological","museum","camp_site","hotel","catKey","resolveRuleIcons","fullIconId","hasRule","hasCategories","isCategoryId","categoryKey","getIconFromTaxonomy","_LegendGenerator","generateLegendFromStyle","itemsContainer","textContainer","_LegendRenderer","renderFooter","footerEl","fontStyle","renderAccordion","accordionData","toggleAccordion","ensureSpriteLoaded","_alreadyLogged","maxAttempts","checkInterval","checkSprite","spriteEl","_spriteDetected","_LegendControl","_renderContent","updateMultiLayerContent","legendsArray","spriteLoaded","updateContent","_profileConfig","_taxonomyData","_rebuildTimer","_loadingOverlayEl","_loadingOverlayTimer","_allLayers","_scheduleRebuild","LegendModule","_rebuildDisplay","_clearOverlayTimeout","_hideLoadingOverlay","legendConfig","allConfig","_initializeAllLayers","layerInfo","rawGeometry","_normalizeGeometryType","originalPOIShared","addControl","visibilityManager","removeLayerLegend","updateLayerLegend","hideLegend","removeLegend","isLegendVisible","showLoadingOverlay","styleEl","head","_ensureSpinnerStyles","inset","spinner","borderTop","animation","_showLoadingOverlay","hideLoadingOverlay","_LabelRenderer","createTooltipsForLayer","tooltipsMap","labelId","hasLeafletLayer","labelConfigKeys","labelField","featureLayer","_createTooltipForFeature","labelValue","_extractFieldValue","positionType","hasLat","hasLng","latType","lngType","positionKeys","latlngs","flatLatlngs","_formatLabelContent","labelIcon","_buildClassName","labelMarker","keyboard","_parseOffset","_applyInlineStyles","outerHTML","family","fontFamily","bold","italic","bufferColor","bufferOpacity","bufferSize","rgba","_hexToRgba","shadowParts","rad","textTransform","hex","LabelButtonManager","hasContainer","existingButton","labelToggle","onLabelToggle","toggleLabels","visibilityToggle","_syncTimeouts","_doSync","_getState","_applyState","layerExists","layerVisible","labelEnabled","areLabelsActive","_state","zoomListenerAttached","_attachLayerEvents","_getLayerData","showImmediately","labelStyleConfig","integratedLabel","labelScale","effectiveShowImmediately","labelStyle","tooltips","shouldShowLabels","isLayerVisible","_createLabelsForLayer","_ensureZoomListener","layerState","_calculateMapScale","_isScaleInRange","currentZoom","rendererConfig","_handleZoomChange","_handleLayerLoaded","isShowing","_getProfileId","_loadingPromises","_ThemeLoader","loadThemesConfig","themesPath","pathname","loadPromise","validated","validatedConfig","primaryThemes","secondaryThemes","showNavigationButtons","defaultTheme","_currentThemeId","_isFirstLoad","_init","_pendingLayerConfigs","_pendingCheckTimer","_cleanup","themeName","_hideAllLayers","layerConfigs","profileConfig","perfConfig","visibleLayers","BATCH_SIZE","themeBatchSize","updateProgress","_glLoadingScreen","_applyLayerConfig","loadInBatches","_syncLegendVisibility","themeNotificationEvent","layerCount","totalLayersInTheme","_fitBoundsOnAllLayers","getCurrentThemeId","TA","_setLayerVisibilityAndStyle","_scheduleLayerConfig","availableStyles","effectiveStyleId","styleExists","fallbackStyleId","_updateStyleSelector","_loadLegendForStyle","_schedulePendingCheck","_checkPendingLayerConfigs","appliedLayers","profileLayersConfig","Layers","loader","cachedData","_getProfilesBasePath","_normalizeBasePath","layersMap","tempGroup","markerLayer","getLayerGroup","routeGroup","time","primaryContainer","secondaryContainer","dropdown","themesConfig","primary","secondary","_createUI","showThemeSelector","_createPrimaryUI","_createSecondaryUI","_attachPrimaryButtonHandler","prevBtn","_attachNavButtonHandler","currentIsSecondary","_attachDropdownHandler","nextBtn","onChange","nextTheme","previousTheme","_updateUIState","isSecondary","nextIndex","prevIndex","prevTheme","getThemes","getPrimaryThemes","getSecondaryThemes","parseHeight","referenceHeight","vh","innerHeight","populateLayerSelector","allLayers","existingValues","addedCount","_TablePanel","defaultHeight","resizable","resizeHandle","handle","resizeBar","isResizing","startY","startHeight","mouseDownHandler","clientY","offsetHeight","userSelect","mouseMoveHandler","delta","newHeight","viewportHeight","minHeightPx","minHeight","maxHeightPx","maxHeight","mouseUpHandler","createResizeHandle","toolbar","layerSelect","defaultOption","changeHandler","Table","setLayer","createLayerSelector","createSearchInput","zoomButton","zoomToSelection","highlightButton","highlightSelection","enableExportButton","exportButton","exportSelection","spacer","flex","downSvg","createToolbar","tableWrapper","upSvg","createFloatingShowButton","updateToolbarButtons","selectedCount","hasSelection","zoomBtn","highlightBtn","exportBtn","refreshLayerSelector","optionValues","o","handleRowSelection","shiftKey","ctrlKey","isCheckbox","currentSelection","getSelectedIds","targetId","rows","lastSelected","targetIndex","lastIndex","rangeIds","setSelection","updateToolbarButtonsState","selectRange","newSelection","clearSelection","_TableRenderer","_syntheticIdCounter","selectedIds","sortState","thCheckbox","checkboxAll","checkboxAllHandler","ids","toggleAllRows","sortable","sortIcon","sortHandler","sortByField","createTableHead","osm_id","OBJECTID","SITE_ID","IN1","getFeatureId","isSelected","tdCheckbox","checkboxHandler","formattedValue","getTime","toLocaleDateString","formatValue","rowClickHandler","metaKey","createTableRow","createTableBody","virtualScrolling","pageSize","applyVirtualScrolling","updateSelection","totalRows","TableModule","_currentLayerId","_selectedIds","_featureIdMap","_highlightLayers","_highlightActive","_sortState","_isVisible","globalConfig","defaultVisible","maxRowsPerLayer","_attachMapEvents","refreshSelectorTimer","debouncedRefreshSelector","_getAvailableVisibleLayers","_fireEvent","_clearHighlightLayers","_getAvailableLayers","defaultSort","_getLayerFeatures","syntheticCounter","_resolveFeatureId","_applySorting","maxRows","availableLayers","valA","_getNestedValue","valB","localeCompare","selectedFeatures","_getSelectedFeatures","latLngBounds","_extendBoundsFromGeometry","highlightStyle","highlightLayer","blob","Blob","createObjectURL","click","revokeObjectURL","syntheticIndex","poly","APIModuleManager","aliases","totalModules","accessCount","_scanExistingModules","_setupAliases","alias","getModule","targetName","registerModule","hasModule","getModuleList","moduleNames","cachedModules","API","ModuleManager","APIInitializationManager","isReady","pendingPromise","cancelled","initCalls","configLoads","_validateInitParams","normalizedOptions","_normalizeInitOptions","loadConfig","_normalizeConfigOptions","mapOpts","uiOpts","hasPendingRequest","InitializationManager","APINamespaceManager","operations","NamespaceManager","APIFactoryManager","mapInstances","mapsCreated","createMap","getMapInstance","getAllMapInstances","activeInstances","FactoryManager","APIController","managers","moduleAccessFn","healthStatus","lastUpdate","_initializeManagers","_setupModuleAccess","_validateInitialization","ManagerClass","_getManagerClass","manager","initialization","namespace","factory","failures","failureNames","geoleafInit","_ensureInitialized","geoleafLoadConfig","geoleafSetTheme","geoleafCreateMap","getHealthStatus","managersCount","hasModuleAccess","Controller","_APIController","controllerInstance","THEMES","getNamespace","getAllMaps","removeMap","getHealth","getMetrics","_app","AppLog","checkPlugins","storage","enableServiceWorker","_SWRegister","SyncHandler","initApp","mapTarget","uiTheme","profileBounds","profileMaxZoom","profilePadding","mapCenter","storageConfig","indexedDB","cache","enableProfileCache","enableTileCache","offline","enableOfflineDetector","notificationContainer","_loadingToast","pendingProfileToastDetail","tryShowProfileToast","notificationsReady","shown","tableConfig","CacheButton","baseLayersModule","basemapsFromConfig","defaultBasemap","poiApi","showFilterPanel","poiItem","hasBoundsFromProfile","hasGeoJSONLayers","routeApi","geoJsonApi","currentProfileId","getActiveTheme","showLayerManager","_appRevealed","revealApp","reason","pan","startApp","selectedProfile","sessionStorage","removeItem","profilesPath","baseCfg","profileCfg","boot","bundleEntry"],"mappings":"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"}