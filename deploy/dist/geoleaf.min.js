/* GeoLeaf v4.0.0 | MIT License | github.com/mattpottier-ship-it/geoleaf-js */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).GeoLeaf={})}(this,function(e){"use strict";const t={DEBUG:0,INFO:1,WARN:2,ERROR:3};let o=t.INFO,n=0;const r=new Map,i=e=>`[GeoLeaf.${e}]`,a=e=>[/Chargement du sprite SVG/,/Sprite SVG d\xe9tect\xe9/,/IconsConfig r\xe9cup\xe9r\xe9/,/Module.*charg\xe9/,/Module.*initialis\xe9/,/Contr\xf4le.*ajout\xe9/,/Bouton.*ajout\xe9/,/Panneau.*cr\xe9\xe9/,/Section.*remplie/,/Profil.*charg\xe9/,/Couche.*charg\xe9e/,/Style.*appliqu\xe9/,/ThemeApplier/,/LayerManager/,/Storage/,/CacheButton/,/Renderers\./,/FormRenderer/,/ResourceEnumerator/,/LayerSelector/,/CacheControl/,/POI.*DEBUG/,/AddForm/].some(t=>t.test(e)),l=e=>[/ERROR/,/WARN/,/Failed/,/Error/,/Exception/,/Carte initialis\xe9e avec succ\xe8s/,/All.*modules loaded/,/Mode.*activ\xe9/].some(t=>t.test(e)),s=e=>{const t=e.replace(/\d+/g,"X").replace(/[{}:,]/g,""),o=(r.get(t)||0)+1;if(r.set(t,o),r.size>200){const e=r.keys().next().value;r.delete(e)}return 1===o?1:3!==o||l(e)?o>3?0:o<=2:(console.info(`${i("INFO")} [Group\xe9] Message r\xe9p\xe9t\xe9 - suite masqu\xe9e: ${e.substring(0,60)}...`),0)},c={setLevel(e){switch(String(e).toLowerCase()){case"debug":o=t.DEBUG;break;case"info":o=t.INFO;break;case"warn":o=t.WARN;break;case"error":o=t.ERROR;break;case"production":o=t.WARN,n=1;break;default:console.warn(`${i("WARN")} Niveau de log inconnu :`,e)}},getLevel:()=>o,getLevelName(){for(const[e,n]of Object.entries(t))if(n===o)return e;return"UNKNOWN"},setQuietMode(e){n!==e&&(n=e,e&&console.info(`${i("INFO")} Mode silencieux activ\xe9 - logs r\xe9p\xe9titifs r\xe9duits`))},showSummary(){if(r.size>0){console.group(`${i("INFO")} R\xe9sum\xe9 des logs group\xe9s:`);for(const[e,t]of r)t>3&&console.info(`\u2022 ${t}x: ${e.substring(0,60)}...`);console.groupEnd()}},debug(...e){if(o<=t.DEBUG){const t=e.join(" ");if(n&&a(t)&&!s(t))return;i("DEBUG")}},info(...e){if(o<=t.INFO){const t=e.join(" ");if(n){if(l(t))return void console.info(i("INFO"),...e);if(a(t)&&!s(t))return}console.info(i("INFO"),...e)}},warn(...e){o<=t.WARN&&console.warn(i("WARN"),...e)},error(...e){o<=t.ERROR&&console.error(i("ERROR"),...e)}},u="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{},d=new Proxy(c,{get(e,t,o){const n=u.GeoLeaf&&u.GeoLeaf.Log;return n&&n!==c&&n!==o&&t in n?n[t]:c[t]}});class GeoLeafError extends Error{constructor(e,t={}){super(e),this.name=this.constructor.name,this.context=t,this.timestamp=(new Date).toISOString(),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}toJSON(){return{name:this.name,message:this.message,context:this.context,timestamp:this.timestamp,stack:this.stack}}toString(){const e=Object.keys(this.context).length>0?` [Context: ${JSON.stringify(this.context)}]`:"";return`${this.name}: ${this.message}${e}`}}class ValidationError extends GeoLeafError{constructor(e,t={}){super(e,t),this.code="VALIDATION_ERROR"}}class SecurityError extends GeoLeafError{constructor(e,t={}){super(e,t),this.code="SECURITY_ERROR"}}class ConfigError extends GeoLeafError{constructor(e,t={}){super(e,t),this.code="CONFIG_ERROR"}}class NetworkError extends GeoLeafError{constructor(e,t={}){super(e,t),this.code="NETWORK_ERROR"}}class InitializationError extends GeoLeafError{constructor(e,t={}){super(e,t),this.code="INITIALIZATION_ERROR"}}class MapError extends GeoLeafError{constructor(e,t={}){super(e,t),this.code="MAP_ERROR"}}class DataError extends GeoLeafError{constructor(e,t={}){super(e,t),this.code="DATA_ERROR"}}class POIError extends GeoLeafError{constructor(e,t={}){super(e,t),this.code="POI_ERROR"}}class RouteError extends GeoLeafError{constructor(e,t={}){super(e,t),this.code="ROUTE_ERROR"}}class UIError extends GeoLeafError{constructor(e,t={}){super(e,t),this.code="UI_ERROR"}}const f=Object.freeze({VALIDATION:"VALIDATION_ERROR",SECURITY:"SECURITY_ERROR",CONFIG:"CONFIG_ERROR",NETWORK:"NETWORK_ERROR",INITIALIZATION:"INITIALIZATION_ERROR",MAP:"MAP_ERROR",DATA:"DATA_ERROR",POI:"POI_ERROR",ROUTE:"ROUTE_ERROR",UI:"UI_ERROR"});function p(e,t,o={}){const n=new e(t,o);return Error.captureStackTrace&&Error.captureStackTrace(n,p),n}const g={GeoLeafError,ValidationError,SecurityError,ConfigError,NetworkError,InitializationError,MapError,DataError,POIError,RouteError,UIError,normalizeError:function(e,t="An unknown error occurred"){if(e instanceof Error)return e;if("string"==typeof e)return new GeoLeafError(e);if(e&&"object"==typeof e){const o=e.message||e.error||t;return new GeoLeafError(o,{originalError:e})}return new GeoLeafError(t,{originalError:e})},isErrorType:function(e,t){return e instanceof t},getErrorCode:function(e){return e&&"object"==typeof e&&"code"in e?e.code:"UNKNOWN_ERROR"},createError:p,createErrorByType:function(e,t,o={}){return p({validation:ValidationError,security:SecurityError,config:ConfigError,network:NetworkError,initialization:InitializationError,map:MapError,data:DataError,poi:POIError,route:RouteError,ui:UIError}[e.toLowerCase()]||GeoLeafError,t,o)},sanitizeErrorMessage:function(e,t=500){if(null==e)return"Unknown error";let o="string"==typeof e?e:String(e);return o=o.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"),o.length>t&&(o=o.slice(0,t)+"..."),o},safeErrorHandler:function(e,t){if("function"==typeof e)try{e(t)}catch(e){d.error("[GeoLeaf.Errors] Error in error handler:",e),d.error("[GeoLeaf.Errors] Original error:",t)}},ErrorCodes:f},h=Object.freeze({DEFAULT_ZOOM:3,DEFAULT_CENTER:[0,0],MAX_ZOOM_ON_FIT:15,POI_MARKER_SIZE:12,POI_MAX_ZOOM:18,POI_SWIPE_THRESHOLD:50,POI_LIGHTBOX_TRANSITION_MS:300,POI_SIDEPANEL_DEFAULT_WIDTH:420,ROUTE_MAX_ZOOM_ON_FIT:14,ROUTE_WAYPOINT_RADIUS:5,GEOJSON_MAX_ZOOM_ON_FIT:15,GEOJSON_POINT_RADIUS:6,FULLSCREEN_TRANSITION_MS:10});function y(e){if(null==e)return"";"string"!=typeof e&&(e=String(e));const t=document.createElement("div");return t.textContent=e,t.innerHTML}function m(e){return null==e?"":("string"!=typeof e&&(e=String(e)),e.replace(/&/g,"&amp;").replace(/'/g,"&#39;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;"))}function b(e,t){if(!e||"string"!=typeof e)throw new TypeError("URL must be a non-empty string");e=e.trim();const o="undefined"!=typeof globalThis&&globalThis.location?globalThis.location:"undefined"!=typeof location?location:null,n=t||o&&o.origin||"https://localhost";try{const t=new URL(e,n),o=["http:","https:","data:"];if(!o.includes(t.protocol))throw new Error(`Protocol "${t.protocol}" not allowed. Allowed protocols: ${o.join(", ")}`);if("data:"===t.protocol){const t=["image/png","image/jpeg","image/jpg","image/gif","image/svg+xml","image/webp"],o=e.split(",")[0].match(/data:([^;,]+)/);if(!o)throw new Error("Invalid data URL format");if(!t.includes(o[1]))throw new Error(`Data URL type "${o[1]}" not allowed. Allowed: ${t.join(", ")}`)}return t.href}catch(t){if(t.message.includes("not allowed"))throw t;throw new Error(`Invalid URL "${e}": ${t.message}`)}}function _(e,t){if("number"!=typeof e||"number"!=typeof t)throw new TypeError(`Coordinates must be numbers, got lat=${typeof e}, lng=${typeof t}`);if(!Number.isFinite(e)||!Number.isFinite(t))throw new RangeError("Coordinates must be finite numbers (not NaN or Infinity)");if(e<-90||e>90)throw new RangeError(`Latitude must be between -90 and 90, got ${e}`);if(t<-180||t>180)throw new RangeError(`Longitude must be between -180 and 180, got ${t}`);return[e,t]}function v(e){if("string"!=typeof e)return"";const t=(new DOMParser).parseFromString(e,"text/html");return t.body.textContent||t.body.innerText||""}function w(e,t=["p","br","strong","em","span","a","ul","ol","li","b","i"]){const o=document.createDocumentFragment();if(!e||"string"!=typeof e)return o;try{const n=(new DOMParser).parseFromString(e,"text/html"),r=e=>{if(e.nodeType===Node.TEXT_NODE)return document.createTextNode(e.textContent);if(e.nodeType!==Node.ELEMENT_NODE)return null;const o=e.tagName.toLowerCase();if(!t.includes(o))return document.createTextNode(e.textContent);const n=document.createElement(o);if("a"===o&&e.hasAttribute("href"))try{const t=b(e.getAttribute("href"));n.setAttribute("href",t),n.setAttribute("rel","noopener noreferrer"),n.setAttribute("target","_blank")}catch(e){}return e.childNodes.forEach(e=>{const t=r(e);t&&n.appendChild(t)}),n};n.body.childNodes.forEach(e=>{const t=r(e);t&&o.appendChild(t)})}catch(e){d.warn("[Security] Erreur parsing HTML s\xe9curis\xe9:",e.message)}return o}const C={escapeHtml:y,escapeAttribute:m,validateUrl:b,validateCoordinates:_,sanitizePoiProperties:function e(t){if(!t||"object"!=typeof t)return{};const o={},n=["label","name","title","description","desc","address","phone","email","category","type"],r=["url","website","image","photo","icon"];for(const[i,a]of Object.entries(t))if("function"!=typeof a&&"symbol"!=typeof a)if(null!=a)if(n.includes(i)&&"string"==typeof a)o[i]=y(a);else if(r.includes(i)&&"string"==typeof a)try{o[i]=b(a)}catch(e){d.warn(`[Security] Invalid URL for ${i}: ${e.message}`),o[i]=""}else Array.isArray(a)?o[i]=a.map(t=>"object"==typeof t&&null!==t?e(t):"string"==typeof t?y(t):t):o[i]="object"==typeof a&&null!==a?e(a):a;else o[i]="";return o},containsDangerousHtml:function(e){return"string"!=typeof e?0:[/<script/i,/javascript:/i,/on\w+\s*=/i,/<iframe/i,/<object/i,/<embed/i,/<applet/i,/<meta/i,/<link/i,/vbscript:/i,/data:text\/html/i].some(t=>t.test(e))},stripHtml:v,createSafeElement:function(e,t={}){const o=document.createElement(e);return t.className&&(o.className=t.className),t.id&&(o.id=t.id),t.textContent&&(o.textContent=t.textContent),t.attributes&&Object.keys(t.attributes).forEach(e=>{o.setAttribute(e,m(t.attributes[e]))}),t.children&&Array.isArray(t.children)&&t.children.forEach(e=>{e instanceof Element&&o.appendChild(e)}),o},sanitizeSvgContent:function(e){if(!e||"string"!=typeof e)return null;try{const t=(new DOMParser).parseFromString(e,"image/svg+xml"),o=t.querySelector("parsererror");if(o)return d.warn("[Security] Erreur parsing SVG:",o.textContent),null;const n=t.documentElement;return n&&"svg"===n.tagName.toLowerCase()?(["script","foreignObject","use[href^='data:']"].forEach(e=>{n.querySelectorAll(e).forEach(e=>e.remove())}),n.querySelectorAll("*").forEach(e=>{Array.from(e.attributes).forEach(t=>{t.name.toLowerCase().startsWith("on")&&e.removeAttribute(t.name),"href"!==t.name&&"xlink:href"!==t.name||!t.value.toLowerCase().trim().startsWith("javascript:")||e.removeAttribute(t.name)})}),n):(d.warn("[Security] Contenu SVG invalide: \xe9l\xe9ment racine n'est pas SVG"),null)}catch(e){return d.warn("[Security] Erreur sanitization SVG:",e.message),null}},validateNumber:function(e,t=-1/0,o=1/0){const n=Number(e);return Number.isFinite(n)?n<t||n>o?null:n:null},parseHtmlSafely:w,sanitizeHTML:function(e,t,o={}){if(!e||"function"!=typeof e.appendChild)return null;if(null==t)return e.innerHTML="",e;const n="string"==typeof t?t:String(t);if(o.trusted&&d.warn("[GeoLeaf.Security] sanitizeHTML({ trusted: true }) is deprecated and ignored. All content is now sanitized."),o.stripAll)return e.textContent=v(n),e;const r=w(n,o.allowedTags||["p","br","strong","em","span","a","ul","ol","li","b","i"]);return e.innerHTML="",e.appendChild(r),e}},I="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{},S={_token:null,_tokenExpiry:null,_tokenDuration:36e5,_refreshIntervalId:null,init(){try{this._token=this._generateToken(),this._tokenExpiry=Date.now()+this._tokenDuration,this._startAutoRefresh(),d.info("[CSRF] Token initialized")}catch(e){d.error("[CSRF] Init failed \u2014 crypto.getRandomValues unavailable:",e.message),this._token=null}},_generateToken(){if(I.crypto&&I.crypto.getRandomValues){const e=new Uint8Array(32);return I.crypto.getRandomValues(e),btoa(String.fromCharCode.apply(null,e)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}throw d.error("[CSRF] crypto.getRandomValues not available \u2014 CSRF protection disabled"),new Error("[CSRF] Secure random number generation not available")},getToken(){if(!this._token||Date.now()>=this._tokenExpiry){d.info("[CSRF] Token expired, generating new one");try{this._token=this._generateToken(),this._tokenExpiry=Date.now()+this._tokenDuration}catch(e){d.error("[CSRF] Token generation failed:",e.message),this._token=null}}return this._token},validateToken(e){return e&&"string"==typeof e?e===this._token&&Date.now()<this._tokenExpiry?1:(d.warn("[CSRF] Token validation failed"),0):0},addTokenToData(e){const t=this.getToken();return e instanceof FormData?e.append("csrf_token",t):"object"==typeof e&&null!==e&&(e.csrf_token=t),e},addTokenToHeaders(e={}){const t=this.getToken();return e.headers||(e.headers={}),e.headers["X-CSRF-Token"]=t,e},createTokenInput(){const e=document.createElement("input");return e.type="hidden",e.name="csrf_token",e.value=this.getToken(),e.className="csrf-token-input",e},addTokenToForm(e){if(!(e&&e instanceof HTMLFormElement))return void d.error("[CSRF] Invalid form element");const t=e.querySelector('input[name="csrf_token"]');t?t.value=this.getToken():e.appendChild(this.createTokenInput())},validateFormToken(e){let t;return e instanceof FormData?t=e.get("csrf_token"):"object"==typeof e&&null!==e&&(t=e.csrf_token),this.validateToken(t)},setSecureCookie(e,t,o={}){const{maxAge:n=3600,path:r="/",sameSite:i="Strict",secure:a=1}=o;let l=`${encodeURIComponent(e)}=${encodeURIComponent(t)}`;l+=`; Max-Age=${n}`,l+=`; Path=${r}`,l+=`; SameSite=${i}`,a&&I.location&&"https:"===I.location.protocol&&(l+="; Secure"),document.cookie=l,d.info(`[CSRF] Secure cookie set: ${e}`)},_startAutoRefresh(){const e=this._tokenDuration-3e5;this._refreshIntervalId=setInterval(()=>{if(d.info("[CSRF] Auto-refreshing token"),this._token=this._generateToken(),this._tokenExpiry=Date.now()+this._tokenDuration,"undefined"!=typeof CustomEvent){const e=new CustomEvent("geoleaf:csrf:refreshed",{detail:{token:this._token}});document.dispatchEvent(e)}},e)},destroy(){null!==this._refreshIntervalId&&(clearInterval(this._refreshIntervalId),this._refreshIntervalId=null),this._token=null,this._tokenExpiry=null},rotateToken(){if(d.info("[CSRF] Rotating token"),this._token=this._generateToken(),this._tokenExpiry=Date.now()+this._tokenDuration,"undefined"!=typeof CustomEvent){const e=new CustomEvent("geoleaf:csrf:rotated",{detail:{token:this._token}});document.dispatchEvent(e)}},getTokenInfo(){return{hasToken:!!this._token,expiresIn:this._tokenExpiry?Math.max(0,this._tokenExpiry-Date.now()):0,isValid:this._token&&Date.now()<this._tokenExpiry}}},E={_config:null,init(e){this._config=e},getAll(){return this._config||{}},get(e,t){if(!this._config||!e||"string"!=typeof e)return void 0===t?void 0:t;const o=this.getValueByPath(this._config,e);return void 0===o?void 0===t?void 0:t:o},set(e,t){if(!this._config)return void d.warn("[GeoLeaf.Config.Storage] Configuration non initialis\xe9e.");if(!e||"string"!=typeof e)return void d.warn("[GeoLeaf.Config.Storage] set() requiert un chemin string.");const o=e.split(".");let n=this._config;for(let e=0;e<o.length;e++){const r=o[e];e===o.length-1?n[r]=t:(Object.prototype.hasOwnProperty.call(n,r)&&"object"==typeof n[r]&&null!==n[r]||(n[r]={}),n=n[r])}},getSection(e,t){if(!e)return void 0===t?void 0:t;const o=this.get(e);return void 0===o?void 0===t?void 0:t:o},deepMerge(e,t){const o=Object.assign({},e||{});return t&&"object"==typeof t?(Object.keys(t).forEach(e=>{const n=t[e],r=o[e];n&&"object"==typeof n&&!Array.isArray(n)&&r&&"object"==typeof r&&!Array.isArray(r)?o[e]=this.deepMerge(r,n):o[e]=n}),o):o},getValueByPath(e,t){if(!e||!t)return;const o=t.split(".");let n=e;for(let e=0;e<o.length;e+=1){if(null==n)return;n=n[o[e]]}return n},setValueByPath(e,t,o){if(!e||!t)return;const n=t.split(".");let r=e;for(let e=0;e<n.length-1;e+=1){const t=n[e];Object.prototype.hasOwnProperty.call(r,t)&&null!=r[t]||(r[t]={}),r=r[t]}r[n[n.length-1]]=o}};let A=null;function P(){if(null!==A)return A;const e=C||null;return e&&(A=e),e}const G={loadUrl(e,t={}){if(!e)return d.warn("[GeoLeaf.Config.Loader] URL JSON manquante dans loadUrl()."),Promise.resolve({});const{headers:o={},strictContentType:n=1}=t,r=P();if(!/^\.{0,2}\//.test(e)&&!/^\/[^/]/.test(e))if(r&&"function"==typeof r.validateUrl)try{const t=r.validateUrl(e);if(t&&"object"==typeof t){if(!t.valid)throw new Error(t.error||"URL validation failed");e=t.url||e}else"string"==typeof t&&(e=t)}catch(e){const t="[GeoLeaf.Config.Loader] "+e.message;return d.error(t),Promise.reject(new Error(t))}else if(!/^https?:\/\//i.test(e)){const e="[GeoLeaf.Config.Loader] URL doit \xeatre relative ou commencer par http:// ou https://";return d.error(e),Promise.reject(new Error(e))}const i={method:"GET",headers:{Accept:"application/json",...o}};return fetch(e,i).then(t=>{if(!t.ok)throw new Error("HTTP "+t.status+" pour "+e);const o=t.headers.get("content-type");if(n){if(!o||!o.includes("application/json"))throw new Error("[GeoLeaf.Config.Loader] Content-Type invalide: attendu 'application/json', re\xe7u '"+(o||"null")+"'. Cela peut indiquer une attaque XSS ou un serveur mal configur\xe9.")}else o&&!o.includes("application/json")&&d.warn("[GeoLeaf.Config.Loader] Content-Type inattendu:",o);return t.json().catch(t=>{const o="[GeoLeaf.Config.Loader] Erreur de parsing JSON pour "+e+": "+t.message;throw d.error(o),new Error(o)})}).then(e=>{if("object"!=typeof e||null===e)throw new Error("Le JSON de configuration n'est pas un objet valide.");return e}).catch(e=>{throw d.error("[GeoLeaf.Config.Loader] Erreur lors du chargement JSON :",e),e})},fetchJson(e,t={}){if(!e)return d.warn("[GeoLeaf.Config.Loader] fetchJson() appel\xe9 sans URL."),Promise.resolve(null);const{headers:o={},strictContentType:n=1}=t,r=P();if(!/^\.{0,2}\//.test(e)&&!/^\/[^/]/.test(e))if(r&&"function"==typeof r.validateUrl)try{const t=r.validateUrl(e);if(t&&"object"==typeof t){if(!t.valid)throw new Error(t.error||"URL validation failed");e=t.url||e}else"string"==typeof t&&(e=t)}catch(e){const t="[GeoLeaf.Config.Loader] "+e.message;return d.error(t),Promise.reject(new Error(t))}else if(!/^https?:\/\//i.test(e)){const e="[GeoLeaf.Config.Loader] URL doit \xeatre relative ou commencer par http:// ou https://";return d.error(e),Promise.reject(new Error(e))}const i={method:"GET",headers:{Accept:"application/json",...o}};return fetch(e,i).then(t=>{if(!t.ok)throw new Error("HTTP "+t.status+" pour "+e);const o=t.headers.get("content-type");if(n){if(!o||!o.includes("application/json"))throw new Error("[GeoLeaf.Config.Loader] Content-Type invalide dans fetchJson: attendu 'application/json', re\xe7u '"+(o||"null")+"'.")}else o&&!o.includes("application/json")&&d.warn("[GeoLeaf.Config.Loader] fetchJson() Content-Type inattendu:",o);return t.json().catch(t=>{const o="[GeoLeaf.Config.Loader] Erreur de parsing JSON dans fetchJson pour "+e+": "+t.message;throw d.error(o),new Error(o)})}).then(t=>("object"==typeof t&&null!==t||d.warn("[GeoLeaf.Config.Loader] fetchJson() a re\xe7u un JSON non-objet pour l'URL :",e),t)).catch(t=>{throw d.error("[GeoLeaf.Config.Loader] Erreur fetchJson() pour "+e+" :",t),t})}},T=G,x={_config:null,init(e){this._config=e},loadTaxonomy(e=null,t={}){return T?e?T.loadUrl(e,t).then(e=>(e&&"object"==typeof e&&e.categories&&"object"==typeof e.categories&&!Array.isArray(e.categories)?(this._config.categories&&"object"==typeof this._config.categories||(this._config.categories={}),Object.assign(this._config.categories,e.categories),d.info("[GeoLeaf.Config.Taxonomy] Mapping cat\xe9gories fusionn\xe9 avec succ\xe8s.")):d.warn("[GeoLeaf.Config.Taxonomy] Fichier de mapping cat\xe9gories charg\xe9 mais aucune propri\xe9t\xe9 'categories' valide trouv\xe9e (attendu: { \"categories\": { ... } })."),this.getCategories())).catch(e=>(d.error("[GeoLeaf.Config.Taxonomy] Erreur lors du chargement de la taxonomie :",e),{})):(d.info("[GeoLeaf.Config.Taxonomy] Aucune URL de mapping fournie \u2014 skip."),Promise.resolve({})):(d.error("[GeoLeaf.Config.Taxonomy] Module Loader non disponible."),Promise.reject(new Error("Loader module not available")))},getCategories(){if(!this._config)return{};const e=this._config.categories;return e&&"object"==typeof e&&!Array.isArray(e)?e:{}},getCategory(e){if(!e||"string"!=typeof e)return;const t=this.getCategories();return Object.prototype.hasOwnProperty.call(t,e)?t[e]:void 0},getSubcategory(e,t){if(!e||"string"!=typeof e||!t||"string"!=typeof t)return;const o=this.getCategory(e);if(!o||!o.subcategories||"object"!=typeof o.subcategories||Array.isArray(o.subcategories))return;const n=o.subcategories;return Object.prototype.hasOwnProperty.call(n,t)?n[t]:void 0}},O={_safeAssign(e,t){const o=["__proto__","constructor","prototype"];for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&(o.includes(n)?d.warn("[GeoLeaf.Config.Normalization] Tentative de pollution de prototype bloqu\xe9e",{key:n}):e[n]=t[n]);return e},isPoiStructNormalized(e){if(!e||"object"!=typeof e)return 0;if("string"!=typeof e.id||""===e.id.trim())return 0;const t="string"==typeof e.title&&""!==e.title.trim(),o="string"==typeof e.label&&""!==e.label.trim();if(!t&&!o)return 0;if(Array.isArray(e.latlng)&&e.latlng.length>=2){const t=e.latlng[0],o=e.latlng[1];if("number"==typeof t&&!Number.isNaN(t)&&"number"==typeof o&&!Number.isNaN(o))return 1}if(e.location&&"object"==typeof e.location){const t=e.location.lat,o=e.location.lng;if("number"==typeof t&&!Number.isNaN(t)&&"number"==typeof o&&!Number.isNaN(o))return 1}return 0},mapRawPoiToNormalized(e,t){if(!e||!t||"object"!=typeof t)return null;const o=E;if(!o)return d.error("[GeoLeaf.Config.Normalization] Module Storage non disponible."),null;const n={id:"",title:"",location:{lat:0,lng:0},attributes:{}};return Object.keys(t).forEach(r=>{const i=t[r];if(!i)return;const a=o.getValueByPath(e,i);void 0!==a&&o.setValueByPath(n,r,a)}),n.attributes&&"object"==typeof n.attributes&&!Array.isArray(n.attributes)||(n.attributes={}),n},normalizePoiWithMapping(e,t){if(!Array.isArray(e))return[];if(!t||"object"!=typeof t||!t.mapping||"object"!=typeof t.mapping)return e;const o=t.mapping,n=[];return e.forEach((e,t)=>{if(this.isPoiStructNormalized(e))return void n.push(e);const r=this.mapRawPoiToNormalized(e,o);r&&this.isPoiStructNormalized(r)?n.push(r):d.warn("[GeoLeaf.Config.Normalization] POI non normalis\xe9 m\xeame apr\xe8s application du mapping ; POI ignor\xe9.",{poiIndex:t,poiId:e&&e.id})}),n},normalizePoiArray:e=>Array.isArray(e)?e.map((e,t)=>{if(!e||"object"!=typeof e)return e;const o=e,n=o.attributes&&"object"==typeof o.attributes&&!Array.isArray(o.attributes)?o.attributes:{},r=Object.assign(Object.create(null),n);return r.reviews&&"object"==typeof r.reviews&&!Array.isArray(r.reviews)&&Array.isArray(r.reviews.recent)?r.reviews={...r.reviews,recent:r.reviews.recent.slice(0,5)}:o.reviews&&"object"==typeof o.reviews&&!Array.isArray(o.reviews)&&Array.isArray(o.reviews.recent)?r.reviews={...o.reviews,recent:o.reviews.recent.slice(0,5)}:Array.isArray(r.reviews)?r.reviews=r.reviews.slice(0,5):Array.isArray(o.reviews)?r.reviews=o.reviews.slice(0,5):void 0!==o.reviews||void 0!==r.reviews?(d.warn("[GeoLeaf.Config.Normalization] Format de `reviews` inattendu pour le POI :",{poiIndex:t,poiId:o.id,reviewsType:typeof o.reviews,attributesReviewsType:typeof r.reviews}),r.reviews=[]):r.reviews=[],o.attributes=r,o}):e},M={async loadModularProfile(e,t,o,n=Date.now(),r={}){if(!T)throw new Error("GeoLeaf._ConfigLoader non disponible");d.info(`[ProfileLoader] Chargement profil modulaire: ${o}`);try{const[i,a,l]=await Promise.all([this._loadTaxonomy(e,t,n,r),this._loadThemes(e,t,n,r),this._loadLayersFile(e,t,n,r)]),s=l||e.layers||[],c=await this._loadLayerConfigs(s,t,n,r),u=this._buildEnrichedProfile({profile:e,baseUrl:t,profileId:o,taxonomy:i,themes:a,layersSource:s,layersConfigs:c});return d.info("[ProfileLoader] Profil modulaire charg\xe9 avec succ\xe8s",{profileId:o,hasTaxonomy:!!u.taxonomy,hasThemes:!!u.themes,layersCount:u.layers?u.layers.length:0}),u}catch(e){throw d.error("[ProfileLoader] Erreur chargement profil modulaire:",e),e}},async _loadTaxonomy(e,t,o,n){const r=T,i=e.Files?.taxonomyFile||e.taxonomyFile;if(!i&&!e.taxonomy)return null;if(i)try{const e=await r.fetchJson(`${t}/${i}?t=${o}`,n);return d.info("[ProfileLoader] Taxonomy.json charg\xe9 avec succ\xe8s"),e}catch(e){return d.warn("[ProfileLoader] Erreur chargement taxonomy.json:",e),null}return e.taxonomy||null},async _loadThemes(e,t,o,n){const r=T,i=e.Files?.themesFile||e.themesFile;if(i)try{return await r.fetchJson(`${t}/${i}?t=${o}`,n)}catch(e){return d.warn("[ProfileLoader] Erreur chargement themes.json:",e),null}return e.themes||null},async _loadLayersFile(e,t,o,n){const r=T,i=e.Files?.layersFile;if(i)try{return await r.fetchJson(`${t}/${i}?t=${o}`,n)}catch(e){return d.warn("[ProfileLoader] Erreur chargement layers.json:",e),null}return null},async _loadLayerConfigs(e,t,o,n){const r=T;if(!Array.isArray(e)||0===e.length)return[];const i=e.map(async e=>{if(!e.configFile)return{id:e.id,config:null,layerDirectory:null,layerManagerId:e.layerManagerId||null};const i=e.configFile.replace(/\/[^\/]+$/,"");try{const a=await r.fetchJson(`${t}/${e.configFile}?t=${o}`,n);return{id:e.id,config:a,layerDirectory:i,layerManagerId:e.layerManagerId||null}}catch(t){return d.error(`[ProfileLoader] Erreur chargement ${e.configFile}:`,t),{id:e.id,config:null,layerDirectory:i,layerManagerId:e.layerManagerId||null}}});return Promise.all(i)},_buildEnrichedProfile(e){const{profile:t,baseUrl:o,profileId:n,taxonomy:r,themes:i,layersSource:a,layersConfigs:l}=e,s={...t};return s.basePath=o,s._profileId=n,r&&(s.taxonomy=r),i&&(s.themes=i),l&&l.length>0&&(s.layers=l.map(e=>{if(e.config){const t={...e.config,_layerDirectory:e.layerDirectory,_profileId:n,layerManagerId:e.layerManagerId||e.config.layerManagerId||"geojson-default"};if(t.data&&t.data.file&&!t.dataFile){const e=t.data.directory||"data";t.dataFile=`${e}/${t.data.file}`}return t}return a.find(t=>t.id===e.id)||{id:e.id,error:"Failed to load config"}})),s},isModularProfile(e){if(!e||"object"!=typeof e)return 0;if(e.Files&&"object"==typeof e.Files)return 1;if(e.version){const t=e.version.match(/^(\d+)\.(\d+)/);if(t)return parseInt(t[1],10)>=3}return 0}},k={_config:null,_activeProfileId:null,_activeProfile:null,_activeProfileData:{poi:[],routes:[],mapping:null},init(e){this._config=e},isProfilePoiMappingEnabled(){const e=this._config&&this._config.data;return e&&"object"==typeof e?"boolean"==typeof e.enableProfilePoiMapping?e.enableProfilePoiMapping:"boolean"==typeof e.useProfilePoiMapping?e.useProfilePoiMapping:"boolean"==typeof e.useMapping?e.useMapping:1:1},loadActiveProfileResources(e={}){const t=this._config&&this._config.data;if(!t||!t.activeProfile)return d.info("[GeoLeaf.Config.Profile] Aucun profil actif d\xe9fini dans config.data.activeProfile ; aucun chargement de profil effectu\xe9."),Promise.resolve(this._config);const o="boolean"==typeof t.useLegacyProfileData?t.useLegacyProfileData:0,n=t.activeProfile,r=`${t.profilesBasePath||"data/profiles"}/${n}`;d.info("[GeoLeaf.Config.Profile] D\xe9but du chargement du profil :",{profileId:n,baseUrl:r,configData:t});const i={headers:e.headers||{},strictContentType:"boolean"==typeof e.strictContentType?e.strictContentType:1},a=T;if(!a||!O)return d.error("[GeoLeaf.Config.Profile] Modules Loader ou Normalization non disponibles."),Promise.reject(new Error("Required modules not available"));const l=this.isProfilePoiMappingEnabled();l||d.info("[GeoLeaf.Config.Profile] Mapping de POI d\xe9sactiv\xe9 via configuration globale ; les POI du profil seront consid\xe9r\xe9s comme d\xe9j\xe0 normalis\xe9s."),d.info("[GeoLeaf.Config.Profile] Chargement des ressources du profil actif :",{profileId:n,baseUrl:r});const s=Date.now();if(o){const e=l?a.fetchJson(`${r}/mapping.json?t=${s}`,i):Promise.resolve(null),t=a.fetchJson(`${r}/routes.json?t=${s}`,i).catch(()=>(d.info("[GeoLeaf.Config.Profile] routes.json non disponible ou invalide, utilisation d'un tableau vide."),[]));return Promise.all([a.fetchJson(`${r}/profile.json?t=${s}`,i),a.fetchJson(`${r}/poi.json?t=${s}`,i),e,t]).then(([e,t,o,n])=>this._finalizeProfileLoad({profile:e,poi:t,routes:n,mapping:o,mappingEnabled:l})).catch(e=>(d.error("[GeoLeaf.Config.Profile] Erreur lors du chargement des ressources du profil actif :",e),this._config))}return a.fetchJson(`${r}/profile.json?t=${s}`,i).then(e=>{if(M&&M.isModularProfile(e))return d.info("[GeoLeaf.Config.Profile] Profil modulaire d\xe9tect\xe9 - Chargement modulaire"),this._loadModularProfile(e,r,s,i);let t=0;e&&Array.isArray(e.layers)&&(t=e.layers.some(e=>0==e.normalized));const o=l&&t?a.fetchJson(`${r}/mapping.json?t=${s}`,i).catch(e=>(d.error("[GeoLeaf.Config.Profile] mapping.json requis (normalized:false) mais non trouv\xe9 ou invalide.",e),null)):Promise.resolve(null);return Promise.all([Promise.resolve(e),o])}).then(e=>{if(e&&!Array.isArray(e))return e;const[t,o]=e;return this._activeProfileId=n,this._activeProfile=t||null,d.info("[GeoLeaf.Config.Profile] Profil charg\xe9 (layers-only)",{profileId:n,profileLoaded:!!t,profileKeys:t?Object.keys(t):[]}),this._activeProfileData={poi:[],routes:[],mapping:o&&"object"==typeof o?o:null},t&&"object"==typeof t&&t.taxonomy&&t.taxonomy.categories&&"object"==typeof t.taxonomy.categories&&!Array.isArray(t.taxonomy.categories)&&(this._config.categories=t.taxonomy.categories,d.info("[GeoLeaf.Config.Profile] Taxonomie des cat\xe9gories charg\xe9e (layers-only).",{profileId:n,categoriesCount:Object.keys(t.taxonomy.categories||{}).length})),this._config.profiles&&"object"==typeof this._config.profiles&&!Array.isArray(this._config.profiles)||(this._config.profiles={}),this._config.profiles[n]={profile:this._activeProfile,poi:this._activeProfileData.poi,routes:this._activeProfileData.routes,mapping:this._activeProfileData.mapping},this._fireProfileLoadedEvent(n,{profile:this._activeProfile,poi:this._activeProfileData.poi,routes:this._activeProfileData.routes,mapping:this._activeProfileData.mapping}),this._config}).catch(e=>(d.error("[GeoLeaf.Config.Profile] Erreur lors du chargement des ressources du profil actif :",e),this._config))},_loadModularProfile(e,t,o,n){const r=this._config.data.activeProfile;return M?M.loadModularProfile(e,t,r,o,n).then(e=>(this._activeProfileId=r,this._activeProfile=e,d.info("[GeoLeaf.Config.Profile] Profil modulaire charg\xe9 avec succ\xe8s",{profileId:r,hasTaxonomy:!!e.taxonomy,hasThemes:!!e.themes,layersCount:e.layers?e.layers.length:0}),this._activeProfileData={poi:[],routes:[],mapping:null},e.taxonomy&&e.taxonomy.categories&&(this._config.categories=e.taxonomy.categories,d.info("[GeoLeaf.Config.Profile] Taxonomie charg\xe9e depuis profil modulaire",{categoriesCount:Object.keys(e.taxonomy.categories||{}).length})),Object.keys(e).forEach(t=>{"layers"!==t&&"taxonomy"!==t&&"themes"!==t&&(this._config[t]=e[t])}),this._config.profiles&&"object"==typeof this._config.profiles||(this._config.profiles={}),this._config.profiles[r]={profile:this._activeProfile,poi:[],routes:[],mapping:null},this._fireProfileLoadedEvent(r,{profile:this._activeProfile,poi:[],routes:[],mapping:null}),e)):(d.error("[GeoLeaf.Config.Profile] ProfileLoader non disponible"),Promise.reject(new Error("ProfileLoader non disponible")))},_finalizeProfileLoad({profile:e,poi:t,routes:o,mapping:n,mappingEnabled:r}){const i=O;this._activeProfile=e||null,d.info("[GeoLeaf.Config.Profile] Profil charg\xe9 depuis profile.json :",{profileId:this._activeProfileId,profileLoaded:null!=e,profileKeys:e?Object.keys(e):[]});const a=r&&n&&"object"==typeof n?n:null,l=Array.isArray(t)?i.normalizePoiWithMapping(t,a):[],s=i.normalizePoiArray(l),c=a,u=Array.isArray(o)?o:[];return this._activeProfileData={poi:s,mapping:c,routes:u},s.length&&(this._config.poi=s),u.length&&(this._config.routes=u),e&&"object"==typeof e&&e.taxonomy&&e.taxonomy.categories&&"object"==typeof e.taxonomy.categories&&!Array.isArray(e.taxonomy.categories)&&(this._config.categories=e.taxonomy.categories,d.info("[GeoLeaf.Config.Profile] Taxonomie des cat\xe9gories charg\xe9e depuis le profil actif.",{profileId:this._activeProfileId,categoriesCount:Object.keys(e.taxonomy.categories||{}).length})),this._config.profiles&&"object"==typeof this._config.profiles&&!Array.isArray(this._config.profiles)||(this._config.profiles={}),this._config.profiles[this._activeProfileId]={profile:this._activeProfile,poi:this._activeProfileData.poi,routes:this._activeProfileData.routes,mapping:this._activeProfileData.mapping},this._fireProfileLoadedEvent(this._activeProfileId,{profile:this._activeProfile,poi:this._activeProfileData.poi,routes:this._activeProfileData.routes,mapping:this._activeProfileData.mapping}),this._config},getActiveProfileId(){return this._activeProfileId},getActiveProfile(){return this._activeProfile},getActiveProfilePoi(){return this._activeProfileData&&Array.isArray(this._activeProfileData.poi)?this._activeProfileData.poi:[]},getActiveProfileRoutes(){return this._activeProfileData&&Array.isArray(this._activeProfileData.routes)?this._activeProfileData.routes:[]},getActiveProfileMapping(){return this._activeProfileData&&this._activeProfileData.mapping?this._activeProfileData.mapping:null},getIconsConfig(){return this._activeProfile&&this._activeProfile.taxonomy&&this._activeProfile.taxonomy.icons?this._activeProfile.taxonomy.icons:null},getActiveProfileLayersConfig(){return this._activeProfile&&this._activeProfile.layers?this._activeProfile.layers:null},_fireProfileLoadedEvent(e,t){if("undefined"!=typeof document&&"function"==typeof document.dispatchEvent)try{const o=new CustomEvent("geoleaf:profile:loaded",{detail:{profileId:e,data:t}});document.dispatchEvent(o)}catch(o){try{const o=document.createEvent("CustomEvent");o.initCustomEvent("geoleaf:profile:loaded",0,0,{profileId:e,data:t}),document.dispatchEvent(o)}catch(e){d.warn("[GeoLeaf.Config.Profile] Impossible d'\xe9mettre l'\xe9v\xe9nement geoleaf:profile:loaded.")}}}},N=k,F={_config:{},_isLoaded:0,_subModulesInitialized:0,_source:null,_options:{autoEvent:1},init:function(e={}){if(this._options=Object.assign({},this._options,{autoEvent:"boolean"==typeof e.autoEvent?e.autoEvent:this._options.autoEvent}),e.config&&"object"==typeof e.config){if(this._applyConfig(e.config,"inline"),"string"==typeof e.profileId&&e.profileId.length>0&&(this._config.data||(this._config.data={}),this._config.data.activeProfile=e.profileId,d.info("[GeoLeaf.Config] Profil actif chang\xe9 vers:",e.profileId)),this._maybeFireLoadedEvent(),"function"==typeof e.onLoaded)try{e.onLoaded(this._config)}catch(e){d.error("[GeoLeaf.Config] Erreur dans onLoaded (inline) :",e)}return Promise.resolve(this._config)}if("string"==typeof e.url&&e.url.length>0){const t={headers:e.headers,strictContentType:"boolean"==typeof e.strictContentType?e.strictContentType:1},o="string"==typeof e.mappingUrl&&e.mappingUrl.length>0?e.mappingUrl:null,n={headers:e.mappingHeaders||e.headers,strictContentType:"boolean"==typeof e.mappingStrictContentType?e.mappingStrictContentType:t.strictContentType};return this.loadUrl(e.url,t).then(t=>("string"==typeof e.profileId&&e.profileId.length>0&&(t.data||(t.data={}),t.data.activeProfile=e.profileId,this._config.data.activeProfile=e.profileId,d.info("[GeoLeaf.Config] Profil actif chang\xe9 vers:",e.profileId)),t)).then(e=>o?this.loadTaxonomy(o,n).then(()=>e).catch(t=>(d.warn("[GeoLeaf.Config] \xc9chec du chargement du mapping cat\xe9gories depuis "+o+" (GeoLeaf continuera sans mapping d\xe9di\xe9) :",t),e)):e).then(t=>{if("function"==typeof e.onLoaded)try{e.onLoaded(t)}catch(e){d.error("[GeoLeaf.Config] Erreur dans onLoaded (url+mapping) :",e)}return t}).catch(t=>{if(d.error("[GeoLeaf.Config] Erreur init() avec url :",t),"function"==typeof e.onError)try{e.onError(t)}catch(e){d.error("[GeoLeaf.Config] Erreur dans onError :",e)}throw t})}if(this._applyConfig({},"inline"),"string"==typeof e.profileId&&e.profileId.length>0&&(this._config.data||(this._config.data={}),this._config.data.activeProfile=e.profileId,d.info("[GeoLeaf.Config] Profil actif chang\xe9 vers:",e.profileId)),this._maybeFireLoadedEvent(),"function"==typeof e.onLoaded)try{e.onLoaded(this._config)}catch(e){d.error("[GeoLeaf.Config] Erreur dans onLoaded (vide) :",e)}return Promise.resolve(this._config)},_initSubModules:function(){if(this._subModulesInitialized)return;this._subModulesInitialized=1;const e=E,t=x,o=N;e&&"function"==typeof e.init&&e.init(this._config),t&&"function"==typeof t.init&&t.init(this._config),o&&"function"==typeof o.init&&o.init(this._config)},_applyConfig:function(e,t){"object"==typeof e&&null!==e||(e={}),this._validateConfig(e);const o=E;o&&"function"==typeof o.deepMerge?this._config=o.deepMerge(this._config,e):this._config=Object.assign({},this._config,e);const n=O;Array.isArray(this._config.poi)&&n&&(this._config.poi=n.normalizePoiArray(this._config.poi)),this._isLoaded=1,this._source=t||"inline",this._subModulesInitialized=0,this._initSubModules();try{const t=e&&"object"==typeof e&&e.logging?e.logging:this._config&&this._config.logging?this._config.logging:null;let o=t&&t.level,n=0;e&&void 0!==e.debug?n=!!e.debug:this._config&&void 0!==this._config.debug&&(n=!!this._config.debug),o||(o=n?"debug":"info"),o&&d&&"function"==typeof d.setLevel&&(d.setLevel(o),d.info("[GeoLeaf.Config] Niveau de log appliqu\xe9 depuis la configuration :",o,"(debug:",n,")"))}catch(e){d.warn("[GeoLeaf.Config] Impossible d'appliquer le niveau de log depuis la configuration :",e)}},isLoaded:function(){return this._isLoaded},getSource:function(){return this._source},_maybeFireLoadedEvent:function(){if(this._options.autoEvent&&"undefined"!=typeof document&&"function"==typeof document.dispatchEvent)try{const e=new CustomEvent("geoleaf:config:loaded",{detail:{config:this._config,source:this._source}});document.dispatchEvent(e)}catch(e){try{const e=document.createEvent("CustomEvent");e.initCustomEvent("geoleaf:config:loaded",0,0,{config:this._config,source:this._source}),document.dispatchEvent(e)}catch(e){d.warn("[GeoLeaf.Config] Impossible d'\xe9mettre l'\xe9v\xe9nement geoleaf:config:loaded.")}}}},D="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{};let U="light";const R="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{};let j=null,$=null;function B(e={}){const t="[GeoLeaf.Core]";try{if(j)return d.warn(`${t} Carte d\xe9j\xe0 initialis\xe9e. Recyclage de l'instance existante.`),j;const o=function(e){if(!e)throw new Error("L'option obligatoire 'mapId' est manquante.");const t=document.getElementById(e);if(!t)throw new Error(`Aucun \xe9l\xe9ment DOM trouv\xe9 pour mapId='${e}'.`);return t}(e.mapId),n=function(e){const t=Array.isArray(e.center)?e.center:h.DEFAULT_CENTER,o=Number.isFinite(e.zoom)?e.zoom:h.DEFAULT_ZOOM;return Object.assign({},e.mapOptions||{},{center:t,zoom:o,zoomControl:e.mapOptions?.zoomControl??1,attributionControl:e.mapOptions?.attributionControl??0,zoomSnap:e.mapOptions?.zoomSnap??1,zoomDelta:e.mapOptions?.zoomDelta??1,wheelPxPerZoomLevel:e.mapOptions?.wheelPxPerZoomLevel??120,preferCanvas:e.mapOptions?.preferCanvas??1})}(e),r=e.theme||"light";return j=function(e,t){if("undefined"==typeof L)throw new Error("Leaflet (L) est introuvable. Assurez-vous d'avoir charg\xe9 Leaflet 1.9.x.");return L.map(e,t)}(o,n),$=j,function(e){try{D.GeoLeaf?.UI&&"function"==typeof D.GeoLeaf.UI.applyTheme&&D.GeoLeaf.UI.applyTheme(e)}catch(e){d.warn("[GeoLeaf.Core] Impossible d'appliquer le th\xe8me :",e)}}(r),function(e){const t=D.GeoLeaf?.Config?.get?D.GeoLeaf.Config.get("ui"):null;if((!t||0!=t.showLegend)&&"function"==typeof D.GeoLeaf?.Legend?.init)try{D.GeoLeaf.Legend.init(e,{position:"bottomleft",collapsible:1,collapsed:0})}catch(e){d.warn("[GeoLeaf.Core] Impossible d'initialiser Legend :",e)}}(j),d.info(`${t} Carte initialis\xe9e avec succ\xe8s.`),j}catch(e){if(d.error(`${t} ERREUR :`,e.message),"function"==typeof R.GeoLeaf?.Core?.onError)try{R.GeoLeaf.Core.onError(e)}catch(e){d.error(`${t} Erreur dans Core.onError() :`,e)}return j=null,$=null,null}}const z={init:B,initMap:function(e,t,o,n){if(d.warn("[GeoLeaf.Core] GeoLeaf.Core.initMap() est obsol\xe8te, utilisez GeoLeaf.Core.init()."),R.GeoLeaf?.Config?.get)try{const e=R.GeoLeaf.Config.get("map")||{},t=R.GeoLeaf.Config.get("ui")||{};return B({center:e.center||h.DEFAULT_CENTER,zoom:"number"==typeof e.zoom?e.zoom:h.DEFAULT_ZOOM,theme:t.theme||"light",mapOptions:e.mapOptions||{}})}catch(e){d.error("[GeoLeaf.Core] initMap() n'a pas pu construire les options :",e)}return e&&"object"==typeof e&&!Array.isArray(e)?B(e):"string"==typeof e&&Array.isArray(t)&&"number"==typeof o?B({center:t,zoom:o,theme:n||"light"}):(d.error("[GeoLeaf.Core] initMap() appel\xe9 avec une signature obsol\xe8te ou invalide."),null)},getMap:function(){return $},setTheme:function(e){!e||"light"!==e&&"dark"!==e?d.warn("[GeoLeaf.Core] setTheme() : th\xe8me invalide \u2192",e):(U=e,function(e){const t=document.body;t?(t.classList.remove("gl-theme-light","gl-theme-dark"),t.classList.add("dark"===e?"gl-theme-dark":"gl-theme-light")):d.warn("[GeoLeaf.Core] Impossible d'appliquer le th\xe8me : document.body introuvable.")}(e))},getTheme:function(){return U}};function V(e){return e||(z&&"function"==typeof z.getMap?z.getMap():null)}function q(e,t=250,o=0){let n;return function(...r){const i=this,a=o&&!n;clearTimeout(n),n=setTimeout(()=>{n=null,o||e.apply(i,r)},t),a&&e.apply(i,r)}}function J(e,t,o,n){const r=(o-e)*(Math.PI/180),i=(n-t)*(Math.PI/180),a=Math.sin(r/2)*Math.sin(r/2)+Math.cos(e*(Math.PI/180))*Math.cos(o*(Math.PI/180))*Math.sin(i/2)*Math.sin(i/2);return 2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))*6371}function H(e,...t){if(!e||"object"!=typeof e)return"";for(const o of t){const t=o.split(".");let n=e;for(const e of t){if(!n||"object"!=typeof n||!(e in n)){n=null;break}n=n[e]}if(null!=n){if("string"!=typeof n)return n;if(n.trim())return n}}return""}function Z(e,t,o=999){return("number"==typeof e.order?e.order:o)-("number"==typeof t.order?t.order:o)}function W(){return d}function X(){return F&&"function"==typeof F.getActiveProfile&&F.getActiveProfile()||null}const Y={validateUrl:function(e){if(!e||"string"!=typeof e)return null;try{return b(e)}catch{return null}},deepMerge:function e(t,o){if(!o||"object"!=typeof o)return t;if(!t||"object"!=typeof t)return o;const n=["__proto__","constructor","prototype"],r=Object.assign({},t);return Object.keys(o).forEach(i=>{n.includes(i)||(o[i]&&"object"==typeof o[i]&&!Array.isArray(o[i])?r[i]=e(t[i]||{},o[i]):r[i]=o[i])}),r},ensureMap:V,mergeOptions:function(e,t){return t&&"object"==typeof t?Object.assign({},e,t):e},fireMapEvent:function(e,t,o){if(e&&"function"==typeof e.fire)try{e.fire(t,o||{})}catch(e){d&&d.warn("[Utils] fireMapEvent error:",t,e)}},debounce:q,throttle:function(e,t=100){let o;return function(...n){const r=Date.now();(!o||r-o>=t)&&(e.apply(this,n),o=r)}},getDistance:J,resolveField:H,compareByOrder:Z,getLog:W,getActiveProfile:X};function Q(e,t,o,n={}){const r=document.createElementNS("http://www.w3.org/2000/svg","svg");r.setAttribute("width",e),r.setAttribute("height",t),r.setAttribute("viewBox",n.viewBox||"0 0 24 24"),r.setAttribute("fill",n.fill||"none"),r.setAttribute("stroke",n.stroke||"currentColor"),r.setAttribute("stroke-width",String(n.strokeWidth||"2")),r.setAttribute("stroke-linecap",n.strokeLinecap||"round"),r.setAttribute("stroke-linejoin",n.strokeLinejoin||"round");const i=document.createElementNS("http://www.w3.org/2000/svg","path");return i.setAttribute("d",o),r.appendChild(i),r}const K={"chevron-down":"M6 9l6 6 6-6","chevron-up":"M18 15l-6-6-6 6","chevron-left":"M15 18l-6-6 6-6","chevron-right":"M9 18l6-6-6-6","arrow-left":"\u2039","arrow-right":"\u203a",close:"\u2715",check:"\u2713",star:"\u2605","star-empty":"\u2606","triangle-right":"\u25b6","triangle-down":"\u25bc",home:"M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z",layers:"M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5",marker:"M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z","map-pin":"M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z",download:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3",upload:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12",trash:"M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",copy:"M8 4v12a2 2 0 002 2h8a2 2 0 002-2V7.242a2 2 0 00-.602-1.43L16.083 2.57A2 2 0 0014.685 2H10a2 2 0 00-2 2z",sync:"M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"},ee={setTextContent:function(e,t){e&&e.nodeType?e.textContent=null!=t?String(t):"":d.warn("[DOMSecurity] Invalid element in setTextContent")},setSafeHTML:function(e,t,o){e&&e.nodeType?C&&"function"==typeof C.sanitizeHTML?C.sanitizeHTML(e,t,o?{allowedTags:o}:{}):(d.warn("[DOMSecurity] Security.sanitizeHTML unavailable, falling back to textContent"),e.textContent=t?String(t):""):d.warn("[DOMSecurity] Invalid element in setSafeHTML")},clearElement:function(e){if(e&&e.nodeType)for(;e.firstChild;)e.removeChild(e.firstChild);else d.warn("[DOMSecurity] Invalid element in clearElement")},clearElementFast:function(e){e&&e.nodeType?e.textContent="":d.warn("[DOMSecurity] Invalid element in clearElementFast")},createSVGIcon:Q,getIcon:function(e,t=18,o={}){const n=K[e];return n?Q(t,t,n,o):(d.warn(`[DOMSecurity] Icon '${e}' not found`),null)},createElement:function(e,t={},o=null){const n=document.createElement(e);for(const[e,o]of Object.entries(t))"class"===e||"className"===e?n.className=o:"style"===e&&"object"==typeof o?Object.assign(n.style,o):e.startsWith("data-")?n.setAttribute(e,o):n[e]=o;return o&&(Array.isArray(o)?o.forEach(e=>{"string"==typeof e?n.appendChild(document.createTextNode(e)):e&&e.nodeType&&n.appendChild(e)}):"string"==typeof o?n.textContent=o:o.nodeType&&n.appendChild(o)),n},SVG_ICONS:K};function te(e,t={},...o){if("string"!=typeof e||!e.trim())throw new TypeError("[DomHelpers] createElement: tag must be a non-empty string");const n=document.createElement(e),{className:r,id:i,style:a,dataset:l,attributes:s,textContent:c,innerHTML:u,_eventContext:f,_cleanupArray:p,...g}=t;if(r&&(n.className=r),i&&(n.id=i),a&&"object"==typeof a&&Object.assign(n.style,a),l&&"object"==typeof l)for(const[e,t]of Object.entries(l))n.dataset[e]=t;if(s&&"object"==typeof s)for(const[e,t]of Object.entries(s))n.setAttribute(e,t);const h=GeoLeaf.Utils?.events;for(const[e,t]of Object.entries(g))if(e.startsWith("on")&&"function"==typeof t){const o=e.substring(2).toLowerCase();if(h){const e=h.on(n,o,t,0,f||"DomHelpers.createElement");p&&Array.isArray(p)&&p.push(e)}else n.addEventListener(o,t)}else if(e.startsWith("aria")){const o="aria-"+e.substring(4).toLowerCase();n.setAttribute(o,t)}else e in n?n[e]=t:n.setAttribute(e,t);return void 0!==c?(n.textContent=c,n):void 0!==u?(d&&d.warn&&d.warn("[DomHelpers] createElement avec innerHTML - assurez-vous que le contenu est sanitiz\xe9",{tag:e,innerHTML:u.substring(0,100)}),GeoLeaf.DOMSecurity&&"function"==typeof GeoLeaf.DOMSecurity.setSafeHTML?GeoLeaf.DOMSecurity.setSafeHTML(n,u):(d&&d.error&&d.error("[DomHelpers] DOMSecurity not available, using textContent fallback"),n.textContent=u),n):(oe(n,...o),n)}function oe(e,...t){for(const o of t)null!=o&&0!=o&&(Array.isArray(o)?oe(e,...o):"string"==typeof o||"number"==typeof o?e.appendChild(document.createTextNode(String(o))):o instanceof Node?e.appendChild(o):e.appendChild(document.createTextNode(String(o))));return e}const ne=new Set(["translateX","translateY","translateZ","scale","scaleX","scaleY","rotate","rotateX","rotateY","rotateZ","skewX","skewY"]),re={linear:e=>e,easeInQuad:e=>e*e,easeOutQuad:e=>e*(2-e),easeInOutQuad:e=>e<.5?2*e*e:(4-2*e)*e-1,easeInCubic:e=>e*e*e,easeOutCubic:e=>--e*e*e+1,easeInOutCubic:e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1,easeInQuart:e=>e*e*e*e,easeOutQuart:e=>1- --e*e*e*e,easeInOutQuart:e=>e<.5?8*e*e*e*e:1-8*--e*e*e*e,easeOutBack:e=>1+2.70158*Math.pow(e-1,3)+1.70158*Math.pow(e-1,2)};class AnimationHelper{constructor(){this._animations=new Map,this._rafId=null,this._lastFrameTime=0,this._fpsHistory=[],this._debug=0,this._nextId=1,this._elementAnimations=new WeakMap,this._stats={totalFrames:0,droppedFrames:0,averageFPS:0},this._tick=this._tick.bind(this)}setDebug(e){this._debug=e,e&&!this._rafId&&this._startLoop()}getStats(){return{...this._stats,activeAnimations:this._animations.size,currentFPS:this._getCurrentFPS()}}animate(e,t={}){if(!(e&&e instanceof HTMLElement))return this._log("warn","animate: invalid element",e),null;const{from:o={},to:n={},duration:r=300,easing:i="easeOutCubic",onComplete:a=null,onUpdate:l=null}=t,s=this._nextId++,c=performance.now(),u=this._getEasingFunction(i);return this._optimizeElement(e,n),this._trackElementAnimation(e,s),this._animations.set(s,t=>{const i=t-c,d=Math.min(i/r,1),f=u(d);return this._applyTransform(e,o,n,f),l&&l(f),d>=1?(this._animations.delete(s),this._untrackElementAnimation(e,s),this._cleanupElement(e),a&&a(),this._log("debug",`Animation ${s} completed`),0):1}),this._startLoop(),this._log("debug",`Animation ${s} started`,{duration:r,easing:i}),s}fadeIn(e,t=300,o=null){return e.style.display&&"none"!==e.style.display||(e.style.display="block"),this.animate(e,{from:{opacity:0},to:{opacity:1},duration:t,easing:"easeOutCubic",onComplete:o})}fadeOut(e,t=300,o=null){return this.animate(e,{from:{opacity:1},to:{opacity:0},duration:t,easing:"easeOutCubic",onComplete:()=>{e.style.display="none",o&&o()}})}slideIn(e,t=300,o=null){return e.style.display=e.style.display||"block",this.animate(e,{from:{opacity:0,translateY:-20},to:{opacity:1,translateY:0},duration:t,easing:"easeOutBack",onComplete:o})}slideOut(e,t=300,o=null){return this.animate(e,{from:{opacity:1,translateY:0},to:{opacity:0,translateY:-20},duration:t,easing:"easeInCubic",onComplete:()=>{e.style.display="none",o&&o()}})}cancel(e){const t=this._animations.has(e);return t&&(this._animations.delete(e),this._log("debug",`Animation ${e} cancelled`)),t}cancelForElement(e){const t=this._elementAnimations.get(e);if(!t)return 0;let o=0;return t.forEach(e=>{this._animations.delete(e)&&o++}),this._elementAnimations.delete(e),this._cleanupElement(e),this._log("debug",`Cancelled ${o} animations for element`),o}cancelAll(){const e=this._animations.size;this._animations.clear(),this._rafId&&(cancelAnimationFrame(this._rafId),this._rafId=null),this._log("info",`Cancelled all ${e} animations`)}nextFrame(){return new Promise(e=>{requestAnimationFrame(e)})}batch(e){Array.isArray(e)&&requestAnimationFrame(()=>{e.forEach(e=>{if("function"==typeof e)try{e()}catch(e){this._log("error","Batch animation error:",e)}})})}_tick(e){if(this._lastFrameTime){const t=1e3/(e-this._lastFrameTime);this._updateFPS(t),t<50&&this._stats.droppedFrames++}this._lastFrameTime=e,this._stats.totalFrames++;const t=[];this._animations.forEach((o,n)=>{try{o(e)||t.push(n)}catch(e){this._log("error",`Animation ${n} error:`,e),t.push(n)}}),t.forEach(e=>this._animations.delete(e)),this._animations.size>0||this._debug?this._rafId=requestAnimationFrame(this._tick):this._rafId=null}_startLoop(){this._rafId||(this._rafId=requestAnimationFrame(this._tick))}_applyTransform(e,t,o,n){const r=[],i={};Object.keys(o).forEach(e=>{const a=void 0!==t[e]?t[e]:this._getDefaultValue(e),l=o[e],s=this._interpolate(a,l,n);this._isTransformProperty(e)?r.push(this._formatTransform(e,s)):i[e]=this._formatValue(e,s)}),r.length>0&&(e.style.transform=r.join(" ")),Object.keys(i).forEach(t=>{e.style[t]=i[t]})}_interpolate(e,t,o){return e+(t-e)*o}_isTransformProperty(e){return ne.has(e)}_formatTransform(e,t){return e.includes("translate")?`${e}(${t}px)`:e.includes("rotate")||e.includes("skew")?`${e}(${t}deg)`:`${e}(${t})`}_formatValue(e,t){return"opacity"===e?t.toString():`${t}px`}_getDefaultValue(e){return"opacity"===e||"scale"===e||"scaleX"===e||"scaleY"===e?1:0}_optimizeElement(e,t){const o=[];Object.keys(t).forEach(e=>{this._isTransformProperty(e)?o.includes("transform")||o.push("transform"):o.push(e)}),o.length>0&&(e.style.willChange=o.join(", "))}_cleanupElement(e){e.style.willChange="auto"}_trackElementAnimation(e,t){let o=this._elementAnimations.get(e);o||(o=new Set,this._elementAnimations.set(e,o)),o.add(t)}_untrackElementAnimation(e,t){const o=this._elementAnimations.get(e);o&&(o.delete(t),0===o.size&&this._elementAnimations.delete(e))}_getEasingFunction(e){return re[e]||re.easeOutCubic}_updateFPS(e){this._fpsHistory.push(e),this._fpsHistory.length>60&&this._fpsHistory.shift();const t=this._fpsHistory.reduce((e,t)=>e+t,0);this._stats.averageFPS=Math.round(t/this._fpsHistory.length)}_getCurrentFPS(){return 0===this._fpsHistory.length?0:Math.round(this._fpsHistory[this._fpsHistory.length-1])}_log(e,...t){if(!this._debug&&"debug"===e)return;const o=d||console;o[e]&&o[e]("[AnimationHelper]",...t)}}let ie=null;function ae(){return ie||(ie=new AnimationHelper),ie}const le={LEVELS:{ERROR:"error",WARN:"warn",INFO:"info",DEBUG:"debug"},error:function(e,t,o){const n=`[${e}] ${t}`;d&&"function"==typeof d.error&&(d.error(n,o),o&&o.stack&&d.error(`  Stack: ${o.stack}`))},warn:function(e,t){const o=`[${e}] ${t}`;d&&"function"==typeof d.warn&&d.warn(o)},info:function(e,t){const o=`[${e}] ${t}`;d&&"function"==typeof d.info&&d.info(o)},debug:function(){d&&d.debug},quotaError:function(e,t,o){const n=`QUOTA EXCEEDED - Available: ${(t/1024/1024/1024).toFixed(2)}GB, Needed: ${(o/1024/1024/1024).toFixed(2)}GB, Shortage: ${((o-t)/1024/1024/1024).toFixed(2)}GB`;this.error(e,n)},networkError:function(e,t,o,n){const r=`Network error [${o}] - ${t}`;this.error(e,r,n)},validationError:function(e,t,o){const n=`Validation error - ${t} (expected: ${o})`;this.warn(e,n)},idbError:function(e,t,o){const n=`IndexedDB error (${t})`;this.error(e,n,o)},performance:function(e,t,o){const n=`${t} completed in ${o}ms`;this.info(e,n)},memoryWarning:function(e,t){const o=`\u26a0\ufe0f High memory usage: ${t}MB`;this.warn(e,o)},operation:function(e,t){const o=performance.now();return{success:n=>{const r=performance.now()-o;return this.info(e,`${t} succeeded (${r.toFixed(0)}ms)`),n},error:n=>{const r=performance.now()-o;throw this.error(e,`${t} failed (${r.toFixed(0)}ms)`,n),n},warn:n=>{const r=performance.now()-o;this.warn(e,`${t} warning (${r.toFixed(0)}ms): ${n}`)}}}},se={dispatchCustomEvent(e,t={},o={}){const{bubbles:n=1,cancelable:r=1,target:i=document}=o;try{const o=new CustomEvent(e,{detail:t,bubbles:n,cancelable:r});return i.dispatchEvent(o),1}catch(t){return d.error&&d.error(`[EventHelpers] Failed to dispatch event '${e}':`,t),0}},dispatchMapEvent(e,t,o={}){if(!e||"function"!=typeof e.fire)return d.warn&&d.warn(`[EventHelpers] Invalid map instance, cannot fire '${t}'`),0;try{return e.fire(t,o),1}catch(e){return d.error&&d.error(`[EventHelpers] Failed to fire map event '${t}':`,e),0}},dispatchBoth(e,t={},o=null){const n=e.startsWith("geoleaf:")?e:`geoleaf:${e}`,r={document:0,map:0};return r.document=this.dispatchCustomEvent(n,t),o&&(r.map=this.dispatchMapEvent(o,n,t)),r},addEventListener:(e,t,o,n={})=>e&&"function"==typeof e.addEventListener?(e.addEventListener(t,o,n),()=>{try{e.removeEventListener(t,o,n)}catch(e){d.error&&d.error(`[EventHelpers] Failed to remove listener '${t}':`,e)}}):(d.warn&&d.warn(`[EventHelpers] Invalid target for addEventListener '${t}'`),()=>{}),addEventListeners(e=[]){const t=e.map(({target:e,event:t,handler:o,options:n})=>this.addEventListener(e,t,o,n));return()=>{t.forEach(e=>e())}},debounce(e,t=300,o=0){let n;return function(...r){const i=this,a=o&&!n;clearTimeout(n),n=setTimeout(()=>{n=null,o||e.apply(i,r)},t),a&&e.apply(i,r)}},throttle(e,t=300){let o;return function(...n){const r=Date.now();o?r-o>=t&&(e.apply(this,n),o=r):(e.apply(this,n),o=r)}}};class EventListenerManager{constructor(e="default"){this.name=e,this.listeners=[],this._nextId=1}addEventListener(e,t,o,n=0,r=""){if(!e||"function"!=typeof e.addEventListener)return d.warn(`[EventListenerManager.${this.name}] Invalid target for addEventListener`),null;const i=this._nextId++;return e.addEventListener(t,o,n),this.listeners.push({id:i,target:e,event:t,handler:o,options:n,label:r,createdAt:Date.now()}),this.name,i}addLeafletListener(e,t,o,n=""){if(!e||"function"!=typeof e.on)return d.warn(`[EventListenerManager.${this.name}] Invalid Leaflet target`),null;const r=this._nextId++;return e.on(t,o),this.listeners.push({id:r,target:e,event:t,handler:o,label:n,type:"leaflet",createdAt:Date.now()}),this.name,r}removeListener(e){const t=this.listeners.findIndex(t=>t.id===e);if(-1===t)return 0;const o=this.listeners[t];return"leaflet"===o.type?o.target&&"function"==typeof o.target.off&&o.target.off(o.event,o.handler):o.target&&"function"==typeof o.target.removeEventListener&&o.target.removeEventListener(o.event,o.handler,o.options),this.listeners.splice(t,1),this.name,o.label,1}removeListenersForTarget(e){const t=this.listeners.filter(t=>t.target===e);return t.forEach(e=>{"leaflet"===e.type?e.target&&"function"==typeof e.target.off&&e.target.off(e.event,e.handler):e.target&&"function"==typeof e.target.removeEventListener&&e.target.removeEventListener(e.event,e.handler,e.options)}),this.listeners=this.listeners.filter(t=>t.target!==e),d&&t.length>0&&d.info(`[EventListenerManager.${this.name}] Removed ${t.length} listener(s) for target`),t.length}removeAll(){const e=this.listeners.length;this.listeners.forEach(e=>{try{"leaflet"===e.type?e.target&&"function"==typeof e.target.off&&e.target.off(e.event,e.handler):e.target&&"function"==typeof e.target.removeEventListener&&e.target.removeEventListener(e.event,e.handler,e.options)}catch(e){d.warn(`[EventListenerManager.${this.name}] Error removing listener:`,e)}}),this.listeners=[],d&&e>0&&d.info(`[EventListenerManager.${this.name}] Removed ${e} listener(s)`)}getCount(){return this.listeners.length}listActiveListeners(){return this.listeners.map(e=>({id:e.id,event:e.event,label:e.label,type:e.type||"dom",age:Date.now()-e.createdAt}))}destroy(){this.removeAll(),d.info(`[EventListenerManager.${this.name}] Destroyed`)}}const ce=new EventListenerManager("global");"undefined"!=typeof window&&window.addEventListener("beforeunload",()=>{const e=ce.getCount();e>0&&(d.warn(`[EventListenerManager] ${e} listener(s) still active at page unload`),ce.removeAll())});const ue={on:(e,t,o,n,r)=>ce.addEventListener(e,t,o,n,r),onLeaflet:(e,t,o,n)=>ce.addLeafletListener(e,t,o,n),off:e=>ce.removeListener(e),offTarget:e=>ce.removeListenersForTarget(e),offAll:()=>ce.removeAll(),getCount:()=>ce.getCount(),listActive:()=>ce.listActiveListeners(),createManager:e=>new EventListenerManager(e)};function de(){const e=new Map;function t(t,n){return e.has(t)||e.set(t,new Set),e.get(t).add(n),()=>o(t,n)}function o(t,o){const n=e.get(t);n&&n.delete(o)}return{on:t,off:o,emit:function(t,o){const n=e.get(t);n&&n.forEach(e=>{try{e(o)}catch(e){}})},once:function(e,n){const r=t=>{o(e,r),n(t)};return t(e,r)},clear:function(t){t?e.delete(t):e.clear()}}}const fe=de(),pe={timeout:1e4,retries:2,retryDelay:1e3,retryDelayMultiplier:1.5,cache:"default",credentials:"same-origin",parseResponse:1,throwOnError:1,validateUrl:1},ge={_requests:new Map,maxPerDomain:50,windowMs:1e4,allow(e){let t;try{t=new URL(e,globalThis.location?.origin||"https://localhost").hostname}catch{t="_relative"}const o=Date.now();let n=this._requests.get(t)||[];return n=n.filter(e=>o-e<this.windowMs),n.length>=this.maxPerDomain?0:(n.push(o),this._requests.set(t,n),1)},reset(){this._requests.clear()}},he={async fetch(e,t={}){const o={...pe,...t};let n=0;if(!ge.allow(e))throw new FetchError("Rate limit exceeded for this domain",{url:e,type:"rate_limit_error"});if(o.validateUrl&&C?.validateUrl)try{const t=C.validateUrl(e);if(t&&"object"==typeof t){if(!t.valid)throw new Error(t.error||"URL validation failed");e=t.url||e}else"string"==typeof t&&(e=t)}catch(t){throw new FetchError(`URL validation failed: ${t.message}`,{url:e,cause:t,type:"validation_error"})}for(;n<=o.retries;)try{const t=await this._executeRequest(e,o,n);return d&&n>0&&d.info(`[FetchHelper] \u2713 ${e} (succeeded after ${n} retries)`),t}catch(t){if(n++,n>o.retries)throw new FetchError(`Request failed after ${o.retries+1} attempts: ${t.message}`,{url:e,attempts:n,cause:t,type:"AbortError"===t.name?"timeout":"network_error"});const r=o.retryDelay*Math.pow(o.retryDelayMultiplier,n-1);if(o.onRetry&&"function"==typeof o.onRetry)try{o.onRetry(n,t,r)}catch(e){d.warn("[FetchHelper] onRetry callback failed:",e)}d&&d.warn(`[FetchHelper] Retry ${n}/${o.retries} for ${e} in ${r}ms (${t.message})`),await this._delay(r)}},async _executeRequest(e,t,o){const n=new AbortController,r=setTimeout(()=>{if(n.abort(),t.onTimeout&&"function"==typeof t.onTimeout)try{t.onTimeout(e,t.timeout,o)}catch(e){d.warn("[FetchHelper] onTimeout callback failed:",e)}},t.timeout);try{const o={...t};delete o.timeout,delete o.retries,delete o.retryDelay,delete o.retryDelayMultiplier,delete o.parseResponse,delete o.throwOnError,delete o.validateUrl,delete o.onRetry,delete o.onTimeout,o.signal=n.signal;const i=await fetch(e,o);if(clearTimeout(r),!i.ok&&t.throwOnError)throw new Error(`HTTP ${i.status}: ${i.statusText}`);return t.parseResponse&&i.ok?await this._parseResponse(i):i}catch(e){if(clearTimeout(r),"AbortError"===e.name)throw new Error(`Request timed out after ${t.timeout}ms`);throw e}},async _parseResponse(e){const t=e.headers.get("content-type")||"";return t.includes("application/json")?await e.json():t.includes("text/")||t.includes("application/javascript")?await e.text():t.startsWith("image/")||t.includes("application/octet-stream")?await e.blob():await e.text()},_delay:async e=>new Promise(t=>setTimeout(t,e)),async get(e,t={}){return this.fetch(e,{...t,method:"GET"})},async post(e,t,o={}){const n={...o,method:"POST",headers:{"Content-Type":"application/json",...o.headers},body:"string"==typeof t?t:JSON.stringify(t)};return this.fetch(e,n)},async head(e,t={}){return this.fetch(e,{...t,method:"HEAD",parseResponse:0})},async exists(e,t={}){try{return(await this.head(e,{...t,throwOnError:0})).ok}catch(e){return e.message,0}},configure(e){Object.assign(pe,e)},getConfig:()=>({...pe})};class FetchError extends Error{constructor(e,t={}){super(e),this.name="FetchError",this.url=t.url,this.attempts=t.attempts,this.type=t.type||"unknown",this.cause=t.cause,Error.captureStackTrace&&Error.captureStackTrace(this,FetchError)}}const ye={locale:"fr-FR"};function me(e,t={}){const{locale:o=ye.locale,decimals:n=null,minDecimals:r=0,maxDecimals:i=2}=t;if(null==e||isNaN(e))return"0";const a={};return null!==n?(a.minimumFractionDigits=n,a.maximumFractionDigits=n):(a.minimumFractionDigits=r,a.maximumFractionDigits=i),e.toLocaleString(o,a)}const be=104857600,_e=[{signature:[255,216,255],offset:0,mime:"image/jpeg",extensions:["jpg","jpeg"]},{signature:[137,80,78,71,13,10,26,10],offset:0,mime:"image/png",extensions:["png"]},{signature:[71,73,70,56,55,97],offset:0,mime:"image/gif",extensions:["gif"]},{signature:[71,73,70,56,57,97],offset:0,mime:"image/gif",extensions:["gif"]},{signature:[82,73,70,70],offset:0,mime:"image/webp",extensions:["webp"],extraCheck:e=>e.length>=12&&87===e[8]&&69===e[9]&&66===e[10]&&80===e[11]},{signature:[66,77],offset:0,mime:"image/bmp",extensions:["bmp"]},{signature:[37,80,68,70],offset:0,mime:"application/pdf",extensions:["pdf"]},{signature:[80,75,3,4],offset:0,mime:"application/zip",extensions:["zip","kmz"]},{signature:[80,75,5,6],offset:0,mime:"application/zip",extensions:["zip","kmz"]},{signature:[80,75,7,8],offset:0,mime:"application/zip",extensions:["zip","kmz"]}],Le=["jpg","jpeg","png","gif","webp","bmp","svg","geojson","json","kml","gpx","kmz","pdf","txt","csv"],ve=["image/jpeg","image/png","image/gif","image/webp","image/bmp","image/svg+xml","application/json","application/geo+json","application/vnd.google-earth.kml+xml","application/vnd.google-earth.kmz","application/gpx+xml","application/pdf","text/plain","text/csv","application/zip"],we={async validateFile(e,t={}){const{maxSize:o=be,allowedExtensions:n=Le,allowedMimeTypes:r=ve,checkMagicBytes:i=1}=t,a={valid:0,error:null,details:{fileName:e.name,fileSize:e.size,mimeType:e.type,extension:this._getFileExtension(e.name)}};try{if(!e)return a.error="No file provided",a;if(e.name){const t=[/\.\./,/[/\\]/,/[\0-\x1f]/,/^\.+$/];for(const o of t)if(o.test(e.name))return a.error="Filename contains dangerous characters (path traversal attempt?)",d.warn("[FileValidator] Dangerous filename rejected:",e.name.substring(0,50)),a;if(e.name.length>255)return a.error="Filename too long (max 255 characters)",a}if(e.size>o)return a.error=`File size (${this._formatBytes(e.size)}) exceeds maximum allowed (${this._formatBytes(o)})`,d.warn("[FileValidator] File too large:",a.error),a;if(0===e.size)return a.error="File is empty",a;const t=this._getFileExtension(e.name);if(!t)return a.error="File has no extension",a;if(!n.includes(t.toLowerCase()))return a.error=`File extension '.${t}' is not allowed. Allowed: ${n.join(", ")}`,d.warn("[FileValidator] Invalid extension:",a.error),a;if(e.type&&!r.includes(e.type))return a.error=`MIME type '${e.type}' is not allowed`,d.warn("[FileValidator] Invalid MIME type:",a.error),a;if(i&&this._needsMagicBytesCheck(t)){const o=await this._validateMagicBytes(e,t);if(!o.valid)return a.error=o.error||"Magic bytes validation failed",d.warn("[FileValidator] Magic bytes check failed:",a.error),a;a.details.magicBytesMatch=o.matchedType}if(this._isTextFile(t)){const o=await this._validateTextFile(e,t);if(!o.valid)return a.error=o.error||"Text file validation failed",d.warn("[FileValidator] Text file validation failed:",a.error),a}return a.valid=1,d.info("[FileValidator] File validation successful:",e.name),a}catch(e){return a.error=`Validation error: ${e.message}`,d.error("[FileValidator] Validation exception:",e),a}},async _validateMagicBytes(e,t){try{const o=await this._readFileBytes(e,0,32),n=_e.filter(e=>{if(!e.extensions.includes(t.toLowerCase()))return 0;for(let t=0;t<e.signature.length;t++)if(o[e.offset+t]!==e.signature[t])return 0;return e.extraCheck&&!e.extraCheck(o)?0:1});return 0===n.length?{valid:0,error:`File signature does not match extension '.${t}'. File may be corrupted or renamed.`}:{valid:1,matchedType:n[0].mime}}catch(e){return{valid:0,error:`Error reading file signature: ${e.message}`}}},async _validateTextFile(e,t){try{const o=await this._readFileAsText(e,1048576);if("json"===t||"geojson"===t)try{return JSON.parse(o),{valid:1}}catch(e){return{valid:0,error:`Invalid JSON: ${e.message}`}}return"kml"!==t&&"gpx"!==t&&"svg"!==t||o.trim().startsWith("<?xml")||o.trim().startsWith("<")?{valid:1}:{valid:0,error:"Invalid XML: File does not start with XML declaration or tag"}}catch(e){return{valid:0,error:`Error reading text file: ${e.message}`}}},_readFileBytes:(e,t,o)=>new Promise((n,r)=>{const i=new FileReader,a=e.slice(t,t+o);i.onload=e=>{const t=e.target.result,o=new Uint8Array(t);n(o)},i.onerror=()=>{r(new Error("Failed to read file bytes"))},i.readAsArrayBuffer(a)}),_readFileAsText:(e,t=null)=>new Promise((o,n)=>{const r=new FileReader,i=t?e.slice(0,t):e;r.onload=e=>{o(e.target.result)},r.onerror=()=>{n(new Error("Failed to read file as text"))},r.readAsText(i)}),_getFileExtension(e){if(!e||"string"!=typeof e)return"";const t=e.split(".");return t.length>1?t[t.length-1]:""},_needsMagicBytesCheck(e){const t=e.toLowerCase();return["jpg","jpeg","png","gif","webp","bmp","pdf"].includes(t)},_isTextFile(e){const t=e.toLowerCase();return["json","geojson","kml","gpx","svg","txt","csv"].includes(t)},_formatBytes:e=>function(e,t={}){const{precision:o=2,locale:n=ye.locale}=t;if(null==e||isNaN(e)||0===e)return"0 B";const r=Math.floor(Math.log(e)/Math.log(1024));return`${(e/Math.pow(1024,r)).toLocaleString(n,{minimumFractionDigits:0===r?0:o,maximumFractionDigits:0===r?0:o})} ${["B","KB","MB","GB","TB"][r]}`}(e,{precision:2}),getConfig:()=>({maxFileSize:be,allowedExtensions:[...Le],allowedMimeTypes:[...ve],magicBytesSignatures:_e.map(e=>({mime:e.mime,extensions:e.extensions}))})},Ce={ensureMap(e=null){if(e&&"object"==typeof e&&this._isLeafletMap(e))return e;if(z?.getMap&&"function"==typeof z.getMap){const e=z.getMap();if(e&&this._isLeafletMap(e))return e}return null},requireMap(e=null,t="Unknown"){const o=this.ensureMap(e);if(!o){const o=[];throw null!==e&&o.push("explicit parameter"),z&&o.push("(Core module)"),new Error(`[${t}] No Leaflet map instance found. Tried: ${o.length?o.join(", "):"no sources available"}. Ensure map is initialized or passed as option.`)}return o},_isLeafletMap:e=>e&&"object"==typeof e?"function"==typeof e.getCenter&&"function"==typeof e.setView&&"function"==typeof e.getBounds&&"function"==typeof e.on&&"function"==typeof e.off:0,hasMap(e=null){return null!==this.ensureMap(e)},getMapDiagnostic(e=null){const t={map:null,found:0,source:"none",isValid:0};if(e&&"object"==typeof e&&this._isLeafletMap(e))return t.map=e,t.found=1,t.source="explicit",t.isValid=1,t;if(z?.getMap&&"function"==typeof z.getMap){const e=z.getMap();if(e&&this._isLeafletMap(e))return t.map=e,t.found=1,t.source="core",t.isValid=1,t}return t}},Ie="geoleaf_performance_baseline",Se=/\.(jpg|jpeg|png|gif|svg|webp)$/i,Ee={monitoring:{enabled:0,interval:5e3,maxDataPoints:60},memory:{enabled:1,threshold:209715200,leakDetection:1},marks:{enabled:1,autoMark:["init","ready","firstLoad"]},baseline:{enabled:1,storage:"sessionStorage"}};let Ae={marks:new Map,measures:new Map,memory:[],baseline:null};class PerformanceProfiler{constructor(e={}){this.config=this._mergeConfig(Ee,e),this.monitoringInterval=null,this.baselineEstablished=0}init(){this.config.monitoring.enabled=this._isDevelopmentMode(),this._initPerformanceObserver(),this._loadBaseline(),this.config.monitoring.enabled&&this._startMonitoring(),d&&d.info("[GeoLeaf.Utils.PerformanceProfiler] Performance profiler initialized")}startMonitoring(){this.monitoringInterval&&this.stopMonitoring(),this._startMonitoring(),d&&d.info("[PerformanceProfiler] Monitoring started")}stopMonitoring(){this.monitoringInterval&&(clearInterval(this.monitoringInterval),this.monitoringInterval=null,d&&d.info("[PerformanceProfiler] Monitoring stopped"))}mark(e){if(!this.config.marks.enabled)return;const t=performance.now();try{performance.mark(e),Ae.marks.set(e,t),d&&t.toFixed(2)}catch(t){d&&d.warn(`[PerformanceProfiler] Failed to create mark ${e}:`,t)}}measure(e,t,o){try{performance.measure(e,t,o);const n=performance.getEntriesByName(e,"measure"),r=n[n.length-1],i=r?r.duration:0;return Ae.measures.set(e,i),d&&i.toFixed(2),i}catch(t){return d&&d.warn(`[PerformanceProfiler] Failed to create measure ${e}:`,t),0}}getMemoryUsage(){const e={timestamp:performance.now(),used:0,total:0,available:0};try{performance.memory&&(e.used=performance.memory.usedJSHeapSize,e.total=performance.memory.totalJSHeapSize,e.available=performance.memory.jsHeapSizeLimit)}catch(e){}return e}analyzeMemoryLeaks(){if(Ae.memory.length<10)return{status:"insufficient_data"};const e=Ae.memory.slice(-30),t=e[0].used,o=e[e.length-1].used,n=(o-t)/t,r={status:"normal",growthRate:n,memoryTrend:o>t?"increasing":"decreasing",recommendation:"No action needed"};return n>.2&&(r.status="warning",r.recommendation="Monitor memory usage - potential leak detected"),n>.5&&(r.status="critical",r.recommendation="Investigate memory leak - significant growth detected"),r}generateReport(){const e=this.getMemoryUsage(),t=this.analyzeMemoryLeaks();return{timestamp:(new Date).toISOString(),session:{duration:performance.now(),marks:Object.fromEntries(Ae.marks),measures:Object.fromEntries(Ae.measures)},memory:{current:e,peak:this._getPeakMemory(),analysis:t,history:Ae.memory.slice(-10)},performance:{navigation:this._getNavigationTiming(),paint:this._getPaintTiming(),resources:this._getResourceTiming(),longTasks:this._getLongTasks()},baseline:this._compareWithBaseline(),recommendations:this._generateRecommendations()}}establishBaseline(){const e={timestamp:(new Date).toISOString(),navigation:this._getNavigationTiming(),paint:this._getPaintTiming(),memory:this.getMemoryUsage(),userAgent:navigator.userAgent,viewport:{width:window.innerWidth,height:window.innerHeight}};return Ae.baseline=e,this.baselineEstablished=1,this.config.baseline.enabled&&this._saveBaseline(e),d&&d.info("[PerformanceProfiler] Performance baseline established"),e}exportForDevTools(){return function({marks:e,measures:t}){const o={traceEvents:[],metadata:{"cpu-family":6,"cpu-model":70,"cpu-stepping":1,"field-name-mappings":{},"os-name":navigator.platform,"trace-capture-datetime":(new Date).toISOString(),"user-agent":navigator.userAgent}};return e.forEach((e,t)=>{o.traceEvents.push({name:t,cat:"blink.user_timing",ph:"I",ts:1e3*e,pid:1,tid:1})}),t.forEach((e,t)=>{const n=performance.now()-e;o.traceEvents.push({name:t,cat:"blink.user_timing",ph:"B",ts:1e3*n,pid:1,tid:1},{name:t,cat:"blink.user_timing",ph:"E",ts:1e3*(n+e),pid:1,tid:1})}),o}(Ae)}_initPerformanceObserver(){if("PerformanceObserver"in window)try{new PerformanceObserver(e=>{this._processPerformanceEntries(e.getEntries())}).observe({entryTypes:["navigation","paint","measure","mark","longtask"]})}catch(e){d&&d.warn("[PerformanceProfiler] PerformanceObserver initialization failed:",e)}}_processPerformanceEntries(e){e.forEach(e=>{switch(e.entryType){case"longtask":d&&d.warn(`[PerformanceProfiler] Long task detected: ${e.duration.toFixed(2)}ms`);break;case"measure":Ae.measures.set(e.name,e.duration);break;case"mark":Ae.marks.set(e.name,e.startTime)}})}_startMonitoring(){this.monitoringInterval=setInterval(()=>{this._collectPerformanceData()},this.config.monitoring.interval)}_collectPerformanceData(){const e=this.getMemoryUsage();Ae.memory.push(e),Ae.memory.length>this.config.monitoring.maxDataPoints&&Ae.memory.shift(),this.config.memory.enabled&&e.used>this.config.memory.threshold&&d&&d.warn(`[PerformanceProfiler] Memory usage high: ${(e.used/1024/1024).toFixed(2)}MB`)}_getNavigationTiming(){try{const e=performance.getEntriesByType("navigation")[0];return e?{domContentLoaded:e.domContentLoadedEventEnd-e.domContentLoadedEventStart,load:e.loadEventEnd-e.loadEventStart,domComplete:e.domComplete-e.navigationStart,firstByte:e.responseStart-e.requestStart,dns:e.domainLookupEnd-e.domainLookupStart,tcp:e.connectEnd-e.connectStart}:null}catch(e){return null}}_getPaintTiming(){try{const e=performance.getEntriesByType("paint"),t={};return e.forEach(e=>{t[e.name]=e.startTime}),t}catch(e){return{}}}_getResourceTiming(){try{const e=performance.getEntriesByType("resource"),t={total:e.length,scripts:0,stylesheets:0,images:0,totalSize:0,totalDuration:0};return e.forEach(e=>{e.name.includes(".js")?t.scripts++:e.name.includes(".css")?t.stylesheets++:Se.test(e.name)&&t.images++,e.transferSize&&(t.totalSize+=e.transferSize),t.totalDuration+=e.duration}),t}catch(e){return{total:0}}}_getLongTasks(){try{return performance.getEntriesByType("longtask").map(e=>({duration:e.duration,startTime:e.startTime}))}catch(e){return[]}}_getPeakMemory(){return 0===Ae.memory.length?this.getMemoryUsage():Ae.memory.reduce((e,t)=>t.used>e.used?t:e)}_compareWithBaseline(){if(!Ae.baseline)return{status:"no_baseline"};const e={navigation:this._getNavigationTiming(),paint:this._getPaintTiming(),memory:this.getMemoryUsage()},t={navigation:{},paint:{},memory:{},overall:"similar"};if(e.navigation&&Ae.baseline.navigation&&Object.keys(Ae.baseline.navigation).forEach(o=>{const n=Ae.baseline.navigation[o],r=e.navigation[o],i=(r-n)/n*100;t.navigation[o]={baseline:n,current:r,difference:i,status:Math.abs(i)>20?i>0?"worse":"better":"similar"}}),Object.keys(Ae.baseline.paint).forEach(o=>{if(e.paint[o]){const n=(e.paint[o]-Ae.baseline.paint[o])/Ae.baseline.paint[o]*100;t.paint[o]={baseline:Ae.baseline.paint[o],current:e.paint[o],difference:n,status:Math.abs(n)>20?n>0?"worse":"better":"similar"}}}),Ae.baseline.memory.used>0){const o=(e.memory.used-Ae.baseline.memory.used)/Ae.baseline.memory.used*100;t.memory={baseline:Ae.baseline.memory.used,current:e.memory.used,difference:o,status:Math.abs(o)>30?o>0?"worse":"better":"similar"}}return t}_generateRecommendations(){const e=[],t=this.analyzeMemoryLeaks(),o=this._getResourceTiming(),n=this._getLongTasks();if("warning"===t.status?e.push({type:"memory",priority:"medium",message:"Monitor memory usage - potential leak detected",action:"Check for event listener cleanup and object references"}):"critical"===t.status&&e.push({type:"memory",priority:"high",message:"Critical memory usage detected",action:"Immediate investigation required - check for memory leaks"}),n.length>0){const t=n.reduce((e,t)=>e+t.duration,0)/n.length;e.push({type:"performance",priority:"medium",message:`${n.length} long tasks detected (avg: ${t.toFixed(2)}ms)`,action:"Consider breaking up long-running operations with setTimeout or requestIdleCallback"})}return o.total>50&&e.push({type:"resources",priority:"low",message:`High number of resources loaded (${o.total})`,action:"Consider bundling or lazy loading resources"}),e}_isDevelopmentMode(){return globalThis.location&&"localhost"===globalThis.location.hostname||globalThis.location&&"127.0.0.1"===globalThis.location.hostname||globalThis.location&&globalThis.location.port||1==globalThis.GeoLeaf?.DEBUG}_loadBaseline(){if(!this.config.baseline.enabled)return;const e=function(e){try{const t=("localStorage"===e?localStorage:sessionStorage).getItem(Ie);if(t)return JSON.parse(t)}catch(e){}return null}(this.config.baseline.storage);e&&(Ae.baseline=e,this.baselineEstablished=1)}_saveBaseline(e){!function(e,t){try{("localStorage"===t?localStorage:sessionStorage).setItem(Ie,JSON.stringify(e))}catch(e){}}(e,this.config.baseline.storage)}_mergeConfig(e,t){const o={...e};for(const n in t)"object"!=typeof t[n]||Array.isArray(t[n])?o[n]=t[n]:o[n]={...e[n],...t[n]};return o}}let Pe=null;function Ge(){return Pe||(Pe=new PerformanceProfiler,Pe.init()),Pe}window.addEventListener("load",()=>{Pe&&Pe.establishBaseline()},{once:1});const Te="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{},xe={modules:{timeout:15e3,retries:2,cacheBust:0},images:{rootMargin:"50px",threshold:.1,loadingClass:"lazy-loading",loadedClass:"lazy-loaded",errorClass:"lazy-error"},chunks:{preload:["core","ui"],defer:["poi","geojson","route","legend"]}},Oe=new Map,Me=new Map,ke={modulesLoaded:0,imagesLoaded:0,totalLoadTime:0,errors:0};class LazyLoader{constructor(e={}){this.config=this._mergeConfig(xe,e),this.imageObserver=null,this.init()}init(){this._preloadCoreModules(),d&&d.info("[GeoLeaf.Utils.LazyLoader] Lazy loading system initialized")}async loadModule(e,t,o={}){const n=performance.now();try{if(Oe.has(e))return Oe.get(e);if(Me.has(e))return await Me.get(e);const r=this._loadModuleScript(e,t,o);Me.set(e,r);const i=await r;Oe.set(e,i),Me.delete(e);const a=performance.now()-n;return ke.modulesLoaded++,ke.totalLoadTime+=a,d&&d.info(`[LazyLoader] Module "${e}" loaded in ${a.toFixed(2)}ms`),i}catch(t){throw Me.delete(e),ke.errors++,d&&d.error(`[LazyLoader] Failed to load module "${e}":`,t),t}}async _loadModuleScript(e,t,o){const n={...this.config.modules,...o},r=n.cacheBust?`${t}?v=${Date.now()}`:t,i=import(r);if(!n.timeout)return i;const a=new Promise((t,o)=>setTimeout(()=>o(new Error(`Module "${e}" load timeout`)),n.timeout));return Promise.race([i,a])}_extractModuleExports(e){const t=[`GeoLeaf.${e}`,`GeoLeaf._${e}`,`GeoLeaf.Utils.${e}`,e];for(const e of t){const t=this._getNestedProperty(Te,e);if(t)return t}return{name:e,loaded:1}}_getNestedProperty(e,t){return t.split(".").reduce((e,t)=>e&&void 0!==e[t]?e[t]:null,e)}_ensureObserver(){this.imageObserver||this._initImageObserver()}_initImageObserver(){"IntersectionObserver"in window&&(this.imageObserver=new IntersectionObserver(e=>this._handleImageIntersection(e),{rootMargin:this.config.images.rootMargin,threshold:this.config.images.threshold}))}_handleImageIntersection(e){e.forEach(e=>{if(e.isIntersecting){const t=e.target;this._loadImage(t),this.imageObserver.unobserve(t)}})}_loadImage(e){const t=this.config.images;e.classList.add(t.loadingClass);const o=performance.now(),n=new Image;n.onload=()=>{e.src=n.src,e.classList.remove(t.loadingClass),e.classList.add(t.loadedClass);const r=performance.now()-o;ke.imagesLoaded++,d&&(r.toFixed(2),e.src)},n.onerror=()=>{e.classList.remove(t.loadingClass),e.classList.add(t.errorClass),ke.errors++,d&&d.warn(`[LazyLoader] Image load failed: ${n.src}`)},n.src=e.dataset.src||e.src}enableImageLazyLoading(e="img[data-src]"){this._ensureObserver();const t=document.querySelectorAll(e);this.imageObserver?t.forEach(e=>this.imageObserver.observe(e)):t.forEach(e=>this._loadImage(e)),d&&d.info(`[LazyLoader] Enabled lazy loading for ${t.length} images`)}scan(e="img[data-src]"){this._ensureObserver();const t=document.querySelectorAll(e);return t.length&&(this.imageObserver?t.forEach(e=>this.imageObserver.observe(e)):t.forEach(e=>this._loadImage(e)),d&&d.info(`[LazyLoader] scan() \u2014 ${t.length} image(s) trouv\xe9e(s)`)),t.length}initialize(e={}){const{autoScan:t=1,selector:o="img[data-src]"}=e;t&&("loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>this.scan(o),{once:1}):this.scan(o))}_preloadCoreModules(){this.config.chunks.preload.forEach(e=>{!Oe.has(e)&&this._shouldPreloadModule(e)&&this._preloadModule(e)})}_shouldPreloadModule(e){const t=this._extractModuleExports(e);return!t||t.name===e}_preloadModule(e){const t=this._getModulePath(e);if(t){const e=document.createElement("link");e.rel="prefetch",e.href=t,document.head.appendChild(e)}}_getModulePath(e){const t={poi:"poi/add-form-orchestrator.js",geojson:"geojson/loader.js",route:"geoleaf.route.js",legend:"geoleaf.legend.js",themes:"themes/theme-loader.js"},o=this._getBasePath();return t[e]?`${o}/${t[e]}`:null}_getBasePath(){const e=document.getElementsByTagName("script");for(const t of e)if(t.src&&t.src.includes("geoleaf")){const e=t.src.split("/");return e.pop(),e.join("/")}return"./src/modules"}_loadAllImages(){document.querySelectorAll("img[data-src]").forEach(e=>this._loadImage(e))}getMetrics(){return{...ke,averageLoadTime:ke.modulesLoaded>0?ke.totalLoadTime/ke.modulesLoaded:0}}clearCache(){Oe.clear(),Me.clear(),d&&d.info("[LazyLoader] Module cache cleared")}_mergeConfig(e,t){const o={...e};for(const n in t)"object"!=typeof t[n]||Array.isArray(t[n])?o[n]=t[n]:o[n]={...e[n],...t[n]};return o}}let Ne=null;function Fe(){return Ne||(Ne=new LazyLoader),Ne}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{Fe().initialize()},{once:1}):Promise.resolve().then(()=>Fe().initialize());class TimerManager{constructor(e="default"){this.name=e,this.timers=new Map,this.intervals=new Map,this._nextId=1}setTimeout(e,t,o=""){const n=this._nextId++,r=setTimeout(()=>{try{e()}finally{this.timers.delete(n)}},t);return this.timers.set(n,{timerId:r,label:o,type:"timeout",createdAt:Date.now(),delay:t}),this.name,n}setInterval(e,t,o=""){const n=this._nextId++,r=setInterval(()=>{try{e()}catch(e){d.error(`[TimerManager.${this.name}] Error in interval ${n}:`,e)}},t);return this.intervals.set(n,{intervalId:r,label:o,type:"interval",createdAt:Date.now(),interval:t}),this.name,n}clearTimeout(e){const t=this.timers.get(e);return t?(clearTimeout(t.timerId),this.timers.delete(e),this.name,t.label,1):0}clearInterval(e){const t=this.intervals.get(e);return t?(clearInterval(t.intervalId),this.intervals.delete(e),this.name,t.label,1):0}clearAll(){for(const[e,t]of this.timers.entries())clearTimeout(t.timerId);for(const[e,t]of this.intervals.entries())clearInterval(t.intervalId);const e=this.timers.size+this.intervals.size;this.timers.clear(),this.intervals.clear(),d&&e>0&&d.info(`[TimerManager.${this.name}] Cleared ${e} timer(s)`)}getStats(){return{timeouts:this.timers.size,intervals:this.intervals.size,total:this.timers.size+this.intervals.size}}listActiveTimers(){const e=[];for(const[t,o]of this.timers.entries())e.push({id:t,type:"timeout",label:o.label,age:Date.now()-o.createdAt,delay:o.delay});for(const[t,o]of this.intervals.entries())e.push({id:t,type:"interval",label:o.label,age:Date.now()-o.createdAt,interval:o.interval});return e}destroy(){this.clearAll(),d.info(`[TimerManager.${this.name}] Destroyed`)}}const De=new TimerManager("global");function Ue(e,t){if(!e||"object"!=typeof e)return null;if(!t||"string"!=typeof t)return null;const o=t.split(".");let n=e;for(const e of o){if(null==n)return null;n=n[e]}return void 0!==n?n:null}function Re(e,t){if(!e||"object"!=typeof e||!t)return 0;const o=t.split(".");let n=e;for(const e of o){if(null==n||!Object.prototype.hasOwnProperty.call(n,e))return 0;n=n[e]}return 1}function je(e,t,o){if(!e||"object"!=typeof e)throw new Error("[ObjectUtils.setNestedValue] Invalid object");if(!t||"string"!=typeof t)throw new Error("[ObjectUtils.setNestedValue] Invalid path");const n=t.split("."),r=n.pop();let i=e;for(const e of n)e in i&&"object"==typeof i[e]||(i[e]={}),i=i[e];return i[r]=o,e}"undefined"!=typeof window&&window.addEventListener("beforeunload",()=>{const e=De.getStats();e.total>0&&(d.warn(`[TimerManager] ${e.total} timer(s) still active at page unload`),De.clearAll())});const $e={zoom:null,lat:null,scale:null};function Be(e,t={}){if(!e)return 0;const o=t.logger,n=e.getCenter?.(),r=e.getZoom?.();if(!n||"number"!=typeof r)return 0;if(!t.force&&$e.zoom===r&&$e.lat===n.lat)return $e.scale||0;const i=156543.04*Math.cos(n.lat*Math.PI/180)/Math.pow(2,r)*96,a=Math.round(i/.0254);return $e.zoom=r,$e.lat=n.lat,$e.scale=a,o&&"function"==typeof o.debug&&o.debug(`[ScaleUtils] Calcul \xe9chelle: zoom=${r}, lat=${n.lat.toFixed(2)}, \xe9chelle=1:${a.toLocaleString()}`),a}function ze(e,t,o,n){const r="number"==typeof t&&t>0?t:null,i="number"==typeof o&&o>0?o:null;return null!==r&&e>r?(n&&"function"==typeof n.debug&&n.debug(`[ScaleUtils] ${e} > minScale ${r} \u2192 invisible (trop d\xe9zoom\xe9)`),0):null!==i&&e<i?(n&&"function"==typeof n.debug&&n.debug(`[ScaleUtils] ${e} < maxScale ${i} \u2192 invisible (trop zoom\xe9)`),0):(n&&"function"==typeof n.debug&&n.debug(`[ScaleUtils] ${e} dans [${i??"\u221e"} ; ${r??"\u221e"}] \u2192 visible`),1)}const Ve="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{};Ve.GeoLeaf=Ve.GeoLeaf||{},Ve.GeoLeaf._version="4.0.0",Ve.GeoLeaf.Log=d,Ve.GeoLeaf.Errors=g,Ve.GeoLeaf.CONSTANTS=h,Ve.GeoLeaf.Security||(Ve.GeoLeaf.Security={}),Object.assign(Ve.GeoLeaf.Security,C),Ve.GeoLeaf.Security.CSRFToken=S,Ve.GeoLeaf.Utils||(Ve.GeoLeaf.Utils={}),Object.assign(Ve.GeoLeaf.Utils,Y),Ve.GeoLeaf.Utils.AnimationHelper=AnimationHelper,Object.defineProperty(Ve.GeoLeaf.Utils,"animationHelper",{get:()=>ae(),configurable:1}),Ve.GeoLeaf.Utils.createElement=te,Ve.GeoLeaf.Utils.DOMSecurity=ee,Ve.GeoLeaf.DOMSecurity=ee,Ve.GeoLeaf.Utils.ErrorLogger=le,Ve.GeoLeaf.Utils.EventHelpers=se,Ve.GeoLeaf.Utils.EventListenerManager=EventListenerManager,Ve.GeoLeaf.Utils.events=ue,Ve.GeoLeaf.Utils.globalEventManager=ce,Ve.GeoLeaf.Bus=fe,Ve.GeoLeaf.Utils.createEventBus=de,Ve.GeoLeaf.Utils.FetchHelper=he,Ve.GeoLeaf.Utils.FetchError=FetchError,Ve.GeoLeaf.Utils.FileValidator=we,Ve.GeoLeaf.FileValidator=we,Ve.GeoLeaf.Utils.MapHelpers=Ce,Ve.GeoLeaf.Utils.PerformanceProfiler=PerformanceProfiler,Object.defineProperty(Ve.GeoLeaf.Utils,"performanceProfiler",{get:()=>Ge(),configurable:1}),Ve.GeoLeaf.Utils.LazyLoader=LazyLoader,Object.defineProperty(Ve.GeoLeaf.Utils,"lazyLoader",{get:()=>Fe(),configurable:1}),Ve.GeoLeaf.Utils.TimerManager=TimerManager,Ve.GeoLeaf.Utils.ObjectUtils={getNestedValue:Ue,hasNestedPath:Re,setNestedValue:je},Ve.GeoLeaf.Utils.getNestedValue=Ue,Ve.GeoLeaf.Utils.hasNestedPath=Re,Ve.GeoLeaf.Utils.setNestedValue=je,Ve.GeoLeaf.Utils.ScaleUtils={calculateMapScale:Be,isScaleInRange:ze,clearScaleCache:function(){$e.zoom=null,$e.lat=null,$e.scale=null}},Ve.GeoLeaf.fetch=he.fetch.bind(he),Ve.GeoLeaf.get=he.get.bind(he),Ve.GeoLeaf.post=he.post.bind(he),Ve.GeoLeaf.ensureMap=Ce.ensureMap.bind(Ce),Ve.GeoLeaf.requireMap=Ce.requireMap.bind(Ce),Ve.GeoLeaf.hasMap=Ce.hasMap.bind(Ce),Ve.GeoLeaf.animate=(...e)=>ae().animate(...e),Ve.GeoLeaf.fadeIn=(...e)=>ae().fadeIn(...e),Ve.GeoLeaf.fadeOut=(...e)=>ae().fadeOut(...e),Ve.GeoLeaf.mark=e=>Ge().mark(e),Ve.GeoLeaf.measure=(e,t,o)=>Ge().measure(e,t,o),Ve.GeoLeaf.getPerformanceReport=()=>Ge().generateReport(),Ve.GeoLeaf.establishBaseline=()=>Ge().establishBaseline(),Ve.GeoLeaf.loadModule=(e,t,o)=>Fe().loadModule(e,t,o),Ve.GeoLeaf.enableLazyImages=e=>Fe().enableImageLazyLoading(e),Ve.GeoLeaf.dispatchEvent=se.dispatchCustomEvent.bind(se),Ve.GeoLeaf.dispatchMapEvent=se.dispatchMapEvent.bind(se);const qe="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{};function Je(e,t){if(!e||!t)return null;const o=qe.GeoLeaf?._GeoJSONShared?.state?.layers?.get(t);if(!o)return null;const n=o.currentStyle;if(!n||!n.styleRules)return null;const r=e.categoryId||e.category||e.attributes&&e.attributes.categoryId||e.properties&&e.properties.categoryId||e.properties&&e.properties.category,i=e.subCategoryId||e.subCategory||e.sub_category||e.attributes&&e.attributes.subCategoryId||e.properties&&e.properties.subCategoryId||e.properties&&e.properties.sub_category;if(i){const e=n.styleRules.find(e=>e.when&&"properties.subCategoryId"===e.when.field&&e.when.value===i);if(e&&e.style)return{fillColor:e.style.fillColor,color:e.style.color,colorFill:e.style.fillColor,colorStroke:e.style.color}}if(r){const e=n.styleRules.find(e=>e.when&&"properties.categoryId"===e.when.field&&e.when.value===r);if(e&&e.style)return{fillColor:e.style.fillColor,color:e.style.color,colorFill:e.style.fillColor,colorStroke:e.style.color}}return n.defaultStyle?{fillColor:n.defaultStyle.fillColor,color:n.defaultStyle.color,colorFill:n.defaultStyle.fillColor,colorStroke:n.defaultStyle.color}:null}function He(e){const t={colorFill:null,colorStroke:null,colorRoute:null};if(!e||!e._layerConfig)return t;const o=Je(e,e._layerConfig.id);return o&&(t.colorFill=o.fillColor||o.colorFill,t.colorStroke=o.color||o.colorStroke,t.colorRoute=o.color||o.colorStroke),t}const Ze={getColorsFromLayerStyle:Je,resolvePoiColors:He};function We(e,t,o,n){Array.isArray(e)?e.forEach((e,o)=>{const r={...n,ruleIndex:o};"object"==typeof e&&null!==e?(e.when?Xe(e.when,o,t,0,r):t.push({field:`styleRules[${o}].when`,message:"Le champ 'when' est requis",context:r}),e.style?"object"==typeof e.style&&null!==e.style||t.push({field:`styleRules[${o}].style`,message:"Le style doit \xeatre un objet",context:{received:typeof e.style,...r}}):t.push({field:`styleRules[${o}].style`,message:"Le champ 'style' est requis",context:r}),e.legend&&"object"!=typeof e.legend&&t.push({field:`styleRules[${o}].legend`,message:"legend doit \xeatre un objet",context:{received:typeof e.legend,...r}})):t.push({field:`styleRules[${o}]`,message:"La r\xe8gle doit \xeatre un objet",context:r})}):t.push({field:"styleRules",message:"styleRules doit \xeatre un tableau",context:{received:typeof e,...n}})}function Xe(e,t,o,n,r){"object"==typeof e&&null!==e?e.all&&Array.isArray(e.all)?e.all.forEach((e,n)=>{Ye(e,t,n,o,r)}):Ye(e,t,null,o,r):o.push({field:`styleRules[${t}].when`,message:"when doit \xeatre un objet",context:{received:typeof e,...r}})}function Ye(e,t,o=null,n,r){const i=["field","operator","value"];for(const a of i)if(!(a in e)){const e=null!==o?`styleRules[${t}].when.all[${o}]`:`styleRules[${t}].when`;n.push({field:`${e}.${a}`,message:`Le champ '${a}' est requis dans la condition`,context:r})}const a=["==","!=","<",">","<=",">=","in","contains"];if(e.operator&&!a.includes(e.operator)){const i=null!==o?`styleRules[${t}].when.all[${o}]`:`styleRules[${t}].when`;n.push({field:`${i}.operator`,message:"Op\xe9rateur invalide",context:{received:e.operator,allowed:a,...r}})}if(e.field&&"string"!=typeof e.field){const i=null!==o?`styleRules[${t}].when.all[${o}]`:`styleRules[${t}].when`;n.push({field:`${i}.field`,message:"field doit \xeatre une cha\xeene de caract\xe8res",context:{received:typeof e.field,...r}})}}function Qe(e,t,o,n){["layerScale","labelScale"].forEach(o=>{const r="layerScale"===o;if(!e[o])return void(r&&t.push({field:o,message:`${o} est requis`,context:n}));const i=e[o];"object"==typeof i&&null!==i?["minScale","maxScale"].forEach(e=>{e in i?null!==i[e]&&("number"!=typeof i[e]||i[e]<0)&&t.push({field:`${o}.${e}`,message:`${e} doit \xeatre un nombre >= 0 ou null`,context:{received:i[e],...n}}):r&&t.push({field:`${o}.${e}`,message:`${e} est requis dans ${o}`,context:n})}):t.push({field:o,message:`${o} doit \xeatre un objet`,context:{received:typeof i,...n}})})}function Ke(e,t,o,n){"object"==typeof e&&null!==e?"order"in e&&!Number.isInteger(e.order)&&t.push({field:"legend.order",message:"order doit \xeatre un entier",context:{received:e.order,type:typeof e.order,...n}}):t.push({field:"legend",message:"legend doit \xeatre un objet",context:{received:typeof e,...n}})}const et={validateStyleRules:We,validateWhenCondition:Xe,validateSimpleCondition:Ye,validateScales:Qe,validateLegend:Ke};class StyleValidationError extends Error{constructor(e,t={}){super(e),this.name="StyleValidationError",this.context=t}}function tt(e,t,o,n,r){"object"==typeof e&&null!==e?(e.color&&!ot(e.color)&&o.push({field:`${t}.color`,message:"Couleur invalide, format attendu: #RRGGBB",context:{received:e.color,...r}}),"opacity"in e&&("number"!=typeof e.opacity||e.opacity<0||e.opacity>1)&&o.push({field:`${t}.opacity`,message:"L'opacit\xe9 doit \xeatre un nombre entre 0 et 1",context:{received:e.opacity,...r}}),"sizePx"in e&&("number"!=typeof e.sizePx||e.sizePx<0)&&o.push({field:`${t}.sizePx`,message:"sizePx doit \xeatre un nombre >= 0",context:{received:e.sizePx,...r}})):o.push({field:t,message:`${t} doit \xeatre un objet`,context:{received:typeof e,...r}})}function ot(e){return"string"==typeof e&&/^#[0-9A-Fa-f]{6}$/.test(e)}const nt={validateStyle:function(e,t={}){const o=[],n=[];try{if(!e||"object"!=typeof e)return o.push({field:"root",message:"Le style doit \xeatre un objet JSON valide",context:{received:typeof e,...t}}),{valid:0,errors:o,warnings:n};!function(e,t,o){"id"in e&&void 0!==e.id&&null!==e.id||t.push({field:"id",message:"Le champ requis 'id' est manquant",context:{availableFields:Object.keys(e),...o}});const n="style"in e&&void 0!==e.style&&null!==e.style,r="defaultStyle"in e&&void 0!==e.defaultStyle&&null!==e.defaultStyle;n||r||t.push({field:"style",message:"Le champ requis 'style' ou 'defaultStyle' est manquant",context:{availableFields:Object.keys(e),...o}}),"layerScale"in e||t.push({field:"layerScale",message:"Le champ requis 'layerScale' est manquant",context:{availableFields:Object.keys(e),...o}})}(e,o,t),function(e,t,o){if(!e.id)return;const n=/^[\p{L}0-9_-]+$/u;"string"!=typeof e.id?t.push({field:"id",message:"L'ID doit \xeatre une cha\xeene de caract\xe8res",context:{received:typeof e.id,value:e.id,...o}}):n.test(e.id)||t.push({field:"id",message:"L'ID doit contenir uniquement des lettres, chiffres, tirets et underscores",context:{received:e.id,pattern:n.toString(),...o}})}(e,o,t),function(e,t,o,n){if(!("label"in e))return;const r=e.label;"string"!=typeof r&&("object"==typeof r&&null!==r?("enabled"in r?"boolean"!=typeof r.enabled&&t.push({field:"label.enabled",message:"Le champ 'enabled' doit \xeatre un bool\xe9en",context:{received:typeof r.enabled,value:r.enabled,...n}}):t.push({field:"label.enabled",message:"Le champ 'enabled' est requis dans la configuration de labels",context:{labelConfig:r,...n}}),r.enabled&&!r.field&&o.push({field:"label.field",message:"Les labels sont activ\xe9s mais aucun champ n'est sp\xe9cifi\xe9",context:{labelConfig:r,...n}}),r.font&&function(e,t,o,n){"object"==typeof e&&null!==e?(void 0!==e.sizePt&&("number"!=typeof e.sizePt||e.sizePt<1)&&t.push({field:"label.font.sizePt",message:"sizePt doit \xeatre un nombre >= 1",context:{received:e.sizePt,...n}}),void 0!==e.weight&&(!Number.isInteger(e.weight)||e.weight<0||e.weight>100)&&t.push({field:"label.font.weight",message:"weight doit \xeatre un entier entre 0 et 100",context:{received:e.weight,...n}})):t.push({field:"label.font",message:"La configuration font doit \xeatre un objet",context:{received:typeof e,...n}})}(r.font,t,0,n),r.color&&!ot(r.color)&&t.push({field:"label.color",message:"Couleur invalide, format attendu: #RRGGBB",context:{received:r.color,...n}}),"opacity"in r&&("number"!=typeof r.opacity||r.opacity<0||r.opacity>1)&&t.push({field:"label.opacity",message:"L'opacit\xe9 doit \xeatre un nombre entre 0 et 1",context:{received:r.opacity,...n}}),r.buffer&&tt(r.buffer,"label.buffer",t,0,n),r.background&&tt(r.background,"label.background",t,0,n),r.offset&&void 0!==r.offset.distancePx&&"number"!=typeof r.offset.distancePx&&t.push({field:"label.offset.distancePx",message:"distancePx doit \xeatre un nombre",context:{received:typeof r.offset.distancePx,...n}})):t.push({field:"label",message:"Le champ 'label' doit \xeatre une cha\xeene de caract\xe8res ou un objet de configuration",context:{received:typeof r,value:r,...n}}))}(e,o,n,t),function(e,t,o,n){const r=e.style||e.defaultStyle;r&&("object"==typeof r&&null!==r?(["fillColor","color"].forEach(e=>{r[e]&&!ot(r[e])&&t.push({field:`style.${e}`,message:"Couleur invalide, format attendu: #RRGGBB",context:{received:r[e],...n}})}),["fillOpacity","opacity"].forEach(e=>{e in r&&("number"!=typeof r[e]||r[e]<0||r[e]>1)&&t.push({field:`style.${e}`,message:`${e} doit \xeatre un nombre entre 0 et 1`,context:{received:r[e],...n}})}),["weight","sizePx","radius"].forEach(e=>{e in r&&("number"!=typeof r[e]||r[e]<0)&&t.push({field:`style.${e}`,message:`${e} doit \xeatre un nombre >= 0`,context:{received:r[e],...n}})}),r.shape&&!["circle","square"].includes(r.shape)&&t.push({field:"style.shape",message:"shape doit \xeatre 'circle' ou 'square'",context:{received:r.shape,allowed:["circle","square"],...n}}),r.stroke&&function(e,t,o,n){"object"==typeof e&&null!==e?(e.color&&!ot(e.color)&&t.push({field:"style.stroke.color",message:"Couleur invalide, format attendu: #RRGGBB",context:{received:e.color,...n}}),"opacity"in e&&("number"!=typeof e.opacity||e.opacity<0||e.opacity>1)&&t.push({field:"style.stroke.opacity",message:"opacity doit \xeatre un nombre entre 0 et 1",context:{received:e.opacity,...n}}),"weight"in e&&("number"!=typeof e.weight||e.weight<0)&&t.push({field:"style.stroke.weight",message:"weight doit \xeatre un nombre >= 0",context:{received:e.weight,...n}}),null!==e.dashArray&&void 0!==e.dashArray&&"string"!=typeof e.dashArray&&t.push({field:"style.stroke.dashArray",message:"dashArray doit \xeatre une cha\xeene de caract\xe8res ou null",context:{received:typeof e.dashArray,value:e.dashArray,...n}})):t.push({field:"style.stroke",message:"stroke doit \xeatre un objet",context:{received:typeof e,...n}})}(r.stroke,t,0,n),r.casing&&function(e,t,o,n){"object"==typeof e&&null!==e?("enabled"in e&&"boolean"!=typeof e.enabled&&t.push({field:"style.casing.enabled",message:"enabled doit \xeatre un bool\xe9en",context:{received:typeof e.enabled,...n}}),e.color&&!ot(e.color)&&t.push({field:"style.casing.color",message:"Couleur invalide, format attendu: #RRGGBB",context:{received:e.color,...n}})):t.push({field:"style.casing",message:"casing doit \xeatre un objet",context:{received:typeof e,...n}})}(r.casing,t,0,n),r.fillPattern&&function(e,t,o,n){"object"==typeof e&&null!==e?("enabled"in e&&"boolean"!=typeof e.enabled&&t.push({field:"style.fillPattern.enabled",message:"enabled doit \xeatre un bool\xe9en",context:{received:typeof e.enabled,...n}}),e.type&&!["diagonal","horizontal","vertical","cross","x"].includes(e.type)&&t.push({field:"style.fillPattern.type",message:"type doit \xeatre parmi: diagonal, horizontal, vertical, cross, x",context:{received:e.type,allowed:["diagonal","horizontal","vertical","cross","x"],...n}}),e.color&&!ot(e.color)&&t.push({field:"style.fillPattern.color",message:"Couleur invalide, format attendu: #RRGGBB",context:{received:e.color,...n}}),["weight","density"].forEach(o=>{o in e&&("number"!=typeof e[o]||e[o]<0)&&t.push({field:`style.fillPattern.${o}`,message:`${o} doit \xeatre un nombre >= 0`,context:{received:e[o],...n}})})):t.push({field:"style.fillPattern",message:"fillPattern doit \xeatre un objet",context:{received:typeof e,...n}})}(r.fillPattern,t,0,n)):t.push({field:"style",message:"Le style doit \xeatre un objet",context:{received:typeof r,...n}}))}(e,o,0,t),e.styleRules&&We(e.styleRules,o,0,t),Qe(e,o,0,t),e.legend&&Ke(e.legend,o,0,t)}catch(e){o.push({field:"validation",message:`Erreur inattendue lors de la validation: ${e.message}`,stack:e.stack,context:t})}return{valid:0===o.length,errors:o,warnings:n}},formatValidationErrors:function(e,t=""){if(e.valid)return null;const o=[];return o.push("\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550"),o.push("\u274c ERREUR DE VALIDATION DE STYLE GEOLEAF"),o.push("\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550"),t&&(o.push(`Fichier: ${t}`),o.push("")),e.errors.length>0&&(o.push(`\u274c ${e.errors.length} erreur(s) d\xe9tect\xe9e(s):`),o.push(""),e.errors.forEach((e,t)=>{o.push(`  ${t+1}. Champ: ${e.field}`),o.push(`     Message: ${e.message}`),e.context&&o.push(`     Contexte: ${JSON.stringify(e.context,null,2).split("\n").join("\n     ")}`),e.stack&&o.push(`     Stack: ${e.stack.split("\n").slice(0,3).join("\n     ")}`),o.push("")})),e.warnings.length>0&&(o.push(`\u26a0\ufe0f  ${e.warnings.length} avertissement(s):`),o.push(""),e.warnings.forEach((e,t)=>{o.push(`  ${t+1}. Champ: ${e.field}`),o.push(`     Message: ${e.message}`),e.context&&o.push(`     Contexte: ${JSON.stringify(e.context,null,2).split("\n").join("\n     ")}`),o.push("")})),o.push("\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550"),o.push("\u{1f4a1} Conseil: V\xe9rifiez la documentation dans docs/STYLE_FORMAT_SPEC.md"),o.push("\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550"),o.join("\n")},StyleValidationError},rt="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{};class AbstractRenderer{constructor(e={}){this._name=e.name||"Renderer",this._config=e.config||{},this._debug=e.debug||0,this._eventListeners=[],this._initialized=0,this._stateMap=new WeakMap}getLog(){return rt.GeoLeaf&&rt.GeoLeaf.Log?rt.GeoLeaf.Log:console}getSecurity(){return rt.GeoLeaf&&rt.GeoLeaf.Security&&"function"==typeof rt.GeoLeaf.Security.escapeHtml?rt.GeoLeaf.Security:{escapeHtml:e=>{if(null==e)return"";const t=document.createElement("div");return t.textContent=String(e),t.innerHTML},setSafeHTML:(e,t)=>{e&&(rt.GeoLeaf&&rt.GeoLeaf.DOMSecurity&&"function"==typeof rt.GeoLeaf.DOMSecurity.setSafeHTML?rt.GeoLeaf.DOMSecurity.setSafeHTML(e,t):e.textContent=t)}}}getUtils(){return rt.GeoLeaf&&rt.GeoLeaf.Utils&&"function"==typeof rt.GeoLeaf.Utils.resolveField?rt.GeoLeaf.Utils:{resolveField:(e,...t)=>{if(!e)return null;for(const o of t){if(!o)continue;const t=String(o).split(".");let n=e,r=1;for(const e of t){if(!n||"object"!=typeof n||!(e in n)){r=0;break}n=n[e]}if(r&&null!=n)return n}return null}}}getActiveProfile(){return rt.GeoLeaf&&rt.GeoLeaf.Config&&"function"==typeof rt.GeoLeaf.Config.getActiveProfile&&rt.GeoLeaf.Config.getActiveProfile()||null}log(e,t,...o){if("debug"===e&&!this._debug)return;const n=this.getLog(),r=`[${this._name}]`;switch(e){case"debug":case"info":default:n.info(r,t,...o);break;case"warn":n.warn(r,t,...o);break;case"error":n.error(r,t,...o)}}debug(e,...t){this.log("debug",e,...t)}info(e,...t){this.log("info",e,...t)}warn(e,...t){this.log("warn",e,...t)}error(e,...t){this.log("error",e,...t)}createElement(e,t,o={}){const n=document.createElement(e);return t&&(Array.isArray(t)?n.classList.add(...t):n.className=t),Object.keys(o).forEach(e=>{n.setAttribute(e,o[e])}),n}createTextNode(e){return document.createTextNode(e||"")}createTextElement(e,t,o){const n=this.createElement(e,o);return n.textContent=t||"",n}createHTMLElement(e,t,o){const n=this.createElement(e,o);return this.getSecurity().setSafeHTML(n,t),n}appendChildren(e,...t){return t.forEach(t=>{t&&e.appendChild(t)}),e}addEventListener(e,t,o,n){if(!e||!t||!o)return this.warn("addEventListener: invalid parameters"),()=>{};const r=o.bind(this);e.addEventListener(t,r,n);const i=()=>{e.removeEventListener(t,r,n)};return this._eventListeners.push(i),i}removeAllEventListeners(){this._eventListeners.forEach(e=>e()),this._eventListeners=[]}setState(e,t){e&&this._stateMap.set(e,{...t})}getState(e){return e&&this._stateMap.get(e)||null}updateState(e,t){if(e){const o=this.getState(e)||{};this.setState(e,{...o,...t})}}deleteState(e){e&&this._stateMap.delete(e)}init(){this._initialized?this.warn("Renderer already initialized"):(this.debug("Initializing renderer"),this._initialized=1)}isInitialized(){return this._initialized}destroy(){this.debug("Destroying renderer"),this.removeAllEventListeners(),this._stateMap=new WeakMap,this._initialized=0}render(e,t){throw new Error(`${this._name}.render() must be implemented by subclass`)}}const it={JSON:"json",GEOJSON:"geojson",GPX:"gpx",ROUTE:"route"};function at(){return"poi_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}function lt(e){if(!e)return"Unknown";if("function"==typeof e.getLatLng)return"Point";if("function"==typeof e.getLatLngs){const t=e.getLatLngs();if(Array.isArray(t)&&t.length>0)return Array.isArray(t[0])&&Array.isArray(t[0][0])||Array.isArray(t[0])?"Polygon":"LineString"}return"Unknown"}function st(e){if(!e)return null;if("function"==typeof e.getLatLng){const t=e.getLatLng();return t?[t.lat,t.lng]:null}if("function"==typeof e.getCenter){const t=e.getCenter();return t?[t.lat,t.lng]:null}if("function"==typeof e.getBounds)try{const t=e.getBounds();if(t&&t.isValid()){const e=t.getCenter();return e?[e.lat,e.lng]:null}}catch(e){}return null}function ct(e,t={}){if(!e)return null;const o=e.id||e.uid||e.guid||at(),n=t.dataMapping||{},r=e[n.title||"title"]||e.title||e.name||e.label||e.nom||"Sans titre",i=e[n.description||"description"]||e.description||e.shortDescription||"",a=n.lat||"lat",l=n.lng||"lng";let s=e[a],c=e[l];void 0===s&&(s=e.latitude||e.y),void 0===c&&(c=e.longitude||e.lng||e.x);const u=n.categoryId||"categoryId",d=n.subCategoryId||"subCategoryId",f=e[u]||e.categoryId||e.category||null,p=e[d]||e.subCategoryId||e.subcategory||null,g={...e};return{id:String(o),sourceType:it.JSON,geometryType:"Point",title:String(r),description:String(i||""),lat:void 0!==s?parseFloat(s):null,lng:void 0!==c?parseFloat(c):null,categoryId:f,subCategoryId:p,attributes:g,rawData:e}}function ut(e,t={},o=null){if(!e)return null;const n=e.properties||{},r=e.geometry||{},i=t.dataMapping||{},a=e.id||n.id||n.uid||n.guid||at();let l=r.type||"Unknown";o&&"Unknown"===l&&(l=lt(o));const s=i.title||"title",c=n[s.includes(".")?s.split(".").pop():s]||n.name||n.nom||n.title||n.label||"Sans titre",u=i.description||"description",d=n[u.includes(".")?u.split(".").pop():u]||n.description||n.shortDescription||"";let f=null,p=null;if(r.coordinates){if("Point"===l)p=r.coordinates[0],f=r.coordinates[1];else if(o){const e=st(o);e&&(f=e[0],p=e[1])}else if(r.coordinates.length>0){const e=function(e,t){if(!e||!Array.isArray(e))return[];switch(t){case"Point":return[e];case"MultiPoint":case"LineString":return e;case"MultiLineString":case"Polygon":return e.flat();case"MultiPolygon":return e.flat(2);default:const t=[],o=e=>{Array.isArray(e)&&("number"==typeof e[0]?t.push(e):e.forEach(o))};return o(e),t}}(r.coordinates,r.type);if(e.length>0){let t=0,o=0;e.forEach(e=>{o+=e[0],t+=e[1]}),p=o/e.length,f=t/e.length}}}else if(o){const e=st(o);e&&(f=e[0],p=e[1])}const g=i.categoryId||"categoryId",h=g.includes(".")?g.split(".").pop():g,y=i.subCategoryId||"subCategoryId",m=y.includes(".")?y.split(".").pop():y,b=n[h]||n.categoryId||n.category||null,_=n[m]||n.subCategoryId||n.subcategory||null,v=n.attributes&&"object"==typeof n.attributes?n.attributes:{},w={...n,...v};return{id:String(a),sourceType:it.GEOJSON,geometryType:l,title:String(c),description:String(d||""),lat:null!==f?parseFloat(f):null,lng:null!==p?parseFloat(p):null,categoryId:b,subCategoryId:_,attributes:w,properties:n,rawData:e}}function dt(e){if(!e)return null;W().info("[Normalizer] GPX normalization - placeholder for future implementation");const t=e.name||e.sym||at(),o=e.name||e.cmt||"Point GPX",n=e.desc||e.cmt||"";return{id:String(t),sourceType:it.GPX,geometryType:"Point",title:String(o),description:String(n),lat:void 0!==e.lat?parseFloat(e.lat):null,lng:void 0!==e.lon?parseFloat(e.lon):null,categoryId:e.type||null,subCategoryId:null,attributes:{...e},rawData:e}}function ft(e){if(!e)return null;const t=e.id||e.placeId||at(),o=e.name||e.title||e.address||"Point de route",n=e.description||e.comment||"";let r=null,i=null;return e.latLng?(r=e.latLng.lat,i=e.latLng.lng):void 0!==e.lat&&void 0!==e.lng&&(r=e.lat,i=e.lng),{id:String(t),sourceType:it.ROUTE,geometryType:"Point",title:String(o),description:String(n),lat:null!==r?parseFloat(r):null,lng:null!==i?parseFloat(i):null,categoryId:e.type||"route-point",subCategoryId:void 0!==e.order?`stop-${e.order}`:null,order:e.order,address:e.address,attributes:{...e},rawData:e}}function pt(e,t,o={},n={}){if(!t)return W().warn("[Normalizer] Donn\xe9es nulles pour normalisation"),null;switch(e){case it.JSON:return ct(t,o);case it.GEOJSON:return ut(t,o,n.layer);case it.GPX:return dt(t);case it.ROUTE:return ft(t);default:return W().warn("[Normalizer] Type de source non reconnu:",e),gt(t,o,n)}}function gt(e,t={},o={}){return"Feature"===e.type&&e.geometry?ut(e,t,o.layer):void 0!==e.lat&&void 0!==e.lon&&(e.name||e.sym)?dt(e):e.latLng||void 0!==e.order&&e.address?ft(e):ct(e,t)}const ht={SOURCE_TYPES:it,normalizeFromJSON:ct,normalizeFromGeoJSON:ut,normalizeFromGPX:dt,normalizeFromRoute:ft,normalizeFeature:pt,autoDetectAndNormalize:gt,normalizeCollection:function(e,t,o={},n={}){return Array.isArray(t)?t.map(t=>pt(e,t,o,n)).filter(e=>null!==e):(W().warn("[Normalizer] normalizeCollection attend un tableau"),[])},detectGeometryType:lt,extractCoordinates:st,generateUniqueId:at};W().info("[GeoLeaf._Normalizer] Module Normalizer charg\xe9");const yt="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{},mt=new Map;function bt(){return d||null}let _t={debug:0,throwOnValidationError:1};async function Lt(e,t,o,n,r){const i=`${e}:${t}:${o}`;if(!_t.debug&&mt.has(i))return mt.get(i);try{const a=`${function(){const e=yt.GeoLeaf&&yt.GeoLeaf.Config;if(e&&"function"==typeof e.get){const t=e.get("data.profilesBasePath","profiles");if("string"==typeof t&&t.trim().length>0)return t.endsWith("/")?t.slice(0,-1):t}return"profiles"}()}/${e}/${r}/styles/${n}`,l=await fetch(a);if(!l.ok)throw new Error(`Impossible de charger le fichier de style: ${a}\nHTTP ${l.status}: ${l.statusText}`);let s;try{s=await l.json()}catch(n){const r={profileId:e,layerId:t,styleId:o,stylePath:a,httpStatus:l.status,parseError:n.message};throw console.error("\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550"),console.error("\u274c ERREUR DE PARSING JSON - FICHIER STYLE MALFORM\xc9"),console.error("\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550"),console.error(`Fichier: ${a}`),console.error(`Erreur: ${n.message}`),console.error("Contexte:",JSON.stringify(r,null,2)),console.error("Stack trace:",n.stack),console.error("\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550"),new Error(`Le fichier de style contient du JSON malform\xe9: ${a}\nErreur de parsing: ${n.message}\nVeuillez v\xe9rifier la syntaxe JSON du fichier.`)}s.label&&1==s.label.enabled&&void 0===s.label.visibleByDefault&&(s.label.visibleByDefault=0,console.warn(`[StyleLoader] \u26a0\ufe0f Param\xe8tre "visibleByDefault" manquant dans le style: ${a}\nLe style a "label.enabled: true" mais pas de "visibleByDefault".\nFallback appliqu\xe9: visibleByDefault = false\nAjoutez explicitement "visibleByDefault": false ou true dans le fichier de style.`));{nt||console.warn("[StyleLoader] StyleValidator non disponible, validation ignor\xe9e");const n=nt?nt.validateStyle(s,{profileId:e,layerId:t,styleId:o,stylePath:a}):{valid:1,errors:[],warnings:[]};if(!n.valid){const e=nt?nt.formatValidationErrors(n,a):"Erreurs de validation";if(console.error(e),_t.throwOnValidationError)throw new Error(`Le fichier de style ne respecte pas le sch\xe9ma GeoLeaf: ${a}\nConsultez la console pour les d\xe9tails des erreurs.`)}n.warnings.length>0&&(console.warn(`[StyleLoader] ${n.warnings.length} avertissement(s) pour ${a}:`),n.warnings.forEach(e=>{console.warn(`  - ${e.field}: ${e.message}`)}))}const c=vt(s),u={styleData:s,labelConfig:c,metadata:{profileId:e,layerId:t,styleId:o,stylePath:a,hasIntegratedLabels:null!==c,loadedAt:(new Date).toISOString()}};return _t.debug||mt.set(i,u),u}catch(i){if(i.message.includes("JSON malform\xe9")||i.message.includes("sch\xe9ma GeoLeaf"))throw i;const a={profileId:e,layerId:t,styleId:o,styleFileName:n,layerDirectory:r,originalError:i.message};throw console.error("\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550"),console.error("\u274c ERREUR DE CHARGEMENT DE STYLE"),console.error("\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550"),console.error("Contexte:",JSON.stringify(a,null,2)),console.error("Stack trace:",i.stack),console.error("\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550"),i}}function vt(e){return e&&"object"==typeof e&&e.label&&"object"==typeof e.label&&null!==e.label&&1==e.label.enabled?{...e.label,isIntegrated:1}:null}const wt={initStyleLoader:function(e={}){_t.debug=1==e.debug,_t.debug&&bt()},loadAndValidateStyle:Lt,extractLabelConfig:vt,loadStyleLenient:async function(e,t,o,n,r){const i=_t.throwOnValidationError;_t.throwOnValidationError=0;try{return await Lt(e,t,o,n,r)}finally{_t.throwOnValidationError=i}},preloadStyles:async function(e){const t=bt();t&&t.info(`[StyleLoader] Pr\xe9chargement de ${e.length} style(s)...`);const o=e.map(e=>Lt(e.profileId,e.layerId,e.styleId,e.styleFileName,e.layerDirectory).catch(t=>({error:1,message:t.message,config:e}))),n=await Promise.all(o),r=n.filter(e=>!e.error).length,i=n.filter(e=>e.error).length;return t&&t.info(`[StyleLoader] Pr\xe9chargement termin\xe9: ${r} succ\xe8s, ${i} erreurs`),n},clearStyleCache:function(e=null){e?mt.delete(e):mt.clear()},getCacheStats:function(){return{size:mt.size,keys:Array.from(mt.keys()),debug:_t.debug,cacheEnabled:!_t.debug}},loadStyleFromLayerConfig:async function(e,t,o){const n=t.id,r=t._layerDirectory||`layers/${n}`;if(t.labels&&t.labels.styleFile){const o=`\u274c CONFIGURATION OBSOL\xc8TE D\xc9TECT\xc9E\n\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nLa couche "${n}" utilise une r\xe9f\xe9rence obsol\xe8te \xe0 un fichier\nde labels s\xe9par\xe9 via "labels.styleFile".\n\nGeoLeaf ne supporte plus les fichiers de labels s\xe9par\xe9s (styleLabel.json).\nLes labels doivent \xeatre int\xe9gr\xe9s dans les fichiers de style.\n\nValeur d\xe9tect\xe9e: ${t.labels.styleFile}\nProfil: ${e}\nCouche: ${n}\n\nAction requise:\n1. Supprimez la propri\xe9t\xe9 "labels.styleFile" de la configuration\n2. Int\xe9grez les labels dans les fichiers de style (propri\xe9t\xe9 "label")\n3. Consultez docs/STYLE_FORMAT_SPEC.md pour la syntaxe\n\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550`;throw console.error(o),new Error(`Configuration obsol\xe8te: labels.styleFile d\xe9tect\xe9 dans la couche ${n}`)}let i=o,a=o;if(t.styles&&t.styles.available){const e=t.styles.available.find(e=>e.id===o||e.file===o);e&&(i=e.file,a=e.id)}return Lt(e,n,a,i,r)},getStylePath:function(e,t,o){return`profiles/${e}/${t}/styles/${o}`},styleCache:mt},Ct="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{},It={_map:null,_config:null,_container:null,_scaleLineMetric:null,_numericElement:null,_zoomElement:null,_inputElement:null,_scalePrefix:null,_mainWrapper:null,_eventHandlers:{},init(e,t){e?(this._map=e,this._config=t||{},this._createMainContainer(),d.info("[GeoLeaf.ScaleControl] Contr\xf4le d'\xe9chelle initialis\xe9")):d.error("[GeoLeaf.ScaleControl] Carte non fournie")},_createMainContainer(){const e=this._config.position||"bottomleft";if(this._mainWrapper=L.DomUtil.create("div","gl-scale-main-wrapper"),0!=this._config.scaleGraphic){const e=L.DomUtil.create("div","gl-scale-graphic-wrapper",this._mainWrapper);this._addGraphicScaleToContainer(e)}(this._config.scaleNumeric||this._config.scaleNivel)&&this._createCustomScaleBlock(this._mainWrapper),(new(L.Control.extend({options:{position:e},onAdd:()=>this._mainWrapper}))).addTo(this._map)},_addGraphicScaleToContainer(e){const t=L.DomUtil.create("div","leaflet-control-scale leaflet-control",e),o=L.DomUtil.create("div","leaflet-control-scale-line",t);this._scaleLineMetric=o;const n=()=>{const e=this._map.getSize().y/2,t=this._map.distance(this._map.containerPointToLatLng([0,e]),this._map.containerPointToLatLng([150,e]));this._updateScaleLine(this._scaleLineMetric,t)};this._eventHandlers.graphicScaleUpdate=n,this._map.on("zoomend moveend",n),n(),d.info("[GeoLeaf.ScaleControl] \xc9chelle graphique ajout\xe9e")},_updateScaleLine(e,t){const o=t/1e3;let n,r;if(o>1){const e=this._getRoundNum(o);r=e/o,n=e+" km"}else{const e=this._getRoundNum(t);r=e/t,n=e+" m"}e.style.width=Math.round(150*r)+"px",e.textContent=n},_getRoundNum(e){const t=Math.pow(10,(Math.floor(e)+"").length-1);let o=e/t;return o=o>=10?10:o>=5?5:o>=3?3:o>=2?2:1,t*o},_createCustomScaleBlock(e){this._container=L.DomUtil.create("div","gl-scale-control",e),this._config.scaleNumeric&&(this._config.scaleNumericEditable?this._createEditableScale():this._createReadOnlyScale()),this._config.scaleNivel&&this._createZoomLevel();const t=()=>this._updateScale();this._eventHandlers.numericScaleUpdate=t,this._map.on("zoomend moveend",t),this._updateScale(),d.info("[GeoLeaf.ScaleControl] Bloc personnalis\xe9 ajout\xe9")},_createReadOnlyScale(){this._numericElement=L.DomUtil.create("div","gl-scale-numeric",this._container)},_createEditableScale(){const e=L.DomUtil.create("div","gl-scale-numeric-editable",this._container);this._scalePrefix=L.DomUtil.create("span","gl-scale-prefix",e),this._scalePrefix.textContent="1:",this._numericElement=L.DomUtil.create("span","gl-scale-numeric-clickable",e),this._numericElement.textContent="0",this._inputElement=L.DomUtil.create("input","gl-scale-numeric-input",e),this._inputElement.type="text",this._inputElement.placeholder="250000",this._inputElement.style.display="none",L.DomEvent.disableClickPropagation(e),L.DomEvent.disableScrollPropagation(e),this._numericElement.addEventListener("click",()=>{this._switchToEditMode()}),this._inputElement.addEventListener("keypress",e=>{"Enter"===e.key&&(this._onScaleInputChange(),this._switchToDisplayMode())}),this._inputElement.addEventListener("blur",()=>{this._onScaleInputChange(),this._switchToDisplayMode()})},_createZoomLevel(){this._zoomElement=L.DomUtil.create("div","gl-scale-zoom",this._container)},_switchToEditMode(){this._numericElement&&this._inputElement&&(this._inputElement.value=this._numericElement.textContent,this._numericElement.style.display="none",this._inputElement.style.display="inline-block",this._inputElement.focus(),this._inputElement.select())},_switchToDisplayMode(){this._numericElement&&this._inputElement&&(this._inputElement.style.display="none",this._numericElement.style.display="inline")},_updateScale(){const e=this._map.getZoom(),t=this._calculateScale(e);this._numericElement&&(this._config.scaleNumericEditable?"none"===this._inputElement.style.display&&(this._numericElement.textContent=this._formatNumber(t)):this._numericElement.textContent=`1:${this._formatNumber(t)}`),this._zoomElement&&(this._zoomElement.textContent=`Zoom: ${Number(e).toFixed(2)}`)},_calculateScale(e,t){const o=void 0!==t?t:this._map.getCenter().lat,n=156543.03392*Math.cos(o*Math.PI/180)/Math.pow(2,e)*96/.0254;return Math.round(n)},_formatNumber:e=>e.toString().replace(/\B(?=(\d{3})+(?!\d))/g," "),_onScaleInputChange(){if(!this._inputElement)return;const e=this._inputElement.value.trim(),t=e.replace(/\s/g,""),o=parseInt(t,10);if(!isNaN(o)&&o>0){const e=this._calculateZoomFromScale(o);this._map.setView(this._map.getCenter(),e,{animate:1,zoomSnap:0}),d.info(`[GeoLeaf.ScaleControl] Zoom ajust\xe9 \xe0 ${e} pour \xe9chelle 1:${o}`)}else d.warn("[GeoLeaf.ScaleControl] Format d'\xe9chelle invalide:",e),this._updateScale()},_calculateZoomFromScale(e){const t=this._map.getCenter().lat,o=.0254*e/96;let n=Math.log2(156543.03392*Math.cos(t*Math.PI/180)/o);for(let o=0;o<20;o++){const o=this._calculateScale(n,t),r=e-o;if(Math.abs(r)<1)break;n-=.95*Math.log2(e/o)}const r=Math.round(1e4*n)/1e4;return Math.max(0,Math.min(22,r))},destroy(){this._map&&this._eventHandlers&&(this._eventHandlers.graphicScaleUpdate&&this._map.off("zoomend moveend",this._eventHandlers.graphicScaleUpdate),this._eventHandlers.numericScaleUpdate&&this._map.off("zoomend moveend",this._eventHandlers.numericScaleUpdate)),this._mainWrapper&&this._mainWrapper.parentNode&&this._mainWrapper.parentNode.removeChild(this._mainWrapper),this._map=null,this._config=null,this._container=null,this._scaleLineMetric=null,this._numericElement=null,this._zoomElement=null,this._inputElement=null,this._scalePrefix=null,this._mainWrapper=null,this._eventHandlers={},d.info("[GeoLeaf.ScaleControl] Contr\xf4le d\xe9truit et ressources nettoy\xe9es")}},St={convertPoiArrayToGeoJSON(e){if(!Array.isArray(e))return d.warn("[DataConverter.convertPoiArrayToGeoJSON] Input n'est pas un array, retour FeatureCollection vide"),{type:"FeatureCollection",features:[]};const t=e.map(e=>{if(!e||"object"!=typeof e)return null;if(!e.id)return d.warn("[DataConverter.convertPoiArrayToGeoJSON] POI sans ID, ignor\xe9",e),null;let t=null;if(Array.isArray(e.latlng)&&2===e.latlng.length)t=[e.latlng[1],e.latlng[0]];else{if(!e.location||"number"!=typeof e.location.lat||"number"!=typeof e.location.lng)return d.warn("[DataConverter.convertPoiArrayToGeoJSON] POI sans coordonn\xe9es valides, ignor\xe9",{id:e.id}),null;t=[e.location.lng,e.location.lat]}return{type:"Feature",id:e.id,geometry:{type:"Point",coordinates:t},properties:{id:e.id,title:e.title||"Sans titre",description:e.description||"",...e.attributes}}}).filter(e=>null!==e);return e.length,t.length,{type:"FeatureCollection",features:t}},convertRouteArrayToGeoJSON(e){if(!Array.isArray(e))return d.warn("[DataConverter.convertRouteArrayToGeoJSON] Input n'est pas un array, retour FeatureCollection vide"),{type:"FeatureCollection",features:[]};const t=e.map(e=>e&&"object"==typeof e?e.id?e.geometry&&"LineString"===e.geometry.type&&Array.isArray(e.geometry.coordinates)?{type:"Feature",id:e.id,geometry:{type:"LineString",coordinates:e.geometry.coordinates},properties:{id:e.id,title:e.title||"Sans titre",description:e.description||"",categoryId:e.categoryId,subCategoryId:e.subCategoryId,...e.attributes}}:(d.warn("[DataConverter.convertRouteArrayToGeoJSON] Route sans g\xe9om\xe9trie LineString valide, ignor\xe9e",{id:e.id}),null):(d.warn("[DataConverter.convertRouteArrayToGeoJSON] Route sans ID, ignor\xe9e",e),null):null).filter(e=>null!==e);return e.length,t.length,{type:"FeatureCollection",features:t}},convertZoneArrayToGeoJSON(e){if(!Array.isArray(e))return d.warn("[DataConverter.convertZoneArrayToGeoJSON] Input n'est pas un array, retour FeatureCollection vide"),{type:"FeatureCollection",features:[]};const t=e.map(e=>e&&"object"==typeof e?e.id?e.geometry&&"Polygon"===e.geometry.type&&Array.isArray(e.geometry.coordinates)?{type:"Feature",id:e.id,geometry:{type:"Polygon",coordinates:e.geometry.coordinates},properties:{id:e.id,title:e.title||e.siteName||"Sans titre",description:e.description||"",...e.attributes}}:(d.warn("[DataConverter.convertZoneArrayToGeoJSON] Zone sans g\xe9om\xe9trie Polygon valide, ignor\xe9e",{id:e.id}),null):(d.warn("[DataConverter.convertZoneArrayToGeoJSON] Zone sans ID, ignor\xe9e",e),null):null).filter(e=>null!==e);return e.length,t.length,{type:"FeatureCollection",features:t}},convertGpxToGeoJSON(e){if(!e||"string"!=typeof e)return d.warn("[DataConverter.convertGpxToGeoJSON] GPX string invalide"),{type:"FeatureCollection",features:[]};try{const t=(new DOMParser).parseFromString(e,"text/xml"),o=t.getElementsByTagName("parsererror");if(o.length>0)return d.error("[DataConverter.convertGpxToGeoJSON] Erreur parsing XML:",o[0].textContent),{type:"FeatureCollection",features:[]};const n=[],r=t.getElementsByTagName("wpt");for(let e=0;e<r.length;e++){const t=r[e],o=parseFloat(t.getAttribute("lat")),i=parseFloat(t.getAttribute("lon"));if(!isNaN(o)&&!isNaN(i)){const r=t.getElementsByTagName("name")[0],a=t.getElementsByTagName("desc")[0],l=t.getElementsByTagName("sym")[0],s={},c=[],u=t.getElementsByTagName("extensions");if(u.length>0){const e=u[0];for(let t=0;t<e.childNodes.length;t++){const o=e.childNodes[t];if(1!==o.nodeType)continue;const n=o.tagName||o.nodeName||"",r=o.localName||n.split(":").pop();if(n.toLowerCase().startsWith("geoleaf:")||o.namespaceURI&&o.namespaceURI.includes("geoleaf")||n.includes(":")){const e=r||n.replace(/^[^:]+:/,""),t=o.textContent||"";"tag"===e||"tags"===e?t&&c.push(t):s[e]=t}}}c.length>0&&(s.tags=c);const d={type:"Feature",id:s.id||(r?r.textContent:`wpt-${e}`),geometry:{type:"Point",coordinates:[i,o]},properties:{id:s.id||(r?r.textContent:`wpt-${e}`),title:r?r.textContent:`Waypoint ${e+1}`,description:a?a.textContent:"",symbol:l?l.textContent:"",...s}};n.push(d)}}const i=t.getElementsByTagName("trk");for(let e=0;e<i.length;e++){const t=i[e],o=t.getElementsByTagName("name")[0],r=t.getElementsByTagName("desc")[0],a={},l=[],s=t.getElementsByTagName("extensions");if(s.length>0){const e=s[0];for(let t=0;t<e.childNodes.length;t++){const o=e.childNodes[t];if(1!==o.nodeType)continue;const n=o.tagName||o.nodeName||"",r=o.localName||n.split(":").pop();if(n.toLowerCase().startsWith("geoleaf:")||o.namespaceURI&&o.namespaceURI.includes("geoleaf")||n.includes(":")){const e=r||n.replace(/^[^:]+:/,""),t=o.textContent||"";"tag"===e||"tags"===e?t&&l.push(t):a[e]=t}}}l.length>0&&(a.tags=l);const c=t.getElementsByTagName("trkseg");for(let t=0;t<c.length;t++){const i=c[t].getElementsByTagName("trkpt"),l=[];for(let e=0;e<i.length;e++){const t=i[e],o=parseFloat(t.getAttribute("lat")),n=parseFloat(t.getAttribute("lon"));isNaN(o)||isNaN(n)||l.push([n,o])}if(l.length>0){const i={type:"Feature",id:o?`${o.textContent}-${t}`:`trk-${e}-${t}`,geometry:{type:"LineString",coordinates:l},properties:{id:o?`${o.textContent}-${t}`:`trk-${e}-${t}`,title:o?o.textContent:`Track ${e+1}`,description:r?r.textContent:"",segmentIndex:t,pointCount:l.length,...a}};n.push(i)}}}return r.length,i.length,n.length,{type:"FeatureCollection",features:n}}catch(e){return d.error("[DataConverter.convertGpxToGeoJSON] Erreur lors du parsing GPX:",e),{type:"FeatureCollection",features:[]}}},autoConvert(e){if(!e)return d.warn("[DataConverter.autoConvert] Donn\xe9es nulles, retour FeatureCollection vide"),{type:"FeatureCollection",features:[]};if("FeatureCollection"===e.type&&Array.isArray(e.features))return e;if("Feature"===e.type&&e.geometry)return{type:"FeatureCollection",features:[e]};if(!Array.isArray(e)||0===e.length)return d.warn("[DataConverter.autoConvert] Donn\xe9es ne sont pas un array ou array vide"),{type:"FeatureCollection",features:[]};const t=e[0];return t&&"object"==typeof t?t.latlng||t.location&&"number"==typeof t.location.lat?this.convertPoiArrayToGeoJSON(e):t.geometry&&"LineString"===t.geometry.type&&Array.isArray(t.geometry.coordinates)?this.convertRouteArrayToGeoJSON(e):t.geometry&&"Polygon"===t.geometry.type&&Array.isArray(t.geometry.coordinates)?this.convertZoneArrayToGeoJSON(e):(d.warn("[DataConverter.autoConvert] Type de donn\xe9es non reconnu"),{type:"FeatureCollection",features:[]}):(d.warn("[DataConverter.autoConvert] Premier \xe9l\xe9ment invalide"),{type:"FeatureCollection",features:[]})}},Et=St;F.loadUrl=function(e,t={}){return T?T.loadUrl(e,t).then(e=>(this._applyConfig(e,"url"),this._maybeFireLoadedEvent(),this._config)).catch(e=>(d.error("[GeoLeaf.Config] Erreur lors du chargement JSON :",e),this._config)):(d.error("[GeoLeaf.Config] Module Loader non disponible."),Promise.reject(new Error("Loader module not available")))},F.loadTaxonomy=function(e=null,t={}){return x?x.loadTaxonomy(e,t):(d.error("[GeoLeaf.Config] Module Taxonomy non disponible."),Promise.reject(new Error("Taxonomy module not available")))},F.loadActiveProfileResources=function(e={}){return N?N.loadActiveProfileResources(e):(d.error("[GeoLeaf.Config] Module Profile non disponible."),Promise.reject(new Error("Profile module not available")))},F.getAll=function(){this._isLoaded||this._initSubModules();const e=E;return e&&"function"==typeof e.getAll?e.getAll():this._config},F.get=function(e,t){this._isLoaded||this._initSubModules();const o=E;return o&&"function"==typeof o.get?o.get(e,t):t},F.set=function(e,t){const o=E;o&&"function"==typeof o.set?o.set(e,t):d.warn("[GeoLeaf.Config] Module Storage non disponible pour set().")},F.getSection=function(e,t){const o=E;return o&&"function"==typeof o.getSection?o.getSection(e,t):t},F.getCategories=function(){this._isLoaded||this._initSubModules();const e=x;return e&&"function"==typeof e.getCategories?e.getCategories():{}},F.getCategory=function(e){const t=x;return t&&"function"==typeof t.getCategory?t.getCategory(e):void 0},F.getSubcategory=function(e,t){const o=x;return o&&"function"==typeof o.getSubcategory?o.getSubcategory(e,t):void 0},F.getActiveProfileId=function(){const e=N;return e&&"function"==typeof e.getActiveProfileId?e.getActiveProfileId():null},F.getActiveProfile=function(){const e=N;return e&&"function"==typeof e.getActiveProfile?e.getActiveProfile():null},F.getActiveProfilePoi=function(){const e=N;return e&&"function"==typeof e.getActiveProfilePoi?e.getActiveProfilePoi():[]},F.getActiveProfileRoutes=function(){const e=N;return e&&"function"==typeof e.getActiveProfileRoutes?e.getActiveProfileRoutes():[]},F.getActiveProfileMapping=function(){const e=N;return e&&"function"==typeof e.getActiveProfileMapping?e.getActiveProfileMapping():null},F.getIconsConfig=function(){const e=N;return e&&"function"==typeof e.getIconsConfig?e.getIconsConfig():null},F.isProfilePoiMappingEnabled=function(){const e=N;return e&&"function"==typeof e.isProfilePoiMappingEnabled?e.isProfilePoiMappingEnabled():1},F._validateConfig=function(e){if(e&&"object"==typeof e){if(e.map&&void 0!==e.map.center&&(!Array.isArray(e.map.center)||2!==e.map.center.length||"number"!=typeof e.map.center[0]||"number"!=typeof e.map.center[1]))throw new Error("[GeoLeaf.Config] map.center doit \xeatre un tableau de 2 nombres [lat, lng].");if(e.map&&void 0!==e.map.zoom&&("number"!=typeof e.map.zoom||e.map.zoom<0||e.map.zoom>20))throw new Error("[GeoLeaf.Config] map.zoom doit \xeatre un nombre entre 0 et 20.");if(e.map&&void 0!==e.map.positionFixed&&"boolean"!=typeof e.map.positionFixed)throw new Error("[GeoLeaf.Config] map.positionFixed doit \xeatre un bool\xe9en (true/false).");if(e.map&&void 0!==e.map.initialMaxZoom&&("number"!=typeof e.map.initialMaxZoom||e.map.initialMaxZoom<1||e.map.initialMaxZoom>20))throw new Error("[GeoLeaf.Config] map.initialMaxZoom doit \xeatre un nombre entre 1 et 20.");if(e.map&&void 0!==e.map.boundsMargin&&("number"!=typeof e.map.boundsMargin||e.map.boundsMargin<0||e.map.boundsMargin>1))throw new Error("[GeoLeaf.Config] map.boundsMargin doit \xeatre un nombre entre 0 et 1 (ex: 0.3 = 30% de marge).");if(void 0!==e.basemaps&&("object"!=typeof e.basemaps||null===e.basemaps))throw new Error("[GeoLeaf.Config] basemaps doit \xeatre un objet.");if(void 0!==e.poi&&!Array.isArray(e.poi))throw new Error("[GeoLeaf.Config] poi doit \xeatre un tableau.");if(void 0!==e.geojson&&!Array.isArray(e.geojson))throw new Error("[GeoLeaf.Config] geojson doit \xeatre un tableau.");if(void 0!==e.categories){if("object"!=typeof e.categories||null===e.categories||Array.isArray(e.categories))throw new Error("[GeoLeaf.Config] categories doit \xeatre un objet.");Object.entries(e.categories).forEach(([e,t])=>{if(!t||"object"!=typeof t)return void d.warn(`[GeoLeaf.Config] Cat\xe9gorie '${e}' invalide (doit \xeatre un objet).`);t.label&&"string"==typeof t.label||d.warn(`[GeoLeaf.Config] Cat\xe9gorie '${e}' : le champ 'label' est manquant ou invalide.`);const o=t.color&&"string"==typeof t.color,n=t.colorFill&&"string"==typeof t.colorFill||t.colorStroke&&"string"==typeof t.colorStroke;if(o||n||d.warn(`[GeoLeaf.Config] Cat\xe9gorie '${e}' : aucune couleur d\xe9finie (ni 'color', ni 'colorFill'/'colorStroke').`),void 0!==t.subcategories){if("object"!=typeof t.subcategories||null===t.subcategories||Array.isArray(t.subcategories))return void d.warn(`[GeoLeaf.Config] Cat\xe9gorie '${e}' : subcategories doit \xeatre un objet.`);Object.entries(t.subcategories).forEach(([t,o])=>{if(!o||"object"!=typeof o)return void d.warn(`[GeoLeaf.Config] Sous-cat\xe9gorie '${t}' dans '${e}' invalide (doit \xeatre un objet).`);o.label&&"string"==typeof o.label||d.warn(`[GeoLeaf.Config] Sous-cat\xe9gorie '${t}' dans '${e}' : le champ 'label' est manquant ou invalide.`);const n=o.color&&"string"==typeof o.color,r=o.colorFill&&"string"==typeof o.colorFill||o.colorStroke&&"string"==typeof o.colorStroke;n||r||d.warn(`[GeoLeaf.Config] Sous-cat\xe9gorie '${t}' dans '${e}' : aucune couleur d\xe9finie (ni 'color', ni 'colorFill'/'colorStroke').`)})}})}}};const At="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{};At.GeoLeaf=At.GeoLeaf||{},At.GeoLeaf.Helpers||(At.GeoLeaf.Helpers={}),At.GeoLeaf.Helpers.StyleResolver=Ze,At.GeoLeaf.Helpers.getColorsFromLayerStyle=Je,At.GeoLeaf.Helpers.resolvePoiColors=He,At.GeoLeaf._Validators||(At.GeoLeaf._Validators={}),At.GeoLeaf._StyleValidator=nt,At.GeoLeaf._Validators.StyleValidator=nt,At.GeoLeaf._StyleValidatorRules=et,At.GeoLeaf._Validators.StyleValidatorRules=et,At.GeoLeaf._Renderers||(At.GeoLeaf._Renderers={}),At.GeoLeaf._Renderers.AbstractRenderer=AbstractRenderer,At.GeoLeaf._Renderers.SimpleTextRenderer=class SimpleTextRenderer extends AbstractRenderer{constructor(e={}){super({name:"SimpleTextRenderer",debug:e.debug||0,config:{showIcon:0!=e.showIcon,theme:e.theme||"light"}}),this.init()}init(){super.init(),this.debug("Initializing with config:",this._config)}render(e,t={}){if(!e)return this.warn("render: no POI data provided"),null;this.debug("Rendering POI:",e.title||e.id);const o=this.createElement("div","simple-text-renderer",{"data-poi-id":e.id||"unknown","data-context":t.context||"default"});this.setState(o,{poi:e,renderTime:Date.now(),context:t.context});const n=this._renderTitle(e);n&&o.appendChild(n);const r=this._renderDescription(e);return r&&o.appendChild(r),this.addEventListener(o,"click",t=>{this._handleClick(t,e)}),this.info("Rendered POI successfully"),o}_renderTitle(e){const t=this.getUtils().resolveField(e,"title","label","name")||"Untitled",o=this.createTextElement("h3",t,"simple-text-renderer__title");if(this._config.showIcon&&e.categoryId){const t=this._createIcon(e.categoryId);t&&o.insertBefore(t,o.firstChild)}return o}_renderDescription(e){const t=this.getUtils().resolveField(e,"description","desc");return t?this.createTextElement("p",t,"simple-text-renderer__description"):null}_createIcon(e){const t=this.getActiveProfile();if(!t||!t.icons)return null;const o=this.createElement("span","simple-text-renderer__icon");return o.textContent="\u{1f4cd}",o.style.marginRight="8px",o}_handleClick(e,t){const o=this.getState(e.currentTarget);this.info("Clicked POI:",t.title,"State:",o),this.updateState(e.currentTarget,{lastClicked:Date.now(),clickCount:(o.clickCount||0)+1});const n=new CustomEvent("poi:click",{detail:{poi:t,state:o},bubbles:1});e.currentTarget.dispatchEvent(n)}destroy(){this.debug("Destroying SimpleTextRenderer"),super.destroy()}},At.GeoLeaf._Normalizer=ht,At.GeoLeaf._StyleLoader=wt,At.GeoLeaf.ScaleControl=It,At.GeoLeaf.initScaleControl=function(e){if(!e)return void d.warn("[GeoLeaf.ScaleControl] Impossible d'initialiser : carte non fournie");const t=Ct.GeoLeaf&&Ct.GeoLeaf.Config&&"function"==typeof Ct.GeoLeaf.Config.get?Ct.GeoLeaf.Config.get("scaleConfig"):null;t&&(t.scaleGraphic||t.scaleNumeric||t.scaleNivel)&&It.init(e,t)},At.GeoLeaf.Config||(At.GeoLeaf.Config=F),Object.assign(At.GeoLeaf.Config,F),At.GeoLeaf._DataConverter=Et,At.GeoLeaf._ConfigLoader=T,At.GeoLeaf._ConfigNormalization=O,At.GeoLeaf._ProfileLoader=M,At.GeoLeaf._ConfigProfile=N,At.GeoLeaf._ConfigStorage=E,At.GeoLeaf._ConfigTaxonomy=x;const Pt="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{},Gt={};Gt.state={map:null,layerGroup:null,geoJsonLayer:null,layers:new Map,layerIdCounter:0,options:{defaultStyle:{color:"#999999",weight:2,opacity:.9,fillColor:"#cccccc",fillOpacity:.15},defaultPointStyle:{radius:6,color:"#999999",weight:2,fillColor:"#cccccc",fillOpacity:.9},onEachFeature:null,pointToLayer:null,fitBoundsOnLoad:1,maxZoomOnFit:Pt.GeoLeaf&&Pt.GeoLeaf.CONSTANTS?Pt.GeoLeaf.CONSTANTS.GEOJSON_MAX_ZOOM_ON_FIT:18}},Gt.PANE_CONFIG={BASEMAP_NAME:"geoleaf-basemap",BASEMAP_ZINDEX:200,LAYER_PREFIX:"geoleaf-layer-",LAYER_BASE_ZINDEX:400,MIN_LAYER_ZINDEX:0,MAX_LAYER_ZINDEX:99},Gt.PaneHelpers={getPaneName:e=>`${Gt.PANE_CONFIG.LAYER_PREFIX}${e||0}`,validateZIndex(e){const t=Gt.PANE_CONFIG;return Math.max(t.MIN_LAYER_ZINDEX,Math.min(t.MAX_LAYER_ZINDEX,Math.floor(e)))},applyPaneToLayer(e,t){e&&e.options&&(e.options.pane=this.getPaneName(t))}},Gt.STYLE_OPERATORS={">":(e,t)=>Number(e)>Number(t),">=":(e,t)=>Number(e)>=Number(t),"<":(e,t)=>Number(e)<Number(t),"<=":(e,t)=>Number(e)<=Number(t),"==":(e,t)=>e==t,"===":(e,t)=>e===t,eq:(e,t)=>e==t,"!=":(e,t)=>e!=t,"!==":(e,t)=>e!==t,neq:(e,t)=>e!=t,contains:(e,t)=>String(e).toLowerCase().includes(String(t).toLowerCase()),startsWith:(e,t)=>String(e).toLowerCase().startsWith(String(t).toLowerCase()),endsWith:(e,t)=>String(e).toLowerCase().endsWith(String(t).toLowerCase()),in:(e,t)=>Array.isArray(t)&&t.includes(e),notIn:(e,t)=>Array.isArray(t)&&!t.includes(e),between:(e,t)=>{if(!Array.isArray(t)||2!==t.length)return 0;const o=Number(e),n=Number(t[0]),r=Number(t[1]);return o>=n&&o<=r}},Gt.reset=function(){const e=Gt.state;e.map=null,e.layerGroup=null,e.geoJsonLayer=null,e.layers=new Map,e.layerIdCounter=0,e.options={defaultStyle:{color:"#999999",weight:2,opacity:.9,fillColor:"#cccccc",fillOpacity:.15},defaultPointStyle:{radius:6,color:"#999999",weight:2,fillColor:"#cccccc",fillOpacity:.9},onEachFeature:null,pointToLayer:null,fitBoundsOnLoad:1,maxZoomOnFit:Pt.GeoLeaf&&Pt.GeoLeaf.CONSTANTS?Pt.GeoLeaf.CONSTANTS.GEOJSON_MAX_ZOOM_ON_FIT:18}},Gt.getLog=function(){return Pt.GeoLeaf&&Pt.GeoLeaf.Log?Pt.GeoLeaf.Log:console},Gt.getLayers=function(){return Gt.state.layers},Gt.getLayerById=function(e){return Gt.state.layers.get(e)};const Tt="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{},xt={getPoiConfig:function(){const e=Tt.GeoLeaf&&Tt.GeoLeaf.Config;return e&&"function"==typeof e.get&&e.get("poiConfig")||{}},getSharedPOICluster:function(){const e=W();try{const t=Tt.GeoLeaf&&Tt.GeoLeaf.POI;if(!t||"function"!=typeof t.getLayer)return null;const o=t.getLayer();if(!o)return null;if(o.addLayer,o.removeLayer,o._featureGroup,o._group,o._markerCluster,o.constructor&&o.constructor.name,o.constructor&&o.constructor.name,o&&"function"==typeof o.addLayer&&"function"==typeof o.removeLayer)return o;e.warn("[GeoLeaf.GeoJSON] POI.getLayer() ne retourne pas un layer valide (checks failed)")}catch(t){e.error("[GeoLeaf.GeoJSON] Impossible de r\xe9cup\xe9rer le cluster POI :",t)}return null},getClusteringStrategy:function(e,t){const o=W(),n=xt.getPoiConfig(),r="object"==typeof e.clustering?e.clustering:{enabled:e.clustering},i=1==r.enabled;if(0==r.enabled)return{shouldCluster:0,useSharedCluster:0};if(!n.clustering&&!i)return{shouldCluster:0,useSharedCluster:0};if(!t.features||!t.features.some(e=>e.geometry&&e.geometry.type&&e.geometry.type.includes("Point")))return{shouldCluster:0,useSharedCluster:0};if(i){const t=r.maxClusterRadius||("number"==typeof e.clusterRadius?e.clusterRadius:null),o=r.disableClusteringAtZoom||("number"==typeof e.disableClusteringAtZoom?e.disableClusteringAtZoom:null);return null!==t&&t!==(n.clusterRadius||80)||null!==o&&o!==(n.disableClusteringAtZoom||18)?{shouldCluster:1,useSharedCluster:0}:{shouldCluster:1,useSharedCluster:"unified"===(n.clusterStrategy||"unified")}}const a=n.clusterStrategy||"unified";switch(a){case"unified":return{shouldCluster:1,useSharedCluster:1};case"by-layer":return{shouldCluster:i,useSharedCluster:0};case"by-source":return{shouldCluster:0!=(n.clusterStrategies?.["by-source"]?.sources||{}).geojson,useSharedCluster:0};case"json-only":return{shouldCluster:1==(n.clusterStrategies?.["json-only"]||{}).geojsonClustering,useSharedCluster:0};default:return o.warn("[GeoLeaf.GeoJSON] Strat\xe9gie de clustering inconnue: "+a+". Utilisation de 'unified'."),{shouldCluster:1,useSharedCluster:1}}},createIndependentCluster:function(e={}){return Tt.L&&Tt.L.markerClusterGroup?Tt.L.markerClusterGroup({maxClusterRadius:e.clusterRadius||80,disableClusteringAtZoom:e.disableClusteringAtZoom||18,animate:void 0!==e.animate?e.animate:0,spiderfyOnMaxZoom:void 0!==e.spiderfyOnMaxZoom?e.spiderfyOnMaxZoom:0,showCoverageOnHover:void 0!==e.showCoverageOnHover?e.showCoverageOnHover:0,zoomToBoundsOnClick:void 0!==e.zoomToBoundsOnClick?e.zoomToBoundsOnClick:1}):null}},Ot={validateFeatureCollection:function(e){const t=W(),o=[],n=[];if(!e||"object"!=typeof e)return t.warn("[GeoLeaf.GeoJSON.Validator] Collection non valide : type invalide"),{validFeatures:[],errors:[{message:"Collection non valide"}]};const r="FeatureCollection"===e.type?e.features:Array.isArray(e)?e:[e];return Array.isArray(r)?(r.forEach((e,t)=>{const r=Ot.validateFeature(e,t);r.valid?n.push(e):o.push(...r.errors)}),{validFeatures:n,errors:o}):(t.warn("[GeoLeaf.GeoJSON.Validator] Pas de features \xe0 valider"),{validFeatures:[],errors:[]})},validateFeature:function(e,t){const o=W(),n=[],r=e?.properties?.id||e?.id||t||"unknown";if(!e||"Feature"!==e.type)return n.push({featureId:r,field:"type",message:"Feature doit avoir type='Feature'",severity:"error"}),o.warn(`[GeoLeaf.GeoJSON.Validator] Feature ${r}: type invalide`),{valid:0,errors:n};const i=Ot.validateGeometry(e.geometry,r);i.valid||n.push(...i.errors);const a=Ot.validateProperties(e.properties,r);return a.valid||n.push(...a.errors),n.length>0?(o.warn(`[GeoLeaf.GeoJSON.Validator] Feature ${r} rejet\xe9e : ${n.map(e=>e.message).join("; ")}`),{valid:0,errors:n}):{valid:1,errors:[]}},validateGeometry:function(e,t){const o=[],n=["Point","LineString","MultiLineString","Polygon","MultiPolygon"];return e&&"object"==typeof e?e.type?n.includes(e.type)?Array.isArray(e.coordinates)&&0!==e.coordinates.length?{valid:0===o.length,errors:o}:(o.push({featureId:t,field:"geometry.coordinates",message:"geometry.coordinates doit \xeatre un array non-vide",severity:"error"}),{valid:0,errors:o}):(o.push({featureId:t,field:"geometry.type",message:`Type de g\xe9om\xe9trie invalide '${e.type}'. Doit \xeatre : ${n.join(", ")}`,severity:"error"}),{valid:0,errors:o}):(o.push({featureId:t,field:"geometry.type",message:"geometry.type requis",severity:"error"}),{valid:0,errors:o}):(o.push({featureId:t,field:"geometry",message:"geometry requis et doit \xeatre un objet",severity:"error"}),{valid:0,errors:o})},validateProperties:function(e,t){const o=[];return e&&"object"==typeof e?(e.name||e.title||e.label||o.push({featureId:t,field:"properties.name",message:"properties doit contenir au moins name, title ou label",severity:"error"}),void 0!==e.distance_km&&"number"!=typeof e.distance_km&&o.push({featureId:t,field:"properties.distance_km",message:"distance_km doit \xeatre un nombre",severity:"warning"}),"number"==typeof e.distance_km&&e.distance_km<0&&o.push({featureId:t,field:"properties.distance_km",message:"distance_km doit \xeatre >= 0",severity:"warning"}),void 0!==e.duration_min&&"number"!=typeof e.duration_min&&o.push({featureId:t,field:"properties.duration_min",message:"duration_min doit \xeatre un nombre",severity:"warning"}),"number"==typeof e.duration_min&&e.duration_min<0&&o.push({featureId:t,field:"properties.duration_min",message:"duration_min doit \xeatre >= 0",severity:"warning"}),void 0!==e.rating&&("number"!=typeof e.rating?o.push({featureId:t,field:"properties.rating",message:"rating doit \xeatre un nombre",severity:"warning"}):(e.rating<0||e.rating>5)&&o.push({featureId:t,field:"properties.rating",message:"rating doit \xeatre entre 0 et 5",severity:"warning"})),void 0!==e.color&&"string"==typeof e.color&&(/^#([0-9a-fA-F]{6}|[0-9a-fA-F]{3})$/.test(e.color)||o.push({featureId:t,field:"properties.color",message:`color invalide '${e.color}'. Format: #RGB ou #RRGGBB`,severity:"warning"})),void 0!==e.opacity&&("number"!=typeof e.opacity?o.push({featureId:t,field:"properties.opacity",message:"opacity doit \xeatre un nombre",severity:"warning"}):(e.opacity<0||e.opacity>1)&&o.push({featureId:t,field:"properties.opacity",message:"opacity doit \xeatre entre 0 et 1",severity:"warning"})),void 0!==e.weight&&("number"!=typeof e.weight?o.push({featureId:t,field:"properties.weight",message:"weight doit \xeatre un nombre",severity:"warning"}):e.weight<0&&o.push({featureId:t,field:"properties.weight",message:"weight doit \xeatre >= 0",severity:"warning"})),["link","photo","url"].forEach(n=>{void 0!==e[n]&&"string"==typeof e[n]&&(Ot.isValidUrl(e[n])||o.push({featureId:t,field:`properties.${n}`,message:`${n} n'est pas une URL valide`,severity:"warning"}))}),void 0!==e.email&&"string"==typeof e.email&&(Ot.isValidEmail(e.email)||o.push({featureId:t,field:"properties.email",message:"email invalide",severity:"warning"})),void 0!==e.tags&&(Array.isArray(e.tags)?e.tags.forEach((e,n)=>{"string"!=typeof e&&o.push({featureId:t,field:`properties.tags[${n}]`,message:"tag doit \xeatre une string",severity:"warning"})}):o.push({featureId:t,field:"properties.tags",message:"tags doit \xeatre un array",severity:"warning"})),Object.entries(e).forEach(([e,n])=>{null===n||"object"!=typeof n||Array.isArray(n)||o.push({featureId:t,field:`properties.${e}`,message:`Propri\xe9t\xe9 imbriqu\xe9e d\xe9tect\xe9e. Les propri\xe9t\xe9s doivent \xeatre plates (strings, nombres, arrays). Objet trouv\xe9: ${JSON.stringify(n)}`,severity:"error"})}),{valid:!o.some(e=>"error"===e.severity),errors:o}):(o.push({featureId:t,field:"properties",message:"properties requis et doit \xeatre un objet",severity:"error"}),{valid:0,errors:o})},isValidUrl:function(e){if("string"!=typeof e)return 0;try{return new URL(e),1}catch{return/^(https?:\/\/|\/|\.\.?\/)/.test(e)}},isValidEmail:function(e){return"string"!=typeof e?0:/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}},Mt="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{};function kt(e,t={}){if(!e||"object"!=typeof e)return{};const o={};return e.fill||e.stroke?(e.fill&&(e.fill.color&&(o.fillColor=e.fill.color),o.fillOpacity="number"==typeof e.fill.opacity?e.fill.opacity:.4,e.fill.pattern&&(o.fillPattern=e.fill.pattern),t.setFillFlag&&(o.fill=1)),e.stroke&&(e.stroke.color&&(o.color=e.stroke.color),"number"==typeof e.stroke.opacity&&(o.opacity=e.stroke.opacity),"number"==typeof e.stroke.widthPx&&(o.weight=e.stroke.widthPx),e.stroke.dashArray&&(o.dashArray=e.stroke.dashArray),e.stroke.lineCap&&(o.lineCap=e.stroke.lineCap),e.stroke.lineJoin&&(o.lineJoin=e.stroke.lineJoin)),e.shape&&(o.shape=e.shape),"number"==typeof e.sizePx&&(o.radius=e.sizePx,o.sizePx=e.sizePx)):Object.assign(o,e),o}Mt.GeoLeaf||(Mt.GeoLeaf={}),Mt.GeoLeaf._StyleUtils={normalizeStyleToLeaflet:kt};const Nt="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{},Ft={getNestedValue:function(e,t){return e&&t?t.split(".").reduce((e,t)=>e&&void 0!==e[t]?e[t]:null,e):null},evaluateCondition:function(e,t,o,n){const{field:r,operator:i,value:a}=t;if(!r||!i)return 0;const l=Ft.getNestedValue(e,r);if(null==l)return 0;const s=o[i];if(!s)return n.warn&&n.warn("[GeoJSON] Op\xe9rateur styleRules inconnu:",i),0;try{return s(l,a)}catch(e){return n.warn&&n.warn("[GeoJSON] Erreur \xe9valuation condition:",e.message),0}},evaluateStyleRules:function(e,t){if(!Array.isArray(t)||0===t.length)return null;const o=Gt,n=W(),r=o.STYLE_OPERATORS;for(const o of t)if(o&&o.when&&o.style)if(o.when.all&&Array.isArray(o.when.all)){if(o.when.all.every(t=>Ft.evaluateCondition(e,t,r,n)))return o.style}else if(o.when.field&&o.when.operator&&Ft.evaluateCondition(e,o.when,r,n))return o.style;return null},buildLeafletOptions:function(e){const t=Ft.evaluateStyleRules,o=e=>{if(!e||"object"!=typeof e)return{};const t={};return e.fill||e.stroke?(e.fill&&(e.fill.color&&(t.fillColor=e.fill.color),"number"==typeof e.fill.opacity?t.fillOpacity=e.fill.opacity:t.fillOpacity=1),e.stroke&&(e.stroke.color&&(t.color=e.stroke.color),"number"==typeof e.stroke.opacity&&(t.opacity=e.stroke.opacity),"number"==typeof e.stroke.widthPx&&(t.weight=e.stroke.widthPx),e.stroke.dashArray&&(t.dashArray=e.stroke.dashArray),e.stroke.lineCap&&(t.lineCap=e.stroke.lineCap),e.stroke.lineJoin&&(t.lineJoin=e.stroke.lineJoin)),e.hatch&&e.hatch.enabled&&(t.hatch=Object.assign({},e.hatch),"pattern_only"===e.hatch.renderMode&&(t.fillColor="transparent",t.fillOpacity=1)),e.shape&&(t.shape=e.shape),"number"==typeof e.sizePx&&(t.radius=e.sizePx,t.sizePx=e.sizePx)):(Object.assign(t,e),"number"!=typeof t.fillOpacity&&(t.fillOpacity=1)),t};return{style(n){let r=Object.assign({},o(e.defaultStyle));if(e.styleRules&&Array.isArray(e.styleRules)){const i=t(n,e.styleRules);i&&(r=Object.assign({},r,o(i)))}const i="boolean"==typeof e.interactiveShape?e.interactiveShape:Nt.GeoLeaf&&Nt.GeoLeaf.Config&&Nt.GeoLeaf.Config.get?Nt.GeoLeaf.Config.get("ui.interactiveShapes",0):0;return r.interactive=i,r},pointToLayer:e.pointToLayer?function(t,o){return e.pointToLayer(t,o)}:function(t,o){const n="boolean"==typeof e.interactiveShape?e.interactiveShape:Nt.GeoLeaf&&Nt.GeoLeaf.Config&&Nt.GeoLeaf.Config.get?Nt.GeoLeaf.Config.get("ui.interactiveShapes",0):0,r=Nt.GeoLeaf&&Nt.GeoLeaf.Utils&&Nt.GeoLeaf.Utils.mergeOptions?Nt.GeoLeaf.Utils.mergeOptions(e.defaultPointStyle,{interactive:n}):Object.assign({},e.defaultPointStyle,{interactive:n});return Nt.L.circleMarker(o,r)},onEachFeature:function(t,o){t&&t.properties&&"string"==typeof t.properties.popupContent&&o.bindPopup(t.properties.popupContent),"function"==typeof e.onEachFeature&&e.onEachFeature(t,o)}}}};Nt.GeoLeaf||(Nt.GeoLeaf={}),Nt.GeoLeaf._StyleRules={evaluate:Ft.evaluateStyleRules,operators:Gt?Gt.STYLE_OPERATORS:{},getNestedValue:Ft.getNestedValue};const Dt="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{},Ut=()=>Gt.state,Rt={isAvailable:()=>!(!Dt.L||!Dt.L.vectorGrid||"function"!=typeof Dt.L.vectorGrid.protobuf),shouldUseVectorTiles(e){const t=this._getVTConfig(e);return t&&0!=t.enabled&&this.isAvailable()?e.style&&e.style.hatch&&e.style.hatch.enabled?(W().info(`[VectorTiles] Layer "${e.id}" has hatch patterns \u2192 falling back to GeoJSON/SVG renderer`),0):1:0},_getVTConfig:e=>e?e.vectorTiles&&"object"==typeof e.vectorTiles?e.vectorTiles:e.data&&e.data.vectorTiles&&"object"==typeof e.data.vectorTiles?e.data.vectorTiles:null:null,_resolveTileUrl(e,t){if(t.url&&(t.url.startsWith("http")||t.url.startsWith("//")||t.url.startsWith("/")))return t.url;const o=Dt.GeoLeaf&&Dt.GeoLeaf.Config,n=o&&o.get?o.get("data"):null,r=n&&n.profilesBasePath||"profiles",i=e._profileId,a=e._layerDirectory;return i&&a?`${r}/${i}/${a}/${t.tilesDirectory||"tiles"}/{z}/{x}/{y}.pbf`:t.url||null},_normalizeStyle:e=>kt(e,{setFillFlag:1}),convertStyleToVT(e,t){const o=this,n=this._normalizeStyle(t||{});if(!e)return n;const r=Object.assign({},n,this._normalizeStyle(e.defaultStyle));if(e.styleRules&&Array.isArray(e.styleRules)&&e.styleRules.length>0){const t=e.styleRules;return function(e){const n={properties:e||{}},i=Dt.GeoLeaf&&Dt.GeoLeaf._GeoJSONStyleResolver;if(i&&"function"==typeof i.evaluateStyleRules){const e=i.evaluateStyleRules(n,t);if(e)return Object.assign({},r,o._normalizeStyle(e))}return r}}return r},async loadVectorTileLayer(e,t,o,n){const r=W(),i=Ut(),a=this._getVTConfig(o);if(!a)throw new Error(`[VectorTiles] No vectorTiles config for ${e}`);const l=this._resolveTileUrl(o,a);if(!l)throw new Error(`[VectorTiles] Cannot resolve tile URL for ${e}`);let s=null;try{o.styles&&o.styles.default&&(s=await(Dt.GeoLeaf&&Dt.GeoLeaf._GeoJSONLayerConfig&&Dt.GeoLeaf._GeoJSONLayerConfig.loadDefaultStyle(e,o)))}catch(t){r.warn(`[VectorTiles] Could not load default style for ${e}:`,t.message)}const c=i.options.defaultStyle,u=this.convertStyleToVT(s,c),d=a.layerName||o.id,f=Gt.PaneHelpers,p=Gt.PANE_CONFIG;let g=o.zIndex;if("number"!=typeof g){const e=Array.from(i.layers.keys());g=Math.max(p.MIN_LAYER_ZINDEX,p.MAX_LAYER_ZINDEX-e.length)}else g=f.validateZIndex(g);o.zIndex=g;const h=f.getOrCreatePane?f.getOrCreatePane(g,i.map):f.getPaneName(g),y={vectorTileLayerStyles:{},interactive:0!=a.interactive,maxNativeZoom:a.maxNativeZoom||14,maxZoom:a.maxZoom||i.options.maxZoomOnFit||18,minZoom:a.minZoom||0,pane:h,rendererFactory:Dt.L&&Dt.L.canvas?Dt.L.canvas.tile:void 0,tolerance:a.tolerance||3};a.featureIdProperty&&(y.getFeatureId=function(e){return e.properties[a.featureIdProperty]||e.id}),y.vectorTileLayerStyles[d]=u,r.info(`[GeoLeaf.VectorTiles] \u2b21 Creating VT layer: ${e} (tile layer: ${d})`);const m=Dt.L.vectorGrid.protobuf(l,y);0!=a.interactive&&this._bindInteractions(m,o);const b=Dt.GeoLeaf&&Dt.GeoLeaf.Config,_=b&&b.get?b.get("data"):null,v=`${_&&_.profilesBasePath||"profiles"}/${o._profileId}/${o._layerDirectory}`,w={id:e,label:t,layer:m,visible:1,config:o,clusterGroup:null,legendsConfig:o.legends,basePath:v,useSharedCluster:0,features:[],geometryType:o.geometry||o.geometryType||"polygon",isVectorTile:1,vtLayerName:d,vtTileUrl:l,currentStyle:s,_visibility:{current:0,logicalState:0,source:"system",userOverride:0,themeOverride:0,themeDesired:null,zoomConstrained:0}};return i.layers.set(e,w),Dt.GeoLeaf&&Dt.GeoLeaf._GeoJSONLayerManager&&Dt.GeoLeaf._GeoJSONLayerManager.updateLayerVisibilityByZoom(),w.visible=0,r.info(`[GeoLeaf.VectorTiles] \u2705 VT layer loaded: ${e}`),{id:e,label:t,featureCount:0,isVectorTile:1}},_bindInteractions(e,t){const o=Dt.GeoLeaf&&Dt.GeoLeaf._GeoJSONPopupTooltip;if(t.popup&&0!=t.popup.enabled&&e.on("click",function(e){if(!e.layer||!e.layer.properties)return;const n={type:"Feature",properties:e.layer.properties,geometry:null};if(o&&"function"==typeof o._buildPopupContent){const r=o._buildPopupContent(n,t);r&&Dt.L.popup().setLatLng(e.latlng).setContent(r).openOn(Ut().map)}else{const t=n.properties,o=Object.keys(t).filter(e=>null!==t[e]&&void 0!==t[e]).slice(0,10).map(e=>`<b>${e}:</b> ${t[e]}`);o.length>0&&Dt.L.popup().setLatLng(e.latlng).setContent(o.join("<br>")).openOn(Ut().map)}}),t.tooltip&&0!=t.tooltip.enabled){let o=null;e.on("mouseover",function(e){if(!e.layer||!e.layer.properties)return;const n=t.tooltip.fields;if(!n||!Array.isArray(n)||0===n.length)return;const r=n[0].field||"",i=function(e,t){if(!e||!t)return null;const o=(t.startsWith("properties.")?t.substring(11):t).split(".");let n=e;for(const e of o){if(null==n)return null;n=n[e]}return void 0!==n?n:null}(e.layer.properties,r);i&&(o=Dt.L.tooltip({sticky:1}).setLatLng(e.latlng).setContent(String(i)),Ut().map.addLayer(o))}),e.on("mouseout",function(){o&&(Ut().map.removeLayer(o),o=null)})}},updateLayerStyle(e,t){W();const o=Ut(),n=o.layers.get(e);if(!n||!n.isVectorTile)return;const r=n.vtLayerName,i=n.layer;if(!i||!i.options)return;const a=o.options.defaultStyle,l=this.convertStyleToVT(t,a);i.options.vectorTileLayerStyles[r]=l,"function"==typeof i.redraw&&i.redraw(),n.currentStyle=t}},jt="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{},$t=()=>Gt.state,Bt={},zt={USER:"user",THEME:"theme",ZOOM:"zoom",SYSTEM:"system"};function Vt(e){e._visibility||(e._visibility={current:0,logicalState:0,source:zt.SYSTEM,userOverride:0,themeOverride:0,themeDesired:null,zoomConstrained:0})}Bt.setVisibility=function(e,t,o){const n=$t(),r=W(),i=n.layers.get(e);if(!i)return r.warn("[VisibilityManager] Couche introuvable:",e),0;Vt(i);const a=i._visibility;if(a.current,a.source,!this._canChangeVisibility(a,o,t))return a.userOverride,a.themeOverride,0;this._updateVisibilityFlags(a,o,t);const l=this._applyVisibilityChange(e,i,t);return l&&(a.current=t,a.source=o,i.visible=t,i.userDisabled=a.userOverride&&!t,i.themeHidden=a.themeOverride&&!t,this._notifyLegend(e,t),this._fireVisibilityEvent(e,t,o)),l},Bt._canChangeVisibility=function(e,t,o){return t===zt.USER||t===zt.ZOOM?1:e.userOverride||t===zt.ZOOM&&e.themeOverride&&0==e.themeDesired&&1==o?0:1},Bt._updateVisibilityFlags=function(e,t,o){switch(t){case zt.USER:e.userOverride=1,e.themeOverride=0,e.zoomConstrained=0,e.logicalState=o;break;case zt.THEME:e.userOverride||(e.themeOverride=1,e.themeDesired=o,e.zoomConstrained=0,e.logicalState=o);break;case zt.ZOOM:e.userOverride||(e.zoomConstrained=1);break;case zt.SYSTEM:e.userOverride=0,e.themeOverride=0,e.themeDesired=null,e.zoomConstrained=0,e.logicalState=o}},Bt._applyVisibilityChange=function(e,t,o){const n=$t(),r=W();if(!t.layer)return r.warn("[VisibilityManager] Layer Leaflet manquant pour:",e),0;const i=t.clusterGroup||t.layer,a=n.map&&n.map.hasLayer(i);if(o&&a)return 0;if(!o&&!a)return 0;try{return o?t.useSharedCluster&&t.clusterGroup?t.clusterGroup.addLayer(t.layer):t.clusterGroup?(n.map.addLayer(t.clusterGroup),t.clusterGroup.refreshClusters&&t.clusterGroup.refreshClusters()):n.map.addLayer(t.layer):t.useSharedCluster&&t.clusterGroup?t.clusterGroup.removeLayer(t.layer):t.clusterGroup?n.map.removeLayer(t.clusterGroup):n.map.removeLayer(t.layer),jt.GeoLeaf&&jt.GeoLeaf.LayerManager&&"function"==typeof jt.GeoLeaf.LayerManager.refresh&&jt.GeoLeaf.LayerManager.refresh(),jt.GeoLeaf&&jt.GeoLeaf._LabelButtonManager&&"function"==typeof jt.GeoLeaf._LabelButtonManager.syncImmediate&&jt.GeoLeaf._LabelButtonManager.syncImmediate(e),1}catch(t){return r.error(`[VisibilityManager] Erreur lors du changement de visibilit\xe9 de ${e}:`,t),0}},Bt._notifyLegend=function(e,t){jt.GeoLeaf&&jt.GeoLeaf.Legend&&"function"==typeof jt.GeoLeaf.Legend.setLayerVisibility&&jt.GeoLeaf.Legend.setLayerVisibility(e,t),jt.GeoLeaf&&jt.GeoLeaf.Labels&&(t?"function"==typeof jt.GeoLeaf.Labels.refreshLabels&&jt.GeoLeaf.Labels.refreshLabels(e):"function"==typeof jt.GeoLeaf.Labels._hideLabelsForLayer&&jt.GeoLeaf.Labels._hideLabelsForLayer(e)),jt.GeoLeaf&&jt.GeoLeaf._LabelButtonManager&&"function"==typeof jt.GeoLeaf._LabelButtonManager.syncImmediate&&jt.GeoLeaf._LabelButtonManager.syncImmediate(e)},Bt._fireVisibilityEvent=function(e,t,o){const n=$t();if(n.map)try{n.map.fire("geoleaf:geojson:visibility-changed",{layerId:e,visible:t,source:o})}catch(e){}},Bt.resetUserOverride=function(e){const t=$t().layers.get(e);t&&t._visibility&&(t._visibility.userOverride=0,W().debug(`[VisibilityManager] User override r\xe9initialis\xe9 pour ${e}`))},Bt.resetAllUserOverrides=function(){const e=$t();let t=0;e.layers.forEach(e=>{e._visibility&&e._visibility.userOverride&&(e._visibility.userOverride=0,t++)}),t>0&&W().debug(`[VisibilityManager] ${t} user override(s) r\xe9initialis\xe9(s)`)},Bt.getVisibilityState=function(e){const t=$t().layers.get(e);return t?(Vt(t),{current:t._visibility.current,source:t._visibility.source,userOverride:t._visibility.userOverride,themeOverride:t._visibility.themeOverride,zoomConstrained:t._visibility.zoomConstrained}):null},Bt.VisibilitySource=zt,W().info("[GeoLeaf._LayerVisibilityManager] Module charg\xe9");const qt="geojson-worker.js",Jt=function(){if("undefined"!=typeof document&&document.currentScript&&document.currentScript.src)return document.currentScript.src.substring(0,document.currentScript.src.lastIndexOf("/")+1);if("undefined"!=typeof document)for(var e=document.getElementsByTagName("script"),t=e.length-1;t>=0;t--){var o=e[t].src||"";if(/geoleaf[\w.-]*\.js/i.test(o))return o.substring(0,o.lastIndexOf("/")+1)}return""}(),Ht={worker:null,workerAvailable:1,pending:new Map,idleTimer:null};function Zt(){if(!Ht.workerAvailable)return null;if(Ht.worker)return Ht.worker;try{const e=Jt+qt,t=new Worker(e);return t.onmessage=Xt,t.onerror=Yt,Ht.worker=t,W().debug("[WorkerManager] Web Worker GeoJSON cr\xe9\xe9 :",e),t}catch(e){return W().warn("[WorkerManager] Impossible de cr\xe9er le Web Worker, fallback main-thread :",e.message),Ht.workerAvailable=0,null}}function Wt(){Ht.idleTimer&&clearTimeout(Ht.idleTimer),Ht.idleTimer=setTimeout(()=>{0===Ht.pending.size&&Ht.worker&&(Ht.worker.terminate(),Ht.worker=null,W().debug("[WorkerManager] Worker termin\xe9 apr\xe8s inactivit\xe9"))},3e4)}function Xt(e){const t=e.data;if(!t||!t.type)return;const o=t.layerId?Ht.pending.get(t.layerId):null;switch(t.type){case"chunk":o&&(t.features&&t.features.length&&o.features.push(...t.features),"function"==typeof o.onChunk&&o.onChunk(t.features,t.index,t.total));break;case"done":o&&(Ht.pending.delete(t.layerId),o.resolve({type:"FeatureCollection",features:o.features}),Wt());break;case"text-done":o&&(Ht.pending.delete(t.layerId),o.resolve(t.text||""),Wt());break;case"error":o?(Ht.pending.delete(t.layerId),o.reject(new Error(t.message)),Wt()):W().warn("[WorkerManager] Erreur Worker sans layerId :",t.message);break;case"pong":W().debug("[WorkerManager] Worker pong re\xe7u")}}function Yt(e){var t=e.message||e.filename||"unknown (possible 404 on "+Jt+qt+")";W().error("[WorkerManager] Erreur Worker :",t),Ht.pending.forEach(function(e){e.reject(new Error("Worker error: "+t))}),Ht.pending.clear(),Ht.workerAvailable=0,Ht.worker&&(Ht.worker.terminate(),Ht.worker=null)}const Qt={fetchGeoJSON:function(e,t,o){o=o||{};var n=e;if("undefined"!=typeof location&&e&&!e.includes("://"))try{n=new URL(e,location.href).href}catch(e){}var r=Zt();return r?new Promise(function(e,i){Ht.pending.set(t,{resolve:e,reject:i,features:[],onChunk:o.onChunk||null}),r.postMessage({type:"fetch",url:n,layerId:t,chunkSize:o.chunkSize||500}),Wt()}):function(e){return W(),fetch(e).then(function(t){if(!t.ok)throw new Error("HTTP "+t.status+" pour "+e);return t.json()}).then(function(e){return e&&"FeatureCollection"===e.type?e:e&&"Feature"===e.type?{type:"FeatureCollection",features:[e]}:Array.isArray(e)?{type:"FeatureCollection",features:e}:e})}(n)},fetchText:function(e,t){var o=e;if("undefined"!=typeof location&&e&&!e.includes("://"))try{o=new URL(e,location.href).href}catch(e){}var n=Zt();return n?new Promise(function(e,r){Ht.pending.set(t,{resolve:e,reject:r,features:[],onChunk:null}),n.postMessage({type:"fetch-text",url:o,layerId:t}),Wt()}):fetch(o).then(function(e){if(!e.ok)throw new Error("HTTP "+e.status+" pour "+o);return e.text()})},isAvailable:function(){return Ht.workerAvailable&&"undefined"!=typeof Worker},dispose:function(){Ht.idleTimer&&clearTimeout(Ht.idleTimer),Ht.pending.forEach(function(e){e.reject(new Error("WorkerManager disposed"))}),Ht.pending.clear(),Ht.worker&&(Ht.worker.terminate(),Ht.worker=null),W().debug("[WorkerManager] Disposed")}},Kt="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{},eo={resolveDataFilePath:function(e,t,o){const n=Kt.GeoLeaf&&Kt.GeoLeaf.Config,r=n&&n.get?n.get("data"):null,i=r&&r.profilesBasePath||"profiles",a=r&&r.activeProfile||t.id;return e.startsWith("../")?`${i}/${a}/${e.replace("../","")}`:e.startsWith("/")?e:o?`${i}/${a}/${o}/${e}`:`${i}/${a}/${e}`},inferGeometryType:function(e,t){if(e&&"string"==typeof e.geometryType)return e.geometryType;const o=(t&&Array.isArray(t.features)?t.features:[]).find(e=>e&&e.geometry&&e.geometry.type);if(!o)return"unknown";const n=o.geometry.type.toLowerCase();return n.includes("point")?"point":n.includes("line")?"line":n.includes("polygon")?"polygon":"unknown"},buildLayerOptions:function(e,t){const o=Gt.state,n=Object.assign({},o.options,t);e.style&&"object"==typeof e.style&&(n.defaultStyle=Object.assign({},n.defaultStyle,e.style)),Array.isArray(e.styleRules)&&e.styleRules.length>0&&(n.styleRules=e.styleRules),n.interactiveShape="boolean"==typeof e.interactiveShape?e.interactiveShape:Kt.GeoLeaf&&Kt.GeoLeaf.Config&&Kt.GeoLeaf.Config.get?Kt.GeoLeaf.Config.get("ui.interactiveShapes",0):0;const r="boolean"==typeof e.showIconsOnMap?e.showIconsOnMap:0,i=Gt.PaneHelpers.getPaneName(e.zIndex);if(r)n.pointToLayer=function(t,o){const r=Kt.GeoLeaf&&Kt.GeoLeaf._GeoJSONPopupTooltip,a=r?r.convertFeatureToPOI(t,e):null;if(a){const t=e.popup||{},o={enabled:t.enabled,detailPopup:t.detailPopup||t.fields||[],detailTooltip:t.detailTooltip||t.tooltip&&t.tooltip.fields||[]};a._layerConfig={style:n.defaultStyle||{},popup:o,tooltip:e.tooltip||{},sidepanelConfig:e.sidepanelConfig||{}}}const l=Kt.GeoLeaf&&Kt.GeoLeaf._POIMarkers;if(l&&"function"==typeof l.createMarker&&a){const e=0!=n.interactiveShape,t=l.createMarker(a,{attachEvents:e,pane:i});return t&&t.options&&(t.options.pane=i),t}const s=Object.assign({},n.defaultPointStyle,e.pointStyle,{interactive:n.interactiveShape,pane:i});return Kt.L.circleMarker(o,s)};else if(e.pointStyle&&"object"==typeof e.pointStyle){const t=Object.assign({},n.defaultPointStyle,e.pointStyle,{interactive:n.interactiveShape,pane:i});n.pointToLayer=function(e,o){return Kt.L.circleMarker(o,t)}}const a="function"==typeof e.onEachFeature?e.onEachFeature:null;return n.onEachFeature=function(t,o){const n=Kt.GeoLeaf&&Kt.GeoLeaf._GeoJSONPopupTooltip;n&&(n.bindUnifiedPopup(t,o,e),n.bindUnifiedTooltip(t,o,e)),a&&a(t,o)},n.defaultPointStyle?n.defaultPointStyle=Object.assign({},n.defaultPointStyle,{pane:i}):n.defaultPointStyle={pane:i},Kt.GeoLeaf&&Kt.GeoLeaf._GeoJSONStyleResolver&&Kt.GeoLeaf._GeoJSONStyleResolver.buildLeafletOptions?Kt.GeoLeaf._GeoJSONStyleResolver.buildLeafletOptions(n):n},loadLayerLegend:function(e,t){const o=W();if(!t)return;const n=t.legends?t:null;if(!n||!n.legends)return;const r=n.legends,i=(r.directory,t.style||"default");let a;if(a="default"===i&&r.default?r.default:`${i}.legend.json`,e.basePath||e.id,t._layerDirectory||t.id,Kt.GeoLeaf&&Kt.GeoLeaf.Legend&&"function"==typeof Kt.GeoLeaf.Legend.loadLayerLegend)try{Kt.GeoLeaf.Legend.loadLayerLegend(t.id,i,t),o&&o.info(`[GeoLeaf.GeoJSON] L\xe9gende affich\xe9e pour ${t.id} (style: ${i})`)}catch(e){o&&o.warn(`[GeoLeaf.GeoJSON] Erreur chargement l\xe9gende: ${e.message}`)}else o&&o.warn("[GeoLeaf.GeoJSON] Module Legend non disponible")},loadDefaultStyle:async function(e,t){if(W(),!t.styles||!t.styles.default)throw new Error("Pas de style par d\xe9faut d\xe9fini");const o=t._profileId,n=t._layerDirectory;if(!o||!n)throw new Error("M\xe9tadonn\xe9es manquantes (profileId ou layerDirectory)");const r=Kt.GeoLeaf&&Kt.GeoLeaf.Config,i=r&&r.get?r.get("data"):null,a=`${i&&i.profilesBasePath||"profiles"}/${o}/${n}/${t.styles.directory||"styles"}/${t.styles.default}`,l=await fetch(a);if(!l.ok)throw new Error(`HTTP ${l.status}`);return await l.json()}},to="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{},oo={convertFeatureToPOI:function(e,t){let o;const n=to.GeoLeaf&&to.GeoLeaf._Normalizer;if(n&&"function"==typeof n.normalizeFromGeoJSON)o=n.normalizeFromGeoJSON(e,t);else{const n=e.properties||{};o={id:n.id||"geojson-feature-"+Math.random().toString(36).substr(2,9),title:n.NAME||n.Name||n.name||n.TITLE||n.Title||n.title||n.LABEL||n.Label||n.label||"Sans titre",description:n.description||n.desc||"",properties:{...n},attributes:{source:"geojson",layerId:t.id,layerLabel:t.label,...n}},e.geometry&&e.geometry.coordinates&&(o.latlng=[e.geometry.coordinates[1],e.geometry.coordinates[0]],o.geometry=e.geometry,o.location={lat:e.geometry.coordinates[1],lng:e.geometry.coordinates[0]})}if(o){o.attributes=o.attributes||{},o.attributes.source="geojson",o.attributes.layerId=t.id,o.attributes.layerLabel=t.label,o._layerConfig=t;const e=to.GeoLeaf&&to.GeoLeaf._GeoJSONLoader,n=e&&e.getSidepanelConfig?e.getSidepanelConfig(t):null;n&&(o._sidepanelConfig={detailLayout:n})}return o},bindUnifiedPopup:function(e,t,o){const n=W();if(!e.properties)return;if(0==o.interactiveShape)return;if("boolean"==typeof o.showPopup&&!o.showPopup)return void t.on("click",n=>{if(n&&n.originalEvent&&n.originalEvent.stopPropagation(),t.getTooltip&&t.getTooltip())try{"function"==typeof t.closeTooltip?t.closeTooltip():t.unbindTooltip()}catch(e){}if(to.GeoLeaf&&to.GeoLeaf.POI&&"function"==typeof to.GeoLeaf.POI.showPoiDetails){const t=oo.convertFeatureToPOI(e,o),n=to.GeoLeaf._POIShared&&to.GeoLeaf._POIShared.state,r=n?n.currentPoiInPanel:null;r&&t&&r.id&&t.id&&r.id===t.id?to.GeoLeaf.POI&&"function"==typeof to.GeoLeaf.POI.hideSidePanel&&to.GeoLeaf.POI.hideSidePanel():to.GeoLeaf.POI.showPoiDetails(t)}});if(t.getPopup())return;const r=oo.convertFeatureToPOI(e,o),i=to.GeoLeaf&&to.GeoLeaf._ContentBuilder?.Assemblers||null,a=to.GeoLeaf&&to.GeoLeaf._GeoJSONLoader;let l=null;try{l=a&&a.getPopupConfig?a.getPopupConfig(o):null}catch(e){}if(i&&"function"==typeof i.buildPopupHTML){const e=to.GeoLeaf&&to.GeoLeaf._POIMarkers,o=e&&"function"==typeof e.resolveCategoryDisplay?e.resolveCategoryDisplay:null,n=i.buildPopupHTML(r,l,{resolveCategoryDisplay:o});n&&t.bindPopup(n)}else{const n=to.GeoLeaf&&to.GeoLeaf._POIPopup;if(n&&"function"==typeof n.buildQuickPopupContent){const e=to.GeoLeaf&&to.GeoLeaf._POIMarkers,o=e&&"function"==typeof e.resolveCategoryDisplay?e.resolveCategoryDisplay:null,i=n.buildQuickPopupContent(r,o);i&&t.bindPopup(i)}else{const n=to.GeoLeaf&&to.GeoLeaf.Security||{escapeHtml:e=>{if(!e)return"";const t=document.createElement("div");return t.textContent=String(e),t.innerHTML}},r=e.properties,i=r.name||r.label||r.title||"Sans titre",a=r.description||r.desc||"";let l='<div class="gl-geojson-popup">';l+='<h3 class="gl-popup-title">'+n.escapeHtml(i)+"</h3>",a&&(l+='<p class="gl-popup-description">'+n.escapeHtml(a)+"</p>"),to.GeoLeaf&&to.GeoLeaf.POI&&"function"==typeof to.GeoLeaf.POI.showPoiDetails&&(l+='<a href="#" class="gl-poi-popup__link" data-layer-id="'+o.id+'" data-feature-id="'+(r.id||"")+'">Voir d\xe9tails \u2192</a>'),l+="</div>",t.bindPopup(l)}}t._geoleafPopupActive=0,t.on("popupopen",()=>{if(t._geoleafPopupActive=1,t.getTooltip&&t.getTooltip())try{"function"==typeof t.closeTooltip&&t.closeTooltip()}catch(e){n.warn("[GeoJSON] Erreur fermeture tooltip:",e)}const r=t.getPopup();if(!r)return;const i=r.getElement();if(!i)return;const a=i.querySelector(".gl-poi-popup__link");a&&!a._geoleafClickBound&&(a._geoleafClickBound=1,a.addEventListener("click",t=>{if(t.preventDefault(),to.GeoLeaf&&to.GeoLeaf.POI&&"function"==typeof to.GeoLeaf.POI.showPoiDetails){const t=oo.convertFeatureToPOI(e,o);to.GeoLeaf.POI.showPoiDetails(t)}}))}),t.on("popupclose",()=>{t._geoleafPopupActive=0,t.getTooltip()&&t.getTooltip().options.permanent&&setTimeout(()=>{t.openTooltip&&!t._geoleafPopupActive&&t.openTooltip()},50)})},bindUnifiedTooltip:function(e,t,o){const n=Gt.state;if(!e.properties||!t)return;const r=o.tooltipMode||"hover",i="number"==typeof o.tooltipMinZoom?o.tooltipMinZoom:0;if("never"===r)return;const a=e.properties,l=a.NAME||a.Name||a.name||a.TITLE||a.Title||a.title||a.LABEL||a.Label||a.label||a.id||"Sans titre",s=to.GeoLeaf&&to.GeoLeaf._GeoJSONLoader,c=s&&s.getTooltipConfig?s.getTooltipConfig(o):null,u=oo.convertFeatureToPOI(e,o),d=()=>{if(!n.map)return;if(t._geoleafPopupActive)return;const e=n.map.getZoom()>=i,o=(()=>{const e=to.GeoLeaf&&to.GeoLeaf._ContentBuilder?.Assemblers||null;if(e&&"function"==typeof e.buildTooltipHTML)return e.buildTooltipHTML(u,c)||l;const t=to.GeoLeaf&&to.GeoLeaf._POIPopup;return t&&"function"==typeof t.buildTooltipContent&&t.buildTooltipContent(u)||l})();if(e)if(t.getTooltip()){const e=t.getTooltip();e&&e.setContent&&e.setContent(o)}else{const e={direction:"top",offset:[0,-10],opacity:.9,className:"gl-geojson-tooltip",permanent:"always"===r};t.bindTooltip(o,e),"always"===r&&t.openTooltip&&t.openTooltip()}else if(t.getTooltip())try{"function"==typeof t.closeTooltip?t.closeTooltip():t.unbindTooltip()}catch(e){}};t._geoleafTooltipUpdate=d,t.on("tooltipopen",()=>{t._geoleafPopupActive&&t.closeTooltip()}),t.on("add",()=>{d(),n.map&&n.map.on("zoomend",d)}),t.on("remove",()=>{n.map&&t._geoleafTooltipUpdate&&n.map.off("zoomend",t._geoleafTooltipUpdate)})}},no="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{},ro=()=>Gt.state,io={getLayerById:function(e){return ro().layers.get(e)||null},getLayerData:function(e){const t=ro().layers.get(e);return t?{geojson:t.geojson||null,features:t.features||[],geometryType:t.geometryType||"unknown",config:t.config||{},layer:t.layer}:null},getAllLayers:function(){const e=ro(),t=[];return e.layers.forEach((e,o)=>{const n=e._visibility,r=n&&"boolean"==typeof n.logicalState?n.logicalState:e.visible||0;t.push({id:o,label:e.label,visible:r,type:e.geometryType||io.detectLayerType(e.layer),featureCount:e.features?e.features.length:e.layer?e.layer.getLayers().length:0})}),t},detectLayerType:function(e){if(!e||"function"!=typeof e.eachLayer)return"mixed";const t={Point:0,LineString:0,Polygon:0};e.eachLayer(e=>{if(e.feature&&e.feature.geometry){const o=e.feature.geometry.type;o.includes("Point")?t.Point++:o.includes("LineString")?t.LineString++:o.includes("Polygon")&&t.Polygon++}});const o=Math.max(t.Point,t.LineString,t.Polygon);return 0===o?"mixed":t.Point===o?"poi":t.LineString===o?"route":t.Polygon===o?"area":"mixed"},removeLayer:function(e){const t=ro(),o=W(),n=t.layers.get(e);n?(n.visible&&io.hideLayer(e),n.clusterGroup&&n.clusterGroup.clearLayers(),n.layer&&n.layer.clearLayers(),t.layers.delete(e)):o.warn("[GeoLeaf.GeoJSON] removeLayer: couche introuvable :",e)},updateLayerZIndex:function(e,t){const o=ro(),n=W(),r=o.layers.get(e);if(!r)return n.warn("[GeoLeaf.GeoJSON] updateLayerZIndex: couche introuvable :",e),0;const i=Gt.PaneHelpers;t=i.validateZIndex(t);const a=r.config.zIndex||0;if(a===t)return 1;n.info(`[GeoLeaf.GeoJSON] Changement zIndex pour ${e}: ${a} \u2192 ${t}`),r.config.zIndex=t;const l=no.GeoLeaf&&no.GeoLeaf._LayerVisibilityManager,s=l?l.getVisibilityState(e):null;if(!(s?s.current:r.visible))return 1;const c=i.getPaneName(t);if(!o.map.getPane(c))return n.error(`[GeoLeaf.GeoJSON] Pane ${c} introuvable`),0;try{return r.clusterGroup?o.map.removeLayer(r.clusterGroup):o.map.removeLayer(r.layer),r.layer&&r.layer.options&&(r.layer.options.pane=c,r.layer.eachLayer(function(e){if(e.options&&(e.options.pane=c),e._path&&e._path.parentNode){const t=o.map.getPane(c);t&&t.appendChild(e._path)}})),r.clusterGroup&&r.clusterGroup.options&&(r.clusterGroup.options.pane=c),r.clusterGroup?o.map.addLayer(r.clusterGroup):o.map.addLayer(r.layer),o.map&&o.map.fire("geoleaf:geojson:zindex-changed",{layerId:e,oldZIndex:a,newZIndex:t}),1}catch(t){return n.error(`[GeoLeaf.GeoJSON] Erreur lors du changement de zIndex pour ${e}:`,t),0}}},ao="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{},lo=()=>Gt.state,so={calculateMapScale:Be,isScaleInRange:ze},co={};function uo(e){if(e._path&&e._path.ownerSVGElement)return e._path.ownerSVGElement;if("function"==typeof e.eachLayer){let t=null;if(e.eachLayer(e=>{!t&&e._path&&e._path.ownerSVGElement&&(t=e._path.ownerSVGElement)}),t)return t}const t=e._renderer||e._map?._renderer;if(t&&t._container&&"svg"===t._container.tagName)return t._container;const o=document.querySelectorAll(".leaflet-pane svg");return 1===o.length?o[0]:document.querySelector(".leaflet-overlay-pane svg")}function fo(e,t,o){if(!e||!t)return;let n=uo(e);if(!n){const r=5,i=100;let a=0;const l=()=>{n=uo(e),n?fo(e,t,o):(a++,a<r&&setTimeout(l,i))};return void setTimeout(l,i)}let r=n.querySelector(`#${t}`);if(!r&&o){const e=o.spacingPx||10,i=o.type||"diagonal",a=o.angleDeg,l=o.stroke?.color||"#000000",s=o.stroke?.widthPx||1,c=o.stroke?.opacity||1,u=l.startsWith("#")?l:`#${l}`;if(r=document.createElementNS("http://www.w3.org/2000/svg","pattern"),r.setAttribute("id",t),r.setAttribute("patternUnits","userSpaceOnUse"),r.setAttribute("width",e),r.setAttribute("height",e),"dot"===i){const t=document.createElementNS("http://www.w3.org/2000/svg","circle");t.setAttribute("cx",e/2),t.setAttribute("cy",e/2),t.setAttribute("r",Math.max(.3,.07*e)),t.setAttribute("fill",u),t.setAttribute("fill-opacity",c),r.appendChild(t)}else if("diagonal"===i){const t=document.createElementNS("http://www.w3.org/2000/svg","line");if(t.setAttribute("x1","0"),t.setAttribute("y1","0"),t.setAttribute("x2",e),t.setAttribute("y2",e),t.setAttribute("stroke",u),t.setAttribute("stroke-width",s),t.setAttribute("stroke-opacity",c),null!=a&&45!==a){const t=e/2,o=e/2;r.setAttribute("patternTransform",`rotate(${a} ${t} ${o})`)}r.appendChild(t)}else if("cross"===i){const t=document.createElementNS("http://www.w3.org/2000/svg","line");t.setAttribute("x1","0"),t.setAttribute("y1",e/2),t.setAttribute("x2",e),t.setAttribute("y2",e/2),t.setAttribute("stroke",u),t.setAttribute("stroke-width",s),t.setAttribute("stroke-opacity",c),r.appendChild(t);const o=document.createElementNS("http://www.w3.org/2000/svg","line");o.setAttribute("x1",e/2),o.setAttribute("y1","0"),o.setAttribute("x2",e/2),o.setAttribute("y2",e),o.setAttribute("stroke",u),o.setAttribute("stroke-width",s),o.setAttribute("stroke-opacity",c),r.appendChild(o)}else if("x"===i){const t=document.createElementNS("http://www.w3.org/2000/svg","line");t.setAttribute("x1","0"),t.setAttribute("y1","0"),t.setAttribute("x2",e),t.setAttribute("y2",e),t.setAttribute("stroke",u),t.setAttribute("stroke-width",s),t.setAttribute("stroke-opacity",c),r.appendChild(t);const o=document.createElementNS("http://www.w3.org/2000/svg","line");o.setAttribute("x1",e),o.setAttribute("y1","0"),o.setAttribute("x2","0"),o.setAttribute("y2",e),o.setAttribute("stroke",u),o.setAttribute("stroke-width",s),o.setAttribute("stroke-opacity",c),r.appendChild(o)}else if("horizontal"===i){const t=document.createElementNS("http://www.w3.org/2000/svg","line");t.setAttribute("x1","0"),t.setAttribute("y1",e/2),t.setAttribute("x2",e),t.setAttribute("y2",e/2),t.setAttribute("stroke",u),t.setAttribute("stroke-width",s),t.setAttribute("stroke-opacity",c),r.appendChild(t)}else if("vertical"===i){const t=document.createElementNS("http://www.w3.org/2000/svg","line");t.setAttribute("x1",e/2),t.setAttribute("y1","0"),t.setAttribute("x2",e/2),t.setAttribute("y2",e),t.setAttribute("stroke",u),t.setAttribute("stroke-width",s),t.setAttribute("stroke-opacity",c),r.appendChild(t)}let d=n.querySelector("defs");d||(d=document.createElementNS("http://www.w3.org/2000/svg","defs"),n.insertBefore(d,n.firstChild)),d.appendChild(r)}const i=e=>{if(e&&e.setAttribute){const n=`url(#${t})`;if(e.getAttribute("fill")!==n&&e.setAttribute("fill",n),o&&"pattern_only"===o.renderMode&&e.setAttribute("fill-opacity","1"),!e._hatchObserver){const o=new MutationObserver(o=>{o.forEach(o=>{if("attributes"===o.type&&"fill"===o.attributeName){const o=e.getAttribute("fill");o===n||o.includes(t)||e.setAttribute("fill",n)}})});o.observe(e,{attributes:1,attributeFilter:["fill"]}),e._hatchObserver=o}}};e._path&&i(e._path),"function"==typeof e.eachLayer&&e.eachLayer(e=>{e._path?i(e._path):"function"==typeof e.eachLayer&&e.eachLayer(e=>{e._path&&i(e._path)})}),e._disconnectHatchObservers||(e._disconnectHatchObservers=function(){const e=e=>{e._hatchObserver&&(e._hatchObserver.disconnect(),e._hatchObserver=null)};this._path&&e(this._path),"function"==typeof this.eachLayer&&this.eachLayer(t=>{t._path&&e(t._path),"function"==typeof t.eachLayer&&t.eachLayer(t=>{t._path&&e(t._path)})})},e.on("remove",function(){this._disconnectHatchObservers()}))}co.showLayer=function(e){const t=lo(),o=W(),n=t.layers.get(e);if(!n)return void o.warn("[GeoLeaf.GeoJSON] showLayer: couche introuvable :",e);const r=ao.GeoLeaf&&ao.GeoLeaf._LayerVisibilityManager;if(!r)return void o.error("[GeoLeaf.GeoJSON] LayerVisibilityManager non disponible");const i=r.setVisibility(e,1,r.VisibilitySource.USER);co.updateLayerVisibilityByZoom(),i&&(co._loadLayerLegend(e,n),ao.GeoLeaf&&ao.GeoLeaf.Labels&&ao.GeoLeaf.Labels.hasLabelConfig(e)&&(1==n.currentStyle?.label?.visibleByDefault?ao.GeoLeaf.Labels.enableLabels(e,{},1):ao.GeoLeaf.Labels.areLabelsEnabled(e)&&ao.GeoLeaf.Labels.refreshLabels(e)),ao.GeoLeaf&&ao.GeoLeaf._LabelButtonManager&&ao.GeoLeaf._LabelButtonManager.syncImmediate(e))},co.hideLayer=function(e){const t=lo(),o=W();if(!t.layers.get(e))return void o.warn("[GeoLeaf.GeoJSON] hideLayer: couche introuvable :",e);const n=ao.GeoLeaf&&ao.GeoLeaf._LayerVisibilityManager;if(!n)return void o.error("[GeoLeaf.GeoJSON] LayerVisibilityManager non disponible");const r=n.setVisibility(e,0,n.VisibilitySource.USER);co.updateLayerVisibilityByZoom(),r&&(ao.GeoLeaf&&ao.GeoLeaf.Labels&&ao.GeoLeaf.Labels.disableLabels(e),ao.GeoLeaf&&ao.GeoLeaf._LabelButtonManager&&ao.GeoLeaf._LabelButtonManager.syncImmediate(e))},co.toggleLayer=function(e){const t=lo(),o=W(),n=t.layers.get(e);if(!n)return void o.warn("[GeoLeaf.GeoJSON] toggleLayer: couche introuvable :",e);const r=ao.GeoLeaf&&ao.GeoLeaf._LayerVisibilityManager;if(!r)return void o.error("[GeoLeaf.GeoJSON] LayerVisibilityManager non disponible");const i=r.getVisibilityState(e);(i?i.current:n.visible)?co.hideLayer(e):co.showLayer(e)},co.updateLayerVisibilityByZoom=function(){const e=lo(),t=W();if(!e.map)return;const o=ao.GeoLeaf&&ao.GeoLeaf._LayerVisibilityManager;if(!o)return void t.error("[GeoLeaf.GeoJSON] LayerVisibilityManager non disponible");const n=so&&"function"==typeof so.calculateMapScale?so.calculateMapScale(e.map,{logger:t}):0,r=e=>"number"!=typeof e||e<=0?null:e;e.layers.forEach((e,i)=>{if(!e.config)return;const a=!!e.currentStyle,l=a?e.currentStyle.layerScale:null;!l&&a&&t&&"function"==typeof t.warn&&t.warn(`[GeoLeaf.GeoJSON] layerScale manquant pour ${i}, couche laiss\xe9e visible par d\xe9faut`);const s=r(l&&l.minScale),c=r(l&&l.maxScale),u=so&&"function"==typeof so.isScaleInRange?so.isScaleInRange(n,s,c,t):1,d=e._visibility;let f;f=d&&d.userOverride?d.logicalState:d&&d.themeOverride?d.themeDesired:1;const p=f&&u;o.setVisibility(i,p,o.VisibilitySource.ZOOM)})},co._fireLayerVisibilityEvent=function(e,t){const o=lo();if(o.map)try{o.map.fire("geoleaf:geojson:visibility-changed",{layerId:e,visible:t})}catch(e){}};const po="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{},go={};function ho(e,t){if(!e||"object"!=typeof e)return{};const o=kt(e);if((e.fill||e.stroke)&&(e.hatch&&e.hatch.enabled&&"pattern_only"===e.hatch.renderMode&&(o.fillColor="transparent",o.fillOpacity=1),e.casing&&e.casing.enabled&&(o._casing={enabled:1,color:e.casing.color||"#000000",opacity:"number"==typeof e.casing.opacity?e.casing.opacity:1,weight:"number"==typeof e.casing.widthPx?e.casing.widthPx:1,dashArray:e.casing.dashArray||null,lineCap:e.casing.lineCap||null,lineJoin:e.casing.lineJoin||null}),e.hatch)){if(o.hatch={...e.hatch},e.hatch.stroke){const t={};e.hatch.stroke.color&&(t.color=e.hatch.stroke.color),"number"==typeof e.hatch.stroke.opacity&&(t.opacity=e.hatch.stroke.opacity),"number"==typeof e.hatch.stroke.widthPx&&(t.widthPx=e.hatch.stroke.widthPx),o.hatch.stroke=t}if(e.hatch.enabled&&t){const n=function(e,t){if(!t||!t.enabled)return null;const o=t.type||"diagonal",n=t.angleDeg||0,r=t.spacingPx||10,i=(t.stroke?.color||"#000000").replace("#",""),a=t.stroke?.widthPx||1,l=t.stroke?.opacity||1,s=`hatch-${e}-${o}-${n}-${r}-${i}-${a}-${l}`;if(document.getElementById(s))return s;const c=document.createElementNS("http://www.w3.org/2000/svg","pattern");if(c.setAttribute("id",s),c.setAttribute("patternUnits","userSpaceOnUse"),c.setAttribute("width",r),c.setAttribute("height",r),"dot"===o){const e=document.createElementNS("http://www.w3.org/2000/svg","circle");e.setAttribute("cx",r/2),e.setAttribute("cy",r/2),e.setAttribute("r",Math.max(.5,a/2)),e.setAttribute("fill",`#${i}`),e.setAttribute("fill-opacity",l),c.appendChild(e)}else if("cross"===o){const e=document.createElementNS("http://www.w3.org/2000/svg","line");e.setAttribute("x1","0"),e.setAttribute("y1",r/2),e.setAttribute("x2",r),e.setAttribute("y2",r/2),e.setAttribute("stroke",`#${i}`),e.setAttribute("stroke-width",a),e.setAttribute("stroke-opacity",l),c.appendChild(e);const t=document.createElementNS("http://www.w3.org/2000/svg","line");t.setAttribute("x1",r/2),t.setAttribute("y1","0"),t.setAttribute("x2",r/2),t.setAttribute("y2",r),t.setAttribute("stroke",`#${i}`),t.setAttribute("stroke-width",a),t.setAttribute("stroke-opacity",l),c.appendChild(t)}else if("x"===o){const e=document.createElementNS("http://www.w3.org/2000/svg","line");e.setAttribute("x1","0"),e.setAttribute("y1","0"),e.setAttribute("x2",r),e.setAttribute("y2",r),e.setAttribute("stroke",`#${i}`),e.setAttribute("stroke-width",a),e.setAttribute("stroke-opacity",l),c.appendChild(e);const t=document.createElementNS("http://www.w3.org/2000/svg","line");t.setAttribute("x1",r),t.setAttribute("y1","0"),t.setAttribute("x2","0"),t.setAttribute("y2",r),t.setAttribute("stroke",`#${i}`),t.setAttribute("stroke-width",a),t.setAttribute("stroke-opacity",l),c.appendChild(t)}else{const e=document.createElementNS("http://www.w3.org/2000/svg","line");if("horizontal"===o||0===n)e.setAttribute("x1","0"),e.setAttribute("y1",r/2),e.setAttribute("x2",r),e.setAttribute("y2",r/2);else if("vertical"===o||90===n)e.setAttribute("x1",r/2),e.setAttribute("y1","0"),e.setAttribute("x2",r/2),e.setAttribute("y2",r);else if(e.setAttribute("x1","0"),e.setAttribute("y1","0"),e.setAttribute("x2",r),e.setAttribute("y2",r),null!=n&&45!==n){const e=r/2,t=r/2;c.setAttribute("patternTransform",`rotate(${n} ${e} ${t})`)}e.setAttribute("stroke",`#${i}`),e.setAttribute("stroke-width",a),e.setAttribute("stroke-opacity",l),c.appendChild(e)}return s}(t,e.hatch);n&&(o._hatchPatternId=n,"pattern_only"===e.hatch.renderMode&&(o.fillColor="transparent",o.fillOpacity=1))}}return o}go.setLayerStyle=function(e,t){const o=Gt.state,n=W(),r=o.layers.get(e);if(!r)return n.warn("[GeoLeaf.GeoJSON] setLayerStyle: couche introuvable :",e),0;if(r.isVectorTile&&po.GeoLeaf&&po.GeoLeaf._VectorTiles)return po.GeoLeaf._VectorTiles.updateLayerStyle(e,t),1;const i=r.layer;if(!i||"function"!=typeof i.setStyle)return n.warn("[GeoLeaf.GeoJSON] setLayerStyle: couche sans m\xe9thode setStyle :",e),0;const a=ho(t.defaultStyle||t.style||{},e),l=Object.assign({},{color:"#999999",weight:2,opacity:.9,fillColor:"#cccccc",fillOpacity:.15},a),s=Array.isArray(t.styleRules)?t.styleRules:[];try{let o=0,n=0;const a=[];if(i.eachLayer(function(t){if(!t.feature)return;const n=(t=>{let o=Object.assign({},l);if(s.length>0&&po.GeoLeaf&&po.GeoLeaf._GeoJSONStyleResolver){const n=po.GeoLeaf._GeoJSONStyleResolver.evaluateStyleRules(t,s);if(n){const t=ho(n,e);o=Object.assign({},o,t)}}return o})(t.feature);if(t.setStyle&&"function"==typeof t.setStyle){t.setStyle(n);const e="boolean"==typeof r.config.interactiveShape?r.config.interactiveShape:po.GeoLeaf&&po.GeoLeaf.Config&&po.GeoLeaf.Config.get?po.GeoLeaf.Config.get("ui.interactiveShapes",0):0;if(t.options&&(t.options.interactive=e),t._path&&(t._path.style.pointerEvents=e?"auto":"none"),!t._path&&t._renderer&&"function"==typeof t.redraw&&t.redraw(),o++,n._casing&&n._casing.enabled&&t instanceof po.L.Polyline&&!(t instanceof po.L.Polygon)){const e=n._casing;if(t._casingLayer)t._casingLayer.setStyle({color:e.color,opacity:e.opacity,weight:e.weight,dashArray:e.dashArray,lineCap:e.lineCap||"butt",lineJoin:e.lineJoin||"miter"});else{const o={color:e.color,opacity:e.opacity,weight:e.weight,dashArray:e.dashArray,lineCap:e.lineCap||"butt",lineJoin:e.lineJoin||"miter",fill:0};t._casingLayer=po.L.polyline(t.getLatLngs(),o),i&&i.addLayer?i.addLayer(t._casingLayer):t._map&&t._map.addLayer(t._casingLayer),t._casingLayer.setZIndex&&t._casingLayer.setZIndex((t.options.zIndex||0)-1)}}else n._casing&&n._casing.enabled||t._casingLayer&&i&&i.removeLayer&&(i.removeLayer(t._casingLayer),t._casingLayer=null);if(n._hatchPatternId&&n.hatch){const e=n._hatchPatternId,o=n.hatch;setTimeout(()=>{fo(t,e,o)},0),t._hatchPatternId&&t._hatchPatternId===e||(t._hatchPatternId=e,t._hatchListener&&t.off("add",t._hatchListener),t._hatchListener=function(){fo(this,e,o)},t.on("add",t._hatchListener),t._hatchCleanupBound||(t._hatchCleanupBound=1,t.on("remove",function(){this._hatchListener&&(this.off("add",this._hatchListener),this._hatchListener=null)})))}}else po.L&&t instanceof po.L.Marker&&a.push({layer:t,feature:t.feature,style:n})}),a.length>0){const e=po.GeoLeaf&&po.GeoLeaf._POIMarkers;a.forEach(({layer:t,feature:o,style:r})=>{const a=t.getLatLng();if(e&&"function"==typeof e.buildMarkerIcon){const i={...o.properties,latlng:[a.lat,a.lng],attributes:o.properties.attributes||{},_layerConfig:{style:r}};let l={};"function"==typeof e.resolveCategoryDisplay&&(l=e.resolveCategoryDisplay(i)),r.fillColor&&(l.colorFill=r.fillColor),r.color&&(l.colorStroke=r.color),"number"==typeof r.radius&&(l.radius=r.radius),"number"==typeof r.weight&&(l.weight=r.weight),"number"==typeof r.fillOpacity&&(l.fillOpacity=r.fillOpacity),"number"==typeof r.opacity&&(l.opacity=r.opacity);const s=e.buildMarkerIcon(l);t.setIcon(s),n++}else{const e=po.L.circleMarker(a,r);e.feature=o,i.removeLayer(t),i.addLayer(e),n++}})}const c=s.some(e=>e.style?.hatch?.enabled);if(l._hatchPatternId&&!c){const e=l._hatchPatternId,t=l.hatch;fo(i,e,t),r._hatchListeners&&(i.off("add",r._hatchListeners.onAdd),po.L&&po.L.DomEvent&&i.eachLayer(e=>{e._path&&e.off("add",r._hatchListeners.onLayerAdd)}));const o=()=>{setTimeout(()=>fo(i,e,t),0)},n=function(){fo(this,e,t)};i.on("add",o),i.eachLayer(e=>{e._path&&e.on("add",n)}),r._hatchListeners={onAdd:o,onLayerAdd:n},r._hatchPatternId=e}return r.config=Object.assign({},r.config,{style:t.defaultStyle||t.style,styleRules:s}),r.currentStyle=t,po.GeoLeaf&&po.GeoLeaf._LabelButtonManager&&po.GeoLeaf._LabelButtonManager.syncImmediate(e),po.GeoLeaf&&po.GeoLeaf._GeoJSONLayerManager&&"function"==typeof po.GeoLeaf._GeoJSONLayerManager.updateLayerVisibilityByZoom&&po.GeoLeaf._GeoJSONLayerManager.updateLayerVisibilityByZoom(),1}catch(t){return n.error("[GeoLeaf.GeoJSON] Erreur setLayerStyle :",e,t.message),0}};const yo="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{},mo={registerWithLayerManager:function(){const e=Gt.state,t=W(),o=yo.GeoLeaf&&yo.GeoLeaf.LayerManager;if(t.info(`[GeoLeaf.GeoJSON] registerWithLayerManager() appel\xe9 avec ${e.layers.size} couche(s)`),!o||"function"!=typeof o._registerGeoJsonLayer)return void t.warn("[GeoLeaf.GeoJSON] Module LayerManager non disponible, pas d'int\xe9gration gestionnaire de couches");const n=new Map;e.layers.forEach((e,o)=>{const r=e.config.layerManagerId||"geojson-default";n.has(r)||n.set(r,{id:r,order:99,items:[]});const i=mo.detectLayerType(e.layer);let a="fill";"poi"===i?a="circle":"route"===i?a="line":"area"===i&&(a="fill");let l="#3388ff";e.config.style?l=e.config.style.fillColor||e.config.style.color||l:e.config.pointStyle&&(l=e.config.pointStyle.fillColor||l);let s=0,c=null;e.config.labels&&e.config.labels.enabled&&(s=1,c=e.config.labels),!s&&e.currentStyle&&e.currentStyle.label&&e.currentStyle.label.enabled&&(s=1,c={enabled:1}),t&&t.info(`[GeoJSON LayerManager] \u{1f50d} Pr\xe9paration item ${o}:`,{hasConfig:!!e.config,hasStyles:!(!e.config||!e.config.styles),styles:e.config?e.config.styles:"NO CONFIG",configKeys:e.config?Object.keys(e.config).sort():[]}),n.get(r).items.push({id:o,label:e.label,type:a,color:l,visible:e.visible,toggleable:1,order:0,zIndex:e.config.zIndex||0,themes:e.config.themes||null,labels:s?c:null,styles:e.config.styles||null})}),n.forEach(e=>{e.items.sort((e,t)=>(t.zIndex||0)-(e.zIndex||0)),e.items.forEach(t=>{t.id,e.id,o._registerGeoJsonLayer(t.id,{layerManagerId:e.id,label:t.label,themes:t.themes,styles:t.styles,labels:t.labels})}),e.id,e.items.length})},_loadLayerLegend:function(e,t){const o=t.config||{};if(yo.GeoLeaf&&yo.GeoLeaf.Legend&&"function"==typeof yo.GeoLeaf.Legend.loadLayerLegend){const n=yo.GeoLeaf._LayerManagerStyleSelector;let r=null;if(n&&"function"==typeof n.getCurrentStyle&&(r=n.getCurrentStyle(e)||null),!r&&t.currentStyleMetadata&&t.currentStyleMetadata.id&&(r=t.currentStyleMetadata.id),!r&&o.styles&&Array.isArray(o.styles.available)){const e=o.styles.available,t=o.styles.default,n=t?e.find(e=>e.file===t):null;r=n&&n.id||e[0]&&e[0].id||"default"}return r||(r="default"),void yo.GeoLeaf.Legend.loadLayerLegend(e,r,o)}},populateLayerManagerWithAllConfigs:function(e){const t=W(),o=yo.GeoLeaf&&yo.GeoLeaf.LayerManager;if(!o||"function"!=typeof o._registerGeoJsonLayer)return void t.warn("[GeoLeaf.GeoJSON] populateLayerManagerWithAllConfigs: Module LayerManager non disponible");if(!yo.GeoLeaf||!yo.GeoLeaf._allLayerConfigs||!Array.isArray(yo.GeoLeaf._allLayerConfigs))return void t.warn("[GeoLeaf.GeoJSON] populateLayerManagerWithAllConfigs: GeoLeaf._allLayerConfigs non disponible");t.info(`[GeoLeaf.GeoJSON] Peuplement LayerManager avec ${yo.GeoLeaf._allLayerConfigs.length} configs de couches...`);let n=[];e&&Array.isArray(e.layers)&&(n=e.layers.map(e=>e.id||e)),n.join(", ");const r=new Map;yo.GeoLeaf._allLayerConfigs.forEach(e=>{const t=e.layerManagerId||"geojson-default";r.has(t)||r.set(t,{id:t,items:[]});const o=n.includes(e.id);r.get(t).items.push({id:e.id,label:e.label,layerManagerId:t,themes:e.themes||null,isActive:o,zIndex:e.zIndex||0,styles:e.styles||null,labels:e.labels||null})}),r.forEach(e=>{e.items.sort((e,t)=>(t.zIndex||0)-(e.zIndex||0)),e.items.forEach(t=>{t.id,e.id,t.isActive,o._registerGeoJsonLayer(t.id,{layerManagerId:e.id,label:t.label,themes:t.themes,checked:t.isActive,styles:t.styles,labels:t.labels})}),e.id,e.items.length}),t.info("[GeoLeaf.GeoJSON] LayerManager peupl\xe9 avec succ\xe8s"),o._updateUI&&"function"==typeof o._updateUI&&o._updateUI()}},bo={getPopupConfig:function(e){return e?e.popupFields&&Array.isArray(e.popupFields)?e.popupFields:e.popup&&e.popup.fields&&Array.isArray(e.popup.fields)?e.popup.fields:null:null},getTooltipConfig:function(e){return e?e.tooltipFields&&Array.isArray(e.tooltipFields)?e.tooltipFields:e.tooltip&&e.tooltip.fields&&Array.isArray(e.tooltip.fields)?e.tooltip.fields:null:null},getSidepanelConfig:function(e){return e?e.sidepanelFields&&Array.isArray(e.sidepanelFields)?e.sidepanelFields:e.sidepanel&&e.sidepanel.detailLayout&&Array.isArray(e.sidepanel.detailLayout)?e.sidepanel.detailLayout:null:null}},_o="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{},Lo=()=>Gt.state,vo={loadUrl:async function(e,t={}){const o=Lo(),n=W();if(!e)return n.warn("[GeoLeaf.GeoJSON] URL GeoJSON manquante."),o.geoJsonLayer;if(!o.map)return n.error("[GeoLeaf.GeoJSON] Module non initialis\xe9. Appelle GeoLeaf.GeoJSON.init() avant loadUrl()."),null;const r=_o.GeoLeaf&&_o.GeoLeaf.Utils&&_o.GeoLeaf.Utils.mergeOptions?_o.GeoLeaf.Utils.mergeOptions(o.options,t):Object.assign({},o.options,t);try{const t=_o.GeoLeaf&&_o.GeoLeaf.Utils?.FetchHelper;let n;if(t)n=await t.get(e,{timeout:2e4,retries:2});else{const t=await fetch(e);if(!t.ok)throw new Error("HTTP "+t.status+" pour "+e);n=await t.json()}return _o.GeoLeaf&&vo.addData(n,r),o.geoJsonLayer}catch(e){return n.error("[GeoLeaf.GeoJSON] Erreur lors du chargement GeoJSON :",e),o.geoJsonLayer}},addData:function(e,t={}){const o=Lo(),n=W();if(!e)return void n.warn("[GeoLeaf.GeoJSON] Aucune donn\xe9e GeoJSON fournie \xe0 addData().");if(!o.map||!o.geoJsonLayer)return void n.error("[GeoLeaf.GeoJSON] Module non initialis\xe9. Appelle GeoLeaf.GeoJSON.init() avant addData().");const r=_o.GeoLeaf&&_o.GeoLeaf.Utils&&_o.GeoLeaf.Utils.mergeOptions?_o.GeoLeaf.Utils.mergeOptions(o.options,t):Object.assign({},o.options,t);_o.GeoLeaf&&_o.GeoLeaf._GeoJSONStyleResolver&&_o.GeoLeaf._GeoJSONStyleResolver.buildLeafletOptions&&(o.geoJsonLayer.options=_o.GeoLeaf._GeoJSONStyleResolver.buildLeafletOptions(r));let i=e;if(_o.GeoLeaf&&_o.GeoLeaf._GeoJSONFeatureValidator&&"function"==typeof _o.GeoLeaf._GeoJSONFeatureValidator.validateFeatureCollection){const t=_o.GeoLeaf._GeoJSONFeatureValidator.validateFeatureCollection(e);if(t.errors.length>0&&n.warn(`[GeoLeaf.GeoJSON] Validation: ${t.errors.length} feature(s) rejet\xe9e(s), ${t.validFeatures.length} accept\xe9e(s)`),!(t.validFeatures.length>0))return void n.warn("[GeoLeaf.GeoJSON] Aucune feature valide \xe0 ajouter apr\xe8s validation");i="FeatureCollection"===e.type?{type:"FeatureCollection",features:t.validFeatures}:1===t.validFeatures.length?t.validFeatures[0]:{type:"FeatureCollection",features:t.validFeatures}}if(o.geoJsonLayer.addData(i),r.fitBoundsOnLoad&&o.layerGroup){const e=o.layerGroup.getBounds();if(e.isValid()){const t={};"number"==typeof r.maxZoomOnFit&&(t.maxZoom=r.maxZoomOnFit),o.map.fitBounds(e,t)}}try{o.map.fire("geoleaf:geojson:loaded",{data:e,layer:o.geoJsonLayer})}catch(e){}}},wo="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{},Co={loadFromActiveProfile:function(e={}){const t=Gt.state,o=W(),n=wo.GeoLeaf&&wo.GeoLeaf.Config;if(!n||"function"!=typeof n.getActiveProfile)return o.warn("[GeoLeaf.GeoJSON] Module Config ou Config.getActiveProfile() non disponible ; chargement GeoJSON par profil impossible."),Promise.resolve([]);const r=n.getActiveProfile();if(!r||"object"!=typeof r)return o.warn("[GeoLeaf.GeoJSON] Aucun profil actif ou profil invalide ; aucun GeoJSON charg\xe9."),Promise.resolve([]);let i=[];if(Array.isArray(r.geojsonLayers))i=r.geojsonLayers;else if(r.geojson&&Array.isArray(r.geojson.layers))i=r.geojson.layers;else if(Array.isArray(r.layers))i=r.layers;else if(n.Profile&&"function"==typeof n.Profile.getActiveProfileLayersConfig){const e=n.Profile.getActiveProfileLayersConfig();Array.isArray(e)&&(i=e,o.info("[GeoLeaf.GeoJSON] Utilisation du syst\xe8me v3.0 - "+e.length+" couches d\xe9tect\xe9es"))}if(!i.length)return o.info("[GeoLeaf.GeoJSON] Aucun bloc geojsonLayers / geojson.layers / layers d\xe9fini dans le profil actif ; rien \xe0 charger."),Promise.resolve([]);i.length>50?o.warn("[GeoLeaf.GeoJSON] Beaucoup de couches GeoJSON d\xe9tect\xe9es ("+i.length+"). Cela peut affecter les performances."):i.length>20&&o.info("[GeoLeaf.GeoJSON] "+i.length+" couches GeoJSON d\xe9tect\xe9es. Profil riche d\xe9tect\xe9.");const a=e||{},l=this,s=i.map((e,n)=>async()=>{if(!e||"object"!=typeof e)return o.warn("[GeoLeaf.GeoJSON] Descripteur GeoJSON de profil invalide, ignor\xe9 :",{index:n,def:e}),null;if("boolean"==typeof e.active&&0==e.active)return e.id,null;const i=e._layerDirectory||null,s=e.url||(e.dataFile?l._resolveDataFilePath(e.dataFile,r,i):null);if(!s)return o.warn("[GeoLeaf.GeoJSON] Descripteur GeoJSON sans URL ou dataFile, ignor\xe9 :",{index:n,id:e.id,label:e.label}),null;const c={...e,url:s};c._profileId=r.id,c._layerDirectory=i,e.popup&&"object"==typeof e.popup&&(c.showPopup=0!=e.popup.enabled,e.popup.fields&&Array.isArray(e.popup.fields)&&(c.popupFields=e.popup.fields),c.popup=e.popup),e.tooltip&&"object"==typeof e.tooltip&&(c.showTooltip=0!=e.tooltip.enabled,e.tooltip.fields&&Array.isArray(e.tooltip.fields)&&(c.tooltipFields=e.tooltip.fields),e.tooltip.mode&&(c.tooltipMode=e.tooltip.mode),c.tooltip=e.tooltip),e.sidepanel&&"object"==typeof e.sidepanel&&(e.sidepanel.detailLayout&&Array.isArray(e.sidepanel.detailLayout)&&(c.sidepanelFields=e.sidepanel.detailLayout),c.sidepanel=e.sidepanel),e.clustering&&"object"==typeof e.clustering&&(c.clustering=0!=e.clustering.enabled,"number"==typeof e.clustering.maxClusterRadius&&(c.maxClusterRadius=e.clustering.maxClusterRadius,c.clusterRadius=e.clustering.maxClusterRadius),"number"==typeof e.clustering.disableClusteringAtZoom&&(c.disableClusteringAtZoom=e.clustering.disableClusteringAtZoom)),e.search&&"object"==typeof e.search&&(c.search=e.search),e.table&&"object"==typeof e.table&&(c.table=e.table),e.data&&e.data.vectorTiles&&"object"==typeof e.data.vectorTiles&&(c.vectorTiles=e.data.vectorTiles),e.vectorTiles&&"object"==typeof e.vectorTiles&&(c.vectorTiles=e.vectorTiles);const u=e.id||"geojson-layer-"+t.layerIdCounter++,d=e.label||u;r.id;try{return await wo.GeoLeaf._GeoJSONLoader._loadSingleLayer(u,d,c,a)}catch(e){return o.error("[GeoLeaf.GeoJSON] \xc9chec chargement couche :",{layerId:u,url:s,error:e}),null}}),c=l._getDefaultThemeLayerIds(r),u=[],d=[];return i.forEach((e,t)=>{e&&e.id&&c.has(e.id)?u.push(s[t]):d.push(s[t])}),o.info(`[GeoLeaf.GeoJSON] Smart loading: ${u.length} imm\xe9diate(s) (th\xe8me par d\xe9faut), ${d.length} diff\xe9r\xe9e(s)`),this._loadLayersByBatch(u,3,200).then(e=>{const n=e.filter(Boolean);if(o.info("[GeoLeaf.GeoJSON] Phase 1 : "+n.length+" couche(s) du th\xe8me par d\xe9faut charg\xe9e(s)"),n.length>0&&wo.GeoLeaf&&wo.GeoLeaf._GeoJSONLayerManager&&wo.GeoLeaf._GeoJSONLayerManager.registerWithLayerManager(),0!=a.fitBoundsOnLoad&&t.map&&t.layerGroup){const e=t.layerGroup.getBounds();if(e.isValid()){const o={};"number"==typeof a.maxZoomOnFit&&(o.maxZoom=a.maxZoomOnFit),t.map.fitBounds(e,o);const n=function(){t.map.off("moveend",n);try{const t=new CustomEvent("geoleaf:fitbounds:complete",{detail:{bounds:e}});document.dispatchEvent(t)}catch(e){}};t.map.on("moveend",n)}}try{t.map.fire("geoleaf:geojson:layers-loaded",{count:n.length,layers:n.map(e=>({id:e.id,label:e.label}))})}catch(e){}try{document.dispatchEvent(new CustomEvent("geoleaf:layers:initial-loaded",{detail:{count:n.length,deferred:d.length}}))}catch(e){}return d.length>0&&l._loadLayersInIdle(d).then(e=>{const n=e.filter(Boolean);o.info("[GeoLeaf.GeoJSON] Phase 2 : "+n.length+" couche(s) diff\xe9r\xe9e(s) charg\xe9e(s) en arri\xe8re-plan"),n.length>0&&wo.GeoLeaf&&wo.GeoLeaf._GeoJSONLayerManager&&wo.GeoLeaf._GeoJSONLayerManager.registerWithLayerManager();try{t.map.fire("geoleaf:geojson:deferred-layers-loaded",{count:n.length,layers:n.map(e=>({id:e.id,label:e.label}))})}catch(e){}}).catch(e=>{o.error("[GeoLeaf.GeoJSON] Erreur chargement couches diff\xe9r\xe9es :",e)}),n})},_loadLayersByBatch:async function(e,t=3,o=200){const n=[];for(let r=0;r<e.length;r+=t){const i=e.slice(r,r+t),a=Date.now(),l=await Promise.all(i.map(e=>e()));n.push(...l);const s=Date.now()-a;W().info(`[GeoLeaf.GeoJSON] Lot ${Math.floor(r/t)+1}/${Math.ceil(e.length/t)} charg\xe9 en ${s} ms`),r+t<e.length&&o>0&&await new Promise(e=>setTimeout(e,o))}return n},_getDefaultThemeLayerIds:function(e){try{if(!e||!e.themes)return new Set;const t=e.themes,o=t.config&&t.config.defautTheme||t.defaultTheme||null;if(!o||!Array.isArray(t.themes))return new Set;const n=t.themes.find(e=>e.id===o);return n&&Array.isArray(n.layers)?new Set(n.layers.filter(e=>0!=e.visible).map(e=>e.id)):new Set}catch(e){return new Set}},_loadLayersInIdle:function(e,t=2){return W(),new Promise(o=>{const n=[];let r=0;const i="function"==typeof requestIdleCallback?e=>requestIdleCallback(e,{timeout:3e3}):e=>setTimeout(e,60),a=()=>{r>=e.length?o(n):i(async()=>{const o=e.slice(r,r+t),i=await Promise.all(o.map(e=>e()));n.push(...i),Math.floor(r/t),Math.ceil(e.length/t),n.length,e.length,r+=t,a()})};a()})},loadAllLayersConfigsForLayerManager:async function(e){const t=W();if(!e||!e.layers||!Array.isArray(e.layers))return t.warn("[GeoLeaf.GeoJSON] loadAllLayersConfigsForLayerManager: Pas de couches dans le profil"),[];t.info(`[GeoLeaf.GeoJSON] Pr\xe9paration de ${e.layers.length} configurations de couches pour LayerManager...`);const o=e.layers.map(e=>{let t=null,o=null;return e.config&&e.config.styles?t=e.config.styles:e.styles&&(t=e.styles),e.config&&e.config.labels?o=e.config.labels:e.labels&&(o=e.labels),{id:e.id,label:e.label,layerManagerId:e.layerManagerId||"geojson-default",configFile:e.configFile,zIndex:e.config&&e.config.zIndex||0,themes:e.config&&e.config.themes||null,styles:t,labels:o}});return t.info(`[GeoLeaf.GeoJSON] ${o.length} configurations pr\xeates pour LayerManager`),wo.GeoLeaf._allLayerConfigs=o,o}},Io="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{};function So(e){if(!e)return 0;const t=e.defaultStyle||e.style||{};if(t.hatch&&t.hatch.enabled)return 1;if(t.casing&&t.casing.enabled)return 1;const o=Array.isArray(e.styleRules)?e.styleRules:[];for(const e of o){const t=e.style||{};if(t.hatch&&t.hatch.enabled)return 1;if(t.casing&&t.casing.enabled)return 1}return 0}const Eo={};function Ao(e,t,o){o=o||200;var n=t.length;if(n<=o)return e.addData({type:"FeatureCollection",features:t}),Promise.resolve();W();var r="function"==typeof requestIdleCallback?requestIdleCallback:function(e){return setTimeout(e,4)};return new Promise(function(i){var a=0;r(function l(){var s=Math.min(a+o,n),c=t.slice(a,s);e.addData({type:"FeatureCollection",features:c}),(a=s)<n?r(l):i()})})}Eo._loadSingleLayer=function(e,t,o,n){const r=Gt.state,i=W(),a=Io.GeoLeaf&&Io.GeoLeaf._VectorTiles;if(a&&a.shouldUseVectorTiles(o))return i.info(`[GeoLeaf.GeoJSON] \u2b21 Layer "${e}" \u2192 vector tiles (Sprint 8)`),a.loadVectorTileLayer(e,t,o,n);const l=!!o._cachedData,s="gpx"===o.type||o.url&&o.url.endsWith(".gpx"),c=Io.GeoLeaf&&Io.GeoLeaf._WorkerManager,u=!l&&c&&c.isAvailable();return(l?Promise.resolve(o._cachedData):u?s?c.fetchText(o.url,e):c.fetchGeoJSON(o.url,e):fetch(o.url).then(e=>{if(!e.ok)throw new Error("HTTP "+e.status+" pour "+o.url);return s?e.text():e.json()})).then(async a=>{l&&delete o._cachedData;const c=Io.GeoLeaf&&Io.GeoLeaf._DataConverter;let u;s?"string"==typeof a?u=c&&"function"==typeof c.convertGpxToGeoJSON?c.convertGpxToGeoJSON(a):{type:"FeatureCollection",features:[]}:(i.warn("[GeoLeaf.GeoJSON._loadSingleLayer] GPX n'est pas un string",e),u={type:"FeatureCollection",features:[]}):u=c?c.autoConvert(a):a,o.type,u.features&&u.features.length;const d=Gt.PaneHelpers,f=Gt.PANE_CONFIG;let p=null;if(o.styles&&o.styles.default)try{if(p=await Io.GeoLeaf._GeoJSONLayerConfig.loadDefaultStyle(e,o),p){const e=p.defaultStyle||p.style;e&&(o.style=Object.assign({},o.style||{},e)),Array.isArray(p.styleRules)&&p.styleRules.length&&(o.styleRules=p.styleRules)}}catch(o){i.warn("[GeoLeaf.GeoJSON] \xc9chec pr\xe9-chargement style pour:",e,o.message),Io.GeoLeaf&&Io.GeoLeaf.Notifications&&"function"==typeof Io.GeoLeaf.Notifications.warning&&Io.GeoLeaf.Notifications.warning(`Style par d\xe9faut introuvable pour \xab ${t} \xbb. Affichage avec style neutre.`)}const g=Io.GeoLeaf._GeoJSONLayerConfig.buildLayerOptions(o,n);g.pane=d.getOrCreatePane?d.getOrCreatePane(o.zIndex,r.map):d.getPaneName(o.zIndex);const h=1==o.interactiveShape,y="polygon"===o.geometry||"polyline"===o.geometry||"line"===o.geometry;(So(p)||h&&y)&&Io.L&&Io.L.svg&&(g.renderer=Io.L.svg({pane:g.pane}),So(p)),h&&(g.interactive=1);const m=Array.isArray(u.features)?u.features:[],b=Io.L.geoJSON(null,g),_=Io.GeoLeaf&&Io.GeoLeaf._GeoJSONClustering,v=_?_.getClusteringStrategy(o,u):{shouldCluster:0,useSharedCluster:0};o.clustering&&"object"==typeof o.clustering&&("number"!=typeof o.clusterRadius&&"number"==typeof o.clustering.maxClusterRadius&&(o.clusterRadius=o.clustering.maxClusterRadius),"number"!=typeof o.disableClusteringAtZoom&&"number"==typeof o.clustering.disableClusteringAtZoom&&(o.disableClusteringAtZoom=o.clustering.disableClusteringAtZoom)),v.shouldCluster||So(p)?await Ao(b,m,200):Ao(b,m,200);let w=null,C=0;if(v.shouldCluster)if(v.useSharedCluster){i.info("[GeoLeaf.GeoJSON] \u{1f504} Tentative r\xe9cup\xe9ration cluster POI partag\xe9 pour:",e);let n=_?_.getSharedPOICluster():null;if(!n){const a={id:e,label:t,layer:b,visible:1,config:o,clusterGroup:null,useSharedCluster:0,pendingSharedCluster:1};return r.layers.set(e,a),setTimeout(()=>{if(n=_?_.getSharedPOICluster():null,n)n.addLayer(b),a.clusterGroup=n,a.useSharedCluster=1,a.pendingSharedCluster=0;else if(i.warn("[GeoLeaf.GeoJSON] Cluster POI toujours non disponible, cr\xe9ation cluster ind\xe9pendant :",e),Io.L&&Io.L.markerClusterGroup){const e=Io.L.markerClusterGroup({maxClusterRadius:o.clusterRadius||80,disableClusteringAtZoom:o.disableClusteringAtZoom||18,animate:0,showCoverageOnHover:0});e.on("layeradd",function(e){d.applyPaneToLayer(e.layer,o.zIndex||0)}),e.addLayer(b),a.clusterGroup=e,a.useSharedCluster=0,a.pendingSharedCluster=0,a.visible&&r.map.addLayer(e)}},500),{id:e,label:t,featureCount:m.length}}w=n,w.addLayer(b),C=1,i.info("[GeoLeaf.GeoJSON] \u2705 Couche ajout\xe9e au cluster POI partag\xe9 (strat\xe9gie: unified) :",e)}else Io.L&&Io.L.markerClusterGroup&&(w=Io.L.markerClusterGroup({maxClusterRadius:o.clusterRadius||80,disableClusteringAtZoom:o.disableClusteringAtZoom||18,animate:0,spiderfyOnMaxZoom:0,showCoverageOnHover:0,zoomToBoundsOnClick:1}),d.getPaneName(o.zIndex),w.on("layeradd",function(e){d.applyPaneToLayer(e.layer,o.zIndex||0)}),w.addLayer(b));const I=Io.GeoLeaf._GeoJSONLayerConfig.inferGeometryType(o,u);let S=o.zIndex;if("number"!=typeof S){const e=Array.from(r.layers.keys());S=Math.max(f.MIN_LAYER_ZINDEX,f.MAX_LAYER_ZINDEX-e.length)}else{const t=d.validateZIndex(S);t!==o.zIndex&&i.warn(`[GeoLeaf.GeoJSON] zIndex ${o.zIndex} clamped to ${t} pour ${e}`),S=t}o.zIndex=S;const E=Io.GeoLeaf&&Io.GeoLeaf.Config,A=E&&E.get?E.get("data"):null,P=`${A&&A.profilesBasePath||"profiles"}/${o._profileId}/${o._layerDirectory}`,G={id:e,label:t,layer:b,visible:1,config:o,clusterGroup:w,legendsConfig:o.legends,basePath:P,useSharedCluster:C,features:m,geometryType:o.geometryType||I,_visibility:{current:0,logicalState:0,source:"system",userOverride:0,themeOverride:0,themeDesired:null,zoomConstrained:0}};if(r.layers.set(e,G),Io.GeoLeaf&&Io.GeoLeaf.ThemeCache&&"function"==typeof Io.GeoLeaf.ThemeCache.store){const t=o._profileId||(Io.GeoLeaf.Config&&Io.GeoLeaf.Config.getActiveProfileId?Io.GeoLeaf.Config.getActiveProfileId():null);Io.GeoLeaf.ThemeCache.store(e,t,u,{contentLength:o.contentLength})}if(Io.GeoLeaf&&Io.GeoLeaf._GeoJSONLayerManager&&Io.GeoLeaf._GeoJSONLayerManager.updateLayerVisibilityByZoom(),G.visible=0,o.fitBoundsOnLoad&&(!Io.GeoLeaf||!Io.GeoLeaf.ThemeSelector)&&b.getBounds().isValid()){const e={};"number"==typeof o.maxZoomOnFit&&(e.maxZoom=o.maxZoomOnFit),r.map.fitBounds(b.getBounds(),e)}if(p){const t=r.layers.get(e);t&&(t.currentStyle=p),So(p)&&Io.GeoLeaf&&Io.GeoLeaf._GeoJSONLayerManager&&Io.GeoLeaf._GeoJSONLayerManager.setLayerStyle(e,p),Io.GeoLeaf&&Io.GeoLeaf.Labels&&"function"==typeof Io.GeoLeaf.Labels.initializeLayerLabels&&Io.GeoLeaf.Labels.initializeLayerLabels(e),Io.GeoLeaf&&Io.GeoLeaf._LabelButtonManager&&Io.GeoLeaf._LabelButtonManager.syncImmediate(e)}else o.labels&&o.labels.enabled&&Io.GeoLeaf&&Io.GeoLeaf.Labels&&"function"==typeof Io.GeoLeaf.Labels.initializeLayerLabels&&Io.GeoLeaf.Labels.initializeLayerLabels(e),Io.GeoLeaf&&Io.GeoLeaf._LabelButtonManager&&Io.GeoLeaf._LabelButtonManager.syncImmediate(e);return m.length,{id:e,label:t,featureCount:m.length}})};const Po="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{},Go=()=>Gt.state,To=()=>Po.GeoLeaf&&Po.GeoLeaf._GeoJSONLayerManager,xo=()=>Po.GeoLeaf&&Po.GeoLeaf._GeoJSONLoader,Oo={get _map(){return Go()?Go().map:null},get _layerGroup(){return Go()?Go().layerGroup:null},get _geoJsonLayer(){return Go()?Go().geoJsonLayer:null},get _layers(){return Go()?Go().layers:new Map},get _options(){return Go()?Go().options:{}},_validateOptions:e=>(e.map&&"function"!=typeof e.map.addLayer&&d.warn("[GeoLeaf.GeoJSON] options.map ne semble pas \xeatre une carte Leaflet valide."),e.defaultStyle&&"object"!=typeof e.defaultStyle&&(d.warn("[GeoLeaf.GeoJSON] options.defaultStyle doit \xeatre un objet."),delete e.defaultStyle),e.onEachFeature&&"function"!=typeof e.onEachFeature&&(d.warn("[GeoLeaf.GeoJSON] options.onEachFeature doit \xeatre une fonction."),delete e.onEachFeature),e.pointToLayer&&"function"!=typeof e.pointToLayer&&(d.warn("[GeoLeaf.GeoJSON] options.pointToLayer doit \xeatre une fonction."),delete e.pointToLayer),void 0!==e.maxZoomOnFit&&("number"!=typeof e.maxZoomOnFit||e.maxZoomOnFit<1||e.maxZoomOnFit>20)&&(d.warn("[GeoLeaf.GeoJSON] options.maxZoomOnFit doit \xeatre un nombre entre 1 et 20."),e.maxZoomOnFit=Po.GeoLeaf&&Po.GeoLeaf.CONSTANTS?Po.GeoLeaf.CONSTANTS.GEOJSON_MAX_ZOOM_ON_FIT:18),e),init(e={}){const t=Go();if(!t)return d.error("[GeoLeaf.GeoJSON] Module shared.js non charg\xe9."),null;if(e=this._validateOptions(e),void 0===Po.L||!Po.L||"function"!=typeof Po.L.geoJSON)return d.error("[GeoLeaf.GeoJSON] Leaflet (L) est requis mais introuvable."),null;const o=Po.GeoLeaf&&Po.GeoLeaf.Utils?Po.GeoLeaf.Utils.ensureMap(e.map):e.map||null;if(!o)return d.error("[GeoLeaf.GeoJSON] Aucune carte Leaflet disponible. Passe une instance de carte dans init({ map })."),null;t.map=o,t.options=Po.GeoLeaf&&Po.GeoLeaf.Utils&&Po.GeoLeaf.Utils.mergeOptions?Po.GeoLeaf.Utils.mergeOptions(t.options,e):Object.assign({},t.options,e);const n=Gt.PANE_CONFIG,r=Gt.PaneHelpers;t.map.createPane(n.BASEMAP_NAME).style.zIndex=n.BASEMAP_ZINDEX;const i=new Set,a=r.getPaneName.bind(r);r.getOrCreatePane=function(e,t){const o=a(e);if(!i.has(o)){const r=t.createPane(o);r.style.zIndex=n.LAYER_BASE_ZINDEX+e,r.style.pointerEvents="none",i.add(o)}return o},r.enablePaneInteraction=function(e,t){const o=a(e),n=t.getPane(o);n&&(n.style.pointerEvents="auto")},d.info(`[GeoLeaf.GeoJSON] Pane basemap cr\xe9\xe9 : ${n.BASEMAP_NAME} (z:${n.BASEMAP_ZINDEX}). Couches GeoJSON: panes cr\xe9\xe9s \xe0 la demande.`),t.layerGroup=Po.L.featureGroup().addTo(t.map),t.layers=new Map;const l=To();l&&t.map.on("zoomend",()=>{l.updateLayerVisibilityByZoom()});const s=Ft?Ft.buildLeafletOptions(t.options):{};return t.geoJsonLayer=Po.L.geoJSON(null,s),t.geoJsonLayer.addTo(t.layerGroup),d.info("[GeoLeaf.GeoJSON] Module initialis\xe9 en mode multi-couches"),t.geoJsonLayer},getLayer(){const e=Go();return e?e.geoJsonLayer:null},getLayerById(e){const t=To();return t?t.getLayerById(e):null},getLayerData(e){const t=To();return t?t.getLayerData(e):null},getAllLayers(){const e=To();return e?e.getAllLayers():[]},showLayer(e){const t=To();t&&t.showLayer(e)},hideLayer(e){const t=To();t&&t.hideLayer(e)},toggleLayer(e){const t=To();t&&t.toggleLayer(e)},removeLayer(e){const t=To();t&&t.removeLayer(e)},updateLayerZIndex(e,t){const o=To();return o?o.updateLayerZIndex(e,t):0},setLayerStyle(e,t){const o=To();return o?o.setLayerStyle(e,t):0},loadUrl(e,t={}){const o=xo();return o?o.loadUrl(e,t):Promise.resolve(null)},addData(e,t={}){const o=xo();o&&o.addData(e,t)},loadFromActiveProfile(e={}){const t=xo();return t?t.loadFromActiveProfile(e):Promise.resolve([])},filterFeatures(e,t={}){const o=Go();if("function"!=typeof e)return d.warn("[GeoLeaf.GeoJSON] filterFeatures: filterFn doit \xeatre une fonction"),{filtered:0,total:0,visible:0};const n={filtered:0,total:0,visible:0};let r=[];if(r=t.layerIds?Array.isArray(t.layerIds)?t.layerIds:[t.layerIds]:Array.from(o.layers.keys()),t.geometryType){const e=t.geometryType.toLowerCase(),n={poi:"point",route:"line",linestring:"line",area:"polygon"},i=n[e]||e;r=r.filter(e=>{const t=o.layers.get(e);if(!t)return 0;const r=(t.geometryType||"").toLowerCase();return(n[r]||r)===i})}return r.forEach(t=>{const r=o.layers.get(t);if(!r||!r.layer)return;const i=0==r.config?.search?.enabled;r._filteredOutLayers||(r._filteredOutLayers=new Set);const a=[],l=[];r.layer.eachLayer(o=>{o.feature&&(n.total++,i||e(o.feature,t)?(a.push(o),n.visible++):(l.push(o),n.filtered++))});const s=r.clusterGroup;l.forEach(e=>{if(e._geoleafFiltered=1,s)r._filteredOutLayers.has(e)||(s.removeLayer(e),r._filteredOutLayers.add(e));else if(e.getElement){const t=e.getElement();t&&(t.style.display="none")}else e.setStyle&&(void 0===e.options._originalOpacity&&(e.options._originalOpacity=e.options.opacity,e.options._originalFillOpacity=e.options.fillOpacity),e.setStyle({opacity:0,fillOpacity:0}))}),a.forEach(e=>{if(e._geoleafFiltered=0,s)r._filteredOutLayers.has(e)&&(s.addLayer(e),r._filteredOutLayers.delete(e));else if(e.getElement){const t=e.getElement();t&&(t.style.display="")}else e.setStyle&&e.setStyle({opacity:void 0!==e.options._originalOpacity?e.options._originalOpacity:1,fillOpacity:void 0!==e.options._originalFillOpacity?e.options._originalFillOpacity:.4})})}),n.visible,n.total,n},clearFeatureFilter(e={}){return this.filterFeatures(()=>1,e)},getFeatures(e={}){const t=Go();if(!t)return[];const o=Array.isArray(e.geometryTypes)?new Set(e.geometryTypes.map(e=>e.toLowerCase())):null,n=Array.isArray(e.layerIds)?new Set(e.layerIds):null,r=[];return t.layers.forEach((e,t)=>{if(n&&!n.has(t))return;const i=(e.geometryType||"").toLowerCase();o&&!o.has(i)||(e.features||[]).forEach(e=>{e&&"object"==typeof e&&(e._layerId=t,r.push(e))})}),r},clear(){const e=Go();e&&e.geoJsonLayer&&e.geoJsonLayer.clearLayers()},_updateLayerVisibilityByZoom(){const e=To();e&&e.updateLayerVisibilityByZoom()},_registerWithLayerManager(){const e=To();e&&e.registerWithLayerManager()},_convertFeatureToPOI(e,t){const o=Po.GeoLeaf&&Po.GeoLeaf._GeoJSONPopupTooltip;return o?o.convertFeatureToPOI(e,t):null},_getClusteringStrategy:(e,t)=>xt?xt.getClusteringStrategy(e,t):{shouldCluster:0,useSharedCluster:0},_getSharedPOICluster:()=>xt?xt.getSharedPOICluster():null,_getPoiConfig:()=>xt?xt.getPoiConfig():{},_detectLayerType(e){const t=To();return t?t.detectLayerType(e):"mixed"},_buildLeafletOptions:e=>Ft?Ft.buildLeafletOptions(e):{}};Po.GeoLeaf&&!Po.GeoLeaf._StyleRules&&Ft&&(Po.GeoLeaf._StyleRules={evaluate:Ft.evaluateStyleRules,operators:Gt?Gt.STYLE_OPERATORS:{},getNestedValue:Ft.getNestedValue});const Mo=Oo,ko="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{},No={applyRoute:function(e,t,o,n){if(Array.isArray(t)||(t=[]),"function"==typeof o&&o(),!e.routeLayer&&e.layerGroup&&e.map){const t=ko.GeoLeaf.Config.get("ui.interactiveShapes",0),o=Object.assign({},e.options.lineStyle,{interactive:t});e.routeLayer=ko.L.polyline([],o).addTo(e.layerGroup)}if(e.routeLayer&&e.routeLayer.setLatLngs(t),e.options.fitBoundsOnLoad&&t.length>1&&e.map){const t=e.routeLayer.getBounds(),o={};e.options.maxZoomOnFit&&(o.maxZoom=e.options.maxZoomOnFit),e.map.fitBounds(t,o)}"function"==typeof n&&n(t)},addWaypoint:function(e,t,o){if(!e)return;const n=ko.GeoLeaf.Config.get("ui.interactiveShapes",0),r=Object.assign({},o,{interactive:n});ko.L.circleMarker(t,r).addTo(e)},addSegment:function(e,t){if(!e)return;const o=e.getLatLngs();e.setLatLngs([...o,...t])},fireRouteLoadedEvents:function(e,t,o){try{e&&"function"==typeof e.fire&&e.fire("geoleaf:route:loaded",{coords:o,layer:t,source:"geoleaf.route"})}catch(e){d.warn("[GeoLeaf.Route] Impossible d'\xe9mettre l'\xe9v\xe9nement Leaflet geoleaf:route:loaded.",e)}if("undefined"!=typeof document&&"function"==typeof document.dispatchEvent){const n={coords:Array.isArray(o)?o.slice():[],map:e,layer:t,source:"geoleaf.route"};try{if("function"==typeof CustomEvent){const e=new CustomEvent("geoleaf:route:loaded",{detail:n});document.dispatchEvent(e)}else{const e=document.createEvent("CustomEvent");e.initCustomEvent("geoleaf:route:loaded",1,1,n),document.dispatchEvent(e)}}catch(e){d.warn("[GeoLeaf.Route] Impossible d'\xe9mettre le CustomEvent geoleaf:route:loaded.",e)}}}},Fo={loadGeoJSON:function(e,t){if(!e||!e.type)return void d.error("[GeoLeaf.Route] GeoJSON invalide.");let o=[];"Feature"===e.type&&"LineString"===e.geometry.type?o=e.geometry.coordinates.map(e=>[e[1],e[0]]):"LineString"===e.type?o=e.coordinates.map(e=>[e[1],e[0]]):d.warn("[GeoLeaf.Route] Format GeoJSON non g\xe9r\xe9."),"function"==typeof t&&t(o)},extractCoordsFromRouteItem:function(e){if(Array.isArray(e.geometry)&&e.geometry.length>0){if(Array.isArray(e.geometry[0])&&"number"==typeof e.geometry[0][0]&&"number"==typeof e.geometry[0][1])return e.geometry.map(e=>[e[0],e[1]]);if(e.geometry[0]&&"object"==typeof e.geometry[0]&&"LineString"===e.geometry[0].type&&Array.isArray(e.geometry[0].coordinates))return e.geometry[0].coordinates.map(e=>[e[1],e[0]])}if(e.geometry&&"object"==typeof e.geometry&&"LineString"===e.geometry.type&&Array.isArray(e.geometry.coordinates)&&e.geometry.coordinates.length>0)return e.geometry.coordinates.map(e=>[e[1],e[0]]);if(e.geometry&&"object"==typeof e.geometry&&"MultiLineString"===e.geometry.type&&Array.isArray(e.geometry.coordinates)&&e.geometry.coordinates.length>0){const t=e.geometry.coordinates.reduce((e,t)=>Array.isArray(t)&&t.length>0?e.concat(t.map(e=>[e[1],e[0]])):e,[]);if(t.length>0)return t}return[]}},Do="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{},Uo={},Ro={profileId:null,categories:null,icons:null};Uo.addRouteTooltip=function(e,t){const o=t.label||t.name||"Itin\xe9raire";e.bindTooltip(y(o),{sticky:1,className:"gl-route-tooltip"})},Uo.addRoutePopup=function(e,t){const o=Uo.buildRoutePopupContent(t);e.bindPopup(o,{maxWidth:300}),e.on("popupopen",()=>{d.info&&d.info("[Route Popup] Popup opened for route:",t.id),setTimeout(()=>{const e='.gl-poi-popup__link[data-route-id="'+t.id+'"]',o=document.querySelector(e);o&&!o._geoleafClickBound&&(o._geoleafClickBound=1,o.addEventListener("click",e=>{e.preventDefault(),Uo.openRouteSidePanel(t)}))},50)})},Uo.buildRoutePopupContent=function(e){const t=Do.GeoLeaf._ContentBuilder?.Assemblers||null,o=function(){const e=Do.GeoLeaf.Config;if(e&&"function"==typeof e.getActiveProfile){const t=e.getActiveProfile();if(t?.panels?.route?.popup?.detailPopup)return t.panels.route.popup.detailPopup}return null}(),n=function(e){const t=Do.GeoLeaf._Normalizer||null;if(t&&"function"==typeof t.normalizeFromRoute)return t.normalizeFromRoute(e);const o=e.attributes||{};return{id:e.id,sourceType:"route",geometryType:"LineString",title:e.label||e.name||"Itin\xe9raire",description:o.description||e.description||"",lat:null,lng:null,categoryId:o.categoryId||null,subCategoryId:o.subCategoryId||null,attributes:{...o,label:e.label||e.name,photo:o.photo,distance_km:o.distance_km,duration_min:o.duration_min,difficulty:o.difficulty,tags:o.tags},rawData:e}}(e);return t&&"function"==typeof t.buildPopupHTML&&o?t.buildPopupHTML(n,o,{resolveCategoryDisplay:null}):function(e){const t=e.attributes||{},o=y(e.label||e.name||"Itin\xe9raire"),n=y(t.description||e.description||""),r=t.photo||e.photo||null,i=y(String(e.id||"")),a=t.categoryId||null,l=t.subCategoryId||null,s=function(){const e=Do.GeoLeaf.Config;if(!e||"function"!=typeof e.getActiveProfile)return{categories:{},icons:{}};const t=e.getActiveProfile()||{},o=t.id||null;return Ro.profileId!==o&&(Ro.profileId=o,Ro.categories=t?.taxonomy?.categories||{},Ro.icons=t?.icons||{}),Ro}(),c=s.categories,u=s.icons,d=a?c[a]:null,f=d&&l?d.subcategories?.[l]:null,p=f?.icon||d?.icon||u.defaultIcon||"activity-generic";let g="";g='<svg class="gl-poi-popup__icon" aria-hidden="true" focusable="false" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="'+(f?.colorFill||d?.colorFill||"#666666")+'" stroke="'+(f?.colorStroke||d?.colorStroke||"#222222")+'" stroke-width="1.5"/><svg x="4" y="4" width="16" height="16"><use href="#'+((u.symbolPrefix||"gl-poi-cat-")+String(p).trim().toLowerCase().replace(/\s+/g,"-"))+'" style="color: #ffffff"/></svg></svg>';let h="";const m=[];if(t.distance_km&&m.push("\u{1f4cf} "+t.distance_km+" km"),t.duration_min&&m.push("\u23f1\ufe0f "+t.duration_min+" min"),t.difficulty){const e={easy:"Facile",medium:"Moyen",hard:"Difficile"};m.push("\u26a1 "+(e[t.difficulty]||t.difficulty))}m.length>0&&(h='<p class="gl-poi-popup__meta-text">'+m.join(" \u2022 ")+"</p>");const b=[];return Array.isArray(t.tags)&&t.tags.forEach(e=>{e&&"string"==typeof e&&b.push('<span class="gl-poi-badge gl-poi-badge--tag">'+y(e)+"</span>")}),'<div class="gl-poi-popup">'+(r?'<div class="gl-poi-popup__photo"><img src="'+r+'" alt="'+o+'" /></div>':"")+'<div class="gl-poi-popup__body"><div class="gl-poi-popup__title-wrapper"><h3 class="gl-poi-popup__title">'+g+'<span class="gl-poi-popup__title-text">'+o+"</span></h3></div>"+(n?'<p class="gl-poi-popup__desc">'+n+"</p>":"")+h+(b.length?'<div class="gl-poi-popup__badges">'+b.join("")+"</div>":"")+'<a class="gl-poi-popup__link" href="#" data-route-id="'+i+'">Voir plus >>></a></div></div>'}(e)},Uo.openRouteSidePanel=function(e){if(!Do.GeoLeaf.POI||"function"!=typeof Do.GeoLeaf.POI.openSidePanelWithLayout)return void(d.warn&&d.warn("[Route Popup] Cannot open side panel: POI.openSidePanelWithLayout not available"));const t=e.attributes||{},o=function(){const e=Do.GeoLeaf.Config;if(e&&"function"==typeof e.getActiveProfile){const t=e.getActiveProfile();if(t?.panels?.route?.layout)return t.panels.route.layout}return null}(),n=[];if(t.distance_km&&n.push("\u{1f4cf} Distance : "+t.distance_km+" km"),t.duration_min&&n.push("\u23f1\ufe0f Dur\xe9e : "+t.duration_min+" minutes"),t.difficulty){const e={easy:"Facile",medium:"Moyen",hard:"Difficile"};n.push("\u26a1 Difficult\xe9 : "+(e[t.difficulty]||t.difficulty))}const r={id:e.id,label:e.label||e.name,title:e.label||e.name,name:e.label||e.name,description:t.description||e.description,attributes:{...t,metadata:n.length>0?n:null,photo:t.photo,mainImage:t.photo,description:t.description,shortDescription:t.description,description_long:t.description_long,longDescription:t.description_long,categoryId:t.categoryId,subCategoryId:t.subCategoryId,difficulty:t.difficulty,distance_km:t.distance_km,duration_min:t.duration_min,tags:t.tags,link:t.link}};Do.GeoLeaf.POI.openSidePanelWithLayout(r,o)};const jo={getRouteColor:function(e,t,o){if(!e||!e.attributes)return o?.color||null;const n=e.attributes,r=n.categoryId,i=n.subCategoryId,a=t?.taxonomy?.categories||{};if(r&&i){const e=a[r];if(e&&e.subcategories){const t=e.subcategories[i];if(t&&t.colorRoute)return t.colorRoute}}if(r){const e=a[r];if(e&&e.colorRoute)return e.colorRoute}return o?.color||null},resolveRouteStyle:function(e,t,o,n){const r=Object.assign({},n||{});o&&"object"==typeof o&&Object.assign(r,o);const i=jo.getRouteColor(e,t,o);if(i&&(r.color=i),e.properties&&"object"==typeof e.properties){const t=e.properties;"string"==typeof t.color&&""!==t.color.trim()&&(r.color=t.color.trim()),"number"==typeof t.weight&&(r.weight=t.weight),"number"==typeof t.opacity&&(r.opacity=t.opacity),"string"==typeof t.dashArray&&""!==t.dashArray.trim()&&(r.dashArray=t.dashArray.trim())}return r},resolveEndpointConfig:function(e,t,o){const n=o||{},r=n.startWaypointStyle||n.waypointStyle||{radius:6,color:"#ffffff",fillColor:"#2b7cff",fillOpacity:1,weight:2},i=n.endWaypointStyle||n.waypointStyle||{radius:6,color:"#ffffff",fillColor:"#ff7b32",fillOpacity:1,weight:2},a={showStart:"boolean"==typeof n.showStart?n.showStart:1,showEnd:"boolean"==typeof n.showEnd?n.showEnd:1,startStyle:Object.assign({},r),endStyle:Object.assign({},i)};if(t&&"object"==typeof t&&("boolean"==typeof t.showStart&&(a.showStart=t.showStart),"boolean"==typeof t.showEnd&&(a.showEnd=t.showEnd),t.start&&"object"==typeof t.start&&Object.assign(a.startStyle,t.start),t.end&&"object"==typeof t.end&&Object.assign(a.endStyle,t.end)),e&&e.properties&&"object"==typeof e.properties){const t=e.properties;"boolean"==typeof t.showStart&&(a.showStart=t.showStart),"boolean"==typeof t.showEnd&&(a.showEnd=t.showEnd),t.startStyle&&"object"==typeof t.startStyle&&Object.assign(a.startStyle,t.startStyle),t.endStyle&&"object"==typeof t.endStyle&&Object.assign(a.endStyle,t.endStyle)}return a}},$o="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{};$o.GeoLeaf=$o.GeoLeaf||{};const Bo=Object.assign({},io,co,go,mo),zo=Object.assign({},bo,vo,Co,Eo);zo._resolveDataFilePath=eo.resolveDataFilePath.bind(eo),$o.GeoLeaf._GeoJSONShared=Gt,$o.GeoLeaf._GeoJSONClustering=xt,$o.GeoLeaf._GeoJSONFeatureValidator=Ot,$o.GeoLeaf._StyleUtils={normalizeStyleToLeaflet:kt},$o.GeoLeaf._GeoJSONStyleResolver=Ft,$o.GeoLeaf._StyleRules={evaluate:Ft.evaluateStyleRules,operators:Gt.STYLE_OPERATORS,getNestedValue:Ft.getNestedValue},$o.GeoLeaf._VectorTiles=Rt,$o.GeoLeaf._LayerVisibilityManager=Bt,$o.GeoLeaf._WorkerManager=Qt,$o.GeoLeaf._GeoJSONLayerConfig=eo,$o.GeoLeaf._GeoJSONPopupTooltip=oo,$o.GeoLeaf._GeoJSONLayerManager=Bo,$o.GeoLeaf._GeoJSONLoader=zo,$o.GeoLeaf.GeoJSON=Mo,$o.GeoLeaf._RouteLayerManager=No,$o.GeoLeaf._RouteLoaders=Fo,$o.GeoLeaf._RoutePopupBuilder=Uo,$o.GeoLeaf._RouteStyleResolver=jo;const Vo={createAccordion(e,t){const o=globalThis.L.DomUtil.create("div","gl-legend__accordion",e);o.setAttribute("data-layer-id",t.layerId),t.collapsed&&o.classList.add("gl-legend__accordion--collapsed"),0==t.visible&&o.classList.add("gl-legend__accordion--inactive");const n=globalThis.L.DomUtil.create("div","gl-legend__accordion-header",o);n.setAttribute("role","button"),n.setAttribute("tabindex","0"),n.setAttribute("aria-expanded",!t.collapsed),globalThis.L.DomUtil.create("span","gl-legend__accordion-title",n).textContent=t.label;const r=globalThis.L.DomUtil.create("button","gl-legend__accordion-toggle",n);r.type="button",r.setAttribute("aria-label","Basculer l'accord\xe9on"),r.textContent=t.collapsed?"\u25b6":"\u25bc";const i=globalThis.L.DomUtil.create("div","gl-legend__accordion-body",o);return this.attachEventHandler(n,"click",e=>{if(0==t.visible)return globalThis.L&&globalThis.L.DomEvent&&globalThis.L.DomEvent.stopPropagation(e),void e.preventDefault();globalThis.L&&globalThis.L.DomEvent&&globalThis.L.DomEvent.stopPropagation(e),e.preventDefault();const i=o.classList.toggle("gl-legend__accordion--collapsed");r.textContent=i?"\u25b6":"\u25bc",n.setAttribute("aria-expanded",!i),"function"==typeof t.onToggle&&t.onToggle(t.layerId,!i)}),{accordionEl:o,headerEl:n,bodyEl:i,toggleEl:r}},renderCircleSymbol(e,t){const o=globalThis.L.DomUtil.create("div","gl-legend__circle",e),n=2*(void 0!==t.radius?t.radius:24),r=t.fillColor||t.color||"#3388ff",i=t.color||t.borderColor||"rgba(0,0,0,0.2)",a=t.weight||1;if(o.style.width=n+"px",o.style.height=n+"px",o.style.backgroundColor=r,o.style.borderRadius="50%",o.style.border=a+"px solid "+i,o.style.position="relative",o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="center",void 0!==t.fillOpacity&&(o.style.opacity=t.fillOpacity),t.icon){const e=t.icon.startsWith("#")?t.icon.substring(1):t.icon;if(!/^[a-zA-Z0-9_-]+$/.test(e))return d&&d.error("[UIComponents] ID d'ic\xf4ne invalide (caract\xe8res non autoris\xe9s):",t.icon),o;const r=document.createElementNS("http://www.w3.org/2000/svg","svg");r.setAttribute("viewBox","0 0 24 24"),r.style.width=.85*n+"px",r.style.height=.85*n+"px",r.style.fill=t.iconColor||"currentColor",r.style.stroke=t.iconColor||"currentColor",r.style.color="#ffffff",r.style.pointerEvents="none",r.style.position="absolute";const i=document.createElementNS("http://www.w3.org/2000/svg","use"),a="#"+e;if(i.setAttribute("href",a),r.appendChild(i),o.appendChild(r),d){const e=document.querySelector('svg[data-geoleaf-sprite="profile"]');if(e){const o=t.icon.startsWith("#")?t.icon.substring(1):t.icon;e.querySelector("#"+o)||(r.setAttribute("data-symbol-missing",t.icon),d.warn("[UIComponents] Symbole",t.icon,"non trouv\xe9 dans le sprite SVG"))}else r.setAttribute("data-sprite-missing","true"),d.warn("[UIComponents] Ic\xf4ne",t.icon,"r\xe9f\xe9renc\xe9e mais sprite non trouv\xe9 dans le DOM")}}return o},renderLineSymbol(e,t){const o=t.width||3,n=t.color||"#3388ff";let r=t.style||"solid";const i=t.dashArray||null,a=t.outlineColor||null,l=t.outlineWidth||null;if(i||o>5||a&&l){const s=document.createElementNS("http://www.w3.org/2000/svg","svg");s.setAttribute("viewBox","0 0 40 8"),s.style.width="40px";const c=Math.max(o,3)+(l||0)+4;if(s.style.height=c+"px",a&&l){const e=document.createElementNS("http://www.w3.org/2000/svg","line");e.setAttribute("x1","0"),e.setAttribute("y1","4"),e.setAttribute("x2","40"),e.setAttribute("y2","4"),e.setAttribute("stroke",a),e.setAttribute("stroke-width",o+2*l),e.setAttribute("stroke-linecap","round"),void 0!==t.outlineOpacity&&e.setAttribute("stroke-opacity",t.outlineOpacity),s.appendChild(e)}const u=document.createElementNS("http://www.w3.org/2000/svg","line");return u.setAttribute("x1","0"),u.setAttribute("y1","4"),u.setAttribute("x2","40"),u.setAttribute("y2","4"),u.setAttribute("stroke",n),u.setAttribute("stroke-width",o),u.setAttribute("stroke-linecap","round"),i?u.setAttribute("stroke-dasharray",i):"dashed"===r?u.setAttribute("stroke-dasharray","8,4"):"dotted"===r&&u.setAttribute("stroke-dasharray","2,3"),void 0!==t.opacity&&u.setAttribute("stroke-opacity",t.opacity),s.appendChild(u),e.appendChild(s),s}const s=globalThis.L.DomUtil.create("div","gl-legend__line",e);return s.style.width="30px",s.style.height=o+"px",s.style.backgroundColor=n,"dashed"===r?(s.style.backgroundImage=`linear-gradient(to right, ${n} 50%, transparent 50%)`,s.style.backgroundSize="8px 100%"):"dotted"===r&&(s.style.backgroundImage=`linear-gradient(to right, ${n} 30%, transparent 30%)`,s.style.backgroundSize="4px 100%"),void 0!==t.opacity&&(s.style.opacity=t.opacity),s},renderPolygonSymbol(e,t){const o=t.fillColor||t.color||"#3388ff",n=t.borderColor||t.color||"#333",r=t.weight||1,i=t.hatch&&t.hatch.enabled;let a=void 0!==t.fillOpacity?t.fillOpacity:void 0!==t.opacity?t.opacity:1;if(i&&"pattern_only"===t.hatch.renderMode&&(a=1),i||0===a){const o=document.createElementNS("http://www.w3.org/2000/svg","svg");if(o.setAttribute("viewBox","0 0 32 24"),o.style.width="32px",o.style.height="24px",i){const e=t.hatch,i=e.type||"diagonal",l=e.spacingPx||10,s=e.stroke&&e.stroke.color||"#000000",c=void 0!==(e.stroke&&e.stroke.opacity)?e.stroke.opacity:1,u=e.stroke&&e.stroke.widthPx||1,d="hatch-legend-"+Date.now()+"-"+Math.random().toString(36).substr(2,9),f=document.createElementNS("http://www.w3.org/2000/svg","defs"),p=document.createElementNS("http://www.w3.org/2000/svg","pattern");if(p.setAttribute("id",d),p.setAttribute("patternUnits","userSpaceOnUse"),p.setAttribute("width",l),p.setAttribute("height",l),"diagonal"===i){const e=document.createElementNS("http://www.w3.org/2000/svg","line");e.setAttribute("x1","0"),e.setAttribute("y1","0"),e.setAttribute("x2",l),e.setAttribute("y2",l),e.setAttribute("stroke",s),e.setAttribute("stroke-width",u),e.setAttribute("stroke-opacity",c),p.appendChild(e)}else if("dot"===i){const e=document.createElementNS("http://www.w3.org/2000/svg","circle");e.setAttribute("cx",l/2),e.setAttribute("cy",l/2),e.setAttribute("r",Math.max(.3,.07*l)),e.setAttribute("fill",s),e.setAttribute("fill-opacity",c),p.appendChild(e)}else if("cross"===i){const e=document.createElementNS("http://www.w3.org/2000/svg","line");e.setAttribute("x1","0"),e.setAttribute("y1",l/2),e.setAttribute("x2",l),e.setAttribute("y2",l/2),e.setAttribute("stroke",s),e.setAttribute("stroke-width",u),e.setAttribute("stroke-opacity",c),p.appendChild(e);const t=document.createElementNS("http://www.w3.org/2000/svg","line");t.setAttribute("x1",l/2),t.setAttribute("y1","0"),t.setAttribute("x2",l/2),t.setAttribute("y2",l),t.setAttribute("stroke",s),t.setAttribute("stroke-width",u),t.setAttribute("stroke-opacity",c),p.appendChild(t)}else if("x"===i){const e=document.createElementNS("http://www.w3.org/2000/svg","line");e.setAttribute("x1","0"),e.setAttribute("y1","0"),e.setAttribute("x2",l),e.setAttribute("y2",l),e.setAttribute("stroke",s),e.setAttribute("stroke-width",u),e.setAttribute("stroke-opacity",c),p.appendChild(e);const t=document.createElementNS("http://www.w3.org/2000/svg","line");t.setAttribute("x1",l),t.setAttribute("y1","0"),t.setAttribute("x2","0"),t.setAttribute("y2",l),t.setAttribute("stroke",s),t.setAttribute("stroke-width",u),t.setAttribute("stroke-opacity",c),p.appendChild(t)}f.appendChild(p),o.appendChild(f);const g=document.createElementNS("http://www.w3.org/2000/svg","rect");g.setAttribute("x","1"),g.setAttribute("y","1"),g.setAttribute("width","30"),g.setAttribute("height","22"),g.setAttribute("fill",`url(#${d})`),g.setAttribute("stroke",n),g.setAttribute("stroke-width",r),1!==a&&g.setAttribute("fill-opacity",a),o.appendChild(g)}else{const e=document.createElementNS("http://www.w3.org/2000/svg","rect");e.setAttribute("x","1"),e.setAttribute("y","1"),e.setAttribute("width","30"),e.setAttribute("height","22"),e.setAttribute("fill","none"),e.setAttribute("stroke",n),e.setAttribute("stroke-width",r),t.dashArray&&e.setAttribute("stroke-dasharray",t.dashArray),o.appendChild(e)}return e.appendChild(o),o}const l=globalThis.L.DomUtil.create("div","gl-legend__polygon",e);return l.style.width="24px",l.style.height="16px",l.style.backgroundColor=o,l.style.border=r+"px solid "+n,1!==a&&(l.style.opacity=a),l},renderStarSymbol(e,t){const o=globalThis.L.DomUtil.create("div","gl-legend__stars",e),n=t.count||5,r=t.color||"#f1c40f",i=t.size||12;for(let e=0;e<n;e++){const e=globalThis.L.DomUtil.create("span","gl-legend__star",o);e.textContent="\u2605",e.style.color=r,e.style.fontSize=i+"px"}return o},renderSymbol(e,t){const o=t.symbol||t;switch(o.type||t.type||"circle"){case"marker":case"circle":default:return this.renderCircleSymbol(e,o);case"line":return this.renderLineSymbol(e,o);case"polygon":case"fill":return this.renderPolygonSymbol(e,o);case"star":return this.renderStarSymbol(e,o);case"icon":if(o.iconUrl){const t=globalThis.L.DomUtil.create("img","gl-legend__icon-img",e);return t.src=o.iconUrl,o.size&&(t.style.width=o.size+"px",t.style.height=o.size+"px"),t}return o.icon,this.renderCircleSymbol(e,o)}},createToggleButton(e,t){const o=void 0!==t.isActive?t.isActive:t.active,n=t.className||"gl-toggle-btn",r=globalThis.L.DomUtil.create("button",n,e);if(r.type="button",t.id&&r.setAttribute("data-toggle-id",t.id),r.setAttribute("aria-pressed",o?"true":"false"),t.title&&(r.title=t.title),o&&r.classList.add(n+"--on"),t.label&&(r.textContent=t.label),"function"==typeof t.onToggle){const e=t.className||"gl-toggle-btn",o=o=>{globalThis.L&&globalThis.L.DomEvent&&globalThis.L.DomEvent.stopPropagation(o),o.preventDefault();const n=r.classList.toggle(e+"--on");r.setAttribute("aria-pressed",n?"true":"false"),t.onToggle(t.id,n,o)};this.attachEventHandler(r,"click",o)}return r},attachEventHandler(e,t,o){globalThis.L&&globalThis.L.DomEvent?(globalThis.L.DomEvent.on(e,t,o),"click"===t&&globalThis.L.DomEvent.disableClickPropagation(e)):e.addEventListener(t,o)}},qo={createTooltipsForLayer(e,t,o,n,r){if(!t||!o||!o.labelId)return void(d&&d.warn("[LabelRenderer] Param\xe8tres invalides pour createTooltipsForLayer",{layerId:e,hasLeafletLayer:!!t,hasLabelConfig:!!o,labelId:o?.labelId,labelConfigKeys:o?Object.keys(o):null}));const i=o.labelId;t.eachLayer(e=>{try{this._createTooltipForFeature(e,i,n,r)}catch(e){d&&d.warn("[LabelRenderer] Erreur cr\xe9ation tooltip:",e)}}),d&&r.size},_createTooltipForFeature(e,t,o,n){const r=e.feature;if(!r||!r.properties)return;const i=this._extractFieldValue(r.properties,t);if(!i)return;let a=null;if("function"==typeof e.getLatLng)a=e.getLatLng();else if("function"==typeof e.getBounds){const t=e.getBounds();t&&"function"==typeof t.getCenter?(a=t.getCenter(),d&&d.info("[LabelRenderer] Position polygone calcul\xe9e:",{labelValue:i,position:a,positionType:typeof a,hasLat:"lat"in a,hasLng:"lng"in a,latType:typeof a.lat,lngType:typeof a.lng,positionKeys:Object.keys(a)})):d&&d.warn("[LabelRenderer] getBounds ne retourne pas getCenter pour:",i)}else if("function"==typeof e.getLatLngs){const t=e.getLatLngs();if(t&&t.length>0){const e=Array.isArray(t[0])?t[0]:t;e&&e.length>0&&(a=e[Math.floor(e.length/2)])}}if(!a)return;const l="function"==typeof a.lat?a.lat():a.lat,s="function"==typeof a.lng?a.lng():a.lng;if(!l||!s||isNaN(l)||isNaN(s))return;const c=this._formatLabelContent(i,o),u=globalThis.L.divIcon({html:c,className:this._buildClassName(o),iconSize:null,iconAnchor:[0,0]}),f=globalThis.L.marker([l,s],{icon:u,interactive:0,keyboard:0}),p=z&&z.getMap?z.getMap():null;if(p){f.addTo(p);const e=r.id||r.properties.id||`feature_${Date.now()}_${Math.random()}`;n.set(e,f)}else d&&d.warn("[LabelRenderer] Carte non disponible pour",i)},_extractFieldValue(e,t){if(!e||!t)return null;if(!t.includes("."))return e[t];const o=t.split(".");let n=e;for(const e of o){if(!n||"object"!=typeof n||!(e in n))return null;n=n[e]}return n},_parseOffset:e=>e&&Array.isArray(e)&&2===e.length?["number"==typeof e[0]?e[0]:0,"number"==typeof e[1]?e[1]:0]:[0,0],_buildClassName(e){const t=["gl-label"];return e&&(e.className&&t.push(e.className),e.variant&&t.push(`gl-label--${e.variant}`)),t.join(" ")},_formatLabelContent(e,t){if(!e)return"";let o=String(e);t&&(t.prefix&&(o=t.prefix+o),t.suffix&&(o+=t.suffix));const n=globalThis.document.createElement("div");return n.className="gl-label__content",n.textContent=o,t&&this._applyInlineStyles(n,t),n.outerHTML},_applyInlineStyles(e,t){if(e&&t){if(t.font){if(t.font.family){const o=`"${t.font.family}", -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif`;e.style.setProperty("font-family",o,"important")}if(t.font.sizePt&&e.style.setProperty("font-size",`${t.font.sizePt}pt`,"important"),t.font.bold)e.style.setProperty("font-weight","bold","important");else if(t.font.weight){const o=t.font.weight<400?500:t.font.weight;e.style.setProperty("font-weight",o,"important")}t.font.italic&&e.style.setProperty("font-style","italic","important")}if(t.color&&e.style.setProperty("color",t.color,"important"),void 0!==t.opacity&&e.style.setProperty("opacity",t.opacity,"important"),t.buffer&&t.buffer.enabled){const o=t.buffer.color||"#ffffff",n=void 0!==t.buffer.opacity?t.buffer.opacity:1,r=t.buffer.sizePx||2,i=this._hexToRgba(o,n),a=[];for(let e=0;e<360;e+=30){const t=e*Math.PI/180,o=Math.cos(t)*r,n=Math.sin(t)*r;a.push(`${o.toFixed(2)}px ${n.toFixed(2)}px 0 ${i}`)}for(let e=15;e<360;e+=30){const t=e*Math.PI/180,o=Math.cos(t)*r*.7,n=Math.sin(t)*r*.7;a.push(`${o.toFixed(2)}px ${n.toFixed(2)}px 0 ${i}`)}a.push(`0 0 ${.8*r}px ${i}`),a.push(`0 0 ${1.5*r}px ${i}`),e.style.setProperty("text-shadow",a.join(", "),"important")}t.textTransform&&e.style.setProperty("text-transform",t.textTransform,"important")}},_hexToRgba:(e,t)=>e?(3===(e=e.replace("#","")).length&&(e=e.split("").map(e=>e+e).join("")),`rgba(${parseInt(e.substring(0,2),16)}, ${parseInt(e.substring(2,4),16)}, ${parseInt(e.substring(4,6),16)}, ${t})`):`rgba(0, 0, 0, ${t})`},Jo={isScaleInRange:ze,calculateMapScale:Be},Ho={layers:new Map,zoomListenerAttached:0},Zo={init(e={}){this._attachLayerEvents()},initializeLayerLabels(e){if(!e)return;const t=this._getLayerData(e);return t&&(this._hideLabelsForLayer(e),Ho.layers.delete(e),1==t.currentStyle?.label?.enabled)?1!=t.currentStyle.label.visibleByDefault?this.enableLabels(e,{},0):1==t._visibility?.current?this.enableLabels(e,{},1):this.enableLabels(e,{},0):void 0},async enableLabels(e,t={},o=1){if(e){if(t&&t.styleFile){const o=`\u274c CONFIGURATION OBSOL\xc8TE D\xc9TECT\xc9E\n\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nLa couche "${e}" utilise une r\xe9f\xe9rence obsol\xe8te \xe0 un fichier\nde labels s\xe9par\xe9 via "labelConfig.styleFile".\n\nGeoLeaf ne supporte plus les fichiers de labels s\xe9par\xe9s (styleLabel.json).\nLes labels doivent \xeatre int\xe9gr\xe9s dans les fichiers de style.\n\nValeur d\xe9tect\xe9e: ${t.styleFile}\nCouche: ${e}\n\nAction requise:\n1. Supprimez la propri\xe9t\xe9 "labels.styleFile" de la configuration\n2. Les labels sont maintenant extraits depuis layerData.currentStyle.label\n3. Consultez docs/STYLE_FORMAT_SPEC.md pour la syntaxe\n\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550`;throw console.error(o),new Error(`Configuration obsol\xe8te: labels.styleFile d\xe9tect\xe9 dans la couche ${e}`)}try{const n=this._getLayerData(e);let r=null;if(n&&n.currentStyle&&n.currentStyle.label){const e=n.currentStyle.label;if(1!=e.enabled)return;r=e,n.currentStyle.labelScale&&(r.labelScale=n.currentStyle.labelScale),d&&r.labelScale}else{if(!(t&&t.enabled&&t.labelId))return;r={enabled:1,field:t.labelId,font:t.font||{family:"Arial",sizePt:10,weight:50,bold:0,italic:0},color:t.color||"#000000",opacity:t.opacity||1,buffer:t.buffer||{enabled:0},background:t.background||{enabled:0},offset:t.offset||{distancePx:0}}}const i=void 0!==r.visibleByDefault?r.visibleByDefault:o;Ho.layers.set(e,{enabled:i,config:t,labelStyle:r,tooltips:new Map});let a=i;if(n){const e=n._visibility&&1==n._visibility.current;a=i&&e}a&&await this._createLabelsForLayer(e),this._ensureZoomListener()}catch(e){d&&d.error("[Labels] Erreur pr\xe9paration labels:",e),console.error("[Labels] Stack trace:",e.stack)}}else d&&d.warn("[Labels] enableLabels: layerId manquant")},disableLabels(e){if(!e)return;const t=Ho.layers.get(e);t&&(t.tooltips&&(t.tooltips.forEach(e=>{try{e&&e.remove&&e.remove()}catch(e){}}),t.tooltips.clear()),t.enabled=0)},_hideLabelsForLayer(e){if(!e)return;const t=Ho.layers.get(e);t&&(t.tooltips&&(t.tooltips.forEach(e=>{try{e&&e.remove&&e.remove()}catch(e){}}),t.tooltips.clear()),d&&t.enabled)},toggleLabels(e){if(!e)return 0;const t=Ho.layers.get(e);if(!t)return 0;const o=this._getLayerData(e);return 1==o?.currentStyle?.label?.enabled?t.enabled?(this._hideLabelsForLayer(e),t.enabled=0,0):(t.enabled=1,this.refreshLabels(e),1):0},hasLabelConfig:e=>Ho.layers.has(e),areLabelsEnabled(e){const t=Ho.layers.get(e);return t?t.enabled:0},refreshLabels(e){if(!e)return;const t=Ho.layers.get(e);if(!t||!t.enabled)return;const o=this._getLayerData(e);o&&o._visibility&&o._visibility.current&&(t.tooltips&&(t.tooltips.forEach(e=>{try{e&&e.remove&&e.remove()}catch(e){}}),t.tooltips.clear()),this._createLabelsForLayer(e))},async _createLabelsForLayer(e){const t=Ho.layers.get(e);if(!t||!t.enabled)return;const o=this._getLayerData(e);if(!o||!o._visibility||!o._visibility.current)return;if(!o.layer)return void(d&&d.warn("[Labels] Couche GeoJSON non trouv\xe9e:",e));const{config:n,labelStyle:r}=t,i=z&&z.getMap?z.getMap():null;if(i&&r.labelScale){const{minScale:e,maxScale:t}=r.labelScale;if(null!==e||null!==t){const o=this._calculateMapScale(i);if(d&&this._isScaleInRange(o,e,t),!this._isScaleInRange(o,e,t))return}}else if(i&&void 0!==n.minZoom&&void 0!==n.maxZoom){const e=i.getZoom();if(e<n.minZoom||e>n.maxZoom)return}if(qo){const i={labelId:r.field||n.labelId,minZoom:n.minZoom,maxZoom:n.maxZoom};d&&(i.labelId,o.layer),qo.createTooltipsForLayer(e,o.layer,i,r,t.tooltips),d&&t.tooltips.size}else d&&d.error("[Labels] GeoLeaf._LabelRenderer non disponible!")},_getLayerData:e=>Mo&&"function"==typeof Mo.getLayerById?Mo.getLayerById(e):(d&&d.warn("[Labels] GeoLeaf.GeoJSON non disponible"),null),_ensureZoomListener(){if(Ho.zoomListenerAttached)return;const e=z&&z.getMap?z.getMap():null;e?(e.on("zoomend",()=>{const t=e.getZoom();this._handleZoomChange({zoom:t})}),Ho.zoomListenerAttached=1):d&&d.warn("[Labels] Carte non disponible pour attacher l'\xe9couteur de zoom")},_attachLayerEvents(){"function"==typeof globalThis.addEventListener&&globalThis.addEventListener("geoleaf:layer-loaded",e=>{e.detail&&e.detail.layerId&&this._handleLayerLoaded(e.detail.layerId)})},_handleZoomChange(e){if(!e)return;const t=z&&z.getMap?z.getMap():null;if(!t)return;const o=this._calculateMapScale(t);Ho.layers.forEach((n,r)=>{if(!n.enabled)return;const i=this._getLayerData(r);if(!i||!i._visibility||!i._visibility.current)return void(n.tooltips&&n.tooltips.size>0&&(n.tooltips.forEach(e=>{e&&e.remove&&e.remove()}),n.tooltips.clear()));const{labelStyle:a,config:l}=n;let s=1;if(a&&a.labelScale){const{minScale:e,maxScale:t}=a.labelScale;s=this._isScaleInRange(o,e,t)}else if(void 0!==l.minZoom&&void 0!==l.maxZoom){const o=void 0!==e.zoom?e.zoom:t.getZoom(),n=l.minZoom,r=l.maxZoom;s=o>=n&&o<=r}const c=n.tooltips&&n.tooltips.size>0;s&&!c?this._createLabelsForLayer(r):!s&&c&&(n.tooltips.forEach(e=>{e&&e.remove&&e.remove()}),n.tooltips.clear())})},async _handleLayerLoaded(e){const t=Ho.layers.get(e);t&&t.enabled&&await this._createLabelsForLayer(e)},_getProfileId:()=>F.get("id")||"default",_calculateMapScale:e=>Jo&&"function"==typeof Jo.calculateMapScale?Jo.calculateMapScale(e,{logger:d}):(d&&d.warn("[Labels] ScaleUtils.calculateMapScale unavailable"),0),_isScaleInRange:(e,t,o)=>Jo&&"function"==typeof Jo.isScaleInRange?Jo.isScaleInRange(e,t,o,d):(d&&d.warn("[Labels] ScaleUtils.isScaleInRange unavailable"),1),destroy(){Ho.layers.forEach((e,t)=>{this.disableLabels(t)}),Ho.layers.clear()}},Wo={createButton(e,t){if(!e||!t)return d&&d.warn("[LabelButtonManager] createButton: param\xe8tres manquants",{layerId:e,hasContainer:!!t}),null;const o=t.querySelector(".gl-layer-manager__label-toggle");if(o)return o;const n=globalThis.L.DomUtil.create("button","gl-layer-manager__label-toggle");n.type="button",n.setAttribute("aria-label","Afficher/masquer les \xe9tiquettes"),n.disabled=1,n.classList.add("gl-layer-manager__label-toggle--disabled");const r=document.createElement("span");r.className="gl-layer-manager__label-toggle-icon",r.textContent="\u{1f3f7}\ufe0f",n.appendChild(r),n.title="Afficher/masquer les \xe9tiquettes",Vo.attachEventHandler(n,"click",function(t){if(globalThis.L&&globalThis.L.DomEvent&&globalThis.L.DomEvent.stopPropagation(t),t.preventDefault(),!n.disabled)try{const t=Mo?.getLayerById?.(e);if(1!=t?.currentStyle?.label?.enabled)return void(d&&d.warn("[LabelButtonManager] Impossible d'afficher les labels: le style actuel a label.enabled=false"));Zo?.toggleLabels&&(Zo.toggleLabels(e)?(n.classList.add("gl-layer-manager__label-toggle--on"),n.setAttribute("aria-pressed","true")):(n.classList.remove("gl-layer-manager__label-toggle--on"),n.setAttribute("aria-pressed","false")))}catch(e){d&&d.warn("[LabelButtonManager] Erreur lors du toggle des labels:",e)}});const i=t.querySelector(".gl-layer-manager__item-toggle");return i?t.insertBefore(n,i):t.appendChild(n),n},sync(e){if(!e)return;this._syncTimeouts&&this._syncTimeouts.has(e)&&clearTimeout(this._syncTimeouts.get(e)),this._syncTimeouts||(this._syncTimeouts=new Map);const t=setTimeout(()=>{this._syncTimeouts.delete(e),this._doSync(e)},300);this._syncTimeouts.set(e,t)},_doSync(e){if(!e)return;let t=document.querySelector(`[data-layer-id="${e}"] .gl-layer-manager__label-toggle`);if(!t){const o=document.querySelector(`[data-layer-id="${e}"]`);if(!o)return;const n=o.querySelector(".gl-layer-manager__item-controls");if(!n)return;t=n.querySelector(".gl-layer-manager__label-toggle"),t||(t=this.createButton(e,n))}if(!t)return;const o=this._getState(e);this._applyState(t,o)},_getState(e){const t=Mo?.getLayerById?.(e);return{layerId:e,layerExists:!!t,layerVisible:1==t?._visibility?.current,labelEnabled:1==t?.currentStyle?.label?.enabled,areLabelsActive:Zo?.areLabelsEnabled?.(e)||0}},_applyState(e,t){t.labelEnabled&&t.layerVisible?(e.disabled=0,e.classList.remove("gl-layer-manager__label-toggle--disabled"),t.areLabelsActive&&t.layerVisible?(e.classList.add("gl-layer-manager__label-toggle--on"),e.setAttribute("aria-pressed","true")):(e.classList.remove("gl-layer-manager__label-toggle--on"),e.setAttribute("aria-pressed","false"))):(e.disabled=1,e.classList.add("gl-layer-manager__label-toggle--disabled"),e.classList.remove("gl-layer-manager__label-toggle--on"),e.setAttribute("aria-pressed","false"))},syncImmediate(e){e&&(this._syncTimeouts&&this._syncTimeouts.has(e)&&(clearTimeout(this._syncTimeouts.get(e)),this._syncTimeouts.delete(e)),this._doSync(e))}},Xo=h.POI_MARKER_SIZE||16,Yo=h.POI_MAX_ZOOM||18,Qo={poiLayerGroup:null,poiClusterGroup:null,allPois:[],poiMarkers:new Map,poiConfig:{},mapInstance:null,isLoading:0,sidePanelElement:null,currentPoiInPanel:null,sidePanelOverlay:null,currentGalleryIndex:0},Ko={constants:Object.freeze({POI_MARKER_SIZE:Xo,POI_MAX_ZOOM:Yo,defaultIconUrl:"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSI4IiBmaWxsPSIjNGE5MGU1IiBzdHJva2U9IiNmZmYiIHN0cm9rZS13aWR0aD0iMiIvPjwvc3ZnPg=="}),state:Qo,ensureMapMaxZoom:function(e,t=18){e&&e.options&&("number"!=typeof e.options.maxZoom||isNaN(e.options.maxZoom))&&(e.options.maxZoom=t)},getAllPois:()=>Qo.allPois,getMarkerLayer:()=>Qo.markerLayer||Qo.poiClusterGroup||Qo.poiLayerGroup,getMapInstance:()=>Qo.mapInstance,getPoiMarkers:()=>Qo.poiMarkers},en={normalizePoi:function(e){if(!e)return null;const t=e,o=t&&"object"==typeof t.attributes&&t.attributes?t.attributes:{},n=t.properties||{},r=e=>{if(!e||"string"!=typeof e)return null;const t=e.trim();return t.match(/^(https?:\/\/|data:image\/)/i)?t:null},i=C.escapeHtml||(e=>{if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}),a={id:t.id||null,latlng:t.latlng||null,title:i(H(t,"title","label","name","attributes.title","properties.label","properties.name")||"Sans nom"),label:i(H(t,"label","name","title")),name:i(H(t,"name","label","title")),description:i(H(t,"description","attributes.description")),properties:t.properties||{},attributes:{...o,shortDescription:i(H(t,"description","attributes.shortDescription","properties.description")),longDescription:i(H(t,"attributes.description_long","description_long","properties.description_long","attributes.longDescription")),categoryId:o.categoryId||t.categoryId||t.category||n.category||null,subCategoryId:o.subCategoryId||t.subCategoryId||t.sub_category||n.sub_category||null,mainImage:r(o.photo||o.mainImage||n.photo||o.gallery&&o.gallery[0]||t.gallery&&t.gallery[0]||null),gallery:(o.gallery||t.gallery||n.gallery||t.images||n.images||[]).map(e=>"string"==typeof e?r(e):e&&e.url?r(e.url):null).filter(Boolean),price:o.price||t.price||n.price||null,openingHours:o.opening_hours||o.openingHours||t.opening_hours||n.opening_hours||t.openingHours||n.openingHours||null,openingHoursTable:null,reviews:o.reviews||o.attributes&&o.attributes.reviews||t.reviews||n.reviews||n.attributes&&n.attributes.reviews||null,tags:(o.tags||t.tags||n.tags||[]).map(e=>i(String(e))),website:r(o.link||o.website||t.link||n.link||t.website||n.website||null),address:i(H(t,"attributes.address","address","properties.address")),phone:i(H(t,"attributes.phone","phone","properties.phone")),email:i(H(t,"attributes.email","email","properties.email")),services:(o.services||t.services||n.services||[]).map(e=>i(String(e)))}};return a.attributes.openingHours&&Array.isArray(a.attributes.openingHours)&&(a.attributes.openingHoursTable=a.attributes.openingHours.map(e=>{if(null==e)return null;const t=String(e).trim();if(!t)return null;const o=t.split(":");if(o.length>1){const e=o.shift().trim(),t=o.join(":").trim();let n="",r="";const i=t.split(/[\u2013-]/);return i.length>1?(n=i[0].trim(),r=i.slice(1).join("\u2013").trim()):n=t,{day:e,open:n,close:r}}return{day:t,open:"",close:""}}).filter(Boolean)),e._sidepanelConfig&&(a._sidepanelConfig=e._sidepanelConfig),e._layerConfig&&(a._layerConfig=e._layerConfig),a},getFieldValue:function(e,t){if(!e||!t)return null;d&&"function"==typeof d.debug&&e.id;const o=t.split(".");let n=e;for(const e of o){if(null==n||"object"!=typeof n)return d&&d.debug,null;n=n[e]}return d&&d.debug,void 0===n||""===n||Array.isArray(n)&&0===n.length?(d&&d.debug,null):n},extractCoordinates:function(e){if(!e)return null;let t,o;return Array.isArray(e.latlng)&&e.latlng.length>=2?(t=e.latlng[0],o=e.latlng[1]):e.latlng&&"object"==typeof e.latlng?(t=e.latlng.lat,o=e.latlng.lng||e.latlng.lon):"number"==typeof e.lat&&"number"==typeof e.lng?(t=e.lat,o=e.lng):"number"==typeof e.latitude&&"number"==typeof e.longitude?(t=e.latitude,o=e.longitude):e.geometry&&Array.isArray(e.geometry.coordinates)&&(o=e.geometry.coordinates[0],t=e.geometry.coordinates[1]),"number"!=typeof t||"number"!=typeof o||isNaN(t)||isNaN(o)||t<-90||t>90||o<-180||o>180?null:[t,o]},generatePoiId:function(e){const t=Date.now(),o=Math.floor(1e4*Math.random());return`poi-${(e.title||e.label||e.name||"poi").toLowerCase().replace(/[^a-z0-9]/g,"-").substring(0,20)}-${t}-${o}`}};function tn(){return H}function on(){return y}let nn=null;function rn(e="popup"){const t=nn||("undefined"!=typeof window?window:null);return t?!!{popup:t.__GEOLEAF_DEBUG_POPUP__,tooltip:t.__GEOLEAF_DEBUG_TOOLTIP__,panel:t.__GEOLEAF_DEBUG_PANEL__}[e]:0}function an(e,t={}){const{allowZero:o=1,allowEmptyArray:n=0,allowEmptyString:r=0}=t;return null==e?1:0===e?!o:""===e?!r:Array.isArray(e)&&0===e.length?!n:0}const ln={getResolveField:tn,getEscapeHtml:on,getActiveProfile:X,getLog:W,sortConfigByOrder:function(e){return Array.isArray(e)?[...e].sort(Z):[]},resolveBadgeLabel:function(e,t,o){const n=X(),r=n?.taxonomy;if(!r)return o;const i=e.attributes||{};if(t.includes("subCategoryId")){const e=i.categoryId||i.category,t=r.categories?.[e],n=t?.subcategories?.[o];return n?.label||o}if(t.includes("categoryId")){const e=r.categories?.[o];return e?.label||o}return o},getDefaultTitle:function(e){if(!e)return"Sans titre";const t=tn();return e.title||e.label||e.name||t(e,"attributes.name","attributes.nom","properties.name","properties.nom")||"Sans titre"},isDebugEnabled:rn,debugLog:function(e,t,o){if(!rn(e))return;const n=W();void 0!==o?n.warn(`[ContentBuilder.${e}] ${t}`,o):n.warn(`[ContentBuilder.${e}] ${t}`)},isEmptyValue:an,getValidFieldValue:function(e,t,o={}){const n=tn()(e,t);return an(n,o)?null:n},wrapInDiv:function(e,t){return`<div class="${t}">${e}</div>`},createBadge:function(e,t=""){return`<span class="gl-poi-badge"${t?` style="${t}"`:""}>${on()(e)}</span>`},createImage:function(e,t,o="gl-poi-popup__photo"){const n=on();return`<div class="${o}"><img src="${n(e)}" alt="${n(t)}" loading="lazy" /></div>`},createLink:function(e,t,o={}){const n=on(),{external:r=0,className:i="gl-poi-link"}=o;return`<a href="${n(e)}" class="${i}"${r?' target="_blank" rel="noopener noreferrer"':""}>${n(t)}</a>`},__setDebugWindow:e=>{nn=e}};function sn(){return H}function cn(e){if(null==e||""===e)return null;const t="number"==typeof e?e:parseFloat(e);return isNaN(t)?null:t}function un(e,t){const o=sn()(e,t);if(null==o||""===o)return{displayValue:"",style:""};const n=X(),r=n?.taxonomy;let i=String(o),a="";if(!r||!t)return{displayValue:i,style:a};const l=e.attributes||{};if(t.includes("subCategoryId")){const e=l.categoryId||l.category,t=r.categories?.[e],n=t?.subcategories?.[o];n?.label&&(i=n.label)}else if(t.includes("categoryId")){const e=r.categories?.[o];e?.label&&(i=e.label)}if(Je&&e._layerConfig){const t=Je(e,e._layerConfig.id);t&&(t.fillColor&&(a+="background-color: "+t.fillColor+";"),t.color&&(a+="border-color: "+t.color+";"))}return{displayValue:i,style:a}}const dn={getResolveField:sn,getEscapeHtml:function(){return y},getActiveProfile:X,getLog:W,validateImageUrl:function(e){if(!e||"string"!=typeof e)return null;try{return b(e)}catch(e){return W().warn("[ContentBuilder.Core] URL image invalide:",e.message),null}const t=e.trim();return/^https?:\/\//i.test(t)||/^data:image\//i.test(t)||t.startsWith("/")||t.startsWith("./")||t.startsWith("../")?t:null},validateCoordinates:function(e){if(null==e)return null;let t,o;if(Array.isArray(e)&&e.length>=2)t=parseFloat(e[0]),o=parseFloat(e[1]);else{if("object"!=typeof e||void 0===e.lat||void 0===e.lng)return null;t=parseFloat(e.lat),o=parseFloat(e.lng)}return isNaN(t)||isNaN(o)||t<-90||t>90||o<-180||o>180?null:{lat:t,lng:o}},validateNumber:cn,validateRating:function(e){const t=cn(e);return null===t||t<0||t>5?null:t},resolveBadge:un,resolveBadgeTooltip:function(e,t){return un(e,t).displayValue},formatNumber:function(e){return e.toLocaleString("fr-FR")},formatCoordinates:function(e,t,o=6){return e.toFixed(o)+", "+t.toFixed(o)},formatRating:function(e,t=1){return e.toFixed(t)+"/5"}};function fn(){return H}function pn(){return y}function gn(e,t,o={}){const n=fn(),r=pn(),i=n(e,t.field);if(null==i||""===i)return"";const a=r(String(i)),l=t.variant||"default";if("title"===l){let t="";if(o.includeIcon&&o.resolveCategoryDisplay){const n=o.resolveCategoryDisplay(e);if(n&&n.iconId){const e=F&&"function"==typeof F.getIconsConfig?F.getIconsConfig():null,o=(e&&e.symbolPrefix||"gl-poi-cat-")+String(n.iconId).trim().toLowerCase().replace(/\s+/g,"-");t='<svg class="gl-poi-popup__icon" aria-hidden="true" focusable="false" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="'+(n.colorFill||"#666")+'" stroke="'+(n.colorStroke||"#222")+'" stroke-width="1.5"/><svg x="4" y="4" width="16" height="16" viewBox="0 0 32 32"><use href="#'+o+'" style="color: #ffffff"/></svg></svg>'}}return'<h3 class="gl-poi-popup__title">'+t+'<span class="gl-poi-popup__title-text">'+a+"</span></h3>"}return"short"===l?'<p class="gl-poi-popup__desc">'+a+"</p>":"long"===l||"paragraph"===l?'<p class="gl-poi-popup__desc gl-poi-popup__desc--long">'+a+"</p>":'<p class="gl-poi-popup__desc">'+a+"</p>"}function hn(e,t){const o=fn(),n=pn(),r=o(e,t.field);return null==r||""===r?"":'<div class="gl-content__longtext"><p>'+n(String(r)).replace(/\n/g,"</p><p>")+"</p></div>"}function yn(e,t){const o=fn(),n=pn(),r=o(e,t.field);if(null==r||""===r)return"";const i="number"==typeof r?r:parseFloat(r);if(isNaN(i))return"";if(me)return me(i);const a=i.toLocaleString("fr-FR"),l=t.label?n(t.label):"";return"stat"===(t.variant||"default")?'<div class="gl-content__stat">'+(l?'<span class="gl-content__stat-label">'+l+"</span>":"")+'<span class="gl-content__stat-value">'+a+"</span></div>":'<p class="gl-content__number">'+(l?"<strong>"+l+":</strong> ":"")+a+"</p>"}function mn(e,t){const o=fn(),n=pn(),r=o(e,t.field);if(null==r||""===r)return"";const i="number"==typeof r?r:parseFloat(r);if(isNaN(i))return"";const a=i.toLocaleString("fr-FR"),l=t.label?n(t.label):"",s=t.suffix?n(t.suffix):"";return'<p class="gl-content__metric">'+(l?"<strong>"+l+":</strong> ":"")+(t.prefix?n(t.prefix):"")+a+s+"</p>"}function bn(e,t){const o=fn(),n=pn(),r=o(e,t.field);if(null==r||""===r)return"";const i="number"==typeof r?r:parseFloat(r);if(isNaN(i))return"";const a=t.label?n(t.label):"",l=t.variant||"default";let s='<span class="gl-rating__stars">';for(let e=1;e<=5;e++)s+='<span class="gl-rating__star'+(e<=Math.round(i)?" gl-rating__star--filled":"")+'">\u2605</span>';s+="</span>";const c=i.toFixed(1);return"stat"===l?'<div class="gl-rating gl-rating--stat">'+(a?'<span class="gl-rating__label">'+a+"</span>":"")+'<div class="gl-rating__content">'+s+'<span class="gl-rating__value">'+c+"/5</span></div></div>":'<div class="gl-rating">'+(a?'<span class="gl-rating__label">'+a+": </span>":"")+s+'<span class="gl-rating__value">'+c+"/5</span></div>"}function _n(e,t){const o=fn(),n=pn(),r=o(e,t.field);if(null==r||""===r)return"";const i=X(),a=i?.taxonomy,l=t.variant||"default";let s=r,c="";if(a&&t.field){const o=e.attributes||{};if(t.field.includes("categoryId")&&!t.field.includes("subCategoryId")){const t=a.categories?.[r];if(t?.label&&(s=t.label),Je&&e._layerConfig){const t=Je(e,e._layerConfig.id);t&&t.fillColor&&(c+="background-color: "+t.fillColor+";"),t&&t.color&&(c+="border-color: "+t.color+";")}}else if(t.field.includes("subCategoryId")){const t=o.categoryId||o.category,n=a.categories?.[t],i=n?.subcategories?.[r];if(i?.label&&(s=i.label),Je&&e._layerConfig){const t=Je(e,e._layerConfig.id);t&&t.fillColor&&(c+="background-color: "+t.fillColor+";"),t&&t.color&&(c+="border-color: "+t.color+";")}}}return'<span class="gl-poi-badge gl-poi-badge--'+l+'"'+(c?' style="'+c+'"':"")+">"+n(String(s))+"</span>"}function Ln(e,t){const o=fn(),n=pn(),r=o(e,t.field);if(null==r||""===r)return"";let i=null;try{i=b(r)}catch(e){return W().warn("[ContentBuilder.Shared] URL image invalide:",e.message),""}if(!i)return"";const a=n(t.label||"Image");return t.variant,'<div class="gl-poi-popup__photo"><img src="'+i+'" alt="'+a+'" loading="lazy" /></div>'}function vn(e,t){const o=fn(),n=pn(),r=o(e,t.field);if(null==r||""===r)return"";const i=n(t.label||r);return"button"===(t.variant||"default")?'<a href="'+n(r)+'" target="_blank" rel="noopener noreferrer" class="gl-content__link gl-content__link--button">'+i+"</a>":'<a href="'+n(r)+'" target="_blank" rel="noopener noreferrer" class="gl-content__link">'+i+"</a>"}function wn(e,t){const o=fn(),n=pn(),r=o(e,t.field);if(null==r)return"";const i=t.variant||"disc";let a=[];if(Array.isArray(r))a=r;else{if("object"!=typeof r)return"";a=Object.entries(r).map(([e,t])=>e+": "+t)}if(0===a.length)return"";let l='<ul class="gl-content__list gl-content__list--'+i+'">';return a.forEach(e=>{l+="<li>"+n(String(e))+"</li>"}),l+="</ul>",l}function Cn(e,t){const o=fn(),n=pn(),r=o(e,t.field);if(null==r||!Array.isArray(r)||0===r.length)return"";const i=t.columns||[];if(0===i.length)return"";const a=t.borders||{};let l="";a.color&&(l+="--gl-table-border-color: "+a.color+";");let s="gl-content__table";a.outer&&(s+=" gl-content__table--border-outer"),a.row&&(s+=" gl-content__table--border-row"),a.column&&(s+=" gl-content__table--border-column");let c='<table class="'+s+'"'+(l?' style="'+l+'"':"")+">";return c+="<thead><tr>",i.forEach(e=>{c+="<th>"+n(e.label||e.key)+"</th>"}),c+="</tr></thead>",c+="<tbody>",r.forEach(e=>{c+="<tr>",i.forEach(t=>{const o="object"==typeof e?e[t.key]||"":e;c+="<td>"+n(String(o))+"</td>"}),c+="</tr>"}),c+="</tbody></table>",c}function In(e,t){const o=fn(),n=pn(),r=o(e,t.field);if(null==r||!Array.isArray(r)||0===r.length)return"";let i='<div class="gl-content__tags">';return r.forEach(e=>{e&&"string"==typeof e&&(i+='<span class="gl-content__tag">'+n(e)+"</span>")}),i+="</div>",i}function Sn(e,t){const o=fn(),n=pn(),r=o(e,t.field);if(null==r)return"";let i,a;if(Array.isArray(r)&&r.length>=2)[i,a]=r;else{if("object"!=typeof r||void 0===r.lat||void 0===r.lng)return"";i=r.lat,a=r.lng}return'<div class="gl-content__coordinates"><span class="gl-content__coordinates-label">'+(t.label?n(t.label):"Coordonn\xe9es")+':</span> <span class="gl-content__coordinates-value">'+i.toFixed(6)+", "+a.toFixed(6)+"</span></div>"}function En(e,t){const o=fn(),n=pn(),r=o(e,t.field);if(null==r||!Array.isArray(r)||0===r.length)return"";let i='<div class="gl-content__gallery">';return r.forEach((e,t)=>{e&&"string"==typeof e&&(i+='<div class="gl-content__gallery-item" data-index="'+t+'"><img src="'+n(e)+'" alt="Image '+(t+1)+'" loading="lazy" /></div>')}),i+="</div>",i}function An(e,t){const o=fn(),n=pn(),r=o(e,t.field);if(null==r||!Array.isArray(r)||0===r.length)return"";let i='<div class="gl-content__reviews">';return r.forEach(e=>{if(!e)return;if(i+='<div class="gl-content__review">',void 0!==e.rating){const t=parseFloat(e.rating)||0;i+='<div class="gl-content__review-rating">';for(let e=1;e<=5;e++)i+='<span class="gl-content__review-star'+(e<=t?" gl-content__review-star--filled":"")+'">\u2605</span>';i+="</div>"}(e.text||e.comment)&&(i+='<p class="gl-content__review-text">'+n(e.text||e.comment)+"</p>");const t=e.author||e.authorName,o=e.date||e.createdAt;if(t||o){if(i+='<div class="gl-content__review-meta">',t){const o=e.verified?' <span class="gl-content__review-verified">\u2713</span>':"";i+='<span class="gl-content__review-author">'+n(t)+o+"</span>"}o&&(i+='<span class="gl-content__review-date">'+n(o)+"</span>"),i+="</div>"}i+="</div>"}),i+="</div>",i}W().info("[GeoLeaf._ContentBuilder.Core] Module Core charg\xe9 - Helpers + Validators + Badge resolver");const Pn={text:gn,longtext:hn,number:yn,metric:mn,rating:bn,badge:_n,image:Ln,link:vn,list:wn,table:Cn,tags:In,coordinates:Sn,gallery:En,reviews:An},Gn={renderText:gn,renderLongtext:hn,renderNumber:yn,renderMetric:mn,renderRating:bn,renderBadge:_n,renderImage:Ln,renderLink:vn,renderList:wn,renderTable:Cn,renderTags:In,renderCoordinates:Sn,renderGallery:En,renderReviews:An,renderItem:function(e,t,o={}){if(!t||!t.type)return"";const n=Pn[t.type];return n?n(e,t,o):(W().warn("[ContentBuilder.Shared] Type de rendu non support\xe9:",t.type),"")},getResolveField:fn,getEscapeHtml:pn,getActiveProfile:X,getLog:W};function Tn(){return ln||{}}function xn(){return H}function On(){return y}function Mn(e,t,o={}){const n=Gn||{};return n&&n.renderItem?n.renderItem(e,t,o):""}W().debug&&W().debug("[ContentBuilder.Shared] Renderers partag\xe9s charg\xe9s");const kn={buildPopupHTML:function(e,t,o={}){const n=Tn(),r=On();if(!e)return W().warn("[Assemblers] POI invalide pour buildPopupHTML"),"";if(!t||!Array.isArray(t)||0===t.length){const t=n.getDefaultTitle?n.getDefaultTitle(e):e.title||e.label||e.name||"Sans titre";return n.debugLog?.("popup","No config provided, using default popup"),'<div class="gl-poi-popup"><div class="gl-poi-popup__body"><h3 class="gl-poi-popup__title"><span class="gl-poi-popup__title-text">'+r(t)+'</span></h3><a href="#" class="gl-poi-popup__link" data-poi-id="'+(e.id||"")+'">Voir plus >>></a></div></div>'}const i=n.sortConfigByOrder?n.sortConfigByOrder(t):[...t].sort(Z),a={context:"popup",includeIcon:1,resolveCategoryDisplay:o.resolveCategoryDisplay};try{const t=function(e,t,o){const n=[];let r=[];return e.forEach((i,a)=>{const l="image"===i.type&&"hero"===i.variant,s="badge"===i.type,c=e[a+1],u=c&&"badge"===c.type,d=Mn(t,i,o);l?n.push({type:"hero",html:d}):s?(r.push(d),u||(n.push({type:"badges",items:[...r]}),r=[])):n.push({type:"content",html:d})}),n}(i,e,a),o=function(e,t){let o='<div class="gl-poi-popup">',n=0;return t.forEach(e=>{"hero"===e.type?(n&&(o+="</div>",n=0),o+=e.html):(n||(o+='<div class="gl-poi-popup__body">',n=1),"badges"===e.type?(o+='<div class="gl-poi-popup__badges">',e.items.forEach(e=>{o+=e}),o+="</div>"):o+=e.html)}),n||(o+='<div class="gl-poi-popup__body">',n=1),o+='<a href="#" class="gl-poi-popup__link" data-poi-id="'+(e.id||"")+'">Voir plus >>></a>',n&&(o+="</div>"),o+="</div>",o}(e,t);return o}catch(e){return'<div class="gl-poi-popup"><div class="gl-poi-popup__body">Erreur: '+r(e.message)+"</div></div>"}},buildTooltipHTML:function(e,t){if(!e)return W().warn("[Assemblers] POI invalide pour buildTooltipHTML"),"";const o=Tn(),n=On(),r=xn();if(!t||!Array.isArray(t)||0===t.length){const t=o.getDefaultTitle?o.getDefaultTitle(e):e.title||e.label||e.name||r(e,"attributes.name","attributes.nom","properties.name","properties.nom")||"Sans titre";return n(String(t))}const i=o.sortConfigByOrder?o.sortConfigByOrder(t):[...t].sort(Z),a=[];if(i.forEach(t=>{if(!t||!t.type||!t.field)return;const i=r(e,t.field);if(null!=i&&""!==i)if("text"===t.type||"badge"===t.type){let r=i;if("badge"===t.type&&o.resolveBadgeLabel)r=o.resolveBadgeLabel(e,t.field,i);else if("badge"===t.type){const o=X(),n=o?.taxonomy;if(n){const o=e.attributes||{};if(t.field.includes("subCategoryId")){const e=o.categoryId||o.category,t=n.categories?.[e],a=t?.subcategories?.[i];a?.label&&(r=a.label)}else if(t.field.includes("categoryId")){const e=n.categories?.[i];e?.label&&(r=e.label)}}}a.push(n(String(r)))}else if("number"===t.type){const e="number"==typeof i?i:parseFloat(i);isNaN(e)||a.push(e.toLocaleString("fr-FR"))}else if("image"===t.type)a.push('<img src="'+n(i)+'" alt="" style="max-width:150px;max-height:100px;display:block;margin:4px 0;" />');else if("link"===t.type){const e=t.label||i;a.push('<a href="'+n(i)+'" target="_blank">'+n(e)+"</a>")}}),0===a.length){const t=e.title||e.label||"Sans titre";return n(String(t))}let l="";return a.forEach((e,t)=>{if(l+=e,t<a.length-1){const e=i[t];e&&e.contentUnion?l+=" "+n(e.contentUnion)+" ":l+=" "}}),l},buildPanelItems:function(e,t,o={}){if(!e||!t||!Array.isArray(t))return[];const n=xn(),r={context:"panel",...o},i=[...t].sort(Z),a=[];return i.forEach(t=>{if(!t||!t.type)return;const o=n(e,t.field);if((null==o||""===o||Array.isArray(o)&&0===o.length)&&"coordinates"!==t.type)return;const i=Mn(e,t,r);i&&a.push({html:i,config:t,label:t.label||"",accordion:1==t.accordion,defaultOpen:0!=t.defaultOpen})}),a}};function Nn(){return kn||null}function Fn(e,t){if(!e||!t)return null;if(H)return H(e,t);const o=t.split(".");let n=e;for(const e of o){if(!n||"object"!=typeof n||!(e in n))return null;n=n[e]}return n}function Dn(e){if(e._layerConfig?.popup?.detailPopup)return d.info&&d.info("[POI Popup] Config popup depuis layerConfig"),e._layerConfig.popup.detailPopup;if(F&&"function"==typeof F.getActiveProfile){const e=F.getActiveProfile();if(e?.popup?.detailPopup)return d.info&&d.info("[POI Popup] Config popup depuis profil actif (profile.popup.detailPopup)"),e.popup.detailPopup;if(e?.panels?.poi?.popup?.detailPopup)return d.info&&d.info("[POI Popup] Config popup depuis profil actif (profile.panels.poi.popup.detailPopup - ancienne structure)"),e.panels.poi.popup.detailPopup}return d.warn&&d.warn("[POI Popup] Aucune configuration detailPopup trouv\xe9e pour POI:",e.id||"unknown"),null}function Un(e){if(e._layerConfig?.popup?.detailTooltip)return e._layerConfig.popup.detailTooltip;if(e._layerConfig?.tooltip?.detailTooltip)return e._layerConfig.tooltip.detailTooltip;if(e._layerConfig?.detailTooltip)return e._layerConfig.detailTooltip;if(F&&"function"==typeof F.getActiveProfile){const e=F.getActiveProfile();if(e?.popup?.detailTooltip)return e.popup.detailTooltip}return null}function Rn(e,t){if(!e)return d.warn&&d.warn("[POI Tooltip] POI invalide"),"";const o=Un(e),n=Nn();return n&&"function"==typeof n.buildTooltipHTML?n.buildTooltipHTML(e,o,{resolveCategoryDisplay:t}):y(Fn(e,"title")||Fn(e,"label")||Fn(e,"name")||"POI")}function jn(e,t,o){if(!e||"function"!=typeof e.bindTooltip)return void(d.warn&&d.warn("[POI Popup] Marker invalide pour attachTooltip"));const n=Object.assign({},{direction:"top",offset:[0,-10],opacity:.9,className:"gl-poi-tooltip"},o||{});e.bindTooltip(t,n)}W().info("[GeoLeaf._ContentBuilder.Assemblers] Module Assemblers charg\xe9");const $n={buildQuickPopupContent:function(e,t){if(!e)return d.warn&&d.warn("[POI Popup] POI invalide"),"";const o=Dn(e),n=Nn();return n&&"function"==typeof n.buildPopupHTML?n.buildPopupHTML(e,o,{resolveCategoryDisplay:t}):(d.warn&&d.warn("[POI Popup] ContentBuilder non disponible, fallback basique"),function(e){const t=y(Fn(e,"title")||Fn(e,"label")||Fn(e,"name")||"POI"),o=Fn(e,"attributes.description")||Fn(e,"description")||"";let n='<div class="gl-poi-popup">';return n+='<div class="gl-poi-popup__body">',n+='<h3 class="gl-poi-popup__title"><span class="gl-poi-popup__title-text">'+t+"</span></h3>",o&&(n+='<p class="gl-poi-popup__desc">'+y(o)+"</p>"),n+='<a href="#" class="gl-poi-popup__link" data-poi-id="'+(e.id||"")+'">Voir plus >>></a>',n+="</div></div>",n}(e))},buildTooltipContent:Rn,attachTooltip:jn,manageTooltip:function(e,t,o,n){if(!e||!t)return;const r=o?.tooltipMode||"hover";if("none"===r)return;const i=Rn(t,n);"permanent"===r?jn(e,i,{permanent:1}):jn(e,i)},attachPopup:function(e,t,o){if(!e||"function"!=typeof e.bindPopup)return void(d.error&&d.error("[POI Popup] Marker invalide ou pas de bindPopup"));const n=Object.assign({},{maxWidth:300,minWidth:200,className:"gl-poi-popup-leaflet",closeButton:1,autoPan:1},o||{});e.bindPopup(t,n)},getPopupConfig:Dn,getTooltipConfig:Un};let Bn=null;const zn={init(e){Bn=e},isAvailable:()=>Bn?"function"==typeof Bn.isAvailable?Bn.isAvailable():!!Bn.DB:0,get DB(){return Bn?.DB??null},get CacheManager(){return Bn?.CacheManager??null},get Cache(){return Bn?.Cache??null},isPluginLoaded:()=>null!==Bn,downloadProfileForOffline:e=>Bn?Bn.downloadProfileForOffline(e):Promise.reject(new Error("[StorageContract] Storage plugin not loaded"))};class ComponentRenderers{constructor(){this.getMarkers=()=>_r}renderBadge(e,t,o){if(!t)return null;const n=document.createElement("div");n.className="gl-poi-badge-container";const r=document.createElement("span");r.className="gl-poi-badge",r.textContent=t;const i=this.getMarkers();if(i&&i.resolveCategoryDisplay){const e=i.resolveCategoryDisplay(o);e.colorFill&&(r.style.background=e.colorFill,r.style.color="#fff")}return n.appendChild(r),n}renderLink(e,t){if(!t)return null;const o=document.createElement("div");o.className="gl-poi-link-container";const n=document.createElement("a");return n.className="gl-poi-website-link",n.href=t,n.target="_blank",n.rel="noopener noreferrer",n.textContent=e.label||"Visiter le site web \u2192",o.appendChild(n),o}renderList(e,t){if(!t)return d&&d.warn("[POI] renderList: data is null/undefined"),null;const o=document.createElement("div");if(o.className="gl-poi-section","object"==typeof t&&!Array.isArray(t)){if(d&&d.info("[POI] renderList: price object:",t),t.from||t.to){const e=document.createElement("p"),n=document.createElement("strong"),r=Number.isFinite(Number(t.from))?Number(t.from):null,i=Number.isFinite(Number(t.to))?Number(t.to):null,a=t.currency||"USD";null!==r&&null!==i?n.textContent=`De ${r} \xe0 ${i} ${a}`:null!==r?n.textContent=`\xc0 partir de ${r} ${a}`:null!==i&&(n.textContent=`Jusqu'\xe0 ${i} ${a}`),n.textContent&&(e.appendChild(n),o.appendChild(e))}if(t.description){const e=document.createElement("p");e.textContent=t.description,e.style.fontSize="0.85rem",e.style.color="var(--gl-color-text-muted)",o.appendChild(e)}return 0===o.children.length?(d&&d.warn("[POI] renderList: price object has no displayable content"),null):o}if(Array.isArray(t)){const n=e.variant||"disc",r=document.createElement("ul");r.className="gl-poi-list-unordered",r.style.listStyleType="disc"===n||"circle"===n||"square"===n?n:"disc",t.forEach(e=>{const t=document.createElement("li");t.textContent=e,r.appendChild(t)}),o.appendChild(r)}return o}renderTable(e,t){if(!t||!Array.isArray(t))return d&&d.warn("[POI] renderTable: data is",t?"not an array":"null/undefined","- type:",typeof t),null;d&&d.info("[POI] renderTable: rendering",t.length,"rows");let o=t;t.length>0&&"string"==typeof t[0]&&e.columns&&2===e.columns.length&&(o=t.map(t=>{const o=[" : ",": "," \u2013 ","\u2013"," - ","-"];for(const n of o){const o=t.split(n);if(o.length>=2)return{[e.columns[0].key]:o[0].trim(),[e.columns[1].key]:o.slice(1).join(n).trim()}}return{[e.columns[0].key]:t,[e.columns[1].key]:""}}),d&&d.info("[POI] renderTable: transformed string array to object array"));const n=document.createElement("table");n.className="gl-poi-table";const r=e.borders||{};if(0!=r.outer&&(n.style.border=`1px solid ${r.color||"var(--gl-color-border-soft)"}`),e.columns){const t=document.createElement("thead"),o=document.createElement("tr");e.columns.forEach((e,t)=>{const n=document.createElement("th");n.textContent=e.label,n.style.padding="8px",n.style.textAlign="left",n.style.fontWeight="600",n.style.backgroundColor="var(--gl-color-bg-subtle)",0!=r.row&&(n.style.borderBottom=`1px solid ${r.color||"var(--gl-color-border-soft)"}`),r.column&&t>0&&(n.style.borderLeft=`1px solid ${r.color||"var(--gl-color-border-soft)"}`),o.appendChild(n)}),t.appendChild(o),n.appendChild(t)}const i=document.createElement("tbody");return o.forEach((t,n)=>{const a=document.createElement("tr");e.columns&&e.columns.forEach((e,i)=>{const l=document.createElement("td");l.textContent=t[e.key]||"",l.style.padding="8px",0!=r.row&&n<o.length-1&&(l.style.borderBottom=`1px solid ${r.color||"var(--gl-color-border-soft)"}`),r.column&&i>0&&(l.style.borderLeft=`1px solid ${r.color||"var(--gl-color-border-soft)"}`),a.appendChild(l)}),i.appendChild(a)}),n.appendChild(i),n}renderTags(e,t){if(!t||!Array.isArray(t))return d&&d.warn("[POI] renderTags: tags is",t?"not an array":"null/undefined","- type:",typeof t,"- value:",t),null;if(0===t.length)return d&&d.warn("[POI] renderTags: tags array is empty"),null;d&&d.info("[POI] renderTags: rendering",t.length,"tags");const o=document.createElement("div");return o.className="gl-poi-sidepanel__tags",o.style.display="flex",o.style.flexWrap="wrap",o.style.gap="6px",t.forEach(e=>{const t=document.createElement("span");t.className="gl-poi-tag",t.textContent=e,o.appendChild(t)}),o}renderRating(e,t){const o=parseFloat(t);if(!Number.isFinite(o))return d&&d.warn("[POI] renderRating: valeur non num\xe9rique:",t),null;const n=document.createElement("div");if(n.className="gl-rating gl-rating--stat",e.label){const t=document.createElement("span");t.className="gl-rating__label",t.textContent=e.label,n.appendChild(t)}const r=document.createElement("span");r.className="gl-rating__stars";for(let e=1;e<=5;e++){const t=document.createElement("span");t.className="gl-rating__star"+(e<=Math.round(o)?" gl-rating__star--filled":""),t.textContent="\u2605",r.appendChild(t)}n.appendChild(r);const i=document.createElement("span");return i.className="gl-rating__value",i.textContent=o.toFixed(1)+"/5",n.appendChild(i),n}renderReviews(e,t){if(!t||!Array.isArray(t))return d&&d.warn("[POI] renderReviews: reviews is",t?"not an array":"null/undefined","- type:",typeof t),null;d&&d.info("[POI] renderReviews: rendering",t.length,"reviews");const o=document.createElement("div");o.className="gl-poi-reviews";const n=e.maxCount||5;return t.slice(0,n).forEach(e=>{const t=document.createElement("div");t.className="gl-poi-review",t.style.borderLeft="3px solid var(--gl-color-accent-soft)",t.style.paddingLeft="12px",t.style.marginBottom="12px";const n=document.createElement("p");n.style.fontSize="0.875rem",n.style.fontWeight="600",n.style.marginBottom="4px";const r=e.authorName||"Anonyme",i=Number.isFinite(e.rating)?e.rating:0,a=e.verified?" \u2713":"";if(n.textContent=`${r} - \u2b50${i}/5${a}`,t.appendChild(n),e.comment){const o=document.createElement("p");o.textContent=e.comment,o.style.fontSize="0.85rem",o.style.marginBottom="4px",t.appendChild(o)}if(e.createdAt){const o=document.createElement("p");o.style.fontSize="0.75rem",o.style.color="var(--gl-color-text-muted)",o.textContent=e.createdAt,t.appendChild(o)}o.appendChild(t)}),o}}class FieldRenderers extends AbstractRenderer{constructor(e={}){super({name:"FieldRenderers",debug:e.debug||0,config:e.config||{}}),this.init()}render(e){const{section:t,poi:o,value:n,type:r}=e;switch(r){case"text":return this.renderText(t,o,n);case"badge":return this.renderBadge(t,n,o);case"link":return this.renderLink(t,n);case"tags":return this.renderTags(t,n);default:return this.warn("Unknown render type:",r),null}}async renderText(e,t,o){if("title"===e.style||"title"===e.variant)return await this._renderTitleWithIcon(t,o);if(!o)return this.warn("renderText: no value provided"),null;const n=this.createElement("multiline"===e.variant?"div":"p","gl-poi-sidepanel__desc");return"multiline"===e.variant&&(n.style.whiteSpace="pre-wrap",n.style.lineHeight="1.6"),n.textContent=o,this.info("renderText: element created, variant:",e.variant||"normal"),n}async _renderTitleWithIcon(e,t){const o=this.createElement("h2","gl-poi-sidepanel__title"),n=this._getMarkers();if(n&&n.resolveCategoryDisplay&&n.ensureProfileSpriteInjectedSync){const t=n.resolveCategoryDisplay(e);if(this.debug("_renderTitleWithIcon: displayInfo =",t),t.iconId){await n.ensureProfileSpriteInjectedSync();const e=this._createCategoryIcon(t);e?(this.debug("_renderTitleWithIcon: SVG icon created successfully"),o.appendChild(e)):this.warn("_renderTitleWithIcon: SVG icon creation failed")}else this.debug("_renderTitleWithIcon: No iconId in displayInfo")}else this.warn("_renderTitleWithIcon: Markers or required methods not available");const r=this.createTextElement("span",t||e.title||e.label||e.name||"POI","gl-poi-sidepanel__title-text");return o.appendChild(r),this.info("renderText: title element created with icon"),o}_createCategoryIcon(e){const t=F&&"function"==typeof F.getIconsConfig?F.getIconsConfig():null,o=t&&t.symbolPrefix||"gl-poi-cat-",n=o+String(e.iconId).trim().toLowerCase().replace(/\s+/g,"-");this.debug("_createCategoryIcon: symbolId =",n,", colors =",e.colorFill,e.colorStroke),this.debug("_createCategoryIcon: iconPrefix from config =",o);const r=document.querySelector('svg[data-geoleaf-sprite="profile"]');r?this.debug("_createCategoryIcon: Sprite trouv\xe9, nombre de symboles:",r.querySelectorAll("symbol").length):this.warn("_createCategoryIcon: Sprite SVG non trouv\xe9 dans le DOM! Le sprite doit \xeatre charg\xe9 avant.");const i=r?r.querySelector(`#${n}`):null;if(!i&&(this.warn("_createCategoryIcon: Symbole non trouv\xe9 dans le sprite:",n),r)){const e=Array.from(r.querySelectorAll("symbol")).map(e=>e.id).slice(0,5);this.debug("_createCategoryIcon: Premiers symboles disponibles:",e)}const a=document.createElementNS("http://www.w3.org/2000/svg","svg");a.setAttribute("width","32"),a.setAttribute("height","32"),a.setAttribute("viewBox","0 0 24 24"),a.setAttribute("class","gl-poi-sidepanel__icon"),a.style.marginRight="10px",a.style.flexShrink="0";const l=document.createElementNS("http://www.w3.org/2000/svg","circle");if(l.setAttribute("cx","12"),l.setAttribute("cy","12"),l.setAttribute("r","10"),l.setAttribute("fill",e.colorFill||"#3388ff"),l.setAttribute("stroke",e.colorStroke||"#fff"),l.setAttribute("stroke-width","1.5"),a.appendChild(l),i){const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("x","4"),e.setAttribute("y","4"),e.setAttribute("width","16"),e.setAttribute("height","16"),e.setAttribute("viewBox","0 0 32 32");const t=document.createElementNS("http://www.w3.org/2000/svg","use");t.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href","#"+n),t.setAttribute("href","#"+n),t.style.color="#ffffff",e.appendChild(t),a.appendChild(e)}return this.debug("_createCategoryIcon: SVG structure created"),a}renderBadge(e,t,o){if(!t)return null;const n=this.createElement("div","gl-poi-badge-container"),r=this.createTextElement("span",t,"gl-poi-badge"),i=this._getMarkers();if(i&&i.resolveCategoryDisplay){const e=i.resolveCategoryDisplay(o);e.colorFill&&(r.style.background=e.colorFill,r.style.color="#fff")}return n.appendChild(r),n}renderLink(e,t){if(!t)return null;const o=this.createElement("p","gl-poi-sidepanel__link"),n=this.createElement("a",null,{href:t,target:"_blank",rel:"noopener noreferrer"});return n.textContent=e.linkText||t,o.appendChild(n),o}renderTags(e,t){if(!t||!Array.isArray(t)||0===t.length)return null;const o=this.createElement("div","gl-poi-sidepanel__tags");return t.forEach(e=>{if(e){const t=this.createTextElement("span",e,"gl-poi-tag");o.appendChild(t)}}),o}_getMarkers(){return _r||null}}class MediaRenderers extends AbstractRenderer{constructor(e={}){super({name:"MediaRenderers",debug:e.debug||0,config:e.config||{}}),this.init()}render(e){const{section:t,value:o,type:n}=e;switch(n){case"image":return this.renderImage(t,o);case"gallery":return this.renderGallery(t,o);default:return this.warn("Unknown media render type:",n),null}}renderImage(e,t){if(!t)return null;const o="hero"===e.variant?"gl-poi-sidepanel__photo gl-poi-sidepanel__photo--hero":"gl-poi-sidepanel__photo",n=this.createElement("div",o),r=this.createElement("img",null,{src:t,alt:e.label||"Photo",loading:"lazy"});return n.appendChild(r),n}renderGallery(e,t){if(!t||!Array.isArray(t)||0===t.length)return this.warn("renderGallery: invalid gallery data",t),null;this.info("renderGallery: rendering",t.length,"images");const o=this.createElement("div","gl-poi-gallery"),n=this._createMainImage(t[0]);if(o.appendChild(n),t.length>1){const e=this._createThumbnails(t,n);o.appendChild(e)}return o}_createMainImage(e){const t=this.createElement("div","gl-poi-gallery__main",{"data-gallery-index":"0"}),o=this.createElement("img",null,{src:e,alt:"Image 1",loading:"lazy"});return t.appendChild(o),t}_createThumbnails(e,t){const o=this.createElement("div","gl-poi-gallery__thumbnails"),n=t.querySelector("img");return e.forEach((e,r)=>{const i=this._createThumbnail(e,r,n,t,o);o.appendChild(i)}),o}_createThumbnail(e,t,o,n,r){const i=this.createElement("div",0===t?"gl-poi-gallery__thumb active":"gl-poi-gallery__thumb",{"data-index":t.toString()}),a=this.createElement("img",null,{src:e,alt:`Image ${t+1}`,loading:"lazy"});return i.appendChild(a),this.addEventListener(i,"click",a=>{a.preventDefault(),a.stopPropagation(),r.querySelectorAll(".gl-poi-gallery__thumb").forEach(e=>e.classList.remove("active")),i.classList.add("active"),o.src=e,o.alt=`Image ${t+1}`,n.setAttribute("data-gallery-index",t.toString()),this.info("Gallery: Switched to image",t+1)},1),i}destroy(){this.debug("Destroying MediaRenderers"),super.destroy()}}class SectionOrchestrator{constructor(){this.componentRenderers=null,this.fieldRenderers=null,this.mediaRenderers=null}_initRenderers(){this.componentRenderers||(this.componentRenderers=new ComponentRenderers),this.fieldRenderers||(this.fieldRenderers=new FieldRenderers({debug:1})),this.mediaRenderers||(this.mediaRenderers=new MediaRenderers({debug:1}))}getFieldValue(e,t){if(!t)return null;const o=(H||function(e,t){const o=t.split(".");let n=e;for(const e of o){if(!n||"object"!=typeof n||!(e in n))return null;n=n[e]}return n})(e,t);return d&&d.info&&d.info("[POI] getFieldValue:",t,"\u2192",void 0===o?"undefined":null===o?"null":""===o?'""(empty string)':Array.isArray(o)?`Array(${o.length})`:o&&"object"==typeof o?`Object(${Object.keys(o).length} keys)`:o),o}wrapInAccordion(e,t,o=0){const n=document.createElement("details");n.className="gl-accordion",o&&n.setAttribute("open","");const r=document.createElement("summary");r.className="gl-accordion__header",r.textContent=e.label||"Section";const i=document.createElement("span");i.className="gl-accordion__arrow",i.textContent="\u25bc",r.appendChild(i);const a=document.createElement("div");a.className="gl-accordion__panel";const l=document.createElement("div");return l.className="gl-accordion__panel-content",l.appendChild(t),a.appendChild(l),n.appendChild(r),n.appendChild(a),n}async renderSection(e,t,o){if(!e||!e.type)return null;this._initRenderers();const n=this.getFieldValue(t,e.field);d&&(Array.isArray(n)?n.length:n&&"object"==typeof n&&Object.keys(n).length,e.label||e.type,e.field);const r="text"===e.type&&"title"===e.style||"badge"===e.type,i=null==n||""===n||Array.isArray(n)&&0===n.length||"object"==typeof n&&!Array.isArray(n)&&0===Object.keys(n).length;if(d&&d.info("[POI] Check isEmpty for:",e.label,"- fieldValue:",n,"- isArray:",Array.isArray(n),"- arrayLength:",Array.isArray(n)?n.length:"N/A","- isEmpty:",i),i&&!r)return d&&d.warn("[POI] Section ignor\xe9e (valeur vide):",e.label||e.type),null;d&&d.info("[POI] \u2192 Appel render pour:",e.label,"- Type:",e.type,"- Value:",Array.isArray(n)?`Array(${n.length})`:n&&"object"==typeof n?"Object":n);let a=null;switch(e.type){case"text":case"longtext":this.fieldRenderers&&(a=await this.fieldRenderers.renderText(e,t,n));break;case"number":this.fieldRenderers&&(a=await this.fieldRenderers.renderText(e,t,String(n)));break;case"metric":{const o=e.suffix||"",r=e.prefix||"";this.fieldRenderers&&(a=await this.fieldRenderers.renderText(e,t,r+String(n)+o));break}case"image":this.mediaRenderers&&(a=this.mediaRenderers.renderImage(e,n));break;case"gallery":this.mediaRenderers&&(a=this.mediaRenderers.renderGallery(e,n));break;case"badge":a=this.componentRenderers.renderBadge(e,n,t);break;case"link":a=this.componentRenderers.renderLink(e,n);break;case"list":a=this.componentRenderers.renderList(e,n);break;case"table":a=this.componentRenderers.renderTable(e,n);break;case"tags":a=this.componentRenderers.renderTags(e,n);break;case"rating":a=this.componentRenderers.renderRating(e,n);break;case"reviews":a=this.componentRenderers.renderReviews(e,n);break;default:return d&&d.warn("[POI] Type de section inconnu:",e.type),null}return a?(d&&(e.label||e.type,e.accordion),e.accordion?this.wrapInAccordion(e,a,e.defaultOpen):a):(d&&(e.label||e.type),null)}}class LightboxManager{constructor(){this.currentLightbox=null,this.keyHandler=null,this.galleryImages=[],this.currentIndex=0,this._imgElement=null,this._counterElement=null,this._prevButton=null,this._nextButton=null,this.onIndexChange=null}open(e,t,o){this.close(),Array.isArray(t)&&t.length>1?(this.galleryImages=t,this.currentIndex="number"==typeof o?o:t.indexOf(e),this.currentIndex<0&&(this.currentIndex=0)):(this.galleryImages=[e],this.currentIndex=0);const n=document.createElement("div");n.className="gl-poi-lightbox-global",n.style.display="flex";const r=document.createElement("div");r.className="gl-poi-lightbox__overlay",r.addEventListener("click",()=>this.close()),n.appendChild(r);const i=document.createElement("div");i.className="gl-poi-lightbox__content",n.appendChild(i);const a=document.createElement("img");a.className="gl-poi-lightbox__image",a.src=e,a.alt="",i.appendChild(a),this._imgElement=a;const l=document.createElement("button");l.className="gl-poi-lightbox__close",l.setAttribute("aria-label","Fermer"),l.textContent="\xd7",l.addEventListener("click",e=>{e.stopPropagation(),this.close()}),n.appendChild(l),this.galleryImages.length>1&&this._createNavigation(n),document.body.appendChild(n),this.currentLightbox=n,this.keyHandler=e=>{"Escape"===e.key?this.close():"ArrowLeft"===e.key?(e.preventDefault(),this.prev()):"ArrowRight"===e.key&&(e.preventDefault(),this.next())},document.addEventListener("keydown",this.keyHandler)}_createNavigation(e){const t=document.createElement("button");t.className="gl-poi-lightbox__prev",t.setAttribute("aria-label","Image pr\xe9c\xe9dente"),t.textContent="\u2039",t.addEventListener("click",e=>{e.stopPropagation(),this.prev()}),e.appendChild(t),this._prevButton=t;const o=document.createElement("button");o.className="gl-poi-lightbox__next",o.setAttribute("aria-label","Image suivante"),o.textContent="\u203a",o.addEventListener("click",e=>{e.stopPropagation(),this.next()}),e.appendChild(o),this._nextButton=o;const n=document.createElement("div");n.className="gl-poi-lightbox__counter",e.appendChild(n),this._counterElement=n,this._updateNavState()}prev(){this.galleryImages.length<=1||(this.currentIndex=(this.currentIndex-1+this.galleryImages.length)%this.galleryImages.length,this._updateImage())}next(){this.galleryImages.length<=1||(this.currentIndex=(this.currentIndex+1)%this.galleryImages.length,this._updateImage())}_updateImage(){this._imgElement&&(this._imgElement.src=this.galleryImages[this.currentIndex],this._updateNavState(),"function"==typeof this.onIndexChange&&this.onIndexChange(this.currentIndex))}_updateNavState(){this._counterElement&&(this._counterElement.textContent=`${this.currentIndex+1} / ${this.galleryImages.length}`)}close(){this.currentLightbox&&document.body.contains(this.currentLightbox)&&document.body.removeChild(this.currentLightbox),this.keyHandler&&(document.removeEventListener("keydown",this.keyHandler),this.keyHandler=null),this.currentLightbox=null,this._imgElement=null,this._counterElement=null,this._prevButton=null,this._nextButton=null,this.galleryImages=[],this.currentIndex=0,this.onIndexChange=null}isOpen(){return null!==this.currentLightbox&&document.body.contains(this.currentLightbox)}}const Vn={attachSingleAccordionBehavior(e){const t=e.querySelectorAll("details.gl-accordion");0!==t.length&&(t.forEach(e=>{e.addEventListener("toggle",e=>{e.target.open&&t.forEach(t=>{t!==e.target&&t.open&&t.removeAttribute("open")})})}),d&&d.info("[POI] Comportement singleAccordion activ\xe9:",t.length,"accord\xe9ons"))},attachGalleryEvents(e,t){if(!e)return;if(e._galleryEventsAttached)return;e._galleryEventsAttached=1;const o=e.querySelectorAll(".gl-poi-gallery__thumb"),n=e.querySelector(".gl-poi-gallery__main img");if(!n||0===o.length)return;const r=Array.from(o).map(e=>e.querySelector("img").src);o.forEach(e=>{e.addEventListener("click",()=>{const t=parseInt(e.getAttribute("data-index"),10),r=e.querySelector("img").src;n.src=r,n.alt=`Image ${t+1}`,o.forEach(e=>e.classList.remove("active")),e.classList.add("active")})}),n.addEventListener("click",()=>{if(t){const i=e.querySelector(".gl-poi-gallery__thumb.active"),a=i?parseInt(i.getAttribute("data-index"),10):0;t.open(n.src,r,a),t.onIndexChange=t=>{o.forEach(e=>e.classList.remove("active"));const r=e.querySelector(`.gl-poi-gallery__thumb[data-index="${t}"]`);if(r){r.classList.add("active");const e=r.querySelector("img").src;n.src=e,n.alt=`Image ${t+1}`}}}})},setupAll(e,t){this.attachSingleAccordionBehavior(e),this.attachGalleryEvents(e,t)}};let qn=null,Jn=null,Hn=null;const Zn={populateSidePanel:async function(e,t){qn||(qn=new SectionOrchestrator),Jn||(Jn=new LightboxManager),Hn||(Hn=Vn);const o=Ko;if(!o)return void(d&&d.error("[POI] populateSidePanel : shared is null"));const n=o.state;if(!n.sidePanelElement)return void(d&&d.error("[POI] populateSidePanel : sidePanelElement not found"));const r=n.sidePanelElement.querySelector(".gl-poi-sidepanel__content");if(!r)return;ee.clearElementFast(r),delete n.sidePanelElement._galleryEventsAttached;const i=en?en.normalizePoi(e):e;d&&(i.title||i.label,Object.keys(i.attributes||{}));let a=t;if(!a&&i._sidepanelConfig&&i._sidepanelConfig.detailLayout&&(a=i._sidepanelConfig.detailLayout,d&&d.info("[POI] Layout r\xc3\u0192\xc2\xa9cup\xc3\u0192\xc2\xa9r\xc3\u0192\xc2\xa9 depuis la configuration de couche attach\xc3\u0192\xc2\xa9e au POI")),!a&&F&&"function"==typeof F.getActiveProfile){const e=F.getActiveProfile();e&&e.panels&&e.panels.detail&&(a=e.panels.detail.layout,d&&d.info("[POI] Layout r\xc3\u0192\xc2\xa9cup\xc3\u0192\xc2\xa9r\xc3\u0192\xc2\xa9 depuis le profil actif:",e.id||"unknown"))}!a&&n.poiConfig?.panels?.detail?.layout&&(a=n.poiConfig.panels.detail.layout),a&&0!==a.length||(d&&d.warn("[POI] Aucun layout trouv\xc3\u0192\xc2\xa9, utilisation du layout par d\xc3\u0192\xc2\xa9faut"),a=[{type:"text",field:"title",style:"title",accordion:0},{type:"image",field:"attributes.mainImage",variant:"hero",accordion:0},{type:"text",field:"attributes.shortDescription",variant:"short",accordion:0},{type:"text",label:"Informations",field:"attributes.longDescription",variant:"multiline",accordion:1,defaultOpen:1},{type:"text",label:"Description",field:"attributes.description_long",variant:"multiline",accordion:1,defaultOpen:1},{type:"gallery",label:"Galerie photos",field:"attributes.gallery",accordion:1,defaultOpen:1},{type:"list",label:"Prix",field:"attributes.price",accordion:1,defaultOpen:0},{type:"reviews",label:"Avis r\xc3\u0192\xc2\xa9cents",field:"attributes.reviews.recent",maxCount:5,accordion:1,defaultOpen:0},{type:"tags",label:"Tags",field:"attributes.tags",accordion:0},{type:"link",label:"Visiter le site web \xc3\xa2\xe2\u20ac\xa0\xe2\u20ac\u2122",field:"attributes.website",accordion:0}]);const l=[...a].sort(Z);d&&d.info("[POI] G\xc3\u0192\xc2\xa9n\xc3\u0192\xc2\xa9ration du side panel avec",l.length,"sections");const s=document.createElement("div");s.className="gl-poi-sidepanel__body";for(const e of l)try{const t=qn?await qn.renderSection(e,i,n):null;t?(s.appendChild(t),d&&d.info("[POI] \xc3\xa2\xc5\u201c\xe2\u20ac\u0153 Section ajout\xc3\u0192\xc2\xa9e:",e.label||e.type)):d&&d.warn("[POI] \xc3\xa2\xc5\u201c\xe2\u20ac\u201d Section ignor\xc3\u0192\xc2\xa9e (element null):",e.label||e.type,"- field:",e.field)}catch(t){console.error("[SIDEPANEL] ERROR rendering section:",e.label,t),d&&d.error("[POI] Erreur lors du rendu de la section:",e.label,t)}r.appendChild(s);const c=i._sidepanelConfig?.singleAccordion;1==c&&Hn&&Hn.attachSingleAccordionBehavior(s),Hn&&Hn.attachGalleryEvents(n.sidePanelElement,Jn)}},Wn={renderLink(e,t){if(!t)return null;const o=document.createElement("div");o.className="gl-poi-link-container";const n=document.createElement("a");return n.className="gl-poi-website-link",n.href=t,n.target="_blank",n.rel="noopener noreferrer",n.textContent=e.label||t,o.appendChild(n),o}};let Xn=null,Yn=null;function Qn(){return Xn||(Xn=new FieldRenderers({debug:0})),Xn}function Kn(){return Yn||(Yn=new MediaRenderers({debug:0})),Yn}const er={async populateSidePanel(e,t){if(Zn&&"function"==typeof Zn.populateSidePanel)return Zn.populateSidePanel(e,t)},renderContent:(e,t)=>Zn&&"function"==typeof Zn.renderContent?Zn.renderContent(e,t):document.createDocumentFragment(),renderText:async(e,t,o)=>Qn().renderText(e,t,o),renderBadge:(e,t,o)=>Qn().renderBadge(e,t,o),renderImage:(e,t)=>Kn().renderImage(e,t),renderGallery:(e,t)=>Kn().renderGallery(e,t),renderLink:(e,t)=>Wn.renderLink(e,t)},tr={renderContent:(e,t)=>er.renderContent(e,t),renderText:(e,t,o)=>er.renderText(e,t,o),renderBadge:(e,t,o)=>er.renderBadge(e,t,o),renderImage:(e,t)=>er.renderImage(e,t),renderGallery:(e,t)=>er.renderGallery(e,t),renderLink:(e,t)=>er.renderLink(e,t),populateSidePanel:async(e,t)=>er.populateSidePanel(e,t)},or=tr,nr=(e,t,...o)=>te(e,t,...o);function rr(){if(!Ko)return;const e=Ko.state;if(e.sidePanelElement)return;const t=nr("div",{className:"gl-poi-sidepanel-overlay",attributes:{"aria-hidden":"true"}}),o=document.querySelector(".gl-main");o?o.appendChild(t):document.body.appendChild(t),e.sidePanelOverlay=t;const n=nr("aside",{className:"gl-poi-sidepanel",attributes:{"aria-hidden":"true",role:"complementary"}}),r=nr("div",{className:"gl-poi-sidepanel__header"}),i=nr("button",{className:"gl-poi-sidepanel__close",attributes:{"aria-label":"Fermer"},textContent:"\xd7",onClick:ir});r.appendChild(i);const a=nr("div",{className:"gl-poi-sidepanel__content"});n.appendChild(r),n.appendChild(a),o?o.appendChild(n):document.body.appendChild(n),e.sidePanelElement=n,e.sidePanelContent=a,t.addEventListener("click",ir),d&&d.info("[POI] Side panel cr\xe9\xe9.")}function ir(){if(!Ko)return;const e=Ko.state;if(!e.sidePanelElement)return;e.sidePanelElement.classList.remove("open"),e.sidePanelElement.setAttribute("aria-hidden","true"),e.sidePanelOverlay&&e.sidePanelOverlay.classList.remove("open"),document.body.classList.remove("gl-poi-sidepanel-open");const t=document.querySelector(".gl-poi-lightbox-global");t&&t.remove(),e.currentPoiInPanel=null,d&&d.info("[POI] Panneau lat\xe9ral ferm\xe9.")}const ar={createSidePanel:rr,openSidePanel:async function(e,t){if(!e)return void(d&&d.warn("[POI] openSidePanel() : POI invalide."));d&&(e.id||e.name);const o=Ko;if(!o)return void(d&&d.error("[POI] openSidePanel() : POIShared is null"));const n=o.state;if(n.sidePanelElement||rr(),!n.sidePanelElement)return void(d&&d.error("[POI] openSidePanel() : Impossible de cr\xe9er le panneau lat\xe9ral."));n.currentPoiInPanel=e,n.currentGalleryIndex=0;const r=or;if(r&&"function"==typeof r.populateSidePanel)try{await r.populateSidePanel(e,t)}catch(e){d&&d.error("[POI] Erreur lors du peuplement du side panel :",e)}else d&&d.warn("[POI] openSidePanel() : renderers.populateSidePanel non disponible");n.sidePanelOverlay&&n.sidePanelOverlay.classList.add("open"),n.sidePanelElement.classList.add("open"),n.sidePanelElement.setAttribute("aria-hidden","false"),document.body.classList.add("gl-poi-sidepanel-open"),d&&d.info("[POI] Panneau lat\xe9ral ouvert pour :",e.title||e.name||e.label)},closeSidePanel:ir,hideSidePanel:function(){ir()}};function lr(e,t){if("function"!=typeof t)return void(d&&d.error("[POI] loadAndMergeStoredPois: callback requis"));const o=()=>zn.isAvailable()&&"function"==typeof zn.DB?.getAllFromSyncQueue;if(!o()){d&&d.warn("[POI] Module Storage pas encore pr\xeat, attente \xe9v\xe9nement geoleaf:storage:ready...");const n=()=>{o()?lr(e,t):(d&&d.error("[POI] Module Storage toujours non disponible, abandon."),t(e))};return document.addEventListener("geoleaf:storage:ready",n,{once:1}),void Promise.resolve().then(()=>{o()||(document.removeEventListener("geoleaf:storage:ready",n),t(e))})}d&&d.info("[POI] Module Storage disponible, r\xe9cup\xe9ration des POI..."),zn.DB.getAllFromSyncQueue().then(o=>{if(d&&d.info(`[POI] R\xe9cup\xe9ration cache: ${o.length} items trouv\xe9s`),!Array.isArray(o)||0===o.length)return d&&d.info("[POI] Aucun POI trouv\xe9 dans la file de synchronisation."),void t(e);if(d){const e=o.map(e=>`${e.action}:${e.data?.type||"no-type"}`);d.info(`[POI] Types d'items dans le cache: [${e.join(", ")}]`),o.slice(0,2).forEach((e,t)=>{d.info(`[POI] DEBUG Item ${t}:`,{action:e.action,type:e.type,data_type:e.data?.type,keys:Object.keys(e),data_keys:e.data?Object.keys(e.data):"no data"})})}const n=[],r=en;if(!r)return d&&d.error("[POI] Module Normalizers non disponible pour les POI du cache."),void t(e);if(o.forEach(e=>{let t=0,o=null,i=null;if(e.data&&"poi"===e.data.type&&e.action&&(e.action.includes("add")||e.action.includes("update"))?(t=1,o=e.data,i=e.action):"poi"===e.type?(t=1,o=e,i=e.action||"add"):e.data&&(e.data.id||e.data.latlng||e.data.latitude)?(t=1,o=e.data,i=e.action||"add",d&&d.info(`[POI] D\xe9tection heuristique POI: ${e.data.id||"no-id"}`)):e.id&&(e.latlng||e.latitude)&&(t=1,o=e,i="add",d&&d.info(`[POI] D\xe9tection POI direct: ${e.id}`)),t&&o){const e=r.normalizePoi(o);e?(n.push(e),d&&d.info(`[POI] POI du cache normalis\xe9: ${e.id||"Sans ID"} (action: ${i})`)):d&&d.warn("[POI] \xc9chec normalisation POI du cache:",o)}else d&&(e.action,e.type||e.data,Object.keys(e).join(","))}),n.length>0){d&&d.info(`[POI] ${n.length} POI(s) r\xe9cup\xe9r\xe9(s) du cache local.`);const o=[...e];n.forEach(e=>{o.find(t=>t.id===e.id)||o.push(e)}),t(o)}else t(e)}).catch(o=>{d&&d.error("[POI] Erreur lors de la r\xe9cup\xe9ration des POI du cache :",o),t(e)})}function sr(){if(!Ko)return;const e=Ko.state;if(e.isLoading)d&&d.warn("[POI] Chargement d\xe9j\xe0 en cours...");else{try{if(F&&"function"==typeof F.getActiveProfilePoi){const t=F.getActiveProfilePoi();if(Array.isArray(t)&&t.length>0)return e.allPois=t,d&&d.info(`[POI] ${e.allPois.length} POI(s) provenant du profil actif.`),void lr(e.allPois,function(t){e.allPois=t,cr(e.allPois)})}}catch(e){d&&d.error("[POI] Erreur lors de la r\xe9cup\xe9ration des POI du profil actif :",e)}lr([],function(t){if(t.length>0)return e.allPois=t,d&&d.info(`[POI] ${t.length} POI(s) charg\xe9(s) depuis le cache local.`),void cr(t);const o=e.poiConfig.dataUrl;o?(e.isLoading=1,d&&d.info("[POI] Chargement des donn\xe9es POI depuis :",o),fetch(o).then(e=>{if(!e.ok)throw new Error(`Erreur HTTP ${e.status} lors du chargement de ${o}`);return e.json()}).then(t=>{Array.isArray(t)?e.allPois=t:t&&Array.isArray(t.pois)?e.allPois=t.pois:e.allPois=[],d&&d.info(`[POI] ${e.allPois.length} POI(s) charg\xe9(s) depuis dataUrl.`),cr(e.allPois)}).catch(e=>{d&&d.error("[POI] Erreur lors du chargement des POIs :",e)}).finally(()=>{e.isLoading=0})):d&&d.info("[POI] Aucune dataUrl sp\xe9cifi\xe9e et aucun POI en cache. Mode ajout manuel.")})}}function cr(e){if(!e||!Array.isArray(e))return void(d&&d.warn("[POI] displayPois() : Aucune donn\xe9e POI valide \xe0 afficher."));if(!Ko)return;const t=Ko.state;t.poiLayerGroup&&t.poiLayerGroup.clearLayers(),t.poiClusterGroup&&t.poiClusterGroup.clearLayers();const o=0!=t.poiConfig.clustering,n=_r;n&&"function"==typeof n.createMarker?o&&t.poiClusterGroup?(e.forEach(e=>{const o=n.createMarker(e);o&&(t.poiClusterGroup.addLayer(o),t.poiMarkers.set(e.id||e.title||e.label,o))}),t.mapInstance.hasLayer(t.poiClusterGroup)||t.mapInstance.addLayer(t.poiClusterGroup),d&&d.info("[POI] Affichage avec clustering.")):(e.forEach(e=>{const o=n.createMarker(e);o&&(t.poiLayerGroup.addLayer(o),t.poiMarkers.set(e.id||e.title||e.label,o))}),t.mapInstance.hasLayer(t.poiLayerGroup)||t.mapInstance.addLayer(t.poiLayerGroup),d&&d.info("[POI] Affichage sans clustering.")):d&&d.error("[POI] Module Markers non charg\xe9.")}const ur={init:async function(e,t){let o,n;if(e&&"object"==typeof e&&e.map?(o=e.map,n=e.config||e):(o=e,n=t),!o||"function"!=typeof o.addLayer)return void(d&&d.error("[POI] Aucune carte Leaflet valide fournie. Impossible d'initialiser le module POI."));const r=Ko;if(!r)return void(d&&d.error("[POI] Module shared non charg\xe9."));const i=r.state,a=r.constants;i.mapInstance=o,i.poiConfig=n||{},d&&d.info("[POI] Initialisation du module POI..."),r.ensureMapMaxZoom&&r.ensureMapMaxZoom(o,a.POI_MAX_ZOOM),i.poiLayerGroup=L.layerGroup().addTo(o),0!=i.poiConfig.clustering&&"undefined"!=typeof L&&"function"==typeof L.markerClusterGroup&&(i.poiClusterGroup=L.markerClusterGroup({maxClusterRadius:i.poiConfig.clusterRadius||80,disableClusteringAtZoom:i.poiConfig.disableClusteringAtZoom||a.POI_MAX_ZOOM,animate:0,showCoverageOnHover:0}),i.mapInstance.addLayer(i.poiClusterGroup),d&&d.info("[POI] Clustering activ\xe9 (MarkerClusterGroup cr\xe9\xe9)."));const l=ar;l&&"function"==typeof l.createSidePanel&&l.createSidePanel();const s=_r;if(s&&"function"==typeof s.ensureProfileSpriteInjectedSync&&await s.ensureProfileSpriteInjectedSync(),0!=i.poiConfig.enabled)if(zn.isAvailable())sr();else{const e=()=>{document.removeEventListener("geoleaf:storage:ready",e),sr()};document.addEventListener("geoleaf:storage:ready",e,{once:1}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{document.removeEventListener("geoleaf:storage:ready",e),sr()},{once:1}):Promise.resolve().then(()=>{document.removeEventListener("geoleaf:storage:ready",e),sr()})}},loadAndDisplay:sr,displayPois:cr,addPoi:function(e){if(!e)return d&&d.warn("[POI] addPoi() : POI invalide."),null;if(!Ko)return null;const t=Ko.state,o=en,n=_r;if(!o||!n)return d&&d.error("[POI] Modules Normalizers ou Markers non charg\xe9s."),null;const r=o.normalizePoi(e);if(!r)return d&&d.warn("[POI] addPoi() : \xc9chec de la normalisation du POI.",e),null;r.id||(r.id=o.generatePoiId(r)),d&&(d.info("[POI] Adding normalized POI:",r.id),d.info("[POI] - Has _layerConfig:",!!r._layerConfig),d.info("[POI] - Has _sidepanelConfig:",!!r._sidepanelConfig),d.info("[POI] - Has _popupConfig:",!!r._popupConfig),d.info("[POI] - Attributes keys:",Object.keys(r.attributes||{})));const i=n.createMarker(r);return i?(0!=t.poiConfig.clustering&&t.poiClusterGroup?t.poiClusterGroup.addLayer(i):t.poiLayerGroup.addLayer(i),t.allPois.push(r),t.poiMarkers.set(r.id,i),d&&d.info("[POI] \u2705 POI normalis\xe9 ajout\xe9 avec succ\xe8s :",r.id),i):(d&&d.warn("[POI] addPoi() : Impossible de cr\xe9er le marqueur pour ce POI normalis\xe9.",r),null)},getAllPois:function(){return Ko?Ko.state.allPois:[]},getPoiById:function(e){return Ko&&Ko.state.allPois.find(t=>t.id===e)||null},reload:function(e){if(!Ko)return;const t=Ko.state;e&&Array.isArray(e)&&(t.allPois=e),cr(t.allPois),d&&d.info("[POI] POI recharg\xe9s.")},getDisplayedPoisCount:function(){const e=Ko;return e&&e.state?(e.state.allPois||[]).length:0}};let dr=null,fr=null;const pr={register(e,t){dr=e||{},t&&(fr=t)},canShowDetails:()=>!(!dr||"function"!=typeof dr.showPoiDetails),showPoiDetails(e){dr&&"function"==typeof dr.showPoiDetails&&dr.showPoiDetails(e)},registerNotify(e){fr=e},addPoi:e=>ur.addPoi(e),updatePoi(e){dr&&"function"==typeof dr.updatePoi&&dr.updatePoi(e)},removePoi(e){dr&&"function"==typeof dr.removePoi&&dr.removePoi(e)},canUpdate:()=>!(!dr||"function"!=typeof dr.updatePoi),canRemove:()=>!(!dr||"function"!=typeof dr.removePoi),notifySuccess(e){fr&&"function"==typeof fr.success&&fr.success(e)},notifyError(e){fr&&"function"==typeof fr.error&&fr.error(e)}};function gr(){const e={radius:6,weight:1.5,colorFill:"#4a90e5",colorStroke:"#ffffff",fillOpacity:.8,opacity:.9,showIconsOnMap:1};try{if(F&&"function"==typeof F.getActiveProfile){const t=F.getActiveProfile(),o=t&&t.appearance&&t.appearance.poi;o&&("number"==typeof o.radius&&(e.radius=o.radius),"number"==typeof o.weight&&(e.weight=o.weight),"number"==typeof o.fillOpacity&&(e.fillOpacity=o.fillOpacity),"number"==typeof o.opacity&&(e.opacity=o.opacity),"boolean"==typeof o.showIconsOnMap&&(e.showIconsOnMap=o.showIconsOnMap),"string"==typeof o.colorFill&&(e.colorFill=o.colorFill),"string"==typeof o.colorStroke&&(e.colorStroke=o.colorStroke))}if("undefined"!=typeof document&&"undefined"!=typeof window&&window.getComputedStyle){const t=getComputedStyle(document.documentElement),o=t.getPropertyValue("--gl-color-poi-fill-default").trim(),n=t.getPropertyValue("--gl-color-poi-stroke-default").trim();o&&!e.colorFill&&(e.colorFill=o),n&&!e.colorStroke&&(e.colorStroke=n)}}catch(e){d&&d.warn("[POI] getPoiBaseConfig() : Erreur lecture config :",e)}return e}function hr(e){const t=F.getCategories?.()??{},o=0!=(Ko?Ko.state.poiConfig:{}).showIconsOnMap,n=function(e,t){const o={colorFill:t.colorFill,colorStroke:t.colorStroke,colorRoute:null,weight:t.weight,radius:t.radius,fillOpacity:void 0!==t.fillOpacity?t.fillOpacity:null,opacity:void 0!==t.opacity?t.opacity:null};if(e._layerConfig&&e._layerConfig.style){const t=e._layerConfig.style;t.fillColor&&(o.colorFill=t.fillColor),t.color&&(o.colorStroke=t.color),"number"==typeof t.weight&&(o.weight=t.weight),"number"==typeof t.radius&&(o.radius=t.radius),"number"==typeof t.fillOpacity&&(o.fillOpacity=t.fillOpacity),"number"==typeof t.opacity&&(o.opacity=t.opacity)}if(Ze){const t=Ze.resolvePoiColors(e);t.colorFill&&(o.colorFill=t.colorFill),t.colorStroke&&(o.colorStroke=t.colorStroke),t.colorRoute&&(o.colorRoute=t.colorRoute)}return o}(e,gr()),r={useIcon:0,iconId:null,colorFill:n.colorFill,colorStroke:n.colorStroke,colorRoute:n.colorRoute,weight:n.weight,radius:n.radius,fillOpacity:n.fillOpacity,opacity:n.opacity};if(o)try{const e=F.getIconsConfig?.()??null;e&&0!=e.showOnMap&&(r.useIcon=1)}catch(e){}const i=e.categoryId||e.category||e.attributes&&e.attributes.categoryId||e.properties&&e.properties.categoryId||e.properties&&e.properties.category,a=e.subCategoryId||e.subCategory||e.sub_category||e.attributes&&e.attributes.subCategoryId||e.properties&&e.properties.subCategoryId||e.properties&&e.properties.sub_category,l=(e=>{if(!e||!t)return null;if(t[e])return e;const o=String(e).toUpperCase();if(t[o])return o;const n=String(e).toLowerCase();return t[n]?n:Object.keys(t).find(e=>e.toLowerCase()===n)||null})(i);if(a&&l&&t[l]?.subcategories){const e=t[l].subcategories[a]||t[l].subcategories[String(a).toUpperCase()]||t[l].subcategories[String(a).toLowerCase()],o=t[l];r.iconId=e?e.icon||e.iconId||o.icon||o.iconId||null:o.icon||o.iconId||null}else if(l){const e=t[l];r.iconId=e.icon||e.iconId||null}else i&&"undefined"!==i&&"null"!==i&&d&&d.warn(`[POI] resolveCategoryDisplay() : Cat\xe9gorie '${i}' non trouv\xe9e dans la taxonomie.`);return r}function yr(e){if(!e)return d&&d.warn("[POI] extractMarkerCoordinates() : POI invalide.",e),null;return en?en.extractCoordinates(e)||(d&&d.warn("[POI] extractMarkerCoordinates() : POI sans coordonn\xe9es valides.",e),null):(d&&d.error("[POI] extractMarkerCoordinates() : Module Normalizers non charg\xe9."),null)}function mr(e){const t=gr(),o=void 0!==e.radius?e.radius:t.radius,n=void 0!==e.weight?e.weight:t.weight,r=e.fillOpacity,i=e.opacity,a=Math.max(Math.round(2*o+2*n),8),l=Math.max(Math.round(2*o+2*n),16);let s=e.colorFill;if(null!==r&&"number"==typeof r&&s&&s.startsWith("#")){const e=parseInt(s.slice(1,3),16),t=parseInt(s.slice(3,5),16),o=parseInt(s.slice(5,7),16);s="rgba("+e+", "+t+", "+o+", "+r+")"}let c=e.colorStroke;if(null!==i&&"number"==typeof i&&c&&c.startsWith("#")){const e=parseInt(c.slice(1,3),16),t=parseInt(c.slice(3,5),16),o=parseInt(c.slice(5,7),16);c="rgba("+e+", "+t+", "+o+", "+i+")"}if(e.useIcon&&e.iconId){const t=F.getIconsConfig?.()??null,o=['<div class="gl-poi-marker" style="',"--gl-poi-fill:",s,";","--gl-poi-stroke:",c,";","width:",l,"px;","height:",l,"px;",'">','<svg class="gl-poi-marker__icon" aria-hidden="true" focusable="false" viewBox="0 0 24 24" style="overflow: visible;">','<circle cx="12" cy="12" r="10" fill="',s,'" stroke="',c,'" stroke-width="',n,'"/>','<svg x="2" y="2" width="20" height="20" viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" overflow="visible">','<use href="#',(t&&t.symbolPrefix||"gl-poi-cat-")+String(e.iconId).trim().toLowerCase().replace(/\s+/g,"-"),'" style="color: #ffffff"/>',"</svg>","</svg>","</div>"].join("");return L.divIcon({html:o,className:"gl-poi-divicon",iconSize:[l,l],iconAnchor:[l/2,l/2],popupAnchor:[0,-l/2]})}{const e=['<div class="gl-poi-marker" style="',"--gl-poi-fill:",s,";","--gl-poi-stroke:",c,";","width:",a,"px;","height:",a,"px;",'">','<svg class="gl-poi-marker__circle" aria-hidden="true" focusable="false">','<circle cx="50%" cy="50%" r="',o,'"',' fill="',s,'"',' stroke="',c,'"',' stroke-width="',n,'" />',"</svg>","</div>"].join("");return L.divIcon({html:e,className:"gl-poi-divicon",iconSize:[a,a],iconAnchor:[a/2,a/2],popupAnchor:[0,-a/2]})}}function br(e,t){e._geoleafPoiData=t;const o=Ko?Ko.state.poiConfig:{},n=$n;if(n&&"function"==typeof n.manageTooltip&&n.manageTooltip(e,t,o,hr),0!=o.showPopup){if(n&&"function"==typeof n.buildQuickPopupContent){const o=n.buildQuickPopupContent(t,hr);o?n.attachPopup?n.attachPopup(e,o):e.bindPopup(o):d.error("[markers] Popup content vide pour POI:",t.id),e._geoleafPopupActive=0,e.on("tooltipopen",function(){e._geoleafPopupActive&&e.closeTooltip()}),e.on("popupopen",function(){e._geoleafPopupActive=1,e.closeTooltip(),setTimeout(function(){const o=document.querySelector('.gl-poi-popup__link[data-poi-id="'+t.id+'"]');if(o){d&&d.info('[POI] Lien "Voir plus" trouv\xe9 pour POI:',t.id);const n=o.cloneNode(1);o.parentNode.replaceChild(n,o),n.addEventListener("click",function(o){o.preventDefault(),o.stopPropagation(),d&&d.info('[POI] Clic sur "Voir plus" pour POI:',t.id),e&&e.closePopup&&e.closePopup(),setTimeout(function(){d&&d.info("[POI] Appel de showPoiDetails pour:",t.id);const e="undefined"!=typeof globalThis?globalThis:window;e.GeoLeaf?.POI?.showPoiDetails?e.GeoLeaf.POI.showPoiDetails(t):pr.showPoiDetails?.(t)},100)})}else d&&d.warn('[POI] Lien "Voir plus" non trouv\xe9 pour POI:',t.id)},50)}),e.on("popupclose",function(){e._geoleafPopupActive=0,e.getTooltip()&&e.getTooltip().options.permanent&&setTimeout(function(){e.openTooltip&&!e._geoleafPopupActive&&e.openTooltip()},50)})}}else e.on("click",function(e){e.originalEvent.stopPropagation(),d&&d.info("[POI] Clic direct sur marker (sans popup) pour POI:",t.id);const o="undefined"!=typeof globalThis?globalThis:window;o.GeoLeaf?.POI?.showPoiDetails?o.GeoLeaf.POI.showPoiDetails(t):pr.showPoiDetails?.(t)})}const _r={getPoiBaseConfig:gr,resolveCategoryDisplay:hr,ensureProfileSpriteInjectedSync:async function e(){try{if(void 0===F||"function"!=typeof F.getIconsConfig)return void(d&&d.warn("[POI] Config.getIconsConfig non disponible"));const t=F.getIconsConfig();if(e._lastConfig&&JSON.stringify(t)===JSON.stringify(e._lastConfig)||(e._lastConfig=t),!t)return void(d&&d.warn("[POI] Aucune configuration d'ic\xf4nes trouv\xe9e"));const o=t.spriteUrl;if(!o||"string"!=typeof o)return void(d&&d.warn("[POI] spriteUrl manquant ou invalide:",o));if(document.querySelector('svg[data-geoleaf-sprite="profile"]'))return;d&&d.info("[POI] Chargement sprite depuis:",o);try{const e=await fetch(o);if(e.ok){const t=await e.text(),o=(new DOMParser).parseFromString(t,"image/svg+xml"),n=o.querySelector("parsererror");if(n)return void(d&&d.warn("[POI] Erreur parsing SVG sprite :",n.textContent));const r=o.documentElement;if(r&&"svg"===r.tagName.toLowerCase()){r.setAttribute("data-geoleaf-sprite","profile"),r.style.position="absolute",r.style.width="0",r.style.height="0",r.style.overflow="hidden",r.setAttribute("aria-hidden","true"),document.body.firstChild?document.body.insertBefore(r,document.body.firstChild):document.body.appendChild(r);const e=r.querySelectorAll("symbol").length;d&&d.info("[POI] Sprite SVG profil inject\xe9 dans le DOM (async).",e,"symboles charg\xe9s.")}}else d&&d.warn("[POI] Erreur chargement sprite profil: HTTP",e.status)}catch(e){d&&d.warn("[POI] Erreur chargement sprite profil (async):",e)}}catch(e){d&&d.warn("[POI] Erreur chargement sprite profil :",e)}},extractMarkerCoordinates:yr,buildMarkerIcon:mr,attachMarkerEvents:br,createMarker:function(e,t={}){if(!e)return d&&d.warn("[POI] createMarker() : POI invalide.",e),null;const{attachEvents:o=1,pane:n}=t,r=yr(e);if(!r)return null;const[i,a]=r,l={icon:mr(hr(e))};n&&(l.pane=n);const s=L.marker([i,a],l);return o&&br(s,e),s}};function Lr(e,t){const o=globalThis.L.DomUtil.create("div","gl-legend__section",e);t.title&&(globalThis.L.DomUtil.create("h3","gl-legend__section-title",o).textContent=t.title);const n=globalThis.L.DomUtil.create("div","gl-legend__items",o);return Array.isArray(t.items)&&t.items.forEach(e=>vr(n,e)),o}function vr(e,t){const o=globalThis.L.DomUtil.create("div","gl-legend__item",e);wr(globalThis.L.DomUtil.create("div","gl-legend__symbol",o),t);const n=globalThis.L.DomUtil.create("div","gl-legend__text",o);return globalThis.L.DomUtil.create("span","gl-legend__label",n).textContent=t.label||"",t.description&&(globalThis.L.DomUtil.create("span","gl-legend__description",n).textContent=t.description),o}function wr(e,t){Vo&&"function"==typeof Vo.renderSymbol?Vo.renderSymbol(e,t):d&&d.error("[LegendRenderer] Module _UIComponents non disponible")}const Cr={renderSection:Lr,renderItem:vr,renderSymbol:wr,renderFooter:function(e,t){if(!t||!t.text)return;const o=globalThis.L.DomUtil.create("div","gl-legend__footer",e);o.textContent=t.text,"italic"===t.style&&(o.style.fontStyle="italic")},renderAccordion:function(e,t){const o=("undefined"!=typeof globalThis?globalThis:window)?.GeoLeaf?._UIComponents;if(!o)return void(d&&d.error("[LegendRenderer] Module _UIComponents non disponible"));const{bodyEl:n}=o.createAccordion(e,{layerId:t.layerId,label:t.label,collapsed:0!=t.collapsed,visible:t.visible,onToggle:e=>{const t="undefined"!=typeof globalThis?globalThis:window;t.GeoLeaf&&t.GeoLeaf.Legend&&"function"==typeof t.GeoLeaf.Legend.toggleAccordion&&t.GeoLeaf.Legend.toggleAccordion(e)}});Array.isArray(t.sections)&&t.sections.forEach(e=>{Lr(n,e)})}};async function Ir(e){if(_r&&"function"==typeof _r.ensureProfileSpriteInjectedSync){if(Ir._alreadyLogged||(Ir._alreadyLogged=1),await _r.ensureProfileSpriteInjectedSync(),document.querySelector('svg[data-geoleaf-sprite="profile"]'))return Ir._spriteDetected||(d&&d.info("[Legend] Sprite SVG d\xe9tect\xe9 et pr\xeat pour utilisation"),Ir._spriteDetected=1),void("function"==typeof e&&e(1));new Promise(e=>{const t=new MutationObserver((t,n)=>{document.querySelector('svg[data-geoleaf-sprite="profile"]')&&(n.disconnect(),clearTimeout(o),Ir._spriteDetected||(d&&d.info("[Legend] Sprite SVG d\xe9tect\xe9 via MutationObserver"),Ir._spriteDetected=1),e(1))});t.observe(document.documentElement||document.body,{childList:1,subtree:1});const o=setTimeout(()=>{t.disconnect(),d&&d.warn("[Legend] Sprite SVG non trouv\xe9 apr\xe8s 2s"),e(0)},2e3)}).then(t=>{"function"==typeof e&&e(t)})}else"function"==typeof e&&e(0)}const Sr={create:function(e){return globalThis.L&&globalThis.L.Control?new(globalThis.L.Control.extend({options:{position:e.position||"bottomleft"},initialize:function(e){globalThis.L.setOptions(this,e||{}),this._glOptions=e._glOptions},onAdd:function(e){return this._map=e,this._container=globalThis.L.DomUtil.create("div","gl-map-legend"),globalThis.L.DomEvent&&(globalThis.L.DomEvent.disableClickPropagation(this._container),globalThis.L.DomEvent.disableScrollPropagation(this._container)),this._buildStructure(),this._container},onRemove:function(){this._map=null,this._container=null},_buildStructure:function(){const e=this._glOptions,t=globalThis.L.DomUtil.create("div","gl-map-legend__wrapper",this._container);if(e.title){const o=globalThis.L.DomUtil.create("div","gl-map-legend__header",t);if(globalThis.L.DomUtil.create("h2","gl-map-legend__title",o).textContent=e.title,e.collapsible){const e=globalThis.L.DomUtil.create("button","gl-map-legend__toggle",o);e.type="button",e.setAttribute("aria-label","Basculer la l\xe9gende"),e.textContent="\u27f1";const t=this;globalThis.L.DomEvent.on(e,"click",function(e){globalThis.L.DomEvent.stopPropagation(e),t._toggleCollapsed()})}}this._bodyEl=globalThis.L.DomUtil.create("div","gl-map-legend__body",t),e.collapsed&&this._container.classList.add("gl-map-legend--collapsed"),this._renderContent()},_renderContent:function(){if(!this._bodyEl)return;const e=this._glOptions;ee.clearElementFast(this._bodyEl);const t=Cr;t?(Ir(),Array.isArray(e.sections)&&e.sections.forEach(e=>{t.renderSection(this._bodyEl,e)}),e.footer&&t.renderFooter(this._bodyEl,e.footer)):d&&d.error("[Legend] LegendRenderer non disponible")},updateMultiLayerContent:function(e){if(!this._bodyEl)return;ee.clearElementFast(this._bodyEl);const t=Cr;if(!t||"function"!=typeof t.renderAccordion)return void(d&&d.error("[Legend] Renderer.renderAccordion non disponible"));const o=this;Ir(function(n){Array.isArray(e)&&e.forEach(e=>{t.renderAccordion(o._bodyEl,e)}),n||setTimeout(function(){document.querySelector('svg[data-geoleaf-sprite="profile"]')&&d&&(d.info("[Legend] Sprite charg\xe9 tardivement - Re-rendu des accord\xe9ons"),o.updateMultiLayerContent(e))},1e3)})},updateContent:function(e){e.title&&(this._glOptions.title=e.title),e.sections&&(this._glOptions.sections=e.sections),e.footer&&(this._glOptions.footer=e.footer),this._renderContent()},_toggleCollapsed:function(){const e=this._container.classList.toggle("gl-map-legend--collapsed");this._glOptions.collapsed=e},show:function(){this._container&&(this._container.style.display="block")},hide:function(){this._container&&(this._container.style.display="none")}}))({position:e.position,_glOptions:e}):(d&&d.error("[Legend] Leaflet L.Control non disponible"),null)}};function Er(){try{const e=Ko??null;if(0!=(e?e.state.poiConfig:{}).showIconsOnMap){const e=F.getIconsConfig?.()??null;if(e&&0!=e.showOnMap)return 1}}catch(e){}return 0}function Ar(e,t,o,n,r,i,a){if(!e||!t)return null;const l=n?Object.assign({},n,e):e,s={label:t.label||"Sans label",order:t.order||999};switch(t.description&&(s.description=t.description),o){case"point":s.symbol=Pr(l,r,i,a);break;case"line":s.symbol=function(e){const t=e.stroke||{},o=e.casing||{},n={type:"line",color:t.color||e.color||"#3388ff",width:t.widthPx||e.weight||3,style:"solid"};o.enabled&&o.color&&(n.outlineColor=o.color,n.outlineWidth=Math.max(.5,.4*(o.widthPx||1)),n.outlineOpacity=o.opacity||1),void 0!==t.opacity&&(n.opacity=t.opacity);const r=e.dashArray||t.dashArray;return r&&(n.dashArray=r,"5, 5"===r||"10, 10"===r?n.style="dashed":"1, 3"!==r&&"2, 4"!==r||(n.style="dotted")),n}(l);break;case"polygon":s.symbol=function(e){const t=e.fill||{},o=e.stroke||{},n={type:"polygon",fillColor:e.fillColor||e.color||t.color||"#3388ff",color:e.color||o.color||"#333",weight:e.weight||o.widthPx||1};(function(e,t){["fillOpacity"].forEach(o=>{void 0!==t[o]&&(e[o]=t[o])})})(n,e),void 0!==t.opacity&&(n.opacity=t.opacity),void 0!==e.opacity&&(n.opacity=e.opacity);const r=e.dashArray||o.dashArray;return r&&(n.dashArray=r),e.fillPattern&&(n.fillPattern=e.fillPattern),e.hatch&&(n.hatch=e.hatch),n}(l);break;default:d&&d.warn("[LegendGenerator] Type de g\xe9om\xe9trie non reconnu:",o),s.symbol=Pr(l,r,i,a)}return s}function Pr(e,t,o,n){const r=e.fill||{},i=e.stroke||{},a={type:"circle",radius:e.radius||e.size||(e.sizePx?e.sizePx/2:void 0)||24,fillColor:e.fillColor||e.color||r.color||"#3388ff",fillOpacity:void 0!==e.fillOpacity?e.fillOpacity:void 0!==r.opacity?r.opacity:1,color:e.color||i.color||"#ffffff",weight:e.weight||i.widthPx||2,opacity:void 0!==e.opacity?e.opacity:void 0!==i.opacity?i.opacity:1};if(e.useIcon&&e.iconId)a.icon=e.iconId,a.iconColor="#ffffff",d&&e.iconId;else if(t&&Er()){const e=function(e){if(!Er())return{useIcon:0,iconId:null};const t=F.getCategories?.()??{};if(!t||0===Object.keys(t).length)return{useIcon:0,iconId:null};const o={archaeological:{categoryId:"CULTURES",subCategoryId:"SITE ARCHEOLOGIQUE"},museum:{categoryId:"CULTURES",subCategoryId:"MUSEE"},camp_site:{categoryId:"HEBERGEMENT",subCategoryId:"CAMPING"},hotel:{categoryId:"HEBERGEMENT",subCategoryId:"HOTEL"}};let n=null,r=null;if(e.when&&e.when.field&&void 0!==e.when.value)if("properties.fclass"===e.when.field||"fclass"===e.when.field){const t=o[e.when.value];t&&(n=t.categoryId,r=t.subCategoryId)}else"properties.categoryId"===e.when.field||"categoryId"===e.when.field?n=e.when.value:"properties.subCategoryId"===e.when.field||"subCategoryId"===e.when.field?r=e.when.value:"properties.category"===e.when.field||"category"===e.when.field?n=e.when.value:"properties.subCategory"!==e.when.field&&"subCategory"!==e.when.field||(r=e.when.value);else e.condition&&(void 0!==e.condition.categoryId&&(n=e.condition.categoryId),void 0!==e.condition.subCategoryId&&(r=e.condition.subCategoryId),void 0!==e.condition.category&&(n=e.condition.category),void 0!==e.condition.subCategory&&(r=e.condition.subCategory));if(r&&!n&&Object.keys(t).forEach(e=>{const o=t[e];o.subcategories&&o.subcategories[r]&&(n=e)}),!n&&!r)return{useIcon:0,iconId:null};let i=null;if(r&&t[n]?.subcategories){const e=t[n].subcategories[r],o=t[n];i=e?e.icon||e.iconId||o.icon||o.iconId||null:o.icon||o.iconId||null}else if(t[n]){const e=t[n];i=e.icon||e.iconId||null}return{useIcon:null!==i,iconId:i}}(t);if(e.useIcon&&e.iconId){const t=e.iconId.startsWith("#")?e.iconId:n?n+e.iconId:"#sprite-"+e.iconId;a.icon=t,a.iconColor="#ffffff"}}if(!a.icon&&t&&o&&Er()){const e=function(e,t,o){if(!e.when||!t||!t.categories)return d&&(e.when,!t||t.categories),null;const n=e.when.field,r=e.when.value,i=t.categories,a="properties.categoryId"===n||"attributes.categoryId"===n;if("properties.subCategoryId"===n||"attributes.subCategoryId"===n)for(const e in i){const t=i[e].subcategories;if(t&&t[r]&&t[r].icon)return o+t[r].icon}return a&&i[r]&&i[r].icon?o+i[r].icon:(d&&d.warn(`[LegendGenerator] Aucune ic\xf4ne trouv\xe9e pour ${n}=${r}`),null)}(t,o,n);e&&(a.icon=e,a.iconColor="#ffffff")}return a}const Gr={generateLegendFromStyle:function(e,t,o){if(!e)return d&&d.warn("[LegendGenerator] Style data manquant"),null;const n={version:"3.0",id:e.id,title:e.label||"Sans titre",description:e.description||"",sections:[]},r=[],i=o?.icons?.symbolPrefix||"tourism-poi-cat-";if(Array.isArray(e.styleRules)&&e.styleRules.length>0&&(e.styleRules.forEach(n=>{if(!n.legend)return void(d&&d.warn("[LegendGenerator] R\xe8gle sans propri\xe9t\xe9 legend:",n));const a=Ar(n.style,n.legend,t,e.style,n,o,i);a&&r.push(a)}),r.sort(Z)),0===r.length&&e.style&&e.legend){const n=Ar(e.style,e.legend,t,null,null,o,i);n&&r.push(n)}return r.length>0&&n.sections.push({title:"",items:r}),n},generateLegendItem:Ar},Tr={street:{label:"Street",url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",options:{maxZoom:19,attribution:"&copy; OpenStreetMap contributors"}},topo:{label:"Topo",url:"https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",options:{maxZoom:17,attribution:"Map data: &copy; OpenStreetMap contributors, SRTM | Map style: &copy; OpenTopoMap"}},satellite:{label:"Satellite",url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",options:{maxZoom:19,attribution:"Tiles &copy; Esri \u2014 Source: Esri, Earthstar Geographics, and the GIS user community"}}};function xr(e){const t=Object.assign({},e.options||{});return"number"!=typeof t.minZoom&&"number"==typeof e.minZoom&&(t.minZoom=e.minZoom),"number"!=typeof t.maxZoom&&(t.maxZoom="number"==typeof e.maxZoom?e.maxZoom:19),!t.attribution&&e.attribution&&(t.attribution=e.attribution),t}const Or="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{};let Mr=null,kr=null;const Nr=Object.create(null);function Fr(){if(Mr&&"function"==typeof Mr.setView)return;const e=Or.GeoLeaf?.Utils?.MapHelpers,t=e&&"function"==typeof e.ensureMap?e.ensureMap():null;t&&(Mr=t,d.info("[GeoLeaf.Baselayers] ensureMap: acquired via MapHelpers.ensureMap()."))}function Dr(e,t){const L=Or.L;if(!e)return void d.warn("[GeoLeaf.Baselayers] registerBaseLayer appel\xe9 sans cl\xe9.");if(!t)return void d.warn("[GeoLeaf.Baselayers] D\xe9finition manquante pour la couche :",e);const o=t.id||e;let n=null;const r=t.label||o;if(t instanceof L.TileLayer)n=t;else if(t.layer&&t.layer instanceof L.TileLayer)n=t.layer;else if("maplibre"===t.type||t.style)if("function"==typeof L.maplibreGL){const e={style:t.style,attribution:t.attribution||"",interactive:0,padding:.25,maplibreOptions:{preserveDrawingBuffer:1,trackResize:1,fadeDuration:0}};n=L.maplibreGL(e),n.once("add",function(){const e=n.getMaplibreMap&&n.getMaplibreMap();e&&e.once("styledata",function(){!function(e){const t={boundary_3:{admin_level:-1,maritime:0,disputed:0},road_motorway_link:{ramp:0},road_motorway_link_casing:{ramp:0},road_link:{ramp:0},road_link_casing:{ramp:0},bridge_motorway_link:{ramp:0},bridge_motorway_link_casing:{ramp:0},tunnel_motorway_link:{ramp:0},tunnel_motorway_link_casing:{ramp:0},tunnel_link:{ramp:0},tunnel_link_casing:{ramp:0},road_one_way_arrow:{oneway:0},road_one_way_arrow_opposite:{oneway:0},label_city:{capital:0},label_city_capital:{capital:0},poi_r1:{rank:0},poi_r7:{rank:0},poi_r20:{rank:0},label_country_1:{rank:0},label_country_2:{rank:0},label_country_3:{rank:0}};function o(e,t){return Array.isArray(e)?"get"===e[0]&&2===e.length&&"string"==typeof e[1]&&Object.prototype.hasOwnProperty.call(t,e[1])?["coalesce",e,t[e[1]]]:e.map(e=>Array.isArray(e)?o(e,t):e):e}for(const[n,r]of Object.entries(t))try{if(!e.getLayer(n))continue;const t=e.getFilter(n);if(!t)continue;e.setFilter(n,o(t,r))}catch(e){}}(e)})}),d.info("[GeoLeaf.Baselayers] Basemap vectorielle MapLibre cr\xe9\xe9e :",o)}else{d.warn("[GeoLeaf.Baselayers] MapLibre GL plugin non charg\xe9. Fallback raster pour :",o);const e=t.url||t.fallbackUrl;n=e?L.tileLayer(e,xr(t)):L.tileLayer(Tr.street.url,Tr.street.options)}else{if(!t.url)return void d.warn("[GeoLeaf.Baselayers] D\xe9finition invalide pour la couche :",o,"(aucune url / aucun layer fourni)");n=L.tileLayer(t.url,xr(t))}Nr[o]={key:o,label:r,layer:n}}function Ur(e){e&&"object"==typeof e?Object.keys(e).forEach(t=>Dr(t,e[t])):d.warn("[GeoLeaf.Baselayers] registerBaseLayers attend un objet de d\xe9finitions.")}function Rr(e,t){if(t=t||{},!e)return void d.warn("[GeoLeaf.Baselayers] setBaseLayer appel\xe9 sans cl\xe9.");const o=kr;if(Fr(),d.info("[GeoLeaf.Baselayers] setBaseLayer:",e,"_map=",!!Mr),!Mr)return void d.warn("[GeoLeaf.Baselayers] Aucun L.Map disponible.");if(!Nr[e]){d.warn("[GeoLeaf.Baselayers] Couche inconnue :",e);const t=Object.keys(Nr);return void(!o&&t.length>0&&Rr(t[0],{silent:1}))}if(kr===e)return;if(o&&Nr[o]){const e=Nr[o].layer;try{e&&Mr&&"function"==typeof Mr.hasLayer&&Mr.hasLayer(e)&&Mr.removeLayer(e)}catch(e){d.warn("[GeoLeaf.Baselayers] Impossible de retirer la couche pr\xe9c\xe9dente:",e)}}const n=Nr[e].layer;if(n&&"function"==typeof n.addTo){try{n.addTo(Mr)}catch(e){return void d.error("[GeoLeaf.Baselayers] Impossible d'ajouter la couche:",e)}kr=e,d.info("[GeoLeaf.Baselayers] Couche active :",e),t.silent||function(e,t,o){if("undefined"==typeof document||"function"!=typeof document.dispatchEvent)return;const n={key:e,previousKey:t,map:Mr,layer:o,source:"geoleaf.baselayers"};try{document.dispatchEvent(new CustomEvent("geoleaf:basemap:change",{detail:n}))}catch(e){d.warn("[GeoLeaf.Baselayers] Impossible d'\xe9mettre geoleaf:basemap:change.",e)}}(e,o,n)}else d.error("[GeoLeaf.Baselayers] Couche invalide pour la cl\xe9:",e)}function jr(){return Object.assign({},Nr)}function $r(){return kr}const Br="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{};let zr=0,Vr=null;function qr(){if(!Br.document)return;const e=Br.document.querySelectorAll("[data-gl-baselayer]"),t=Br.document.getElementById("gl-left-panel"),o=$r();let n=null;e.forEach(e=>{const t=e.getAttribute("data-gl-baselayer");if(!t)return;const r=t===o;e.classList.toggle("gl-baselayer-active",r),e.classList.toggle("is-active",r),e.setAttribute("aria-pressed",String(r)),r&&(n=e)}),t&&n&&function(e,t){if(!e||!t)return;const o=e.getBoundingClientRect(),n=t.getBoundingClientRect();e.style.setProperty("--indicator-left",n.left-o.left+"px"),e.style.setProperty("--indicator-width",n.width+"px")}(t,n)}const Jr={init:function(e){var t;if((e=e||{}).map?(t=e.map,Mr=t):Fr(),Or.L&&Object.keys(Tr).forEach(e=>{Nr[e]||Dr(e,Tr[e])}),e.baselayers&&"object"==typeof e.baselayers&&Ur(e.baselayers),e.activeKey&&Rr(e.activeKey,{silent:1}),!$r()){const e=Object.keys(jr());e.length>0&&Rr(e[0],{silent:1})}return function(e){if(!Br.document)return;!e&&Br.GeoLeaf?.Config?.get&&(e={ui:Br.GeoLeaf.Config.get("ui"),basemaps:Br.GeoLeaf.Config.get("basemaps")||{}});const t=e&&e.ui,o=t&&0==t.showBaseLayerControls?0:!!t;d.info("[GeoLeaf.Baselayers] showBaseLayerControls =",o,"(config.ui.showBaseLayerControls =",t?t.showBaseLayerControls:"N/A",")");let n=Br.document.getElementById("gl-left-panel");o?(n||(n=Br.document.createElement("div"),n.id="gl-left-panel",n.className="gl-left-panel",(Br.document.getElementById("geoleaf-map")||Br.document.querySelector(".gl-map")||Br.document.body).appendChild(n)),Br.GeoLeaf?.DOMSecurity?.clearElementFast?Br.GeoLeaf.DOMSecurity.clearElementFast(n):n.innerHTML="",Object.keys(Nr).forEach(e=>{const t=Nr[e],o=Br.document.createElement("button");o.className="gl-baselayer-btn",o.setAttribute("data-gl-baselayer",e),o.setAttribute("aria-label",t.label||e),o.textContent=t.label||e,n.appendChild(o)}),n.style.display="flex",d.info("[GeoLeaf.Baselayers] Contr\xf4les cr\xe9\xe9s avec",Object.keys(Nr).length,"boutons"),setTimeout(qr,50)):n&&n.parentNode&&n.parentNode.removeChild(n)}(e),function(){if(zr||!Br.document)return;let e;zr=1,Br.document.addEventListener("click",e=>{const t=e.target.closest("[data-gl-baselayer]");if(!t)return;const o=t.getAttribute("data-gl-baselayer");o&&(e.preventDefault(),Rr(o),qr())}),Vr=()=>{clearTimeout(e),e=setTimeout(qr,100)},Br.addEventListener("resize",Vr)}(),qr(),{activeKey:$r(),layers:jr()}},registerBaseLayer:Dr,registerBaseLayers:Ur,setBaseLayer:Rr,setActive:Rr,getBaseLayers:jr,getActiveKey:$r,getActiveId:$r,getActiveLayer:function(){return kr&&Nr[kr]?Nr[kr].layer:null},destroy:function(){Vr&&(Br.removeEventListener("resize",Vr),Vr=null),zr=0}},Hr={render(e,t){if(!e||!t)return;const o=globalThis.L.DomUtil.create("div","gl-layer-manager__items gl-layer-manager__basemap-select",t),n=globalThis.L.DomUtil.create("select","gl-layer-manager__basemap-select__select",o);Array.isArray(e.items)&&e.items.forEach(function(e){if(!e||!e.id)return;const t=document.createElement("option");t.value=e.id,t.textContent=e.label||e.id,n.appendChild(t)});try{const e=Jr&&"function"==typeof Jr.getActiveKey?Jr.getActiveKey():null;e&&(n.value=e)}catch(e){}this._attachChangeHandler(n),this._attachExternalListener(n)},_attachChangeHandler(e){const t=function(t){globalThis.L&&globalThis.L.DomEvent&&globalThis.L.DomEvent.stopPropagation(t);try{const t=e.value;Jr&&"function"==typeof Jr.setBaseLayer&&Jr.setBaseLayer(t)}catch(e){d&&d.warn("Erreur lors du changement de basemap depuis la l\xe9gende:",e)}};globalThis.L&&globalThis.L.DomEvent?globalThis.L.DomEvent.on(e,"change",t):e.addEventListener("change",t)},_attachExternalListener(e){"undefined"!=typeof document&&(this._externalHandler=function(t){try{t&&t.detail&&t.detail.key&&(e.value=t.detail.key)}catch(e){}},document.addEventListener("geoleaf:basemap:change",this._externalHandler))},destroy(){this._externalHandler&&(document.removeEventListener("geoleaf:basemap:change",this._externalHandler),this._externalHandler=null)}},Zr={ERROR:3,WARNING:2,SUCCESS:1,INFO:1};class NotificationSystem{constructor(){this.container=null,this.maxVisible=3,this.maxPersistent=2,this.durations={success:3e3,error:5e3,warning:4e3,info:3e3},this.config={enabled:1,position:"bottom-center",animations:1},this._eventManager=null,this._timerManager=null,this._activeToasts=new Map,this._queue=[],this._maxQueueSize=15}init(e={}){return this.config={...this.config,...e},this.maxVisible=e.maxVisible||3,this.durations={...this.durations,...e.durations},this.container=document.querySelector(e.container||"#gl-notifications"),this.container?(e.position&&(this.container.className=`gl-notifications gl-notifications--${e.position}`),this._eventManager=ue?ue.createManager("notifications"):null,this._timerManager=new TimerManager("notifications"),1):(d&&d.warn("[GeoLeaf Notifications] Container introuvable:",e.container),0)}show(e,t="info",o){let n={};return n="string"==typeof t?{type:t,duration:o}:"object"==typeof t&&null!==t?t:{type:"info"},this._enqueue(e,n)}success(e,t){return"number"==typeof t?this.show(e,"success",t):"object"==typeof t?this.show(e,{...t,type:"success"}):this.show(e,"success")}error(e,t){return"number"==typeof t?this.show(e,"error",t):"object"==typeof t?this.show(e,{...t,type:"error"}):this.show(e,"error")}warning(e,t){return"number"==typeof t?this.show(e,"warning",t):"object"==typeof t?this.show(e,{...t,type:"warning"}):this.show(e,"warning")}info(e,t){return"number"==typeof t?this.show(e,"info",t):"object"==typeof t?this.show(e,{...t,type:"info"}):this.show(e,"info")}_enqueue(e,t){const o=t.type||"info",n=Zr[o.toUpperCase()]||Zr.INFO,r={message:e,options:{type:o,duration:t.duration,persistent:t.persistent||0,dismissible:0!=t.dismissible,icon:t.icon,action:t.action},priority:n,timestamp:Date.now()};if(this._queue.length>=this._maxQueueSize){const e=this._queue.reduce((e,t,o,n)=>{const r=n[e];return t.priority<r.priority||t.priority===r.priority&&t.timestamp<r.timestamp?o:e},0);if(!(r.priority>this._queue[e].priority))return void(d&&d.warn("[GeoLeaf Notifications] Queue pleine, notification rejet\xe9e"));this._queue.splice(e,1),d&&d.warn("[GeoLeaf Notifications] Queue pleine, notification dropp\xe9e")}return this._queue.push(r),this._queue.sort((e,t)=>t.priority!==e.priority?t.priority-e.priority:e.timestamp-t.timestamp),this._processQueue()}_processQueue(){if(!this.container||!this.config.enabled||0===this._queue.length)return null;const e=this.container.querySelectorAll(".gl-toast:not(.gl-toast--removing)"),t=Array.from(e).filter(e=>!e.dataset.persistent),o=Array.from(e).filter(e=>e.dataset.persistent);let n=null;for(;this._queue.length>0;){const e=this._queue[0],r=e.options.persistent;if(!(r?o.length<this.maxPersistent:t.length<this.maxVisible)){if(!(e.priority===Zr.ERROR&&t.length>0))break;{const e=t.find(e=>e.classList.contains("gl-toast--info")||e.classList.contains("gl-toast--success"))||t[0];this._remove(e,1)}}const i=this._queue.shift();n=this._showImmediate(i.message,i.options),r?o.push(null):t.push(null)}return n}_showImmediate(e,t){const o=t.type||"info",n=t.duration||this.durations[o],r=t.persistent||0,i=0!=t.dismissible,a=te("div",{className:`gl-toast gl-toast--${o}`,attributes:{role:"alert","aria-live":"error"===o||t.priority===Zr.ERROR?"assertive":"polite"}});r&&(a.dataset.persistent="true");const l=te("span",{className:"gl-toast__message",textContent:e});if(a.appendChild(l),i){const e=te("button",{className:"gl-toast__close",attributes:{"aria-label":"Fermer la notification",title:"Fermer"},textContent:"\xd7",onClick:()=>{this._remove(a,0)}});a.appendChild(e)}if(this.container.appendChild(a),this.config.animations?requestAnimationFrame(()=>{requestAnimationFrame(()=>{a.classList.add("gl-toast--visible")})}):a.classList.add("gl-toast--visible"),!r)if(this._timerManager)a.dataset.timerId=this._timerManager.setTimeout(()=>{this._remove(a,0)},n);else{const e=setTimeout(()=>{this._remove(a,0)},n);a.dataset.timeoutId=e}return a}_remove(e,t=0){if(!e||e.classList.contains("gl-toast--removing"))return;e.dataset.timeoutId&&(clearTimeout(parseInt(e.dataset.timeoutId)),delete e.dataset.timeoutId),e.dataset.timerId&&this._timerManager&&(this._timerManager.clearTimeout(e.dataset.timerId),delete e.dataset.timerId),e.classList.add("gl-toast--removing"),e.classList.remove("gl-toast--visible"),t&&this.config.animations&&e.classList.add("gl-toast--sliding-up");const o=this.config.animations?200:0,n=()=>{e.parentNode&&e.remove(),this._processQueue()};this._timerManager?this._timerManager.setTimeout(n,o):setTimeout(n,o)}clearAll(){this.container&&(this.container.querySelectorAll(".gl-toast").forEach(e=>this._remove(e,0)),this._queue=[])}dismiss(e){e&&this._remove(e,0)}disable(){this.config.enabled=0}enable(){this.config.enabled=1,this._processQueue()}destroy(){this._timerManager&&(this._timerManager.destroy(),this._timerManager=null),this._eventManager&&(this._eventManager.destroy(),this._eventManager=null),this.container&&this.container.querySelectorAll(".gl-toast").forEach(e=>e.remove()),this._queue=[],this._activeToasts.clear(),this.container=null,this.config.enabled=0,d&&d.info("[GeoLeaf Notifications] Syst\xe8me d\xe9truit et nettoy\xe9")}getStatus(){const e=this.container?this.container.querySelectorAll(".gl-toast:not(.gl-toast--removing)"):[],t=Array.from(e).filter(e=>!e.dataset.persistent),o=Array.from(e).filter(e=>e.dataset.persistent);return{enabled:this.config.enabled,initialized:!!this.container,activeToasts:e.length,temporaryToasts:t.length,persistentToasts:o.length,queued:this._queue.length,maxVisible:this.maxVisible,maxPersistent:this.maxPersistent,position:this.config.position}}}const Wr=new NotificationSystem,Xr={generateSection(){return{id:"offline-cache",label:"\u{1f4e5} Cache Hors Ligne",order:98,collapsedByDefault:0,customContent:this._generateContent(),init:()=>this._attachEventListeners()}},_generateContent:()=>'\n            <div class="gl-cache-section">\n                <div class="gl-cache-status">\n                    <div class="gl-cache-status__header">\n                        <span class="gl-cache-status__icon">\u{1f4be}</span>\n                        <span class="gl-cache-status__label">Statut</span>\n                    </div>\n                    <div class="gl-cache-status__info">\n                        <div class="gl-cache-status__row">\n                            <span class="gl-cache-status__key">Profil:</span>\n                            <span class="gl-cache-status__value" id="gl-cache-profile">-</span>\n                        </div>\n                        <div class="gl-cache-status__row">\n                            <span class="gl-cache-status__key">\xc9tat:</span>\n                            <span class="gl-cache-status__value" id="gl-cache-state">Non t\xe9l\xe9charg\xe9</span>\n                        </div>\n                        <div class="gl-cache-status__row">\n                            <span class="gl-cache-status__key">Taille:</span>\n                            <span class="gl-cache-status__value" id="gl-cache-size">0 MB</span>\n                        </div>\n                        <div class="gl-cache-status__row">\n                            <span class="gl-cache-status__key">Quota:</span>\n                            <span class="gl-cache-status__value" id="gl-cache-quota">0 MB disponible</span>\n                        </div>\n                    </div>\n                </div>\n\n                <div class="gl-cache-actions">\n                    <button\n                        id="gl-cache-download"\n                        class="gl-btn gl-btn--primary gl-cache-btn"\n                        title="T\xe9l\xe9charger le profil pour usage offline">\n                        <span class="gl-btn__icon">\u2b07\ufe0f</span>\n                        <span class="gl-btn__text">T\xe9l\xe9charger profil</span>\n                    </button>\n\n                    <button\n                        id="gl-cache-clear"\n                        class="gl-btn gl-btn--secondary gl-cache-btn"\n                        title="Effacer le cache du profil"\n                        disabled>\n                        <span class="gl-btn__icon">\u{1f5d1}\ufe0f</span>\n                        <span class="gl-btn__text">Vider cache</span>\n                    </button>\n                </div>\n\n                <div class="gl-cache-progress" id="gl-cache-progress" style="display: none;">\n                    <div class="gl-cache-progress__bar">\n                        <div class="gl-cache-progress__fill" id="gl-cache-progress-fill"></div>\n                    </div>\n                    <div class="gl-cache-progress__text" id="gl-cache-progress-text">\n                        T\xe9l\xe9chargement en cours...\n                    </div>\n                </div>\n            </div>\n        ',_attachEventListeners(){const e=document.getElementById("gl-cache-download"),t=document.getElementById("gl-cache-clear");e&&e.addEventListener("click",()=>this._handleDownload()),t&&t.addEventListener("click",()=>this._handleClear()),this._updateStatus(),document.addEventListener("geoleaf:cache:completed",()=>this._updateStatus()),document.addEventListener("geoleaf:cache:cleared",()=>this._updateStatus()),document.addEventListener("geoleaf:profile:loaded",()=>this._updateStatus())},async _updateStatus(){if(zn.isAvailable())try{const e=F.get("data.activeProfile",""),t=await zn.CacheManager.getCacheStatus(e),o=await zn.CacheManager.getStorageQuota(),n=document.getElementById("gl-cache-profile"),r=document.getElementById("gl-cache-state"),i=document.getElementById("gl-cache-size"),a=document.getElementById("gl-cache-quota"),l=document.getElementById("gl-cache-clear");n&&(n.textContent=e||"-"),t&&t.resourcesCount>0?(r&&(r.textContent="\u2705 T\xe9l\xe9charg\xe9",r.style.color="#22c55e"),i&&(i.textContent=`${(t.totalSize/1024/1024).toFixed(2)} MB`),l&&(l.disabled=0)):(r&&(r.textContent="\u274c Non t\xe9l\xe9charg\xe9",r.style.color="#ef4444"),i&&(i.textContent="0 MB"),l&&(l.disabled=1)),a&&(a.textContent=`${(o.available/1024/1024).toFixed(2)} MB disponible`)}catch(e){d.error(`[CacheSection] Failed to update status: ${e.message}`)}},async _handleDownload(){if(!zn.isAvailable())return void Wr.error("Stockage offline non disponible",5e3);const e=F.get("data.activeProfile","");if(!e)return void Wr.error("Aucun profil actif",3e3);const t=document.getElementById("gl-cache-download"),o=document.getElementById("gl-cache-progress"),n=document.getElementById("gl-cache-progress-text");try{t&&(t.disabled=1,t.querySelector(".gl-btn__text").textContent="T\xe9l\xe9chargement..."),o&&(o.style.display="block"),n&&(n.textContent="Pr\xe9paration..."),d.info(`[CacheSection] Starting download for profile: ${e}`);const r=await zn.downloadProfileForOffline(e);n&&(n.textContent=`\u2705 ${r.resourcesCount} ressources t\xe9l\xe9charg\xe9es`),Wr.success(`Profil t\xe9l\xe9charg\xe9 : ${(r.totalSize/1024/1024).toFixed(2)} MB`,4e3),setTimeout(()=>{o&&(o.style.display="none")},2e3),await this._updateStatus()}catch(e){d.error(`[CacheSection] Download failed: ${e.message}`),n&&(n.textContent=`\u274c Erreur: ${e.message}`),Wr.error(`Erreur t\xe9l\xe9chargement: ${e.message}`,5e3),setTimeout(()=>{o&&(o.style.display="none")},3e3)}finally{t&&(t.disabled=0,t.querySelector(".gl-btn__text").textContent="T\xe9l\xe9charger profil")}},async _handleClear(){if(!zn.isAvailable())return;const e=F.get("data.activeProfile","");if(!e)return;if(!confirm(`Voulez-vous vraiment effacer le cache du profil "${e}" ?`))return;const t=document.getElementById("gl-cache-clear");try{t&&(t.disabled=1,t.querySelector(".gl-btn__text").textContent="Effacement..."),d.info(`[CacheSection] Clearing cache for profile: ${e}`);const o=await zn.CacheManager.clearCache(e);Wr.success(`Cache effac\xe9 : ${o} ressources supprim\xe9es`,3e3),await this._updateStatus()}catch(e){d.error(`[CacheSection] Clear failed: ${e.message}`),Wr.error(`Erreur effacement: ${e.message}`,5e3)}finally{t&&(t.querySelector(".gl-btn__text").textContent="Vider cache")}}},Yr="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{};Yr.GeoLeaf=Yr.GeoLeaf||{};let Qr=null,Kr=null,ei={},ti=null,oi=null,ni=null,ri=null,ii=null;const ai=new Map;function li(){ni&&clearTimeout(ni),ni=setTimeout(()=>{ni=null,ui._rebuildDisplay()},150)}function si(){ii&&(clearTimeout(ii),ii=null)}function ci(){si(),ri&&ri.parentElement&&ri.parentElement.removeChild(ri),Kr&&Kr._container&&(Kr._container.removeAttribute("aria-busy"),Kr._container.removeAttribute("aria-live"))}const ui={init:function(e,t){if(!e)return d&&d.error("[Legend] Carte Leaflet requise pour initialiser Legend"),0;if(Qr=e,Yr.GeoLeaf.Config&&"function"==typeof Yr.GeoLeaf.Config.get){const e=Yr.GeoLeaf.Config.get("legendConfig");if(ei=Object.assign({position:e&&e.position||"bottomleft",collapsible:1,collapsed:e&&e.collapsedByDefault||0,title:e&&e.title||"L\xe9gende"},t||{}),"function"==typeof Yr.GeoLeaf.Config.getActiveProfile)ti=Yr.GeoLeaf.Config.getActiveProfile();else{const e=Yr.GeoLeaf.Config.getAll();ti={id:e.id||Yr.GeoLeaf.Config.get("id"),layers:e.layers||Yr.GeoLeaf.Config.get("layers")||[]}}}else ei=Object.assign({position:"bottomleft",collapsible:1,collapsed:0,title:"L\xe9gende"},t||{});return this._loadTaxonomy(),this._initializeAllLayers(),d&&d.info("[Legend] Module Legend initialis\xe9 avec g\xe9n\xe9ration automatique depuis styles"),1},_loadTaxonomy:function(){if(!ti)return;const e=Yr.GeoLeaf.Config,t=e&&e.get?e.get("data"):null,o=t&&t.profilesBasePath||"profiles",n=ti.id;n?fetch(`${o}/${n}/taxonomy.json`).then(e=>{if(!e.ok)throw new Error(`HTTP ${e.status}`);return e.json()}).then(e=>{oi=e}).catch(e=>{d&&d.warn(`[Legend] Erreur chargement taxonomy: ${e.message}`)}):d&&d.warn("[Legend] Impossible de charger taxonomy sans profileId")},_initializeAllLayers:function(){ti&&Array.isArray(ti.layers)?(ti.layers.forEach((e,t)=>{ai.set(e.id,{label:e.id,styleId:null,legendData:null,visible:0,order:t+1,geometryType:null,configFile:e.configFile})}),d&&ai.size):d&&d.warn("[Legend] Aucune couche d\xe9finie dans le profil")},loadLayerLegend:function(e,t,o){if(!Qr)return void(d&&d.warn("[Legend] Module non initialis\xe9"));const n=ai.get(e);if(!n)return void(d&&d.warn(`[Legend] Couche ${e} non trouv\xe9e dans le profil`));Yr.GeoLeaf._POIMarkers&&"function"==typeof Yr.GeoLeaf._POIMarkers.ensureProfileSpriteInjectedSync&&Yr.GeoLeaf._POIMarkers.ensureProfileSpriteInjectedSync(),n.label=o.label||e,n.geometryType=function(e){const t=e.toLowerCase();return"polyline"===t||"line"===t?"line":"polygon"===t?"polygon":"point"}(o.geometryType||o.geometry||n.geometryType||"point"),n.styleId=t;const r=Yr.GeoLeaf.Config,i=r&&r.get?r.get("data"):null,a=i&&i.profilesBasePath||"profiles",l=o._profileId||ti.id,s=o._layerDirectory;if(!o.styles||!o.styles.directory)return void(d&&d.warn(`[Legend] Configuration styles manquante pour ${e}`));const c=`${a}/${l}/${s}/${o.styles.directory}/${o.styles.available?.find(e=>e.id===t)?.file||o.styles.default}`;fetch(c).then(e=>{if(!e.ok)throw new Error(`HTTP ${e.status}`);return e.json()}).then(t=>{if(!Yr.GeoLeaf._LegendGenerator)return void(d&&d.error("[Legend] LegendGenerator non disponible"));const r=Yr.GeoLeaf._POIShared;void 0!==o.showIconsOnMap&&(Yr.GeoLeaf._POIShared={state:{poiConfig:{showIconsOnMap:o.showIconsOnMap}}});const i=Yr.GeoLeaf._LegendGenerator.generateLegendFromStyle(t,n.geometryType,oi);void 0!==o.showIconsOnMap&&(Yr.GeoLeaf._POIShared=r),i&&(n.legendData=i,ai.set(e,n),li())}).catch(e=>{d&&d.warn(`[Legend] Erreur chargement style: ${e.message}`)})},setLayerVisibility:function(e,t){const o=ai.get(e);o&&(o.visible=t,ai.set(e,o),li())},_rebuildDisplay:function(){if(Qr)if(0!==ai.size){if(Kr||(Kr=Yr.GeoLeaf._LegendControl.create(ei),Kr&&Qr.addControl(Kr)),Kr&&"function"==typeof Kr.updateMultiLayerContent){const e=Yr.GeoLeaf._LayerVisibilityManager,t=[];ai.forEach((o,n)=>{if(!o.legendData)return;const r=e&&"function"==typeof e.getVisibilityState?e.getVisibilityState(n):null;(r?r.current:o.visible)&&t.push({layerId:n,label:o.label,collapsed:1,order:o.order,visible:1,sections:o.legendData.sections||[]})}),t.sort((e,t)=>e.order-t.order),Kr.updateMultiLayerContent(t);const o=t.some(e=>e.sections.some(e=>e.items&&e.items.some(e=>e.icon)));o&&(document.querySelector('svg[data-geoleaf-sprite="profile"]')||(d&&d.info("[Legend] Ic\xf4nes d\xe9tect\xe9es mais sprite manquant - programmation retry"),setTimeout(()=>{document.querySelector('svg[data-geoleaf-sprite="profile"]')&&d&&(d.info("[Legend] Sprite disponible - nouveau rendu de la l\xe9gende"),this._rebuildDisplay())},2e3)))}}else Kr&&Qr&&(Qr.removeControl(Kr),Kr=null)},toggleAccordion:function(){},getAllLayers:function(){return ai},hideLegend:function(){Kr&&Kr.hide()},removeLegend:function(){ai.forEach(e=>{e.legendData=null,e.visible=0}),Kr&&Qr&&(Qr.removeControl(Kr),Kr=null)},isLegendVisible:function(){return null!==Kr&&ai.size>0},showLoadingOverlay:function(){!function(){if(!Kr||!Kr._container)return;!function(){if(document.getElementById("gl-legend-spinner-style"))return;const e=document.createElement("style");e.id="gl-legend-spinner-style",e.textContent="@keyframes gl-legend-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }",document.head.appendChild(e)}(),si();const e=Kr._container;if(e.style.position||(e.style.position="relative"),!ri){const e=document.createElement("div");e.className="gl-map-legend__loading-overlay",e.style.position="absolute",e.style.inset="0",e.style.background="rgba(255,255,255,0.6)",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.pointerEvents="auto",e.style.zIndex="2",e.setAttribute("aria-hidden","false");const t=document.createElement("div");t.className="gl-map-legend__spinner",t.style.width="34px",t.style.height="34px",t.style.border="3px solid rgba(0,0,0,0.12)",t.style.borderTop="3px solid rgba(0,0,0,0.55)",t.style.borderRadius="50%",t.style.animation="gl-legend-spin 1s linear infinite",e.appendChild(t),ri=e}ri.parentElement||e.appendChild(ri),e.setAttribute("aria-busy","true"),e.setAttribute("aria-live","polite"),ii=setTimeout(()=>{ii=null,ci()},12e3)}()},hideLoadingOverlay:function(){ci()}},di=ui,fi={isAvailable:()=>!!di&&"function"==typeof di.loadLayerLegend,loadLayerLegend(e,t,o){"function"==typeof di.loadLayerLegend&&di.loadLayerLegend(e,t,o)},setLayerVisibility(e,t){"function"==typeof di.setLayerVisibility&&di.setLayerVisibility(e,t)}},pi={currentStyles:new Map},gi={getCurrentStyle:function(e){return pi.currentStyles.get(e)||null},setCurrentStyle:function(e,t){pi.currentStyles.set(e,t)},renderDOM:function(e){if(!e.styles||!Array.isArray(e.styles.available)||e.styles.available.length<=1)return null;const t=this.getCurrentStyle(e.id)||e.styles.default||e.styles.available[0].id,o="style-selector-"+e.id,n=document.createElement("div");n.className="gl-layer-manager__style-selector";const r=document.createElement("select");return r.id=o,r.className="gl-layer-manager__style-select",r.setAttribute("data-layer-id",e.id),e.styles.available.forEach(function(e){const o=document.createElement("option");o.value=e.id,o.textContent=e.label,e.id===t&&(o.selected=1),r.appendChild(o)}),n.appendChild(r),n},bindEvents:function(e,t){if(!t.styles||!Array.isArray(t.styles.available)||t.styles.available.length<=1)return;const o="style-selector-"+t.id,n=e.querySelector("#"+o);if(!n)return;const r=this;n.addEventListener("change",function(){const e=this.value,t=this.getAttribute("data-layer-id");r.setCurrentStyle(t,e),r.applyStyle(t,e)})},applyStyle:async function(e,t){if(!Mo)return;const o=Mo.getLayerData(e);if(!o)return;if(!o.config.styles||!Array.isArray(o.config.styles.available))return;const n=o.config.styles.available.find(function(e){return e.id===t});if(n)try{if(!wt)return void this._applyStyleLegacy(e,t,o,n);const r=o.config._profileId,i=o.config._layerDirectory;if(!r||!i)return;const a=await wt.loadAndValidateStyle(r,e,t,n.file,i);o.currentStyle=a.styleData,o.currentStyleMetadata=a.metadata,"function"==typeof Mo.setLayerStyle&&Mo.setLayerStyle(e,a.styleData),Zo&&"function"==typeof Zo.initializeLayerLabels&&Zo.initializeLayerLabels(e),Wo&&Wo.syncImmediate(e),fi.isAvailable()&&fi.loadLayerLegend(o.config.id,t,o.config)}catch(e){}},_applyStyleLegacy:function(e,t,o,n){const r=o.config._profileId,i=o.config._layerDirectory;if(!r||!i)return;const a=F.get?F.get("data"):null,l=(a&&a.profilesBasePath||"profiles")+"/"+r+"/"+i+"/"+(o.config.styles.directory||"styles")+"/"+n.file;fetch(l).then(function(e){if(!e.ok)throw new Error("Erreur HTTP "+e.status);return e.json()}).then(function(n){"function"==typeof Mo.setLayerStyle&&Mo.setLayerStyle(e,n),fi.isAvailable()&&fi.loadLayerLegend(o.config.id,t,o.config)}).catch(function(){})}},hi="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{};hi.GeoLeaf=hi.GeoLeaf||{};const yi={_map:null,_control:null,_refreshTimeout:null,_options:{position:"bottomright",title:"Gestionnaire de couches",collapsible:1,collapsed:0,sections:[]},init(e={}){if(void 0===hi.L||!hi.L||!hi.L.Control)return d&&d.error("[GeoLeaf.LayerManager] Leaflet (L.Control) est requis mais introuvable."),null;let t=e.map||null;return!t&&hi.GeoLeaf.Core&&"function"==typeof hi.GeoLeaf.Core.getMap&&(t=hi.GeoLeaf.Core.getMap()),t?(this._map=t,d&&d.info("[GeoLeaf.LayerManager] init: map assigned"),this._options=this._mergeOptions(this._options,e),this._loadConfigSections(),this._autoPopulateBasemap(),this._autoPopulateSections(),hi.GeoLeaf._LayerManagerControl?(this._control=hi.GeoLeaf._LayerManagerControl.create(this._options),this._control?(this._control.addTo(this._map),d&&d.info("[GeoLeaf.LayerManager] Contr\xf4le cr\xe9\xe9 et ajout\xe9 \xe0 la carte"),this._control):(d&&d.error("[GeoLeaf.LayerManager] \xc9chec cr\xe9ation contr\xf4le"),null)):(d&&d.error("[GeoLeaf.LayerManager] Module _LayerManagerControl non charg\xe9"),null)):(d&&d.error("[GeoLeaf.LayerManager] Aucune carte Leaflet disponible. Passe une instance dans init({ map })."),null)},_loadConfigSections(){if(hi.GeoLeaf.Config&&"function"==typeof hi.GeoLeaf.Config.get){const e=hi.GeoLeaf.Config.get("layerManagerConfig");if(hi.GeoLeaf.Log&&hi.GeoLeaf.Log.debug("[LayerManager] Configuration charg\xe9e:",{title:e?.title,collapsed:e?.collapsedByDefault,sectionsCount:e?.sections?.length||0}),e&&(e.title&&(this._options.title=e.title),"boolean"==typeof e.collapsedByDefault&&(this._options.collapsed=e.collapsedByDefault),Array.isArray(e.sections)&&e.sections.length>0)){const t=e.sections.slice().sort((e,t)=>(e.order||0)-(t.order||0)).map(e=>({id:e.id,label:e.label,order:e.order,collapsedByDefault:e.collapsedByDefault,items:[]}));Array.isArray(this._options.sections)||(this._options.sections=[]),t.forEach(e=>{const t=this._options.sections.find(t=>t.id===e.id);t?e.label&&!t.label&&(t.label=e.label):this._options.sections.push(e)}),this._options.sections.sort((e,t)=>(e.order||0)-(t.order||0)),d&&d.info("[GeoLeaf.LayerManager] Sections fusionn\xe9es avec layerManagerConfig")}}},_autoPopulateBasemap(){if(!Array.isArray(this._options.sections))return;const e=this._options.sections.find(e=>"basemap"===e.id);if(e&&(!e.items||0===e.items.length))try{let t=null;hi.GeoLeaf&&hi.GeoLeaf.Baselayers&&"function"==typeof hi.GeoLeaf.Baselayers.getBaseLayers?t=hi.GeoLeaf.Baselayers.getBaseLayers()||{}:hi.GeoLeaf.Config&&"function"==typeof hi.GeoLeaf.Config.get&&(t=hi.GeoLeaf.Config.get("basemaps")||{}),t&&Object.keys(t).length>0&&(e.items=Object.keys(t).map(e=>{const o=t[e]||{};return{id:o.id||e,label:o.label||e}}),d&&d.info("[GeoLeaf.LayerManager] Section basemap remplie automatiquement"))}catch(e){d&&d.warn("[GeoLeaf.LayerManager] Erreur lors du remplissage automatique des basemaps:",e)}},_autoPopulateSections(){if(Array.isArray(this._options.sections)&&this._options.sections.length>0)return;const e=[];try{if(hi.GeoLeaf&&hi.GeoLeaf.Baselayers&&"function"==typeof hi.GeoLeaf.Baselayers.getBaseLayers){const t=hi.GeoLeaf.Baselayers.getBaseLayers()||{},o=Object.keys(t).map(e=>({id:e,label:(t[e]||{}).label||e}));o.length&&e.push({id:"basemap",label:"Fond de carte",items:o})}}catch(e){}e.length?(this._options.sections=e,d&&d.info("[GeoLeaf.LayerManager] auto-populated sections from Baselayers")):d&&d.warn("[GeoLeaf.LayerManager] Aucune section fournie et autoremplissage impossible.")},_registerGeoJsonLayer(e,t={}){this._options.sections||(this._options.sections=[]);const o=t.layerManagerId||t.legendSection||"geojson-default";let n=this._options.sections.find(e=>e.id===o);n||(n={id:o,label:t.legendSectionLabel||"Couches GeoJSON",order:10,items:[]},this._options.sections.push(n),this._options.sections.sort((e,t)=>(e.order||0)-(t.order||0))),n.items.find(t=>t.id===e)||(n.items.push({id:e,label:t.label||e,toggleable:1,themes:t.themes||null,styles:t.styles||null,labels:t.labels||null}),this._updateContent())},_unregisterGeoJsonLayer(e){Array.isArray(this._options.sections)&&(this._options.sections.forEach(t=>{Array.isArray(t.items)&&(t.items=t.items.filter(t=>t.id!==e))}),this._options.sections=this._options.sections.filter(e=>"basemap"===e.id||Array.isArray(e.items)&&e.items.length>0),this._updateContent())},updateSections(e){Array.isArray(e)?(this._options.sections=e,this._updateContent()):d&&d.warn("[GeoLeaf.LayerManager] updateSections: sections doit \xeatre un tableau")},addSection(e){if(!e||!e.id)return void(d&&d.warn("[GeoLeaf.LayerManager] addSection: section invalide (id manquant)"));Array.isArray(this._options.sections)||(this._options.sections=[]);const t=this._options.sections.findIndex(t=>t.id===e.id);if(-1!==t){const o=this._options.sections[t];Array.isArray(e.items)&&(Array.isArray(o.items)||(o.items=[]),e.items.forEach(e=>{const t=o.items.findIndex(t=>t.id===e.id);-1!==t?o.items[t]=Object.assign({},o.items[t],e):o.items.push(e)}),o.items.sort((e,t)=>(e.order||0)-(t.order||0))),e.label&&(o.label=e.label),void 0!==e.order&&(o.order=e.order),void 0!==e.collapsedByDefault&&(o.collapsedByDefault=e.collapsedByDefault)}else this._options.sections.push({id:e.id,label:e.label||e.id,order:e.order||99,collapsedByDefault:e.collapsedByDefault||0,items:e.items||[]}),this._options.sections.sort((e,t)=>(e.order||0)-(t.order||0));this._updateContent(),d&&e.id},toggleCollapse(){this._options.collapsed=!this._options.collapsed,this._control&&(this._options.collapsed?this._control._container.classList.add("gl-layer-manager--collapsed"):this._control._container.classList.remove("gl-layer-manager--collapsed"))},isCollapsed(){return!!this._options.collapsed},_updateContent(){this._control&&"function"==typeof this._control.updateSections&&this._control.updateSections(this._options.sections||[])},refresh(e=0){if(this._control&&"function"==typeof this._control.refresh){if(e)return this._refreshTimeout&&(clearTimeout(this._refreshTimeout),this._refreshTimeout=null),void this._control.refresh();this._refreshTimeout&&clearTimeout(this._refreshTimeout),this._refreshTimeout=setTimeout(()=>{this._refreshTimeout=null,this._control.refresh()},250)}else d&&d.warn("[LayerManager] refresh(): contr\xf4le non disponible ou m\xe9thode refresh manquante")},_mergeOptions(e,t){const o=Object.assign({},e||{});return t?(Object.keys(t).forEach(n=>{const r=t[n];r&&"object"==typeof r&&!Array.isArray(r)&&e&&"object"==typeof e[n]&&!Array.isArray(e[n])?o[n]=Object.assign({},e[n],r):o[n]=r}),o):o}},mi={_currentThemeId:null,_isFirstLoad:1,_init(){this._pendingLayerConfigs=new Map,this._pendingCheckTimer=null},_cleanup(){this._pendingCheckTimer&&(clearTimeout(this._pendingCheckTimer),this._pendingCheckTimer=null),this._pendingLayerConfigs&&this._pendingLayerConfigs.clear()},applyTheme(e,t={}){if(this._pendingLayerConfigs||this._init(),di&&"function"==typeof di.showLoadingOverlay&&di.showLoadingOverlay(),!e||!e.id)return Promise.reject(new Error("Th\xe8me invalide"));if(!Mo||!yi)return Promise.reject(new Error("Modules GeoJSON ou LayerManager non disponibles"));try{document.dispatchEvent(new CustomEvent("geoleaf:theme:applying",{detail:{themeId:e.id,themeName:e.name||e.label||e.id}}))}catch(e){}this._hideAllLayers();const o=e.layers||[],n=F?.Profile?.getActiveProfileConfig(),r=n?.performance||{},i=o.filter(e=>0!=e.visible),a=r.themeBatchSize||3,l=e=>{try{"undefined"!=typeof window&&window._glLoadingScreen&&"function"==typeof window._glLoadingScreen.updateProgress&&window._glLoadingScreen.updateProgress(e)}catch(e){}},s=this;return(async e=>{for(let t=0;t<e.length;t+=a){const o=e.slice(t,t+a);await Promise.all(o.map(e=>this._applyLayerConfig(e))),0===t&&l(98)}})(i).then(()=>(l(98),Promise.resolve())).then(()=>{l(99),s._currentThemeId=e.id,yi&&yi.refresh&&yi.refresh(),s._syncLegendVisibility();try{const t=new CustomEvent("geoleaf:theme:applied",{detail:{themeId:e.id,themeName:e.name||e.label||e.id,layerCount:i.length,totalLayersInTheme:o.length,timestamp:(new Date).toISOString()}});document.dispatchEvent(t)}catch(e){}(1==t.fitBounds||(s._isFirstLoad,0))&&(setTimeout(()=>{s._fitBoundsOnAllLayers()},1e3),s._isFirstLoad=0)}).catch(e=>{throw e}).finally(()=>{di&&"function"==typeof di.hideLoadingOverlay&&di.hideLoadingOverlay()})},getCurrentThemeId(){return this._currentThemeId}},bi={renderSections(e,t){e&&(ee.clearElementFast(e),Array.isArray(t)&&0!==t.length?(t.filter(e=>"poi"!==e.id&&"route"!==e.id).forEach(t=>{const o="boolean"==typeof t.collapsedByDefault,n=1==t.collapsedByDefault,r=globalThis.L.DomUtil.create("div",o?"gl-layer-manager__section gl-layer-manager__section--accordion":"gl-layer-manager__section",e);if(n&&r.classList.add("gl-layer-manager__section--collapsed"),t.label)if(o){const e=globalThis.L.DomUtil.create("div","gl-layer-manager__accordion-header",r);globalThis.L.DomUtil.create("div","gl-layer-manager__section-title",e).textContent=t.label;const o=globalThis.L.DomUtil.create("span","gl-layer-manager__accordion-arrow",e);o.textContent="\u25b6",globalThis.L.DomEvent.on(e,"click",function(e){globalThis.L.DomEvent.stopPropagation(e),globalThis.L.DomEvent.preventDefault(e);const n=r.classList.contains("gl-layer-manager__section--collapsed");r.classList.toggle("gl-layer-manager__section--collapsed"),o.textContent=n?"\u25bc":"\u25b6",t._isExpanded=n,d&&t.id})}else globalThis.L.DomUtil.create("div","gl-layer-manager__section-title",r).textContent=t.label;if(!Array.isArray(t.items)||0===t.items.length)return;const i=o?globalThis.L.DomUtil.create("div","gl-layer-manager__accordion-body",r):r;"basemap"===t.id?Hr&&Hr.render(t,i):this._renderItems(t,i)}),Wo&&Mo&&(Mo._layers||new Map).forEach((e,t)=>{e.currentStyle&&Wo.syncImmediate(t)})):globalThis.L.DomUtil.create("div","gl-layer-manager__empty",e).textContent="Aucune couche \xe0 afficher.")},syncToggles(){const e=document.querySelectorAll("[data-layer-id]");d&&e.length,e.forEach(e=>{const t=e.getAttribute("data-layer-id");if(!t)return;const o=Mo?.getLayerById(t),n=this._checkLayerVisibility(t);d&&(!o||o._visibility,o?.layer&&Gt.state.map?.hasLayer(o.layer)),n?e.classList.remove("gl-layer--hidden"):e.classList.add("gl-layer--hidden");const r=e.querySelector(".gl-layer-manager__item-toggle");if(r){r.setAttribute("aria-pressed",n?"true":"false");const e="gl-layer-manager__item-toggle--on";n?r.classList.add(e):r.classList.remove(e)}})},_renderItems(e,t){const o=globalThis.L.DomUtil.create("div","gl-layer-manager__items",t);e.items.forEach(e=>{const t=globalThis.L.DomUtil.create("div","gl-layer-manager__item",o);e.id&&(t.setAttribute("data-layer-id",e.id),this._checkLayerVisibility(e.id)||t.classList.add("gl-layer--hidden"));const n=globalThis.L.DomUtil.create("div","gl-layer-manager__item-row",t);if(globalThis.L.DomUtil.create("span","gl-layer-manager__label",n).textContent=e.label||"",e.toggleable&&e.id)this._renderToggleControls(e,n,t);else if(e.id){const t=globalThis.L.DomUtil.create("div","gl-layer-manager__item-controls",n);Wo&&(Wo.createButton(e.id,t),Wo.syncImmediate(e.id))}else void 0!==e.value&&(globalThis.L.DomUtil.create("span","gl-layer-manager__value",t).textContent=String(e.value))})},_renderToggleControls(e,t,o){const n=globalThis.L.DomUtil.create("div","gl-layer-manager__item-controls",t);Wo&&(Wo.createButton(e.id,n),Wo.syncImmediate(e.id));const r=this._checkLayerVisibility(e.id),i=Vo.createToggleButton(n,{isActive:r,className:"gl-layer-manager__item-toggle",title:"Afficher / masquer la couche"});if(this._attachToggleHandler(i,e.id),e.styles&&gi){const t=gi.renderDOM(e);t&&(o.appendChild(t),gi.bindEvents(t,e))}},_checkLayerVisibility(e){try{if(e&&Mo){const t=Mo.getLayerById(e);return t&&t._visibility&&"boolean"==typeof t._visibility.logicalState?t._visibility.logicalState:t&&1==t.visible}}catch(e){d&&d.error("[LayerManager Renderer] Erreur dans _checkLayerVisibility:",e)}return 0},_attachToggleHandler(e,t){if(e._toggleHandlerAttached)return;e._toggleHandlerAttached=1;const o=this,n=function(n){if(e._isToggling)return d&&d.warn("[LayerManager] \u23f8\ufe0f Toggle D\xc9J\xc0 en cours, BLOQU\xc9:",t),void(globalThis.L&&globalThis.L.DomEvent&&(globalThis.L.DomEvent.stopPropagation(n),globalThis.L.DomEvent.preventDefault(n)));e._isToggling=1,globalThis.L&&globalThis.L.DomEvent&&(globalThis.L.DomEvent.stopPropagation(n),globalThis.L.DomEvent.preventDefault(n)),setTimeout(()=>{e._isToggling=0},100);try{if(t&&Mo){if(!Mo.getLayerById(t))return d&&d.info("[LayerManager] \u23f3 Couche non charg\xe9e, chargement \xe0 la demande:",t),e.classList.add("gl-layer-manager__item-toggle--loading"),e.disabled=1,void(mi&&"function"==typeof mi._loadLayerFromProfile?mi._loadLayerFromProfile(t).then(function(o){if(e.classList.remove("gl-layer-manager__item-toggle--loading"),e.disabled=0,o){d&&d.info("[LayerManager] \u2705 Couche charg\xe9e avec succ\xe8s:",t),Mo.showLayer(t),e.setAttribute("aria-pressed","true"),e.classList.add("gl-layer-manager__item-toggle--on");const o=document.querySelector('[data-layer-id="'+t+'"]');o&&o.classList.remove("gl-layer--hidden");let n=null;if(o&&(n=o.querySelector(".gl-layer-manager__label-toggle")),!n&&e.parentElement&&(n=e.parentElement.querySelector(".gl-layer-manager__label-toggle")),n){const e=Mo?.getLayerById?.(t);1==e?.currentStyle?.label?.enabled&&(n.disabled=0,n.classList.remove("gl-layer-manager__label-toggle--disabled"))}}else d&&d.warn("[LayerManager] \u274c \xc9chec du chargement de la couche:",t)}).catch(function(o){e.classList.remove("gl-layer-manager__item-toggle--loading"),e.disabled=0,d&&d.error("[LayerManager] Erreur lors du chargement de la couche:",t,o)}):(e.classList.remove("gl-layer-manager__item-toggle--loading"),e.disabled=0,d&&d.warn("[LayerManager] ThemeApplierCore non disponible pour charger:",t)));const n=o._checkLayerVisibility(t),r=document.querySelector(`[data-layer-id="${t}"]`);if(n){Mo.hideLayer(t),e.setAttribute("aria-pressed","false"),e.classList.remove("gl-layer-manager__item-toggle--on"),r&&r.classList.add("gl-layer--hidden");let o=null;r&&(o=r.querySelector(".gl-layer-manager__label-toggle")),!o&&e.parentElement&&(o=e.parentElement.querySelector(".gl-layer-manager__label-toggle")),o?(o.disabled=1,o.classList.add("gl-layer-manager__label-toggle--disabled"),o.classList.remove("gl-layer-manager__label-toggle--on"),o.setAttribute("aria-pressed","false")):d&&d.warn("[LayerManager] Bouton label NON TROUV\xc9 pour d\xe9sactivation:",t)}else{Mo.showLayer(t),e.setAttribute("aria-pressed","true"),e.classList.add("gl-layer-manager__item-toggle--on"),r&&r.classList.remove("gl-layer--hidden");let o=null;if(r&&(o=r.querySelector(".gl-layer-manager__label-toggle")),!o&&e.parentElement&&(o=e.parentElement.querySelector(".gl-layer-manager__label-toggle")),o){const e=Mo?.getLayerById?.(t);1==e?.currentStyle?.label?.enabled&&(o.disabled=0,o.classList.remove("gl-layer-manager__label-toggle--disabled"))}}}}catch(e){d&&d.warn("Erreur toggle l\xe9gende :",e)}};globalThis.L&&globalThis.L.DomEvent?(globalThis.L.DomEvent.on(e,"click",n),globalThis.L.DomEvent.disableClickPropagation(e)):e.addEventListener("click",n)},_createToggleFallback(e,t){const o=globalThis.L.DomUtil.create("button","gl-layer-manager__item-toggle",e);return o.type="button",o.setAttribute("aria-pressed",t?"true":"false"),o.title="Afficher / masquer la couche",t&&o.classList.add("gl-layer-manager__item-toggle--on"),o}},_i={create:function(e){return globalThis.L&&globalThis.L.Control?new(globalThis.L.Control.extend({options:{position:e.position||"bottomright"},initialize:function(e){globalThis.L.setOptions(this,e||{}),this._glOptions=e._glOptions},onAdd:function(e){return this._map=e,this._container=globalThis.L.DomUtil.create("div","gl-layer-manager"),globalThis.L.DomEvent&&(globalThis.L.DomEvent.disableClickPropagation(this._container),globalThis.L.DomEvent.disableScrollPropagation(this._container)),this._buildStructure(),this._container},onRemove:function(){this._map=null,this._container=null},_buildStructure:function(){const e=this._glOptions,t=globalThis.L.DomUtil.create("div","gl-layer-manager__main-wrapper",this._container),o=globalThis.L.DomUtil.create("div","gl-layer-manager__header-wrapper",t),n=globalThis.L.DomUtil.create("div","gl-layer-manager__header",o);globalThis.L.DomUtil.create("div","gl-layer-manager__title",n).textContent=e.title||"L\xe9gende";let r=null;if(e.collapsible){r=globalThis.L.DomUtil.create("button","gl-layer-manager__toggle",n),r.type="button",r.setAttribute("aria-label","Basculer la l\xe9gende"),r.textContent="\u27f1";const e=this;globalThis.L.DomEvent.on(r,"click",function(t){globalThis.L.DomEvent.stopPropagation(t),e._toggleCollapsed()})}const i=globalThis.L.DomUtil.create("div","gl-layer-manager__body-wrapper",t);this._bodyEl=globalThis.L.DomUtil.create("div","gl-layer-manager__body",i),(e.collapsed||e.collapsedByDefault)&&(this._container.classList.add("gl-layer-manager--collapsed"),e.collapsed=1),this._renderSections(e.sections||[])},_renderSections:function(e){bi?bi.renderSections(this._bodyEl,e):d&&d.error("[LayerManager] _LayerManagerRenderer non disponible")},updateSections:function(e){this._glOptions.sections=Array.isArray(e)?e:[],this._renderSections(this._glOptions.sections)},refresh:function(){bi&&"function"==typeof bi.syncToggles?bi.syncToggles():this._glOptions&&this._glOptions.sections&&this._renderSections(this._glOptions.sections)},_toggleCollapsed:function(){const e=this._container.classList.toggle("gl-layer-manager--collapsed");this._glOptions.collapsed=e}}))({position:e.position,_glOptions:e}):(d&&d.error("[LayerManager] Leaflet L.Control non disponible"),null)}};function Li(){const e="undefined"!=typeof globalThis?globalThis:window;return e?.GeoLeaf?.Storage?.DB??null}const vi={_config:{enabled:1,maxAge:6048e5},async get(e,t){if(!this._config.enabled)return null;const o=Li();if(!o)return null;try{const n=await o.getLayer(e);return n?t&&n.profileId&&n.profileId!==t||Date.now()-n.timestamp>this._config.maxAge?null:(d&&d.info(`[ThemeCache] Cache hit pour ${e}`),n.data):null}catch(t){return d&&d.warn(`[ThemeCache] Lecture cache impossible pour ${e}: ${t.message}`),null}},async store(e,t,o,n={}){if(!this._config.enabled)return;const r=Li();if(r)try{await r.cacheLayer(e,o,t||null,n)}catch(t){d&&d.warn(`[ThemeCache] \xc9chec mise en cache ${e}: ${t.message}`)}},async invalidate(e){const t=Li();if(t)try{await t.removeLayer(e),d&&d.info(`[ThemeCache] Cache invalid\xe9 pour ${e}`)}catch(t){d&&d.warn(`[ThemeCache] Impossible d'invalider ${e}: ${t.message}`)}}},wi=new Map,Ci=new Map,Ii={loadThemesConfig(e){if(wi.has(e))return Promise.resolve(wi.get(e));if(Ci.has(e))return Ci.get(e);const t=`${window.location.pathname.includes("/demo/")?"../":""}profiles/${e}/themes.json`;let o;return o=he?he.get(t,{timeout:8e3,retries:1,parseResponse:1}).then(t=>{const o=this._validateConfig(t);return wi.set(e,o),Ci.delete(e),o}).catch(t=>{throw d&&d.warn("[ThemeLoader] Erreur chargement themes.json:",t.message),Ci.delete(e),t}):fetch(t).then(e=>{if(!e.ok)throw new Error(`Erreur HTTP ${e.status} lors du chargement de ${t}`);return e.json()}).then(t=>{const o=this._validateConfig(t);return wi.set(e,o),Ci.delete(e),o}).catch(t=>{throw d&&d.warn("[ThemeLoader] Erreur chargement themes.json:",t.message),Ci.delete(e),t}),Ci.set(e,o),o},_validateConfig(e){if(!e||"object"!=typeof e)throw new Error("Configuration de th\xe8mes invalide");const t={config:{primaryThemes:{enabled:1,position:"top-map",...e.config?.primaryThemes||{}},secondaryThemes:{enabled:1,placeholder:"S\xe9lectionner un th\xe8me...",showNavigationButtons:1,position:"top-layermanager",...e.config?.secondaryThemes||{}}},themes:[],defaultTheme:e.defaultTheme||null};if(!Array.isArray(e.themes))return d&&d.warn("[ThemeLoader] Aucun th\xe8me d\xe9fini dans la configuration"),t;if(t.themes=e.themes.map(e=>e.id?{id:e.id,label:e.label||e.id,type:e.type||"secondary",description:e.description||"",icon:e.icon||"",layers:Array.isArray(e.layers)?e.layers:[]}:(d&&d.warn("[ThemeLoader] Th\xe8me sans ID ignor\xe9"),null)).filter(Boolean),0===t.themes.length)throw new Error("Aucun th\xe8me valide trouv\xe9 dans la configuration");return t.defaultTheme?t.themes.some(e=>e.id===t.defaultTheme)||(d&&d.warn("[ThemeLoader] defaultTheme introuvable, utilisation du premier th\xe8me"),t.defaultTheme=t.themes[0].id):t.defaultTheme=t.themes[0].id,d&&t.themes.length,t},clearCache(e){e?(wi.delete(e),Ci.delete(e)):(wi.clear(),Ci.clear())}},Si={initialized:0,profileId:null,config:null,themes:[],primaryThemes:[],secondaryThemes:[],currentTheme:null,primaryContainer:null,secondaryContainer:null,dropdown:null,_eventCleanups:[]},Ei={init(e){return e&&e.profileId?(d&&e.profileId,Si.profileId=e.profileId,Si.primaryContainer=e.primaryContainer||null,Si.secondaryContainer=e.secondaryContainer||null,Ii.loadThemesConfig(e.profileId).then(e=>(Si.config=e.config,Si.themes=e.themes,Si.primaryThemes=e.themes.filter(e=>"primary"===e.type),Si.secondaryThemes=e.themes.filter(e=>"secondary"===e.type),Si.currentTheme=e.defaultTheme,d&&(Si.themes.length,Si.primaryThemes.length,Si.secondaryThemes.length),this._createUI(),Si.initialized=1,this.setTheme(Si.currentTheme))).then(()=>{const e=new CustomEvent("geoleaf:themes:ready",{detail:{time:Date.now()}});document.dispatchEvent(e)}).catch(e=>{d&&d.warn("[ThemeSelector] Erreur initialisation:",e.message);const t=new CustomEvent("geoleaf:themes:ready",{detail:{time:Date.now(),error:e.message}});throw document.dispatchEvent(t),e})):Promise.reject(new Error("profileId requis pour ThemeSelector.init"))},_createUI(){const e=F?.get?.("ui")??null;e&&1==e.showThemeSelector&&(Si.config.primaryThemes.enabled&&Si.primaryContainer&&this._createPrimaryUI(),Si.config.secondaryThemes.enabled&&Si.secondaryContainer&&this._createSecondaryUI())},_createPrimaryUI(){Si.primaryContainer&&(ee.clearElementFast(Si.primaryContainer),Si.primaryContainer.classList.add("gl-theme-selector-primary"),Si.primaryThemes.forEach(e=>{const t=globalThis.L.DomUtil.create("button","gl-theme-btn",Si.primaryContainer);t.type="button",t.dataset.themeId=e.id,t.title=e.description||e.label,globalThis.L.DomUtil.create("span","gl-theme-btn__icon",t).textContent=e.icon||"??",globalThis.L.DomUtil.create("span","gl-theme-btn__label",t).textContent=e.label,e.id===Si.currentTheme&&t.classList.add("gl-theme-btn--active"),this._attachPrimaryButtonHandler(t,e)}),d&&Si.primaryThemes.length)},_attachPrimaryButtonHandler(e,t){const o=e=>{globalThis.L&&globalThis.L.DomEvent&&globalThis.L.DomEvent.stopPropagation(e),e.preventDefault(),this.setTheme(t.id)};globalThis.L&&globalThis.L.DomEvent?(globalThis.L.DomEvent.on(e,"click",o),globalThis.L.DomEvent.disableClickPropagation(e),Si._eventCleanups.push(()=>{globalThis.L&&globalThis.L.DomEvent&&globalThis.L.DomEvent.off(e,"click",o)})):ue?Si._eventCleanups.push(ue.on(e,"click",o,0,"ThemeSelector.primaryButton")):e.addEventListener("click",o)},_createSecondaryUI(){if(!Si.secondaryContainer)return void(d&&d.warn("[ThemeSelector] Conteneur secondaire introuvable"));d&&Si.secondaryThemes.length,d&&Si.secondaryThemes.map(e=>e.id),ee.clearElementFast(Si.secondaryContainer),Si.secondaryContainer.classList.add("gl-theme-selector-secondary");const e=globalThis.L.DomUtil.create("div","gl-theme-selector-secondary__wrapper",Si.secondaryContainer);if(Si.config.secondaryThemes.showNavigationButtons){const t=globalThis.L.DomUtil.create("button","gl-theme-nav gl-theme-nav--prev",e);t.type="button",t.textContent="\u276e",t.title="Th\xc3\xaf\xc2\xbf\xc2\xbdme pr\xc3\xaf\xc2\xbf\xc2\xbdc\xc3\xaf\xc2\xbf\xc2\xbddent",this._attachNavButtonHandler(t,"prev")}const t=globalThis.L.DomUtil.create("select","gl-theme-dropdown",e);Si.dropdown=t;const o=te("option",{value:"",textContent:Si.config.secondaryThemes.placeholder,disabled:1});t.appendChild(o),Si.secondaryThemes.forEach(e=>{const o=te("option",{value:e.id,textContent:e.label});t.appendChild(o)});const n=Si.secondaryThemes.some(e=>e.id===Si.currentTheme);if(t.value=n?Si.currentTheme:"",this._attachDropdownHandler(t),Si.config.secondaryThemes.showNavigationButtons){const t=globalThis.L.DomUtil.create("button","gl-theme-nav gl-theme-nav--next",e);t.type="button",t.textContent="\u276f",t.title="Th\xc3\xaf\xc2\xbf\xc2\xbdme suivant",this._attachNavButtonHandler(t,"next")}d&&Si.secondaryThemes.length},_attachDropdownHandler(e){const t=t=>{globalThis.L&&globalThis.L.DomEvent&&globalThis.L.DomEvent.stopPropagation(t);const o=e.value;d&&d.info(`[ThemeSelector] Dropdown chang\xc3\xaf\xc2\xbf\xc2\xbd: ${o}`),o?this.setTheme(o):d&&d.warn("[ThemeSelector] Dropdown: themeId vide")};globalThis.L&&globalThis.L.DomEvent?(globalThis.L.DomEvent.on(e,"change",t),globalThis.L.DomEvent.disableClickPropagation(e),Si._eventCleanups.push(()=>{globalThis.L&&globalThis.L.DomEvent&&globalThis.L.DomEvent.off(e,"change",t)})):ue?Si._eventCleanups.push(ue.on(e,"change",t,0,"ThemeSelector.dropdown")):e.addEventListener("change",t)},_attachNavButtonHandler(e,t){const o=e=>{globalThis.L&&globalThis.L.DomEvent&&globalThis.L.DomEvent.stopPropagation(e),e.preventDefault(),"next"===t?this.nextTheme():this.previousTheme()};globalThis.L&&globalThis.L.DomEvent?(globalThis.L.DomEvent.on(e,"click",o),globalThis.L.DomEvent.disableClickPropagation(e),Si._eventCleanups.push(()=>{globalThis.L&&globalThis.L.DomEvent&&globalThis.L.DomEvent.off(e,"click",o)})):ue?Si._eventCleanups.push(ue.on(e,"click",o,0,"ThemeSelector.navButton")):e.addEventListener("click",o)},setTheme(e){if(!Si.initialized)return Promise.reject(new Error("ThemeSelector non initialis\xc3\xaf\xc2\xbf\xc2\xbd"));const t=Si.themes.find(t=>t.id===e);return t?mi.applyTheme(t).then(()=>{Si.currentTheme=e,this._updateUIState(e)}).catch(e=>{throw d&&d.warn("[ThemeSelector] Erreur activation th\xc3\xaf\xc2\xbf\xc2\xbdme:",e.message),e}):Promise.reject(new Error(`Th\xc3\xaf\xc2\xbf\xc2\xbdme introuvable: ${e}`))},_updateUIState(e){if(Si.primaryContainer&&Si.primaryContainer.querySelectorAll(".gl-theme-btn").forEach(t=>{t.dataset.themeId===e?t.classList.add("gl-theme-btn--active"):t.classList.remove("gl-theme-btn--active")}),Si.dropdown){const t=Si.secondaryThemes.some(t=>t.id===e);Si.dropdown.value=t?e:""}},nextTheme(){if(!Si.initialized||0===Si.secondaryThemes.length)return;let e=0;Si.secondaryThemes.some(e=>e.id===Si.currentTheme)&&(e=(Si.secondaryThemes.findIndex(e=>e.id===Si.currentTheme)+1)%Si.secondaryThemes.length);const t=Si.secondaryThemes[e];t&&this.setTheme(t.id)},previousTheme(){if(!Si.initialized||0===Si.secondaryThemes.length)return;const e=Si.secondaryThemes.some(e=>e.id===Si.currentTheme);let t=Si.secondaryThemes.length-1;e&&(t=(Si.secondaryThemes.findIndex(e=>e.id===Si.currentTheme)-1+Si.secondaryThemes.length)%Si.secondaryThemes.length);const o=Si.secondaryThemes[t];o&&this.setTheme(o.id)},getCurrentTheme:()=>Si.currentTheme,getThemes:()=>Si.themes,getPrimaryThemes:()=>Si.primaryThemes,getSecondaryThemes:()=>Si.secondaryThemes,isInitialized:()=>Si.initialized,destroy(){Si._eventCleanups&&(Si._eventCleanups.forEach(e=>{"function"==typeof e&&e()}),Si._eventCleanups=[]),Si.initialized=0}};mi._scheduleLayerConfig=function(e,t,o){return mi._pendingLayerConfigs||(mi._pendingLayerConfigs=new Map),mi._pendingLayerConfigs.set(e,{visible:t,styleId:o}),mi._schedulePendingCheck(),Promise.resolve()},mi._schedulePendingCheck=function(){mi._pendingCheckTimer||(mi._pendingCheckTimer=setTimeout(()=>{mi._checkPendingLayerConfigs(),mi._pendingCheckTimer=null},1e3))},mi._checkPendingLayerConfigs=function(){if(!mi._pendingLayerConfigs||0===mi._pendingLayerConfigs.size)return;const e=[];for(const[t,o]of mi._pendingLayerConfigs){const n=Gt.state.layers?.get(t);n&&(mi._setLayerVisibilityAndStyle(t,o.visible,o.styleId),e.push(t))}e.forEach(e=>{mi._pendingLayerConfigs.delete(e)}),mi._pendingLayerConfigs.size>0&&mi._schedulePendingCheck()},mi._loadLayerFromProfile=async function(e){if(!F||"function"!=typeof F.getActiveProfile)return null;try{const t=F.getActiveProfile();if(!t||"object"!=typeof t)return null;const o=t.id||null;let n=[];if(Array.isArray(t.geojsonLayers)?n=t.geojsonLayers:t.geojson&&Array.isArray(t.geojson.layers)?n=t.geojson.layers:Array.isArray(t.layers)?n=t.layers:Array.isArray(t.Layers)&&(n=t.Layers),!Array.isArray(n)||0===n.length)return null;const r=n.find(t=>t.id===e);if(!r)return null;const i=mi._resolveDataFilePath(r);if(!i)return null;const a=r.label||e,l={},s=Eo._loadSingleLayer;if(!s)return null;let c=null;vi?.get&&(c=await vi.get(e,o));const u={...r,url:i,type:r.geometryType||r.type||"geojson",_profileId:o,_layerDirectory:r._layerDirectory},f={...u};u.popup&&u.popup.fields&&(f.popupFields=u.popup.fields),u.tooltip&&u.tooltip.fields&&(f.tooltipFields=u.tooltip.fields),u.sidepanel&&u.sidepanel.detailLayout&&(f.sidepanelFields=u.sidepanel.detailLayout),u.clustering&&"object"==typeof u.clustering&&(f.clustering=0!=u.clustering.enabled,"number"==typeof u.clustering.maxClusterRadius&&(f.maxClusterRadius=u.clustering.maxClusterRadius,f.clusterRadius=u.clustering.maxClusterRadius),"number"==typeof u.clustering.disableClusteringAtZoom&&(f.disableClusteringAtZoom=u.clustering.disableClusteringAtZoom)),c&&(f._cachedData=c);try{const t=await s.call(Eo,e,a,f,l);return c&&vi?.store&&vi.store(e,o,c),t}catch(t){return d&&d.warn(`[ThemeApplier._loadLayerFromProfile] Erreur chargement couche "${e}":`,t&&t.message),null}}catch(t){return d&&d.warn(`[ThemeApplier._loadLayerFromProfile] Erreur inattendue pour "${e}":`,t&&t.message),null}},mi._resolveDataFilePath=function(e){if(!e.dataFile||!e._layerDirectory)return null;if(!F||!F.getActiveProfile)return null;const t=F.getActiveProfile();if(!t)return null;const o=t.id;return`${mi._getProfilesBasePath(t)}/${o}/${e._layerDirectory}/${e.dataFile}`},mi._getProfilesBasePath=function(e){const t=F?.get?.("data.profilesBasePath");return"string"==typeof t&&t.trim().length>0?mi._normalizeBasePath(t):e&&"string"==typeof e.profilesBasePath?mi._normalizeBasePath(e.profilesBasePath):"profiles"},mi._normalizeBasePath=function(e){const t=e.trim();return t.endsWith("/")?t.slice(0,-1):t};const Ai="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{};Ai.GeoLeaf=Ai.GeoLeaf||{};const Pi={_map:null,_layerGroup:null,_routeLayer:null,_initialized:0,_visible:1,_options:{lineStyle:{color:"#1E88E5",weight:4,opacity:.9,interactive:0},waypointStyle:{radius:5,color:"#0D47A1",fillColor:"#42A5F5",fillOpacity:.9,weight:2},showStart:1,showEnd:1,startWaypointStyle:null,endWaypointStyle:null,fitBoundsOnLoad:1,maxZoomOnFit:14},_validateOptions:e=>(e.map&&"function"!=typeof e.map.addLayer&&d.warn("[GeoLeaf.Route] options.map ne semble pas \xeatre une carte Leaflet valide."),e.lineStyle&&"object"!=typeof e.lineStyle&&(d.warn("[GeoLeaf.Route] options.lineStyle doit \xeatre un objet."),delete e.lineStyle),e.waypointStyle&&"object"!=typeof e.waypointStyle&&(d.warn("[GeoLeaf.Route] options.waypointStyle doit \xeatre un objet."),delete e.waypointStyle),void 0!==e.maxZoomOnFit&&("number"!=typeof e.maxZoomOnFit||e.maxZoomOnFit<1||e.maxZoomOnFit>20)&&(d.warn("[GeoLeaf.Route] options.maxZoomOnFit doit \xeatre entre 1 et 20."),e.maxZoomOnFit=14),e),getLayer(){return this._layerGroup||null},init(e={}){if(e=this._validateOptions(e),void 0===Ai.L)return d.error("[GeoLeaf.Route] Leaflet introuvable."),null;let t=e.map||null;if(!t&&Ai.GeoLeaf.Core&&"function"==typeof Ai.GeoLeaf.Core.getMap&&(t=Ai.GeoLeaf.Core.getMap()),Ai.GeoLeaf.Utils&&"function"==typeof Ai.GeoLeaf.Utils.ensureMap&&(t=Ai.GeoLeaf.Utils.ensureMap(t)),!t)return d.error("[GeoLeaf.Route] Aucune carte disponible pour init()."),null;this._map=t,Ai.GeoLeaf.Utils&&"function"==typeof Ai.GeoLeaf.Utils.mergeOptions?this._options=Ai.GeoLeaf.Utils.mergeOptions(this._options,e):this._options=Object.assign({},this._options,e);const o=Ai.GeoLeaf.Config.get("ui.interactiveShapes",0);return this._options.lineStyle&&(this._options.lineStyle.interactive=o),this._layerGroup=Ai.L.layerGroup().addTo(this._map),this._routeLayer=Ai.L.polyline([],this._options.lineStyle).addTo(this._layerGroup),this._initialized=1,this._visible=1,this._layerGroup},isInitialized(){return 1==this._initialized&&!!this._map&&!!this._layerGroup},isVisible(){return 1==this._visible},show(){this._map&&this._layerGroup&&(this._map.hasLayer(this._layerGroup)||this._layerGroup.addTo(this._map),this._visible=1)},hide(){this._map&&this._layerGroup&&(this._map.hasLayer(this._layerGroup)&&this._map.removeLayer(this._layerGroup),this._visible=0)},toggleVisibility(){this.isInitialized()?this.isVisible()?this.hide():this.show():d.warn("[GeoLeaf.Route] toggleVisibility() appel\xe9 sans init().")},clear(){this._layerGroup&&this._layerGroup.clearLayers(),this._map&&this._layerGroup?this._routeLayer=Ai.L.polyline([],this._options.lineStyle).addTo(this._layerGroup):this._routeLayer=null},loadGPX(e){if(!e)return d.warn("[GeoLeaf.Route] URL GPX manquante."),Promise.resolve();const t=Ai.GeoLeaf.Utils?.FetchHelper;return t?t.fetch(e,{timeout:15e3,retries:2,parseResponse:0}).then(e=>e.text()).then(e=>(new DOMParser).parseFromString(e,"application/xml")).then(e=>{const t=Array.from(e.getElementsByTagName("trkpt")).map(e=>[parseFloat(e.getAttribute("lat")||"0"),parseFloat(e.getAttribute("lon")||"0")]);this._applyRoute(t)}).catch(e=>d.error("[GeoLeaf.Route] Erreur GPX :",e)):fetch(e).then(e=>e.text()).then(e=>(new DOMParser).parseFromString(e,"application/xml")).then(e=>{const t=Array.from(e.getElementsByTagName("trkpt")).map(e=>[parseFloat(e.getAttribute("lat")||"0"),parseFloat(e.getAttribute("lon")||"0")]);this._applyRoute(t)}).catch(e=>d.error("[GeoLeaf.Route] Erreur GPX :",e))},loadGeoJSON(e){Fo.loadGeoJSON(e,this._applyRoute.bind(this))},loadFromConfig(e){if(!this.isInitialized())return void d.warn("[GeoLeaf.Route] loadFromConfig() appel\xe9 alors que le module n'est pas initialis\xe9.");if(!Array.isArray(e)||0===e.length)return this.clear(),void d.info("[GeoLeaf.Route] Aucun itin\xe9raire dans cfg.routes ; couche vid\xe9e.");this.clear();const t=[],o=this._options.lineStyle||{};let n=null,r=null,i=null;try{Ai.GeoLeaf.Config&&"function"==typeof Ai.GeoLeaf.Config.getActiveProfile&&(n=Ai.GeoLeaf.Config.getActiveProfile(),n&&n.defaultSettings&&n.defaultSettings.routeConfig&&(n.defaultSettings.routeConfig.default&&"object"==typeof n.defaultSettings.routeConfig.default&&!Array.isArray(n.defaultSettings.routeConfig.default)&&(r=n.defaultSettings.routeConfig.default),n.defaultSettings.routeConfig.endpoints&&"object"==typeof n.defaultSettings.routeConfig.endpoints&&!Array.isArray(n.defaultSettings.routeConfig.endpoints)&&(i=n.defaultSettings.routeConfig.endpoints)))}catch(e){d.warn("[GeoLeaf.Route] Impossible de lire la config/endpoints depuis le profil actif.",e)}if(e.forEach(e=>{if(!e||"object"!=typeof e)return;const a=this._extractCoordsFromRouteItem(e);if(!a||0===a.length)return;const l=this._resolveRouteStyle(e,n,r,o),s=Ai.GeoLeaf.Config.get("ui.interactiveShapes",0);l.interactive=s;const c=Ai.L.polyline(a,l).addTo(this._layerGroup);c.options||(c.options={}),c.options.routeId=e.id,c._geoleafRouteData=e,this._addRouteTooltip(c,e),this._addRoutePopup(c,e),this._routeLayer||(this._routeLayer=c),t.push(...a);const u=this._resolveEndpointConfig(e,i,this._options);if(a.length>0){const t=a[0],o=a[a.length-1];if(u.showStart){const o=Object.assign({},u.startStyle,{interactive:s,routeId:e.id});Ai.L.circleMarker(t,o).addTo(this._layerGroup)}if(u.showEnd&&o&&(o[0]!==t[0]||o[1]!==t[1])){const t=Object.assign({},u.endStyle,{interactive:s,routeId:e.id});Ai.L.circleMarker(o,t).addTo(this._layerGroup)}}}),0!==t.length){if(this._options.fitBoundsOnLoad)try{const e=this._layerGroup.getBounds(),t={};this._options.maxZoomOnFit&&(t.maxZoom=this._options.maxZoomOnFit),this._map.fitBounds(e,t)}catch(e){d.warn("[GeoLeaf.Route] Erreur lors du fitBounds sur les itin\xe9raires :",e)}this._fireRouteLoadedEvents(t)}else d.warn("[GeoLeaf.Route] loadFromConfig() n'a trouv\xe9 aucun itin\xe9raire valide dans cfg.routes.")},filterVisibility:function(e){if(!this._initialized)return void d.warn("[GeoLeaf.Route] Module non initialis\xe9 - filterVisibility ignor\xe9.");if(!Array.isArray(e))return void d.warn("[GeoLeaf.Route] filterVisibility : filteredRoutes doit \xeatre un tableau.");const t=new Set(e.map(e=>e.id));this._layerGroup.eachLayer(function(e){const o=e.options&&e.options.routeId||e.feature&&e.feature.properties&&e.feature.properties.id;void 0!==o&&(t.has(o)?this._map.hasLayer(e)||this._map.addLayer(e):this._map.hasLayer(e)&&this._map.removeLayer(e))}.bind(this)),d.info("[GeoLeaf.Route] Visibilit\xe9 filtr\xe9e : "+e.length+" routes visibles.")},_extractCoordsFromRouteItem:e=>Fo.extractCoordsFromRouteItem(e),_getRouteColor:(e,t,o)=>jo.getRouteColor(e,t,o),_resolveRouteStyle:(e,t,o,n)=>jo.resolveRouteStyle(e,t,o,n),_resolveEndpointConfig:(e,t,o)=>jo.resolveEndpointConfig(e,t,o),addWaypoint(e){No.addWaypoint(this._layerGroup,e,this._options.waypointStyle)},addSegment(e){if(!this._routeLayer)return;const t=this._routeLayer.getLatLngs();this._routeLayer.setLatLngs([...t,...e])},_applyRoute(e){const t={map:this._map,layerGroup:this._layerGroup,routeLayer:this._routeLayer,options:this._options};No.applyRoute(t,e,this.clear.bind(this),this._fireRouteLoadedEvents.bind(this)),this._routeLayer=t.routeLayer},_addRouteTooltip(e,t){Uo.addRouteTooltip(e,t)},_addRoutePopup(e,t){Uo.addRoutePopup(e,t,this)},_buildRoutePopupContent:e=>Uo.buildRoutePopupContent(e),_openRouteSidePanel(e){Uo.openRouteSidePanel(e)},_fireRouteLoadedEvents(e){No.fireRouteLoadedEvents(this._map,this._routeLayer,e)}},Gi=Pi;mi._updateStyleSelector=function(e,t){const o="style-selector-"+e,n=document.getElementById(o);n&&(n.value=t)},mi._loadLegendForStyle=function(e,t){if(!fi.isAvailable())return;const o=Gt.state.layers,n=o instanceof Map?o.get(e):o?.[e];n&&n.config&&fi.loadLayerLegend(e,t,n.config)},mi._fitBoundsOnAllLayers=function(){const e=z?.getMap();if(!e)return;window._glLoadingScreen&&"function"==typeof window._glLoadingScreen.updateProgress&&window._glLoadingScreen.updateProgress(99);const t=globalThis.L.featureGroup();let o=0;if(Gt.getLayers&&Gt.getLayers().forEach(e=>{if(e.layer)try{t.addLayer(e.layer),o++}catch(e){}}),Ko?.getMarkerLayer){const e=Ko.getMarkerLayer();if(e)try{t.addLayer(e),o++}catch(e){}}if(Gi&&1==Gi._initialized)try{const e="function"==typeof Gi.getLayer?Gi.getLayer():null;e&&(t.addLayer(e),o++)}catch(e){}if(o>0){const o=t.getBounds();if(o.isValid()){const t=document.getElementById("geoleaf-map")||document.querySelector(".leaflet-container")?.parentElement;t&&(t.style.opacity="1"),e.fitBounds(o,{maxZoom:12,padding:[50,50],animate:0}),setTimeout(()=>{try{const e=new CustomEvent("geoleaf:map:ready",{detail:{time:Date.now()}});document.dispatchEvent(e)}catch(e){}},800)}}},mi._syncLegendVisibility=function(){if(!fi.isAvailable())return;if(!Gt.getLayers)return;const e=Bt;e&&Gt.getLayers().forEach((t,o)=>{const n=e.getVisibilityState(o),r=n?n.current:t.visible;fi.setLayerVisibility(o,r)})},mi._hideAllLayers=function(){if(!Gt.state.layers)return;const e=Bt;e&&(e.resetAllUserOverrides(),Gt.getLayers().forEach((t,o)=>{e.setVisibility(o,0,e.VisibilitySource.THEME)}))},mi._applyLayerConfig=function(e){if(!e?.id)return Promise.resolve();const t=e.id,o=0!=e.visible,n=e.style?String(e.style).trim():void 0,r=Gt.state.layers?.get(t);return r?mi._setLayerVisibilityAndStyle(t,o,n):mi._loadLayerFromProfile(t).then(e=>e?mi._setLayerVisibilityAndStyle(t,o,n):mi._scheduleLayerConfig(t,o,n))},mi._setLayerVisibilityAndStyle=function(e,t,o){const n=Gt.state.layers?.get(e);if(!n)return Promise.resolve();const r=Bt;if(!r)return Promise.resolve();if(t){if(r.setVisibility(e,1,r.VisibilitySource.THEME),o&&go?.setLayerStyle){const t=n.config?.styles?.available||[];let r=o,i=t.some(e=>e.id===o);if(!i){const e={default:"d\xe9faut",d\u00e9faut:"default"}[o];e&&t.some(t=>t.id===e)&&(r=e,i=1)}if(i){const i=t.find(e=>e.id===r)?.file;if(i){let t="default";if(F&&"function"==typeof F.getActiveProfile){const e=F.getActiveProfile();t=e?.id||"default"}const a=n._layerDirectory||e;return wt?wt.loadAndValidateStyle(t,e,r,i,`layers/${a}`).then(t=>{const n=t.styleData;go.setLayerStyle(e,n);const r=Gt.state.layers?.get(e);return r&&(r.currentStyle=n),Zo&&"function"==typeof Zo.initializeLayerLabels&&Zo.initializeLayerLabels(e),Wo&&Wo.syncImmediate(e),yi&&"function"==typeof yi.refresh&&yi.refresh(),gi&&gi.setCurrentStyle(e,o),mi._updateStyleSelector(e,o),mi._loadLegendForStyle(e,o),t}).catch(()=>{}):(d&&d.error("[ThemeApplier] StyleLoader non disponible"),Promise.resolve())}}}}else r.setVisibility(e,0,r.VisibilitySource.THEME),Zo&&Zo.disableLabels(e),Wo&&Wo.syncImmediate(e);return Promise.resolve()};const Ti={_map:null,_control:null,_options:{position:"bottomleft",text:"Propuls\xe9 par \xa9 GeoLeaf with Leaflet"},init(e,t={}){const o="[GeoLeaf.UI.Branding]";try{if(!e)throw new Error("Une instance de carte Leaflet est requise.");this._map=e,this._options=Object.assign({},this._options,t);const n=F?.get("branding");if(null==n)return console.warn("[GeoLeaf] branding key missing in geoleaf.config.json"),this._options.text="\u26a0 Branding non configur\xe9",void this._createControl();if(0==n||n&&0==n.enabled)return void d.info(`${o} Branding d\xe9sactiv\xe9 dans la configuration.`);if(""===n.text)return void d.info(`${o} Branding text vide \u2014 rien affich\xe9.`);n&&"object"==typeof n&&(n.text&&(this._options.text=n.text),n.position&&(this._options.position=n.position)),this._createControl(),d.info(`${o} Module initialis\xe9 avec succ\xe8s.`)}catch(e){d.error(`${o} Erreur lors de l'initialisation :`,e.message)}},_createControl(){const e="[GeoLeaf.UI.Branding]";try{const t=L.Control.extend({options:{position:this._options.position},onAdd:()=>{const e=L.DomUtil.create("div","geoleaf-branding");return L.DomEvent.disableClickPropagation(e),L.DomEvent.disableScrollPropagation(e),L.DomUtil.create("div","branding-content",e).textContent=this._options.text,e},onRemove:()=>{}});this._control=new t,this._control.addTo(this._map),d.info(`${e} Contr\xf4le de branding cr\xe9\xe9 et ajout\xe9 \xe0 la carte.`)}catch(t){d.error(`${e} Erreur lors de la cr\xe9ation du contr\xf4le :`,t.message)}},destroy(){const e="[GeoLeaf.UI.Branding]";try{this._control&&this._map&&(this._map.removeControl(this._control),this._control=null),d.info(`${e} Module d\xe9truit avec succ\xe8s.`)}catch(t){d.error(`${e} Erreur lors de la destruction :`,t.message)}},show(){this._control&&!this._map.hasControl(this._control)&&this._control.addTo(this._map)},hide(){this._control&&this._map&&this._map.removeControl(this._control)},setText(e){if(this._control){const t=this._control.getContainer();if(t){const o=t.querySelector(".branding-content");o&&(o.textContent=e)}}}},xi={active:0,watchId:null,userPosition:null,userPositionAccuracy:null};function Oi(){return("undefined"!=typeof globalThis?globalThis:window)?.GeoLeaf?.POI?.AddForm??null}function Mi(){return("undefined"!=typeof globalThis?globalThis:window)?.GeoLeaf?.POI?.PlacementMode??null}const ki={isAddFormAvailable(){const e=Oi();return!(!e||"function"!=typeof e.openAddForm)},isPlacementModeAvailable(){const e=Mi();return!(!e||"function"!=typeof e.activate)},openAddForm:async(e,t)=>Oi()?.openAddForm(e,t),activatePlacementMode(e,t){const o=Mi();o&&"function"==typeof o.activate&&o.activate(e,t)},get orchestrator(){return Oi()},get placementMode(){return Mi()}},Ni={initFullscreenControl:function(e,t){e&&t?"undefined"!=typeof L&&L.Control?(L.Control.Fullscreen=L.Control.extend({options:{position:"topleft"},onAdd:function(e){const o=L.DomUtil.create("div","leaflet-control-fullscreen leaflet-bar leaflet-control"),n=L.DomUtil.create("a","",o);n.href="#",n.title="Plein \xc3\u0192\xc2\xa9cran",n.setAttribute("role","button"),n.setAttribute("aria-label","Activer le mode plein \xc3\u0192\xc2\xa9cran");const r=ee.createSVGIcon(18,18,"M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3",{stroke:"currentColor",strokeWidth:"2",fill:"none"});r.classList.add("fullscreen-enter-icon");const i=ee.createSVGIcon(18,18,"M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3",{stroke:"currentColor",strokeWidth:"2",fill:"none"});i.classList.add("fullscreen-exit-icon"),i.style.display="none",n.appendChild(r),n.appendChild(i),L.DomEvent.disableClickPropagation(o),L.DomEvent.disableScrollPropagation(o);const a=q?q(()=>e.invalidateSize(),200):()=>e.invalidateSize(),l=e=>{e?(r.style.display="none",i.style.display="block"):(r.style.display="block",i.style.display="none")},s=e=>{L.DomEvent.preventDefault(e),document.fullscreenElement?document.exitFullscreen().then(()=>{n.classList.remove("is-fullscreen"),n.title="Plein \xc3\u0192\xc2\xa9cran",n.setAttribute("aria-label","Activer le mode plein \xc3\u0192\xc2\xa9cran"),l(0),a()}).catch(e=>{d&&d.error("[UI.Controls] Erreur sortie plein \xc3\u0192\xc2\xa9cran:",e)}):t.requestFullscreen().then(()=>{n.classList.add("is-fullscreen"),n.title="Quitter le plein \xc3\u0192\xc2\xa9cran",n.setAttribute("aria-label","Quitter le mode plein \xc3\u0192\xc2\xa9cran"),l(1),a()}).catch(e=>{d&&d.error("[UI.Controls] Erreur plein \xc3\u0192\xc2\xa9cran:",e)})},c=()=>{document.fullscreenElement||(n.classList.remove("is-fullscreen"),n.title="Plein \xc3\u0192\xc2\xa9cran",n.setAttribute("aria-label","Activer le mode plein \xc3\u0192\xc2\xa9cran"),l(0),a())};return L.DomEvent.on(n,"click",s),L.DomEvent.on(n,"keydown",e=>{"Enter"!==e.key&&" "!==e.key&&"Spacebar"!==e.key||s(e)}),document.addEventListener("fullscreenchange",c),this._fullscreenChangeHandler=c,this._toggleFullscreen=s,this._link=n,this._mapContainer=t,this._debouncedInvalidateSize=a,o},onRemove:function(){this._fullscreenChangeHandler&&(document.removeEventListener("fullscreenchange",this._fullscreenChangeHandler),this._fullscreenChangeHandler=null),this._link&&(L.DomEvent.off(this._link,"click",this._toggleFullscreen),L.DomEvent.off(this._link,"keydown"),this._link=null),this._toggleFullscreen=null,this._mapContainer=null,this._debouncedInvalidateSize=null}}),(new L.Control.Fullscreen).addTo(e),d&&d.info("[UI.Controls] Contr\xc3\u0192\xc2\xb4le plein \xc3\u0192\xc2\xa9cran ajout\xc3\u0192\xc2\xa9 \xc3\u0192\xc2  la carte")):d&&d.warn("[UI.Controls] Leaflet n'est pas disponible"):d&&d.warn("[UI.Controls] initFullscreenControl: carte ou conteneur manquant")},initGeolocationControl:function(e,t){if(!e)return void(d&&d.warn("[UI.Controls] initGeolocationControl: carte manquante"));if(!t?.ui?.enableGeolocation)return void(d&&d.info("[UI.Controls] G\xc3\u0192\xc2\xa9olocalisation d\xc3\u0192\xc2\xa9sactiv\xc3\u0192\xc2\xa9e dans la configuration"));if("undefined"==typeof L||!L.Control)return void(d&&d.warn("[UI.Controls] Leaflet n'est pas disponible"));if(!navigator.geolocation)return void(d&&d.warn("[UI.Controls] La g\xc3\u0192\xc2\xa9olocalisation n'est pas support\xc3\u0192\xc2\xa9e par ce navigateur"));let o=null,n=null;L.Control.Geolocation=L.Control.extend({options:{position:"topleft"},onAdd:function(e){const t=L.DomUtil.create("div","leaflet-control-geolocation leaflet-bar leaflet-control"),r=L.DomUtil.create("a","",t);r.href="#",r.title="G\xc3\u0192\xc2\xa9olocalisation ON/OFF",r.setAttribute("role","button"),r.setAttribute("aria-label","Activer/D\xc3\u0192\xc2\xa9sactiver le suivi GPS");const i=ee.createSVGIcon(18,18,"M12 2 C 6.5 2 2 6.5 2 12 C 2 17.5 6.5 22 12 22 C 17.5 22 22 17.5 22 12 C 22 6.5 17.5 2 12 2 M12 9 C 10.3 9 9 10.3 9 12 C 9 13.7 10.3 15 12 15 C 13.7 15 15 13.7 15 12 C 15 10.3 13.7 9 12 9",{stroke:"currentColor",strokeWidth:"2",fill:"none"});r.appendChild(i),L.DomEvent.disableClickPropagation(t),L.DomEvent.disableScrollPropagation(t);const a=t=>{if(L.DomEvent.preventDefault(t),xi.active)return null!==xi.watchId&&(navigator.geolocation.clearWatch(xi.watchId),xi.watchId=null),o&&(e.removeLayer(o),o=null),n&&(e.removeLayer(n),n=null),xi.active=0,xi.userPosition=null,r.classList.remove("is-active"),r.classList.remove("is-locating"),void(d&&d.info("[UI.Controls] G\xc3\u0192\xc2\xa9olocalisation d\xc3\u0192\xc2\xa9sactiv\xc3\u0192\xc2\xa9e"));r.classList.add("is-locating"),xi.watchId=navigator.geolocation.watchPosition(t=>{const{latitude:i,longitude:a,accuracy:l}=t.coords;if(xi.active||e.setView([i,a],16,{animate:1,duration:.5}),o&&e.removeLayer(o),n&&e.removeLayer(n),o=L.marker([i,a],{icon:L.divIcon({className:"gl-user-location-marker gl-user-location-marker--active",html:'<div class="gl-user-location-dot gl-user-location-dot--active"></div>',iconSize:[22,22],iconAnchor:[11,11]}),zIndexOffset:1e3}).addTo(e),l&&l<1e3){const t=F.get("ui.interactiveShapes",0);n=L.circle([i,a],{radius:l,className:"gl-user-location-accuracy",fillColor:"#4285F4",fillOpacity:.1,stroke:1,color:"#4285F4",opacity:.3,weight:1,interactive:t}).addTo(e)}xi.active=1,r.classList.remove("is-locating"),r.classList.add("is-active"),xi.userPosition={lat:i,lng:a,accuracy:l,timestamp:Date.now()}},e=>{r.classList.remove("is-locating"),r.classList.remove("is-active"),xi.active=0;let t="Impossible d'obtenir votre position";switch(e.code){case e.PERMISSION_DENIED:t="Permission de g\xc3\u0192\xc2\xa9olocalisation refus\xc3\u0192\xc2\xa9e";break;case e.POSITION_UNAVAILABLE:t="Position indisponible";break;case e.TIMEOUT:t="D\xc3\u0192\xc2\xa9lai de g\xc3\u0192\xc2\xa9olocalisation d\xc3\u0192\xc2\xa9pass\xc3\u0192\xc2\xa9"}d&&d.error("[UI.Controls] Erreur de g\xc3\u0192\xc2\xa9olocalisation:",e),Wr&&"function"==typeof Wr.error?Wr.error(t):d.warn("[UI.Controls] "+t)},{enableHighAccuracy:1,timeout:1e4,maximumAge:0})};return L.DomEvent.on(r,"click",a),L.DomEvent.on(r,"keydown",e=>{"Enter"!==e.key&&" "!==e.key&&"Spacebar"!==e.key||a(e)}),this._link=r,this._userMarker=o,t},onRemove:function(e){this._link&&(L.DomEvent.off(this._link,"click"),L.DomEvent.off(this._link,"keydown"),this._link=null),this._userMarker&&(e.removeLayer(this._userMarker),this._userMarker=null)}}),(new L.Control.Geolocation).addTo(e),d&&d.info("[UI.Controls] Contr\xc3\u0192\xc2\xb4le de g\xc3\u0192\xc2\xa9olocalisation ajout\xc3\u0192\xc2\xa9 \xc3\u0192\xc2  la carte")},initPoiAddControl:function(e,t){e?t?.ui?.showAddPoi&&("undefined"!=typeof L&&L.Control?ki.isAddFormAvailable()&&ki.isPlacementModeAvailable()?(L.Control.PoiAdd=L.Control.extend({options:{position:"topleft"},onAdd:function(e){const o=L.DomUtil.create("div","leaflet-control-poi-add leaflet-bar leaflet-control"),n=L.DomUtil.create("a","",o);n.href="#",n.title="Ajouter un POI",n.setAttribute("role","button"),n.setAttribute("aria-label","Ajouter un nouveau point d'int\xc3\u0192\xc2\xa9r\xc3\u0192\xc2\xaat");const r=ee.createSVGIcon(18,18,"M12 2 C 6.5 2 2 6.5 2 12 C 2 17.5 6.5 22 12 22 C 17.5 22 22 17.5 22 12 C 22 6.5 17.5 2 12 2 M12 8 L12 16 M8 12 L16 12",{stroke:"currentColor",strokeWidth:"2",fill:"none"});n.appendChild(r),L.DomEvent.disableClickPropagation(o),L.DomEvent.disableScrollPropagation(o);const i=o=>{L.DomEvent.preventDefault(o),n.classList.add("disabled");const r=e=>{n.classList.remove("disabled"),ki.isAddFormAvailable()?ki.openAddForm(e,null):d&&d.error("[UI.Controls] AddForm.openAddForm non disponible")},i=xi.userPosition;i&&"geolocation"===(t?.poiAddConfig?.defaultPosition||"placement-mode")?r(i):ki.activatePlacementMode(e,e=>{e?.latlng?r(e.latlng):(n.classList.remove("disabled"),d&&d.warn("[UI.Controls] Mode placement cancelled"))})};return L.DomEvent.on(n,"click",i),L.DomEvent.on(n,"keydown",e=>{"Enter"!==e.key&&" "!==e.key&&"Spacebar"!==e.key||i(e)}),this._link=n,o},onRemove:function(){this._link&&(L.DomEvent.off(this._link,"click"),L.DomEvent.off(this._link,"keydown"),this._link=null)}}),(new L.Control.PoiAdd).addTo(e),d&&d.info("[UI.Controls] Contr\xc3\u0192\xc2\xb4le POI Add ajout\xc3\u0192\xc2\xa9 \xc3\u0192\xc2  la carte")):d&&d.warn("[UI.Controls] Modules POI non charg\xc3\u0192\xc2\xa9s"):d&&d.warn("[UI.Controls] Leaflet n'est pas disponible")):d&&d.warn("[UI.Controls] initPoiAddControl: carte manquante")}},Fi="[GeoLeaf.UI.CoordinatesDisplay]",Di="Lat: --, Lng: --",Ui={_map:null,_control:null,_coordsElement:null,_boundMouseMoveHandler:null,_options:{position:"bottomleft",decimals:6},init(e,t={}){try{if(!e)throw new Error("Une instance de carte Leaflet est requise.");this._map=e,this._options=Object.assign({},this._options,t);const o=F?.get("ui.showCoordinates");if(0==o)return void d.info(`${Fi} Affichage des coordonn\xe9es d\xe9sactiv\xe9 dans la configuration.`);this._boundMouseMoveHandler=this._onMouseMove.bind(this),this._createControl(),d.info(`${Fi} Module initialis\xe9 avec succ\xe8s.`)}catch(e){d.error(`${Fi} Erreur lors de l'initialisation :`,e.message)}},_createControl(){try{const e=document.querySelector(".gl-scale-main-wrapper");if(e)this._attachToScaleWrapper(e);else{const e=new MutationObserver((e,t)=>{const o=document.querySelector(".gl-scale-main-wrapper");o&&(t.disconnect(),this._attachToScaleWrapper(o))});e.observe(document.body||document.documentElement,{childList:1,subtree:1}),setTimeout(()=>{e.disconnect(),this._coordsElement||(d.warn(`${Fi} Wrapper d'\xe9chelle non trouv\xe9 apr\xe8s 5s, utilisation du mode classique.`),this._createStandaloneControl())},5e3)}}catch(e){d.error(`${Fi} Erreur lors de la cr\xe9ation du contr\xf4le :`,e.message)}},_attachToScaleWrapper(e){L.DomUtil.create("div","gl-scale-separator",e),this._coordsElement=L.DomUtil.create("div","gl-scale-coordinates",e),this._coordsElement.textContent=Di,this._map.on("mousemove",this._boundMouseMoveHandler),d.info(`${Fi} Coordonn\xe9es int\xe9gr\xe9es au wrapper d'\xe9chelle.`)},_createStandaloneControl(){const e=L.Control.extend({options:{position:this._options.position},onAdd:e=>{const t=L.DomUtil.create("div","geoleaf-coordinates-display");return L.DomEvent.disableClickPropagation(t),L.DomEvent.disableScrollPropagation(t),this._coordsElement=L.DomUtil.create("div","coordinates-content",t),this._coordsElement.textContent=Di,e.on("mousemove",this._boundMouseMoveHandler),t},onRemove:e=>{e.off("mousemove",this._boundMouseMoveHandler)}});this._control=new e,this._control.addTo(this._map)},_onMouseMove(e){if(!this._coordsElement)return;const t=e.latlng.lat.toFixed(this._options.decimals),o=e.latlng.lng.toFixed(this._options.decimals);this._coordsElement.textContent=`Lat: ${t}, Lng: ${o}`},destroy(){try{this._map&&this._boundMouseMoveHandler&&(this._map.off("mousemove",this._boundMouseMoveHandler),this._boundMouseMoveHandler=null),this._coordsElement&&this._coordsElement.parentNode&&(this._coordsElement.parentNode.removeChild(this._coordsElement),this._coordsElement=null),this._control&&this._map&&(this._map.removeControl(this._control),this._control=null),d.info(`${Fi} Module d\xe9truit avec succ\xe8s.`)}catch(e){d.error(`${Fi} Erreur lors de la destruction :`,e.message)}}},Ri={};Ri.resolveField=H,Ri.attachAccordionBehavior=function(e){e&&!e._glAccordionBound&&(e._glAccordionBound=1,e.addEventListener("click",function(t){const o=t.target.closest(".gl-accordion__header");if(!o||!e.contains(o))return;const n=o.closest(".gl-accordion");n&&n.classList.toggle("is-open")}))},Ri.getActiveProfileConfig=function(){if(!F||"function"!=typeof F.getActiveProfile)return d.warn("[UIDomUtils] GeoLeaf.Config.getActiveProfile() indisponible. Impossible de r\xe9cup\xe9rer le profil actif."),null;const e=F.getActiveProfile();return e||d.warn("[UIDomUtils] Aucun profil actif retourn\xe9 par GeoLeaf.Config.getActiveProfile()."),e||null},Ri.populateSelectOptionsFromTaxonomy=function(e,t,o){if(!e||!t||!t.taxonomy)return;const n=t.taxonomy,r=te("option",{value:"",textContent:"\u2014 Tous \u2014"});if(e.appendChild(r),"taxonomy.categories"===o){const t=n.categories||{};return void Object.keys(t).forEach(function(o){const n=te("option",{value:o,textContent:t[o].label||o});e.appendChild(n)})}if("taxonomy.categories[*].subcategories"===o){const t=n.categories||{};Object.keys(t).forEach(function(o){const n=t[o],r=n&&n.subcategories||{};Object.keys(r).forEach(function(t){const i=r[t],a=te("option",{value:t,textContent:(n.label||o)+" \u2013 "+(i.label||t),attributes:{"data-category-id":o}});e.appendChild(a)})})}};const ji=new Map;let $i=0;function Bi(e,t,o,n={}){if(!e||"function"!=typeof o)return d&&d.warn("[UI.EventDelegation] attachTrackedListener: \xe9lement ou handler manquant"),null;const r="listener_"+ ++$i,i=function(e){try{return o.call(this,e)}catch(e){d&&d.error("[UI.EventDelegation] Erreur dans handler:",e)}};return e.addEventListener(t,i,n),ji.set(r,{element:e,event:t,handler:i,originalHandler:o}),r}const zi={attachTrackedListener:Bi,detachTrackedListener:function(e){if(!e||!ji.has(e))return 0;const{element:t,event:o,handler:n}=ji.get(e);return t.removeEventListener(o,n),ji.delete(e),1},cleanupAllListeners:function(){let e=0;for(const[t,{element:o,event:n,handler:r}]of ji)o.removeEventListener(n,r),e++;return ji.clear(),d&&e>0&&d.info(`[UI.EventDelegation] ${e} listeners nettoy\xe9es`),e},attachFilterInputEvents:function(e,t,o=300){if(!e||"function"!=typeof t)return d&&d.warn("[UI.EventDelegation] attachFilterInputEvents: param\xe8tres manquants"),[];const n=[];let r=null;return n.push(Bi(e,"input",function(e){e.target.matches('input[type="text"], input[type="range"]')&&(r&&clearTimeout(r),r=setTimeout(()=>{t()},o))})),n.push(Bi(e,"change",function(e){e.target.matches('input[type="checkbox"]')&&t()})),n.push(Bi(e,"change",function(e){e.target.matches("select")&&t()})),n.filter(e=>null!==e)},attachAccordionEvents:function(e){return e?Bi(e,"click",function(e){const t=e.target.closest(".gl-accordion-toggle, .accordion-arrow");if(!t)return;e.preventDefault(),e.stopPropagation();const o=t.closest(".gl-accordion")?.querySelector(".gl-accordion-content");if(!o)return;const n="none"!==o.style.display;o.style.display=n?"none":"block",t.setAttribute("aria-expanded",!n);const r=t.querySelector(".accordion-icon, .accordion-arrow");r&&r.classList.toggle("expanded",!n)}):(d&&d.warn("[UI.EventDelegation] attachAccordionEvents: conteneur manquant"),null)},attachMapControlEvents:function(e,t){if(!e||!t||"object"!=typeof t)return d&&d.warn("[UI.EventDelegation] attachMapControlEvents: param\xe8tres manquants"),[];const o=[];return o.push(Bi(e,"click",function(e){for(const[o,n]of Object.entries(t))if(e.target.matches(o)||e.target.closest(o)){e.preventDefault(),e.stopPropagation(),"function"==typeof n&&n.call(this,e);break}})),o.filter(e=>null!==e)},getActiveListenersCount:function(){return ji.size},getActiveListeners:function(){return Array.from(ji.keys())}},Vi=function(e,t,o){if(!e||!e.id||!e.type)return null;const n=te("div",{className:"gl-filter-panel__group",attributes:{"data-gl-filter-id":e.id}});let r=null;e.label&&!o&&(r=te("label",{className:"gl-filter-panel__label",textContent:e.label}),n.appendChild(r));let i=null;if("select"===e.type||"multiselect"===e.type){const t=te("select",{className:"gl-filter-panel__control gl-filter-panel__control--select",name:e.id,id:"gl-filter-"+e.id});r&&r.setAttribute("for",t.id),"multiselect"===e.type&&(t.multiple=1),i=t}else if("range"===e.type){const t=te("div",{className:"gl-filter-panel__range-wrapper"}),o=te("input",{type:"range",className:"gl-filter-panel__control gl-filter-panel__control--range",id:"gl-filter-"+e.id,name:e.id});r&&r.setAttribute("for",o.id),"number"==typeof e.min&&(o.min=String(e.min)),"number"==typeof e.max&&(o.max=String(e.max)),"number"==typeof e.step&&(o.step=String(e.step));const n=te("span",{className:"gl-filter-panel__range-value"});let a;a="number"==typeof e.default?e.default:o.min&&o.max?(parseFloat(o.min)+parseFloat(o.max))/2:o.min?parseFloat(o.min):0,isNaN(a)||(o.value=String(a),n.textContent=a.toString().replace(".",",")),o.addEventListener("input",function(){const e=parseFloat(o.value);isNaN(e)||(n.textContent=e.toString().replace(".",","))}),t.appendChild(o),t.appendChild(n),i=t}else if("tree"===e.type||"tree-category"===e.type||"categoryTree"===e.type)i=te("div",{className:"gl-filter-panel__tree gl-filter-panel__tree--lazy",attributes:{"data-lazy-type":"categories","data-filter-id":e.id}});else if("checkbox-group"===e.type){const t=te("div",{className:"gl-filter-panel__checkbox-group"});Array.isArray(e.options)&&e.options.forEach(function(o){const n=te("label",{className:"gl-filter-panel__checkbox-label"}),r=te("input",{type:"checkbox",className:"gl-filter-panel__checkbox",name:e.id,value:o.id,checked:!!o.checked,attributes:{"data-filter-option-id":o.id}}),i=te("span",{className:"gl-filter-panel__checkbox-text",textContent:o.label||o.id});n.appendChild(r),n.appendChild(i),t.appendChild(n)}),i=t}else if("search"===e.type){const t=te("input",{type:"text",className:"gl-filter-panel__control gl-filter-panel__control--search",name:e.id,placeholder:e.placeholder||"Filtrer..."});Array.isArray(e.searchFields)&&t.setAttribute("data-search-fields",e.searchFields.join(",")),i=t}else if("proximity"===e.type){const t=te("div",{className:"gl-filter-panel__proximity"});if(e.label){const o=te("h3",{className:"gl-filter-panel__proximity-title",textContent:e.label});t.appendChild(o)}const o=te("button",{type:"button",className:"gl-btn gl-btn--secondary gl-filter-panel__proximity-btn",attributes:{"data-filter-proximity-btn":"true"},textContent:e.buttonLabel||"Activer"});t.appendChild(o);const n=te("div",{className:"gl-filter-panel__proximity-range",style:{display:"none"}}),r=te("label",{className:"gl-filter-panel__label",textContent:"Rayon (km)",attributes:{for:"gl-filter-proximity-radius"}});n.appendChild(r);const a=te("div",{className:"gl-filter-panel__range-wrapper"});let l=1,s=50,c=1,u=10;try{const e=F?.getActiveProfile?.();if(e){const t=e.panels&&e.panels.search||e.search;t&&("number"==typeof t.radiusMin&&t.radiusMin>0&&(l=t.radiusMin),"number"==typeof t.radiusMax&&t.radiusMax>0&&(s=t.radiusMax),"number"==typeof t.radiusStep&&t.radiusStep>0&&(c=t.radiusStep),"number"==typeof t.radiusDefault&&t.radiusDefault>0&&(u=t.radiusDefault),u=Math.max(l,Math.min(u,s)))}}catch(e){d?.warn?.("[GeoLeaf.UI] Erreur lecture radius config:",e)}const f=te("input",{type:"range",className:"gl-filter-panel__control gl-filter-panel__control--range",id:"gl-filter-proximity-radius",name:e.id+"_radius",min:String(l),max:String(s),step:String(c),value:String(u),attributes:{"data-filter-proximity-radius":"true"}}),p=te("span",{className:"gl-filter-panel__range-value",textContent:String(u)});f.addEventListener("input",function(){p.textContent=f.value}),a.appendChild(f),a.appendChild(p),n.appendChild(a);const g=te("p",{className:"gl-filter-panel__proximity-instruction",textContent:e.instructionText||"Cliquez sur la carte",style:{display:"none"}});n.appendChild(g),t.appendChild(n),i=t}else"multiselect-tags"!==e.type&&"tags"!==e.id||(i=te("div",{className:"gl-filter-panel__tags-container",attributes:{"data-lazy-type":"tags","data-filter-id":e.id}}));if(!i)return null;if(r&&i instanceof HTMLElement&&!i.id){const t="gl-filter-"+e.id;i.id=t,r.setAttribute("for",t)}return n.appendChild(i),n};function qi(e){const t=F&&"function"==typeof F.getActiveProfile?F.getActiveProfile():null;if(!t||!t.taxonomy||!t.taxonomy.categories)return'<div class="gl-empty-state">Aucune cat\xe9gorie disponible</div>';const o=t.taxonomy.categories,n=e.usedIds,r=C&&"function"==typeof C.escapeHtml?function(e){return C.escapeHtml(e)}:function(e){return String(e||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},i=new Set;n.forEach(function(e){i.add(e.toLowerCase())});const a=Object.keys(o).filter(e=>i.has(e.toLowerCase()));if(0===a.length)return'<div class="gl-empty-state">ND - Non disponible</div>';let l='<ul class="gl-filter-tree gl-filter-tree--root">';return a.forEach(function(e){const t=o[e]||{},n=t.subcategories||{},a=Object.keys(n).filter(e=>i.has(e.toLowerCase())),s=a.length>0;l+='<li class="gl-filter-tree__item gl-filter-tree__item--category">',l+='<div class="gl-filter-tree__row">',l+=s?'<span class="gl-filter-tree__arrow" data-category-id="'+r(e)+'">\u25b6</span>':'<span class="gl-filter-tree__spacer"></span>',l+='<label class="gl-filter-tree__label gl-filter-tree__label--category">',l+='<input type="checkbox" class="gl-filter-tree__checkbox gl-filter-tree__checkbox--category" ',l+='name="categories_category" value="'+r(e)+'" ',l+='data-gl-filter-category-id="'+r(e)+'">',l+='<span class="gl-filter-tree__text">'+r(t.label||e)+"</span>",l+="</label>",l+="</div>",s&&(l+='<ul class="gl-filter-tree gl-filter-tree--subcategories">',a.forEach(function(t){const o=n[t]||{};l+='<li class="gl-filter-tree__item gl-filter-tree__item--subcategory">',l+='<label class="gl-filter-tree__label gl-filter-tree__label--subcategory">',l+='<input type="checkbox" class="gl-filter-tree__checkbox gl-filter-tree__checkbox--subcategory" ',l+='name="categories_subcategory" value="'+r(t)+'" ',l+='data-gl-filter-category-id="'+r(e)+'" ',l+='data-gl-filter-subcategory-id="'+r(t)+'">',l+='<span class="gl-filter-tree__text">'+r(o.label||t)+"</span>",l+="</label>",l+="</li>"}),l+="</ul>"),l+="</li>"}),l+="</ul>",l}function Ji(e){if(!e||0===e.length)return'<div class="gl-empty-state">ND - Non disponible</div>';const t=C&&"function"==typeof C.escapeHtml?function(e){return C.escapeHtml(e)}:function(e){return String(e||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")};let o="";return e.forEach(function(e){o+='<span class="gl-filter-panel__tag-badge" data-tag-value="'+t(e)+'">'+t(e)+"</span>"}),o}let Hi={values:new Map,metadata:new Map,activeProfile:null,observers:new Set};const Zi=new Map;function Wi(e,t,o,n){const r={type:e,filterId:t,newValue:o,oldValue:n,timestamp:Date.now(),allValues:Object.fromEntries(Hi.values)};Hi.observers.forEach(e=>{try{e(r)}catch(e){d&&d.error("[UI.FilterStateManager] Erreur dans observateur:",e)}})}const Xi={initializeFromProfile:function(e){return e&&e.filters?(Hi.values.clear(),Hi.metadata.clear(),Hi.activeProfile=e,e.filters.forEach(e=>{if(!e.id)return;const t={type:e.type,label:e.label,required:!!e.required,min:e.min,max:e.max,options:e.options||[],optionsFrom:e.optionsFrom};Hi.metadata.set(e.id,t);let o=null;switch(e.type){case"select":case"multiselect":o=e.default||("multiselect"===e.type?[]:"");break;case"range":o=e.default??(e.min+e.max)/2;break;case"tree":case"tree-category":case"categoryTree":o=e.default||[];break;default:o=e.default||""}Hi.values.set(e.id,o)}),Wi("init",null,Hi.values),d&&d.info(`[UI.FilterStateManager] Initialis\xe9 avec ${Hi.values.size} filtres`),1):(d&&d.warn("[UI.FilterStateManager] Profil ou filtres manquants"),0)},updateFilterValue:function(e,t,o=0){if(!e||!Hi.metadata.has(e))return d&&d.warn(`[UI.FilterStateManager] Filtre inconnu: ${e}`),0;const n=Hi.metadata.get(e),r=Hi.values.get(e),i=function(e,t){if(!t)return null;switch(t.type){case"select":return"string"==typeof e?e:"";case"multiselect":case"tree":case"tree-category":case"categoryTree":return Array.isArray(e)?e:[];case"range":const o=parseFloat(e);return isNaN(o)?t.min||0:void 0!==t.min&&o<t.min?t.min:void 0!==t.max&&o>t.max?t.max:o;default:return e}}(t,n);return null===i&&null!==t?(d&&d.warn(`[UI.FilterStateManager] Valeur invalide pour ${e}:`,t),0):(Hi.values.set(e,i),o||("range"===n.type?function(e,t,o,n){Zi.has(e)&&clearTimeout(Zi.get(e));const r=setTimeout(()=>{Wi("change",e,n,o),Zi.delete(e)},200);Zi.set(e,r)}(e,0,r,i):Wi("change",e,i,r)),1)},getFilterValue:function(e){return Hi.values.get(e)||null},getAllFilterValues:function(){return Object.fromEntries(Hi.values)},getFilterMetadata:function(e){return Hi.metadata.get(e)||null},resetAllFilters:function(e=0){const t=new Map(Hi.values);Hi.values.forEach((e,t)=>{const o=Hi.metadata.get(t);if(!o)return;let n=null;switch(o.type){case"multiselect":case"tree":case"tree-category":case"categoryTree":n=[];break;case"range":n=(o.min+o.max)/2;break;default:n=""}Hi.values.set(t,n)}),e||Wi("reset",null,Hi.values,t)},addObserver:function(e){return"function"!=typeof e?(d&&d.warn("[UI.FilterStateManager] Observateur doit \xeatre une fonction"),()=>{}):(Hi.observers.add(e),function(){Hi.observers.delete(e)})},hasActiveFilters:function(){for(const[e,t]of Hi.values){const o=Hi.metadata.get(e);if(o)switch(o.type){case"multiselect":case"tree":case"tree-category":case"categoryTree":if(Array.isArray(t)&&t.length>0)return 1;break;case"select":if(t&&""!==t)return 1;break;case"range":const e=(o.min+o.max)/2;if(Math.abs(t-e)>.01)return 1}}return 0},getActiveFiltersSummary:function(){const e=[];for(const[t,o]of Hi.values){const n=Hi.metadata.get(t);if(!n)continue;let r=0,i="";switch(n.type){case"multiselect":case"tree":case"tree-category":case"categoryTree":Array.isArray(o)&&o.length>0&&(r=1,i=`${o.length} s\xe9lectionn\xe9(s)`);break;case"select":o&&""!==o&&(r=1,i=o);break;case"range":const e=(n.min+n.max)/2;Math.abs(o-e)>.01&&(r=1,i=o.toString().replace(".",","))}r&&e.push({id:t,label:n.label||t,value:i,type:n.type})}return e}};function Yi(e,t){return te("div",{className:"gl-poi-panel__text"+("multiline"===t?" gl-poi-panel__text--multiline":""),textContent:String(e)})}function Qi(e){const t=[];if(Array.isArray(e)?e.forEach(function(e){if(null!=e)if("string"==typeof e||"number"==typeof e)t.push(String(e));else if("object"==typeof e){const o="string"==typeof e.label?e.label:"string"==typeof e.text?e.text:null,n=null!=e.value?String(e.value):null;o&&n?t.push(o+" : "+n):o?t.push(o):n&&t.push(n)}}):"string"==typeof e&&e.split(/\r?\n/).forEach(function(e){const o=e.trim();o&&t.push(o)}),!t.length)return null;const o=te("ul",{className:"gl-poi-panel__list"});return t.forEach(function(e){const t=te("li",{className:"gl-poi-panel__list-item",textContent:e});o.appendChild(t)}),o}function Ki(e,t){if(!Array.isArray(e)||!e.length)return null;const o=Array.isArray(t.columns)?t.columns:[];if(!o.length)return null;const n=te("div",{className:"gl-poi-panel__table-wrapper"}),r=t.borders||{},i=[];r.outer&&i.push("gl-poi-panel__table--border-outer"),r.row&&i.push("gl-poi-panel__table--border-row"),r.column&&i.push("gl-poi-panel__table--border-column");const a=te("table",{className:"gl-poi-panel__table"+(i.length?" "+i.join(" "):""),attributes:r.color?{"data-gl-border-color":r.color}:{}}),l=te("thead"),s=te("tr",{className:"gl-poi-panel__table-row gl-poi-panel__table-row--head"});o.forEach(function(e){const t=te("th",{className:"gl-poi-panel__table-cell gl-poi-panel__table-cell--head",textContent:e.label||e.key||""});s.appendChild(t)}),l.appendChild(s),a.appendChild(l);const c=te("tbody");return e.forEach(function(e){if(!e||"object"!=typeof e)return;const t=te("tr",{className:"gl-poi-panel__table-row"});o.forEach(function(o){const n=e[o.key],r=te("td",{className:"gl-poi-panel__table-cell",textContent:null==n?"":String(n)});t.appendChild(r)}),c.appendChild(t)}),a.appendChild(c),n.appendChild(a),n}function ea(e){if(!Array.isArray(e))return null;const t=te("div",{className:"gl-poi-panel__gallery"});return e.forEach(function(e){if(!e)return;const o=te("figure",{className:"gl-poi-panel__gallery-item"}),n=te("img",{src:e.url||e,alt:e.alt||""});if(o.appendChild(n),e.caption){const t=te("figcaption",{textContent:e.caption});o.appendChild(t)}t.appendChild(o)}),t}function ta(e){let t=e;if(e&&"object"==typeof e&&!Array.isArray(e)&&Array.isArray(e.recent)&&(t=e.recent),!Array.isArray(t))return null;const o=te("div",{className:"gl-poi-panel__reviews gl-poi-sidepanel__reviews"});return t.forEach(function(e){if(!e)return;const t=te("article",{className:"gl-poi-panel__review"}),n=te("header",{className:"gl-poi-panel__review-header"}),r=te("span",{className:"gl-poi-panel__review-author",textContent:e.authorName||""});if(n.appendChild(r),"number"==typeof e.rating){const t=te("span",{className:"gl-poi-panel__review-rating",textContent:e.rating.toFixed(1)+"/5"});n.appendChild(t)}if(e.source){const t=te("span",{className:"gl-poi-panel__review-source",textContent:e.source});n.appendChild(t)}if(t.appendChild(n),e.title){const o=te("h4",{className:"gl-poi-panel__review-title",textContent:e.title});t.appendChild(o)}const i=e.text||e.comment;if(i){const e=te("p",{className:"gl-poi-panel__review-text",textContent:i});t.appendChild(e)}const a=e.date||e.createdAt;if(a){const e=te("time",{className:"gl-poi-panel__review-date",textContent:a});t.appendChild(e)}const l=te("footer",{className:"gl-poi-panel__review-footer"});if("number"==typeof e.helpfulCount){const t=te("span",{className:"gl-poi-panel__review-helpful",textContent:e.helpfulCount+" personnes ont trouv\xe9 cet avis utile"});l.appendChild(t)}if(e.url){const t=te("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",className:"gl-poi-panel__review-link",textContent:"Voir l'avis"});l.appendChild(t)}t.appendChild(l),o.appendChild(t)}),o}Object.defineProperty(Xi,"activeProfile",{get:()=>Hi.activeProfile,enumerable:1}),Object.defineProperty(Xi,"filterCount",{get:()=>Hi.values.size,enumerable:1});const oa={resolveField:H,createPlainSection:function(e,t,o){const n=te("section",{className:"gl-poi-panel__section"+(o?" "+o:"")});if(e){const t=te("h3",{className:"gl-poi-panel__section-title",textContent:e});n.appendChild(t)}const r=te("div",{className:"gl-poi-panel__section-body"});return t instanceof Node?r.appendChild(t):null!=t&&(r.textContent=String(t)),n.appendChild(r),n},createAccordionSection:function(e,t,o){const n=te("section",{className:"gl-accordion gl-poi-panel__section"+(Boolean((o||{}).defaultOpen)?" is-open":"")}),r=te("button",{type:"button",className:"gl-accordion__header"}),i=te("span",{className:"gl-accordion__title",textContent:e||""});r.appendChild(i);const a=te("span",{className:"gl-accordion__icon",attributes:{"aria-hidden":"true"},textContent:"\u25be"});r.appendChild(a),n.appendChild(r);const l=te("div",{className:"gl-accordion__body"});if(t instanceof Node)l.appendChild(t);else if(null!=t){const e=te("p",{textContent:String(t)});l.appendChild(e)}return n.appendChild(l),n},renderText:Yi,renderList:Qi,renderTable:Ki,renderGallery:ea,renderReviews:ta,buildLayoutItemContent:function(e,t){const o=t.type,n=H(e,t.field);return null!=n&&""!==n||Array.isArray(n)?"text"===o?Yi(n,t.variant):"list"===o?Qi(n):"table"===o?Ki(n,t):"gallery"===o?ea(n):"reviews"===o?ta(n):te("div",{className:"gl-poi-panel__text",textContent:String(n)}):null}},na={_map:null,_control:null,_scaleElement:null,_options:{position:"bottomleft",scaleType:"graphic",metric:1,imperial:0,maxWidth:150},init(e,t={}){const o="[GeoLeaf.UI.ScaleControl]";try{if(!e)throw new Error("Une instance de carte Leaflet est requise.");this._map=e,this._options={...this._options,...t};const n=F?.get("ui.showScale");if(0==n)return void d.info(`${o} Affichage de l'\xe9chelle d\xe9sactiv\xe9 dans la configuration.`);const r=F?.get("ui.scaleType");r&&(this._options.scaleType=r),this._createControl(),d.info(`${o} Module initialis\xe9 avec succ\xe8s (type: ${this._options.scaleType}).`)}catch(e){d.error(`${o} Erreur lors de l'initialisation :`,e.message)}},_createControl(){const e="[GeoLeaf.UI.ScaleControl]";try{"numeric"===this._options.scaleType?this._createNumericScale():(this._control=L.control.scale({position:this._options.position,metric:this._options.metric,imperial:this._options.imperial,maxWidth:this._options.maxWidth}),this._control.addTo(this._map)),d.info(`${e} Contr\xf4le d'\xe9chelle cr\xe9\xe9 et ajout\xe9 \xe0 la carte.`)}catch(t){d.error(`${e} Erreur lors de la cr\xe9ation du contr\xf4le :`,t.message)}},_createNumericScale(){const e=L.Control.extend({options:{position:this._options.position},onAdd:e=>{const t=L.DomUtil.create("div","geoleaf-scale-numeric leaflet-control");L.DomEvent.disableClickPropagation(t),L.DomEvent.disableScrollPropagation(t);const o=L.DomUtil.create("div","scale-flex-container",t);return o.style.cssText="display: flex; align-items: center; gap: 8px;",this._scaleElement=L.DomUtil.create("div","scale-content gl-scale-numeric",o),this._scaleElement.textContent="1:0",this._zoomElement=L.DomUtil.create("div","zoom-level gl-zoom-badge",o),this._zoomElement.textContent="Z0",this._boundUpdateNumericScale=this._updateNumericScale.bind(this),this._updateNumericScale(),e.on("zoomend",this._boundUpdateNumericScale),e.on("moveend",this._boundUpdateNumericScale),t},onRemove:e=>{this._boundUpdateNumericScale&&(e.off("zoomend",this._boundUpdateNumericScale),e.off("moveend",this._boundUpdateNumericScale),this._boundUpdateNumericScale=null)}});this._control=new e,this._control.addTo(this._map)},_updateNumericScale(){if(!this._scaleElement||!this._map)return;const e=this._map.getCenter(),t=this._map.getZoom();this._zoomElement&&(this._zoomElement.textContent=`Z${Number(t).toFixed(2)}`);const o=156543.03392*Math.cos(e.lat*Math.PI/180)/Math.pow(2,t),n=Math.round(96*o/.0254);let r;r=n>=1e6?`1:${(n/1e6).toFixed(1)}M`:n>=1e3?`1:${(n/1e3).toFixed(0)}K`:`1:${n}`,this._scaleElement.textContent=r},destroy(){try{this._control&&this._map&&(this._map.removeControl(this._control),this._control=null),this._scaleElement=null,this._map=null}catch(e){d.error("[GeoLeaf.UI.ScaleControl] Erreur lors de la destruction :",e.message)}},show(){!this._control&&this._map&&this._createControl()},hide(){this._control&&this._map&&(this._map.removeControl(this._control),this._control=null,this._scaleElement=null)}},ra="geoleaf_theme",ia="light",aa="dark";let la=null;function sa(){return la||(document.body.classList.contains("gl-theme-dark")?(la=aa,aa):document.body.classList.contains("gl-theme-light")?(la=ia,ia):(la=aa,aa))}function ca(e){const t=e===ia||e===aa?e:aa;la=t,document.body.classList.remove("gl-theme-light","gl-theme-dark"),document.body.classList.add(t===aa?"gl-theme-dark":"gl-theme-light");const o=document.getElementById("geoleaf-map");o&&(o.classList.remove("gl-theme-light","gl-theme-dark"),o.classList.add(t===aa?"gl-theme-dark":"gl-theme-light"));try{localStorage.setItem(ra,t)}catch(e){d&&d.warn("[UI.Theme] localStorage non disponible, th\xe8me non persist\xe9.")}da(t),globalThis.dispatchEvent&&globalThis.dispatchEvent(new CustomEvent("geoleaf:ui-theme-changed",{detail:{theme:t}}))}function ua(){ca(sa()===aa?ia:aa)}function da(e){const t=document.querySelector('[data-gl-role="theme-toggle"]');if(!t)return;const o=e===aa;t.setAttribute("data-gl-theme-state",o?"dark":"light"),t.setAttribute("aria-pressed",String(o)),t.setAttribute("aria-label",o?"Basculer en th\xe8me clair":"Basculer en th\xe8me sombre"),t.title=o?"Th\xe8me clair":"Th\xe8me sombre"}const fa={initThemeToggle:function(e={}){const t={buttonSelector:e.buttonSelector||'[data-gl-role="theme-toggle"]',autoInitOnDomReady:"boolean"==typeof e.autoInitOnDomReady?e.autoInitOnDomReady:0},o=()=>{const e=function(){let e=null;try{e=localStorage.getItem(ra)}catch(t){e=null}if(e===ia||e===aa)return e;const t=sa();return t===ia||t===aa?t:aa}();ca(e);const o=document.querySelector(t.buttonSelector);if(o){if("button"===(o.tagName||"").toLowerCase())try{o.type=o.type||"button"}catch(e){}else o.setAttribute("role","button"),o.setAttribute("tabindex","0");da(e),o.addEventListener("click",e=>{e.preventDefault(),ua()}),o.addEventListener("keydown",e=>{"Enter"!==e.key&&" "!==e.key&&"Spacebar"!==e.key||(e.preventDefault(),ua())})}else d.warn("[UI.Theme] Bouton de th\xe8me introuvable:",t.buttonSelector)};t.autoInitOnDomReady&&"loading"===document.readyState?document.addEventListener("DOMContentLoaded",o,{once:1}):o()},toggleTheme:ua,applyTheme:ca,getCurrentTheme:sa,THEME_LIGHT:ia,THEME_DARK:aa},pa={text:"gl-content__text",longtext:"gl-content__longtext",number:"gl-content__number",metric:"gl-content__metric",badge:"gl-poi-badge",rating:"gl-content__rating",image:"gl-content__image",link:"gl-content__link",list:"gl-content__list",table:"gl-content__table",tags:"gl-content__tags",tag:"gl-content__tag",coordinates:"gl-content__coordinates",gallery:"gl-content__gallery",badgeDefault:"gl-poi-badge--default",badgeStatus:"gl-poi-badge--status",badgePriority:"gl-poi-badge--priority",badgeCategory:"gl-poi-badge--category",star:"gl-star",starFull:"gl-star--full",starHalf:"gl-star--half",starEmpty:"gl-star--empty"};function ga(e,t){const o=[e];return t&&o.push(t),' class="'+o.join(" ")+'"'}function ha(e){return e?' style="'+e+'"':""}function ya(e,t){return e?"<strong>"+t(e)+":</strong> ":""}function ma(e,t,o){return"<p"+ga(t,o)+">"+e+"</p>"}function ba(e,t,o){return"<div"+ga(t,o)+">"+e+"</div>"}function _a(e){return'<span class="'+pa.star+" "+pa["star"+e.charAt(0).toUpperCase()+e.slice(1)]+'">\u2605</span>'}function La(e,t){return'<span class="'+pa.tag+'">'+t(String(e))+"</span>"}const va={CSS_CLASSES:pa,buildClassAttr:ga,buildStyleAttr:ha,buildLabel:ya,wrapInParagraph:ma,wrapInDiv:ba,createTextElement:function(e,t,o){return ma(ya(t.label,o)+o(e),pa.text,t.className)},createLongtextElement:function(e,t,o){return ba((t.label?"<p><strong>"+o(t.label)+"</strong></p>":"")+"<p>"+o(e)+"</p>",pa.longtext,t.className)},createNumberElement:function(e,t,o){const n=e.toLocaleString("fr-FR"),r=ya(t.label,o),i=t.suffix?" "+o(t.suffix):"";return ma(r+(t.prefix?o(t.prefix)+" ":"")+n+i,pa.number,t.className)},createMetricElement:function(e,t,o){const n=e.toLocaleString("fr-FR"),r=ya(t.label,o),i=t.suffix?o(t.suffix):"";return ma(r+(t.prefix?o(t.prefix):"")+n+i,pa.metric,t.className)},createBadge:function(e,t,o,n){return'<span class="'+pa.badge+" "+pa["badge"+(t=t||"default").charAt(0).toUpperCase()+t.slice(1)]+'"'+ha(o)+">"+n(e)+"</span>"},createStar:_a,createRatingElement:function(e,t,o){let n="";const r=Math.floor(e),i=e%1>=.5;for(let e=0;e<r;e++)n+=_a("full");i&&(n+=_a("half"));const a=5-r-(i?1:0);for(let e=0;e<a;e++)n+=_a("empty");const l=" ("+e.toFixed(1)+"/5)";return ba(ya(t.label,o)+n+l,pa.rating,t.className)},createImageElement:function(e,t,o){const n=t.alt?o(t.alt):"";return"<img"+ga(pa.image,t.className)+' src="'+o(e)+'" alt="'+n+'">'},createLinkElement:function(e,t,o){const n=t.text?o(t.text):o(e);return ma(ya(t.label,o)+'<a href="'+o(e)+'" target="_blank" rel="noopener noreferrer">'+n+"</a>",pa.link,t.className)},createListElement:function(e,t,o){const n=t.label?"<p><strong>"+o(t.label)+"</strong></p>":"";let r="<ul>";return e.forEach(e=>{r+="<li>"+o(String(e))+"</li>"}),r+="</ul>",ba(n+r,pa.list,t.className)},createTableElement:function(e,t,o){const n=t.label?"<p><strong>"+o(t.label)+"</strong></p>":"";let r="<table><tbody>";return Object.keys(e).forEach(t=>{const n=o(String(t)),i=o(String(e[t]));r+="<tr><th>"+n+"</th><td>"+i+"</td></tr>"}),r+="</tbody></table>",ba(n+r,pa.table,t.className)},createTag:La,createTagsElement:function(e,t,o){let n="";return e.forEach(e=>{n+=La(e,o)+" "}),ba(n.trim(),pa.tags,t.className)},createCoordinatesElement:function(e,t,o){return ma("<strong>Coordonn\xe9es:</strong> "+e.toFixed(6)+", "+t.toFixed(6),pa.coordinates,o.className)},createGalleryElement:function(e,t,o){let n="";return e.forEach(e=>{n+='<img src="'+o(e)+'" alt="Photo">'}),ba(n,pa.gallery,t.className)}},wa="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{},Ca={featureToPoiLike:function(e){if(!e||!e.geometry||!e.properties)return null;const t=e.geometry;if(!t||-1===t.type?.toLowerCase().indexOf("point"))return null;const o=Array.isArray(t.coordinates)?t.coordinates:null,n=o&&o.length>=2?[o[1],o[0]]:null,r=e.properties||{},i=Object.assign({},r);return!i.title&&r.name&&(i.title=r.name),!i.id&&e.id&&(i.id=e.id),!i.latlng&&n&&(i.latlng=n),!i.attributes&&r.attributes&&(i.attributes=r.attributes),i},featureToRouteLike:function(e){if(!e||!e.geometry||!e.properties)return null;const t=e.geometry;if(!t||-1===t.type?.toLowerCase().indexOf("line"))return null;const o=e.properties||{};if(!Object.keys(o).some(e=>!["fid","name","Name","region","REGION","Region"].includes(e))&&(void 0!==o.fid||o.Name))return null;const n=Object.assign({},o);return!n.title&&o.name&&(n.title=o.name),!n.id&&e.id&&(n.id=e.id),n.geometry=t,n},getBasePois:function(){const e=W(),t=Ca.featureToPoiLike;try{if(Mo&&"function"==typeof Mo.getFeatures){const e=(Mo.getFeatures({geometryTypes:["point"]})||[]).map(t).filter(Boolean);if(e.length)return e}}catch(t){e.warn("[GeoLeaf.UI.FilterPanel] Erreur r\xe9cup\xe9ration POI via GeoJSON:",t)}try{if(F){if("function"==typeof F.get){const e=F.get("poi");if(Array.isArray(e))return e}if(Array.isArray(F._activeProfileData?.poi))return F._activeProfileData.poi}}catch(t){e.warn("[GeoLeaf.UI.FilterPanel] Erreur r\xe9cup\xe9ration POI via Config:",t)}return wa.cfg&&Array.isArray(wa.cfg.poi)?wa.cfg.poi:[]},getBaseRoutes:function(){const e=W(),t=Ca.featureToRouteLike;try{if(Mo&&"function"==typeof Mo.getFeatures){const e=(Mo.getFeatures({geometryTypes:["line","linestring","multilinestring"]})||[]).map(t).filter(Boolean);if(e.length)return e}}catch(t){e.warn("[GeoLeaf.UI.FilterPanel] Erreur r\xe9cup\xe9ration routes via GeoJSON:",t)}try{if(F){if("function"==typeof F.get){const e=F.get("routes");if(Array.isArray(e))return e}if(Array.isArray(F._activeProfileData?.routes))return F._activeProfileData.routes}}catch(t){e.warn("[GeoLeaf.UI.FilterPanel] Erreur r\xe9cup\xe9ration routes via Config:",t)}return wa.cfg&&Array.isArray(wa.cfg.routes)?wa.cfg.routes:[]},getFilterPanelElement:function(){let e=document.getElementById("gl-filter-panel");return e||(e=document.getElementById("gl-left-panel"),e||(W().warn("[GeoLeaf.UI.FilterPanel] Aucun conteneur de panneau de filtres trouv\xe9 (#gl-filter-panel / #gl-left-panel)."),null))}};Ca.getNestedValue=Ue,Ca.getRepresentativePoint=function(e){if(!e||!e.coordinates)return null;if("Polygon"===e.type||"MultiPolygon"===e.type){const t="Polygon"===e.type?e.coordinates[0][0]:e.coordinates[0][0][0];return t?{lng:t[0],lat:t[1]}:null}if("LineString"===e.type){const t=e.coordinates;if(t&&t.length>0){const e=Math.floor(t.length/2);return{lng:t[e][0],lat:t[e][1]}}}else if("MultiLineString"===e.type){const t=e.coordinates[0];if(t&&t.length>0){const e=Math.floor(t.length/2);return{lng:t[e][0],lat:t[e][1]}}}else{if("Point"===e.type)return{lng:e.coordinates[0],lat:e.coordinates[1]};if("MultiPoint"===e.type){const t=e.coordinates[0];return t?{lng:t[0],lat:t[1]}:null}}return null},Ca.collectAllTags=function(e){const t=new Set;e.forEach(function(e){const o=e.properties||e,n=(o.attributes||e.attributes||{}).tags||o.tags||e.tags;Array.isArray(n)&&n.length>0&&n.forEach(function(e){e&&"string"==typeof e&&t.add(e)})});const o=Array.from(t);return o.sort(),o};let Ia=0,Sa=null,Ea=null,Aa=null,Pa=null;const Ga={_eventCleanups:[],initProximityFilter:function(e){const t=W();if(e){if(Ia=0,Sa=null,Ea=null,Aa=e,Pa=null,ue){const t=function(e){const t=e.target.closest("[data-filter-proximity-radius]");if(!t)return;const o=t.closest(".gl-filter-panel__proximity");if(!o)return;const n=o.closest("[data-gl-filter-id='proximity']");if(!n)return;const r=parseFloat(t.value);if(n.setAttribute("data-proximity-radius",r),Sa){const e=1e3*r;Sa.setRadius(e)}},o=function(t){const o=t.target.closest("[data-filter-proximity-btn]");o&&(t.preventDefault(),Ga.toggleProximityMode(o,e))};Ga._eventCleanups.push(ue.on(document,"input",t,0,"ProximityFilter.radiusInput")),Ga._eventCleanups.push(ue.on(document,"click",o,0,"ProximityFilter.buttonClick"))}else t.warn("[ProximityFilter] EventListenerManager not available - listeners will not be cleaned up"),document.addEventListener("input",function(e){const t=e.target.closest("[data-filter-proximity-radius]");if(!t)return;const o=t.closest(".gl-filter-panel__proximity");if(!o)return;const n=o.closest("[data-gl-filter-id='proximity']");if(!n)return;const r=parseFloat(t.value);if(n.setAttribute("data-proximity-radius",r),Sa){const e=1e3*r;Sa.setRadius(e)}}),document.addEventListener("click",function(t){const o=t.target.closest("[data-filter-proximity-btn]");o&&(t.preventDefault(),Ga.toggleProximityMode(o,e))});t.info("[GeoLeaf.UI.FilterPanel] Filtre de proximit\xe9 initialis\xe9")}else t.warn("[GeoLeaf.UI.FilterPanel] Carte non disponible pour le filtre de proximit\xe9")},destroy:function(){const e=W();Ga._eventCleanups&&Ga._eventCleanups.length>0&&(Ga._eventCleanups.forEach(e=>{"function"==typeof e&&e()}),Ga._eventCleanups=[],e.info("[ProximityFilter] Event listeners cleaned up")),Sa&&(Aa.removeLayer(Sa),Sa=null),Ea&&(Aa.removeLayer(Ea),Ea=null),Aa=null,Ia=0},toggleProximityMode:function(e,t){Ia=!Ia;const o=e.closest(".gl-filter-panel__proximity"),n=o.querySelector(".gl-filter-panel__proximity-range"),r=o.querySelector(".gl-filter-panel__proximity-instruction");Ia?(e.textContent="D\xe9sactiver",e.classList.add("is-active"),n&&(n.style.display="block"),r&&(r.style.display="block"),xi.userPosition&&Date.now()-xi.userPosition.timestamp<3e5?Ga.activateGPSMode(o,t):Ga.activateManualMode(o,t)):Ga.deactivateProximityMode(e,o,t)},activateGPSMode:function(e,t){const o=W();o.info("[GeoLeaf.UI.FilterPanel] Utilisation de la position GPS pour la recherche par proximit\xe9");const n=e.querySelector("[data-filter-proximity-radius]"),r=n?parseFloat(n.value):10,i=1e3*r,a=e.closest("[data-gl-filter-id='proximity']");if(!a)return void o.warn("[GeoLeaf.UI.FilterPanel] Wrapper proximity non trouv\xe9");Sa&&t.removeLayer(Sa),Ea&&t.removeLayer(Ea);const l=globalThis.L.latLng(xi.userPosition.lat,xi.userPosition.lng),s=F.get("ui.interactiveShapes",0);Sa=globalThis.L.circle(l,{radius:i,color:"#c2410c",fillColor:"#c2410c",fillOpacity:.2,weight:2,interactive:s}).addTo(t),xi.active?(Ea=null,o.info("[GeoLeaf.UI.FilterPanel] Cercle de proximit\xe9 affich\xe9 autour du marqueur GPS")):(Ea=globalThis.L.marker(l,{draggable:1,icon:globalThis.L.divIcon({className:"gl-proximity-gps-marker",html:'<div style="width: 20px; height: 20px; background: #2563eb; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',iconSize:[20,20],iconAnchor:[10,10]})}).addTo(t),Ea.on("dragend",function(){const e=Ea.getLatLng();Sa&&Sa.setLatLng(e),a.setAttribute("data-proximity-lat",e.lat),a.setAttribute("data-proximity-lng",e.lng),o.info("[GeoLeaf.UI.FilterPanel] Point de proximit\xe9 GPS d\xe9plac\xe9:",{lat:e.lat,lng:e.lng,radius:r})})),a.setAttribute("data-proximity-lat",l.lat),a.setAttribute("data-proximity-lng",l.lng),a.setAttribute("data-proximity-radius",r),a.setAttribute("data-proximity-active","true"),t.setView(l,Math.max(t.getZoom(),14),{animate:1,duration:.5}),o.info("[GeoLeaf.UI.FilterPanel] Point de proximit\xe9 GPS d\xe9fini:",{lat:l.lat,lng:l.lng,radius:r}),Pa=null},activateManualMode:function(e,t){const o=W();o.info("[GeoLeaf.UI.FilterPanel] Mode manuel : cliquez sur la carte pour d\xe9finir le point de recherche"),t.getContainer().style.cursor="crosshair",Pa=function(n){const r=e.querySelector("[data-filter-proximity-radius]"),i=r?parseFloat(r.value):10,a=1e3*i,l=e.closest("[data-gl-filter-id='proximity']");if(!l)return void o.warn("[GeoLeaf.UI.FilterPanel] Wrapper proximity non trouv\xe9");Sa&&t.removeLayer(Sa),Ea&&t.removeLayer(Ea);const s=F.get("ui.interactiveShapes",0);Sa=globalThis.L.circle(n.latlng,{radius:a,color:"#c2410c",fillColor:"#c2410c",fillOpacity:.2,weight:2,interactive:s}).addTo(t),Ea=globalThis.L.marker(n.latlng,{draggable:1}).addTo(t),Ea.on("dragend",function(){const e=Ea.getLatLng();Sa&&Sa.setLatLng(e),l.setAttribute("data-proximity-lat",e.lat),l.setAttribute("data-proximity-lng",e.lng),o.info("[GeoLeaf.UI.FilterPanel] Point de proximit\xe9 d\xe9plac\xe9:",{lat:e.lat,lng:e.lng,radius:i})}),l.setAttribute("data-proximity-lat",n.latlng.lat),l.setAttribute("data-proximity-lng",n.latlng.lng),l.setAttribute("data-proximity-radius",i),l.setAttribute("data-proximity-active","true"),t.getContainer().style.cursor="",o.info("[GeoLeaf.UI.FilterPanel] Point de proximit\xe9 d\xe9fini:",{lat:n.latlng.lat,lng:n.latlng.lng,radius:i}),t.off("click",Pa),Pa=null},t.on("click",Pa)},deactivateProximityMode:function(e,t,o){const n=W();e.textContent="Activer",e.classList.remove("is-active");const r=t.querySelector(".gl-filter-panel__proximity-range"),i=t.querySelector(".gl-filter-panel__proximity-instruction");r&&(r.style.display="none"),i&&(i.style.display="none"),o.getContainer().style.cursor="",Pa&&(o.off("click",Pa),Pa=null),Sa&&(o.removeLayer(Sa),Sa=null),Ea&&(o.removeLayer(Ea),Ea=null);const a=t.closest("[data-gl-filter-id='proximity']");a&&(a.removeAttribute("data-proximity-active"),a.removeAttribute("data-proximity-lat"),a.removeAttribute("data-proximity-lng")),n.info("[GeoLeaf.UI.FilterPanel] Mode proximit\xe9 d\xe9sactiv\xe9")},resetProximity:function(){Aa&&(Pa&&(Aa.off("click",Pa),Pa=null),Aa.getContainer().style.cursor="",Sa&&(Aa.removeLayer(Sa),Sa=null),Ea&&(Aa.removeLayer(Ea),Ea=null),Ia=0)}},Ta={getDefaultState:function(){return{categoriesTree:[],subCategoriesTree:[],minRating:NaN,hasMinRating:0,selectedTags:[],hasTags:0,dataTypes:{poi:1,routes:1},searchText:"",hasSearchText:0,proximity:{active:0,center:null,radius:10}}},readFiltersFromPanel:function(e){const t=Ta.getDefaultState();if(!e)return t;const o=e.querySelector("[data-gl-filter-id='dataTypes'] input[value='poi']"),n=e.querySelector("[data-gl-filter-id='dataTypes'] input[value='routes']");o&&(t.dataTypes.poi=o.checked),n&&(t.dataTypes.routes=n.checked);const r=e.querySelector("[data-gl-filter-id='searchText'] input[type='text']");r&&""!==r.value.trim()&&(t.searchText=r.value.trim().toLowerCase(),t.hasSearchText=1);const i=e.querySelector("[data-gl-filter-id='proximity']");if(i){const e="true"===i.getAttribute("data-proximity-active"),o=parseFloat(i.getAttribute("data-proximity-lat")),n=parseFloat(i.getAttribute("data-proximity-lng")),r=parseFloat(i.getAttribute("data-proximity-radius"));!e||isNaN(o)||isNaN(n)||isNaN(r)||(t.proximity.active=1,t.proximity.center={lat:o,lng:n},t.proximity.radius=r)}e.querySelectorAll("input.gl-filter-tree__checkbox--category:checked").forEach(function(e){const o=e.value;o&&t.categoriesTree.push(String(o))}),e.querySelectorAll("input.gl-filter-tree__checkbox--subcategory:checked").forEach(function(e){const o=e.getAttribute("data-gl-filter-subcategory-id");o&&t.subCategoriesTree.push(String(o))});const a=e.querySelector("[data-gl-filter-id='minRating'] input[type='range']");if(a&&""!==a.value){const e=parseFloat(a.value);isNaN(e)||(t.minRating=e,t.hasMinRating=e>0)}const l=e.querySelector("[data-gl-filter-id='tags'] .gl-filter-panel__tags-container");if(l){const e=l.querySelectorAll(".gl-filter-panel__tag-badge.is-selected"),o=Array.from(e).map(function(e){return e.getAttribute("data-tag-value")}).filter(Boolean);t.selectedTags=o,t.hasTags=o.length>0}return t},resetControls:function(e){if(!e)return;e.querySelectorAll("[data-gl-filter-id='dataTypes'] input[type='checkbox']").forEach(function(e){e.checked=1});const t=e.querySelector("[data-gl-filter-id='searchText'] input[type='text']");t&&(t.value="");const o=e.querySelector("[data-gl-filter-id='proximity']");if(o){o.removeAttribute("data-proximity-active"),o.removeAttribute("data-proximity-lat"),o.removeAttribute("data-proximity-lng"),o.removeAttribute("data-proximity-radius");const e=o.querySelector(".gl-filter-panel__proximity-btn");e&&(e.classList.remove("is-active"),e.textContent=e.getAttribute("data-label-inactive")||"Activer");const t=o.querySelector(".gl-filter-panel__proximity-range");t&&(t.style.display="none");const n=o.querySelector(".gl-filter-panel__proximity-instruction");n&&(n.style.display="none"),Ga.resetProximity()}e.querySelectorAll(".gl-filter-tree__checkbox").forEach(function(e){e.checked=0}),e.querySelectorAll(".gl-filter-panel__tag-badge.is-selected").forEach(function(e){e.classList.remove("is-selected")}),e.querySelectorAll("select.gl-filter-panel__control--select").forEach(function(e){e.multiple?Array.from(e.options).forEach(function(e){e.selected=0}):e.value=""});const n=e.querySelector("[data-gl-filter-id='minRating'] input[type='range']"),r=e.querySelector("[data-gl-filter-id='minRating'] .gl-filter-panel__range-value");if(n){const e=""!==n.min?n.min:"0";n.value=e,r&&(r.textContent=String(e).replace(".",","))}}},xa={init:function(e,t){ur?ur.init(e,t):d&&d.error("[POI] Module Core non charg\xe9.")},loadAndDisplay:function(){ur?ur.loadAndDisplay():d&&d.error("[POI] Module Core non charg\xe9.")},displayPois:function(e){ur?ur.displayPois(e):d&&d.error("[POI] Module Core non charg\xe9.")},addPoi:function(e){return ur?ur.addPoi(e):(d&&d.error("[POI] Module Core non charg\xe9."),null)},add:function(e){return ur?ur.addPoi(e):(d&&d.error("[POI] Module Core non charg\xe9."),0)},getAllPois:function(){return ur?ur.getAllPois():[]},getPoiById:function(e){return ur?ur.getPoiById(e):null},reload:function(e){ur?ur.reload(e):d&&d.error("[POI] Module Core non charg\xe9.")},showPoiDetails:async function(e,t){ar?await ar.openSidePanel(e,t):d&&d.error("[POI] Module SidePanel non charg\xe9.")},hideSidePanel:function(){ar?ar.closeSidePanel():d&&d.error("[POI] Module SidePanel non charg\xe9.")},openSidePanelWithLayout:function(e,t){this.showPoiDetails(e,t)},getLayer:function(){if(!Ko)return null;const e=Ko.state;return e.poiClusterGroup||e.poiLayerGroup},getDisplayedPoisCount:function(){return ur?ur.getDisplayedPoisCount():(d&&d.error("[POI] Module Core non charg\xe9."),0)},_clearAllForTests:function(){if(!Ko)return;const e=Ko.state;d&&d.info("[POI] _clearAllForTests: Suppression de",e.allPois.length,"POI(s) et",e.poiMarkers.size,"marqueur(s)"),e.allPois=[],e.poiMarkers.clear(),e.poiClusterGroup&&e.poiClusterGroup.clearLayers(),e.poiLayerGroup&&e.poiLayerGroup.clearLayers()}},Oa="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{};function Ma(e,t){return t.split(".").reduce((e,t)=>e&&void 0!==e[t]?e[t]:null,e)}function ka(){try{if(Oa.GeoLeaf?.Config&&"function"==typeof Oa.GeoLeaf.Config.getActiveProfile){const e=Oa.GeoLeaf.Config.getActiveProfile(),t=new Set;if(e?.panels?.detail?.layout&&e.panels.detail.layout.filter(e=>1==e.search&&e.field).forEach(e=>t.add(e.field)),e?.panels?.route?.layout&&e.panels.route.layout.filter(e=>1==e.search&&e.field).forEach(e=>t.add(e.field)),t.size>0)return Array.from(t);if(Array.isArray(e?.panels?.search?.filters)){const t=e.panels.search.filters.find(e=>"search"===e.type);if(t?.searchFields?.length>0)return t.searchFields,t.searchFields}}}catch(e){d.warn("[Filters] Erreur extraction searchFields du profil:",e)}return["title","label","name"]}const Na="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{};function Fa(e,t,o,n){const r=(o-e)*Math.PI/180,i=(n-t)*Math.PI/180,a=Math.sin(r/2)**2+Math.cos(e*Math.PI/180)*Math.cos(o*Math.PI/180)*Math.sin(i/2)**2;return 12742e3*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))}const Da="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{};function Ua(e,t,o,n){const r=(o-e)*Math.PI/180,i=(n-t)*Math.PI/180,a=Math.sin(r/2)**2+Math.cos(e*Math.PI/180)*Math.cos(o*Math.PI/180)*Math.sin(i/2)**2;return 12742e3*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))}const Ra={filterPoiList:function(e,t){const o=t.categoriesTree||[],n=t.subCategoriesTree||[],r=o.length>0,i=n.length>0,a=!!t.hasMinRating,l=t.minRating,s=t.selectedTags||[],c=t.hasTags,u=t.dataTypes||{poi:1,routes:1},d=(t.searchText||"").toLowerCase(),f=t.hasSearchText||0,p=t.proximity||{active:0};if(!Array.isArray(e)||0===e.length)return[];e.length,p.active;const g=Na.GeoLeaf?.Utils?.getDistance??Fa;return e.filter(e=>{const h=e.attributes||{},y=e.properties||{},m=e.type||h.type||y.type||"poi";if("route"===m||"routes"===m){if(!u.routes)return 0}else if(!u.poi)return 0;if(f&&!(t.searchFields?.length>0?t.searchFields:ka()).some(t=>{const o=Ma(e,t);return Array.isArray(o)?o.some(e=>String(e).toLowerCase().includes(d)):o&&String(o).toLowerCase().includes(d)}))return 0;if(p.active&&p.center){let t,o;if(e.latlng&&Array.isArray(e.latlng)&&2===e.latlng.length?[t,o]=e.latlng:(t=e.lat??e.latitude??h.latitude??y.latitude??e.coordinates?.[1]??e.geometry?.coordinates?.[1],o=e.lng??e.longitude??h.longitude??y.longitude??e.coordinates?.[0]??e.geometry?.coordinates?.[0]),!t||!o)return 0;if(g(p.center.lat,p.center.lng,t,o)>p.radius)return 0}const b=String(h.categoryId??e.categoryId??e.category??y.categoryId??y.category??""),_=String(h.subCategoryId??e.subCategoryId??e.subCategory??e.sub_category??y.subCategoryId??y.sub_category??"");if(r||i)if(i){if(!_||!n.includes(_))return 0}else if(r&&(!b||!o.includes(b)))return 0;if(a){const{avg:t,hasRating:o}=function(e,t,o){let n=0,r=0;const i=e.reviews||t.reviews||o.reviews;return i&&"object"==typeof i&&!Array.isArray(i)?"number"==typeof i.rating&&(n=i.rating,r=1):Array.isArray(i)&&i.length>0?(n=i.reduce((e,t)=>e+(Number(t.rating)||0),0)/i.length,r=n>0):"number"==typeof e.rating?(n=e.rating,r=1):"number"==typeof t.rating?(n=t.rating,r=1):"number"==typeof o.rating&&(n=o.rating,r=1),{avg:n,hasRating:r}}(h,e,y);if(!o||t<l)return 0}if(c){const t=(v=h.tags??e.tags??y.tags,Array.isArray(v)?v.map(e=>String(e).trim()).filter(Boolean):"string"==typeof v?v.split(/[,;]+/).map(e=>e.trim()).filter(Boolean):[]);if(!s.some(e=>t.includes(e)))return 0}var v;return 1})},filterRouteList:function(e,t){const o=t.categoriesTree||[],n=t.subCategoriesTree||[],r=o.length>0,i=n.length>0,a=t.selectedTags||[],l=t.hasTags,s=!!t.hasMinRating,c=t.minRating,u=(t.searchText||"").toLowerCase(),d=t.hasSearchText||0,f=t.proximity||{active:0};if(!Array.isArray(e)||0===e.length)return[];e.length,f.active;const p=Da.GeoLeaf?.Utils?.getDistance??Ua;return e.filter(e=>{const g=e.attributes||{},h=e.properties||{};if(d&&!(t.searchFields?.length>0?t.searchFields:ka()).some(t=>{const o=Ma(e,t);return o&&String(o).toLowerCase().includes(u)}))return 0;const y=String(g.categoryId??e.categoryId??e.category??h.categoryId??h.category??""),m=String(g.subCategoryId??e.subCategoryId??e.subCategory??e.sub_category??h.subCategoryId??h.sub_category??"");if(r||i)if(i){if(!m||!n.includes(m))return 0}else if(r&&(!y||!o.includes(y)))return 0;if(l){const t=(b=g.tags??e.tags??h.tags,Array.isArray(b)?b.map(e=>String(e).trim()).filter(Boolean):"string"==typeof b?b.split(/[,;]+/).map(e=>e.trim()).filter(Boolean):[]);if(!a.some(e=>t.includes(e)))return 0}var b;if(s){const{avg:t,hasRating:o}=function(e,t,o){let n=0,r=0;const i=e.reviews||t.reviews||o.reviews;return i&&"object"==typeof i&&!Array.isArray(i)?"number"==typeof i.rating&&(n=i.rating,r=1):Array.isArray(i)&&i.length>0?(n=i.reduce((e,t)=>e+(Number(t.rating)||0),0)/i.length,r=n>0):"number"==typeof e.rating?(n=e.rating,r=1):"number"==typeof t.rating?(n=t.rating,r=1):"number"==typeof o.rating&&(n=o.rating,r=1),{avg:n,hasRating:r}}(g,e,h);if(!o||t<c)return 0}if(f.active&&f.center){const t=function(e){if(Array.isArray(e.geometry)&&e.geometry.length>0){if(Array.isArray(e.geometry[0])&&"number"==typeof e.geometry[0][0])return e.geometry.map(e=>[e[0],e[1]]);if("LineString"===e.geometry[0]?.type&&Array.isArray(e.geometry[0].coordinates))return e.geometry[0].coordinates.map(e=>[e[1],e[0]])}return"LineString"===e.geometry?.type&&Array.isArray(e.geometry.coordinates)?e.geometry.coordinates.map(e=>[e[1],e[0]]):[]}(e);if(0===t.length)return 0;if(!t.some(([e,t])=>p(f.center.lat,f.center.lng,e,t)<=f.radius))return 0}return 1})}},ja=()=>Ca,$a=()=>Ta,Ba={};let za=0,Va=null,qa=0;function Ja(e){ee.clearElementFast(e);const t=ee.createSVGIcon(16,16,"M15 18l-6-6 6-6",{stroke:"currentColor",strokeWidth:"6",fill:"none"});e.appendChild(t)}function Ha(e){ee.clearElementFast(e);const t=ee.createSVGIcon(16,16,"M9 6l6 6-6 6",{stroke:"currentColor",strokeWidth:"6",fill:"none"});e.appendChild(t)}Ba.destroy=function(){Va&&(clearTimeout(Va),Va=null)},Ba.refreshPoiLayer=function(e){const t=W(),o="function"==typeof F.get?F.get("poiConfig"):null;o&&0==o.enabled||(xa?("function"==typeof xa._clearAllForTests?xa._clearAllForTests():t.warn("[GeoLeaf.UI.FilterPanel] GeoLeaf.POI._clearAllForTests indisponible."),e.forEach(function(e){try{xa.addPoi(e)}catch(o){t.warn("[GeoLeaf.UI.FilterPanel] Impossible d'ajouter un POI filtr\xe9:",e,o)}}),e.length):t.warn("[GeoLeaf.UI.FilterPanel] GeoLeaf.POI indisponible, pas de rafra\xeechissement de la couche POI."))},Ba.filterGeoJSONLayers=function(e){const t=W(),o=ja(),n=Mo;if(!n||"function"!=typeof n.filterFeatures)return;const r=e.categoriesTree&&e.categoriesTree.length>0,i=e.subCategoriesTree&&e.subCategoriesTree.length>0,a=e.hasTags&&e.selectedTags&&e.selectedTags.length>0,l=e.selectedTags||[],s=e.proximity&&e.proximity.active,c=e.hasSearchText&&e.searchText,u=e.searchText||"",d=()=>(d,f)=>{const p=d.properties||{};if(c&&!((e,r)=>{if(!c)return 1;const i=(e=>{try{const t=n.getLayerData(e);if(t&&t.config){if(t.config.search&&Array.isArray(t.config.search.indexingFields))return t.config.search.indexingFields;if(Array.isArray(t.config.indexingFields))return t.config.indexingFields;if(Array.isArray(t.config.searchFields))return t.config.searchFields}}catch(e){t.warn("[GeoLeaf.UI.FilterPanel] Erreur r\xe9cup\xe9ration champs de recherche:",e)}try{const e=F._activeProfileData;if(e&&e.search&&e.search.filters){const t=e.search.filters.find(e=>"search"===e.type);if(t&&Array.isArray(t.searchFields))return t.searchFields}}catch(e){t.warn("[GeoLeaf.UI.FilterPanel] Erreur r\xe9cup\xe9ration champs par d\xe9faut:",e)}return["title","description","properties.title","properties.name","properties.description","attributes.nom"]})(r),a=u.toLowerCase();for(let t=0;t<i.length;t++){let n=i[t],r=null,l=n;if(n.startsWith("properties.")&&(l=n.substring(11)),e.properties&&(r=o.getNestedValue(e.properties,l)),r||(r=o.getNestedValue(e,n)),r&&String(r).toLowerCase().includes(a))return 1}return 0})(d,f))return 0;if(r||i){const t=p.categoryId||p.category||null,o=p.subcategoryId||p.subCategoryId||p.subcategory||p.sub_category||null;if(!t&&!o)return 0;if(i&&(!o||!e.subCategoriesTree.includes(String(o))))return 0;if(r&&!i&&(!t||!e.categoriesTree.includes(String(t))))return 0}if(a){let e=p.tags||[];if(Array.isArray(e)||(e="string"==typeof e?e.split(/[,;]+/):[]),e=e.map(e=>String(e).trim()).filter(Boolean),!l.some(t=>e.includes(t)))return 0}if(s&&e.proximity.center&&J){const t=o.getRepresentativePoint(d.geometry);if(t&&J(e.proximity.center.lat,e.proximity.center.lng,t.lat,t.lng)>e.proximity.radius)return 0}return 1};n.filterFeatures(d(),{geometryType:"polygon"}),n.filterFeatures(d(),{geometryType:"line"}),n.filterFeatures(d(),{geometryType:"point"})},Ba.applyFiltersNow=function(e,t){!function(e,t){Va&&clearTimeout(Va),qa=t||0,Va=setTimeout(()=>{Ba._applyFiltersImmediate(e,qa)},300)}(e,t)},Ba._applyFiltersImmediate=function(e,t){const o=W(),n=ja(),r=$a(),i=Date.now();if(i-za<100)return;za=i;const a=n.getBasePois(),l=n.getBaseRoutes(),s=r.readFiltersFromPanel(e);if(Ba.filterGeoJSONLayers(s),!a.length&&!l.length)return void o.info("[GeoLeaf.UI.FilterPanel] Aucun POI ni route source trouv\xe9.");if(Gi&&"function"==typeof Gi.isInitialized&&Gi.isInitialized())if(s.dataTypes.routes)if(t)Gi.show();else{let e=l;e=Ra&&"function"==typeof Ra.filterRouteList?Ra.filterRouteList(l,s):l,o.info("[GeoLeaf.UI.FilterPanel] Filtres appliqu\xe9s sur les routes.",{total:l.length,result:e.length}),"function"==typeof Gi.filterVisibility?Gi.filterVisibility(e):"function"==typeof Gi.loadFromConfig&&Gi.loadFromConfig(e),Gi.show()}else Gi.hide();const c=Ba.filterPoiList(a,s);o.info("[GeoLeaf.UI.FilterPanel] Filtres appliqu\xe9s sur les POI.",{total:a.length,result:c.length,filters:s}),Ba.refreshPoiLayer(c)},Ba.filterPoiList=function(e,t){return Ra&&"function"==typeof Ra.filterPoiList?Ra.filterPoiList(e,t):(W().warn("[GeoLeaf.UI.FilterPanel] Module Filters non charg\xe9, retour liste compl\xe8te"),e||[])},Ba.filterRouteList=function(e,t){return Ra&&"function"==typeof Ra.filterRouteList?Ra.filterRouteList(e,t):(W().warn("[GeoLeaf.UI.FilterPanel] Module Filters non charg\xe9, retour liste compl\xe8te"),e||[])},Ba.applyFiltersInitial=function(){const e=W(),t=ja(),o=$a(),n=t.getFilterPanelElement();if(!n)return void e.warn("[GeoLeaf.UI.FilterPanel] Panneau de filtres non trouv\xe9, impossible d'appliquer les filtres initiaux.");e.info("[GeoLeaf.UI.FilterPanel] Application des filtres initiaux...");const r=o.readFiltersFromPanel(n),i=t.getBasePois(),a=t.getBaseRoutes();if(!i.length&&!a.length)return void e.info("[GeoLeaf.UI.FilterPanel] Aucun POI ni route source trouv\xe9.");if(Gi&&"function"==typeof Gi.isInitialized&&Gi.isInitialized())if(r.dataTypes.routes){let e=Ba.filterRouteList(a,r);"function"==typeof Gi.loadFromConfig&&Gi.loadFromConfig(e),Gi.show()}else Gi.hide();const l=Ba.filterPoiList(i,r);e.info("[GeoLeaf.UI.FilterPanel] POI filtr\xe9s pour chargement initial.",{total:i.length,result:l.length}),Ba.refreshPoiLayer(l)};const Za={_cache:{},_openAccordions:new Set,loadCategories(e){const t=`categories_${e}`;if(this._cache[t])return this._cache[t];const o=this._scanCategories(e);return this._cache[t]=o,o},loadTags(e){const t=`tags_${e}`;if(this._cache[t])return this._cache[t];const o=this._scanTags(e);return this._cache[t]=o,o},_scanCategories(e){const t=performance.now(),o=this._getVisibleLayerIds(e);let n=[];try{Mo&&"function"==typeof Mo.getFeatures&&(n=Mo.getFeatures()||[])}catch(e){return d.warn("[LazyLoader] Erreur r\xe9cup\xe9ration features:",e),{categories:new Map,usedIds:new Set}}const r=n.filter(e=>{const t=e.properties?._layerId||e.properties?.layerId||e._layerId;return o.includes(t)});r.length,o.length;const i=new Set;r.forEach(e=>{const t=e.properties||{};t.categoryId&&i.add(t.categoryId),t.subcategoryId&&i.add(t.subcategoryId),t.subCategoryId&&i.add(t.subCategoryId)});const a=(performance.now()-t).toFixed(2);return d.info(`[LazyLoader] Scan cat\xe9gories termin\xe9 en ${a}ms: ${i.size} cat\xe9gories trouv\xe9es`),{usedIds:i,visibleLayerIds:o}},_scanTags(e){const t=performance.now(),o=this._getVisibleLayerIds(e);let n=[];try{Mo&&"function"==typeof Mo.getFeatures&&(n=Mo.getFeatures()||[])}catch(e){return d.warn("[LazyLoader] Erreur r\xe9cup\xe9ration features:",e),[]}const r=n.filter(e=>{const t=e.properties?._layerId||e.properties?.layerId||e._layerId;return o.includes(t)}),i=new Set;r.forEach(e=>{const t=e.properties||{},o=(t.attributes||{}).tags||t.tags;Array.isArray(o)&&o.forEach(e=>{e&&"string"==typeof e&&i.add(e)})});const a=Array.from(i).sort(),l=(performance.now()-t).toFixed(2);return d.info(`[LazyLoader] Scan tags termin\xe9 en ${l}ms:`,{totalFeatures:n.length,visibleFeatures:r.length,tagsFound:a.length}),a},_getVisibleLayerIds(e){let t=[];try{Mo&&"function"==typeof Mo.getAllLayers&&(t=Mo.getAllLayers().filter(e=>1==e.visible).map(e=>e.id),t.length)}catch(e){d.warn("[LazyLoader] Erreur r\xe9cup\xe9ration couches visibles:",e)}return t},markAccordionOpen(e,t){this._openAccordions.add({type:e,element:t})},markAccordionClosed(e){this._openAccordions.forEach(t=>{t.element===e&&(this._openAccordions.delete(t),t.type)})},invalidateCacheForTheme(e){delete this._cache[`categories_${e}`],delete this._cache[`tags_${e}`],d.info(`[LazyLoader] Cache invalid\xe9 pour th\xe8me: ${e}`)},clearCache(){this._cache={},d.info("[LazyLoader] Cache compl\xe8tement vid\xe9")},refreshOpenAccordions(){if(0===this._openAccordions.size)return;d.info(`[LazyLoader] Rafra\xeechissement de ${this._openAccordions.size} accord\xe9on(s) ouvert(s)`);const e=Ei.getCurrentTheme();e?this._openAccordions.forEach(({type:t,element:o})=>{const n=this._saveCheckboxStates(o),r=o.querySelector("[data-lazy-type]");r?(o.dataset.lazyLoaded="false","categories"===t?this._rerenderCategories(r,e,n):"tags"===t&&this._rerenderTags(r,e,n),o.dataset.lazyLoaded="true"):d.warn("[LazyLoader] Zone [data-lazy-type] introuvable dans l'accord\xe9on")}):d.warn("[LazyLoader] Impossible de r\xe9cup\xe9rer le th\xe8me actif")},_rerenderCategories(e,t,o){const n=qi(this.loadCategories(t));e.textContent="";const r=document.createRange().createContextualFragment(n.replace(/<script[\s\S]*?<\/script>/gi,""));e.appendChild(r),this._restoreCheckboxStates(e,o)},_rerenderTags(e,t,o){const n=Ji(this.loadTags(t));e.textContent="";const r=document.createRange().createContextualFragment(n.replace(/<script[\s\S]*?<\/script>/gi,""));e.appendChild(r),this._restoreCheckboxStates(e,o)},_saveCheckboxStates(e){const t={};return e.querySelectorAll('input[type="checkbox"]').forEach(e=>{const o=e.dataset.glFilterCategoryId,n=e.dataset.glFilterSubcategoryId,r=e.value;let i;n?i=`${o}:${n}`:o?i=o:r&&(i=r),i&&(t[i]=e.checked)}),t},_restoreCheckboxStates(e,t){t&&0!==Object.keys(t).length&&e.querySelectorAll('input[type="checkbox"]').forEach(e=>{const o=e.dataset.glFilterCategoryId,n=e.dataset.glFilterSubcategoryId,r=e.value;let i;n?i=`${o}:${n}`:o?i=o:r&&(i=r),i&&void 0!==t[i]&&(e.checked=t[i])})}};document.addEventListener("geoleaf:theme:applied",()=>{d.info("[LazyLoader] \xc9v\xe9nement theme:applied d\xe9tect\xe9 \u2014 invalidation compl\xe8te"),Za.clearCache();const e=document.querySelectorAll(".gl-filter-panel__group--accordion[data-lazy-loaded]");e.forEach(e=>{e.dataset.lazyLoaded="false"}),e.length,Za.refreshOpenAccordions()}),document.addEventListener("geoleaf:geojson:visibility-changed",e=>{const t=e.detail||{};d.info("[LazyLoader] Visibilit\xe9 couche chang\xe9e:",t.layerId,t.visible);const o=Ei.getCurrentTheme();o&&(Za.invalidateCacheForTheme(o),Za.refreshOpenAccordions())});const Wa=()=>Ca,Xa={_eventCleanups:[],buildFilterPanelFromActiveProfile:function(e){const t=W(),o=Wa(),n=Ta,r=Ba,i=X();if(!i)return void t.warn("[GeoLeaf.UI.FilterPanel] Aucun profil actif trouv\xe9");t.info("[GeoLeaf.UI.FilterPanel] Profil actif:",i.id||"unknown");const a=i.panels&&i.panels.search||i.search;if(!a)return void t.warn("[GeoLeaf.UI.FilterPanel] Aucune configuration search/panels.search dans le profil");const l=a&&Array.isArray(a.filters)?a.filters:null;if(!l||!l.length)return void t.warn("[GeoLeaf.UI.FilterPanel] Aucun filtre d\xe9fini dans profile.search.filters pour le profil actif. Filters:",l);t.info("[GeoLeaf.UI.FilterPanel] Nombre de filtres trouv\xe9s:",l.length);const s=e&&e.container||o.getFilterPanelElement();if(!s)return void t.warn("[GeoLeaf.UI.FilterPanel] Conteneur de panneau introuvable");for(;s.firstChild;)s.removeChild(s.firstChild);s.classList.add("gl-filter-panel");const c=te("div",{className:"gl-filter-panel__header"}),u=te("h2",{className:"gl-filter-panel__title",textContent:a.title||"Filtres"});c.appendChild(u);const d=te("button",{type:"button",className:"gl-filter-panel__toggle-btn",attributes:{"data-gl-action":"filter-close","aria-label":"Fermer le panneau"}}),f=te("span",{className:"gl-filter-panel__toggle-icon",textContent:"\u25c0"});d.appendChild(f),c.appendChild(d),s.appendChild(c);const p=te("div",{className:"gl-filter-panel__body"}),g=document.createDocumentFragment();l.forEach(function(e){const t="categories"===e.id||"tags"===e.id||"proximity"===e.type,o=Vi(e,0,t);if(o)if("categories"===e.id||"tags"===e.id){const t=te("div",{className:"gl-filter-panel__group--accordion",attributes:{"data-accordion-for":e.id}}),n=te("div",{className:"gl-filter-panel__accordion-header"}),r=te("h3",{className:"gl-filter-panel__accordion-title",textContent:e.label||("categories"===e.id?"Afficher les cat\xe9gories":"Afficher les tags")}),i=te("span",{className:"gl-filter-panel__accordion-arrow",textContent:"\u25b6"});n.appendChild(r),n.appendChild(i);const a=te("div",{className:"gl-filter-panel__accordion-body"}),l=te("div");l.appendChild(o),a.appendChild(l);const s=function(){requestAnimationFrame(function(){t.classList.toggle("is-expanded"),t.classList.contains("is-expanded")?Xa._loadAccordionContentIfNeeded(t,e):Za&&Za.markAccordionClosed(t)})};ue?Xa._eventCleanups.push(ue.on(n,"click",s,0,"FilterPanel.accordionToggle")):n.addEventListener("click",s),t.appendChild(n),t.appendChild(a),g.appendChild(t)}else g.appendChild(o)}),p.appendChild(g),s.appendChild(p);const h=te("div",{className:"gl-filter-panel__footer"}),y=te("button",{type:"button",className:"gl-btn gl-btn--accent gl-filter-panel__btn-apply",textContent:a.actions&&a.actions.applyLabel||"Appliquer"});h.appendChild(y);const m=te("button",{type:"button",className:"gl-btn gl-btn--subtle gl-filter-panel__btn-reset",textContent:a.actions&&a.actions.resetLabel||"R\xe9initialiser"});if(h.appendChild(m),s.appendChild(h),!s._glFilterHandlersBound){const e=function(e){const t=e.target;return t.closest("[data-gl-action='filter-close']")?(e.preventDefault(),void Xa.toggleFilterPanelVisibility(0)):t.classList.contains("gl-filter-panel__btn-reset")?(e.preventDefault(),n.resetControls(s),void r.applyFiltersNow(s,1)):t.classList.contains("gl-filter-panel__btn-apply")?(e.preventDefault(),void r.applyFiltersNow(s)):void 0};ue?Xa._eventCleanups.push(ue.on(s,"click",e,0,"FilterPanel.containerClick")):s.addEventListener("click",e);const t=function(e){if(("Enter"===e.key||13===e.keyCode)&&e.target.closest("[data-gl-filter-id='searchText'] input[type='text']"))return e.preventDefault(),void r.applyFiltersNow(s)};ue?Xa._eventCleanups.push(ue.on(s,"keydown",t,0,"FilterPanel.enterKey")):s.addEventListener("keydown",t),s._glFilterHandlersBound=1}s.classList.remove("is-open")},toggleFilterPanelVisibility:function(e){const t=Wa().getFilterPanelElement();if(!t)return;const o=t.classList.contains("is-open");let n;n="boolean"==typeof e?e:!o,n?t.classList.add("is-open"):t.classList.remove("is-open");const r=document.getElementById("gl-filter-toggle");if(r){const e=r.querySelector(".gl-filter-toggle__icon");e&&(n?(Ja(e),r.setAttribute("aria-label","Fermer le panneau de filtres")):(Ha(e),r.setAttribute("aria-label","Ouvrir le panneau de filtres")))}},initFilterToggle:function(){const e=W(),t=Wa(),o=document.getElementById("gl-filter-toggle"),n=t.getFilterPanelElement();if(!o||!n)return void e.info("[GeoLeaf.UI.FilterPanel] Bouton toggle ou panneau filtres introuvable");const r=function(){const e=n.classList.contains("is-open"),t=o.querySelector(".gl-filter-toggle__icon");e?(n.classList.remove("is-open"),t&&Ha(t),o.setAttribute("aria-label","Ouvrir le panneau de filtres")):(n.classList.add("is-open"),t&&Ja(t),o.setAttribute("aria-label","Fermer le panneau de filtres"))};ue?Xa._eventCleanups.push(ue.on(o,"click",r,0,"FilterPanel.toggleButton")):o.addEventListener("click",r),e.info("[GeoLeaf.UI.FilterPanel] Bouton toggle filtres initialis\xe9")},refreshFilterTags:function(){const e=W(),t=Wa(),o=t.getFilterPanelElement();if(!o)return void e.warn("[GeoLeaf.UI.FilterPanel.refreshFilterTags] Panneau de filtres non trouv\xe9");const n=t.getBasePois(),r=t.getBaseRoutes(),i=n.concat(r);n.length,r.length;const a=t.collectAllTags(i);Xa.populateTagsBadges(o,a)},populateTagsBadges:function(e,t){const o=W(),n=e.querySelector("[data-gl-filter-id='tags']");if(!n)return;const r=n.querySelector(".gl-filter-panel__tags-container");if(!r)return void o.warn("[GeoLeaf.UI.FilterPanel] Container tags non trouv\xe9");const i=e.querySelector("[data-accordion-for='tags']");for(;r.firstChild;)r.removeChild(r.firstChild);if(!t.length)return t.length,void(i?(i.style.display="none",o.info("[GeoLeaf.UI.FilterPanel] Accord\xe9on tags CACH\xc9 (display: none)")):o.warn("[GeoLeaf.UI.FilterPanel] Accord\xe9on tags non trouv\xe9 pour le cacher"));t.length,i&&(i.style.display="",o.info("[GeoLeaf.UI.FilterPanel] Accord\xe9on tags AFFICH\xc9"));const a=document.createDocumentFragment();t.forEach(function(e){const t=function(){this.classList.toggle("is-selected")},o=te("span",{className:"gl-filter-panel__tag-badge",textContent:e,attributes:{"data-tag-value":e},onClick:t});ue?Xa._eventCleanups.push(ue.on(o,"click",t,0,"FilterPanel.tagBadge")):o.addEventListener("click",t),a.appendChild(o)}),r.appendChild(a)},destroy:function(){W(),Xa._eventCleanups&&(Xa._eventCleanups.forEach(e=>{"function"==typeof e&&e()}),Xa._eventCleanups=[]),Ba&&Ba.destroy&&Ba.destroy()},_loadAccordionContentIfNeeded:function(e){const t=W(),o=Za;if(!o)return void t.warn("[FilterPanel] LazyLoader non disponible");if("true"===e.dataset.lazyLoaded)return;const n=e.querySelector("[data-lazy-type]");if(!n)return;const r=n.dataset.lazyType;t.info(`[FilterPanel] Chargement lazy du contenu: ${r}`);let i=Ei.getCurrentTheme();if(!i){const e=F&&"function"==typeof F.getActiveProfile?F.getActiveProfile():null;e&&e.themes&&e.themes.config&&e.themes.config.defautTheme&&(i=e.themes.config.defautTheme,t.info("[FilterPanel] Fallback sur le th\xe8me par d\xe9faut:",i))}function a(e,t){for(;e.firstChild;)e.removeChild(e.firstChild);const o=("string"==typeof t?t:String(t||"")).replace(/<script[\s\S]*?<\/script>/gi,""),n=document.createRange().createContextualFragment(o);e.appendChild(n)}function l(e,t,o){for(;e.firstChild;)e.removeChild(e.firstChild);const n=document.createElement("div");n.className=t,n.textContent=o,e.appendChild(n)}i||(i="defaut",t.warn("[FilterPanel] Th\xe8me actif introuvable, utilisation de 'defaut'")),function(e){for(;e.firstChild;)e.removeChild(e.firstChild);const t=document.createElement("div");t.className="gl-filter-panel__loading",t.textContent="Chargement...",e.appendChild(t)}(n),setTimeout(()=>{try{if("categories"===r){const t=o.loadCategories(i);if(!t.usedIds||0===t.usedIds.size)return l(n,"gl-filter-panel__empty","Aucune cat\xe9gorie disponible sur les couches visibles"),void(e.dataset.lazyLoaded="true");const r=qi(t);a(n,r),(s=n).addEventListener("click",function(e){const t=e.target.closest(".gl-filter-tree__arrow");if(!t)return;e.stopPropagation();const o=t.closest(".gl-filter-tree__item--category");o&&o.querySelector(".gl-filter-tree--subcategories")&&(o.classList.contains("is-expanded")?(o.classList.remove("is-expanded"),t.textContent="\u25b6"):(o.classList.add("is-expanded"),t.textContent="\u25bc"))}),s.addEventListener("change",function(e){const t=e.target;if(t.matches(".gl-filter-tree__checkbox"))if(t.classList.contains("gl-filter-tree__checkbox--category")){const e=t.closest(".gl-filter-tree__item--category");if(!e)return;e.querySelectorAll(".gl-filter-tree__checkbox--subcategory").forEach(function(e){e.checked=t.checked}),t.indeterminate=0}else if(t.classList.contains("gl-filter-tree__checkbox--subcategory")){const e=t.closest(".gl-filter-tree__item--category");if(!e)return;const o=e.querySelector(".gl-filter-tree__checkbox--category"),n=e.querySelectorAll(".gl-filter-tree__checkbox--subcategory"),r=Array.from(n).filter(e=>e.checked).length,i=n.length;0===r?(o.checked=0,o.indeterminate=0):r===i?(o.checked=1,o.indeterminate=0):(o.checked=0,o.indeterminate=1)}}),o.markAccordionOpen("categories",e)}else if("tags"===r){const t=o.loadTags(i);if(!t||0===t.length)return l(n,"gl-filter-panel__empty","Aucun tag disponible sur les couches visibles"),void(e.dataset.lazyLoaded="true");const r=Ji(t);a(n,r),function(e){e.addEventListener("click",function(e){const t=e.target.closest(".gl-filter-panel__tag-badge");t&&t.classList.toggle("is-selected")})}(n),o.markAccordionOpen("tags",e)}e.dataset.lazyLoaded="true"}catch(e){t.error("[FilterPanel] Erreur durant le chargement lazy:",e),l(n,"gl-filter-panel__error","Erreur: "+e.message)}var s},10)}},Ya=()=>Ca,Qa=()=>Ba,Ka=()=>Xa,el={buildFilterPanelFromActiveProfile:function(e){const t=Ka();if(t&&t.buildFilterPanelFromActiveProfile)return t.buildFilterPanelFromActiveProfile(e);W().error("[GeoLeaf.UI.FilterPanel] Module Renderer non charg\xe9")},toggleFilterPanelVisibility:function(e){const t=Ka();if(t&&t.toggleFilterPanelVisibility)return t.toggleFilterPanelVisibility(e)},initFilterToggle:function(){const e=Ka();if(e&&e.initFilterToggle)return e.initFilterToggle()},refreshFilterTags:function(){const e=Ka();if(e&&e.refreshFilterTags)return e.refreshFilterTags()},applyFiltersInitial:function(){const e=Qa();if(e&&e.applyFiltersInitial)return e.applyFiltersInitial()},initProximityFilter:function(e){const t=Ga;if(t&&t.initProximityFilter)return t.initProximityFilter(e)},_getFilterPanelElement:function(){const e=Ya();return e&&e.getFilterPanelElement?e.getFilterPanelElement():null},_getBasePois:function(){const e=Ya();return e&&e.getBasePois?e.getBasePois():[]},_getBaseRoutes:function(){const e=Ya();return e&&e.getBaseRoutes?e.getBaseRoutes():[]},_readFiltersFromPanel:function(e){const t=Ta;return t&&t.readFiltersFromPanel?t.readFiltersFromPanel(e):{}},_filterPoiList:function(e,t){const o=Qa();return o&&o.filterPoiList?o.filterPoiList(e,t):e||[]},_filterRouteList:function(e,t){const o=Qa();return o&&o.filterRouteList?o.filterRouteList(e,t):e||[]},_refreshPoiLayer:function(e){const t=Qa();if(t&&t.refreshPoiLayer)return t.refreshPoiLayer(e)}},tl=el,ol="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{};ol.GeoLeaf=ol.GeoLeaf||{},ol.GeoLeaf._LabelButtonManager=Wo,ol.GeoLeaf._LabelRenderer=qo,ol.GeoLeaf.Labels=Zo,ol.GeoLeaf._LegendControl=Sr,ol.GeoLeaf._LegendGenerator=Gr,ol.GeoLeaf._LegendRenderer=Cr,ol.GeoLeaf._LayerManagerBasemapSelector=Hr,ol.GeoLeaf._LayerManagerCacheSection=Xr,ol.GeoLeaf._LayerManagerControl=_i,ol.GeoLeaf._LayerManagerRenderer=bi,ol.GeoLeaf._LayerManagerShared={map:null,control:null,options:{position:"bottomright",title:"L\xe9gende",collapsible:1,collapsed:0,sections:[]}},ol.GeoLeaf._LayerManagerStyleSelector=gi,ol.GeoLeaf.ThemeCache=vi,ol.GeoLeaf._ThemeLoader=Ii,ol.GeoLeaf.ThemeSelector=Ei,ol.GeoLeaf._ThemeApplier=Object.assign({},mi,mi,mi,mi),ol.GeoLeaf.UI||(ol.GeoLeaf.UI={}),ol.GeoLeaf.UI.Branding=Ti,ol.GeoLeaf._UIComponents=Vo,ol.GeoLeaf._UIControls=Ni,ol.GeoLeaf.UI.CoordinatesDisplay=Ui,ol.GeoLeaf._UIDomUtils=Ri,ol.GeoLeaf._UIEventDelegation=zi,ol.GeoLeaf.UI._buildFilterControl=Vi,ol.GeoLeaf._UIFilterStateManager=Xi,ol.GeoLeaf._UINotifications=Wr,ol.GeoLeaf.NotificationSystem=NotificationSystem,ol.GeoLeaf.UI||(ol.GeoLeaf.UI={}),ol.GeoLeaf.UI.notify={info:(e,t)=>Wr?.info?.(e,t),warn:(e,t)=>Wr?.warn?.(e,t),error:(e,t)=>Wr?.error?.(e,t),success:(e,t)=>Wr?.success?.(e,t),dismiss:e=>Wr?.dismiss?.(e)},ol.GeoLeaf.UI.PanelBuilder=oa,ol.GeoLeaf.UI.ScaleControl=na,ol.GeoLeaf._UITheme=fa,ol.GeoLeaf.UI.applyTheme=fa.applyTheme,ol.GeoLeaf.UI.setTheme=fa.applyTheme,ol.GeoLeaf.UI.toggleTheme=fa.toggleTheme,ol.GeoLeaf.UI.initThemeToggle=fa.initThemeToggle,ol.GeoLeaf.UI.getCurrentTheme=fa.getCurrentTheme,ol.GeoLeaf._ContentBuilder||(ol.GeoLeaf._ContentBuilder={}),ol.GeoLeaf._ContentBuilder.Core=dn,ol.GeoLeaf._ContentBuilder.Helpers=ln,ol.GeoLeaf._ContentBuilder.Shared=Gn,ol.GeoLeaf._ContentBuilder.Templates=va,ol.GeoLeaf._ContentBuilder.Assemblers=kn,ol.GeoLeaf._UIFilterPanelShared=Ca,ol.GeoLeaf._UIFilterPanelStateReader=Ta,ol.GeoLeaf._UIFilterPanelApplier=Ba,ol.GeoLeaf._UIFilterPanelRenderer=Xa,ol.GeoLeaf._UIFilterPanelProximity=Ga,ol.GeoLeaf._UIFilterPanelLazyLoader=Za,ol.GeoLeaf._UIFilterPanel=el,ol.GeoLeaf.FilterPanel=tl;const nl={_isOnline:navigator.onLine,_badge:null,_badgeControl:null,_config:{showBadge:0,badgePosition:"topleft",checkInterval:3e4,pingUrl:null},_checkTimer:null,_eventCleanups:[],init(e={}){this._config={...this._config,...e},d.info(`[OfflineDetector] Initializing (badge: ${this._config.showBadge?"enabled":"disabled"})`),this._isOnline=navigator.onLine,d.info("[OfflineDetector] Initial state: "+(this._isOnline?"ONLINE":"OFFLINE")),this._attachEventListeners(),this._startPeriodicCheck(),this.checkConnectivity()},_createBadge(){if(this._badge)return;const e=V();if(!e)return void d.warn("[OfflineDetector] Cannot create badge: map not available");const L=globalThis.L;if(!L||!L.Control)return void d.warn("[OfflineDetector] Leaflet not available");const t=L.Control.extend({options:{position:"topleft"},onAdd:function(){const e=L.DomUtil.create("div","leaflet-bar geoleaf-offline-badge-control");return e.style.cssText="\n                    background: #ff6b6b;\n                    color: white;\n                    padding: 8px 16px;\n                    border-radius: 20px;\n                    font-family: system-ui, -apple-system, sans-serif;\n                    font-size: 13px;\n                    font-weight: 500;\n                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);\n                    cursor: default;\n                    display: none;\n                    white-space: nowrap;\n                    position: absolute;\n                    left: 54px;\n                    top: 0;\n                    margin: 0 !important;\n                    border: none;\n                ",e.textContent="?? Hors ligne",e.title="Mode hors ligne actif",L.DomEvent.disableClickPropagation(e),L.DomEvent.disableScrollPropagation(e),e}});this._badgeControl=new t,this._badgeControl.addTo(e),this._badge=this._badgeControl.getContainer()},_showBadge(){!this._badge&&this._config.showBadge&&this._createBadge(),this._badge&&(this._badge.style.display="block")},_hideBadge(){this._badge&&(this._badge.style.display="none")},_attachEventListeners(){ue?(this._eventCleanups.push(ue.on(window,"online",()=>this._handleOnline(),0,"OfflineDetector.online")),this._eventCleanups.push(ue.on(window,"offline",()=>this._handleOffline(),0,"OfflineDetector.offline"))):(d.warn("[OfflineDetector] EventListenerManager not available - listeners will not be cleaned up"),window.addEventListener("online",()=>this._handleOnline()),window.addEventListener("offline",()=>this._handleOffline()))},destroy(){this._eventCleanups&&this._eventCleanups.length>0&&(this._eventCleanups.forEach(e=>{"function"==typeof e&&e()}),this._eventCleanups=[],d.info("[OfflineDetector] Event listeners cleaned up")),this._checkTimer&&(clearInterval(this._checkTimer),this._checkTimer=null),this._badgeControl&&this._badgeControl._map&&(this._badgeControl._map.removeControl(this._badgeControl),this._badgeControl=null),this._badge=null},_handleOnline(){this._isOnline||(d.info("[OfflineDetector] Connection restored ? ONLINE"),this._isOnline=1,this._config.showBadge&&this._hideBadge(),document.dispatchEvent(new CustomEvent("geoleaf:online",{detail:{timestamp:Date.now()}})),this.checkConnectivity())},_handleOffline(){this._isOnline&&(d.warn("[OfflineDetector] Connection lost ? OFFLINE"),this._isOnline=0,this._config.showBadge&&this._showBadge(),document.dispatchEvent(new CustomEvent("geoleaf:offline",{detail:{timestamp:Date.now()}})))},async checkConnectivity(){if(!this._config.pingUrl)return this._isOnline;try{const e=new AbortController,t=setTimeout(()=>e.abort(),5e3),o=await fetch(this._config.pingUrl,{method:"HEAD",cache:"no-cache",signal:e.signal});clearTimeout(t);const n=o.ok;return n!==this._isOnline&&(n?this._handleOnline():this._handleOffline()),n}catch(e){return e.message,this._isOnline&&this._handleOffline(),0}},_startPeriodicCheck(){this._checkTimer&&clearInterval(this._checkTimer),this._checkTimer=setInterval(()=>{this.checkConnectivity()},this._config.checkInterval),this._config.checkInterval},stopPeriodicCheck(){this._checkTimer&&(clearInterval(this._checkTimer),this._checkTimer=null)},isOnline(){return this._isOnline},destroy(){if(this.stopPeriodicCheck(),this._badgeControl){const e=V();e&&e.removeControl(this._badgeControl),this._badgeControl=null,this._badge=null}d.info("[OfflineDetector] Destroyed")}},rl={_registration:null,_swPath:"sw-core.js",async register(e={}){if(!("serviceWorker"in navigator))return d.warn("[SWRegister] Service Workers not supported in this browser."),null;const t=e.path||this._swPath,o=e.scope||"/";try{const e=await navigator.serviceWorker.register(t,{scope:o});return this._registration=e,d.info(`[SWRegister] Service Worker registered (scope: ${e.scope})`),e.addEventListener("updatefound",()=>{const t=e.installing;t&&t.addEventListener("statechange",()=>{"activated"===t.state&&(d.info("[SWRegister] New Service Worker activated."),document.dispatchEvent(new CustomEvent("geoleaf:sw:updated")))})}),e}catch(e){throw d.error(`[SWRegister] Registration failed: ${e.message}`),e}},async update(){this._registration?(await this._registration.update(),d.info("[SWRegister] Update check triggered.")):d.warn("[SWRegister] No active registration \u2014 call register() first.")},async unregister(){if(!this._registration)return d.warn("[SWRegister] No active registration to unregister."),0;const e=await this._registration.unregister();return e&&(d.info("[SWRegister] Service Worker unregistered."),this._registration=null),e},getRegistration(){return this._registration}},il="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{};il.GeoLeaf=il.GeoLeaf||{},il.GeoLeaf._OfflineDetector=nl,il.GeoLeaf._SWRegister=rl,il.GeoLeaf.Storage||(il.GeoLeaf.Storage={});const al="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{};al.GeoLeaf=al.GeoLeaf||{},al.GeoLeaf.POI||(al.GeoLeaf.POI={}),al.GeoLeaf._POIShared=Ko,al.GeoLeaf._POINormalizers=en,al.GeoLeaf._POIMarkers=_r,al.GeoLeaf._POIPopup=$n,al.GeoLeaf._POISidePanel=ar,al.GeoLeaf._POIRenderers=or,al.GeoLeaf._POICore=ur,al.GeoLeaf.ComponentRenderers=ComponentRenderers,al.GeoLeaf._POIRenderersCore=Zn,al.GeoLeaf.LightboxManager=LightboxManager,al.GeoLeaf._lightboxManager=new LightboxManager,al.GeoLeaf._POIRendererLinks=Wn,al.GeoLeaf.SectionOrchestrator=SectionOrchestrator,al.GeoLeaf._POIUIBehaviors=Vn,pr.register({showPoiDetails:(e,t)=>ar.openSidePanel(e,t)});const ll="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{};ll.GeoLeaf=ll.GeoLeaf||{};class APIController{constructor(){this.isInitialized=0,this.managers={},this.moduleAccessFn=null,this.healthStatus={managers:0,errors:[],lastUpdate:null}}init(){try{if(this.isInitialized)return 1;if(d&&d.info("[APIController] Initializing API controller (Sprint 4.3 - Robust)"),this._initializeManagers(),!this._setupModuleAccess())throw new Error("Module access setup failed");return this._validateInitialization(),this.isInitialized=1,this.healthStatus.lastUpdate=(new Date).toISOString(),d&&d.info("[APIController] API controller initialized successfully"),1}catch(e){return this.healthStatus.errors.push({message:e.message,timestamp:(new Date).toISOString(),stack:e.stack}),d&&d.error("[APIController] Initialization failed:",e),0}}_initializeManagers(){["module","initialization","factory"].forEach(e=>{const t=this._getManagerClass(e);if(t)try{this.managers[e]=new t,this.healthStatus.managers++}catch(t){d&&d.warn(`[APIController] Failed to load ${e} manager:`,t),this.healthStatus.errors.push({manager:e,error:t.message})}}),d&&d.info(`[APIController] Loaded ${this.healthStatus.managers} managers`)}_getManagerClass(e){const t={module:"APIModuleManager",initialization:"APIInitializationManager",factory:"APIFactoryManager"}[e];return ll.GeoLeaf.API&&ll.GeoLeaf.API[t]?ll.GeoLeaf.API[t]:null}_setupModuleAccess(){return this.managers.module?!this.managers.module.init||this.managers.module.init()?(this.moduleAccessFn=e=>{try{return e&&"string"==typeof e?this.managers.module&&"function"==typeof this.managers.module.getModule?this.managers.module.getModule(e):ll.GeoLeaf&&ll.GeoLeaf[e]?ll.GeoLeaf[e]:null:(d&&d.warn("[APIController] Invalid module name:",e),null)}catch(t){return d&&d.warn(`[APIController] Error accessing module ${e}:`,t),null}},d&&d.info("[APIController] Module access configured"),1):(d&&d.error("[APIController] Module manager initialization failed"),0):(d&&d.error("[APIController] Module manager not available"),0)}_validateInitialization(){const e=[{name:"moduleAccessFn",value:this.moduleAccessFn,type:"function"},{name:"managers",value:this.managers,type:"object"},{name:"moduleManager",value:this.managers.module,type:"object"}].filter(e=>!e.value||typeof e.value!==e.type);if(e.length>0){const t=e.map(e=>e.name).join(", ");throw new Error(`Validation failed for: ${t}`)}}geoleafInit(e){if(!this._ensureInitialized())return null;try{if(!this.managers.initialization)throw new Error("Initialization manager not available");return this.managers.initialization.init(e,this.moduleAccessFn)}catch(e){return d&&d.error("[APIController] geoleafInit failed:",e),null}}geoleafLoadConfig(e){if(!this._ensureInitialized())return Promise.resolve(null);try{if(!this.managers.initialization)throw new Error("Initialization manager not available");return this.managers.initialization.loadConfig(e,this.moduleAccessFn)}catch(e){return d&&d.error("[APIController] geoleafLoadConfig failed:",e),Promise.resolve(null)}}geoleafSetTheme(e){if(!this._ensureInitialized())return 0;try{if(!this.managers.initialization)throw new Error("Initialization manager not available");return this.managers.initialization.setTheme(e,this.moduleAccessFn)}catch(e){return d&&d.error("[APIController] geoleafSetTheme failed:",e),0}}geoleafCreateMap(e,t){if(!this._ensureInitialized())return null;try{if(!this.managers.factory)throw new Error("Factory manager not available");return this.managers.factory.createMap(e,t,this.moduleAccessFn)}catch(e){return d&&d.error("[APIController] geoleafCreateMap failed:",e),null}}_ensureInitialized(){return this.isInitialized?1:(d&&d.error("[APIController] Controller not initialized"),0)}getHealthStatus(){return{...this.healthStatus,isInitialized:this.isInitialized,managersCount:Object.keys(this.managers).length,hasModuleAccess:!!this.moduleAccessFn}}reset(){this.isInitialized=0,this.managers={},this.moduleAccessFn=null,this.healthStatus={managers:0,errors:[],lastUpdate:null},d&&d.info("[APIController] Controller reset")}}let sl=null;Object.getOwnPropertyDescriptor(ll.GeoLeaf,"_APIController")&&Object.getOwnPropertyDescriptor(ll.GeoLeaf,"_APIController").get||Object.defineProperty(ll.GeoLeaf,"_APIController",{get:function(){return sl||(sl=new APIController,sl.init()),sl},configurable:1,enumerable:1});const cl="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{};cl.GeoLeaf=cl.GeoLeaf||{};class APIFactoryManager{constructor(){this.isReady=1,this.mapInstances=new Map,this.stats={mapsCreated:0,errors:0}}init(e){try{if(!e||"function"!=typeof e)throw new Error("getModule function is required");return this.getModule=e,d&&d.info("[APIFactoryManager] Factory manager initialized"),1}catch(e){return this.stats.errors++,d&&d.error("[APIFactoryManager] Initialization failed:",e),0}}createMap(e,t,o){try{if(this.stats.mapsCreated++,!e)throw new Error("Target ID is required");const n=o("Core");if(!n||"function"!=typeof n.init)throw new Error("Core module not available for map creation");const r={target:e,...t},i=n.init(r);return i&&(this.mapInstances.set(e,i),d&&d.info(`[APIFactoryManager] Map created for target: ${e}`)),i}catch(t){return this.stats.errors++,d&&d.error(`[APIFactoryManager] Failed to create map for ${e}:`,t),null}}getMapInstance(e){return this.mapInstances.get(e)||null}getAllMapInstances(){return Array.from(this.mapInstances.values())}removeMapInstance(e){return this.mapInstances.has(e)?(this.mapInstances.delete(e),d&&d.info(`[APIFactoryManager] Map instance removed for: ${e}`),1):(d&&d.warn(`[APIFactoryManager] No map instance found for: ${e}`),0)}getStats(){return{...this.stats,activeInstances:this.mapInstances.size,isReady:this.isReady}}reset(){this.mapInstances.clear(),this.getModule=null,this.stats={mapsCreated:0,errors:0},d&&d.info("[APIFactoryManager] Manager reset")}}const ul="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{};ul.GeoLeaf=ul.GeoLeaf||{};class APIInitializationManager{constructor(){this.isReady=1,this.pendingPromise=null,this.cancelled=0,this.stats={initCalls:0,configLoads:0,errors:0}}init(e,t){try{this.stats.initCalls++,d&&d.info("[APIInitializationManager] Initializing GeoLeaf");const o=this._validateInitParams(e,t);if(!o.valid)throw new Error(o.error);const n=t("Core");if(!n||"function"!=typeof n.init)throw new Error("[GeoLeaf.init] GeoLeaf.Core.init() is not available. Core module must be loaded before API.");const r=this._normalizeInitOptions(e);d&&d.info("[APIInitializationManager] Initializing with options:",r);const i=n.init(r);return d&&d.info("[APIInitializationManager] Initialization completed successfully"),i}catch(e){throw this.stats.errors++,d&&d.error("[APIInitializationManager] Initialization failed:",e),e}}async loadConfig(e,t){try{if(this.stats.configLoads++,d&&d.info("[APIInitializationManager] Loading configuration"),!e)throw new Error("Configuration input is required");if(!t||"function"!=typeof t)throw new Error("getModule function is required");const o=t("Config");if(!o||"function"!=typeof o.init)throw new Error("[GeoLeaf.loadConfig] GeoLeaf.Config.init() is not available. Config module must be loaded.");const n=this._normalizeConfigOptions(e);this.pendingPromise&&(this.cancelled=1,d&&d.info("[APIInitializationManager] Cancelling previous config load request")),this.cancelled=0,this.pendingPromise=o.init(n);const r=await this.pendingPromise;return this.pendingPromise=null,this.cancelled?(d&&d.info("[APIInitializationManager] Config load was cancelled"),null):(d&&d.info("[APIInitializationManager] Configuration loaded successfully"),r)}catch(e){throw this.stats.errors++,this.pendingPromise=null,d&&d.error("[APIInitializationManager] Config loading failed:",e),e}}setTheme(e,t){try{if(d&&d.info(`[APIInitializationManager] Setting theme: ${e}`),!e||"string"!=typeof e)throw new Error("Theme name must be a non-empty string");if(!t||"function"!=typeof t)throw new Error("getModule function is required");const o=t("UI");if(!o)throw new Error("[GeoLeaf.setTheme] GeoLeaf.UI is not available. UI module must be loaded.");let n=0;if("function"==typeof o.applyTheme)n=o.applyTheme(e);else if("function"==typeof o.setTheme)n=o.setTheme(e);else{if("function"!=typeof o.theme)throw new Error("UI module does not provide applyTheme, setTheme or theme method");n=o.theme(e)}return d&&d.info(`[APIInitializationManager] Theme '${e}' applied successfully`),n}catch(t){return this.stats.errors++,d&&d.error(`[APIInitializationManager] Failed to set theme '${e}':`,t),0}}_validateInitParams(e,t){return e&&"object"==typeof e?t&&"function"==typeof t?{valid:1}:{valid:0,error:"getModule function is required"}:{valid:0,error:"[GeoLeaf.init] An options object is required."}}_normalizeInitOptions(e){let t=e.map||{},o=e.ui||{};e.map||(t={target:e.target||e.mapId,center:e.center,zoom:e.zoom},o={theme:e.theme});const n=t.target||t.mapId;if(!n)throw new Error("[GeoLeaf.init] The 'map.target' (or 'target'/'mapId') option is required.");const r=ul.GeoLeaf.CONSTANTS||{},i=Array.isArray(t.center)?t.center:r.DEFAULT_CENTER||[0,0],a=Number.isFinite(t.zoom)?t.zoom:r.DEFAULT_ZOOM||12,l=o.theme||t.theme||"light";return{mapId:String(n),center:i,zoom:a,theme:l,mapOptions:t.mapOptions||{}}}_normalizeConfigOptions(e){if("string"==typeof e)return{source:"url",url:e,autoEvent:1};if(e&&"object"==typeof e)return{source:e.url?"url":"data",url:e.url,data:e.data,profileId:e.profileId,autoEvent:0!=e.autoEvent,...e};throw new Error("Configuration input must be a URL string or options object")}getStats(){return{...this.stats,isReady:this.isReady,hasPendingRequest:!!this.pendingPromise}}reset(){this.pendingPromise&&(this.cancelled=1),this.pendingPromise=null,this.cancelled=0,this.stats={initCalls:0,configLoads:0,errors:0},d&&d.info("[APIInitializationManager] Manager reset")}}const dl="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{};dl.GeoLeaf=dl.GeoLeaf||{};class APIModuleManager{constructor(){this.modules=new Map,this.aliases=new Map,this.isInitialized=0,this.stats={totalModules:0,accessCount:0,errors:0}}init(){try{return this.isInitialized||(d&&d.info("[APIModuleManager] Initializing module manager"),this._scanExistingModules(),this._setupAliases(),this.isInitialized=1,d&&d.info(`[APIModuleManager] Initialized with ${this.stats.totalModules} modules`)),1}catch(e){return this.stats.errors++,d&&d.error("[APIModuleManager] Initialization failed:",e),0}}_scanExistingModules(){dl.GeoLeaf&&(["Core","UI","Config","Baselayers","BaseLayers","POI","GeoJSON","Route","Legend","LayerManager","Storage","Filters","Log","Security","Utils","Constants","Validators","Errors"].forEach(e=>{dl.GeoLeaf[e]&&(this.modules.set(e,dl.GeoLeaf[e]),this.stats.totalModules++)}),Object.keys(dl.GeoLeaf).forEach(e=>{e.startsWith("_")&&!this.modules.has(e)&&(this.modules.set(e,dl.GeoLeaf[e]),this.stats.totalModules++)}))}_setupAliases(){Object.entries({Baselayers:"BaseLayers",BaseLayers:"Baselayers",Logger:"Log",Log:"Logger"}).forEach(([e,t])=>{this.modules.has(t)&&this.aliases.set(e,t)})}getModule(e){try{if(this.stats.accessCount++,!e||"string"!=typeof e)return d&&d.warn("[APIModuleManager] Invalid module name:",e),this.stats.errors++,null;if(this.modules.has(e))return this.modules.get(e);if(this.aliases.has(e)){const t=this.aliases.get(e);return this.modules.get(t)}return dl.GeoLeaf&&dl.GeoLeaf[e]?(this.modules.set(e,dl.GeoLeaf[e]),this.stats.totalModules++,dl.GeoLeaf[e]):null}catch(t){return this.stats.errors++,d&&d.error(`[APIModuleManager] Error accessing module '${e}':`,t),null}}registerModule(e,t){try{if(!e||"string"!=typeof e)throw new Error("Module name must be a non-empty string");if(!t)throw new Error("Module cannot be null or undefined");return this.modules.set(e,t),this.stats.totalModules++,1}catch(t){return this.stats.errors++,d&&d.error(`[APIModuleManager] Failed to register module '${e}':`,t),0}}hasModule(e){try{return this.modules.has(e)||this.aliases.has(e)||!(!dl.GeoLeaf||!dl.GeoLeaf[e])}catch(t){return d&&d.error(`[APIModuleManager] Error checking module '${e}':`,t),0}}getModuleList(){const e=new Set(this.modules.keys());return dl.GeoLeaf&&Object.keys(dl.GeoLeaf).forEach(t=>{e.add(t)}),Array.from(e).sort()}getStats(){return{...this.stats,cachedModules:this.modules.size,aliases:this.aliases.size,isInitialized:this.isInitialized}}refresh(){d&&d.info("[APIModuleManager] Refreshing module cache"),this.modules.clear(),this.aliases.clear(),this.stats.totalModules=0,this._scanExistingModules(),this._setupAliases()}reset(){this.modules.clear(),this.aliases.clear(),this.isInitialized=0,this.stats={totalModules:0,accessCount:0,errors:0},d&&d.info("[APIModuleManager] Manager reset")}}const fl="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{};function pl(e,t,o,n){return e&&t&&o?(e.addEventListener(t,o,n),()=>{e.removeEventListener(t,o,n)}):()=>{}}function gl(e){return new Promise(t=>setTimeout(t,e))}fl.GeoLeaf=fl.GeoLeaf||{};const hl={getElementById:function(e){return e&&"string"==typeof e?document.getElementById(e):null},querySelector:function(e,t=document){if(!e||"string"!=typeof e)return null;try{return t.querySelector(e)}catch(e){return null}},querySelectorAll:function(e,t=document){if(!e||"string"!=typeof e)return[];try{return Array.from(t.querySelectorAll(e))}catch(e){return[]}},createElement:function(e,t={}){const o=document.createElement(e),{className:n,id:r,attributes:i={},dataset:a={},styles:l={},textContent:s,innerHTML:c,children:u=[],...d}=t;if(n&&(o.className=n),r&&(o.id=r),Object.keys(i).forEach(e=>{o.setAttribute(e,i[e])}),Object.keys(a).forEach(e=>{o.dataset[e]=a[e]}),Object.keys(l).forEach(e=>{o.style[e]=l[e]}),Object.keys(d).forEach(e=>{"ariaLabel"===e?o.setAttribute("aria-label",d[e]):e in o?o[e]=d[e]:o.setAttribute(e,d[e])}),c){const e=fl.GeoLeaf?.DOMSecurity;if(e&&"function"==typeof e.setSafeHTML)e.setSafeHTML(o,c);else{const e=fl.GeoLeaf?.Log;e&&e.warn("[GeoLeaf.Helpers] createElement with innerHTML - DOMSecurity not available"),o.innerHTML=c}}else s&&(o.textContent=s);return u.length>0&&u.forEach(e=>{e instanceof HTMLElement&&o.appendChild(e)}),o},addClass:function(e,...t){if(!e||!e.classList)return;const o=t.flatMap(e=>e.split(" ")).filter(Boolean);e.classList.add(...o)},removeClass:function(e,...t){if(!e||!e.classList)return;const o=t.flatMap(e=>e.split(" ")).filter(Boolean);e.classList.remove(...o)},toggleClass:function(e,t,o){if(e&&e.classList)return e.classList.toggle(t,o)},hasClass:function(e,t){return e&&e.classList?e.classList.contains(t):0},removeElement:function(e){e&&e.parentNode&&e.parentNode.removeChild(e)},requestFrame:function(e){return window.requestAnimationFrame(e)},cancelFrame:function(e){window.cancelAnimationFrame(e)},createAbortController:function(e){const t=new AbortController;return e&&setTimeout(()=>t.abort(),e),t},lazyLoadImage:function(e,t={threshold:.1}){if(!("IntersectionObserver"in window)){const t=e.dataset.src||e.getAttribute("data-src");return void(t&&(e.src=t))}const o=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){const t=e.target,n=t.dataset.src||t.getAttribute("data-src");n&&(t.src=n),o.unobserve(t)}})},t);o.observe(e)},lazyExecute:function(e,t=100){"requestIdleCallback"in window?requestIdleCallback(e,{timeout:t}):setTimeout(e,t)},clearObject:function(e){e&&"object"==typeof e&&Object.keys(e).forEach(t=>{delete e[t]})},createFragment:function(e=[]){const t=document.createDocumentFragment();return e.forEach(e=>{e instanceof HTMLElement&&t.appendChild(e)}),t},addEventListener:pl,addEventListeners:function(e,t,o){if(!e||!t)return()=>{};const n=[];return Object.keys(t).forEach(r=>{n.push(pl(e,r,t[r],o))}),()=>{n.forEach(e=>e())}},delegateEvent:function(e,t,o,n){return pl(e,t,e=>{const t=e.target;t&&t.matches&&t.matches(o)&&n.call(t,e)})},deepClone:function e(t,o=new WeakMap){if(null===t||"object"!=typeof t)return t;if(o.has(t))return o.get(t);if(t instanceof Date)return new Date(t.getTime());if(t instanceof RegExp)return new RegExp(t.source,t.flags);if(t instanceof Array){const n=[];return o.set(t,n),t.forEach(t=>n.push(e(t,o))),n}const n={};return o.set(t,n),Object.keys(t).forEach(r=>{n[r]=e(t[r],o)}),n},isEmpty:function(e){return null==e?1:"string"==typeof e?0===e.trim().length:Array.isArray(e)?0===e.length:"object"==typeof e?0===Object.keys(e).length:0},wait:gl,retryWithBackoff:async function(e,t=3,o=1e3){let n;for(let r=0;r<t;r++)try{return await e()}catch(e){if(n=e,r<t-1){const e=o*Math.pow(2,r);await gl(e)}}throw n}};let yl=null,ml=null;const bl={register(e,t){yl=e,t&&(ml=t)},isAvailable:()=>!!yl,setLayer(e){yl&&"function"==typeof yl.setLayer&&yl.setLayer(e)},zoomToSelection(){yl&&"function"==typeof yl.zoomToSelection&&yl.zoomToSelection()},highlightSelection(e){yl&&"function"==typeof yl.highlightSelection&&yl.highlightSelection(e)},exportSelection(){yl&&"function"==typeof yl.exportSelection&&yl.exportSelection()},toggle(){yl&&"function"==typeof yl.toggle&&yl.toggle()},show(){yl&&"function"==typeof yl.show&&yl.show()},getSelectedIds:()=>yl&&"function"==typeof yl.getSelectedIds?yl.getSelectedIds():[],setSelection(e,t){yl&&"function"==typeof yl.setSelection&&yl.setSelection(e,t)},clearSelection(){yl&&"function"==typeof yl.clearSelection&&yl.clearSelection()},sortByField(e){yl&&"function"==typeof yl.sortByField&&yl.sortByField(e)},updateToolbarButtons(e){ml&&"function"==typeof ml.updateToolbarButtons&&ml.updateToolbarButtons(e)}},_l={};function Ll(e,t){if("number"==typeof e)return e;if("string"!=typeof e)return 300;if(e.endsWith("%"))return t*parseFloat(e)/100;if(e.endsWith("px"))return parseFloat(e);if(e.endsWith("vh")){const t=parseFloat(e);return window.innerHeight*t/100}return 300}function vl(e,t,o){const n=document.createElement("button");return n.className="gl-table-panel__btn",n.textContent=e,t&&n.classList.add("gl-table-panel__btn--"+t),o&&(ue?_l._eventCleanups.push(ue.on(n,"click",o,0,"TablePanel.button")):n.addEventListener("click",o)),n}_l._eventCleanups=[],_l.create=function(e,t){let o=document.querySelector(".gl-table-panel");if(o)return o;if(o=document.createElement("div"),o.className="gl-table-panel",o.style.height=t.defaultHeight||"40%",t.resizable){const e=function(e,t){const o=document.createElement("div");o.className="gl-table-panel__resize-handle";const n=document.createElement("div");n.className="gl-table-panel__resize-bar",o.appendChild(n);let r=0,i=0,a=0;const l=ue,s=t=>{r=1,i=t.clientY,a=e.offsetHeight,document.body.style.cursor="ns-resize",document.body.style.userSelect="none",t.preventDefault()},c=o=>{if(!r)return;const n=i-o.clientY;let l=a+n;const s=window.innerHeight,c=Ll(t.minHeight||"20%",s),u=Ll(t.maxHeight||"80%",s);l=Math.max(c,Math.min(u,l)),e.style.height=l+"px"},u=()=>{r&&(r=0,document.body.style.cursor="",document.body.style.userSelect="")};return l?(_l._eventCleanups.push(l.on(o,"mousedown",s,0,"TablePanel.resizeMouseDown")),_l._eventCleanups.push(l.on(document,"mousemove",c,0,"TablePanel.resizeMouseMove")),_l._eventCleanups.push(l.on(document,"mouseup",u,0,"TablePanel.resizeMouseUp"))):(o.addEventListener("mousedown",s),document.addEventListener("mousemove",c),document.addEventListener("mouseup",u)),o}(o,t);o.appendChild(e)}const n=function(e,t){const o=document.createElement("div");o.className="gl-table-panel__toolbar";const n=function(){const e=document.createElement("div");e.className="gl-table-panel__layer-selector";const t=document.createElement("select");t.id="geoleaf-table-layer-selector",t.name="geoleaf-table-layer-selector",t.className="gl-table-panel__select",t.setAttribute("data-table-layer-select","");const o=document.createElement("option");o.value="",o.textContent="S\xe9lectionner une couche...",t.appendChild(o);const n=e=>{const t=e.target.value;bl.setLayer(t)},r=ue;return r?_l._eventCleanups.push(r.on(t,"change",n,0,"TablePanel.layerSelect")):t.addEventListener("change",n),e.appendChild(t),e}();o.appendChild(n);const r=function(){const e=document.createElement("div");e.className="gl-table-panel__search";const t=document.createElement("input");let o;return t.type="text",t.id="geoleaf-table-search-input",t.name="geoleaf-table-search-input",t.placeholder="Rechercher...",t.className="gl-table-panel__search-input",t.setAttribute("data-table-search",""),t.addEventListener("input",e=>{clearTimeout(o),o=setTimeout(()=>{!function(e){const t=document.querySelector(".gl-table-panel__table tbody");t&&t.querySelectorAll("tr").forEach(t=>{if(!e)return void(t.style.display="");const o=t.querySelectorAll("td");let n=0;o.forEach(t=>{t.textContent.toLowerCase().includes(e)&&(n=1)}),t.style.display=n?"":"none"})}(e.target.value.trim().toLowerCase())},300)}),e.appendChild(t),e}();o.appendChild(r);const i=vl("Zoom sur s\xe9lection","zoom",()=>{bl.zoomToSelection()});i.disabled=1,i.setAttribute("data-table-btn","zoom"),o.appendChild(i);const a=vl("Surbrillance","highlight",()=>{const e=a.classList.toggle("is-active");bl.highlightSelection(e)});if(a.disabled=1,a.setAttribute("data-table-btn","highlight"),o.appendChild(a),t.enableExportButton){const e=vl("Exporter","export",()=>{bl.exportSelection()});e.disabled=1,e.setAttribute("data-table-btn","export"),o.appendChild(e)}const l=document.createElement("div");l.style.flex="1",o.appendChild(l);const s=function(){const e=document.createElement("button");e.className="gl-table-panel__toggle-btn",e.title="Masquer le tableau",e.setAttribute("aria-label","Masquer tableau");const t=document.createElement("span");t.className="gl-table-panel__toggle-btn__icon";const o=ee.createSVGIcon(16,16,"M6 9l6 6 6-6",{stroke:"currentColor",strokeWidth:"6",fill:"none"});t.appendChild(o),e.appendChild(t);const n=()=>{bl.toggle()},r=ue;return r?_l._eventCleanups.push(r.on(e,"click",n,0,"TablePanel.toggleBtn")):e.addEventListener("click",n),e}();return o.appendChild(s),o}(0,t);o.appendChild(n);const r=document.createElement("div");r.className="gl-table-panel__wrapper",o.appendChild(r);const i=document.createElement("table");return i.className="gl-table-panel__table",r.appendChild(i),document.body.appendChild(o),function(){const e=document.createElement("button");e.className="gl-table-panel__floating-show-btn",e.title="Afficher le tableau",e.setAttribute("aria-label","Afficher tableau");const t=document.createElement("span");t.className="gl-table-panel__toggle-btn__icon";const o=ee.createSVGIcon(16,16,"M18 15l-6-6-6 6",{stroke:"currentColor",strokeWidth:"6",fill:"none"});t.appendChild(o),e.appendChild(t);const n=()=>{bl.show()},r=ue;r?_l._eventCleanups.push(r.on(e,"click",n,0,"TablePanel.floatingShowBtn")):e.addEventListener("click",n),document.body.appendChild(e)}(),d.info("[TablePanel] Panneau cr\xe9\xe9 avec succ\xe8s"),o},_l.updateToolbarButtons=function(e){const t=e>0,o=document.querySelector("[data-table-btn='zoom']"),n=document.querySelector("[data-table-btn='highlight']"),r=document.querySelector("[data-table-btn='export']");o&&(o.disabled=!t),n&&(n.disabled=!t,!t&&n.classList.contains("is-active")&&(n.classList.remove("is-active"),bl.highlightSelection(0))),r&&(r.disabled=!t)},_l.refreshLayerSelector=function(){const e=document.querySelector("[data-table-layer-select]");if(!e)return;const t=e.value;for(;e.options.length>1;)e.remove(1);!function(e){const t=Gt.getLayers();if(!t||0===t.size)return void d.warn("[TablePanel] Module GeoJSON non disponible ou aucune couche");const o=Bt,n=new Set;for(let t=1;t<e.options.length;t++)n.add(e.options[t].value);let r=0;t.forEach((t,i)=>{if(t&&t.config&&t.config.table&&t.config.table.enabled){let a=1;if(o&&"function"==typeof o.getVisibilityState){const e=o.getVisibilityState(i);a=e&&1==e.current}else t._visibility&&(a=1==t._visibility.current);if(!a)return;if(!n.has(i)){const o=document.createElement("option");o.value=i,o.textContent=t.label||t.config?.title||i,e.appendChild(o),r++}}}),r>0&&d.info("[TablePanel] S\xe9lecteur de couche peupl\xe9:",r,"couches ajout\xe9es")}(e);const o=Array.from(e.options).map(e=>e.value);t&&o.includes(t)?e.value=t:t&&!o.includes(t)&&(e.options.length>1?(e.value=e.options[1].value,bl.setLayer(e.options[1].value)):(e.value="",bl.setLayer("")));const n=e.options[0];n&&(n.textContent=e.options.length>1?"S\xe9lectionner une couche...":"Aucune couche visible"),d.info("[TablePanel] S\xe9lecteur de couche rafra\xeechi,",e.options.length-1,"couches disponibles")},_l.destroy=function(){_l._eventCleanups&&_l._eventCleanups.length>0&&(_l._eventCleanups.forEach(e=>{"function"==typeof e&&e()}),_l._eventCleanups=[],d.info("[TablePanel] Event listeners cleaned up"))};const wl=_l,Cl={};function Il(e,t,o,n,r=0){const i=bl.getSelectedIds();if(o&&i.length>0)!function(e){const t=document.querySelector(".gl-table-panel__table tbody");if(!t)return;const o=Array.from(t.querySelectorAll("tr")),n=bl.getSelectedIds(),r=n[n.length-1],i=o.findIndex(t=>t.getAttribute("data-feature-id")===e),a=o.findIndex(e=>e.getAttribute("data-feature-id")===r);if(-1===i||-1===a)return;const l=Math.min(i,a),s=Math.max(i,a),c=[];for(let e=l;e<=s;e++){const t=o[e].getAttribute("data-feature-id");t&&c.push(t)}bl.setSelection(c,0),Sl()}(e);else if(n||r)if(t){const t=[...i,e];bl.setSelection(t,0)}else{const t=i.filter(t=>t!==e);bl.setSelection(t,0)}else t?bl.setSelection([e],0):bl.clearSelection();Sl()}function Sl(){const e=bl.getSelectedIds().length;bl.updateToolbarButtons(e)}Cl._eventCleanups=[],Cl._flushEventCleanups=function(){const e=this._eventCleanups;for(let t=0;t<e.length;t++)if("function"==typeof e[t])try{e[t]()}catch(e){}e.length=0},Cl.destroy=function(){this._flushEventCleanups()},Cl.render=function(e,t){if(!e)return void d.error("[TableRenderer] Conteneur invalide");Cl._flushEventCleanups(),El=0;const{layerId:o,features:n,selectedIds:r,sortState:i}=t;n&&n.length;const a=e.querySelector(".gl-table-panel__table");if(!a)return void d.error("[TableRenderer] \xc9l\xe9ment table introuvable");if(!o)return void ee.clearElementFast(a);const l=Gt.getLayerById(o),s=l&&l.config&&l.config.table?l.config.table:null;if(!s||!s.columns)return d.warn("[TableRenderer] Aucune configuration de colonne pour",o),void ee.clearElementFast(a);s.columns,ee.clearElementFast(a);const c=function(e,t){const o=te("thead"),n=te("tr"),r=te("th",{className:"gl-table-panel__th gl-table-panel__th--checkbox"}),i=te("input",{type:"checkbox",className:"gl-table-panel__checkbox-all",title:"Tout s\xe9lectionner / Tout d\xe9s\xe9lectionner"}),a=e=>{!function(e){const t=document.querySelector(".gl-table-panel__table tbody");if(!t)return;const o=t.querySelectorAll("tr"),n=[];o.forEach(t=>{const o=t.getAttribute("data-feature-id");if(o){n.push(o),t.classList.toggle("is-selected",e);const r=t.querySelector(".gl-table-panel__checkbox");r&&(r.checked=e)}}),e?bl.setSelection(n,0):bl.clearSelection(),Sl()}(e.target.checked)},l=ue;return l?Cl._eventCleanups.push(l.on(i,"change",a,0,"TableRenderer.checkboxAll")):i.addEventListener("change",a),r.appendChild(i),n.appendChild(r),e.forEach(e=>{const o=te("th",{className:"gl-table-panel__th"});if(o.textContent=e.label||e.field,e.width&&(o.style.width=e.width),0!=e.sortable){o.classList.add("gl-table-panel__th--sortable"),o.setAttribute("data-field",e.field);const n=te("span",{className:"gl-table-panel__sort-icon"});t.field===e.field?"asc"===t.direction?(n.textContent=" \u25b2",o.classList.add("is-sorted-asc")):"desc"===t.direction&&(n.textContent=" \u25bc",o.classList.add("is-sorted-desc")):n.textContent=" \u21c5",o.appendChild(n);const r=()=>{bl.sortByField(e.field)},i=ue;i?Cl._eventCleanups.push(i.on(o,"click",r,0,"TableRenderer.sort")):o.addEventListener("click",r)}n.appendChild(o)}),o.appendChild(n),o}(s.columns,i);a.appendChild(c);const u=function(e,t,o){e.length;const n=te("tbody"),r=document.createDocumentFragment();return e.forEach(e=>{const n=function(e,t,o){const n=te("tr"),r=function(e){if(null!=e.id&&""!==e.id)return String(e.id);const t=e.properties;return t?null!=t.id&&""!==t.id?String(t.id):null!=t.fid&&""!==t.fid?String(t.fid):null!=t.osm_id&&""!==t.osm_id?String(t.osm_id):null!=t.OBJECTID&&""!==t.OBJECTID?String(t.OBJECTID):null!=t.SITE_ID&&""!==t.SITE_ID?String(t.SITE_ID):null!=t.code&&""!==t.code?String(t.code):null!=t.IN1&&""!==t.IN1?String(t.IN1):"__gl_row_"+El++:"__gl_row_"+El++}(e);n.setAttribute("data-feature-id",r);const i=o.has(String(r));i&&n.classList.add("is-selected");const a=te("td",{className:"gl-table-panel__td gl-table-panel__td--checkbox"}),l=te("input",{type:"checkbox",className:"gl-table-panel__checkbox",checked:i}),s=e=>{Il(r,e.target.checked,0,1,1)},c=ue;c?Cl._eventCleanups.push(c.on(l,"change",s,0,"TableRenderer.checkbox")):l.addEventListener("change",s),a.appendChild(l),n.appendChild(a),t.forEach(t=>{const o=te("td",{className:"gl-table-panel__td"}),r=function(e,t){if(null==e||""===e)return"\u2013";if("number"===t){const t=Number(e);return isNaN(t)?String(e):t.toLocaleString("fr-FR")}if("date"===t){const t=new Date(e);return isNaN(t.getTime())?String(e):t.toLocaleDateString("fr-FR")}return String(e)}(Ue(e,t.field),t.type);o.textContent=r,"number"===t.type&&o.classList.add("gl-table-panel__td--number"),n.appendChild(o)});const u=e=>{if("checkbox"===e.target.type)return;const t=n.classList.contains("is-selected");Il(r,!t,e.shiftKey,e.ctrlKey||e.metaKey)};return ue?Cl._eventCleanups.push(ue.on(n,"click",u,0,"TableRenderer.rowClick")):n.addEventListener("click",u),n}(e,t,o);r.appendChild(n)}),n.appendChild(r),n.children.length,n}(n,s.columns,r);a.appendChild(u),n.length},Cl.updateSelection=function(e,t){const o=e.querySelector(".gl-table-panel__table tbody");if(!o)return;const n=o.querySelectorAll("tr");n.forEach(e=>{const o=e.getAttribute("data-feature-id"),n=t.has(String(o));e.classList.toggle("is-selected",n);const r=e.querySelector(".gl-table-panel__checkbox");r&&(r.checked=n)});const r=e.querySelector(".gl-table-panel__checkbox-all");if(r){const e=n.length,o=t.size;r.checked=e>0&&o===e,r.indeterminate=o>0&&o<e}Sl()};let El=0;const Al=Cl,Pl="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{};Pl.GeoLeaf=Pl.GeoLeaf||{};const Gl={_map:null,_config:null,_currentLayerId:null,_selectedIds:new Set,_cachedData:[],_featureIdMap:new Map,_highlightLayers:[],_highlightActive:0,_sortState:{field:null,direction:null},_container:null,_isVisible:0,init(e){if(!e||!e.map)return void d.error("[Table] init() n\xe9cessite une instance de carte Leaflet");this._map=e.map;const t=Pl.GeoLeaf.Config?Pl.GeoLeaf.Config.get("tableConfig"):null;this._config=Object.assign({enabled:1,defaultVisible:0,pageSize:50,maxRowsPerLayer:1e3,enableExportButton:1,virtualScrolling:1,defaultHeight:"40%",minHeight:"20%",maxHeight:"60%",resizable:0},t,e.config),this._config.enabled?(d.info("[Table] Initialisation du module Table",this._config),wl&&"function"==typeof wl.create?(this._container=wl.create(this._map,this._config),this._config.defaultVisible&&this.show(),this._attachMapEvents(),d.info("[Table] Module Table initialis\xe9 avec succ\xe8s")):d.error("[Table] Module table/panel.js non charg\xe9")):d.info("[Table] Module d\xe9sactiv\xe9 via configuration")},_attachMapEvents(){if(!this._map)return;let e=null;const t=()=>{e&&clearTimeout(e),e=setTimeout(()=>{wl&&"function"==typeof wl.refreshLayerSelector&&wl.refreshLayerSelector()},150)};this._map.on("geoleaf:filters:changed",()=>{this._isVisible&&this._currentLayerId&&this.refresh()}),this._map.on("geoleaf:geojson:layers-loaded",()=>{t()}),document.addEventListener("geoleaf:theme:applied",()=>{t()}),this._map.on("geoleaf:geojson:visibility-changed",e=>{t(),this._currentLayerId===e.layerId&&(e.visible?this.refresh():setTimeout(()=>{const e=this._getAvailableVisibleLayers();if(e.length>0){this.setLayer(e[0].id);const t=document.querySelector("[data-table-layer-select]");t&&(t.value=e[0].id)}else this.setLayer("")},200))})},show(){this._container?(this._container.classList.add("is-visible"),this._isVisible=1,this._fireEvent("table:opened",{})):d.warn("[Table] Conteneur non initialis\xe9")},hide(){this._container&&(this._clearHighlightLayers(),this._highlightActive=0,this._container.classList.remove("is-visible"),this._isVisible=0,this._fireEvent("table:closed",{}))},toggle(){this._isVisible?this.hide():this.show()},setLayer(e){if(!e)return this._currentLayerId=null,this._selectedIds.clear(),this._clearHighlightLayers(),this._highlightActive=0,this._featureIdMap.clear(),this._sortState={field:null,direction:null},this._cachedData=[],Al&&this._container&&Al.render(this._container,{layerId:null,features:[],selectedIds:this._selectedIds,sortState:this._sortState,config:this._config}),void this._fireEvent("table:layerChanged",{layerId:null});if(!this._getAvailableLayers().find(t=>t.id===e))return void d.warn("[Table] Couche introuvable ou non activ\xe9e pour le tableau:",e);this._currentLayerId=e,this._selectedIds.clear(),this._clearHighlightLayers(),this._highlightActive=0,this._sortState={field:null,direction:null};const t=Pl.GeoLeaf.GeoJSON?Pl.GeoLeaf.GeoJSON.getLayerData(e):null;t&&t.config&&t.config.table&&t.config.table.defaultSort&&(this._sortState.field=t.config.table.defaultSort.field,this._sortState.direction=t.config.table.defaultSort.direction||t.config.table.defaultSort.order||"asc"),this.refresh(),this._fireEvent("table:layerChanged",{layerId:e})},refresh(){if(!this._currentLayerId)return;const e=this._getLayerFeatures(this._currentLayerId);this._cachedData=e,this._featureIdMap.clear();let t=0;e.forEach((e,o)=>{const n=this._resolveFeatureId(e,t);n.startsWith("__gl_row_")&&t++,this._featureIdMap.set(n,o)}),e.length,this._sortState.field&&this._sortState.direction&&this._applySorting(),Al&&"function"==typeof Al.render?Al.render(this._container,{layerId:this._currentLayerId,features:this._cachedData,selectedIds:this._selectedIds,sortState:this._sortState,config:this._config}):d.error("[Table] Renderer non disponible"),e.length},_getLayerFeatures(e){if(!Pl.GeoLeaf.GeoJSON||"function"!=typeof Pl.GeoLeaf.GeoJSON.getLayerData)return d.warn("[Table] Module GeoJSON non disponible"),[];const t=Pl.GeoLeaf.GeoJSON.getLayerData(e);if(!t||!t.features)return d.warn("[Table] Aucune donn\xe9e pour la couche:",e),[];t.features.length;const o=this._config.maxRowsPerLayer||1e3;return t.features.length>o?(d.warn("[Table] Donn\xe9es volumineuses ("+t.features.length+" entit\xe9s). Limit\xe9 \xe0 "+o),t.features.slice(0,o)):t.features||[]},_getAvailableLayers(){if(!Pl.GeoLeaf.GeoJSON||"function"!=typeof Pl.GeoLeaf.GeoJSON.getAllLayers)return[];const e=Pl.GeoLeaf.GeoJSON.getAllLayers(),t=[];return e.forEach(e=>{const o=Pl.GeoLeaf.GeoJSON.getLayerData(e.id);o&&o.config&&o.config.table&&o.config.table.enabled&&t.push({id:e.id,label:e.label||e.id,config:o.config.table})}),t},_getAvailableVisibleLayers(){const e=this._getAvailableLayers(),t=Pl.GeoLeaf._LayerVisibilityManager;return e.filter(e=>{if(t&&"function"==typeof t.getVisibilityState){const o=t.getVisibilityState(e.id);return o&&1==o.current}const o=Pl.GeoLeaf.GeoJSON.getLayerData(e.id);return o&&o._visibility&&1==o._visibility.current})},_applySorting(){!function(e,t,o){if(!t.field||!t.direction)return;const{field:n,direction:r}=t;e.sort((e,t)=>{const i=o(e,n),a=o(t,n);if(null==i&&null==a)return 0;if(null==i)return"asc"===r?1:-1;if(null==a)return"asc"===r?-1:1;let l=0;return l="number"==typeof i&&"number"==typeof a?i-a:String(i).localeCompare(String(a)),"asc"===r?l:-l})}(this._cachedData,this._sortState,(e,t)=>this._getNestedValue(e,t)),this._sortState.field,this._sortState.direction},sortByField(e){this._sortState=function(e,t){return e.field===t?"asc"===e.direction?{field:t,direction:"desc"}:"desc"===e.direction?{field:null,direction:null}:{field:t,direction:"asc"}:{field:t,direction:"asc"}}(this._sortState,e),this.refresh(),this._fireEvent("table:sortChanged",this._sortState)},setSelection(e,t=0){t||this._selectedIds.clear(),e.forEach(e=>this._selectedIds.add(String(e))),this._fireEvent("table:selectionChanged",{layerId:this._currentLayerId,selectedIds:Array.from(this._selectedIds)}),Al&&"function"==typeof Al.updateSelection&&Al.updateSelection(this._container,this._selectedIds),this._selectedIds.size},getSelectedIds(){return Array.from(this._selectedIds)},clearSelection(){this._selectedIds.clear(),this._fireEvent("table:selectionChanged",{layerId:this._currentLayerId,selectedIds:[]}),Al&&"function"==typeof Al.updateSelection&&Al.updateSelection(this._container,this._selectedIds)},zoomToSelection(){if(0===this._selectedIds.size)return void d.warn("[Table] Aucune entit\xe9 s\xe9lectionn\xe9e pour le zoom");const e=this._getSelectedFeatures();if(0===e.length)return void d.warn("[Table] Aucune feature trouv\xe9e pour les IDs s\xe9lectionn\xe9s");const t=L.latLngBounds([]);e.forEach(e=>{e.geometry&&e.geometry.coordinates&&this._extendBoundsFromGeometry(t,e.geometry)}),t.isValid()?(this._map.fitBounds(t,{padding:[50,50],maxZoom:16}),this._fireEvent("table:zoomToSelection",{layerId:this._currentLayerId,selectedIds:Array.from(this._selectedIds)}),e.length):d.warn("[Table] Bounds invalides pour la s\xe9lection")},highlightSelection(e){if(this._clearHighlightLayers(),this._highlightActive=e,!e)return void this._fireEvent("table:highlightSelection",{layerId:this._currentLayerId,selectedIds:Array.from(this._selectedIds),active:0});if(0===this._selectedIds.size)return void d.warn("[Table] Aucune entit\xe9 s\xe9lectionn\xe9e pour la surbrillance");const t=this._getSelectedFeatures();if(0===t.length)return void d.warn("[Table] Aucune feature trouv\xe9e pour la surbrillance");const o={color:"#FFD600",weight:4,opacity:1,fillOpacity:.15,fillColor:"#FFD600",dashArray:"",interactive:0};t.forEach(e=>{try{if(e.geometry)if("Point"===e.geometry.type){const t=e.geometry.coordinates,o=L.circleMarker([t[1],t[0]],{radius:14,color:"#FFD600",weight:4,opacity:1,fillOpacity:.25,fillColor:"#FFD600",interactive:0});o.addTo(this._map),this._highlightLayers.push(o)}else{const t=L.geoJSON(e,{style:function(){return o},interactive:0,pointToLayer:function(e,t){return L.circleMarker(t,o)}});t.addTo(this._map),this._highlightLayers.push(t)}}catch(e){d.warn("[Table] Erreur surbrillance feature:",e)}}),this._fireEvent("table:highlightSelection",{layerId:this._currentLayerId,selectedIds:Array.from(this._selectedIds),active:1}),t.length},_clearHighlightLayers(){this._highlightLayers.forEach(e=>{try{this._map&&this._map.hasLayer(e)&&this._map.removeLayer(e)}catch(e){}}),this._highlightLayers=[]},exportSelection(){if(0===this._selectedIds.size)return void d.warn("[Table] Aucune entit\xe9 s\xe9lectionn\xe9e pour l'export");const e=this._getSelectedFeatures();if(0!==e.length){try{!function(e,t){const o=JSON.stringify(e,null,2),n=new Blob([o],{type:"application/geo+json"}),r=URL.createObjectURL(n),i=document.createElement("a");i.href=r,i.download=(t||"export")+"_selection.geojson",document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(r)}((t=e,{type:"FeatureCollection",features:t.map(e=>({type:"Feature",properties:e.properties||{},geometry:e.geometry||null}))}),this._currentLayerId),d.info("[Table] Export GeoJSON:",e.length,"entit\xe9s export\xe9es")}catch(e){d.error("[Table] Erreur lors de l'export:",e)}var t;this._fireEvent("table:exportSelection",{layerId:this._currentLayerId,selectedIds:Array.from(this._selectedIds),rows:e})}else d.warn("[Table] Aucune feature trouv\xe9e pour l'export")},_getSelectedFeatures(){const e=[];return this._selectedIds.forEach(t=>{const o=this._featureIdMap.get(t);null!=o&&this._cachedData[o]&&e.push(this._cachedData[o])}),e},_resolveFeatureId:(e,t)=>function(e,t){if(null!=e.id&&""!==e.id)return String(e.id);const o=e.properties;return o?null!=o.id&&""!==o.id?String(o.id):null!=o.fid&&""!==o.fid?String(o.fid):null!=o.osm_id&&""!==o.osm_id?String(o.osm_id):null!=o.OBJECTID&&""!==o.OBJECTID?String(o.OBJECTID):null!=o.SITE_ID&&""!==o.SITE_ID?String(o.SITE_ID):null!=o.code&&""!==o.code?String(o.code):null!=o.IN1&&""!==o.IN1?String(o.IN1):"__gl_row_"+t:"__gl_row_"+t}(e,t),_extendBoundsFromGeometry(e,t){const o=t.coordinates,n=t.type;"Point"===n?e.extend([o[1],o[0]]):"LineString"===n?o.forEach(t=>e.extend([t[1],t[0]])):"MultiLineString"===n?o.forEach(t=>t.forEach(t=>e.extend([t[1],t[0]]))):"Polygon"===n?o[0].forEach(t=>e.extend([t[1],t[0]])):"MultiPolygon"===n?o.forEach(t=>{t[0].forEach(t=>e.extend([t[1],t[0]]))}):"MultiPoint"===n&&o.forEach(t=>e.extend([t[1],t[0]]))},_getNestedValue:(e,t)=>Ue(e,t),_fireEvent(e,t){this._map&&"function"==typeof this._map.fire&&this._map.fire("geoleaf:"+e,t),"undefined"!=typeof document&&document.dispatchEvent&&document.dispatchEvent(new CustomEvent("geoleaf:"+e,{detail:t}))}},Tl=Gl;bl.register(Tl,wl);const xl="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{};xl.GeoLeaf=xl.GeoLeaf||{},xl.GeoLeaf.UI=xl.GeoLeaf.UI||{};const Ol=(e,t,...o)=>{if(xl.GeoLeaf.Utils&&xl.GeoLeaf.Utils.createElement)return xl.GeoLeaf.Utils.createElement(e,t,...o);const n=document.createElement(e);return t&&(t.className&&(n.className=t.className),t.textContent&&(n.textContent=t.textContent)),n};function Ml(){const e={theme:!!xl.GeoLeaf._UITheme,controls:!!xl.GeoLeaf._UIControls,panelBuilder:!(!xl.GeoLeaf._UIPanelBuilder&&!xl.GeoLeaf.UI.PanelBuilder),filterPanel:!!xl.GeoLeaf._UIFilterPanel,notifications:!!xl.GeoLeaf._UINotifications,eventDelegation:!!xl.GeoLeaf._UIEventDelegation,filterStateManager:!!xl.GeoLeaf._UIFilterStateManager},t=Object.entries(e).filter(([e,t])=>!t).map(([e])=>e);return t.length>0&&d&&d.warn("[UI.Orchestrator] Modules manquants:",t.join(", ")),{modules:e,missing:t,allAvailable:0===t.length}}xl.GeoLeaf._UITheme&&(xl.GeoLeaf.UI.initThemeToggle=xl.GeoLeaf._UITheme.initThemeToggle,xl.GeoLeaf.UI.toggleTheme=xl.GeoLeaf._UITheme.toggleTheme,xl.GeoLeaf.UI.applyTheme=xl.GeoLeaf._UITheme.applyTheme,xl.GeoLeaf.UI.getCurrentTheme=xl.GeoLeaf._UITheme.getCurrentTheme,xl.GeoLeaf.UI.setTheme=xl.GeoLeaf._UITheme.applyTheme),xl.GeoLeaf._UIControls&&(xl.GeoLeaf.UI.initFullscreenControl=xl.GeoLeaf._UIControls.initFullscreenControl,xl.GeoLeaf.UI.initGeolocationControl=xl.GeoLeaf._UIControls.initGeolocationControl,xl.GeoLeaf.UI.initPoiAddControl=xl.GeoLeaf._UIControls.initPoiAddControl,xl.GeoLeaf.UI.initScaleControl=xl.GeoLeaf._UIControls.initScaleControl,Object.defineProperty(xl.GeoLeaf.UI,"_geolocationActive",{get:()=>xi.active,set(e){xi.active=e},configurable:1,enumerable:1}),Object.defineProperty(xl.GeoLeaf.UI,"_geolocationWatchId",{get:()=>xi.watchId,set(e){xi.watchId=e},configurable:1,enumerable:1}),Object.defineProperty(xl.GeoLeaf.UI,"_userPosition",{get:()=>xi.userPosition,set(e){xi.userPosition=e},configurable:1,enumerable:1}),Object.defineProperty(xl.GeoLeaf.UI,"_userPositionAccuracy",{get:()=>xi.userPositionAccuracy,set(e){xi.userPositionAccuracy=e},configurable:1,enumerable:1})),(xl.GeoLeaf._UIPanelBuilder||xl.GeoLeaf.UI.PanelBuilder)&&(xl.GeoLeaf.UI.buildSidePanel=xl.GeoLeaf._UIPanelBuilder&&xl.GeoLeaf._UIPanelBuilder.buildSidePanel||xl.GeoLeaf.UI.PanelBuilder&&xl.GeoLeaf.UI.PanelBuilder.buildSidePanel,xl.GeoLeaf.UI.renderPoiSidePanel=xl.GeoLeaf._UIPanelBuilder&&xl.GeoLeaf._UIPanelBuilder.renderPoiSidePanel||xl.GeoLeaf.UI.PanelBuilder&&xl.GeoLeaf.UI.PanelBuilder.renderPoiSidePanel,xl.GeoLeaf.UI.renderPoiPanelWithLayout=function(e,t,o){if(xl.GeoLeaf.UI.renderPoiSidePanel)return xl.GeoLeaf.UI.renderPoiSidePanel(e,t,o);d&&d.warn("[UI.Orchestrator] renderPoiPanelWithLayout: PanelBuilder non disponible")},xl.GeoLeaf.UI._resolveField=function(e,t){return xl.GeoLeaf._UIDomUtils&&xl.GeoLeaf._UIDomUtils.resolveField?xl.GeoLeaf._UIDomUtils.resolveField(e,t):null},xl.GeoLeaf.UI._createPlainSection=function(e,t,o){return xl.GeoLeaf.UI.PanelBuilder&&xl.GeoLeaf.UI.PanelBuilder.createPlainSection?xl.GeoLeaf.UI.PanelBuilder.createPlainSection(e,t,o):Ol("section",{className:"gl-poi-panel__section "+(o||"")})},xl.GeoLeaf.UI._createAccordionSection=function(e,t,o){return xl.GeoLeaf.UI.PanelBuilder&&xl.GeoLeaf.UI.PanelBuilder.createAccordionSection?xl.GeoLeaf.UI.PanelBuilder.createAccordionSection(e,t,o):Ol("section",{className:"gl-poi-panel__section--accordion"})}),xl.GeoLeaf._UIFilterPanel&&(xl.GeoLeaf.UI.buildFilterPanelFromActiveProfile=xl.GeoLeaf._UIFilterPanel.buildFilterPanelFromActiveProfile,xl.GeoLeaf.UI.refreshFilterTags=xl.GeoLeaf._UIFilterPanel.refreshFilterTags,xl.GeoLeaf.UI.initFilterToggle=xl.GeoLeaf._UIFilterPanel.initFilterToggle,xl.GeoLeaf.UI.initProximityFilter=xl.GeoLeaf._UIFilterPanel.initProximityFilter,xl.GeoLeaf.UI._getBasePois=xl.GeoLeaf._UIFilterPanel.getBasePois,xl.GeoLeaf.UI._getBaseRoutes=xl.GeoLeaf._UIFilterPanel.getBaseRoutes,xl.GeoLeaf._UIFilterStateManager&&(xl.GeoLeaf.UI.resetAllFilters=function(){xl.GeoLeaf._UIFilterStateManager.resetAllFilters(),xl.GeoLeaf._UIFilterPanel.refreshFilterTags&&xl.GeoLeaf._UIFilterPanel.refreshFilterTags()},xl.GeoLeaf.UI.getActiveFilters=xl.GeoLeaf._UIFilterStateManager.getActiveFiltersSummary,xl.GeoLeaf.UI.hasActiveFilters=xl.GeoLeaf._UIFilterStateManager.hasActiveFilters)),xl.GeoLeaf._UINotifications&&(xl.GeoLeaf.UI.Notifications={show:xl.GeoLeaf._UINotifications.show.bind(xl.GeoLeaf._UINotifications),success:xl.GeoLeaf._UINotifications.success.bind(xl.GeoLeaf._UINotifications),error:xl.GeoLeaf._UINotifications.error.bind(xl.GeoLeaf._UINotifications),warning:xl.GeoLeaf._UINotifications.warning.bind(xl.GeoLeaf._UINotifications),info:xl.GeoLeaf._UINotifications.info.bind(xl.GeoLeaf._UINotifications),clearAll:xl.GeoLeaf._UINotifications.clearAll.bind(xl.GeoLeaf._UINotifications),enable:xl.GeoLeaf._UINotifications.enable.bind(xl.GeoLeaf._UINotifications),disable:xl.GeoLeaf._UINotifications.disable.bind(xl.GeoLeaf._UINotifications),getStatus:xl.GeoLeaf._UINotifications.getStatus.bind(xl.GeoLeaf._UINotifications)},xl.GeoLeaf.UI.showNotification=xl.GeoLeaf._UINotifications.show.bind(xl.GeoLeaf._UINotifications),xl.GeoLeaf.UI.showSuccess=xl.GeoLeaf._UINotifications.success.bind(xl.GeoLeaf._UINotifications),xl.GeoLeaf.UI.showError=xl.GeoLeaf._UINotifications.error.bind(xl.GeoLeaf._UINotifications),xl.GeoLeaf.UI.showWarning=xl.GeoLeaf._UINotifications.warning.bind(xl.GeoLeaf._UINotifications),xl.GeoLeaf.UI.showInfo=xl.GeoLeaf._UINotifications.info.bind(xl.GeoLeaf._UINotifications),xl.GeoLeaf.UI.clearNotifications=xl.GeoLeaf._UINotifications.clearAll.bind(xl.GeoLeaf._UINotifications));let kl=0;xl.GeoLeaf.UI.init=function(e={}){const t={buttonSelector:e.buttonSelector||'[data-gl-role="theme-toggle"]',autoInitOnDomReady:!!e.autoInitOnDomReady,enableEventDelegation:0!=e.enableEventDelegation},{missing:o,allAvailable:n}=Ml();if(!n&&d&&d.warn("[UI.Orchestrator] Initialisation avec modules manquants:",o),xl.GeoLeaf.UI.initThemeToggle)try{xl.GeoLeaf.UI.initThemeToggle(t)}catch(e){d&&d.error("[UI.Orchestrator] Erreur init th\xe8me:",e)}if(e.map&&e.mapContainer){if(xl.GeoLeaf.UI.initFullscreenControl)try{xl.GeoLeaf.UI.initFullscreenControl(e.map,e.mapContainer)}catch(e){d&&d.error("[UI.Orchestrator] Erreur fullscreen control:",e)}if(xl.GeoLeaf.UI.initGeolocationControl)try{xl.GeoLeaf.UI.initGeolocationControl(e.map,e.config)}catch(e){d&&d.error("[UI.Orchestrator] Erreur geolocation control:",e)}if(xl.GeoLeaf.UI.initPoiAddControl)try{xl.GeoLeaf.UI.initPoiAddControl(e.map,e.config)}catch(e){d&&d.error("[UI.Orchestrator] Erreur POI add control:",e)}if(xl.GeoLeaf.UI.initScaleControl)try{xl.GeoLeaf.UI.initScaleControl(e.map)}catch(e){d&&d.error("[UI.Orchestrator] Erreur scale control:",e)}}if(t.enableEventDelegation&&function(e={}){if(kl||!xl.GeoLeaf._UIEventDelegation)return;const{filterContainer:t}=e;t&&xl.GeoLeaf._UIFilterStateManager&&xl.GeoLeaf._UIEventDelegation.attachFilterInputEvents(t,()=>{xl.GeoLeaf._UIFilterPanel&&xl.GeoLeaf._UIFilterPanel.refreshFilterTags&&xl.GeoLeaf._UIFilterPanel.refreshFilterTags()}),document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".gl-poi-panel, .gl-filter-panel").forEach(e=>{xl.GeoLeaf._UIEventDelegation.attachAccordionEvents(e)})}),kl=1,d&&d.info("[UI.Orchestrator] Event delegation initialis\xe9e")}({filterContainer:e.filterContainer}),xl.GeoLeaf._UIFilterStateManager&&xl.GeoLeaf.Config){const e=xl.GeoLeaf.Config.getActiveProfile?.()||null;if(e&&e.filters)try{xl.GeoLeaf._UIFilterStateManager.initializeFromProfile(e)}catch(e){d&&d.error("[UI.Orchestrator] Erreur init filter state:",e)}}d&&d.info(`[UI.Orchestrator] Initialisation termin\xe9e (modules: ${Object.keys(Ml().modules).length})`)},xl.GeoLeaf.UI.getModuleStatus=function(){return Ml()},xl.GeoLeaf.UI.cleanup=function(){if(xl.GeoLeaf._UIEventDelegation&&xl.GeoLeaf._UIEventDelegation.cleanupAllListeners){const e=xl.GeoLeaf._UIEventDelegation.cleanupAllListeners();d&&e>0&&d.info(`[UI.Orchestrator] ${e} event listeners nettoy\xe9s`)}kl=0,d&&d.info("[UI.Orchestrator] Nettoyage termin\xe9")},xl.GeoLeaf.UI._attachAccordionBehavior=function(e){if(xl.GeoLeaf._UIEventDelegation&&xl.GeoLeaf._UIEventDelegation.attachAccordionEvents)return xl.GeoLeaf._UIEventDelegation.attachAccordionEvents(e);d&&d.warn("[UI.Orchestrator] _attachAccordionBehavior: EventDelegation module manquant")},xl.GeoLeaf.UI._getActiveProfileConfig=function(){return xl.GeoLeaf._UIDomUtils&&xl.GeoLeaf._UIDomUtils.getActiveProfileConfig?xl.GeoLeaf._UIDomUtils.getActiveProfileConfig():xl.GeoLeaf.Config?.getActiveProfile?.()||null},xl.GeoLeaf.UI.VERSION="4.4.0",xl.GeoLeaf.UI.BUILD="Sprint-4.4-Modular",d&&d.info(`[UI.Orchestrator] Module initialis\xe9 v${GeoLeaf.UI.VERSION}`);const Nl=xl.GeoLeaf.UI,Fl={validateCoordinates:function(e,t,o={}){const{throwOnError:n=0}=o;try{return _(e,t),{valid:1,error:null}}catch(o){const r=new g.ValidationError(o.message,{lat:e,lng:t});if(n)throw r;return{valid:0,error:r.message}}},validateUrl:function(e,t={}){const{allowedProtocols:o=["http:","https:","data:"],allowDataImages:n=1,throwOnError:r=0}=t;if(!e||"string"!=typeof e){const t=new g.ValidationError("URL must be a non-empty string",{url:e,type:typeof e});if(r)throw t;return{valid:0,error:t.message,url:null}}try{const t=new URL(e,"http://dummy.com"),r=t.protocol;if(!o.includes(r)){if("data:"!==r)throw new g.SecurityError(`Protocol "${r}" not allowed`,{url:e,protocol:r,allowed:o});{if(!n)throw new g.SecurityError("Data URLs are not allowed",{url:e,protocol:r});const t=e.substring(5,e.indexOf(",")||e.indexOf(";"));if(!t.startsWith("image/"))throw new g.SecurityError("Only data:image URLs are allowed",{url:e,dataType:t})}}return{valid:1,error:null,url:t.href}}catch(e){if(r)throw e;return{valid:0,error:e.message,url:null}}},validateEmail:function(e,t={}){const{throwOnError:o=0}=t;if(!e||"string"!=typeof e){const t=new g.ValidationError("Email must be a non-empty string",{email:e,type:typeof e});if(o)throw t;return{valid:0,error:t.message}}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)){const t=new g.ValidationError("Invalid email format",{email:e});if(o)throw t;return{valid:0,error:t.message}}return{valid:1,error:null}},validatePhone:function(e,t={}){const{throwOnError:o=0}=t;if(!e||"string"!=typeof e){const t=new g.ValidationError("Phone must be a non-empty string",{phone:e,type:typeof e});if(o)throw t;return{valid:0,error:t.message}}if(!/^[\d\s+\-()]+$/.test(e)){const t=new g.ValidationError("Invalid phone format",{phone:e});if(o)throw t;return{valid:0,error:t.message}}const n=e.replace(/\D/g,"");if(n.length<10){const t=new g.ValidationError("Phone number must contain at least 10 digits",{phone:e,digitCount:n.length});if(o)throw t;return{valid:0,error:t.message}}return{valid:1,error:null}},validateZoom:function(e,t={}){const{min:o=0,max:n=20,throwOnError:r=0}=t;if("number"!=typeof e){const t=new g.ValidationError("Zoom must be a number",{zoom:e,type:typeof e});if(r)throw t;return{valid:0,error:t.message}}if(!Number.isFinite(e)){const t=new g.ValidationError("Zoom must be a finite number",{zoom:e});if(r)throw t;return{valid:0,error:t.message}}if(e<o||e>n){const t=new g.ValidationError(`Zoom must be between ${o} and ${n}`,{zoom:e,min:o,max:n});if(r)throw t;return{valid:0,error:t.message}}return{valid:1,error:null}},validateRequiredFields:function(e,t,o={}){const{throwOnError:n=0}=o;if(!e||"object"!=typeof e){const o=new g.ConfigError("Config must be an object",{config:e,type:typeof e});if(n)throw o;return{valid:0,error:o.message,missing:t}}const r=t.filter(t=>!(t in e)||null===e[t]||void 0===e[t]);if(r.length>0){const t=new g.ConfigError(`Missing required fields: ${r.join(", ")}`,{config:e,missing:r});if(n)throw t;return{valid:0,error:t.message,missing:r}}return{valid:1,error:null,missing:[]}},validateGeoJSON:function(e,t={}){const{throwOnError:o=0}=t;if(!e||"object"!=typeof e){const t=new g.ValidationError("GeoJSON must be an object",{geojson:e,type:typeof e});if(o)throw t;return{valid:0,error:t.message}}if(!e.type){const t=new g.ValidationError("GeoJSON must have a type field",{geojson:e});if(o)throw t;return{valid:0,error:t.message}}const n=["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon","GeometryCollection","Feature","FeatureCollection"];if(!n.includes(e.type)){const t=new g.ValidationError("Invalid GeoJSON type",{type:e.type,validTypes:n});if(o)throw t;return{valid:0,error:t.message}}if("Feature"===e.type&&!e.geometry){const t=new g.ValidationError("Feature must have a geometry",{geojson:e});if(o)throw t;return{valid:0,error:t.message}}if("FeatureCollection"===e.type&&!Array.isArray(e.features)){const t=new g.ValidationError("FeatureCollection must have a features array",{geojson:e});if(o)throw t;return{valid:0,error:t.message}}return{valid:1,error:null}},validateColor:function(e,t={}){const{throwOnError:o=0}=t;if(!e||"string"!=typeof e){const t=new g.ValidationError("Color must be a non-empty string",{color:e,type:typeof e});if(o)throw t;return{valid:0,error:t.message}}if(!(/^#[0-9A-Fa-f]{3}([0-9A-Fa-f]{3})?$/.test(e)||/^rgb\(\s*\d+\s*,\s*\d+\s*,\s*\d+\s*\)$/.test(e)||/^rgba\(\s*\d+\s*,\s*\d+\s*,\s*\d+\s*,\s*[\d.]+\s*\)$/.test(e)||"undefined"!=typeof CSS&&CSS.supports("color",e))){const t=new g.ValidationError("Invalid color format",{color:e});if(o)throw t;return{valid:0,error:t.message}}return{valid:1,error:null}},validateBatch:function(e){const t=[];for(const o of e){const{value:e,validator:n,options:r={},label:i="value"}=o;if("function"!=typeof n){t.push(`Invalid validator for ${i}`);continue}const a=n(e,{...r,throwOnError:0});a.valid||t.push(`${i}: ${a.error}`)}return{valid:0===t.length,errors:t}}};function Dl(GeoLeaf){if(GeoLeaf.plugins?.getLoadedPlugins)return GeoLeaf.plugins.getLoadedPlugins().filter(e=>!["core"].includes(e));const e=[];if(GeoLeaf.Storage&&"object"==typeof GeoLeaf.Storage){const t=GeoLeaf.Storage.DB&&"object"==typeof GeoLeaf.Storage.DB;e.push(t?"storage (offline + IndexedDB)":"storage (cache)")}return GeoLeaf.POI?.AddForm&&"object"==typeof GeoLeaf.POI.AddForm&&e.push("addpoi"),(GeoLeaf._LayerManagerControl||GeoLeaf._LMRenderer)&&e.push("layer-manager"),GeoLeaf.Route&&"function"==typeof GeoLeaf.Route.load&&e.push("route"),GeoLeaf.Labels&&"function"==typeof GeoLeaf.Labels.init&&e.push("labels"),e}function Ul(GeoLeaf){const e=GeoLeaf._version||"4.0.0",t=Dl(GeoLeaf),o=["storage","addpoi"],n=t.filter(e=>o.some(t=>e.toLowerCase().startsWith(t))),r=t.filter(e=>!o.some(t=>e.toLowerCase().startsWith(t)));let i="";return n.length>0?(i=`Core MIT \u2022 Premium: ${n.join(" + ")}`,r.length>0&&(i+=` \u2022 ${r.join(" \u2022 ")}`)):i=t.length>0?`Core MIT \u2014 ${r.join(" \u2022 ")}`:"Core MIT \u2014 open source",{title:`GeoLeaf JS ${e}`,message:i}}const Rl={show:function(GeoLeaf,e={}){if(!GeoLeaf)return;if(!e.force)try{const e=GeoLeaf.Config?.get?.("debug.showBootInfo");if(0==e)return}catch(e){}const{title:t,message:o}=Ul(GeoLeaf);console.info(`[GeoLeaf] ${t} | ${o}`)},detectPlugins:Dl,buildMessage:Ul},jl=new Map,$l=new Map,Bl={register(e,t={}){jl.set(e,{name:e,version:t.version||null,loaded:1,loadedAt:Date.now(),requires:t.requires||[],optional:t.optional||[],label:t.label||e,healthCheck:t.healthCheck||null})},registerLazy(e,t){$l.set(e,t)},isLoaded:e=>jl.has(e)&&1==jl.get(e).loaded,canActivate(e){const t=jl.get(e);return t?t.requires.every(e=>Bl.isLoaded(e)):$l.has(e)},async load(e){if(Bl.isLoaded(e))return;const t=$l.get(e);if(!t)throw new Error(`[GeoLeaf.plugins] Module inconnu : "${e}". Modules disponibles : ${[...$l.keys()].join(", ")}`);await t()},getLoadedPlugins:()=>[...jl.keys()].filter(e=>jl.get(e).loaded),getAvailableModules:()=>[...new Set([...jl.keys(),...$l.keys()])],getInfo:e=>jl.get(e)||null,reportPremiumPlugins(){const e=new Set(["core","labels","route","table","legend","layerManager","themes","basemapSelector","poiCore","poiRenderers","poiExtras","poi","basemap-selector"]),t=[...jl.values()].filter(t=>t.loaded&&!e.has(t.name));if(0!==t.length){console.groupCollapsed(`%c[PLUGINS] ${t.length} plugin(s) premium charg\xe9(s)`,"color:#7c3aed;font-weight:bold");for(const e of t){const t="function"==typeof e.healthCheck?e.healthCheck():1;e.label||e.name,e.version&&e.version,t||console.warn(`     [PLUGINS] ${e.name} : healthCheck \xe9chou\xe9 \u2014 v\xe9rifiez le chargement du plugin.`)}console.groupEnd()}else console.info("%c[PLUGINS] Core MIT \u2014 0 plugin premium charg\xe9","color:#6b7280;font-style:italic")},_registry:jl,_lazyResolvers:$l},zl="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{};zl.GeoLeaf=zl.GeoLeaf||{},zl.GeoLeaf.API||(zl.GeoLeaf.API={}),zl.GeoLeaf.API.Controller=APIController,zl.GeoLeaf.API.FactoryManager=APIFactoryManager,zl.GeoLeaf.API.InitializationManager=APIInitializationManager,zl.GeoLeaf.API.ModuleManager=APIModuleManager,zl.GeoLeaf.API.APIModuleManager=APIModuleManager,zl.GeoLeaf.API.APIInitializationManager=APIInitializationManager,zl.GeoLeaf.API.APIFactoryManager=APIFactoryManager,zl.GeoLeaf.Baselayers=Jr,zl.GeoLeaf.BaseLayers=Jr,zl.GeoLeaf.Core=z,zl.GeoLeaf.Filters=Ra,zl.GeoLeaf.Helpers=hl,zl.GeoLeaf.LayerManager=yi,zl.GeoLeaf.Legend=di,zl.GeoLeaf.POI&&zl.GeoLeaf.POI.init||(zl.GeoLeaf.POI=Object.assign(zl.GeoLeaf.POI||{},xa)),zl.GeoLeaf.POI.Renderers||(zl.GeoLeaf.POI.Renderers={}),zl.GeoLeaf.POI.Renderers.FieldRenderers=FieldRenderers,zl.GeoLeaf.POI.Renderers.MediaRenderers=MediaRenderers,zl.GeoLeaf.Route=Gi,zl.GeoLeaf.Storage=zl.GeoLeaf.Storage||{},zl.GeoLeaf.Table=Tl,zl.GeoLeaf.UI=Nl||zl.GeoLeaf.UI,zl.GeoLeaf.Validators=Fl,zl.GeoLeaf.plugins=Bl,zl.GeoLeaf.bootInfo=Rl,Bl.register("core",{version:zl.GeoLeaf._version}),zl.GeoLeaf.init=function(e){try{return zl.GeoLeaf._APIController.geoleafInit(e)}catch(e){throw d&&d.error("[GeoLeaf.init]",e),e}},zl.GeoLeaf.setTheme=function(e){try{return zl.GeoLeaf._APIController.geoleafSetTheme(e)}catch(e){throw d&&d.error("[GeoLeaf.setTheme]",e),e}},zl.GeoLeaf.loadConfig=function(e){if(null==e||"string"!=typeof e&&"object"!=typeof e)throw new TypeError("[GeoLeaf.loadConfig] Invalid input: expected string URL or config object, got "+typeof e);try{return zl.GeoLeaf._APIController.geoleafLoadConfig(e)}catch(e){throw d&&d.error("[GeoLeaf.loadConfig]",e),e}},zl.GeoLeaf.createMap=function(e,t){const o=zl.GeoLeaf._APIController;return o&&o.geoleafCreateMap?o.geoleafCreateMap(e,t):null},zl.GeoLeaf.getMap=function(e){const t=zl.GeoLeaf._APIController;return t&&t.managers&&t.managers.factory?t.managers.factory.getMapInstance(e):null},zl.GeoLeaf.getAllMaps=function(){const e=zl.GeoLeaf._APIController;return e&&e.managers&&e.managers.factory?e.managers.factory.getAllMapInstances():[]},zl.GeoLeaf.removeMap=function(e){const t=zl.GeoLeaf._APIController;return t&&t.managers&&t.managers.factory&&"function"==typeof t.managers.factory.removeMapInstance?t.managers.factory.removeMapInstance(e):0},zl.GeoLeaf.getModule=function(e){const t=zl.GeoLeaf._APIController;return t&&t.moduleAccessFn?t.moduleAccessFn(e):null},zl.GeoLeaf.hasModule=function(e){const t=zl.GeoLeaf._APIController;return!!(t&&t.moduleAccessFn&&t.moduleAccessFn(e))},zl.GeoLeaf.getNamespace=function(e){return zl.GeoLeaf&&e&&zl.GeoLeaf[e]||null},zl.GeoLeaf.getHealth=function(){const e=zl.GeoLeaf._APIController;return e&&e.getHealthStatus?e.getHealthStatus():null},zl.GeoLeaf.getMetrics=function(){return zl.GeoLeaf.getHealth()},zl.GeoLeaf.version||(zl.GeoLeaf.version=zl.GeoLeaf.CONSTANTS&&zl.GeoLeaf.CONSTANTS.VERSION||"4.0.0");const Vl="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:{},ql=Vl.GeoLeaf,Jl=ql._app=ql._app||{};Jl.AppLog={log(...e){location.search.includes("debug=true")},info(...e){console.info("[GeoLeaf]",...e)},error(...e){console.error("[GeoLeaf]",...e)},warn(...e){console.warn("[GeoLeaf]",...e)}},Jl.getProfilesBasePath=function(){return Vl.location.pathname.includes("/demo/")?"../profiles/":"./profiles/"},Jl.checkPlugins=function(e){const t=Jl.AppLog;e&&e.ui&&1==e.ui.showAddPoi&&(ql.POI&&ql.POI.AddForm||t.warn("\u26a0\ufe0f Config has showAddPoi=true but AddPOI plugin is not loaded. Load geoleaf-addpoi.plugin.js before calling GeoLeaf.boot().")),e&&e.storage&&(ql.Storage||t.warn("\u26a0\ufe0f Config references storage but Storage plugin is not loaded. Advanced features (IndexedDB, CacheManager, sync) require geoleaf-storage.plugin.js. Basic offline caching via SW core is always available without the plugin."),e.storage.enableServiceWorker&&!ql.Storage&&t.warn("\u26a0\ufe0f Config has enableServiceWorker=true but Storage plugin is not loaded. Premium SW (IndexedDB tiles, background sync) requires geoleaf-storage.plugin.js. Core/lite SW remains active for basic offline caching.")),ql.POI&&ql.POI.SyncHandler&&!ql.Storage&&t.warn("\u26a0\ufe0f SyncHandler loaded without Storage plugin \u2014 sync operations will be disabled. POI add/edit/delete will work in online-only mode.")},Jl.showNotification=function(e,t){if(t=t||3500,ql.UI&&ql.UI.Notifications&&"function"==typeof ql.UI.Notifications.success)try{return ql.UI.Notifications.success(e,t),1}catch(e){}if(ql._UINotifications&&"function"==typeof ql._UINotifications.success)try{return ql._UINotifications.success(e,t),1}catch(e){}return Jl.AppLog.log(e+" (notifications indisponibles)"),0},Jl._ensureModule=async function(e,t){ql[e]||"function"==typeof ql._loadModule&&await ql._loadModule(t)};const Hl=Vl.GeoLeaf,Zl=Hl._app=Hl._app||{};Zl.initApp=async function(e){e=e||{};const t=Zl.AppLog;"undefined"!=typeof performance&&performance.mark&&performance.mark("geoleaf:initApp:start"),t.log("Initialisation avec config:",e),Zl.checkPlugins(e);const o=e.map&&(e.map.target||e.map.id)||"geoleaf-map",n=e.ui&&e.ui.theme||"light";if(!e.map||!Array.isArray(e.map.bounds)||2!==e.map.bounds.length)return void t.error('[GeoLeaf] Le profil actif ne d\xe9finit pas de map.bounds valide. L\'emprise (map.bounds) est obligatoire dans le fichier profile.json. Exemple : "bounds": [[43.0, 1.0], [44.0, 2.0]]');const r=e.map.bounds,i=e.map.initialMaxZoom||e.map.maxZoom||12,a=e.map.padding||[50,50],l=[(r[0][0]+r[1][0])/2,(r[0][1]+r[1][1])/2];let s=null;const c={};if(1==e.map.positionFixed){const t="number"==typeof e.map.boundsMargin?e.map.boundsMargin:.3;c.maxBounds=L.latLngBounds(r).pad(t),c.maxBoundsViscosity=.85,"number"==typeof e.map.minZoom?c.minZoom=e.map.minZoom:c.minZoom=3}try{s=Hl.init({map:{target:o,center:l,zoom:i,mapOptions:c},ui:{theme:n}})}catch(e){return void t.error("GeoLeaf.init() a lev\xe9 une erreur :",e)}if(!s)return void t.error("GeoLeaf.init() n'a pas renvoy\xe9 de carte valide.");let u=null;if("function"==typeof Hl._loadAllSecondaryModules&&(u=Hl._loadAllSecondaryModules()),1==e.map.positionFixed)try{const o="number"==typeof e.map.boundsMargin?e.map.boundsMargin:.3,n=L.latLngBounds(r).pad(o);s.setMaxBounds(n),s.options.maxBoundsViscosity=.85,"number"==typeof e.map.minZoom?s.setMinZoom(e.map.minZoom):s.setMinZoom(3),t.log("[GeoLeaf] positionFixed activ\xe9 \u2014 d\xe9placement restreint \xe0 l'emprise du profil (marge: "+100*o+"%).")}catch(e){t.warn("[GeoLeaf] Erreur lors de l'application de positionFixed :",e)}try{s.fitBounds(r,{maxZoom:i,padding:a,animate:0}),t.log("Carte positionn\xe9e via map.bounds du profil.")}catch(e){t.warn("Erreur fitBounds depuis profile.map.bounds :",e)}Hl._SWRegister&&Hl._SWRegister.register({scope:"./"}).then(()=>t.log("Service Worker (core/lite) enregistr\xe9.")).catch(e=>t.warn("Erreur enregistrement SW core:",e.message));const d=e.storage||{};if(Hl.Storage&&"function"==typeof Hl.Storage.init)try{t.log("Initialisation du Storage avec config:",d),Hl.Storage.init({indexedDB:{name:"geoleaf-db",version:2},cache:d.cache||{enableProfileCache:1,enableTileCache:1},offline:{},enableOfflineDetector:!!d.enableOfflineDetector,enableServiceWorker:!!d.enableServiceWorker}).then(()=>{t.log("Storage initialis\xe9 avec succ\xe8s")}).catch(e=>{t.warn("Erreur initialisation Storage:",e)})}catch(e){t.warn("Erreur lors de l'initialisation du Storage:",e)}else t.log("Plugin Storage non charg\xe9 \u2014 fonctionnement en mode cache navigateur standard."),d.enableOfflineDetector&&Hl._OfflineDetector&&(Hl._OfflineDetector.init({showBadge:1,badgePosition:"topleft",checkInterval:3e4}),t.log("Offline Detector initialis\xe9 (mode core)."));if(Hl._UINotifications&&"function"==typeof Hl._UINotifications.init)try{let e=document.getElementById("gl-notifications");e||(e=document.createElement("div"),e.id="gl-notifications",e.className="gl-notifications gl-notifications--bottom-center",document.body.appendChild(e)),Hl._UINotifications.init({container:"#gl-notifications",position:"bottom-center",maxVisible:3,animations:1}),t.log("Syst\xe8me de notifications initialis\xe9")}catch(e){t.warn("Erreur lors de l'initialisation des notifications:",e)}let f=null;document.addEventListener("geoleaf:theme:applying",function(){Hl._UINotifications&&Hl._UINotifications.container&&(f=Hl._UINotifications.info("Chargement des donn\xe9es en cours, patientez\u2026",{persistent:1,dismissible:0}))});let p=null;function g(e){if(!e||!e.data)return 0;const t=e.data.profile||{},o=(t.label||t.name||t.title||e.profileId||"Profil")+" charg\xe9";if(!function(){try{if(Hl.UI&&Hl.UI.Notifications&&"function"==typeof Hl.UI.Notifications.getStatus)return!!Hl.UI.Notifications.getStatus().initialized;if(Hl._UINotifications&&Hl._UINotifications.container)return 1}catch(e){}return 0}())return p=e,0;const n=Zl.showNotification(o);return p=n?null:e,n}document.addEventListener("geoleaf:profile:loaded",function(e){e&&e.detail&&(p=e.detail,g(e.detail))}),document.addEventListener("geoleaf:theme:applied",function(e){if(f&&Hl._UINotifications&&"function"==typeof Hl._UINotifications.dismiss&&(Hl._UINotifications.dismiss(f),f=null),e&&e.detail){const t=e.detail;Zl.showNotification(`Th\xe8me "${t.themeName}" charg\xe9 (${t.layerCount} couches visibles)`,3500)}}),document.addEventListener("geoleaf:map:ready",function(){p&&g(p)});try{"function"==typeof Hl.setTheme&&Hl.setTheme(n)}catch(e){t.warn("Erreur lors de l'appel \xe0 GeoLeaf.setTheme :",e)}if(Hl.UI&&"function"==typeof Hl.UI.init)try{const t=document.querySelector(".gl-main")||document.getElementById(o);Hl.UI.init({buttonSelector:'[data-gl-role="theme-toggle"]',map:s,mapContainer:t,config:e})}catch(e){t.warn("GeoLeaf.UI.init() a lev\xe9 une erreur :",e)}if(e.ui&&0==e.ui.showFilterPanel){const e=document.getElementById("gl-filter-toggle");e&&(e.style.display="none");const t=document.getElementById("gl-filter-panel");t&&(t.style.display="none")}else if(Hl.UI&&"function"==typeof Hl.UI.buildFilterPanelFromActiveProfile)try{let e=document.getElementById("gl-filter-panel");if(!e){e=document.createElement("div"),e.id="gl-filter-panel",e.setAttribute("data-gl-role","filter-panel");const t=document.querySelector(".gl-main");t?t.appendChild(e):document.body.appendChild(e)}Hl.UI.buildFilterPanelFromActiveProfile({container:e}),"function"==typeof Hl.UI.initFilterToggle&&Hl.UI.initFilterToggle(),"function"==typeof Hl.UI.initProximityFilter&&Hl.UI.initProximityFilter(s)}catch(e){t.warn("Erreur lors de la construction du panneau de filtres :",e)}if(u)try{await u,t.log("Modules secondaires charg\xe9s (POI, Route, Legend, LayerManager, Labels, Themes, Table).")}catch(e){t.warn("Erreur chargement modules secondaires:",e)}if(e.ui&&0!=e.ui.showTable&&Hl.Table&&"function"==typeof Hl.Table.init&&e.tableConfig&&0!=e.tableConfig.enabled)try{Hl.Table.init({map:s,config:e.tableConfig}),t.log("Module Table initialis\xe9.")}catch(e){t.warn("Erreur lors de l'initialisation du module Table :",e)}if(Hl.UI&&Hl.UI.CacheButton&&"function"==typeof Hl.UI.CacheButton.init)try{Hl.UI.CacheButton.init(s,e),t.log("Bouton de cache initialis\xe9.")}catch(e){t.warn("Erreur lors de l'initialisation du bouton de cache :",e)}if(function({GeoLeaf,cfg:e,map:t,AppLog:o}){const n=GeoLeaf.BaseLayers||GeoLeaf.Baselayers;if(!n||"function"!=typeof n.init)return void o.warn("Module BaseLayers introuvable.");let r="street";const i={};e.basemaps&&"object"==typeof e.basemaps&&Object.keys(e.basemaps).forEach(function(t){const o=e.basemaps[t];1==o.defaultBasemap&&(r=o.id||t);const n={id:o.id||t,label:o.label||t,url:o.url||o.fallbackUrl,options:{minZoom:o.minZoom||0,maxZoom:o.maxZoom||19,attribution:o.attribution||""}};o.type&&(n.type=o.type),o.style&&(n.style=o.style),o.attribution&&(n.attribution=o.attribution),"number"==typeof o.minZoom&&(n.minZoom=o.minZoom),"number"==typeof o.maxZoom&&(n.maxZoom=o.maxZoom),i[t]=n});try{n.init({map:t,baselayers:i,activeKey:r,ui:e.ui,basemaps:e.basemaps})}catch(e){o.warn("BaseLayers.init a lev\xe9 une exception :",e)}}({GeoLeaf:Hl,cfg:e,map:s,AppLog:t}),function({GeoLeaf,cfg:e,map:t,AppLog:o}){const n=GeoLeaf.POI;if(!n||"function"!=typeof n.add)return void o.warn("GeoLeaf.POI.add() indisponible, aucun POI ne sera affich\xe9.");try{"function"==typeof n.init&&(n.init({map:t,config:e.poiConfig||{}}),GeoLeaf.Legend&&"function"==typeof GeoLeaf.Legend.loadLayerLegend&&e.layers&&Array.isArray(e.layers)&&e.layers.forEach(function(e){e.id&&e.id.includes("poi")&&e.configFile&&fetch(e.configFile).then(e=>e.json()).then(t=>{let o="default";t.styles&&t.styles.available&&t.styles.available.length>0&&(o=t.styles.available[0].id||"default"),GeoLeaf.Legend.loadLayerLegend(e.id,o,t),"function"==typeof GeoLeaf.Legend.setLayerVisibility&&GeoLeaf.Legend.setLayerVisibility(e.id,1)}).catch(t=>o.warn(`Erreur chargement config couche ${e.id}:`,t))}))}catch(e){o.warn("GeoLeaf.POI.init() a lev\xe9 une erreur :",e)}if(e.ui&&1==e.ui.showFilterPanel)return o.info("Panneau de filtres activ\xe9 : les POI seront charg\xe9s via le syst\xe8me de filtres."),void(GeoLeaf.UI&&"function"==typeof GeoLeaf.UI.applyFiltersInitial&&GeoLeaf.UI.applyFiltersInitial());if(!Array.isArray(e.poi)||0===e.poi.length)return;const r=[];if(e.poi.forEach(function(e){let t=null;e.latlng&&Array.isArray(e.latlng)&&2===e.latlng.length?t=e.latlng:e.location&&"number"==typeof e.location.lat&&"number"==typeof e.location.lng&&(t=[e.location.lat,e.location.lng]),t&&r.push(t)}),r.length>0){const n=e.map&&Array.isArray(e.map.bounds)&&2===e.map.bounds.length,i=e.layers&&Array.isArray(e.layers)&&e.layers.length>0;if(!n&&!i)try{t.fitBounds(L.latLngBounds(r),{padding:[80,80],maxZoom:12,animate:0})}catch(e){o.warn("Erreur lors de fitBounds :",e)}GeoLeaf.UI&&"function"==typeof GeoLeaf.UI.refreshFilterTags&&GeoLeaf.UI.refreshFilterTags()}}({GeoLeaf:Hl,cfg:e,map:s,AppLog:t}),function({GeoLeaf,cfg:e,map:t,AppLog:o}){const n=GeoLeaf.Route;if(n&&"function"==typeof n.init&&"function"==typeof n.loadFromConfig){try{n.init({map:t,fitBoundsOnLoad:0,maxZoomOnFit:12})}catch(e){return void o.warn("GeoLeaf.Route.init() a lev\xe9 une erreur :",e)}if(Array.isArray(e.routes)&&e.routes.length>0)try{n.loadFromConfig(e.routes),o.log("Itin\xe9raires charg\xe9s.")}catch(e){o.warn("GeoLeaf.Route.loadFromConfig() a lev\xe9 une erreur :",e)}}}({GeoLeaf:Hl,cfg:e,map:s,AppLog:t}),function({GeoLeaf,_cfg:e,map:t,AppLog:o,_app:n}){const r=GeoLeaf.GeoJSON;if(r&&"function"==typeof r.init){try{r.init({map:t,fitBoundsOnLoad:0,maxZoomOnFit:12})}catch(e){return void o.warn("GeoLeaf.GeoJSON.init() a lev\xe9 une erreur :",e)}t&&"function"==typeof t.on&&t.on("geoleaf:geojson:layers-loaded",function(e){if(e&&e.detail&&"number"==typeof e.detail.count){const t=e.detail.count,o=1===t?"1 couche GeoJSON charg\xe9e":t+" couches GeoJSON charg\xe9es";n&&"function"==typeof n.showNotification&&n.showNotification(o,3e3)}}),function(){if(GeoLeaf._GeoJSONLoader&&"function"==typeof GeoLeaf._GeoJSONLoader.loadAllLayersConfigsForLayerManager){const e=GeoLeaf.Config&&"function"==typeof GeoLeaf.Config.getActiveProfile?GeoLeaf.Config.getActiveProfile():null;if(e)return GeoLeaf._GeoJSONLoader.loadAllLayersConfigsForLayerManager(e).catch(e=>(o.warn("Erreur chargement configs couches:",e),[]))}return Promise.resolve()}().then(function(){if(!GeoLeaf.ThemeSelector||"function"!=typeof GeoLeaf.ThemeSelector.init)return void o.warn("ThemeSelector non disponible");let e=null;GeoLeaf.Config&&"function"==typeof GeoLeaf.Config.getActiveProfileId&&(e=GeoLeaf.Config.getActiveProfileId());const t=document.getElementById("gl-theme-primary-container"),n=document.getElementById("gl-theme-secondary-container");e&&t&&n?GeoLeaf.ThemeSelector.init({profileId:e,primaryContainer:t,secondaryContainer:n}).then(function(){if(o.log("ThemeSelector initialis\xe9 et th\xe8me appliqu\xe9"),GeoLeaf._GeoJSONLayerManager&&"function"==typeof GeoLeaf._GeoJSONLayerManager.populateLayerManagerWithAllConfigs){const e=GeoLeaf.ThemeSelector.getActiveTheme?GeoLeaf.ThemeSelector.getActiveTheme():null;GeoLeaf._GeoJSONLayerManager.populateLayerManagerWithAllConfigs(e)}document.addEventListener("geoleaf:theme:applied",function(){if(GeoLeaf._GeoJSONLayerManager&&"function"==typeof GeoLeaf._GeoJSONLayerManager.populateLayerManagerWithAllConfigs){const e=GeoLeaf.ThemeSelector.getActiveTheme?GeoLeaf.ThemeSelector.getActiveTheme():null;GeoLeaf._GeoJSONLayerManager.populateLayerManagerWithAllConfigs(e)}})}).catch(function(e){o.warn("Erreur initialisation ThemeSelector:",e)}):o.warn("ThemeSelector : conteneurs ou profil manquants")})}else o.log("GeoLeaf.GeoJSON.init() indisponible \u2014 pas de couches GeoJSON.")}({GeoLeaf:Hl,map:s,AppLog:t,_app:Zl}),Hl.UI&&Hl.UI.Branding&&"function"==typeof Hl.UI.Branding.init)try{Hl.UI.Branding.init(s)}catch(e){t.warn("GeoLeaf.UI.Branding.init() a lev\xe9 une erreur :",e)}if(e.ui&&0!=e.ui.showLegend&&Hl.Legend&&"function"==typeof Hl.Legend.init)try{Hl.Legend.init(s,{position:"bottomleft",collapsible:1,collapsed:0,title:"L\xe9gende"})}catch(e){t.warn("Erreur lors de l'initialisation du module Legend:",e)}if(e.ui&&0!=e.ui.showLayerManager&&Hl.LayerManager&&"function"==typeof Hl.LayerManager.init)try{Hl.LayerManager.init({map:s,position:"bottomright"})}catch(e){t.warn("GeoLeaf.LayerManager.init() a lev\xe9 une erreur :",e)}if(Hl.initScaleControl&&"function"==typeof Hl.initScaleControl)try{Hl.initScaleControl(s)}catch(e){t.warn("GeoLeaf.initScaleControl() a lev\xe9 une erreur :",e)}if(Hl.Labels&&"function"==typeof Hl.Labels.init)try{Hl.Labels.init({map:s})}catch(e){t.warn("GeoLeaf.Labels.init() a lev\xe9 une erreur :",e)}if(e.ui&&0!=e.ui.showCoordinates&&Hl.UI&&Hl.UI.CoordinatesDisplay&&"function"==typeof Hl.UI.CoordinatesDisplay.init)try{Hl.UI.CoordinatesDisplay.init(s,{position:"bottomleft",decimals:6})}catch(e){t.warn("GeoLeaf.UI.CoordinatesDisplay.init() a lev\xe9 une erreur :",e)}let h=0;function y(e){if(h)return;h=1;const o=document.getElementById("gl-loader");if(o&&(o.classList.add("gl-loader--fade"),o.addEventListener("transitionend",function(){o.style.display="none"},{once:1}),setTimeout(function(){o.style.display="none"},800)),s&&(s.invalidateSize({pan:0}),setTimeout(function(){try{s.fitBounds(r,{maxZoom:i,padding:a,animate:1,duration:.6})}catch(e){t.warn("[GeoLeaf] Correctif fitBounds au reveal :",e)}},120)),document.dispatchEvent(new CustomEvent("geoleaf:map:ready")),document.dispatchEvent(new CustomEvent("geoleaf:app:ready",{detail:{version:Hl._version,timestamp:Date.now()}})),t.info("Application pr\xeate \u2014 "+e),"undefined"!=typeof performance&&performance.mark){performance.mark("geoleaf:initApp:ready");try{performance.measure("geoleaf:startup-total","geoleaf:initApp:start","geoleaf:initApp:ready");const e=performance.getEntriesByName("geoleaf:startup-total","measure");e.length&&t.info("[Perf] \u23f1 Startup total: "+e[e.length-1].duration.toFixed(1)+"ms")}catch(e){}}}document.addEventListener("geoleaf:theme:applied",function(){y("th\xe8me appliqu\xe9, couches charg\xe9es")},{once:1}),setTimeout(function(){y("timeout s\xe9curit\xe9 5s")},5e3),t.info("Application initialis\xe9e, chargement des couches en arri\xe8re-plan\u2026")};const Wl=Vl.GeoLeaf,Xl=Wl._app=Wl._app||{};Xl.startApp=async function(){const e=Xl.AppLog;if(!Wl)return void e.error("GeoLeaf global introuvable. Le bundle core doit \xeatre charg\xe9 avant GeoLeaf.boot().");if("function"!=typeof Wl.loadConfig)return void e.error("GeoLeaf.loadConfig() est introuvable. V\xe9rifiez que le bundle core est complet.");e.info("D\xe9marrage de l'application..."),document.addEventListener("geoleaf:app:ready",function(){Wl.bootInfo?.show&&Wl.bootInfo.show(Wl)},{once:1});let t=null;try{const o=sessionStorage.getItem("gl-selected-profile");o&&/^[a-zA-Z0-9_-]{1,50}$/.test(o)?(t=o,e.log("Profil s\xe9lectionn\xe9 depuis sessionStorage:",t)):o&&e.warn("Profil sessionStorage rejet\xe9 (format invalide):",o.substring(0,20)),sessionStorage.removeItem("gl-selected-profile")}catch(t){e.warn("Impossible de lire sessionStorage:",t)}const o=Xl.getProfilesBasePath(),n=new Promise((e,n)=>{Wl.loadConfig({url:o+"geoleaf.config.json",profileId:t,autoEvent:1,onLoaded:e,onError:n})});let r;try{r=await n,e.log("Configuration charg\xe9e via GeoLeaf.loadConfig :",r||{})}catch(t){return void e.error("Erreur chargement config via GeoLeaf.loadConfig :",t)}if(Wl.Config&&"function"==typeof Wl.Config.getCategories)try{Wl.Config.getCategories()}catch(t){e.warn("Erreur lors de la lecture du mapping cat\xe9gories :",t)}const i=r||{};if(Wl.Config&&"function"==typeof Wl.Config.loadActiveProfileResources)try{const t=await Wl.Config.loadActiveProfileResources();e.info("Ressources du profil actif charg\xe9es."),Xl.initApp(t||i)}catch(t){e.warn("Erreur lors du chargement des ressources de profil :",t),Xl.initApp(i)}else Xl.initApp(i)},Wl.boot=function(){Wl.plugins?.reportPremiumPlugins?.(),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",Xl.startApp):Xl.startApp()};const Yl="undefined"!=typeof globalThis?globalThis:window;Yl.GeoLeaf=Yl.GeoLeaf||{};const Ql=new Map([["poi",async()=>{await Promise.resolve().then(function(){return es}),await Promise.all([Promise.resolve().then(function(){return ts}),Promise.resolve().then(function(){return os})])}],["poiCore",()=>Promise.resolve().then(function(){return es})],["poiRenderers",()=>Promise.resolve().then(function(){return ts})],["poiExtras",()=>Promise.resolve().then(function(){return os})],["basemapSelector",()=>Promise.resolve().then(function(){return ns})],["route",()=>Promise.resolve().then(function(){return rs})],["layerManager",()=>Promise.resolve().then(function(){return is})],["legend",()=>Promise.resolve().then(function(){return as})],["labels",()=>Promise.resolve().then(function(){return ls})],["themes",()=>Promise.resolve().then(function(){return ss})],["table",()=>Promise.resolve().then(function(){return cs})]]);if(Yl.GeoLeaf.plugins?.registerLazy)for(const[e,t]of Ql)Yl.GeoLeaf.plugins.registerLazy(e,t);Yl.GeoLeaf._loadModule=async function(e){const t=Ql.get(e);if(t)try{await t(),Yl.GeoLeaf.plugins?.register(e,{version:Yl.GeoLeaf._version})}catch(t){throw console.error(`[GeoLeaf] Erreur lors du chargement du module "${e}" :`,t),t}else console.warn(`[GeoLeaf] Module inconnu : "${e}". Disponibles : ${[...Ql.keys()].join(", ")}`)},Yl.GeoLeaf._loadAllSecondaryModules=async function(){await Promise.resolve().then(function(){return es}),await Promise.all([Promise.resolve().then(function(){return ts}),Promise.resolve().then(function(){return os}),Promise.resolve().then(function(){return rs}),Promise.resolve().then(function(){return is}),Promise.resolve().then(function(){return as}),Promise.resolve().then(function(){return ls}),Promise.resolve().then(function(){return ss}),Promise.resolve().then(function(){return cs})])};var Kl="undefined"!=typeof window?window.GeoLeaf:{},es=Object.freeze({__proto__:null}),ts=Object.freeze({__proto__:null}),os=Object.freeze({__proto__:null}),ns=Object.freeze({__proto__:null}),rs=Object.freeze({__proto__:null}),is=Object.freeze({__proto__:null}),as=Object.freeze({__proto__:null}),ls=Object.freeze({__proto__:null}),ss=Object.freeze({__proto__:null}),cs=Object.freeze({__proto__:null});e.default=Kl,Object.defineProperty(e,"__esModule",{value:1})});