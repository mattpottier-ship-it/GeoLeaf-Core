/* GeoLeaf v3.2.0 | MIT License | github.com/mattpottier-ship-it/geoleaf-js */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).GeoLeaf={})}(this,function(e){"use strict";var t,o,n,r,i,a,l,s,c,u,d,f,p,g,y,h,m,b,_,v,C,S,I,P,w,A,G,E,O,T,M,x,N,F,U,k,R,D,B,$,j,J,z,V,q,H,Z,W,X,Y,Q,K,ee,te,oe,ne,re,ie,ae,le,se,ce,ue,de,fe,pe,ge,ye,he,me,be,_e,Le,ve,Ce,Se,Ie,Pe,we,Ae,Ge,Ee,Oe,Te,Me,xe,Ne,Fe,Ue,ke,Re,De,Be,$e,je,Je,ze,Ve,qe,He,Ze,We,Xe,Ye,Qe,Ke,et,tt,ot,nt,rt,it,at,lt,st,ct,ut,dt,ft,pt,gt="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};t||(t=1,function(e){e.GeoLeaf||(e.GeoLeaf={});let t=1,o=0,n=new Map;const r=e=>`[GeoLeaf.${e}]`,i=e=>[/Chargement du sprite SVG/,/Sprite SVG d\xe9tect\xe9/,/IconsConfig r\xe9cup\xe9r\xe9/,/Module.*charg\xe9/,/Module.*initialis\xe9/,/Contr\xf4le.*ajout\xe9/,/Bouton.*ajout\xe9/,/Panneau.*cr\xe9\xe9/,/Section.*remplie/,/Profil.*charg\xe9/,/Couche.*charg\xe9e/,/Style.*appliqu\xe9/,/ThemeApplier/,/LayerManager/,/Storage/,/CacheButton/,/Renderers\./,/FormRenderer/,/ResourceEnumerator/,/LayerSelector/,/CacheControl/,/POI.*DEBUG/,/AddForm/].some(t=>t.test(e)),a=e=>[/ERROR/,/WARN/,/Failed/,/Error/,/Exception/,/Carte initialis\xe9e avec succ\xe8s/,/All.*modules loaded/,/Mode.*activ\xe9/].some(t=>t.test(e)),l=e=>{const t=e.replace(/\d+/g,"X").replace(/[{}:,]/g,""),o=(n.get(t)||0)+1;return n.set(t,o),1===o?1:3!==o||a(e)?o>3?0:o<=2:(console.info(`${r("INFO")} [Group\xe9] Message r\xe9p\xe9t\xe9 - suite masqu\xe9e: ${e.substring(0,60)}...`),0)},s={setLevel(e){switch(String(e).toLowerCase()){case"debug":t=0;break;case"info":t=1;break;case"warn":t=2;break;case"error":t=3;break;case"production":t=2,o=1;break;default:console.warn(`${r("WARN")} Niveau de log inconnu :`,e)}},setQuietMode(e){o!==e&&(o=e,e&&console.info(`${r("INFO")} Mode silencieux activ\xe9 - logs r\xe9p\xe9titifs r\xe9duits`))},showSummary(){if(n.size>0){console.group(`${r("INFO")} R\xe9sum\xe9 des logs group\xe9s:`);for(const[e,t]of n)t>3&&console.info(`\u2022 ${t}x: ${e.substring(0,60)}...`);console.groupEnd()}},debug(...e){if(t<=0){const t=e.join(" ");if(o&&i(t)&&!l(t))return;r("DEBUG")}},info(...e){if(t<=1){const t=e.join(" ");if(o){if(a(t))return void console.info(r("INFO"),...e);if(i(t)&&!l(t))return}console.info(r("INFO"),...e)}},warn(...e){t<=2&&console.warn(r("WARN"),...e)},error(...e){t<=3&&console.error(r("ERROR"),...e)}};e.GeoLeaf.Log=s}("undefined"!=typeof globalThis?globalThis:window)),function(){function e(){if(!window.GeoLeaf||!window.GeoLeaf.Log)return void setTimeout(e,50);const t=window.GeoLeaf.Log,o="localhost"!==location.hostname&&!location.hostname.includes("127.0.0.1")&&!location.search.includes("debug=true"),n=location.search.includes("debug=true")||location.search.includes("verbose=true");o?(t.setLevel("production"),window.GeoLeaf&&GeoLeaf.Log&&GeoLeaf.Log.info&&GeoLeaf.Log.info("\u{1f527} [GeoLeaf] Mode production activ\xe9 - logs r\xe9duits")):n?(t.setLevel("debug"),t.setQuietMode(0),window.GeoLeaf&&GeoLeaf.Log&&GeoLeaf.Log.info&&GeoLeaf.Log.info("\u{1f527} [GeoLeaf] Mode debug activ\xe9 - tous les logs visibles")):(t.setLevel("info"),t.setQuietMode(1),window.GeoLeaf&&GeoLeaf.Log&&GeoLeaf.Log.info&&GeoLeaf.Log.info("\u{1f527} [GeoLeaf] Mode d\xe9veloppement - logs optimis\xe9s")),setTimeout(()=>{t.showSummary&&t.showSummary();const e=performance.now();window.GeoLeaf&&GeoLeaf.Log&&GeoLeaf.Log.info&&GeoLeaf.Log.info("\u{1f3af} [GeoLeaf] D\xe9marrage termin\xe9:",{"\u23f1\ufe0f Temps total":Math.round(e)+"ms","\u{1f4e6} Modules":"122 charg\xe9s","\u{1f507} Logs":o?"mode production":n?"mode debug":"mode optimis\xe9","\u{1f4a1} Conseil":n?"":"Ajoutez ?debug=true pour les logs d\xe9taill\xe9s"})},3e3)}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e):e()}(),o||(o=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log,o={escapeHtml(e){if(null==e)return"";"string"!=typeof e&&(e=String(e));const t=document.createElement("div");return t.textContent=e,t.innerHTML},escapeAttribute:e=>null==e?"":("string"!=typeof e&&(e=String(e)),e.replace(/&/g,"&amp;").replace(/'/g,"&#39;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")),validateUrl(t,o){if(!t||"string"!=typeof t)throw new TypeError("URL must be a non-empty string");t=t.trim();const n=o||e.location.origin;try{const e=new URL(t,n),o=["http:","https:","data:"];if(!o.includes(e.protocol))throw new Error(`Protocol "${e.protocol}" not allowed. Allowed protocols: ${o.join(", ")}`);if("data:"===e.protocol){const e=["image/png","image/jpeg","image/jpg","image/gif","image/svg+xml","image/webp"],o=t.split(",")[0].match(/data:([^;,]+)/);if(!o)throw new Error("Invalid data URL format");const n=o[1];if(!e.includes(n))throw new Error(`Data URL type "${n}" not allowed. Allowed: ${e.join(", ")}`)}return e.href}catch(e){if(e.message.includes("not allowed"))throw e;throw new Error(`Invalid URL "${t}": ${e.message}`)}},validateCoordinates(e,t){if("number"!=typeof e||"number"!=typeof t)throw new TypeError(`Coordinates must be numbers, got lat=${typeof e}, lng=${typeof t}`);if(!Number.isFinite(e)||!Number.isFinite(t))throw new RangeError("Coordinates must be finite numbers (not NaN or Infinity)");if(e<-90||e>90)throw new RangeError(`Latitude must be between -90 and 90, got ${e}`);if(t<-180||t>180)throw new RangeError(`Longitude must be between -180 and 180, got ${t}`);return[e,t]},sanitizePoiProperties(e){if(!e||"object"!=typeof e)return{};const o={},n=["label","name","title","description","desc","address","phone","email","category","type"],r=["url","website","image","photo","icon"];for(const[i,a]of Object.entries(e))if("function"!=typeof a&&"symbol"!=typeof a)if(null!=a)if(n.includes(i)&&"string"==typeof a)o[i]=this.escapeHtml(a);else if(r.includes(i)&&"string"==typeof a)try{o[i]=this.validateUrl(a)}catch(e){t.warn(`[Security] Invalid URL for ${i}: ${e.message}`),o[i]=""}else Array.isArray(a)?o[i]=a.map(e=>"object"==typeof e&&null!==e?this.sanitizePoiProperties(e):"string"==typeof e?this.escapeHtml(e):e):o[i]="object"==typeof a&&null!==a?this.sanitizePoiProperties(a):a;else o[i]="";return o},containsDangerousHtml:e=>"string"!=typeof e?0:[/<script/i,/javascript:/i,/on\w+\s*=/i,/<iframe/i,/<object/i,/<embed/i,/<applet/i,/<meta/i,/<link/i,/vbscript:/i,/data:text\/html/i].some(t=>t.test(e)),stripHtml(e){if("string"!=typeof e)return"";const t=(new DOMParser).parseFromString(e,"text/html");return t.body.textContent||t.body.innerText||""},createSafeElement(e,t={}){const o=document.createElement(e);return t.className&&(o.className=t.className),t.id&&(o.id=t.id),t.textContent&&(o.textContent=t.textContent),t.attributes&&Object.keys(t.attributes).forEach(e=>{o.setAttribute(e,this.escapeAttribute(t.attributes[e]))}),t.children&&Array.isArray(t.children)&&t.children.forEach(e=>{e instanceof Element&&o.appendChild(e)}),o},sanitizeSvgContent(e){if(!e||"string"!=typeof e)return null;try{const o=(new DOMParser).parseFromString(e,"image/svg+xml"),n=o.querySelector("parsererror");if(n)return t.warn("[Security] Erreur parsing SVG:",n.textContent),null;const r=o.documentElement;return r&&"svg"===r.tagName.toLowerCase()?(["script","foreignObject","use[href^='data:']"].forEach(e=>{r.querySelectorAll(e).forEach(e=>e.remove())}),r.querySelectorAll("*").forEach(e=>{Array.from(e.attributes).forEach(t=>{t.name.toLowerCase().startsWith("on")&&e.removeAttribute(t.name),"href"!==t.name&&"xlink:href"!==t.name||!t.value.toLowerCase().trim().startsWith("javascript:")||e.removeAttribute(t.name)})}),r):(t.warn("[Security] Contenu SVG invalide: \xe9l\xe9ment racine n'est pas SVG"),null)}catch(e){return t.warn("[Security] Erreur sanitization SVG:",e.message),null}},validateNumber(e,t=-1/0,o=1/0){const n=Number(e);return Number.isFinite(n)?n<t||n>o?null:n:null},parseHtmlSafely(e,o=["p","br","strong","em","span","a","ul","ol","li","b","i"]){const n=document.createDocumentFragment();if(!e||"string"!=typeof e)return n;try{const t=(new DOMParser).parseFromString(e,"text/html"),r=e=>{if(e.nodeType===Node.TEXT_NODE)return document.createTextNode(e.textContent);if(e.nodeType!==Node.ELEMENT_NODE)return null;const t=e.tagName.toLowerCase();if(!o.includes(t))return document.createTextNode(e.textContent);const n=document.createElement(t);if("a"===t&&e.hasAttribute("href"))try{const t=this.validateUrl(e.getAttribute("href"));n.setAttribute("href",t),n.setAttribute("rel","noopener noreferrer"),n.setAttribute("target","_blank")}catch(e){}return e.childNodes.forEach(e=>{const t=r(e);t&&n.appendChild(t)}),n};t.body.childNodes.forEach(e=>{const t=r(e);t&&n.appendChild(t)})}catch(e){t.warn("[Security] Erreur parsing HTML s\xe9curis\xe9:",e.message)}return n}};GeoLeaf.Security=o,t.info("[GeoLeaf.Security] Module de s\xe9curit\xe9 charg\xe9")}("undefined"!=typeof window?window:gt)),n||(n=1,function(e){(e.GeoLeaf=e.GeoLeaf||{}).CONSTANTS={DEFAULT_ZOOM:3,DEFAULT_CENTER:[0,0],MAX_ZOOM_ON_FIT:15,POI_MARKER_SIZE:12,POI_MAX_ZOOM:18,POI_SWIPE_THRESHOLD:50,POI_LIGHTBOX_TRANSITION_MS:300,POI_SIDEPANEL_DEFAULT_WIDTH:420,ROUTE_MAX_ZOOM_ON_FIT:14,ROUTE_WAYPOINT_RADIUS:5,GEOJSON_MAX_ZOOM_ON_FIT:15,GEOJSON_POINT_RADIUS:6,FULLSCREEN_TRANSITION_MS:10}}("undefined"!=typeof window?window:gt)),r||(r=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t={escapeHtml(e){if(GeoLeaf.Security&&"function"==typeof GeoLeaf.Security.escapeHtml)return GeoLeaf.Security.escapeHtml(e);if(null==e||""===e)return"";const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;","/":"&#x2F;"};return String(e).replace(/[&<>"'/]/g,function(e){return t[e]})},validateUrl(e,t=["http:","https:","mailto:","tel:"]){if(!e||"string"!=typeof e)return null;try{const o=new URL(e,window.location.origin);return t.includes(o.protocol)?o.href:null}catch(e){return null}},deepMerge(e,t){if(!t||"object"!=typeof t)return e;if(!e||"object"!=typeof e)return t;const o=Object.assign({},e);return Object.keys(t).forEach(n=>{t[n]&&"object"==typeof t[n]&&!Array.isArray(t[n])?o[n]=this.deepMerge(e[n]||{},t[n]):o[n]=t[n]}),o},ensureMap:e=>e||(void 0!==GeoLeaf&&GeoLeaf.Core&&"function"==typeof GeoLeaf.Core.getMap?GeoLeaf.Core.getMap():null),mergeOptions:(e,t)=>t&&"object"==typeof t?Object.assign({},e,t):e,fireMapEvent(e,t,o){if(e&&"function"==typeof e.fire)try{e.fire(t,o||{})}catch(e){Log&&Log.warn("[GeoLeaf.Utils] Erreur lors de l'\xe9mission de l'\xe9v\xe9nement:",t,e)}},debounce(e,t=250){let o;return function(...n){clearTimeout(o),o=setTimeout(()=>{clearTimeout(o),e(...n)},t)}},throttle(e,t=100){let o;return function(...n){o||(e.apply(this,n),o=1,setTimeout(()=>o=0,t))}},getDistance(e,t,o,n){const r=(o-e)*(Math.PI/180),i=(n-t)*(Math.PI/180),a=Math.sin(r/2)*Math.sin(r/2)+Math.cos(e*(Math.PI/180))*Math.cos(o*(Math.PI/180))*Math.sin(i/2)*Math.sin(i/2);return 2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))*6371},resolveField(e,...t){if(!e||"object"!=typeof e)return"";for(const o of t){const t=o.split(".");let n=e;for(const e of t){if(!n||"object"!=typeof n||!(e in n)){n=null;break}n=n[e]}if(null!=n){if("string"!=typeof n)return n;if(n.trim())return n}}return""}};GeoLeaf.Utils=t}("undefined"!=typeof window?window:gt)),i||(i=1,function(e){!function(t){const o=function(){const e=t.GeoLeaf?.Log,o=t.GeoLeaf?.Security;function n(e,t,o,n={}){const r=document.createElementNS("http://www.w3.org/2000/svg","svg");r.setAttribute("width",e),r.setAttribute("height",t),r.setAttribute("viewBox",n.viewBox||"0 0 24 24"),r.setAttribute("fill",n.fill||"none"),r.setAttribute("stroke",n.stroke||"currentColor"),r.setAttribute("stroke-width",String(n.strokeWidth||"2")),r.setAttribute("stroke-linecap",n.strokeLinecap||"round"),r.setAttribute("stroke-linejoin",n.strokeLinejoin||"round");const i=document.createElementNS("http://www.w3.org/2000/svg","path");return i.setAttribute("d",o),r.appendChild(i),r}const r={"chevron-down":"M6 9l6 6 6-6","chevron-up":"M18 15l-6-6-6 6","chevron-left":"M15 18l-6-6 6-6","chevron-right":"M9 18l6-6-6-6","arrow-left":"\u2039","arrow-right":"\u203a",close:"\u2715",check:"\u2713",star:"\u2605","star-empty":"\u2606","triangle-right":"\u25b6","triangle-down":"\u25bc",home:"M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z",layers:"M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5",marker:"M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z","map-pin":"M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z",download:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3",upload:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12",trash:"M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",copy:"M8 4v12a2 2 0 002 2h8a2 2 0 002-2V7.242a2 2 0 00-.602-1.43L16.083 2.57A2 2 0 0014.685 2H10a2 2 0 00-2 2z",sync:"M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"};return{setTextContent:function(t,o){t&&t.nodeType?t.textContent=null!=o?String(o):"":e&&e.warn("[DOMSecurity] Invalid element in setTextContent")},setSafeHTML:function(t,n){if(t&&t.nodeType)if(o&&"function"==typeof o.escapeHtml){const e=o.escapeHtml(n);t.innerHTML=e}else e&&e.warn("[DOMSecurity] No sanitizer available, falling back to textContent"),t.textContent=n||"";else e&&e.warn("[DOMSecurity] Invalid element in setSafeHTML")},clearElement:function(t){if(t&&t.nodeType)for(;t.firstChild;)t.removeChild(t.firstChild);else e&&e.warn("[DOMSecurity] Invalid element in clearElement")},clearElementFast:function(t){t&&t.nodeType?t.textContent="":e&&e.warn("[DOMSecurity] Invalid element in clearElementFast")},createSVGIcon:n,getIcon:function(t,o=18,i={}){const a=r[t];return a?n(o,o,a,i):(e&&e.warn(`[DOMSecurity] Icon '${t}' not found`),null)},createElement:function(e,t={},o=null){const n=document.createElement(e);for(const[e,o]of Object.entries(t))"class"===e||"className"===e?n.className=o:"style"===e&&"object"==typeof o?Object.assign(n.style,o):e.startsWith("data-")?n.setAttribute(e,o):n[e]=o;return o&&(Array.isArray(o)?o.forEach(e=>{"string"==typeof e?n.appendChild(document.createTextNode(e)):e&&e.nodeType&&n.appendChild(e)}):"string"==typeof o?n.textContent=o:o.nodeType&&n.appendChild(o)),n},SVG_ICONS:r}}();void 0!==t.GeoLeaf||(t.GeoLeaf=t.GeoLeaf||{}),t.GeoLeaf.DOMSecurity=o,e.exports&&(e.exports=o)}("undefined"!=typeof window?window:gt)}({exports:{}})),a||(a=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{};function t(e,t={},...n){if("string"!=typeof e||!e.trim())throw new TypeError("[DomHelpers] createElement: tag must be a non-empty string");const r=document.createElement(e),{className:i,id:a,style:l,dataset:s,attributes:c,textContent:u,innerHTML:d,_eventContext:f,_cleanupArray:p,...g}=t;if(i&&(r.className=i),a&&(r.id=a),l&&"object"==typeof l&&Object.assign(r.style,l),s&&"object"==typeof s)for(const[e,t]of Object.entries(s))r.dataset[e]=t;if(c&&"object"==typeof c)for(const[e,t]of Object.entries(c))r.setAttribute(e,t);const y=GeoLeaf.Utils?.events;for(const[e,t]of Object.entries(g))if(e.startsWith("on")&&"function"==typeof t){const o=e.substring(2).toLowerCase();if(y){const e=y.on(r,o,t,0,f||"DomHelpers.createElement");p&&Array.isArray(p)&&p.push(e)}else r.addEventListener(o,t)}else if(e.startsWith("aria")){const o="aria-"+e.substring(4).toLowerCase();r.setAttribute(o,t)}else e in r?r[e]=t:r.setAttribute(e,t);return void 0!==u?(r.textContent=u,r):void 0!==d?(GeoLeaf.Log&&GeoLeaf.Log.warn&&GeoLeaf.Log.warn("[DomHelpers] createElement avec innerHTML - assurez-vous que le contenu est sanitiz\xe9",{tag:e,innerHTML:d.substring(0,100)}),GeoLeaf.DOMSecurity&&"function"==typeof GeoLeaf.DOMSecurity.setSafeHTML?GeoLeaf.DOMSecurity.setSafeHTML(r,d):(GeoLeaf.Log&&GeoLeaf.Log.error&&GeoLeaf.Log.error("[DomHelpers] DOMSecurity not available, using textContent fallback"),r.textContent=d),r):(o(r,...n),r)}function o(e,...t){for(const n of t)null!=n&&0!=n&&(Array.isArray(n)?o(e,...n):"string"==typeof n||"number"==typeof n?e.appendChild(document.createTextNode(String(n))):n instanceof Node?e.appendChild(n):e.appendChild(document.createTextNode(String(n))));return e}function n(e){if(!e)return e;for(;e.firstChild;)e.removeChild(e.firstChild);return e}GeoLeaf.Utils=GeoLeaf.Utils||{},GeoLeaf.Utils.DomHelpers={createElement:t,appendChild:o,clearElement:n,getElementById:function(e,t=0){const o=document.getElementById(e);if(t&&!o)throw new Error(`Element with id "${e}" not found`);return o},querySelector:function(e,t=document){return t.querySelector(e)},querySelectorAll:function(e,t=document){return Array.from(t.querySelectorAll(e))},toggleClass:function(e,t,o){return e?e.classList.toggle(t,o):0},addClass:function(e,...t){return e?(e.classList.add(...t),e):e},removeClass:function(e,...t){return e?(e.classList.remove(...t),e):e},hasClass:function(e,t){return e?e.classList.contains(t):0},setData:function(e,t,o){return e?void 0===o?e.dataset[t]:(e.dataset[t]=o,e):void 0===o?null:e}},GeoLeaf.Utils.createElement=t,GeoLeaf.Utils.appendChild=o,GeoLeaf.Utils.clearElement=n,GeoLeaf.Log&&GeoLeaf.Log.info&&GeoLeaf.Log.info("[GeoLeaf.Utils.DomHelpers] Module loaded")}("undefined"!=typeof window?window:{})),l||(l=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{};GeoLeaf.Utils=GeoLeaf.Utils||{};const t=GeoLeaf.Log;class EventListenerManager{constructor(e="default"){this.name=e,this.listeners=[],this._nextId=1}addEventListener(e,o,n,r=0,i=""){if(!e||"function"!=typeof e.addEventListener)return t&&t.warn(`[EventListenerManager.${this.name}] Invalid target for addEventListener`),null;const a=this._nextId++;return e.addEventListener(o,n,r),this.listeners.push({id:a,target:e,event:o,handler:n,options:r,label:i,createdAt:Date.now()}),t&&t.debug(`[EventListenerManager.${this.name}] Listener added:`,a,o,i),a}addLeafletListener(e,o,n,r=""){if(!e||"function"!=typeof e.on)return t&&t.warn(`[EventListenerManager.${this.name}] Invalid Leaflet target`),null;const i=this._nextId++;return e.on(o,n),this.listeners.push({id:i,target:e,event:o,handler:n,label:r,type:"leaflet",createdAt:Date.now()}),t&&t.debug(`[EventListenerManager.${this.name}] Leaflet listener added:`,i,o,r),i}removeListener(e){const o=this.listeners.findIndex(t=>t.id===e);if(-1===o)return 0;const n=this.listeners[o];return"leaflet"===n.type?n.target&&"function"==typeof n.target.off&&n.target.off(n.event,n.handler):n.target&&"function"==typeof n.target.removeEventListener&&n.target.removeEventListener(n.event,n.handler,n.options),this.listeners.splice(o,1),t&&t.debug(`[EventListenerManager.${this.name}] Listener removed:`,e,n.label),1}removeListenersForTarget(e){const o=this.listeners.filter(t=>t.target===e);return o.forEach(e=>{"leaflet"===e.type?e.target&&"function"==typeof e.target.off&&e.target.off(e.event,e.handler):e.target&&"function"==typeof e.target.removeEventListener&&e.target.removeEventListener(e.event,e.handler,e.options)}),this.listeners=this.listeners.filter(t=>t.target!==e),t&&o.length>0&&t.info(`[EventListenerManager.${this.name}] Removed ${o.length} listener(s) for target`),o.length}removeAll(){const e=this.listeners.length;this.listeners.forEach(e=>{try{"leaflet"===e.type?e.target&&"function"==typeof e.target.off&&e.target.off(e.event,e.handler):e.target&&"function"==typeof e.target.removeEventListener&&e.target.removeEventListener(e.event,e.handler,e.options)}catch(e){t&&t.warn(`[EventListenerManager.${this.name}] Error removing listener:`,e)}}),this.listeners=[],t&&e>0&&t.info(`[EventListenerManager.${this.name}] Removed ${e} listener(s)`)}getCount(){return this.listeners.length}listActiveListeners(){return this.listeners.map(e=>({id:e.id,event:e.event,label:e.label,type:e.type||"dom",age:Date.now()-e.createdAt}))}destroy(){this.removeAll(),t&&t.info(`[EventListenerManager.${this.name}] Destroyed`)}}const o=new EventListenerManager("global");GeoLeaf.Utils.EventListenerManager=EventListenerManager,GeoLeaf.Utils.events={on:(e,t,n,r,i)=>o.addEventListener(e,t,n,r,i),onLeaflet:(e,t,n,r)=>o.addLeafletListener(e,t,n,r),off:e=>o.removeListener(e),offTarget:e=>o.removeListenersForTarget(e),offAll:()=>o.removeAll(),getCount:()=>o.getCount(),listActive:()=>o.listActiveListeners(),createManager:e=>new EventListenerManager(e)},"undefined"!=typeof window&&window.addEventListener("beforeunload",()=>{const e=o.getCount();e>0&&(t&&t.warn(`[EventListenerManager] ${e} listener(s) still active at page unload`),o.removeAll())}),t&&t.info("[GeoLeaf.Utils.EventListenerManager] Module charg\xe9")}("undefined"!=typeof window?window:gt)),s||(s=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{};GeoLeaf.Utils=GeoLeaf.Utils||{};const t=GeoLeaf.Log;class TimerManager{constructor(e="default"){this.name=e,this.timers=new Map,this.intervals=new Map,this._nextId=1}setTimeout(e,o,n=""){const r=this._nextId++,i=setTimeout(()=>{try{e()}finally{this.timers.delete(r)}},o);return this.timers.set(r,{timerId:i,label:n,type:"timeout",createdAt:Date.now(),delay:o}),t&&t.debug(`[TimerManager.${this.name}] setTimeout created:`,r,n),r}setInterval(e,o,n=""){const r=this._nextId++,i=setInterval(()=>{try{e()}catch(e){t&&t.error(`[TimerManager.${this.name}] Error in interval ${r}:`,e)}},o);return this.intervals.set(r,{intervalId:i,label:n,type:"interval",createdAt:Date.now(),interval:o}),t&&t.debug(`[TimerManager.${this.name}] setInterval created:`,r,n),r}clearTimeout(e){const o=this.timers.get(e);return o?(clearTimeout(o.timerId),this.timers.delete(e),t&&t.debug(`[TimerManager.${this.name}] setTimeout cleared:`,e,o.label),1):0}clearInterval(e){const o=this.intervals.get(e);return o?(clearInterval(o.intervalId),this.intervals.delete(e),t&&t.debug(`[TimerManager.${this.name}] setInterval cleared:`,e,o.label),1):0}clearAll(){for(const[e,t]of this.timers.entries())clearTimeout(t.timerId);for(const[e,t]of this.intervals.entries())clearInterval(t.intervalId);const e=this.timers.size+this.intervals.size;this.timers.clear(),this.intervals.clear(),t&&e>0&&t.info(`[TimerManager.${this.name}] Cleared ${e} timer(s)`)}getStats(){return{timeouts:this.timers.size,intervals:this.intervals.size,total:this.timers.size+this.intervals.size}}listActiveTimers(){const e=[];for(const[t,o]of this.timers.entries())e.push({id:t,type:"timeout",label:o.label,age:Date.now()-o.createdAt,delay:o.delay});for(const[t,o]of this.intervals.entries())e.push({id:t,type:"interval",label:o.label,age:Date.now()-o.createdAt,interval:o.interval});return e}destroy(){this.clearAll(),t&&t.info(`[TimerManager.${this.name}] Destroyed`)}}const o=new TimerManager("global");GeoLeaf.Utils.TimerManager=TimerManager,GeoLeaf.Utils.timers={setTimeout:(e,t,n)=>o.setTimeout(e,t,n),setInterval:(e,t,n)=>o.setInterval(e,t,n),clearTimeout:e=>o.clearTimeout(e),clearInterval:e=>o.clearInterval(e),clearAll:()=>o.clearAll(),getStats:()=>o.getStats(),listActive:()=>o.listActiveTimers(),createManager:e=>new TimerManager(e)},"undefined"!=typeof window&&window.addEventListener("beforeunload",()=>{const e=o.getStats();e.total>0&&(t&&t.warn(`[TimerManager] ${e.total} timer(s) still active at page unload`),o.clearAll())}),t&&t.info("[GeoLeaf.Utils.TimerManager] Module charg\xe9")}("undefined"!=typeof window?window:gt)),c||(c=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{};GeoLeaf.Utils=GeoLeaf.Utils||{};const t={zoom:null,lat:null,scale:null};GeoLeaf.Utils.ScaleUtils={calculateMapScale:function(e,o={}){if(!e)return 0;const n=o.logger,r=e.getCenter?.(),i=e.getZoom?.();if(!r||"number"!=typeof i)return 0;if(!o.force&&t.zoom===i&&t.lat===r.lat)return t.scale||0;const a=156543.04*Math.cos(r.lat*Math.PI/180)/Math.pow(2,i)*96,l=Math.round(a/.0254);return t.zoom=i,t.lat=r.lat,t.scale=l,n&&"function"==typeof n.debug&&n.debug(`[ScaleUtils] Calcul \xe9chelle: zoom=${i}, lat=${r.lat.toFixed(2)}, \xe9chelle=1:${l.toLocaleString()}`),l},isScaleInRange:function(e,t,o,n){const r="number"==typeof t&&t>0?t:null,i="number"==typeof o&&o>0?o:null;return null!==r&&e>r?(n&&"function"==typeof n.debug&&n.debug(`[ScaleUtils] ${e} > minScale ${r} \u2192 invisible (trop d\xe9zoom\xe9)`),0):null!==i&&e<i?(n&&"function"==typeof n.debug&&n.debug(`[ScaleUtils] ${e} < maxScale ${i} \u2192 invisible (trop zoom\xe9)`),0):(n&&"function"==typeof n.debug&&n.debug(`[ScaleUtils] ${e} dans [${i??"\u221e"} ; ${r??"\u221e"}] \u2192 visible`),1)},clearScaleCache:function(){t.zoom=null,t.lat=null,t.scale=null}}}(window)),u||(u=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{};function t(e,t){if(!e||!t)return null;const o=GeoLeaf._GeoJSONShared?.state?.layers?.get(t);if(!o)return null;const n=o.currentStyle;if(!n||!n.styleRules)return null;const r=e.categoryId||e.category||e.attributes&&e.attributes.categoryId||e.properties&&e.properties.categoryId||e.properties&&e.properties.category,i=e.subCategoryId||e.subCategory||e.sub_category||e.attributes&&e.attributes.subCategoryId||e.properties&&e.properties.subCategoryId||e.properties&&e.properties.sub_category;if(i){const e=n.styleRules.find(e=>e.when&&"properties.subCategoryId"===e.when.field&&e.when.value===i);if(e&&e.style)return{fillColor:e.style.fillColor,color:e.style.color,colorFill:e.style.fillColor,colorStroke:e.style.color}}if(r){const e=n.styleRules.find(e=>e.when&&"properties.categoryId"===e.when.field&&e.when.value===r);if(e&&e.style)return{fillColor:e.style.fillColor,color:e.style.color,colorFill:e.style.fillColor,colorStroke:e.style.color}}return n.defaultStyle?{fillColor:n.defaultStyle.fillColor,color:n.defaultStyle.color,colorFill:n.defaultStyle.fillColor,colorStroke:n.defaultStyle.color}:null}GeoLeaf.Helpers=GeoLeaf.Helpers||{},GeoLeaf.Helpers.StyleResolver={getColorsFromLayerStyle:t,resolvePoiColors:function(e){const o={colorFill:null,colorStroke:null,colorRoute:null};if(!e||!e._layerConfig)return o;const n=t(e,e._layerConfig.id);return n&&(o.colorFill=n.fillColor||n.colorFill,o.colorStroke=n.color||n.colorStroke,o.colorRoute=n.color||n.colorStroke),o}}}(window)),d||(d=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{};GeoLeaf._StyleValidatorRules=GeoLeaf._StyleValidatorRules||{},GeoLeaf._StyleValidatorRules.validateStyleRules=function(e,t,o,n){Array.isArray(e)?e.forEach((e,r)=>{const i={...n,ruleIndex:r};"object"==typeof e&&null!==e?(e.when?GeoLeaf._StyleValidatorRules.validateWhenCondition(e.when,r,t,o,i):t.push({field:`styleRules[${r}].when`,message:"Le champ 'when' est requis",context:i}),e.style?"object"==typeof e.style&&null!==e.style||t.push({field:`styleRules[${r}].style`,message:"Le style doit \xeatre un objet",context:{received:typeof e.style,...i}}):t.push({field:`styleRules[${r}].style`,message:"Le champ 'style' est requis",context:i}),e.legend&&"object"!=typeof e.legend&&t.push({field:`styleRules[${r}].legend`,message:"legend doit \xeatre un objet",context:{received:typeof e.legend,...i}})):t.push({field:`styleRules[${r}]`,message:"La r\xe8gle doit \xeatre un objet",context:i})}):t.push({field:"styleRules",message:"styleRules doit \xeatre un tableau",context:{received:typeof e,...n}})},GeoLeaf._StyleValidatorRules.validateWhenCondition=function(e,t,o,n,r){"object"==typeof e&&null!==e?e.all&&Array.isArray(e.all)?e.all.forEach((e,n)=>{GeoLeaf._StyleValidatorRules.validateSimpleCondition(e,t,n,o,r)}):GeoLeaf._StyleValidatorRules.validateSimpleCondition(e,t,null,o,r):o.push({field:`styleRules[${t}].when`,message:"when doit \xeatre un objet",context:{received:typeof e,...r}})},GeoLeaf._StyleValidatorRules.validateSimpleCondition=function(e,t,o=null,n,r){const i=["field","operator","value"];for(const a of i)if(!(a in e)){const e=null!==o?`styleRules[${t}].when.all[${o}]`:`styleRules[${t}].when`;n.push({field:`${e}.${a}`,message:`Le champ '${a}' est requis dans la condition`,context:r})}const a=["==","!=","<",">","<=",">=","in","contains"];if(e.operator&&!a.includes(e.operator)){const i=null!==o?`styleRules[${t}].when.all[${o}]`:`styleRules[${t}].when`;n.push({field:`${i}.operator`,message:"Op\xe9rateur invalide",context:{received:e.operator,allowed:a,...r}})}if(e.field&&"string"!=typeof e.field){const i=null!==o?`styleRules[${t}].when.all[${o}]`:`styleRules[${t}].when`;n.push({field:`${i}.field`,message:"field doit \xeatre une cha\xeene de caract\xe8res",context:{received:typeof e.field,...r}})}},GeoLeaf._StyleValidatorRules.validateScales=function(e,t,o,n){["layerScale","labelScale"].forEach(o=>{const r="layerScale"===o;if(!e[o])return void(r&&t.push({field:o,message:`${o} est requis`,context:n}));const i=e[o];"object"==typeof i&&null!==i?["minScale","maxScale"].forEach(e=>{e in i?null!==i[e]&&("number"!=typeof i[e]||i[e]<0)&&t.push({field:`${o}.${e}`,message:`${e} doit \xeatre un nombre >= 0 ou null`,context:{received:i[e],...n}}):r&&t.push({field:`${o}.${e}`,message:`${e} est requis dans ${o}`,context:n})}):t.push({field:o,message:`${o} doit \xeatre un objet`,context:{received:typeof i,...n}})})},GeoLeaf._StyleValidatorRules.validateLegend=function(e,t,o,n){"object"==typeof e&&null!==e?"order"in e&&!Number.isInteger(e.order)&&t.push({field:"legend.order",message:"order doit \xeatre un entier",context:{received:e.order,type:typeof e.order,...n}}):t.push({field:"legend",message:"legend doit \xeatre un objet",context:{received:typeof e,...n}})}}(window)),f||(f=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{};class StyleValidationError extends Error{constructor(e,t={}){super(e),this.name="StyleValidationError",this.context=t}}function t(e,t,n,r,i){"object"==typeof e&&null!==e?(e.color&&!o(e.color)&&n.push({field:`${t}.color`,message:"Couleur invalide, format attendu: #RRGGBB",context:{received:e.color,...i}}),"opacity"in e&&("number"!=typeof e.opacity||e.opacity<0||e.opacity>1)&&n.push({field:`${t}.opacity`,message:"L'opacit\xe9 doit \xeatre un nombre entre 0 et 1",context:{received:e.opacity,...i}}),"sizePx"in e&&("number"!=typeof e.sizePx||e.sizePx<0)&&n.push({field:`${t}.sizePx`,message:"sizePx doit \xeatre un nombre >= 0",context:{received:e.sizePx,...i}})):n.push({field:t,message:`${t} doit \xeatre un objet`,context:{received:typeof e,...i}})}function o(e){return"string"==typeof e&&/^#[0-9A-Fa-f]{6}$/.test(e)}const n={validateStyle:function(e,n={}){const r=[],i=[];try{if(!e||"object"!=typeof e)return r.push({field:"root",message:"Le style doit \xeatre un objet JSON valide",context:{received:typeof e,...n}}),{valid:0,errors:r,warnings:i};!function(e,t,o){"id"in e&&void 0!==e.id&&null!==e.id||t.push({field:"id",message:"Le champ requis 'id' est manquant",context:{availableFields:Object.keys(e),...o}});const n="style"in e&&void 0!==e.style&&null!==e.style,r="defaultStyle"in e&&void 0!==e.defaultStyle&&null!==e.defaultStyle;n||r||t.push({field:"style",message:"Le champ requis 'style' ou 'defaultStyle' est manquant",context:{availableFields:Object.keys(e),...o}}),"layerScale"in e||t.push({field:"layerScale",message:"Le champ requis 'layerScale' est manquant",context:{availableFields:Object.keys(e),...o}})}(e,r,n),function(e,t,o){if(!e.id)return;const n=/^[\p{L}0-9_-]+$/u;"string"!=typeof e.id?t.push({field:"id",message:"L'ID doit \xeatre une cha\xeene de caract\xe8res",context:{received:typeof e.id,value:e.id,...o}}):n.test(e.id)||t.push({field:"id",message:"L'ID doit contenir uniquement des lettres, chiffres, tirets et underscores",context:{received:e.id,pattern:n.toString(),...o}})}(e,r,n),function(e,n,r,i){if(!("label"in e))return;const a=e.label;"string"!=typeof a&&("object"==typeof a&&null!==a?("enabled"in a?"boolean"!=typeof a.enabled&&n.push({field:"label.enabled",message:"Le champ 'enabled' doit \xeatre un bool\xe9en",context:{received:typeof a.enabled,value:a.enabled,...i}}):n.push({field:"label.enabled",message:"Le champ 'enabled' est requis dans la configuration de labels",context:{labelConfig:a,...i}}),a.enabled&&!a.field&&r.push({field:"label.field",message:"Les labels sont activ\xe9s mais aucun champ n'est sp\xe9cifi\xe9",context:{labelConfig:a,...i}}),a.font&&function(e,t,o,n){"object"==typeof e&&null!==e?(void 0!==e.sizePt&&("number"!=typeof e.sizePt||e.sizePt<1)&&t.push({field:"label.font.sizePt",message:"sizePt doit \xeatre un nombre >= 1",context:{received:e.sizePt,...n}}),void 0!==e.weight&&(!Number.isInteger(e.weight)||e.weight<0||e.weight>100)&&t.push({field:"label.font.weight",message:"weight doit \xeatre un entier entre 0 et 100",context:{received:e.weight,...n}})):t.push({field:"label.font",message:"La configuration font doit \xeatre un objet",context:{received:typeof e,...n}})}(a.font,n,0,i),a.color&&!o(a.color)&&n.push({field:"label.color",message:"Couleur invalide, format attendu: #RRGGBB",context:{received:a.color,...i}}),"opacity"in a&&("number"!=typeof a.opacity||a.opacity<0||a.opacity>1)&&n.push({field:"label.opacity",message:"L'opacit\xe9 doit \xeatre un nombre entre 0 et 1",context:{received:a.opacity,...i}}),a.buffer&&t(a.buffer,"label.buffer",n,0,i),a.background&&t(a.background,"label.background",n,0,i),a.offset&&void 0!==a.offset.distancePx&&"number"!=typeof a.offset.distancePx&&n.push({field:"label.offset.distancePx",message:"distancePx doit \xeatre un nombre",context:{received:typeof a.offset.distancePx,...i}})):n.push({field:"label",message:"Le champ 'label' doit \xeatre une cha\xeene de caract\xe8res ou un objet de configuration",context:{received:typeof a,value:a,...i}}))}(e,r,i,n),function(e,t,n,r){const i=e.style||e.defaultStyle;i&&("object"==typeof i&&null!==i?(["fillColor","color"].forEach(e=>{i[e]&&!o(i[e])&&t.push({field:`style.${e}`,message:"Couleur invalide, format attendu: #RRGGBB",context:{received:i[e],...r}})}),["fillOpacity","opacity"].forEach(e=>{e in i&&("number"!=typeof i[e]||i[e]<0||i[e]>1)&&t.push({field:`style.${e}`,message:`${e} doit \xeatre un nombre entre 0 et 1`,context:{received:i[e],...r}})}),["weight","sizePx","radius"].forEach(e=>{e in i&&("number"!=typeof i[e]||i[e]<0)&&t.push({field:`style.${e}`,message:`${e} doit \xeatre un nombre >= 0`,context:{received:i[e],...r}})}),i.shape&&!["circle","square"].includes(i.shape)&&t.push({field:"style.shape",message:"shape doit \xeatre 'circle' ou 'square'",context:{received:i.shape,allowed:["circle","square"],...r}}),i.stroke&&function(e,t,n,r){"object"==typeof e&&null!==e?(e.color&&!o(e.color)&&t.push({field:"style.stroke.color",message:"Couleur invalide, format attendu: #RRGGBB",context:{received:e.color,...r}}),"opacity"in e&&("number"!=typeof e.opacity||e.opacity<0||e.opacity>1)&&t.push({field:"style.stroke.opacity",message:"opacity doit \xeatre un nombre entre 0 et 1",context:{received:e.opacity,...r}}),"weight"in e&&("number"!=typeof e.weight||e.weight<0)&&t.push({field:"style.stroke.weight",message:"weight doit \xeatre un nombre >= 0",context:{received:e.weight,...r}}),null!==e.dashArray&&void 0!==e.dashArray&&"string"!=typeof e.dashArray&&t.push({field:"style.stroke.dashArray",message:"dashArray doit \xeatre une cha\xeene de caract\xe8res ou null",context:{received:typeof e.dashArray,value:e.dashArray,...r}})):t.push({field:"style.stroke",message:"stroke doit \xeatre un objet",context:{received:typeof e,...r}})}(i.stroke,t,0,r),i.casing&&function(e,t,n,r){"object"==typeof e&&null!==e?("enabled"in e&&"boolean"!=typeof e.enabled&&t.push({field:"style.casing.enabled",message:"enabled doit \xeatre un bool\xe9en",context:{received:typeof e.enabled,...r}}),e.color&&!o(e.color)&&t.push({field:"style.casing.color",message:"Couleur invalide, format attendu: #RRGGBB",context:{received:e.color,...r}})):t.push({field:"style.casing",message:"casing doit \xeatre un objet",context:{received:typeof e,...r}})}(i.casing,t,0,r),i.fillPattern&&function(e,t,n,r){"object"==typeof e&&null!==e?("enabled"in e&&"boolean"!=typeof e.enabled&&t.push({field:"style.fillPattern.enabled",message:"enabled doit \xeatre un bool\xe9en",context:{received:typeof e.enabled,...r}}),e.type&&!["diagonal","horizontal","vertical","cross","x"].includes(e.type)&&t.push({field:"style.fillPattern.type",message:"type doit \xeatre parmi: diagonal, horizontal, vertical, cross, x",context:{received:e.type,allowed:["diagonal","horizontal","vertical","cross","x"],...r}}),e.color&&!o(e.color)&&t.push({field:"style.fillPattern.color",message:"Couleur invalide, format attendu: #RRGGBB",context:{received:e.color,...r}}),["weight","density"].forEach(o=>{o in e&&("number"!=typeof e[o]||e[o]<0)&&t.push({field:`style.fillPattern.${o}`,message:`${o} doit \xeatre un nombre >= 0`,context:{received:e[o],...r}})})):t.push({field:"style.fillPattern",message:"fillPattern doit \xeatre un objet",context:{received:typeof e,...r}})}(i.fillPattern,t,0,r)):t.push({field:"style",message:"Le style doit \xeatre un objet",context:{received:typeof i,...r}}))}(e,r,0,n),e.styleRules&&function(e,t,o,n){GeoLeaf._StyleValidatorRules.validateStyleRules(e,t,o,n)}(e.styleRules,r,i,n),function(e,t,o,n){GeoLeaf._StyleValidatorRules.validateScales(e,t,o,n)}(e,r,i,n),e.legend&&function(e,t,o,n){GeoLeaf._StyleValidatorRules.validateLegend(e,t,o,n)}(e.legend,r,i,n)}catch(e){r.push({field:"validation",message:`Erreur inattendue lors de la validation: ${e.message}`,stack:e.stack,context:n})}return{valid:0===r.length,errors:r,warnings:i}},formatValidationErrors:function(e,t=""){if(e.valid)return null;const o=[];return o.push("\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550"),o.push("\u274c ERREUR DE VALIDATION DE STYLE GEOLEAF"),o.push("\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550"),t&&(o.push(`Fichier: ${t}`),o.push("")),e.errors.length>0&&(o.push(`\u274c ${e.errors.length} erreur(s) d\xe9tect\xe9e(s):`),o.push(""),e.errors.forEach((e,t)=>{o.push(`  ${t+1}. Champ: ${e.field}`),o.push(`     Message: ${e.message}`),e.context&&o.push(`     Contexte: ${JSON.stringify(e.context,null,2).split("\n").join("\n     ")}`),e.stack&&o.push(`     Stack: ${e.stack.split("\n").slice(0,3).join("\n     ")}`),o.push("")})),e.warnings.length>0&&(o.push(`\u26a0\ufe0f  ${e.warnings.length} avertissement(s):`),o.push(""),e.warnings.forEach((e,t)=>{o.push(`  ${t+1}. Champ: ${e.field}`),o.push(`     Message: ${e.message}`),e.context&&o.push(`     Contexte: ${JSON.stringify(e.context,null,2).split("\n").join("\n     ")}`),o.push("")})),o.push("\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550"),o.push("\u{1f4a1} Conseil: V\xe9rifiez la documentation dans docs/STYLE_FORMAT_SPEC.md"),o.push("\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550"),o.join("\n")},StyleValidationError};GeoLeaf._StyleValidator=n}(window)),p||(p=1,function(e){let t=null;const o="undefined"!=typeof globalThis?globalThis:window;o.GeoLeaf=o.GeoLeaf||{},o.GeoLeaf.Core=o.GeoLeaf.Core||{};const n=o.GeoLeaf.Log,r=function(){let r=null,i="light";function a(o={}){const i="[GeoLeaf.Core]";try{if("undefined"==typeof L)throw new Error("Leaflet (L) est introuvable. Assurez-vous d\u2019avoir charg\xe9 Leaflet 1.9.x.");if(!o.mapId)throw new Error("L\u2019option obligatoire 'mapId' est manquante.");const a=document.getElementById(o.mapId);if(!a)throw new Error(`Aucun \xe9l\xe9ment DOM trouv\xe9 pour mapId='${o.mapId}'.`);const l=Array.isArray(o.center)?o.center:GeoLeaf.CONSTANTS.DEFAULT_CENTER,s=Number.isFinite(o.zoom)?o.zoom:GeoLeaf.CONSTANTS.DEFAULT_ZOOM,c=o.theme||"light";if(t)return n.warn(`${i} Carte d\xe9j\xe0 initialis\xe9e. Recyclage de l\u2019instance existante.`),t;const u=Object.assign({},o.mapOptions||{},{center:l,zoom:s});void 0===u.zoomControl&&(u.zoomControl=1),void 0===u.attributionControl&&(u.attributionControl=0),void 0===u.zoomSnap&&(u.zoomSnap=0),void 0===u.zoomDelta&&(u.zoomDelta=.25),void 0===u.wheelPxPerZoomLevel&&(u.wheelPxPerZoomLevel=120),t=L.map(a,u),r=t;try{e.GeoLeaf&&e.GeoLeaf.UI&&"function"==typeof e.GeoLeaf.UI.applyTheme&&e.GeoLeaf.UI.applyTheme(c)}catch(e){n.warn(`${i} Impossible d'appliquer le th\xe8me :`,e)}const d=e.GeoLeaf.Config&&e.GeoLeaf.Config.get?e.GeoLeaf.Config.get("ui"):null;if((!d||0!=d.showLegend)&&e.GeoLeaf&&e.GeoLeaf.Legend&&"function"==typeof e.GeoLeaf.Legend.init)try{e.GeoLeaf.Legend.init(t,{position:"bottomleft",collapsible:1,collapsed:0})}catch(e){n.warn(`${i} Impossible d'initialiser Legend :`,e)}return n.info(`${i} Carte initialis\xe9e avec succ\xe8s.`),t}catch(o){if(n.error(`${i} ERREUR :`,o.message),"function"==typeof e.GeoLeaf?.Core?.onError)try{e.GeoLeaf.Core.onError(o)}catch(e){n.error(`${i} Erreur dans Core.onError() :`,e)}return t=null,r=null,null}}return{init:a,initMap:function(e,t,r,i){n.warn("[GeoLeaf.Core] GeoLeaf.Core.initMap() est obsol\xe8te, utilisez GeoLeaf.Core.init().");let l=null;if(o.GeoLeaf&&o.GeoLeaf.Config&&"function"==typeof o.GeoLeaf.Config.get)try{const e=o.GeoLeaf.Config.get("map")||{},t=o.GeoLeaf.Config.get("ui")||{};return l={target:e.target||"geoleaf-map",center:e.center||GeoLeaf.CONSTANTS.DEFAULT_CENTER,zoom:"number"==typeof e.zoom?e.zoom:GeoLeaf.CONSTANTS.DEFAULT_ZOOM,theme:t.theme||"light",mapOptions:e.mapOptions||{}},a(l)}catch(e){n.error("[GeoLeaf.Core] initMap() n\u2019a pas pu construire les options \xe0 partir de GeoLeaf.Config :",e)}return e&&"object"==typeof e&&!Array.isArray(e)?a(e):"string"==typeof e&&Array.isArray(t)&&"number"==typeof r?a({center:t,zoom:r,theme:i||"light"}):(n.error("[GeoLeaf.Core] initMap() appel\xe9 avec une signature obsol\xe8te ou invalide. Utilisez GeoLeaf.Core.init({ target, center, zoom, theme })."),null)},getMap:function(){return r},setTheme:function(e){!e||"light"!==e&&"dark"!==e?n.warn("[GeoLeaf.Core] setTheme() : th\xe8me invalide \u2192",e):(i=e,function(e){const t=document.body;t?(t.classList.remove("gl-theme-light","gl-theme-dark"),t.classList.add("dark"===e?"gl-theme-dark":"gl-theme-light")):n.warn("[GeoLeaf.Core] Impossible d\u2019appliquer le th\xe8me : document.body introuvable.")}(e))},getTheme:function(){return i}}}();o.GeoLeaf.Core=r}(window)),g||(g=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log;GeoLeaf._UITheme=GeoLeaf._UITheme||{};const o="geoleaf_theme",n="light",r="dark";let i=null;function a(){return i||(document.body.classList.contains("gl-theme-dark")?(i=r,r):document.body.classList.contains("gl-theme-light")?(i=n,n):(i=r,r))}function l(a){const l=a===n||a===r?a:r;t.debug("[UI.Theme] applyTheme:",a,"\u2192",l),i=l,document.body.classList.remove("gl-theme-light","gl-theme-dark"),document.body.classList.add(l===r?"gl-theme-dark":"gl-theme-light");const s=document.getElementById("geoleaf-map");s&&(s.classList.remove("gl-theme-light","gl-theme-dark"),s.classList.add(l===r?"gl-theme-dark":"gl-theme-light"));try{const t=GeoLeaf.StorageHelper,n=GeoLeaf.Validators?.Theme;t&&n?t.setItem(o,l,n):e.localStorage.setItem(o,l)}catch(e){t&&t.warn("[UI.Theme] localStorage non disponible, th\xe8me non persist\xe9.")}c(l),e.dispatchEvent&&e.dispatchEvent(new CustomEvent("geoleaf:ui-theme-changed",{detail:{theme:l}}))}function s(){const e=a(),o=e===r?n:r;t.debug("[UI.Theme] toggleTheme:",e,"\u2192",o),l(o)}function c(e){const t=document.querySelector('[data-gl-role="theme-toggle"]');if(!t)return;const o=e===r;t.setAttribute("data-gl-theme-state",o?"dark":"light"),t.setAttribute("aria-pressed",String(o)),t.setAttribute("aria-label",o?"Basculer en th\xe8me clair":"Basculer en th\xe8me sombre"),t.title=o?"Th\xe8me clair":"Th\xe8me sombre"}GeoLeaf._UITheme={initThemeToggle:function(i={}){const u={buttonSelector:i.buttonSelector||'[data-gl-role="theme-toggle"]',autoInitOnDomReady:"boolean"==typeof i.autoInitOnDomReady?i.autoInitOnDomReady:0},d=()=>{const i=function(){let t=null;try{const n=GeoLeaf.StorageHelper,r=GeoLeaf.Validators?.Theme;t=n&&r?n.getItem(o,null,r):e.localStorage.getItem(o)}catch(e){t=null}if(t===n||t===r)return t;const i=a();return i===n||i===r?i:r}();t.debug("[UI.Theme] initThemeToggle:",i),l(i);const d=document.querySelector(u.buttonSelector);if(d){if(t.debug("[UI.Theme] Bouton de th\xe8me trouv\xe9"),"button"===(d.tagName||"").toLowerCase())try{d.type=d.type||"button"}catch(e){}else d.setAttribute("role","button"),d.setAttribute("tabindex","0");c(i),d.addEventListener("click",e=>{e.preventDefault(),s()}),d.addEventListener("keydown",e=>{"Enter"!==e.key&&" "!==e.key&&"Spacebar"!==e.key||(e.preventDefault(),s())})}else t.warn("[UI.Theme] Bouton de th\xe8me introuvable:",u.buttonSelector)};u.autoInitOnDomReady&&"loading"===document.readyState?document.addEventListener("DOMContentLoaded",d,{once:1}):d()},toggleTheme:s,applyTheme:l,getCurrentTheme:a,THEME_LIGHT:n,THEME_DARK:r}}("undefined"!=typeof window?window:gt)),y||(y=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log,o=GeoLeaf.Utils;GeoLeaf._UIControls=GeoLeaf._UIControls||{},GeoLeaf._UIControls={initFullscreenControl:function(e,n){e&&n?"undefined"!=typeof L&&L.Control?(L.Control.Fullscreen=L.Control.extend({options:{position:"topleft"},onAdd:function(e){const r=L.DomUtil.create("div","leaflet-control-fullscreen leaflet-bar leaflet-control"),i=L.DomUtil.create("a","",r);i.href="#",i.title="Plein \xe9cran",i.setAttribute("role","button"),i.setAttribute("aria-label","Activer le mode plein \xe9cran");const a=GeoLeaf.DOMSecurity.createSVGIcon(18,18,"M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3",{stroke:"currentColor",strokeWidth:"2",fill:"none"});a.classList.add("fullscreen-enter-icon");const l=GeoLeaf.DOMSecurity.createSVGIcon(18,18,"M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3",{stroke:"currentColor",strokeWidth:"2",fill:"none"});l.classList.add("fullscreen-exit-icon"),l.style.display="none",i.appendChild(a),i.appendChild(l),L.DomEvent.disableClickPropagation(r),L.DomEvent.disableScrollPropagation(r);const s=o?.debounce?o.debounce(()=>e.invalidateSize(),200):()=>e.invalidateSize(),c=e=>{e?(a.style.display="none",l.style.display="block"):(a.style.display="block",l.style.display="none")},u=e=>{L.DomEvent.preventDefault(e),document.fullscreenElement?document.exitFullscreen().then(()=>{i.classList.remove("is-fullscreen"),i.title="Plein \xe9cran",i.setAttribute("aria-label","Activer le mode plein \xe9cran"),c(0),s()}).catch(e=>{t&&t.error("[UI.Controls] Erreur sortie plein \xe9cran:",e)}):n.requestFullscreen().then(()=>{i.classList.add("is-fullscreen"),i.title="Quitter le plein \xe9cran",i.setAttribute("aria-label","Quitter le mode plein \xe9cran"),c(1),s()}).catch(e=>{t&&t.error("[UI.Controls] Erreur plein \xe9cran:",e)})},d=()=>{document.fullscreenElement||(i.classList.remove("is-fullscreen"),i.title="Plein \xe9cran",i.setAttribute("aria-label","Activer le mode plein \xe9cran"),c(0),s())};return L.DomEvent.on(i,"click",u),L.DomEvent.on(i,"keydown",e=>{"Enter"!==e.key&&" "!==e.key&&"Spacebar"!==e.key||u(e)}),document.addEventListener("fullscreenchange",d),this._fullscreenChangeHandler=d,this._toggleFullscreen=u,this._link=i,this._mapContainer=n,this._debouncedInvalidateSize=s,r},onRemove:function(){this._fullscreenChangeHandler&&(document.removeEventListener("fullscreenchange",this._fullscreenChangeHandler),this._fullscreenChangeHandler=null),this._link&&(L.DomEvent.off(this._link,"click",this._toggleFullscreen),L.DomEvent.off(this._link,"keydown"),this._link=null),this._toggleFullscreen=null,this._mapContainer=null,this._debouncedInvalidateSize=null}}),(new L.Control.Fullscreen).addTo(e),t&&t.info("[UI.Controls] Contr\xf4le plein \xe9cran ajout\xe9 \xe0 la carte")):t&&t.warn("[UI.Controls] Leaflet n'est pas disponible"):t&&t.warn("[UI.Controls] initFullscreenControl: carte ou conteneur manquant")},initGeolocationControl:function(e,o){if(!e)return void(t&&t.warn("[UI.Controls] initGeolocationControl: carte manquante"));if(!o?.ui?.enableGeolocation)return void(t&&t.info("[UI.Controls] G\xe9olocalisation d\xe9sactiv\xe9e dans la configuration"));if("undefined"==typeof L||!L.Control)return void(t&&t.warn("[UI.Controls] Leaflet n'est pas disponible"));if(!navigator.geolocation)return void(t&&t.warn("[UI.Controls] La g\xe9olocalisation n'est pas support\xe9e par ce navigateur"));let n=null,r=null;L.Control.Geolocation=L.Control.extend({options:{position:"topleft"},onAdd:function(e){const o=L.DomUtil.create("div","leaflet-control-geolocation leaflet-bar leaflet-control"),i=L.DomUtil.create("a","",o);i.href="#",i.title="G\xe9olocalisation ON/OFF",i.setAttribute("role","button"),i.setAttribute("aria-label","Activer/D\xe9sactiver le suivi GPS");const a=GeoLeaf.DOMSecurity.createSVGIcon(18,18,"M12 2 C 6.5 2 2 6.5 2 12 C 2 17.5 6.5 22 12 22 C 17.5 22 22 17.5 22 12 C 22 6.5 17.5 2 12 2 M12 9 C 10.3 9 9 10.3 9 12 C 9 13.7 10.3 15 12 15 C 13.7 15 15 13.7 15 12 C 15 10.3 13.7 9 12 9",{stroke:"currentColor",strokeWidth:"2",fill:"none"});i.appendChild(a),L.DomEvent.disableClickPropagation(o),L.DomEvent.disableScrollPropagation(o);const l=o=>{if(L.DomEvent.preventDefault(o),window.GeoLeaf.UI._geolocationActive)return null!==window.GeoLeaf.UI._geolocationWatchId&&(navigator.geolocation.clearWatch(window.GeoLeaf.UI._geolocationWatchId),window.GeoLeaf.UI._geolocationWatchId=null),n&&(e.removeLayer(n),n=null),r&&(e.removeLayer(r),r=null),window.GeoLeaf.UI._geolocationActive=0,window.GeoLeaf.UI._userPosition=null,i.classList.remove("is-active"),i.classList.remove("is-locating"),void(t&&t.info("[UI.Controls] G\xe9olocalisation d\xe9sactiv\xe9e"));i.classList.add("is-locating"),window.GeoLeaf.UI._geolocationWatchId=navigator.geolocation.watchPosition(o=>{const{latitude:a,longitude:l,accuracy:s}=o.coords;if(window.GeoLeaf.UI._geolocationActive||e.setView([a,l],16,{animate:1,duration:.5}),n&&e.removeLayer(n),r&&e.removeLayer(r),n=L.marker([a,l],{icon:L.divIcon({className:"gl-user-location-marker gl-user-location-marker--active",html:'<div class="gl-user-location-dot gl-user-location-dot--active"></div>',iconSize:[22,22],iconAnchor:[11,11]}),zIndexOffset:1e3}).addTo(e),s&&s<1e3){const t=GeoLeaf.Config.get("ui.interactiveShapes",0);r=L.circle([a,l],{radius:s,className:"gl-user-location-accuracy",fillColor:"#4285F4",fillOpacity:.1,stroke:1,color:"#4285F4",opacity:.3,weight:1,interactive:t}).addTo(e)}window.GeoLeaf.UI._geolocationActive=1,i.classList.remove("is-locating"),i.classList.add("is-active"),window.GeoLeaf&&window.GeoLeaf.UI&&(window.GeoLeaf.UI._userPosition={lat:a,lng:l,accuracy:s,timestamp:Date.now()}),t&&t.debug("[UI.Controls] Position GPS mise \xe0 jour:",a,l)},e=>{i.classList.remove("is-locating"),i.classList.remove("is-active"),window.GeoLeaf.UI._geolocationActive=0;let o="Impossible d'obtenir votre position";switch(e.code){case e.PERMISSION_DENIED:o="Permission de g\xe9olocalisation refus\xe9e";break;case e.POSITION_UNAVAILABLE:o="Position indisponible";break;case e.TIMEOUT:o="D\xe9lai de g\xe9olocalisation d\xe9pass\xe9"}t&&t.error("[UI.Controls] Erreur de g\xe9olocalisation:",e),window.alert&&alert(o)},{enableHighAccuracy:1,timeout:1e4,maximumAge:0})};return L.DomEvent.on(i,"click",l),L.DomEvent.on(i,"keydown",e=>{"Enter"!==e.key&&" "!==e.key&&"Spacebar"!==e.key||l(e)}),this._link=i,this._userMarker=n,o},onRemove:function(e){this._link&&(L.DomEvent.off(this._link,"click"),L.DomEvent.off(this._link,"keydown"),this._link=null),this._userMarker&&(e.removeLayer(this._userMarker),this._userMarker=null)}}),(new L.Control.Geolocation).addTo(e),t&&t.info("[UI.Controls] Contr\xf4le de g\xe9olocalisation ajout\xe9 \xe0 la carte")},initPoiAddControl:function(e,o){e?o?.ui?.showAddPoi?"undefined"!=typeof L&&L.Control?GeoLeaf?.POI?.AddForm&&GeoLeaf?.POI?.PlacementMode?(L.Control.PoiAdd=L.Control.extend({options:{position:"topleft"},onAdd:function(e){const n=L.DomUtil.create("div","leaflet-control-poi-add leaflet-bar leaflet-control"),r=L.DomUtil.create("a","",n);r.href="#",r.title="Ajouter un POI",r.setAttribute("role","button"),r.setAttribute("aria-label","Ajouter un nouveau point d'int\xe9r\xeat");const i=GeoLeaf.DOMSecurity.createSVGIcon(18,18,"M12 2 C 6.5 2 2 6.5 2 12 C 2 17.5 6.5 22 12 22 C 17.5 22 22 17.5 22 12 C 22 6.5 17.5 2 12 2 M12 8 L12 16 M8 12 L16 12",{stroke:"currentColor",strokeWidth:"2",fill:"none"});r.appendChild(i),L.DomEvent.disableClickPropagation(n),L.DomEvent.disableScrollPropagation(n);const a=n=>{L.DomEvent.preventDefault(n),r.classList.add("disabled");const i=e=>{r.classList.remove("disabled"),GeoLeaf.POI.AddForm.openAddForm?GeoLeaf.POI.AddForm.openAddForm(e,null):t&&t.error("[UI.Controls] AddForm.openAddForm non disponible")},a=GeoLeaf?.UI?._userPosition;a&&"geolocation"===(o?.poiAddConfig?.defaultPosition||"placement-mode")?(t&&t.debug("[UI.Controls] Utilisation de la position GPS pour l'ajout de POI"),i(a)):(t&&t.debug("[UI.Controls] Activation du mode placement pour l'ajout de POI"),GeoLeaf.POI.PlacementMode.activate(e,e=>{e?.latlng?i(e.latlng):(r.classList.remove("disabled"),t&&t.warn("[UI.Controls] Mode placement cancelled"))}))};return L.DomEvent.on(r,"click",a),L.DomEvent.on(r,"keydown",e=>{"Enter"!==e.key&&" "!==e.key&&"Spacebar"!==e.key||a(e)}),this._link=r,n},onRemove:function(){this._link&&(L.DomEvent.off(this._link,"click"),L.DomEvent.off(this._link,"keydown"),this._link=null)}}),(new L.Control.PoiAdd).addTo(e),t&&t.info("[UI.Controls] Contr\xf4le POI Add ajout\xe9 \xe0 la carte")):t&&t.warn("[UI.Controls] Modules POI non charg\xe9s"):t&&t.warn("[UI.Controls] Leaflet n'est pas disponible"):t&&t.debug("[UI.Controls] Bouton POI Add d\xe9sactiv\xe9 dans la configuration"):t&&t.warn("[UI.Controls] initPoiAddControl: carte manquante")}}}("undefined"!=typeof window?window:gt)),h||(h=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{};GeoLeaf.UI=GeoLeaf.UI||{},GeoLeaf.UI.PanelBuilder=GeoLeaf.UI.PanelBuilder||{};const t=(e,t,...o)=>GeoLeaf.Utils&&GeoLeaf.Utils.createElement?GeoLeaf.Utils.createElement(e,t,...o):document.createElement(e);function o(e,t){if(!e||!t)return;const o=t.split(".");let n=e;for(let e=0;e<o.length;e+=1){if(null==n)return;n=n[o[e]]}return n}function n(e,o){return t("div",{className:"gl-poi-panel__text"+("multiline"===o?" gl-poi-panel__text--multiline":""),textContent:String(e)})}function r(e){const o=[];if(Array.isArray(e)?e.forEach(function(e){if(null!=e)if("string"==typeof e||"number"==typeof e)o.push(String(e));else if("object"==typeof e){const t="string"==typeof e.label?e.label:"string"==typeof e.text?e.text:null,n=null!=e.value?String(e.value):null;t&&n?o.push(t+" : "+n):t?o.push(t):n&&o.push(n)}}):"string"==typeof e&&e.split(/\r?\n/).forEach(function(e){const t=e.trim();t&&o.push(t)}),!o.length)return null;const n=t("ul",{className:"gl-poi-panel__list"});return o.forEach(function(e){const o=t("li",{className:"gl-poi-panel__list-item",textContent:e});n.appendChild(o)}),n}function i(e,o){if(!Array.isArray(e)||!e.length)return null;const n=Array.isArray(o.columns)?o.columns:[];if(!n.length)return null;const r=t("div",{className:"gl-poi-panel__table-wrapper"}),i=o.borders||{},a=[];i.outer&&a.push("gl-poi-panel__table--border-outer"),i.row&&a.push("gl-poi-panel__table--border-row"),i.column&&a.push("gl-poi-panel__table--border-column");const l=t("table",{className:"gl-poi-panel__table"+(a.length?" "+a.join(" "):""),attributes:i.color?{"data-gl-border-color":i.color}:{}}),s=t("thead"),c=t("tr",{className:"gl-poi-panel__table-row gl-poi-panel__table-row--head"});n.forEach(function(e){const o=t("th",{className:"gl-poi-panel__table-cell gl-poi-panel__table-cell--head",textContent:e.label||e.key||""});c.appendChild(o)}),s.appendChild(c),l.appendChild(s);const u=t("tbody");return e.forEach(function(e){if(!e||"object"!=typeof e)return;const o=t("tr",{className:"gl-poi-panel__table-row"});n.forEach(function(n){const r=e[n.key],i=t("td",{className:"gl-poi-panel__table-cell",textContent:null==r?"":String(r)});o.appendChild(i)}),u.appendChild(o)}),l.appendChild(u),r.appendChild(l),r}function a(e){if(!Array.isArray(e))return null;const o=t("div",{className:"gl-poi-panel__gallery"});return e.forEach(function(e){if(!e)return;const n=t("figure",{className:"gl-poi-panel__gallery-item"}),r=t("img",{src:e.url||e,alt:e.alt||""});if(n.appendChild(r),e.caption){const o=t("figcaption",{textContent:e.caption});n.appendChild(o)}o.appendChild(n)}),o}function l(e){let o=e;if(e&&"object"==typeof e&&!Array.isArray(e)&&Array.isArray(e.recent)&&(o=e.recent),!Array.isArray(o))return null;const n=t("div",{className:"gl-poi-panel__reviews gl-poi-sidepanel__reviews"});return o.forEach(function(e){if(!e)return;const o=t("article",{className:"gl-poi-panel__review"}),r=t("header",{className:"gl-poi-panel__review-header"}),i=t("span",{className:"gl-poi-panel__review-author",textContent:e.authorName||""});if(r.appendChild(i),"number"==typeof e.rating){const o=t("span",{className:"gl-poi-panel__review-rating",textContent:e.rating.toFixed(1)+"/5"});r.appendChild(o)}if(e.source){const o=t("span",{className:"gl-poi-panel__review-source",textContent:e.source});r.appendChild(o)}if(o.appendChild(r),e.title){const n=t("h4",{className:"gl-poi-panel__review-title",textContent:e.title});o.appendChild(n)}const a=e.text||e.comment;if(a){const e=t("p",{className:"gl-poi-panel__review-text",textContent:a});o.appendChild(e)}const l=e.date||e.createdAt;if(l){const e=t("time",{className:"gl-poi-panel__review-date",textContent:l});o.appendChild(e)}const s=t("footer",{className:"gl-poi-panel__review-footer"});if("number"==typeof e.helpfulCount){const o=t("span",{className:"gl-poi-panel__review-helpful",textContent:e.helpfulCount+" personnes ont trouv\xe9 cet avis utile"});s.appendChild(o)}if(e.url){const o=t("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",className:"gl-poi-panel__review-link",textContent:"Voir l'avis"});s.appendChild(o)}o.appendChild(s),n.appendChild(o)}),n}GeoLeaf.UI.PanelBuilder={resolveField:o,createPlainSection:function(e,o,n){const r=t("section",{className:"gl-poi-panel__section"+(n?" "+n:"")});if(e){const o=t("h3",{className:"gl-poi-panel__section-title",textContent:e});r.appendChild(o)}const i=t("div",{className:"gl-poi-panel__section-body"});return o instanceof Node?i.appendChild(o):null!=o&&(i.textContent=String(o)),r.appendChild(i),r},createAccordionSection:function(e,o,n){const r=Boolean((n||{}).defaultOpen),i=t("section",{className:"gl-accordion gl-poi-panel__section"+(r?" is-open":"")}),a=t("button",{type:"button",className:"gl-accordion__header"}),l=t("span",{className:"gl-accordion__title",textContent:e||""});a.appendChild(l);const s=t("span",{className:"gl-accordion__icon",attributes:{"aria-hidden":"true"},textContent:"\u25be"});a.appendChild(s),i.appendChild(a);const c=t("div",{className:"gl-accordion__body"});if(o instanceof Node)c.appendChild(o);else if(null!=o){const e=t("p",{textContent:String(o)});c.appendChild(e)}return i.appendChild(c),i},renderText:n,renderList:r,renderTable:i,renderGallery:a,renderReviews:l,buildLayoutItemContent:function(e,s){const c=s.type,u=o(e,s.field);return null!=u&&""!==u||Array.isArray(u)?"text"===c?n(u,s.variant):"list"===c?r(u):"table"===c?i(u,s):"gallery"===c?a(u):"reviews"===c?l(u):t("div",{className:"gl-poi-panel__text",textContent:String(u)}):null}}}("undefined"!=typeof window?window:gt)),m||(m=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{};GeoLeaf._UIDomUtils=GeoLeaf._UIDomUtils||{};const t=(e,t,...o)=>GeoLeaf.Utils&&GeoLeaf.Utils.createElement?GeoLeaf.Utils.createElement(e,t,...o):document.createElement(e),o=GeoLeaf.Log||console;GeoLeaf._UIDomUtils.resolveField=function(e,t){if(!e||!t)return;const o=t.split(".");let n=e;for(let e=0;e<o.length;e+=1){if(null==n)return;n=n[o[e]]}return n},GeoLeaf._UIDomUtils.attachAccordionBehavior=function(e){e&&!e._glAccordionBound&&(e._glAccordionBound=1,e.addEventListener("click",function(t){const o=t.target.closest(".gl-accordion__header");if(!o||!e.contains(o))return;const n=o.closest(".gl-accordion");n&&n.classList.toggle("is-open")}))},GeoLeaf._UIDomUtils.getActiveProfileConfig=function(){if(!GeoLeaf.Config||"function"!=typeof GeoLeaf.Config.getActiveProfile)return o.warn("[UIDomUtils] GeoLeaf.Config.getActiveProfile() indisponible. Impossible de r\xe9cup\xe9rer le profil actif."),null;const e=GeoLeaf.Config.getActiveProfile();return e||o.warn("[UIDomUtils] Aucun profil actif retourn\xe9 par GeoLeaf.Config.getActiveProfile()."),e||null},GeoLeaf._UIDomUtils.populateSelectOptionsFromTaxonomy=function(e,o,n){if(!e||!o||!o.taxonomy)return;const r=o.taxonomy,i=t("option",{value:"",textContent:"\u2014 Tous \u2014"});if(e.appendChild(i),"taxonomy.categories"===n){const o=r.categories||{};return void Object.keys(o).forEach(function(n){const r=o[n],i=t("option",{value:n,textContent:r.label||n});e.appendChild(i)})}if("taxonomy.categories[*].subcategories"===n){const o=r.categories||{};Object.keys(o).forEach(function(n){const r=o[n],i=r&&r.subcategories||{};Object.keys(i).forEach(function(o){const a=i[o],l=r.label||n,s=a.label||o,c=t("option",{value:o,textContent:l+" \u2013 "+s,attributes:{"data-category-id":n}});e.appendChild(c)})})}},o.info("[GeoLeaf._UIDomUtils] Module DOM Utilities charg\xe9")}(window)),b||(b=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{};GeoLeaf.UI=GeoLeaf.UI||{};const t=GeoLeaf.Log,o="[GeoLeaf.UI.CoordinatesDisplay]",n="Lat: --, Lng: --",r={_map:null,_control:null,_coordsElement:null,_boundMouseMoveHandler:null,_options:{position:"bottomleft",decimals:6},init(e,n={}){try{if(!e)throw new Error("Une instance de carte Leaflet est requise.");this._map=e,this._options=Object.assign({},this._options,n);const r=GeoLeaf.Config?.get("ui.showCoordinates");if(0==r)return void t.info(`${o} Affichage des coordonn\xe9es d\xe9sactiv\xe9 dans la configuration.`);this._boundMouseMoveHandler=this._onMouseMove.bind(this),this._createControl(),t.info(`${o} Module initialis\xe9 avec succ\xe8s.`)}catch(e){t.error(`${o} Erreur lors de l'initialisation :`,e.message)}},_createControl(){try{setTimeout(()=>{const e=document.querySelector(".gl-scale-main-wrapper");e?(L.DomUtil.create("div","gl-scale-separator",e),this._coordsElement=L.DomUtil.create("div","gl-scale-coordinates",e),this._coordsElement.textContent=n,this._map.on("mousemove",this._boundMouseMoveHandler),t.info(`${o} Coordonn\xe9es int\xe9gr\xe9es au wrapper d'\xe9chelle.`)):(t.warn(`${o} Wrapper d'\xe9chelle non trouv\xe9, utilisation du mode classique.`),this._createStandaloneControl())},100)}catch(e){t.error(`${o} Erreur lors de la cr\xe9ation du contr\xf4le :`,e.message)}},_createStandaloneControl(){const e=L.Control.extend({options:{position:this._options.position},onAdd:e=>{const t=L.DomUtil.create("div","geoleaf-coordinates-display");return L.DomEvent.disableClickPropagation(t),L.DomEvent.disableScrollPropagation(t),this._coordsElement=L.DomUtil.create("div","coordinates-content",t),this._coordsElement.textContent=n,e.on("mousemove",this._boundMouseMoveHandler),t},onRemove:e=>{e.off("mousemove",this._boundMouseMoveHandler)}});this._control=new e,this._control.addTo(this._map)},_onMouseMove(e){if(!this._coordsElement)return;const t=e.latlng.lat.toFixed(this._options.decimals),o=e.latlng.lng.toFixed(this._options.decimals);this._coordsElement.textContent=`Lat: ${t}, Lng: ${o}`},destroy(){try{this._map&&this._boundMouseMoveHandler&&(this._map.off("mousemove",this._boundMouseMoveHandler),this._boundMouseMoveHandler=null),this._coordsElement&&this._coordsElement.parentNode&&(this._coordsElement.parentNode.removeChild(this._coordsElement),this._coordsElement=null),this._control&&this._map&&(this._map.removeControl(this._control),this._control=null),t.info(`${o} Module d\xe9truit avec succ\xe8s.`)}catch(e){t.error(`${o} Erreur lors de la destruction :`,e.message)}}};GeoLeaf.UI.CoordinatesDisplay=r}("undefined"!=typeof globalThis?globalThis:window)),_||(_=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{};GeoLeaf.UI=GeoLeaf.UI||{};const t=GeoLeaf.Log,o={_map:null,_control:null,_options:{position:"bottomleft",text:"Propuls\xe9 par \xa9 GeoLeaf with Leaflet"},init(e,o={}){const n="[GeoLeaf.UI.Branding]";try{if(!e)throw new Error("Une instance de carte Leaflet est requise.");this._map=e,this._options=Object.assign({},this._options,o);const r=GeoLeaf.Config?.get("brandingConfig");if(0==r||r&&0==r.enabled)return void t.info(`${n} Branding d\xe9sactiv\xe9 dans la configuration.`);r&&"object"==typeof r&&(r.text&&(this._options.text=r.text),r.position&&(this._options.position=r.position)),this._createControl(),t.info(`${n} Module initialis\xe9 avec succ\xe8s.`)}catch(e){t.error(`${n} Erreur lors de l'initialisation :`,e.message)}},_createControl(){const e="[GeoLeaf.UI.Branding]";try{const o=L.Control.extend({options:{position:this._options.position},onAdd:()=>{const e=L.DomUtil.create("div","geoleaf-branding");return L.DomEvent.disableClickPropagation(e),L.DomEvent.disableScrollPropagation(e),L.DomUtil.create("div","branding-content",e).textContent=this._options.text,e},onRemove:()=>{}});this._control=new o,this._control.addTo(this._map),t.info(`${e} Contr\xf4le de branding cr\xe9\xe9 et ajout\xe9 \xe0 la carte.`)}catch(o){t.error(`${e} Erreur lors de la cr\xe9ation du contr\xf4le :`,o.message)}},destroy(){const e="[GeoLeaf.UI.Branding]";try{this._control&&this._map&&(this._map.removeControl(this._control),this._control=null),t.info(`${e} Module d\xe9truit avec succ\xe8s.`)}catch(o){t.error(`${e} Erreur lors de la destruction :`,o.message)}},show(){this._control&&!this._map.hasControl(this._control)&&this._control.addTo(this._map)},hide(){this._control&&this._map&&this._map.removeControl(this._control)},setText(e){if(this._control){const t=this._control.getContainer();if(t){const o=t.querySelector(".branding-content");o&&(o.textContent=e)}}}};GeoLeaf.UI.Branding=o}("undefined"!=typeof globalThis?globalThis:window)),v||(v=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{};function t(){return GeoLeaf.Utils&&"function"==typeof GeoLeaf.Utils.resolveField?GeoLeaf.Utils.resolveField:function(e,...t){if(!e)return null;for(const o of t){if(!o)continue;const t=String(o).split(".");let n=e,r=1;for(const e of t){if(!n||"object"!=typeof n||!(e in n)){r=0;break}n=n[e]}if(r&&null!=n)return n}return null}}function o(){return GeoLeaf.Config&&"function"==typeof GeoLeaf.Config.getActiveProfile&&GeoLeaf.Config.getActiveProfile()||null}function n(){return GeoLeaf.Log||console}function r(e){if(null==e||""===e)return null;const t="number"==typeof e?e:parseFloat(e);return isNaN(t)?null:t}GeoLeaf._ContentBuilder||(GeoLeaf._ContentBuilder={}),GeoLeaf._ContentBuilder.Core={getResolveField:t,getEscapeHtml:function(){return GeoLeaf.Security&&"function"==typeof GeoLeaf.Security.escapeHtml?GeoLeaf.Security.escapeHtml:function(e){if(null==e)return"";const t=document.createElement("div");return t.textContent=String(e),t.innerHTML}},getActiveProfile:o,getLog:n,validateImageUrl:function(e){if(!e||"string"!=typeof e)return null;if(GeoLeaf.Security&&"function"==typeof GeoLeaf.Security.validateUrl)try{return GeoLeaf.Security.validateUrl(e)}catch(e){return n().warn("[ContentBuilder.Core] URL image invalide:",e.message),null}const t=e.trim();return/^https?:\/\//i.test(t)||/^data:image\//i.test(t)||t.startsWith("/")||t.startsWith("./")||t.startsWith("../")?t:null},validateCoordinates:function(e){if(null==e)return null;let t,o;if(Array.isArray(e)&&e.length>=2)t=parseFloat(e[0]),o=parseFloat(e[1]);else{if("object"!=typeof e||void 0===e.lat||void 0===e.lng)return null;t=parseFloat(e.lat),o=parseFloat(e.lng)}return isNaN(t)||isNaN(o)||t<-90||t>90||o<-180||o>180?null:{lat:t,lng:o}},validateNumber:r,validateRating:function(e){const t=r(e);return null===t||t<0||t>5?null:t},resolveBadge:function(e,n){const r=t()(e,n);if(null==r||""===r)return{displayValue:"",style:""};const i=o(),a=i?.taxonomy;let l=String(r),s="";if(!a||!n)return{displayValue:l,style:s};const c=e.attributes||{};if(n.includes("categoryId")&&!n.includes("subCategoryId")){const t=a.categories?.[r];if(t?.label&&(l=t.label),GeoLeaf.Helpers?.StyleResolver&&e._layerConfig){const t=GeoLeaf.Helpers.StyleResolver.getColorsFromLayerStyle(e,e._layerConfig.id);t&&(t.fillColor&&(s+="background-color: "+t.fillColor+";"),t.color&&(s+="border-color: "+t.color+";"))}}else if(n.includes("subCategoryId")){const t=c.categoryId||c.category,o=a.categories?.[t],n=o?.subcategories?.[r];if(n?.label&&(l=n.label),GeoLeaf.Helpers?.StyleResolver&&e._layerConfig){const t=GeoLeaf.Helpers.StyleResolver.getColorsFromLayerStyle(e,e._layerConfig.id);t&&(t.fillColor&&(s+="background-color: "+t.fillColor+";"),t.color&&(s+="border-color: "+t.color+";"))}}return{displayValue:l,style:s}},resolveBadgeTooltip:function(e,n){const r=t()(e,n);if(null==r||""===r)return"";const i=o(),a=i?.taxonomy;if(!a)return String(r);const l=e.attributes||{};if(n.includes("subCategoryId")){const e=l.categoryId||l.category,t=a.categories?.[e],o=t?.subcategories?.[r];if(o?.label)return o.label}else if(n.includes("categoryId")){const e=a.categories?.[r];if(e?.label)return e.label}return String(r)},formatNumber:function(e){return e.toLocaleString("fr-FR")},formatCoordinates:function(e,t,o=6){return e.toFixed(o)+", "+t.toFixed(o)},formatRating:function(e,t=1){return e.toFixed(t)+"/5"}},n().info("[GeoLeaf._ContentBuilder.Core] Module Core charg\xe9 - Helpers + Validators + Badge resolver")}("undefined"!=typeof window?window:gt)),C||(C=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{};GeoLeaf._ContentBuilder||(GeoLeaf._ContentBuilder={});const t={text:"gl-content__text",longtext:"gl-content__longtext",number:"gl-content__number",metric:"gl-content__metric",badge:"gl-poi-badge",rating:"gl-content__rating",image:"gl-content__image",link:"gl-content__link",list:"gl-content__list",table:"gl-content__table",tags:"gl-content__tags",tag:"gl-content__tag",coordinates:"gl-content__coordinates",gallery:"gl-content__gallery",badgeDefault:"gl-poi-badge--default",badgeStatus:"gl-poi-badge--status",badgePriority:"gl-poi-badge--priority",badgeCategory:"gl-poi-badge--category",star:"gl-star",starFull:"gl-star--full",starHalf:"gl-star--half",starEmpty:"gl-star--empty"};function o(e,t){const o=[e];return t&&o.push(t),' class="'+o.join(" ")+'"'}function n(e){return e?' style="'+e+'"':""}function r(e,t){return e?"<strong>"+t(e)+":</strong> ":""}function i(e,t,n){return"<p"+o(t,n)+">"+e+"</p>"}function a(e,t,n){return"<div"+o(t,n)+">"+e+"</div>"}function l(e){return'<span class="'+t.star+" "+t["star"+e.charAt(0).toUpperCase()+e.slice(1)]+'">\u2605</span>'}function s(e,o){return'<span class="'+t.tag+'">'+o(String(e))+"</span>"}GeoLeaf._ContentBuilder.Templates={CSS_CLASSES:t,buildClassAttr:o,buildStyleAttr:n,buildLabel:r,wrapInParagraph:i,wrapInDiv:a,createTextElement:function(e,o,n){return i(r(o.label,n)+n(e),t.text,o.className)},createLongtextElement:function(e,o,n){return a((o.label?"<p><strong>"+n(o.label)+"</strong></p>":"")+"<p>"+n(e)+"</p>",t.longtext,o.className)},createNumberElement:function(e,o,n){const a=e.toLocaleString("fr-FR"),l=r(o.label,n),s=o.suffix?" "+n(o.suffix):"";return i(l+(o.prefix?n(o.prefix)+" ":"")+a+s,t.number,o.className)},createMetricElement:function(e,o,n){const a=e.toLocaleString("fr-FR"),l=r(o.label,n),s=o.suffix?n(o.suffix):"";return i(l+(o.prefix?n(o.prefix):"")+a+s,t.metric,o.className)},createBadge:function(e,o,r,i){return'<span class="'+t.badge+" "+t["badge"+(o=o||"default").charAt(0).toUpperCase()+o.slice(1)]+'"'+n(r)+">"+i(e)+"</span>"},createStar:l,createRatingElement:function(e,o,n){let i="";const s=Math.floor(e),c=e%1>=.5;for(let e=0;e<s;e++)i+=l("full");c&&(i+=l("half"));const u=5-s-(c?1:0);for(let e=0;e<u;e++)i+=l("empty");const d=" ("+e.toFixed(1)+"/5)";return a(r(o.label,n)+i+d,t.rating,o.className)},createImageElement:function(e,n,r){const i=n.alt?r(n.alt):"";return"<img"+o(t.image,n.className)+' src="'+r(e)+'" alt="'+i+'">'},createLinkElement:function(e,o,n){const a=o.text?n(o.text):n(e);return i(r(o.label,n)+'<a href="'+n(e)+'" target="_blank" rel="noopener noreferrer">'+a+"</a>",t.link,o.className)},createListElement:function(e,o,n){const r=o.label?"<p><strong>"+n(o.label)+"</strong></p>":"";let i="<ul>";return e.forEach(e=>{i+="<li>"+n(String(e))+"</li>"}),i+="</ul>",a(r+i,t.list,o.className)},createTableElement:function(e,o,n){const r=o.label?"<p><strong>"+n(o.label)+"</strong></p>":"";let i="<table><tbody>";return Object.keys(e).forEach(t=>{const o=n(String(t)),r=n(String(e[t]));i+="<tr><th>"+o+"</th><td>"+r+"</td></tr>"}),i+="</tbody></table>",a(r+i,t.table,o.className)},createTag:s,createTagsElement:function(e,o,n){let r="";return e.forEach(e=>{r+=s(e,n)+" "}),a(r.trim(),t.tags,o.className)},createCoordinatesElement:function(e,o,n){return i("<strong>Coordonn\xe9es:</strong> "+e.toFixed(6)+", "+o.toFixed(6),t.coordinates,n.className)},createGalleryElement:function(e,o,n){let r="";return e.forEach(e=>{r+='<img src="'+n(e)+'" alt="Photo">'}),a(r,t.gallery,o.className)}};const c=GeoLeaf.Log||console;c.info("[GeoLeaf._ContentBuilder.Templates] Module Templates charg\xe9 - 14 builders disponibles"),GeoLeaf._ContentBuilder&&GeoLeaf._ContentBuilder.Templates?c.info("[GeoLeaf._ContentBuilder.Templates] Export confirm\xe9 - Templates.createMetricElement:",typeof GeoLeaf._ContentBuilder.Templates.createMetricElement):c.error("[GeoLeaf._ContentBuilder.Templates] ERREUR: Export \xe9chou\xe9!")}("undefined"!=typeof window?window:gt)),S||(S=1,function(e){e.GeoLeaf||(e.GeoLeaf={});const GeoLeaf=e.GeoLeaf;function t(){return GeoLeaf._ContentBuilder?.Helpers||{}}function o(){return GeoLeaf._ContentBuilder?.Core||null}function n(){const e=t();if(e.getResolveField)return e.getResolveField();const n=o();return n&&n.getResolveField?n.getResolveField():function(e,...t){for(const o of t){const t=o.split(".");let n=e;for(const e of t){if(null==n)return null;n=n[e]}if(null!=n)return n}return null}}function r(){const e=t();if(e.getEscapeHtml)return e.getEscapeHtml();const n=o();return n&&n.getEscapeHtml?n.getEscapeHtml():function(e){return null==e?"":String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}}function i(){const e=t();if(e.getLog)return e.getLog();const n=o();return n&&n.getLog?n.getLog():GeoLeaf.Utils?.Logger||console}function a(e,t,o={}){const n="undefined"!=typeof window&&window.__GEOLEAF_DEBUG_POPUP__||0,r=GeoLeaf._ContentBuilder||{};if(r&&r.renderItem)return r.renderItem(e,t,o);if(!t||!t.type)return n&&i().warn("[Assemblers renderItem DEBUG] No config or type"),"";const a=r["render"+t.type.charAt(0).toUpperCase()+t.type.slice(1)];if(!a)return n&&i().warn("[Assemblers renderItem DEBUG] No renderer found for type:",t.type),i().warn("[Assemblers] Type de rendu non support\xe9:",t.type),"";const l=a(e,t,o);return n&&i().warn(`[Assemblers renderItem DEBUG] Result from renderer ${t.type}: ${l?l.substring(0,100)+"...":"EMPTY"}`),l}e.GeoLeaf,e.GeoLeaf,GeoLeaf._ContentBuilder||(GeoLeaf._ContentBuilder={}),GeoLeaf._ContentBuilder.Assemblers={buildPopupHTML:function(e,o,n={}){const l=t(),s=r();if(!e)return i().warn("[Assemblers] POI invalide pour buildPopupHTML"),"";if(!o||!Array.isArray(o)||0===o.length){const t=l.getDefaultTitle?l.getDefaultTitle(e):e.title||e.label||e.name||"Sans titre";return l.debugLog?.("popup","No config provided, using default popup"),'<div class="gl-poi-popup"><div class="gl-poi-popup__body"><h3 class="gl-poi-popup__title"><span class="gl-poi-popup__title-text">'+s(t)+'</span></h3><a href="#" class="gl-poi-popup__link" data-poi-id="'+(e.id||"")+'">Voir plus >>></a></div></div>'}const c=l.sortConfigByOrder?l.sortConfigByOrder(o):[...o].sort((e,t)=>("number"==typeof e.order?e.order:999)-("number"==typeof t.order?t.order:999)),u={context:"popup",includeIcon:1,resolveCategoryDisplay:n.resolveCategoryDisplay};try{const t=function(e,t,o){const n=[];let r=[];return e.forEach((i,l)=>{const s="image"===i.type&&"hero"===i.variant,c="badge"===i.type,u=e[l+1],d=u&&"badge"===u.type,f=a(t,i,o);s?n.push({type:"hero",html:f}):c?(r.push(f),d||(n.push({type:"badges",items:[...r]}),r=[])):n.push({type:"content",html:f})}),n}(c,e,u),o=function(e,t){let o='<div class="gl-poi-popup">',n=0;return t.forEach(e=>{"hero"===e.type?(n&&(o+="</div>",n=0),o+=e.html):(n||(o+='<div class="gl-poi-popup__body">',n=1),"badges"===e.type?(o+='<div class="gl-poi-popup__badges">',e.items.forEach(e=>{o+=e}),o+="</div>"):o+=e.html)}),n||(o+='<div class="gl-poi-popup__body">',n=1),o+='<a href="#" class="gl-poi-popup__link" data-poi-id="'+(e.id||"")+'">Voir plus >>></a>',n&&(o+="</div>"),o+="</div>",o}(e,t);return o}catch(e){return'<div class="gl-poi-popup"><div class="gl-poi-popup__body">Erreur: '+s(e.message)+"</div></div>"}},buildTooltipHTML:function(e,a){if(!e)return i().warn("[Assemblers] POI invalide pour buildTooltipHTML"),"";const l=t(),s=r(),c=n();if(!a||!Array.isArray(a)||0===a.length){const t=l.getDefaultTitle?l.getDefaultTitle(e):e.title||e.label||e.name||c(e,"attributes.name","attributes.nom","properties.name","properties.nom")||"Sans titre";return s(String(t))}const u=l.sortConfigByOrder?l.sortConfigByOrder(a):[...a].sort((e,t)=>("number"==typeof e.order?e.order:999)-("number"==typeof t.order?t.order:999)),d=[];if(u.forEach(n=>{if(!n||!n.type||!n.field)return;const r=c(e,n.field);if(null!=r&&""!==r)if("text"===n.type||"badge"===n.type){let i=r;if("badge"===n.type&&l.resolveBadgeLabel)i=l.resolveBadgeLabel(e,n.field,r);else if("badge"===n.type){const a=function(){const e=t();if(e.getActiveProfile)return e.getActiveProfile();const n=o();return n&&n.getActiveProfile?n.getActiveProfile():GeoLeaf.Config?.getActiveProfile?.()||null}(),l=a?.taxonomy;if(l){const t=e.attributes||{};if(n.field.includes("subCategoryId")){const e=t.categoryId||t.category,o=l.categories?.[e],n=o?.subcategories?.[r];n?.label&&(i=n.label)}else if(n.field.includes("categoryId")){const e=l.categories?.[r];e?.label&&(i=e.label)}}}d.push(s(String(i)))}else if("number"===n.type){const e="number"==typeof r?r:parseFloat(r);isNaN(e)||d.push(e.toLocaleString("fr-FR"))}else if("image"===n.type)d.push('<img src="'+s(r)+'" alt="" style="max-width:150px;max-height:100px;display:block;margin:4px 0;" />');else if("link"===n.type){const e=n.label||r;d.push('<a href="'+s(r)+'" target="_blank">'+s(e)+"</a>")}}),0===d.length){const t=e.title||e.label||"Sans titre";return s(String(t))}let f="";return d.forEach((e,t)=>{if(f+=e,t<d.length-1){const e=u[t];e&&e.contentUnion?f+=" "+s(e.contentUnion)+" ":f+=" "}}),f},buildPanelItems:function(e,t,o={}){if(!e||!t||!Array.isArray(t))return[];const r=n(),i={context:"panel",...o},l=[...t].sort((e,t)=>("number"==typeof e.order?e.order:999)-("number"==typeof t.order?t.order:999)),s=[];return l.forEach(t=>{if(!t||!t.type)return;const o=r(e,t.field);if((null==o||""===o||Array.isArray(o)&&0===o.length)&&"coordinates"!==t.type)return;const n=a(e,t,i);n&&s.push({html:n,config:t,label:t.label||"",accordion:1==t.accordion,defaultOpen:0!=t.defaultOpen})}),s}},GeoLeaf._ContentBuilder.Assemblers,e.GeoLeaf._ContentBuilder.Assemblers,e.GeoLeaf=GeoLeaf,i().info("[GeoLeaf._ContentBuilder.Assemblers] Module Assemblers charg\xe9"),e.GeoLeaf=GeoLeaf}("undefined"!=typeof window?window:gt)),I||(I=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{};function t(){return GeoLeaf._ContentBuilder.Core||{getResolveField:function(){return GeoLeaf.Utils?.resolveField||(()=>null)},getEscapeHtml:function(){return GeoLeaf.Security?.escapeHtml||function(e){return null==e?"":String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}},getActiveProfile:function(){return GeoLeaf.Config?.getActiveProfile?.()||null},getLog:function(){return GeoLeaf.Log||console}}}GeoLeaf._ContentBuilder=GeoLeaf._ContentBuilder||{};const o=()=>t().getResolveField(),n=()=>t().getEscapeHtml(),r=()=>t().getLog();function i(e,t,r={}){const i=o(),a=n();let l=i(e,t.field);if((null==l||""===l)&&t.field&&t.field.startsWith("properties.")&&(l=i(e,t.field.replace(/^properties\./,"attributes."))),(null==l||""===l)&&t.field&&t.field.startsWith("attributes.")&&(l=i(e,t.field.replace(/^attributes\./,"properties."))),null==l||""===l)return"";const s=a(String(l)),c=t.variant||"default";if("title"===c){let t="";if(r.includeIcon&&r.resolveCategoryDisplay){const o=r.resolveCategoryDisplay(e);if(o&&o.iconId){const e=GeoLeaf.Config&&"function"==typeof GeoLeaf.Config.getIconsConfig?GeoLeaf.Config.getIconsConfig():null,n=(e&&e.symbolPrefix||"gl-poi-cat-")+String(o.iconId).trim().toLowerCase().replace(/\s+/g,"-");t='<svg class="gl-poi-popup__icon" aria-hidden="true" focusable="false" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="'+(o.colorFill||"#666")+'" stroke="'+(o.colorStroke||"#222")+'" stroke-width="1.5"/><svg x="4" y="4" width="16" height="16"><use href="#'+n+'" style="color: #ffffff"/></svg></svg>'}}return'<h3 class="gl-poi-popup__title">'+t+'<span class="gl-poi-popup__title-text">'+s+"</span></h3>"}return"short"===c?'<p class="gl-poi-popup__desc">'+s+"</p>":"long"===c||"paragraph"===c?'<p class="gl-poi-popup__desc gl-poi-popup__desc--long">'+s+"</p>":'<p class="gl-poi-popup__desc">'+s+"</p>"}function a(e,t){const r=o(),i=n();let a=r(e,t.field);return(null==a||""===a)&&t.field&&t.field.startsWith("properties.")&&(a=r(e,t.field.replace(/^properties\./,"attributes."))),(null==a||""===a)&&t.field&&t.field.startsWith("attributes.")&&(a=r(e,t.field.replace(/^attributes\./,"properties."))),null==a||""===a?"":'<div class="gl-content__longtext"><p>'+i(String(a)).replace(/\n/g,"</p><p>")+"</p></div>"}function l(e,t){const r=o(),i=n();let a=r(e,t.field);if((null==a||""===a)&&t.field&&t.field.startsWith("properties.")&&(a=r(e,t.field.replace(/^properties\./,"attributes."))),(null==a||""===a)&&t.field&&t.field.startsWith("attributes.")&&(a=r(e,t.field.replace(/^attributes\./,"properties."))),null==a||""===a)return"";const l="number"==typeof a?a:parseFloat(a);if(isNaN(l))return"";const s=l.toLocaleString("fr-FR"),c=t.label?i(t.label):"";return"stat"===(t.variant||"default")?'<div class="gl-content__stat">'+(c?'<span class="gl-content__stat-label">'+c+"</span>":"")+'<span class="gl-content__stat-value">'+s+"</span></div>":'<p class="gl-content__number">'+(c?"<strong>"+c+":</strong> ":"")+s+"</p>"}function s(e,r){const i=o(),a=n(),l=t();let s=i(e,r.field);if((null==s||""===s)&&r.field&&r.field.startsWith("properties.")&&(s=i(e,r.field.replace(/^properties\./,"attributes."))),(null==s||""===s)&&r.field&&r.field.startsWith("attributes.")&&(s=i(e,r.field.replace(/^attributes\./,"properties."))),null==s||""===s)return"";const c=r.variant||"default",u=l.resolveBadge?l.resolveBadge(e,r.field,c):{displayValue:String(s),style:""},d=a(u.displayValue);return'<span class="gl-poi-badge gl-poi-badge--'+c+'"'+(u.style?' style="'+u.style+'"':"")+">"+d+"</span>"}function c(e,r){const i=o(),a=n(),l=t();let s=i(e,r.field);if((null==s||""===s)&&r.field&&r.field.startsWith("properties.")&&(s=i(e,r.field.replace(/^properties\./,"attributes."))),(null==s||""===s)&&r.field&&r.field.startsWith("attributes.")&&(s=i(e,r.field.replace(/^attributes\./,"properties."))),null==s||""===s)return"";const c=l.validateImageUrl?l.validateImageUrl(s):s;if(!c)return"";const u=a(r.label||"Image");return r.variant,'<div class="gl-poi-popup__photo"><img src="'+c+'" alt="'+u+'" loading="lazy" /></div>'}function u(e,t){const r=o(),i=n();let a=r(e,t.field);if((null==a||""===a)&&t.field&&t.field.startsWith("properties.")&&(a=r(e,t.field.replace(/^properties\./,"attributes."))),(null==a||""===a)&&t.field&&t.field.startsWith("attributes.")&&(a=r(e,t.field.replace(/^attributes\./,"properties."))),null==a||""===a)return"";const l=i(t.label||a);return"button"===(t.variant||"default")?'<a href="'+i(a)+'" target="_blank" rel="noopener noreferrer" class="gl-content__link gl-content__link--button">'+l+"</a>":'<a href="'+i(a)+'" target="_blank" rel="noopener noreferrer" class="gl-content__link">'+l+"</a>"}function d(e,t){const r=o(),i=n();let a=r(e,t.field);if((null==a||""===a)&&t.field&&t.field.startsWith("properties.")&&(a=r(e,t.field.replace(/^properties\./,"attributes."))),(null==a||""===a)&&t.field&&t.field.startsWith("attributes.")&&(a=r(e,t.field.replace(/^attributes\./,"properties."))),null==a)return"";let l=[];if(Array.isArray(a))l=a;else{if("object"!=typeof a)return"";l=Object.entries(a).map(([e,t])=>e+": "+t)}if(0===l.length)return"";if(GeoLeaf._ContentBuilder&&GeoLeaf._ContentBuilder.Templates)return GeoLeaf._ContentBuilder.Templates.createListElement(l,t,i);let s='<ul class="gl-content__list gl-content__list--'+(t.variant||"disc")+'">';return l.forEach(e=>{s+="<li>"+i(String(e))+"</li>"}),s+="</ul>",s}function f(e,t){const r=o(),i=n(),a=r(e,t.field);if(null==a||!Array.isArray(a)||0===a.length)return"";const l=t.columns||[];if(0===l.length)return"";const s=t.borders||{};let c="";s.color&&(c+="--gl-table-border-color: "+s.color+";");let u="gl-content__table";s.outer&&(u+=" gl-content__table--border-outer"),s.row&&(u+=" gl-content__table--border-row"),s.column&&(u+=" gl-content__table--border-column");let d='<table class="'+u+'"'+(c?' style="'+c+'"':"")+">";return d+="<thead><tr>",l.forEach(e=>{d+="<th>"+i(e.label||e.key)+"</th>"}),d+="</tr></thead>",d+="<tbody>",a.forEach(e=>{d+="<tr>",l.forEach(t=>{const o="object"==typeof e?e[t.key]||"":e;d+="<td>"+i(String(o))+"</td>"}),d+="</tr>"}),d+="</tbody></table>",d}function p(e,t){const r=o(),i=n(),a=r(e,t.field);if(null==a||!Array.isArray(a)||0===a.length)return"";const l=a.filter(e=>e&&"string"==typeof e);if(0===l.length)return"";if(GeoLeaf._ContentBuilder&&GeoLeaf._ContentBuilder.Templates)return GeoLeaf._ContentBuilder.Templates.createTagsElement(l,t,i);let s='<div class="gl-content__tags">';return l.forEach(e=>{s+='<span class="gl-content__tag">'+i(e)+"</span>"}),s+="</div>",s}function g(e,r){const i=o(),a=n(),l=t(),s=i(e,r.field);if(null==s)return"";const c=l.validateCoordinates?l.validateCoordinates(s):null;return c?GeoLeaf._ContentBuilder&&GeoLeaf._ContentBuilder.Templates?GeoLeaf._ContentBuilder.Templates.createCoordinatesElement(c.lat,c.lng,r,a):'<div class="gl-content__coordinates"><span class="gl-content__coordinates-label">'+(r.label?a(r.label):"Coordonn\xe9es")+':</span> <span class="gl-content__coordinates-value">'+(l.formatCoordinates?l.formatCoordinates(c.lat,c.lng):c.lat.toFixed(6)+", "+c.lng.toFixed(6))+"</span></div>":""}function y(e,t){const r=o(),i=n(),a=r(e,t.field);if(null==a||!Array.isArray(a)||0===a.length)return"";const l=a.filter(e=>e&&"string"==typeof e);if(0===l.length)return"";if(GeoLeaf._ContentBuilder&&GeoLeaf._ContentBuilder.Templates)return GeoLeaf._ContentBuilder.Templates.createGalleryElement(l,t,i);let s='<div class="gl-content__gallery">';return l.forEach((e,t)=>{s+='<div class="gl-content__gallery-item" data-index="'+t+'"><img src="'+i(e)+'" alt="Image '+(t+1)+'" loading="lazy" /></div>'}),s+="</div>",s}const h={text:i,longtext:a,number:l,metric:function(e,t){const r=o(),i=n();let a=r(e,t.field);if((null==a||""===a)&&t.field&&t.field.startsWith("properties.")&&(a=r(e,t.field.replace(/^properties\./,"attributes."))),(null==a||""===a)&&t.field&&t.field.startsWith("attributes.")&&(a=r(e,t.field.replace(/^attributes\./,"properties."))),null==a||""===a)return"";const l="number"==typeof a?a:parseFloat(a);if(isNaN(l))return"";if(GeoLeaf._ContentBuilder&&GeoLeaf._ContentBuilder.Templates)return GeoLeaf._ContentBuilder.Templates.createMetricElement(l,t,i);const s=l.toLocaleString("fr-FR"),c=t.suffix?i(t.suffix):"",u=t.prefix?i(t.prefix):"",d=t.label?i(t.label):"";return'<p class="gl-content__metric">'+(d?"<strong>"+d+":</strong> ":"")+u+s+c+"</p>"},badge:s,rating:function(e,t){const r=o(),i=n();let a=r(e,t.field);if((null==a||""===a)&&t.field&&t.field.startsWith("properties.")&&(a=r(e,t.field.replace(/^properties\./,"attributes."))),(null==a||""===a)&&t.field&&t.field.startsWith("attributes.")&&(a=r(e,t.field.replace(/^attributes\./,"properties."))),null==a||""===a)return"";const l="number"==typeof a?a:parseFloat(a);if(isNaN(l)||l<0||l>5)return"";if("stat"===t.variant){const e=t.label?i(t.label):"";let o='<span class="gl-rating__stars">';for(let e=1;e<=5;e++)o+='<span class="gl-rating__star'+(e<=Math.round(l)?" gl-rating__star--filled":"")+'">\u2605</span>';return o+="</span>",'<div class="gl-rating gl-rating--stat">'+(e?'<span class="gl-rating__label">'+e+"</span>":"")+'<div class="gl-rating__content">'+o+'<span class="gl-rating__value">'+l.toFixed(1)+"/5</span></div></div>"}if(GeoLeaf._ContentBuilder&&GeoLeaf._ContentBuilder.Templates)return GeoLeaf._ContentBuilder.Templates.createRatingElement(l,t,i);const s=t.label?i(t.label):"";let c='<span class="gl-rating__stars">';for(let e=1;e<=5;e++)c+='<span class="gl-rating__star'+(e<=Math.round(l)?" gl-rating__star--filled":"")+'">\u2605</span>';return c+="</span>",'<div class="gl-rating">'+(s?'<span class="gl-rating__label">'+s+": </span>":"")+c+'<span class="gl-rating__value">'+l.toFixed(1)+"/5</span></div>"},image:c,link:u,list:d,table:f,tags:p,coordinates:g,gallery:y};function m(){return e.GeoLeaf?._ContentBuilder?.Assemblers||null}const b=e.GeoLeaf?._ContentBuilder?.Assemblers;GeoLeaf._ContentBuilder={renderText:i,renderLongtext:a,renderNumber:l,renderBadge:s,renderImage:c,renderLink:u,renderList:d,renderTable:f,renderTags:p,renderCoordinates:g,renderGallery:y,renderItem:function(e,t,o={}){if(!t||!t.type)return"";const n=h[t.type];return n?n(e,t,o):(r().warn("[ContentBuilder] Type de rendu non support\xe9:",t.type),"")},buildPopupHTML:function(e,t,o={}){const r=m();return r&&r.buildPopupHTML?r.buildPopupHTML(e,t,o):e?'<div class="gl-poi-popup"><div class="gl-poi-popup__body"><h3 class="gl-poi-popup__title"><span class="gl-poi-popup__title-text">'+n()(e.title||e.label||e.name||"Sans titre")+'</span></h3><a href="#" class="gl-poi-popup__link" data-poi-id="'+(e.id||"")+'">Voir plus >>></a></div></div>':""},buildTooltipHTML:function(e,t,r={}){const i=m();if(i&&i.buildTooltipHTML)return i.buildTooltipHTML(e,t,r);if(!e)return"";const a=n(),l=o(),s=e.title||e.label||e.name||l(e,"attributes.name","attributes.nom","properties.name","properties.nom")||"Sans titre";return a(String(s))},buildPanelItems:function(e,t,o={}){const n=m();return n&&n.buildPanelItems?n.buildPanelItems(e,t,o):[]},getResolveField:o,getEscapeHtml:n,getActiveProfile:()=>t().getActiveProfile()},b&&(GeoLeaf._ContentBuilder.Assemblers=b),e.GeoLeaf=GeoLeaf,r().info("[GeoLeaf._ContentBuilder] Module Content Builder charg\xe9")}("undefined"!=typeof window?window:gt)),P||(P=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log,o={createAccordion(t,o){const n=e.L.DomUtil.create("div","gl-legend__accordion",t);n.setAttribute("data-layer-id",o.layerId),o.collapsed&&n.classList.add("gl-legend__accordion--collapsed"),0==o.visible&&n.classList.add("gl-legend__accordion--inactive");const r=e.L.DomUtil.create("div","gl-legend__accordion-header",n);r.setAttribute("role","button"),r.setAttribute("tabindex","0"),r.setAttribute("aria-expanded",!o.collapsed),e.L.DomUtil.create("span","gl-legend__accordion-title",r).textContent=o.label;const i=e.L.DomUtil.create("button","gl-legend__accordion-toggle",r);i.type="button",i.setAttribute("aria-label","Basculer l'accord\xe9on"),i.textContent=o.collapsed?"\u25b6":"\u25bc";const a=e.L.DomUtil.create("div","gl-legend__accordion-body",n);return this.attachEventHandler(r,"click",t=>{if(0==o.visible)return e.L&&e.L.DomEvent&&e.L.DomEvent.stopPropagation(t),void t.preventDefault();e.L&&e.L.DomEvent&&e.L.DomEvent.stopPropagation(t),t.preventDefault();const a=n.classList.toggle("gl-legend__accordion--collapsed");i.textContent=a?"\u25b6":"\u25bc",r.setAttribute("aria-expanded",!a),"function"==typeof o.onToggle&&o.onToggle(o.layerId,!a)}),{accordionEl:n,headerEl:r,bodyEl:a,toggleEl:i}},renderCircleSymbol(o,n){const r=e.L.DomUtil.create("div","gl-legend__circle",o),i=2*(void 0!==n.radius?n.radius:24),a=n.fillColor||n.color||"#3388ff",l=n.color||n.borderColor||"rgba(0,0,0,0.2)",s=n.weight||1;if(r.style.width=i+"px",r.style.height=i+"px",r.style.backgroundColor=a,r.style.borderRadius="50%",r.style.border=s+"px solid "+l,r.style.position="relative",r.style.display="flex",r.style.alignItems="center",r.style.justifyContent="center",void 0!==n.fillOpacity&&(r.style.opacity=n.fillOpacity),n.icon){const e=n.icon.startsWith("#")?n.icon.substring(1):n.icon;if(!/^[a-zA-Z0-9_-]+$/.test(e))return t&&t.error("[UIComponents] ID d'ic\xf4ne invalide (caract\xe8res non autoris\xe9s):",n.icon),r;const o=document.createElementNS("http://www.w3.org/2000/svg","svg");o.setAttribute("viewBox","0 0 24 24"),o.style.width=.85*i+"px",o.style.height=.85*i+"px",o.style.fill=n.iconColor||"currentColor",o.style.stroke=n.iconColor||"currentColor",o.style.color="#ffffff",o.style.pointerEvents="none",o.style.position="absolute";const a=document.createElementNS("http://www.w3.org/2000/svg","use"),l="#"+e;if(a.setAttribute("href",l),o.appendChild(a),r.appendChild(o),t){const e=document.querySelector('svg[data-geoleaf-sprite="profile"]');if(e){const r=n.icon.startsWith("#")?n.icon.substring(1):n.icon;e.querySelector("#"+r)||(o.setAttribute("data-symbol-missing",n.icon),t.warn("[UIComponents] Symbole",n.icon,"non trouv\xe9 dans le sprite SVG"))}else o.setAttribute("data-sprite-missing","true"),t.warn("[UIComponents] Ic\xf4ne",n.icon,"r\xe9f\xe9renc\xe9e mais sprite non trouv\xe9 dans le DOM")}}return r},renderLineSymbol(t,o){const n=o.width||3,r=o.color||"#3388ff";let i=o.style||"solid";const a=o.dashArray||null,l=o.outlineColor||null,s=o.outlineWidth||null;if(a||n>5||l&&s){const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("viewBox","0 0 40 8"),e.style.width="40px";const c=Math.max(n,3)+(s||0)+4;if(e.style.height=c+"px",l&&s){const t=document.createElementNS("http://www.w3.org/2000/svg","line");t.setAttribute("x1","0"),t.setAttribute("y1","4"),t.setAttribute("x2","40"),t.setAttribute("y2","4"),t.setAttribute("stroke",l),t.setAttribute("stroke-width",n+2*s),t.setAttribute("stroke-linecap","round"),void 0!==o.outlineOpacity&&t.setAttribute("stroke-opacity",o.outlineOpacity),e.appendChild(t)}const u=document.createElementNS("http://www.w3.org/2000/svg","line");return u.setAttribute("x1","0"),u.setAttribute("y1","4"),u.setAttribute("x2","40"),u.setAttribute("y2","4"),u.setAttribute("stroke",r),u.setAttribute("stroke-width",n),u.setAttribute("stroke-linecap","round"),a?u.setAttribute("stroke-dasharray",a):"dashed"===i?u.setAttribute("stroke-dasharray","8,4"):"dotted"===i&&u.setAttribute("stroke-dasharray","2,3"),void 0!==o.opacity&&u.setAttribute("stroke-opacity",o.opacity),e.appendChild(u),t.appendChild(e),e}const c=e.L.DomUtil.create("div","gl-legend__line",t);return c.style.width="30px",c.style.height=n+"px",c.style.backgroundColor=r,"dashed"===i?(c.style.backgroundImage=`linear-gradient(to right, ${r} 50%, transparent 50%)`,c.style.backgroundSize="8px 100%"):"dotted"===i&&(c.style.backgroundImage=`linear-gradient(to right, ${r} 30%, transparent 30%)`,c.style.backgroundSize="4px 100%"),void 0!==o.opacity&&(c.style.opacity=o.opacity),c},renderPolygonSymbol(t,o){const n=o.fillColor||o.color||"#3388ff",r=o.borderColor||o.color||"#333",i=o.weight||1,a=o.hatch&&o.hatch.enabled;let l=void 0!==o.fillOpacity?o.fillOpacity:void 0!==o.opacity?o.opacity:1;if(a&&"pattern_only"===o.hatch.renderMode&&(l=1),a||0===l){const e=document.createElementNS("http://www.w3.org/2000/svg","svg");if(e.setAttribute("viewBox","0 0 32 24"),e.style.width="32px",e.style.height="24px",a){const t=o.hatch,n=t.type||"diagonal",a=t.spacingPx||10,s=t.stroke&&t.stroke.color||"#000000",c=void 0!==(t.stroke&&t.stroke.opacity)?t.stroke.opacity:1,u=t.stroke&&t.stroke.widthPx||1,d="hatch-legend-"+Date.now()+"-"+Math.random().toString(36).substr(2,9),f=document.createElementNS("http://www.w3.org/2000/svg","defs"),p=document.createElementNS("http://www.w3.org/2000/svg","pattern");if(p.setAttribute("id",d),p.setAttribute("patternUnits","userSpaceOnUse"),p.setAttribute("width",a),p.setAttribute("height",a),"diagonal"===n){const e=document.createElementNS("http://www.w3.org/2000/svg","line");e.setAttribute("x1","0"),e.setAttribute("y1","0"),e.setAttribute("x2",a),e.setAttribute("y2",a),e.setAttribute("stroke",s),e.setAttribute("stroke-width",u),e.setAttribute("stroke-opacity",c),p.appendChild(e)}else if("dot"===n){const e=document.createElementNS("http://www.w3.org/2000/svg","circle");e.setAttribute("cx",a/2),e.setAttribute("cy",a/2),e.setAttribute("r",Math.max(.3,.07*a)),e.setAttribute("fill",s),e.setAttribute("fill-opacity",c),p.appendChild(e)}else if("cross"===n){const e=document.createElementNS("http://www.w3.org/2000/svg","line");e.setAttribute("x1","0"),e.setAttribute("y1",a/2),e.setAttribute("x2",a),e.setAttribute("y2",a/2),e.setAttribute("stroke",s),e.setAttribute("stroke-width",u),e.setAttribute("stroke-opacity",c),p.appendChild(e);const t=document.createElementNS("http://www.w3.org/2000/svg","line");t.setAttribute("x1",a/2),t.setAttribute("y1","0"),t.setAttribute("x2",a/2),t.setAttribute("y2",a),t.setAttribute("stroke",s),t.setAttribute("stroke-width",u),t.setAttribute("stroke-opacity",c),p.appendChild(t)}else if("x"===n){const e=document.createElementNS("http://www.w3.org/2000/svg","line");e.setAttribute("x1","0"),e.setAttribute("y1","0"),e.setAttribute("x2",a),e.setAttribute("y2",a),e.setAttribute("stroke",s),e.setAttribute("stroke-width",u),e.setAttribute("stroke-opacity",c),p.appendChild(e);const t=document.createElementNS("http://www.w3.org/2000/svg","line");t.setAttribute("x1",a),t.setAttribute("y1","0"),t.setAttribute("x2","0"),t.setAttribute("y2",a),t.setAttribute("stroke",s),t.setAttribute("stroke-width",u),t.setAttribute("stroke-opacity",c),p.appendChild(t)}f.appendChild(p),e.appendChild(f);const g=document.createElementNS("http://www.w3.org/2000/svg","rect");g.setAttribute("x","1"),g.setAttribute("y","1"),g.setAttribute("width","30"),g.setAttribute("height","22"),g.setAttribute("fill",`url(#${d})`),g.setAttribute("stroke",r),g.setAttribute("stroke-width",i),1!==l&&g.setAttribute("fill-opacity",l),e.appendChild(g)}else{const t=document.createElementNS("http://www.w3.org/2000/svg","rect");t.setAttribute("x","1"),t.setAttribute("y","1"),t.setAttribute("width","30"),t.setAttribute("height","22"),t.setAttribute("fill","none"),t.setAttribute("stroke",r),t.setAttribute("stroke-width",i),o.dashArray&&t.setAttribute("stroke-dasharray",o.dashArray),e.appendChild(t)}return t.appendChild(e),e}const s=e.L.DomUtil.create("div","gl-legend__polygon",t);return s.style.width="24px",s.style.height="16px",s.style.backgroundColor=n,s.style.border=i+"px solid "+r,1!==l&&(s.style.opacity=l),s},renderStarSymbol(t,o){const n=e.L.DomUtil.create("div","gl-legend__stars",t),r=o.count||5,i=o.color||"#f1c40f",a=o.size||12;for(let t=0;t<r;t++){const t=e.L.DomUtil.create("span","gl-legend__star",n);t.textContent="\u2605",t.style.color=i,t.style.fontSize=a+"px"}return n},renderSymbol(t,o){const n=o.symbol||o;switch(n.type||o.type||"circle"){case"marker":case"circle":default:return this.renderCircleSymbol(t,n);case"line":return this.renderLineSymbol(t,n);case"polygon":case"fill":return this.renderPolygonSymbol(t,n);case"star":return this.renderStarSymbol(t,n);case"icon":if(n.iconUrl){const o=e.L.DomUtil.create("img","gl-legend__icon-img",t);return o.src=n.iconUrl,n.size&&(o.style.width=n.size+"px",o.style.height=n.size+"px"),o}return n.icon,this.renderCircleSymbol(t,n)}},createToggleButton(t,o){const n=void 0!==o.isActive?o.isActive:o.active,r=o.className||"gl-toggle-btn",i=e.L.DomUtil.create("button",r,t);if(i.type="button",o.id&&i.setAttribute("data-toggle-id",o.id),i.setAttribute("aria-pressed",n?"true":"false"),o.title&&(i.title=o.title),n&&i.classList.add(r+"--on"),o.label&&(i.textContent=o.label),"function"==typeof o.onToggle){const t=o.className||"gl-toggle-btn",n=n=>{e.L&&e.L.DomEvent&&e.L.DomEvent.stopPropagation(n),n.preventDefault();const r=i.classList.toggle(t+"--on");i.setAttribute("aria-pressed",r?"true":"false"),o.onToggle(o.id,r,n)};this.attachEventHandler(i,"click",n)}return i},attachEventHandler(t,o,n){e.L&&e.L.DomEvent?(e.L.DomEvent.on(t,o,n),"click"===o&&e.L.DomEvent.disableClickPropagation(t)):t.addEventListener(o,n)}};GeoLeaf._UIComponents=o,t&&t.info("[GeoLeaf._UIComponents] Module commun UI charg\xe9")}(window)),w||(w=1,function(e){const GeoLeaf=e.GeoLeaf||(e.GeoLeaf={}),t=(e,t,...o)=>GeoLeaf.Utils&&GeoLeaf.Utils.createElement?GeoLeaf.Utils.createElement(e,t,...o):document.createElement(e),o={ERROR:3,WARNING:2,SUCCESS:1,INFO:1};GeoLeaf._UINotifications=new class NotificationSystem{constructor(){this.container=null,this.maxVisible=3,this.maxPersistent=2,this.durations={success:3e3,error:5e3,warning:4e3,info:3e3},this.config={enabled:1,position:"bottom-center",animations:1},this._eventManager=null,this._timerManager=null,this._activeToasts=new Map,this._queue=[],this._maxQueueSize=15,this._metricsBuffer=[],this._metricsBufferTimeout=null,this._telemetryAvailable=0}init(e={}){if(this.config={...this.config,...e},this.maxVisible=e.maxVisible||3,this.durations={...this.durations,...e.durations},this.container=document.querySelector(e.container||"#gl-notifications"),!this.container){const t=GeoLeaf.Log;return t&&t.warn("[GeoLeaf Notifications] Container introuvable:",e.container),0}e.position&&(this.container.className=`gl-notifications gl-notifications--${e.position}`);const t=GeoLeaf.Log;return t&&t.debug("[GeoLeaf Notifications] Syst\xe8me initialis\xe9"),GeoLeaf.Utils&&(this._eventManager=GeoLeaf.Utils.events?GeoLeaf.Utils.events.createManager("notifications"):null,this._timerManager=GeoLeaf.Utils.timers?GeoLeaf.Utils.timers.createManager("notifications"):null),this._startMetricsBufferTimeout(),this._flushMetricsBuffer(),1}show(e,t="info",o){let n={};return n="string"==typeof t?{type:t,duration:o}:"object"==typeof t&&null!==t?t:{type:"info"},this._enqueue(e,n)}success(e,t){return"number"==typeof t?this.show(e,"success",t):"object"==typeof t?this.show(e,{...t,type:"success"}):this.show(e,"success")}error(e,t){return"number"==typeof t?this.show(e,"error",t):"object"==typeof t?this.show(e,{...t,type:"error"}):this.show(e,"error")}warning(e,t){return"number"==typeof t?this.show(e,"warning",t):"object"==typeof t?this.show(e,{...t,type:"warning"}):this.show(e,"warning")}info(e,t){return"number"==typeof t?this.show(e,"info",t):"object"==typeof t?this.show(e,{...t,type:"info"}):this.show(e,"info")}_enqueue(e,t){const n=t.type||"info",r=o[n.toUpperCase()]||o.INFO,i={message:e,options:{type:n,duration:t.duration,persistent:t.persistent||0,dismissible:0!=t.dismissible,icon:t.icon,action:t.action},priority:r,timestamp:Date.now()};if(this._queue.length>=this._maxQueueSize){const e=this._queue.reduce((e,t,o,n)=>{const r=n[e];return t.priority<r.priority||t.priority===r.priority&&t.timestamp<r.timestamp?o:e},0);if(!(i.priority>this._queue[e].priority)){this._recordMetric("notification.dropped",1);const e=GeoLeaf.Log;return void(e&&e.warn("[GeoLeaf Notifications] Queue pleine, notification rejet\xe9e"))}{this._queue.splice(e,1),this._recordMetric("notification.dropped",1);const t=GeoLeaf.Log;t&&t.warn("[GeoLeaf Notifications] Queue pleine, notification dropp\xe9e")}}return this._queue.push(i),this._recordMetric("notification.queued",1),this._queue.sort((e,t)=>t.priority!==e.priority?t.priority-e.priority:e.timestamp-t.timestamp),this._processQueue()}_processQueue(){if(!this.container||!this.config.enabled||0===this._queue.length)return null;const e=this.container.querySelectorAll(".gl-toast:not(.gl-toast--removing)"),t=Array.from(e).filter(e=>!e.dataset.persistent),n=Array.from(e).filter(e=>e.dataset.persistent);let r=null;for(;this._queue.length>0;){const e=this._queue[0],i=e.options.persistent;if(!(i?n.length<this.maxPersistent:t.length<this.maxVisible)){if(!(e.priority===o.ERROR&&t.length>0))break;{const e=t.find(e=>e.classList.contains("gl-toast--info")||e.classList.contains("gl-toast--success"))||t[0];this._remove(e,1)}}const a=this._queue.shift();r=this._showImmediate(a.message,a.options),i?n.push(null):t.push(null)}return r}_showImmediate(e,n){const r=n.type||"info",i=n.duration||this.durations[r],a=n.persistent||0,l=0!=n.dismissible,s=t("div",{className:`gl-toast gl-toast--${r}`,attributes:{role:"alert","aria-live":"error"===r||n.priority===o.ERROR?"assertive":"polite"}});a&&(s.dataset.persistent="true");const c=t("span",{className:"gl-toast__message",textContent:e});if(s.appendChild(c),l){const e=t("button",{className:"gl-toast__close",attributes:{"aria-label":"Fermer la notification",title:"Fermer"},textContent:"\xd7",onClick:()=>{this._recordMetric("notification.dismissed.manual",1),this._remove(s,0)}});s.appendChild(e)}if(this.container.appendChild(s),this._recordMetric(`notification.shown.${r}`,1),this.config.animations?requestAnimationFrame(()=>{requestAnimationFrame(()=>{s.classList.add("gl-toast--visible")})}):s.classList.add("gl-toast--visible"),!a){const e=setTimeout(()=>{this._recordMetric("notification.dismissed.auto",1),this._remove(s,0)},i);this._timerManager?s.dataset.timerId=this._timerManager.setTimeout(()=>{this._recordMetric("notification.dismissed.auto",1),this._remove(s,0)},i):s.dataset.timeoutId=e}return s}_remove(e,t=0){if(!e||e.classList.contains("gl-toast--removing"))return;e.dataset.timeoutId&&(clearTimeout(parseInt(e.dataset.timeoutId)),delete e.dataset.timeoutId),e.dataset.timerId&&this._timerManager&&(this._timerManager.clearTimeout(e.dataset.timerId),delete e.dataset.timerId),e.classList.add("gl-toast--removing"),e.classList.remove("gl-toast--visible"),t&&this.config.animations&&e.classList.add("gl-toast--sliding-up");const o=this.config.animations?200:0;setTimeout(()=>{e.parentNode&&e.remove(),this._processQueue()},o),this._timerManager&&this._timerManager.setTimeout(()=>{e.parentNode&&e.remove(),this._processQueue()},o)}clearAll(){this.container&&(this.container.querySelectorAll(".gl-toast").forEach(e=>this._remove(e,0)),this._queue=[])}dismiss(e){e&&this._remove(e,0)}disable(){this.config.enabled=0;const e=GeoLeaf.Log;e&&e.debug("[GeoLeaf Notifications] Syst\xe8me d\xe9sactiv\xe9")}enable(){this.config.enabled=1;const e=GeoLeaf.Log;e&&e.debug("[GeoLeaf Notifications] Syst\xe8me activ\xe9"),this._processQueue()}_recordMetric(e,t=1){if(GeoLeaf.Storage&&GeoLeaf.Storage.Telemetry&&"function"==typeof GeoLeaf.Storage.Telemetry.recordMetric)try{GeoLeaf.Storage.Telemetry.recordMetric(e,t),this._telemetryAvailable=1}catch(e){const t=GeoLeaf.Log;t&&t.warn("[GeoLeaf Notifications] Erreur enregistrement m\xe9trique:",e)}else this._metricsBuffer.push({name:e,value:t,timestamp:Date.now()})}_flushMetricsBuffer(){if(0!==this._metricsBuffer.length&&GeoLeaf.Storage&&GeoLeaf.Storage.Telemetry&&"function"==typeof GeoLeaf.Storage.Telemetry.recordMetric){const e=GeoLeaf.Log;e&&e.debug(`[GeoLeaf Notifications] Flush de ${this._metricsBuffer.length} m\xe9triques vers Telemetry`),this._metricsBuffer.forEach(t=>{try{GeoLeaf.Storage.Telemetry.recordMetric(t.name,t.value)}catch(t){e&&e.warn("[GeoLeaf Notifications] Erreur flush m\xe9trique:",t)}}),this._metricsBuffer=[],this._telemetryAvailable=1,this._metricsBufferTimeout&&(clearTimeout(this._metricsBufferTimeout),this._metricsBufferTimeout=null)}}_startMetricsBufferTimeout(){this._metricsBufferTimeout=setTimeout(()=>{if(this._metricsBuffer.length>0){const e=GeoLeaf.Log;e&&e.warn(`[GeoLeaf Notifications] Timeout buffer m\xe9triques (30s), ${this._metricsBuffer.length} m\xe9triques abandonn\xe9es`),this._metricsBuffer=[]}this._metricsBufferTimeout=null},3e4)}_escapeHtml(e){return GeoLeaf.Security&&"function"==typeof GeoLeaf.Security.escapeHtml?GeoLeaf.Security.escapeHtml(e):null==e?"":String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}destroy(){const e=GeoLeaf.Log;this._timerManager&&(this._timerManager.destroy(),this._timerManager=null),this._eventManager&&(this._eventManager.destroy(),this._eventManager=null),this._metricsBufferTimeout&&(clearTimeout(this._metricsBufferTimeout),this._metricsBufferTimeout=null),this._metricsBuffer.length>0&&(this._flushMetricsBuffer(),this._metricsBuffer=[]),this.container&&this.container.querySelectorAll(".gl-toast").forEach(e=>e.remove()),this._queue=[],this._activeToasts.clear(),this.container=null,this.config.enabled=0,e&&e.info("[GeoLeaf Notifications] Syst\xe8me d\xe9truit et nettoy\xe9")}getStatus(){const e=this.container?this.container.querySelectorAll(".gl-toast:not(.gl-toast--removing)"):[],t=Array.from(e).filter(e=>!e.dataset.persistent),o=Array.from(e).filter(e=>e.dataset.persistent);return{enabled:this.config.enabled,initialized:!!this.container,activeToasts:e.length,temporaryToasts:t.length,persistentToasts:o.length,queued:this._queue.length,maxVisible:this.maxVisible,maxPersistent:this.maxPersistent,position:this.config.position,telemetryAvailable:this._telemetryAvailable,metricsBuffered:this._metricsBuffer.length}}}}(window)),A||(A=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log;GeoLeaf._UIEventDelegation=GeoLeaf._UIEventDelegation||{};const o=new Map;let n=0;function r(e,r,i,a={}){if(!e||"function"!=typeof i)return t&&t.warn("[UI.EventDelegation] attachTrackedListener: \xe9lement ou handler manquant"),null;const l="listener_"+ ++n,s=function(e){try{return i.call(this,e)}catch(e){t&&t.error("[UI.EventDelegation] Erreur dans handler:",e)}};return e.addEventListener(r,s,a),o.set(l,{element:e,event:r,handler:s,originalHandler:i}),l}GeoLeaf._UIEventDelegation.attachTrackedListener=r,GeoLeaf._UIEventDelegation.detachTrackedListener=function(e){if(!e||!o.has(e))return 0;const{element:t,event:n,handler:r}=o.get(e);return t.removeEventListener(n,r),o.delete(e),1},GeoLeaf._UIEventDelegation.cleanupAllListeners=function(){let e=0;for(const[t,{element:n,event:r,handler:i}]of o)n.removeEventListener(r,i),e++;return o.clear(),t&&e>0&&t.info(`[UI.EventDelegation] ${e} listeners nettoy\xe9es`),e},GeoLeaf._UIEventDelegation.attachFilterInputEvents=function(e,o,n=300){if(!e||"function"!=typeof o)return t&&t.warn("[UI.EventDelegation] attachFilterInputEvents: param\xe8tres manquants"),[];const i=[];let a=null;return i.push(r(e,"input",function(e){e.target.matches('input[type="text"], input[type="range"]')&&(a&&clearTimeout(a),a=setTimeout(()=>{o()},n))})),i.push(r(e,"change",function(e){e.target.matches('input[type="checkbox"]')&&o()})),i.push(r(e,"change",function(e){e.target.matches("select")&&o()})),i.filter(e=>null!==e)},GeoLeaf._UIEventDelegation.attachAccordionEvents=function(e){return e?r(e,"click",function(e){const t=e.target.closest(".gl-accordion-toggle, .accordion-arrow");if(!t)return;e.preventDefault(),e.stopPropagation();const o=t.closest(".gl-accordion")?.querySelector(".gl-accordion-content");if(!o)return;const n="none"!==o.style.display;o.style.display=n?"none":"block",t.setAttribute("aria-expanded",!n);const r=t.querySelector(".accordion-icon, .accordion-arrow");r&&r.classList.toggle("expanded",!n)}):(t&&t.warn("[UI.EventDelegation] attachAccordionEvents: conteneur manquant"),null)},GeoLeaf._UIEventDelegation.attachMapControlEvents=function(e,o){if(!e||!o||"object"!=typeof o)return t&&t.warn("[UI.EventDelegation] attachMapControlEvents: param\xe8tres manquants"),[];const n=[];return n.push(r(e,"click",function(e){for(const[t,n]of Object.entries(o))if(e.target.matches(t)||e.target.closest(t)){e.preventDefault(),e.stopPropagation(),"function"==typeof n&&n.call(this,e);break}})),n.filter(e=>null!==e)},GeoLeaf._UIEventDelegation.getActiveListenersCount=function(){return o.size},GeoLeaf._UIEventDelegation.getActiveListeners=function(){return Array.from(o.keys())},t&&t.info("[UI.EventDelegation] Module initialis\xe9")}(window)),G||(G=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log;GeoLeaf._UIFilterStateManager=GeoLeaf._UIFilterStateManager||{};let o={values:new Map,metadata:new Map,activeProfile:null,observers:new Set};const n=new Map;function r(e,n,r,i){const a={type:e,filterId:n,newValue:r,oldValue:i,timestamp:Date.now(),allValues:Object.fromEntries(o.values)};o.observers.forEach(e=>{try{e(a)}catch(e){t&&t.error("[UI.FilterStateManager] Erreur dans observateur:",e)}})}GeoLeaf._UIFilterStateManager.initializeFromProfile=function(e){return e&&e.filters?(o.values.clear(),o.metadata.clear(),o.activeProfile=e,e.filters.forEach(e=>{if(!e.id)return;const t={type:e.type,label:e.label,required:!!e.required,min:e.min,max:e.max,options:e.options||[],optionsFrom:e.optionsFrom};o.metadata.set(e.id,t);let n=null;switch(e.type){case"select":case"multiselect":n=e.default||("multiselect"===e.type?[]:"");break;case"range":n=e.default??(e.min+e.max)/2;break;case"tree":case"tree-category":case"categoryTree":n=e.default||[];break;default:n=e.default||""}o.values.set(e.id,n)}),r("init",null,o.values),t&&t.info(`[UI.FilterStateManager] Initialis\xe9 avec ${o.values.size} filtres`),1):(t&&t.warn("[UI.FilterStateManager] Profil ou filtres manquants"),0)},GeoLeaf._UIFilterStateManager.updateFilterValue=function(e,i,a=0){if(!e||!o.metadata.has(e))return t&&t.warn(`[UI.FilterStateManager] Filtre inconnu: ${e}`),0;const l=o.metadata.get(e),s=o.values.get(e),c=function(e,t){if(!t)return null;switch(t.type){case"select":return"string"==typeof e?e:"";case"multiselect":case"tree":case"tree-category":case"categoryTree":return Array.isArray(e)?e:[];case"range":const o=parseFloat(e);return isNaN(o)?t.min||0:void 0!==t.min&&o<t.min?t.min:void 0!==t.max&&o>t.max?t.max:o;default:return e}}(i,l);return null===c&&null!==i?(t&&t.warn(`[UI.FilterStateManager] Valeur invalide pour ${e}:`,i),0):(o.values.set(e,c),a||("range"===l.type?function(e,t,o,i){n.has(e)&&clearTimeout(n.get(e));const a=setTimeout(()=>{r("change",e,i,o),n.delete(e)},200);n.set(e,a)}(e,0,s,c):r("change",e,c,s)),1)},GeoLeaf._UIFilterStateManager.getFilterValue=function(e){return o.values.get(e)||null},GeoLeaf._UIFilterStateManager.getAllFilterValues=function(){return Object.fromEntries(o.values)},GeoLeaf._UIFilterStateManager.getFilterMetadata=function(e){return o.metadata.get(e)||null},GeoLeaf._UIFilterStateManager.resetAllFilters=function(e=0){const t=new Map(o.values);o.values.forEach((e,t)=>{const n=o.metadata.get(t);if(!n)return;let r=null;switch(n.type){case"multiselect":case"tree":case"tree-category":case"categoryTree":r=[];break;case"range":r=(n.min+n.max)/2;break;default:r=""}o.values.set(t,r)}),e||r("reset",null,o.values,t)},GeoLeaf._UIFilterStateManager.addObserver=function(e){return"function"!=typeof e?(t&&t.warn("[UI.FilterStateManager] Observateur doit \xeatre une fonction"),()=>{}):(o.observers.add(e),function(){o.observers.delete(e)})},GeoLeaf._UIFilterStateManager.hasActiveFilters=function(){for(const[e,t]of o.values){const n=o.metadata.get(e);if(n)switch(n.type){case"multiselect":case"tree":case"tree-category":case"categoryTree":if(Array.isArray(t)&&t.length>0)return 1;break;case"select":if(t&&""!==t)return 1;break;case"range":const e=(n.min+n.max)/2;if(Math.abs(t-e)>.01)return 1}}return 0},GeoLeaf._UIFilterStateManager.getActiveFiltersSummary=function(){const e=[];for(const[t,n]of o.values){const r=o.metadata.get(t);if(!r)continue;let i=0,a="";switch(r.type){case"multiselect":case"tree":case"tree-category":case"categoryTree":Array.isArray(n)&&n.length>0&&(i=1,a=`${n.length} s\xe9lectionn\xe9(s)`);break;case"select":n&&""!==n&&(i=1,a=n);break;case"range":const e=(r.min+r.max)/2;Math.abs(n-e)>.01&&(i=1,a=n.toString().replace(".",","))}i&&e.push({id:t,label:r.label||t,value:a,type:r.type})}return e},Object.defineProperty(GeoLeaf._UIFilterStateManager,"activeProfile",{get:()=>o.activeProfile,enumerable:1}),Object.defineProperty(GeoLeaf._UIFilterStateManager,"filterCount",{get:()=>o.values.size,enumerable:1}),t&&t.info("[UI.FilterStateManager] Module initialis\xe9")}(window)),E||(E=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log||console,o={_map:null,_config:null,_container:null,_scaleLineMetric:null,_numericElement:null,_zoomElement:null,_inputElement:null,_scalePrefix:null,_mainWrapper:null,_eventHandlers:{},init(e,o){e?(this._map=e,this._config=o||{},this._createMainContainer(),t.info("[GeoLeaf.ScaleControl] Contr\xf4le d'\xe9chelle initialis\xe9")):t.error("[GeoLeaf.ScaleControl] Carte non fournie")},_createMainContainer(){const e=this._config.position||"bottomleft";if(this._mainWrapper=L.DomUtil.create("div","gl-scale-main-wrapper"),0!=this._config.scaleGraphic){const e=L.DomUtil.create("div","gl-scale-graphic-wrapper",this._mainWrapper);this._addGraphicScaleToContainer(e)}(this._config.scaleNumeric||this._config.scaleNivel)&&this._createCustomScaleBlock(this._mainWrapper),(new(L.Control.extend({options:{position:e},onAdd:()=>this._mainWrapper}))).addTo(this._map)},_addGraphicScaleToContainer(e){const o=L.DomUtil.create("div","leaflet-control-scale leaflet-control",e),n=L.DomUtil.create("div","leaflet-control-scale-line",o);this._scaleLineMetric=n;const r=()=>{const e=this._map.getSize().y/2,t=this._map.distance(this._map.containerPointToLatLng([0,e]),this._map.containerPointToLatLng([150,e]));this._updateScaleLine(this._scaleLineMetric,t)};this._eventHandlers.graphicScaleUpdate=r,this._map.on("zoomend moveend",r),r(),t.info("[GeoLeaf.ScaleControl] \xc9chelle graphique ajout\xe9e")},_updateScaleLine(e,t){const o=t/1e3;let n,r;if(o>1){const e=this._getRoundNum(o);r=e/o,n=e+" km"}else{const e=this._getRoundNum(t);r=e/t,n=e+" m"}e.style.width=Math.round(150*r)+"px",e.textContent=n},_getRoundNum(e){const t=Math.pow(10,(Math.floor(e)+"").length-1);let o=e/t;return o=o>=10?10:o>=5?5:o>=3?3:o>=2?2:1,t*o},_createCustomScaleBlock(e){this._container=L.DomUtil.create("div","gl-scale-control",e),this._config.scaleNumeric&&(this._config.scaleNumericEditable?this._createEditableScale():this._createReadOnlyScale()),this._config.scaleNivel&&this._createZoomLevel();const o=()=>this._updateScale();this._eventHandlers.numericScaleUpdate=o,this._map.on("zoomend moveend",o),this._updateScale(),t.info("[GeoLeaf.ScaleControl] Bloc personnalis\xe9 ajout\xe9")},_createReadOnlyScale(){this._numericElement=L.DomUtil.create("div","gl-scale-numeric",this._container)},_createEditableScale(){const e=L.DomUtil.create("div","gl-scale-numeric-editable",this._container);this._scalePrefix=L.DomUtil.create("span","gl-scale-prefix",e),this._scalePrefix.textContent="1:",this._numericElement=L.DomUtil.create("span","gl-scale-numeric-clickable",e),this._numericElement.textContent="0",this._inputElement=L.DomUtil.create("input","gl-scale-numeric-input",e),this._inputElement.type="text",this._inputElement.placeholder="250000",this._inputElement.style.display="none",L.DomEvent.disableClickPropagation(e),L.DomEvent.disableScrollPropagation(e),this._numericElement.addEventListener("click",()=>{this._switchToEditMode()}),this._inputElement.addEventListener("keypress",e=>{"Enter"===e.key&&(this._onScaleInputChange(),this._switchToDisplayMode())}),this._inputElement.addEventListener("blur",()=>{this._onScaleInputChange(),this._switchToDisplayMode()})},_createZoomLevel(){this._zoomElement=L.DomUtil.create("div","gl-scale-zoom",this._container)},_switchToEditMode(){this._numericElement&&this._inputElement&&(this._inputElement.value=this._numericElement.textContent,this._numericElement.style.display="none",this._inputElement.style.display="inline-block",this._inputElement.focus(),this._inputElement.select())},_switchToDisplayMode(){this._numericElement&&this._inputElement&&(this._inputElement.style.display="none",this._numericElement.style.display="inline")},_updateScale(){const e=this._map.getZoom(),t=this._calculateScale(e);this._numericElement&&(this._config.scaleNumericEditable?"none"===this._inputElement.style.display&&(this._numericElement.textContent=this._formatNumber(t)):this._numericElement.textContent=`1:${this._formatNumber(t)}`),this._zoomElement&&(this._zoomElement.textContent=`Zoom: ${Number(e).toFixed(2)}`)},_calculateScale(e,t){const o=void 0!==t?t:this._map.getCenter().lat,n=156543.03392*Math.cos(o*Math.PI/180)/Math.pow(2,e)*96/.0254;return Math.round(n)},_formatNumber:e=>e.toString().replace(/\B(?=(\d{3})+(?!\d))/g," "),_onScaleInputChange(){if(!this._inputElement)return;const e=this._inputElement.value.trim(),o=e.replace(/\s/g,""),n=parseInt(o,10);if(!isNaN(n)&&n>0){const e=this._calculateZoomFromScale(n);this._map.setView(this._map.getCenter(),e,{animate:1,zoomSnap:0}),t.info(`[GeoLeaf.ScaleControl] Zoom ajust\xe9 \xe0 ${e} pour \xe9chelle 1:${n}`)}else t.warn("[GeoLeaf.ScaleControl] Format d'\xe9chelle invalide:",e),this._updateScale()},_calculateZoomFromScale(e){const t=this._map.getCenter().lat,o=.0254*e/96;let n=Math.log2(156543.03392*Math.cos(t*Math.PI/180)/o);for(let o=0;o<20;o++){const o=this._calculateScale(n,t),r=e-o;if(Math.abs(r)<1)break;n-=.95*Math.log2(e/o)}const r=Math.round(1e4*n)/1e4;return Math.max(0,Math.min(22,r))},destroy(){this._map&&this._eventHandlers&&(this._eventHandlers.graphicScaleUpdate&&this._map.off("zoomend moveend",this._eventHandlers.graphicScaleUpdate),this._eventHandlers.numericScaleUpdate&&this._map.off("zoomend moveend",this._eventHandlers.numericScaleUpdate)),this._mainWrapper&&this._mainWrapper.parentNode&&this._mainWrapper.parentNode.removeChild(this._mainWrapper),this._map=null,this._config=null,this._container=null,this._scaleLineMetric=null,this._numericElement=null,this._zoomElement=null,this._inputElement=null,this._scalePrefix=null,this._mainWrapper=null,this._eventHandlers={},t.info("[GeoLeaf.ScaleControl] Contr\xf4le d\xe9truit et ressources nettoy\xe9es")}};GeoLeaf.ScaleControl=o,GeoLeaf.initScaleControl=function(e){if(!e)return void t.warn("[GeoLeaf.ScaleControl] Impossible d'initialiser : carte non fournie");const n=GeoLeaf.Config&&GeoLeaf.Config.get?GeoLeaf.Config.get("scaleConfig"):null;n&&(n.scaleGraphic||n.scaleNumeric||n.scaleNivel)&&o.init(e,n)}}("undefined"!=typeof window?window:gt)),O||(O=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log||console,o=GeoLeaf.Utils?.createElement||function(e,t){const o=document.createElement(e);if(t){if(t.className&&(o.className=t.className),t.textContent&&(o.textContent=t.textContent),t.id&&(o.id=t.id),t.name&&(o.name=t.name),t.type&&(o.type=t.type),t.placeholder&&(o.placeholder=t.placeholder),void 0!==t.value&&(o.value=t.value),void 0!==t.checked&&(o.checked=t.checked),void 0!==t.multiple&&(o.multiple=t.multiple),t.style&&Object.assign(o.style,t.style),t.attributes)for(const[e,n]of Object.entries(t.attributes))o.setAttribute(e,n);void 0!==t.min&&(o.min=t.min),void 0!==t.max&&(o.max=t.max),void 0!==t.step&&(o.step=t.step)}return o};GeoLeaf.UI._buildFilterControl=function(e,n,r){if(!e||!e.id||!e.type)return null;const i=o("div",{className:"gl-filter-panel__group",attributes:{"data-gl-filter-id":e.id}});let a=null;e.label&&!r&&(a=o("label",{className:"gl-filter-panel__label",textContent:e.label}),i.appendChild(a));let l=null;if("select"===e.type||"multiselect"===e.type){const t=o("select",{className:"gl-filter-panel__control gl-filter-panel__control--select",name:e.id,id:"gl-filter-"+e.id});a&&a.setAttribute("for",t.id),"multiselect"===e.type&&(t.multiple=1),e.optionsFrom&&GeoLeaf.UI._populateSelectOptionsFromTaxonomy?.(t,n,e.optionsFrom),l=t}else if("range"===e.type){const t=o("div",{className:"gl-filter-panel__range-wrapper"}),n=o("input",{type:"range",className:"gl-filter-panel__control gl-filter-panel__control--range",id:"gl-filter-"+e.id,name:e.id});a&&a.setAttribute("for",n.id),"number"==typeof e.min&&(n.min=String(e.min)),"number"==typeof e.max&&(n.max=String(e.max)),"number"==typeof e.step&&(n.step=String(e.step));const r=o("span",{className:"gl-filter-panel__range-value"});let i;i="number"==typeof e.default?e.default:n.min&&n.max?(parseFloat(n.min)+parseFloat(n.max))/2:n.min?parseFloat(n.min):0,isNaN(i)||(n.value=String(i),r.textContent=i.toString().replace(".",",")),n.addEventListener("input",function(){const e=parseFloat(n.value);isNaN(e)||(r.textContent=e.toString().replace(".",","))}),t.appendChild(n),t.appendChild(r),l=t}else if("tree"===e.type||"tree-category"===e.type||"categoryTree"===e.type)l=o("div",{className:"gl-filter-panel__tree gl-filter-panel__tree--lazy",attributes:{"data-lazy-type":"categories","data-filter-id":e.id}});else if("checkbox-group"===e.type){const t=o("div",{className:"gl-filter-panel__checkbox-group"});Array.isArray(e.options)&&e.options.forEach(function(n){const r=o("label",{className:"gl-filter-panel__checkbox-label"}),i=o("input",{type:"checkbox",className:"gl-filter-panel__checkbox",name:e.id,value:n.id,checked:!!n.checked,attributes:{"data-filter-option-id":n.id}}),a=o("span",{className:"gl-filter-panel__checkbox-text",textContent:n.label||n.id});r.appendChild(i),r.appendChild(a),t.appendChild(r)}),l=t}else if("search"===e.type){const t=o("input",{type:"text",className:"gl-filter-panel__control gl-filter-panel__control--search",name:e.id,placeholder:e.placeholder||"Filtrer..."});Array.isArray(e.searchFields)&&t.setAttribute("data-search-fields",e.searchFields.join(",")),l=t}else if("proximity"===e.type){const n=o("div",{className:"gl-filter-panel__proximity"});if(e.label){const t=o("h3",{className:"gl-filter-panel__proximity-title",textContent:e.label});n.appendChild(t)}const r=o("button",{type:"button",className:"gl-btn gl-btn--secondary gl-filter-panel__proximity-btn",attributes:{"data-filter-proximity-btn":"true"},textContent:e.buttonLabel||"Activer"});n.appendChild(r);const i=o("div",{className:"gl-filter-panel__proximity-range",style:{display:"none"}}),a=o("label",{className:"gl-filter-panel__label",textContent:"Rayon (km)",attributes:{for:"gl-filter-proximity-radius"}});i.appendChild(a);const s=o("div",{className:"gl-filter-panel__range-wrapper"});let c=1,u=50,d=1,f=10;try{const e=GeoLeaf.Config?.getActiveProfile?.();if(e){const t=e.panels&&e.panels.search||e.search;t&&("number"==typeof t.radiusMin&&t.radiusMin>0&&(c=t.radiusMin),"number"==typeof t.radiusMax&&t.radiusMax>0&&(u=t.radiusMax),"number"==typeof t.radiusStep&&t.radiusStep>0&&(d=t.radiusStep),"number"==typeof t.radiusDefault&&t.radiusDefault>0&&(f=t.radiusDefault),f=Math.max(c,Math.min(f,u)))}}catch(e){t?.warn?.("[GeoLeaf.UI] Erreur lecture radius config:",e)}const p=o("input",{type:"range",className:"gl-filter-panel__control gl-filter-panel__control--range",id:"gl-filter-proximity-radius",name:e.id+"_radius",min:String(c),max:String(u),step:String(d),value:String(f),attributes:{"data-filter-proximity-radius":"true"}}),g=o("span",{className:"gl-filter-panel__range-value",textContent:String(f)});p.addEventListener("input",function(){g.textContent=p.value}),s.appendChild(p),s.appendChild(g),i.appendChild(s);const y=o("p",{className:"gl-filter-panel__proximity-instruction",textContent:e.instructionText||"Cliquez sur la carte",style:{display:"none"}});i.appendChild(y),n.appendChild(i),l=n}else"multiselect-tags"!==e.type&&"tags"!==e.id||(l=o("div",{className:"gl-filter-panel__tags-container",attributes:{"data-lazy-type":"tags","data-filter-id":e.id}}));if(!l)return null;if(a&&l instanceof HTMLElement&&!l.id){const t="gl-filter-"+e.id;l.id=t,a.setAttribute("for",t)}return i.appendChild(l),i}}(window),window._buildCategoryTreeContent=function(e){const t=GeoLeaf.Config&&"function"==typeof GeoLeaf.Config.getActiveProfile?GeoLeaf.Config.getActiveProfile():null;if(!t||!t.taxonomy||!t.taxonomy.categories)return'<div class="gl-empty-state">Aucune cat\xe9gorie disponible</div>';const o=t.taxonomy.categories,n=e.usedIds,r=GeoLeaf.Security&&"function"==typeof GeoLeaf.Security.escapeHtml?function(e){return GeoLeaf.Security.escapeHtml(e)}:function(e){return String(e||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},i=new Set;n.forEach(function(e){i.add(e.toLowerCase())});const a=Object.keys(o).filter(e=>i.has(e.toLowerCase()));if(0===a.length)return'<div class="gl-empty-state">ND - Non disponible</div>';let l='<ul class="gl-filter-tree gl-filter-tree--root">';return a.forEach(function(e){const t=o[e]||{},n=t.subcategories||{},a=Object.keys(n).filter(e=>i.has(e.toLowerCase())),s=a.length>0;l+='<li class="gl-filter-tree__item gl-filter-tree__item--category">',l+='<div class="gl-filter-tree__row">',l+=s?'<span class="gl-filter-tree__arrow" data-category-id="'+r(e)+'">\u25b6</span>':'<span class="gl-filter-tree__spacer"></span>',l+='<label class="gl-filter-tree__label gl-filter-tree__label--category">',l+='<input type="checkbox" class="gl-filter-tree__checkbox gl-filter-tree__checkbox--category" ',l+='name="categories_category" value="'+r(e)+'" ',l+='data-gl-filter-category-id="'+r(e)+'">',l+='<span class="gl-filter-tree__text">'+r(t.label||e)+"</span>",l+="</label>",l+="</div>",s&&(l+='<ul class="gl-filter-tree gl-filter-tree--subcategories">',a.forEach(function(t){const o=n[t]||{};l+='<li class="gl-filter-tree__item gl-filter-tree__item--subcategory">',l+='<label class="gl-filter-tree__label gl-filter-tree__label--subcategory">',l+='<input type="checkbox" class="gl-filter-tree__checkbox gl-filter-tree__checkbox--subcategory" ',l+='name="categories_subcategory" value="'+r(t)+'" ',l+='data-gl-filter-category-id="'+r(e)+'" ',l+='data-gl-filter-subcategory-id="'+r(t)+'">',l+='<span class="gl-filter-tree__text">'+r(o.label||t)+"</span>",l+="</label>",l+="</li>"}),l+="</ul>"),l+="</li>"}),l+="</ul>",l},window._buildTagsListContent=function(e){if(!e||0===e.length)return'<div class="gl-empty-state">ND - Non disponible</div>';const t=GeoLeaf.Security&&"function"==typeof GeoLeaf.Security.escapeHtml?function(e){return GeoLeaf.Security.escapeHtml(e)}:function(e){return String(e||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")};let o="";return e.forEach(function(e){o+='<span class="gl-filter-panel__tag-badge" data-tag-value="'+t(e)+'">'+t(e)+"</span>"}),o},window._attachCategoryTreeListeners=function(e){e.querySelectorAll(".gl-filter-tree__arrow").forEach(function(e){e.addEventListener("click",function(e){e.stopPropagation();const t=this.closest(".gl-filter-tree__item--category");t.querySelector(".gl-filter-tree--subcategories")&&(t.classList.contains("is-expanded")?(t.classList.remove("is-expanded"),this.textContent="\u25b6"):(t.classList.add("is-expanded"),this.textContent="\u25bc"))})}),e.querySelectorAll(".gl-filter-tree__checkbox--category").forEach(function(e){e.addEventListener("change",function(){this.closest(".gl-filter-tree__item--category").querySelectorAll(".gl-filter-tree__checkbox--subcategory").forEach(function(t){t.checked=e.checked}),e.indeterminate=0})}),e.querySelectorAll(".gl-filter-tree__checkbox--subcategory").forEach(function(e){e.addEventListener("change",function(){const e=this.closest(".gl-filter-tree__item--category"),t=e.querySelector(".gl-filter-tree__checkbox--category"),o=e.querySelectorAll(".gl-filter-tree__checkbox--subcategory"),n=Array.from(o).filter(e=>e.checked).length,r=o.length;0===n?(t.checked=0,t.indeterminate=0):n===r?(t.checked=1,t.indeterminate=0):(t.checked=0,t.indeterminate=1)})})},window._attachTagsListeners=function(e){e.querySelectorAll(".gl-filter-panel__tag-badge").forEach(function(e){e.addEventListener("click",function(){this.classList.toggle("is-selected")})})}),T||(T=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=()=>GeoLeaf.Log||console;GeoLeaf._UIFilterPanelShared=GeoLeaf._UIFilterPanelShared||{},GeoLeaf._UIFilterPanelShared.featureToPoiLike=function(e){if(!e||!e.geometry||!e.properties)return null;const t=e.geometry;if(!t||-1===t.type?.toLowerCase().indexOf("point"))return null;const o=Array.isArray(t.coordinates)?t.coordinates:null,n=o&&o.length>=2?[o[1],o[0]]:null,r=e.properties||{},i=Object.assign({},r);return!i.title&&r.name&&(i.title=r.name),!i.id&&e.id&&(i.id=e.id),!i.latlng&&n&&(i.latlng=n),!i.attributes&&r.attributes&&(i.attributes=r.attributes),i},GeoLeaf._UIFilterPanelShared.featureToRouteLike=function(e){if(!e||!e.geometry||!e.properties)return null;const t=e.geometry;if(!t||-1===t.type?.toLowerCase().indexOf("line"))return null;const o=e.properties||{};if(!Object.keys(o).some(e=>!["fid","name","Name","region","REGION","Region"].includes(e))&&(void 0!==o.fid||o.Name))return null;const n=Object.assign({},o);return!n.title&&o.name&&(n.title=o.name),!n.id&&e.id&&(n.id=e.id),n.geometry=t,n},GeoLeaf._UIFilterPanelShared.getBasePois=function(){const o=t(),n=GeoLeaf._UIFilterPanelShared.featureToPoiLike;try{if(GeoLeaf.GeoJSON&&"function"==typeof GeoLeaf.GeoJSON.getFeatures){const e=(GeoLeaf.GeoJSON.getFeatures({geometryTypes:["point"]})||[]).map(n).filter(Boolean);if(e.length)return e}}catch(e){o.warn("[GeoLeaf.UI.FilterPanel] Erreur r\xe9cup\xe9ration POI via GeoJSON:",e)}try{if(GeoLeaf.Config){if("function"==typeof GeoLeaf.Config.get){const e=GeoLeaf.Config.get("poi");if(Array.isArray(e))return e}if(Array.isArray(GeoLeaf.Config._activeProfileData?.poi))return GeoLeaf.Config._activeProfileData.poi}}catch(e){o.warn("[GeoLeaf.UI.FilterPanel] Erreur r\xe9cup\xe9ration POI via Config:",e)}return e.cfg&&Array.isArray(e.cfg.poi)?e.cfg.poi:[]},GeoLeaf._UIFilterPanelShared.getBaseRoutes=function(){const o=t(),n=GeoLeaf._UIFilterPanelShared.featureToRouteLike;try{if(GeoLeaf.GeoJSON&&"function"==typeof GeoLeaf.GeoJSON.getFeatures){const e=(GeoLeaf.GeoJSON.getFeatures({geometryTypes:["line","linestring","multilinestring"]})||[]).map(n).filter(Boolean);if(e.length)return e}}catch(e){o.warn("[GeoLeaf.UI.FilterPanel] Erreur r\xe9cup\xe9ration routes via GeoJSON:",e)}try{if(GeoLeaf.Config){if("function"==typeof GeoLeaf.Config.get){const e=GeoLeaf.Config.get("routes");if(Array.isArray(e))return e}if(Array.isArray(GeoLeaf.Config._activeProfileData?.routes))return GeoLeaf.Config._activeProfileData.routes}}catch(e){o.warn("[GeoLeaf.UI.FilterPanel] Erreur r\xe9cup\xe9ration routes via Config:",e)}return e.cfg&&Array.isArray(e.cfg.routes)?e.cfg.routes:[]},GeoLeaf._UIFilterPanelShared.getFilterPanelElement=function(){let e=document.getElementById("gl-filter-panel");return e||(e=document.getElementById("gl-left-panel"),e||(t().warn("[GeoLeaf.UI.FilterPanel] Aucun conteneur de panneau de filtres trouv\xe9 (#gl-filter-panel / #gl-left-panel)."),null))},GeoLeaf._UIFilterPanelShared.getNestedValue=function(e,t){if(!e||!t)return null;const o=t.split(".");let n=e;for(let e=0;e<o.length;e++){if(null==n)return null;n=n[o[e]]}return n},GeoLeaf._UIFilterPanelShared.getRepresentativePoint=function(e){if(!e||!e.coordinates)return null;if("Polygon"===e.type||"MultiPolygon"===e.type){const t="Polygon"===e.type?e.coordinates[0][0]:e.coordinates[0][0][0];return t?{lng:t[0],lat:t[1]}:null}if("LineString"===e.type){const t=e.coordinates;if(t&&t.length>0){const e=Math.floor(t.length/2);return{lng:t[e][0],lat:t[e][1]}}}else if("MultiLineString"===e.type){const t=e.coordinates[0];if(t&&t.length>0){const e=Math.floor(t.length/2);return{lng:t[e][0],lat:t[e][1]}}}else{if("Point"===e.type)return{lng:e.coordinates[0],lat:e.coordinates[1]};if("MultiPoint"===e.type){const t=e.coordinates[0];return t?{lng:t[0],lat:t[1]}:null}}return null},GeoLeaf._UIFilterPanelShared.collectAllTags=function(e){const t=new Set;e.forEach(function(e){const o=e.properties||e,n=(o.attributes||e.attributes||{}).tags||o.tags||e.tags;Array.isArray(n)&&n.length>0&&n.forEach(function(e){e&&"string"==typeof e&&t.add(e)})});const o=Array.from(t);return o.sort(),o}}(window)),M||(M=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{};GeoLeaf._UIFilterPanelStateReader=GeoLeaf._UIFilterPanelStateReader||{},GeoLeaf._UIFilterPanelStateReader.getDefaultState=function(){return{categoriesTree:[],subCategoriesTree:[],minRating:NaN,hasMinRating:0,selectedTags:[],hasTags:0,dataTypes:{poi:1,routes:1},searchText:"",hasSearchText:0,proximity:{active:0,center:null,radius:10}}},GeoLeaf._UIFilterPanelStateReader.readFiltersFromPanel=function(e){const t=GeoLeaf._UIFilterPanelStateReader.getDefaultState();if(!e)return t;const o=e.querySelector("[data-gl-filter-id='dataTypes'] input[value='poi']"),n=e.querySelector("[data-gl-filter-id='dataTypes'] input[value='routes']");o&&(t.dataTypes.poi=o.checked),n&&(t.dataTypes.routes=n.checked);const r=e.querySelector("[data-gl-filter-id='searchText'] input[type='text']");r&&""!==r.value.trim()&&(t.searchText=r.value.trim().toLowerCase(),t.hasSearchText=1);const i=e.querySelector("[data-gl-filter-id='proximity']");if(i){const e="true"===i.getAttribute("data-proximity-active"),o=parseFloat(i.getAttribute("data-proximity-lat")),n=parseFloat(i.getAttribute("data-proximity-lng")),r=parseFloat(i.getAttribute("data-proximity-radius"));!e||isNaN(o)||isNaN(n)||isNaN(r)||(t.proximity.active=1,t.proximity.center={lat:o,lng:n},t.proximity.radius=r)}e.querySelectorAll("input.gl-filter-tree__checkbox--category:checked").forEach(function(e){const o=e.value;o&&t.categoriesTree.push(String(o))}),e.querySelectorAll("input.gl-filter-tree__checkbox--subcategory:checked").forEach(function(e){const o=e.getAttribute("data-gl-filter-subcategory-id");o&&t.subCategoriesTree.push(String(o))});const a=e.querySelector("[data-gl-filter-id='minRating'] input[type='range']");if(a&&""!==a.value){const e=parseFloat(a.value);isNaN(e)||(t.minRating=e,t.hasMinRating=e>0)}const l=e.querySelector("[data-gl-filter-id='tags'] .gl-filter-panel__tags-container");if(l){const e=l.querySelectorAll(".gl-filter-panel__tag-badge.is-selected"),o=Array.from(e).map(function(e){return e.getAttribute("data-tag-value")}).filter(Boolean);t.selectedTags=o,t.hasTags=o.length>0}return t},GeoLeaf._UIFilterPanelStateReader.resetControls=function(e){if(!e)return;e.querySelectorAll("[data-gl-filter-id='dataTypes'] input[type='checkbox']").forEach(function(e){e.checked=1});const t=e.querySelector("[data-gl-filter-id='searchText'] input[type='text']");t&&(t.value="");const o=e.querySelector("[data-gl-filter-id='proximity']");if(o){o.removeAttribute("data-proximity-active"),o.removeAttribute("data-proximity-lat"),o.removeAttribute("data-proximity-lng"),o.removeAttribute("data-proximity-radius");const e=o.querySelector(".gl-filter-panel__proximity-btn");e&&(e.classList.remove("is-active"),e.textContent=e.getAttribute("data-label-inactive")||"Activer");const t=o.querySelector(".gl-filter-panel__proximity-range");t&&(t.style.display="none");const n=o.querySelector(".gl-filter-panel__proximity-instruction");n&&(n.style.display="none"),GeoLeaf.UI&&GeoLeaf.UI._proximityCircle&&GeoLeaf.UI._proximityMap&&(GeoLeaf.UI._proximityMap.removeLayer(GeoLeaf.UI._proximityCircle),GeoLeaf.UI._proximityCircle=null),GeoLeaf.UI&&GeoLeaf.UI._proximityMarker&&GeoLeaf.UI._proximityMap&&(GeoLeaf.UI._proximityMap.removeLayer(GeoLeaf.UI._proximityMarker),GeoLeaf.UI._proximityMarker=null),GeoLeaf.UI&&(GeoLeaf.UI._proximityMode=0)}e.querySelectorAll(".gl-filter-tree__checkbox").forEach(function(e){e.checked=0}),e.querySelectorAll(".gl-filter-panel__tag-badge.is-selected").forEach(function(e){e.classList.remove("is-selected")}),e.querySelectorAll("select.gl-filter-panel__control--select").forEach(function(e){e.multiple?Array.from(e.options).forEach(function(e){e.selected=0}):e.value=""});const n=e.querySelector("[data-gl-filter-id='minRating'] input[type='range']"),r=e.querySelector("[data-gl-filter-id='minRating'] .gl-filter-panel__range-value");if(n){const e=""!==n.min?n.min:"0";n.value=e,r&&(r.textContent=String(e).replace(".",","))}}}(window)),x||(x=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log||console;GeoLeaf._UIFilterPanelLazyLoader={_cache:{},_openAccordions:new Set,loadCategories(e){const o=`categories_${e}`;if(this._cache[o])return t.debug("[LazyLoader] Cache HIT pour cat\xe9gories:",e),this._cache[o];t.debug("[LazyLoader] Cache MISS pour cat\xe9gories, scan en cours...");const n=this._scanCategories(e);return this._cache[o]=n,n},loadTags(e){const o=`tags_${e}`;if(this._cache[o])return t.debug("[LazyLoader] Cache HIT pour tags:",e),this._cache[o];t.debug("[LazyLoader] Cache MISS pour tags, scan en cours...");const n=this._scanTags(e);return this._cache[o]=n,n},_scanCategories(e){const o=performance.now(),n=this._getVisibleLayerIds(e);let r=[];try{GeoLeaf.GeoJSON&&"function"==typeof GeoLeaf.GeoJSON.getFeatures&&(r=GeoLeaf.GeoJSON.getFeatures()||[])}catch(e){return t.warn("[LazyLoader] Erreur r\xe9cup\xe9ration features:",e),{categories:new Map,usedIds:new Set}}const i=r.filter(e=>{const t=e.properties?._layerId||e.properties?.layerId||e._layerId;return n.includes(t)});t.debug(`[LazyLoader] Scan cat\xe9gories: ${i.length} features sur ${n.length} couches actives`);const a=new Set;i.forEach(e=>{const t=e.properties||{};t.categoryId&&a.add(t.categoryId),t.subcategoryId&&a.add(t.subcategoryId),t.subCategoryId&&a.add(t.subCategoryId)});const l=(performance.now()-o).toFixed(2);return t.info(`[LazyLoader] Scan cat\xe9gories termin\xe9 en ${l}ms: ${a.size} cat\xe9gories trouv\xe9es`),{usedIds:a,visibleLayerIds:n}},_scanTags(e){const o=performance.now(),n=this._getVisibleLayerIds(e);let r=[];try{GeoLeaf.GeoJSON&&"function"==typeof GeoLeaf.GeoJSON.getFeatures&&(r=GeoLeaf.GeoJSON.getFeatures()||[])}catch(e){return t.warn("[LazyLoader] Erreur r\xe9cup\xe9ration features:",e),[]}const i=r.filter(e=>{const t=e.properties?._layerId||e.properties?.layerId||e._layerId;return n.includes(t)}),a=new Set;i.forEach(e=>{const t=e.properties||{},o=(t.attributes||{}).tags||t.tags;Array.isArray(o)&&o.forEach(e=>{e&&"string"==typeof e&&a.add(e)})});const l=Array.from(a).sort(),s=(performance.now()-o).toFixed(2);return t.info(`[LazyLoader] Scan tags termin\xe9 en ${s}ms:`,{totalFeatures:r.length,visibleFeatures:i.length,tagsFound:l.length}),l},_getVisibleLayerIds(e){let o=[];try{GeoLeaf.GeoJSON&&"function"==typeof GeoLeaf.GeoJSON.getAllLayers&&(o=GeoLeaf.GeoJSON.getAllLayers().filter(e=>1==e.visible).map(e=>e.id),t.debug(`[LazyLoader] ${o.length} couches visibles trouv\xe9es:`,o))}catch(e){t.warn("[LazyLoader] Erreur r\xe9cup\xe9ration couches visibles:",e)}return o},markAccordionOpen(e,o){this._openAccordions.add({type:e,element:o}),t.debug(`[LazyLoader] Accord\xe9on "${e}" marqu\xe9 comme ouvert`)},markAccordionClosed(e){this._openAccordions.forEach(o=>{o.element===e&&(this._openAccordions.delete(o),t.debug(`[LazyLoader] Accord\xe9on "${o.type}" marqu\xe9 comme ferm\xe9`))})},invalidateCacheForTheme(e){delete this._cache[`categories_${e}`],delete this._cache[`tags_${e}`],t.info(`[LazyLoader] Cache invalid\xe9 pour th\xe8me: ${e}`)},clearCache(){this._cache={},t.info("[LazyLoader] Cache compl\xe8tement vid\xe9")},refreshOpenAccordions(){if(0===this._openAccordions.size)return void t.debug("[LazyLoader] Aucun accord\xe9on ouvert \xe0 rafra\xeechir");t.info(`[LazyLoader] Rafra\xeechissement de ${this._openAccordions.size} accord\xe9on(s) ouvert(s)`);const e=GeoLeaf.ThemeSelector?.getCurrentTheme();e?this._openAccordions.forEach(({type:o,element:n})=>{const r=this._saveCheckboxStates(n),i=n.querySelector("[data-lazy-type]");i?(n.dataset.lazyLoaded="false","categories"===o?this._rerenderCategories(i,e,r):"tags"===o&&this._rerenderTags(i,e,r),n.dataset.lazyLoaded="true"):t.warn("[LazyLoader] Zone [data-lazy-type] introuvable dans l'accord\xe9on")}):t.warn("[LazyLoader] Impossible de r\xe9cup\xe9rer le th\xe8me actif")},_rerenderCategories(e,o,n){const r=this.loadCategories(o);if("function"==typeof window._buildCategoryTreeContent){const t=window._buildCategoryTreeContent(r);e.innerHTML=t,"function"==typeof window._attachCategoryTreeListeners&&window._attachCategoryTreeListeners(e),this._restoreCheckboxStates(e,n)}else t.warn("[LazyLoader] _buildCategoryTreeContent introuvable"),e.innerHTML='<div class="gl-empty-state">Erreur de chargement</div>'},_rerenderTags(e,o,n){const r=this.loadTags(o);if("function"==typeof window._buildTagsListContent){const t=window._buildTagsListContent(r);e.innerHTML=t,"function"==typeof window._attachTagsListeners&&window._attachTagsListeners(e),this._restoreCheckboxStates(e,n)}else t.warn("[LazyLoader] _buildTagsListContent introuvable"),e.innerHTML='<div class="gl-empty-state">Erreur de chargement</div>'},_saveCheckboxStates(e){const t={};return e.querySelectorAll('input[type="checkbox"]').forEach(e=>{const o=e.dataset.glFilterCategoryId,n=e.dataset.glFilterSubcategoryId,r=e.value;let i;n?i=`${o}:${n}`:o?i=o:r&&(i=r),i&&(t[i]=e.checked)}),t},_restoreCheckboxStates(e,o){if(!o||0===Object.keys(o).length)return;const n=e.querySelectorAll('input[type="checkbox"]');let r=0;n.forEach(e=>{const t=e.dataset.glFilterCategoryId,n=e.dataset.glFilterSubcategoryId,i=e.value;let a;n?a=`${t}:${n}`:t?a=t:i&&(a=i),a&&void 0!==o[a]&&(e.checked=o[a],r++)}),t.debug(`[LazyLoader] ${r} \xe9tats de checkbox restaur\xe9s`)}},document.addEventListener("geoleaf:theme:applied",()=>{t.info("[LazyLoader] \xc9v\xe9nement theme:applied d\xe9tect\xe9 \u2014 invalidation compl\xe8te"),GeoLeaf._UIFilterPanelLazyLoader.clearCache();const e=document.querySelectorAll(".gl-filter-panel__group--accordion[data-lazy-loaded]");e.forEach(e=>{e.dataset.lazyLoaded="false"}),t.debug(`[LazyLoader] ${e.length} flag(s) data-lazy-loaded r\xe9initialis\xe9(s)`),GeoLeaf._UIFilterPanelLazyLoader.refreshOpenAccordions()}),document.addEventListener("geoleaf:geojson:visibility-changed",e=>{const o=e.detail||{};t.info("[LazyLoader] Visibilit\xe9 couche chang\xe9e:",o.layerId,o.visible);const n=GeoLeaf.ThemeSelector?.getCurrentTheme();n&&(GeoLeaf._UIFilterPanelLazyLoader.invalidateCacheForTheme(n),GeoLeaf._UIFilterPanelLazyLoader.refreshOpenAccordions())})}(window)),N||(N=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=()=>GeoLeaf.Log||console,o=()=>GeoLeaf._UIFilterPanelShared,n=()=>GeoLeaf._UIFilterPanelStateReader;GeoLeaf._UIFilterPanelApplier=GeoLeaf._UIFilterPanelApplier||{};let r=0,i=null,a=0;GeoLeaf._UIFilterPanelApplier.destroy=function(){i&&(clearTimeout(i),i=null)},GeoLeaf._UIFilterPanelApplier.refreshPoiLayer=function(e){const o=t(),n=GeoLeaf.Config,r=n&&"function"==typeof n.get?n.get("poiConfig"):null;r&&0==r.enabled?o.debug("[GeoLeaf.UI.FilterPanel] Syst\xe8me POI d\xe9sactiv\xe9, pas de rafra\xeechissement de la couche POI."):GeoLeaf.POI?("function"==typeof GeoLeaf.POI._clearAllForTests?GeoLeaf.POI._clearAllForTests():o.warn("[GeoLeaf.UI.FilterPanel] GeoLeaf.POI._clearAllForTests indisponible."),e.forEach(function(e){try{GeoLeaf.POI.addPoi(e)}catch(t){o.warn("[GeoLeaf.UI.FilterPanel] Impossible d'ajouter un POI filtr\xe9:",e,t)}}),o.debug(`[GeoLeaf.UI.FilterPanel] refreshPoiLayer: ${e.length} POI visibles`)):o.warn("[GeoLeaf.UI.FilterPanel] GeoLeaf.POI indisponible, pas de rafra\xeechissement de la couche POI.")},GeoLeaf._UIFilterPanelApplier.filterGeoJSONLayers=function(e){const n=t(),r=o();if(!GeoLeaf.GeoJSON||"function"!=typeof GeoLeaf.GeoJSON.filterFeatures)return;const i=e.categoriesTree&&e.categoriesTree.length>0,a=e.subCategoriesTree&&e.subCategoriesTree.length>0,l=e.hasTags&&e.selectedTags&&e.selectedTags.length>0,s=e.selectedTags||[],c=e.proximity&&e.proximity.active,u=e.hasSearchText&&e.searchText,d=e.searchText||"",f=GeoLeaf.Utils&&"function"==typeof GeoLeaf.Utils.getDistance?GeoLeaf.Utils.getDistance:null,p=()=>(t,o)=>{const p=t.properties||{};if(u&&!((e,t)=>{if(!u)return 1;const o=(e=>{try{const t=GeoLeaf.GeoJSON.getLayerData(e);if(t&&t.config){if(t.config.search&&Array.isArray(t.config.search.indexingFields))return t.config.search.indexingFields;if(Array.isArray(t.config.indexingFields))return t.config.indexingFields;if(Array.isArray(t.config.searchFields))return t.config.searchFields}}catch(e){n.warn("[GeoLeaf.UI.FilterPanel] Erreur r\xe9cup\xe9ration champs de recherche:",e)}try{const e=GeoLeaf.Config&&GeoLeaf.Config._activeProfileData;if(e&&e.search&&e.search.filters){const t=e.search.filters.find(e=>"search"===e.type);if(t&&Array.isArray(t.searchFields))return t.searchFields}}catch(e){n.warn("[GeoLeaf.UI.FilterPanel] Erreur r\xe9cup\xe9ration champs par d\xe9faut:",e)}return["title","description","properties.title","properties.name","properties.description","attributes.nom"]})(t),i=d.toLowerCase();for(let t=0;t<o.length;t++){let n=o[t],a=null,l=n;if(n.startsWith("properties.")&&(l=n.substring(11)),e.properties&&(a=r.getNestedValue(e.properties,l)),a||(a=r.getNestedValue(e,n)),a&&String(a).toLowerCase().includes(i))return 1}return 0})(t,o))return 0;if(i||a){const t=p.categoryId||p.category||null,o=p.subcategoryId||p.subCategoryId||p.subcategory||p.sub_category||null;if(!t&&!o)return 0;if(a&&(!o||!e.subCategoriesTree.includes(String(o))))return 0;if(i&&!a&&(!t||!e.categoriesTree.includes(String(t))))return 0}if(l){let e=p.tags||[];if(Array.isArray(e)||(e="string"==typeof e?e.split(/[,;]+/):[]),e=e.map(e=>String(e).trim()).filter(Boolean),!s.some(t=>e.includes(t)))return 0}if(c&&e.proximity.center&&f){const o=r.getRepresentativePoint(t.geometry);if(o&&f(e.proximity.center.lat,e.proximity.center.lng,o.lat,o.lng)>e.proximity.radius)return 0}return 1};GeoLeaf.GeoJSON.filterFeatures(p(),{geometryType:"polygon"}),GeoLeaf.GeoJSON.filterFeatures(p(),{geometryType:"line"}),GeoLeaf.GeoJSON.filterFeatures(p(),{geometryType:"point"})},GeoLeaf._UIFilterPanelApplier.applyFiltersNow=function(e,t){!function(e,t){i&&clearTimeout(i),a=t||0,i=setTimeout(()=>{GeoLeaf._UIFilterPanelApplier._applyFiltersImmediate(e,a)},300)}(e,t)},GeoLeaf._UIFilterPanelApplier._applyFiltersImmediate=function(e,i){const a=t(),l=o(),s=n(),c=Date.now();if(c-r<100)return;r=c;const u=l.getBasePois(),d=l.getBaseRoutes(),f=s.readFiltersFromPanel(e);if(GeoLeaf._UIFilterPanelApplier.filterGeoJSONLayers(f),!u.length&&!d.length)return void a.info("[GeoLeaf.UI.FilterPanel] Aucun POI ni route source trouv\xe9.");if(GeoLeaf.Route&&"function"==typeof GeoLeaf.Route.isInitialized&&GeoLeaf.Route.isInitialized())if(f.dataTypes.routes)if(i)GeoLeaf.Route.show();else{let e=d;e=GeoLeaf.Filters&&"function"==typeof GeoLeaf.Filters.filterRouteList?GeoLeaf.Filters.filterRouteList(d,f):d,a.info("[GeoLeaf.UI.FilterPanel] Filtres appliqu\xe9s sur les routes.",{total:d.length,result:e.length}),"function"==typeof GeoLeaf.Route.filterVisibility?GeoLeaf.Route.filterVisibility(e):"function"==typeof GeoLeaf.Route.loadFromConfig&&GeoLeaf.Route.loadFromConfig(e),GeoLeaf.Route.show()}else GeoLeaf.Route.hide();const p=GeoLeaf._UIFilterPanelApplier.filterPoiList(u,f);a.info("[GeoLeaf.UI.FilterPanel] Filtres appliqu\xe9s sur les POI.",{total:u.length,result:p.length,filters:f}),GeoLeaf._UIFilterPanelApplier.refreshPoiLayer(p)},GeoLeaf._UIFilterPanelApplier.filterPoiList=function(e,o){return GeoLeaf.Filters&&"function"==typeof GeoLeaf.Filters.filterPoiList?GeoLeaf.Filters.filterPoiList(e,o):(t().warn("[GeoLeaf.UI.FilterPanel] Module Filters non charg\xe9, retour liste compl\xe8te"),e||[])},GeoLeaf._UIFilterPanelApplier.filterRouteList=function(e,o){return GeoLeaf.Filters&&"function"==typeof GeoLeaf.Filters.filterRouteList?GeoLeaf.Filters.filterRouteList(e,o):(t().warn("[GeoLeaf.UI.FilterPanel] Module Filters non charg\xe9, retour liste compl\xe8te"),e||[])},GeoLeaf._UIFilterPanelApplier.applyFiltersInitial=function(){const e=t(),r=o(),i=n(),a=r.getFilterPanelElement();if(!a)return void e.warn("[GeoLeaf.UI.FilterPanel] Panneau de filtres non trouv\xe9, impossible d'appliquer les filtres initiaux.");e.info("[GeoLeaf.UI.FilterPanel] Application des filtres initiaux...");const l=i.readFiltersFromPanel(a),s=r.getBasePois(),c=r.getBaseRoutes();if(!s.length&&!c.length)return void e.info("[GeoLeaf.UI.FilterPanel] Aucun POI ni route source trouv\xe9.");if(GeoLeaf.Route&&"function"==typeof GeoLeaf.Route.isInitialized&&GeoLeaf.Route.isInitialized())if(l.dataTypes.routes){let e=GeoLeaf._UIFilterPanelApplier.filterRouteList(c,l);"function"==typeof GeoLeaf.Route.loadFromConfig&&GeoLeaf.Route.loadFromConfig(e),GeoLeaf.Route.show()}else GeoLeaf.Route.hide();const u=GeoLeaf._UIFilterPanelApplier.filterPoiList(s,l);e.info("[GeoLeaf.UI.FilterPanel] POI filtr\xe9s pour chargement initial.",{total:s.length,result:u.length}),GeoLeaf._UIFilterPanelApplier.refreshPoiLayer(u)}}(window)),F||(F=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=(e,t,...o)=>GeoLeaf.Utils&&GeoLeaf.Utils.createElement?GeoLeaf.Utils.createElement(e,t,...o):document.createElement(e),o=()=>GeoLeaf.Log||console,n=()=>GeoLeaf._UIFilterPanelShared;GeoLeaf._UIFilterPanelRenderer=GeoLeaf._UIFilterPanelRenderer||{},GeoLeaf._UIFilterPanelRenderer._eventCleanups=[],GeoLeaf._UIFilterPanelRenderer.buildFilterPanelFromActiveProfile=function(e){const r=o(),i=n(),a=GeoLeaf._UIFilterPanelStateReader,l=GeoLeaf._UIFilterPanelApplier;r&&r.debug("[FilterPanel] buildFilterPanelFromActiveProfile APPEL\xc9, options:",e);const s=GeoLeaf.UI._getActiveProfileConfig();if(r&&r.debug("[FilterPanel] Profile r\xe9cup\xe9r\xe9:",s),!s)return void r.warn("[GeoLeaf.UI.FilterPanel] Aucun profil actif trouv\xe9");r.info("[GeoLeaf.UI.FilterPanel] Profil actif:",s.id||"unknown");const c=s.panels&&s.panels.search||s.search;if(r&&r.debug("[FilterPanel] searchPanel:",c),!c)return void r.warn("[GeoLeaf.UI.FilterPanel] Aucune configuration search/panels.search dans le profil");const u=c&&Array.isArray(c.filters)?c.filters:null;if(r&&r.debug("[FilterPanel] Filters:",u),!u||!u.length)return void r.warn("[GeoLeaf.UI.FilterPanel] Aucun filtre d\xe9fini dans profile.search.filters pour le profil actif. Filters:",u);r.info("[GeoLeaf.UI.FilterPanel] Nombre de filtres trouv\xe9s:",u.length);const d=e&&e.container||i.getFilterPanelElement();if(!d)return void r.warn("[GeoLeaf.UI.FilterPanel] Conteneur de panneau introuvable");for(;d.firstChild;)d.removeChild(d.firstChild);d.classList.add("gl-filter-panel");const f=t("div",{className:"gl-filter-panel__header"}),p=t("h2",{className:"gl-filter-panel__title",textContent:c.title||"Filtres"});f.appendChild(p);const g=t("button",{type:"button",className:"gl-filter-panel__toggle-btn",attributes:{"data-gl-action":"filter-close","aria-label":"Fermer le panneau"}}),y=t("span",{className:"gl-filter-panel__toggle-icon",textContent:"\u25c0"});g.appendChild(y),f.appendChild(g),d.appendChild(f);const h=t("div",{className:"gl-filter-panel__body"}),m=document.createDocumentFragment();u.forEach(function(e){const o="categories"===e.id||"tags"===e.id||"proximity"===e.type,n=GeoLeaf.UI._buildFilterControl(e,s,o);if(n)if("categories"===e.id||"tags"===e.id){const o=t("div",{className:"gl-filter-panel__group--accordion",attributes:{"data-accordion-for":e.id}}),r=t("div",{className:"gl-filter-panel__accordion-header"}),i=t("h3",{className:"gl-filter-panel__accordion-title",textContent:e.label||("categories"===e.id?"Afficher les cat\xe9gories":"Afficher les tags")}),a=t("span",{className:"gl-filter-panel__accordion-arrow",textContent:"\u25b6"});r.appendChild(i),r.appendChild(a);const l=t("div",{className:"gl-filter-panel__accordion-body"}),s=t("div");s.appendChild(n),l.appendChild(s);const c=function(){requestAnimationFrame(function(){if(o.classList.toggle("is-expanded"),o.classList.contains("is-expanded"))GeoLeaf._UIFilterPanelRenderer._loadAccordionContentIfNeeded(o,e);else{const e=GeoLeaf._UIFilterPanelLazyLoader;e&&e.markAccordionClosed(o)}})},u=GeoLeaf.Utils?.events;u?GeoLeaf._UIFilterPanelRenderer._eventCleanups.push(u.on(r,"click",c,0,"FilterPanel.accordionToggle")):r.addEventListener("click",c),o.appendChild(r),o.appendChild(l),m.appendChild(o)}else m.appendChild(n)}),h.appendChild(m),d.appendChild(h);const b=t("div",{className:"gl-filter-panel__footer"}),_=t("button",{type:"button",className:"gl-btn gl-btn--accent gl-filter-panel__btn-apply",textContent:c.actions&&c.actions.applyLabel||"Appliquer"});b.appendChild(_);const v=t("button",{type:"button",className:"gl-btn gl-btn--subtle gl-filter-panel__btn-reset",textContent:c.actions&&c.actions.resetLabel||"R\xe9initialiser"});if(b.appendChild(v),d.appendChild(b),!d._glFilterHandlersBound){const e=GeoLeaf.Utils?.events,t=function(e){const t=e.target;return t.closest("[data-gl-action='filter-close']")?(e.preventDefault(),void GeoLeaf._UIFilterPanelRenderer.toggleFilterPanelVisibility(0)):t.classList.contains("gl-filter-panel__btn-reset")?(e.preventDefault(),a.resetControls(d),void l.applyFiltersNow(d,1)):t.classList.contains("gl-filter-panel__btn-apply")?(e.preventDefault(),void l.applyFiltersNow(d)):void 0};e?GeoLeaf._UIFilterPanelRenderer._eventCleanups.push(e.on(d,"click",t,0,"FilterPanel.containerClick")):d.addEventListener("click",t);const o=function(e){if(("Enter"===e.key||13===e.keyCode)&&e.target.closest("[data-gl-filter-id='searchText'] input[type='text']"))return e.preventDefault(),void l.applyFiltersNow(d)};e?GeoLeaf._UIFilterPanelRenderer._eventCleanups.push(e.on(d,"keydown",o,0,"FilterPanel.enterKey")):d.addEventListener("keydown",o),d._glFilterHandlersBound=1}d.classList.remove("is-open")},GeoLeaf._UIFilterPanelRenderer.toggleFilterPanelVisibility=function(e){const t=n().getFilterPanelElement();if(!t)return;const o=t.classList.contains("is-open");let r;r="boolean"==typeof e?e:!o,r?t.classList.add("is-open"):t.classList.remove("is-open");const i=document.getElementById("gl-filter-toggle");if(i){const e=i.querySelector(".gl-filter-toggle__icon");if(e)if(r){GeoLeaf.DOMSecurity.clearElementFast(e);const t=GeoLeaf.DOMSecurity.createSVGIcon(16,16,"M15 18l-6-6 6-6",{stroke:"currentColor",strokeWidth:"6",fill:"none"});e.appendChild(t),i.setAttribute("aria-label","Fermer le panneau de filtres")}else{GeoLeaf.DOMSecurity.clearElementFast(e);const t=GeoLeaf.DOMSecurity.createSVGIcon(16,16,"M9 6l6 6-6 6",{stroke:"currentColor",strokeWidth:"6",fill:"none"});e.appendChild(t),i.setAttribute("aria-label","Ouvrir le panneau de filtres")}}},GeoLeaf._UIFilterPanelRenderer.initFilterToggle=function(){const e=o(),t=n(),r=document.getElementById("gl-filter-toggle"),i=t.getFilterPanelElement();if(!r||!i)return void e.info("[GeoLeaf.UI.FilterPanel] Bouton toggle ou panneau filtres introuvable");const a=function(){const e=i.classList.contains("is-open"),t=r.querySelector(".gl-filter-toggle__icon");if(e){if(i.classList.remove("is-open"),t){GeoLeaf.DOMSecurity.clearElementFast(t);const e=GeoLeaf.DOMSecurity.createSVGIcon(16,16,"M9 6l6 6-6 6",{stroke:"currentColor",strokeWidth:"6",fill:"none"});t.appendChild(e)}r.setAttribute("aria-label","Ouvrir le panneau de filtres")}else{if(i.classList.add("is-open"),t){GeoLeaf.DOMSecurity.clearElementFast(t);const e=GeoLeaf.DOMSecurity.createSVGIcon(16,16,"M15 18l-6-6 6-6",{stroke:"currentColor",strokeWidth:"6",fill:"none"});t.appendChild(e)}r.setAttribute("aria-label","Fermer le panneau de filtres")}},l=GeoLeaf.Utils?.events;l?GeoLeaf._UIFilterPanelRenderer._eventCleanups.push(l.on(r,"click",a,0,"FilterPanel.toggleButton")):r.addEventListener("click",a),e.info("[GeoLeaf.UI.FilterPanel] Bouton toggle filtres initialis\xe9")},GeoLeaf._UIFilterPanelRenderer.refreshFilterTags=function(){const e=o(),t=n(),r=t.getFilterPanelElement();if(!r)return void e.warn("[GeoLeaf.UI.FilterPanel.refreshFilterTags] Panneau de filtres non trouv\xe9");const i=t.getBasePois(),a=t.getBaseRoutes(),l=i.concat(a);e.debug("[GeoLeaf.UI.FilterPanel.refreshFilterTags] Items:",i.length,"POI,",a.length,"routes");const s=t.collectAllTags(l);GeoLeaf._UIFilterPanelRenderer.populateTagsBadges(r,s)},GeoLeaf._UIFilterPanelRenderer.populateTagsBadges=function(e,n){const r=o(),i=e.querySelector("[data-gl-filter-id='tags']");if(!i)return void r.debug("[GeoLeaf.UI.FilterPanel] Wrapper tags non trouv\xe9 - probablement pas utilis\xe9 dans ce profil");const a=i.querySelector(".gl-filter-panel__tags-container");if(!a)return void r.warn("[GeoLeaf.UI.FilterPanel] Container tags non trouv\xe9");const l=e.querySelector("[data-accordion-for='tags']");for(r.debug("[GeoLeaf.UI.FilterPanel] Recherche accord\xe9on avec [data-accordion-for='tags']"),r.debug("[GeoLeaf.UI.FilterPanel] Accord\xe9on trouv\xe9:",l);a.firstChild;)a.removeChild(a.firstChild);if(!n.length)return r.debug("[GeoLeaf.UI.FilterPanel] Pas de tags (count:",n.length,")"),void(l?(l.style.display="none",r.info("[GeoLeaf.UI.FilterPanel] Accord\xe9on tags CACH\xc9 (display: none)")):r.warn("[GeoLeaf.UI.FilterPanel] Accord\xe9on tags non trouv\xe9 pour le cacher"));r.debug("[GeoLeaf.UI.FilterPanel] Tags d\xe9tect\xe9s (count:",n.length,")"),l&&(l.style.display="",r.info("[GeoLeaf.UI.FilterPanel] Accord\xe9on tags AFFICH\xc9"));const s=document.createDocumentFragment();n.forEach(function(e){const o=function(){this.classList.toggle("is-selected")},n=t("span",{className:"gl-filter-panel__tag-badge",textContent:e,attributes:{"data-tag-value":e},onClick:o}),r=GeoLeaf.Utils?.events;r?GeoLeaf._UIFilterPanelRenderer._eventCleanups.push(r.on(n,"click",o,0,"FilterPanel.tagBadge")):n.addEventListener("click",o),s.appendChild(n)}),a.appendChild(s)},GeoLeaf._UIFilterPanelRenderer.destroy=function(){const e=o();e&&e.debug("[FilterPanel] Cleaning up event listeners"),GeoLeaf._UIFilterPanelRenderer._eventCleanups&&(GeoLeaf._UIFilterPanelRenderer._eventCleanups.forEach(e=>{"function"==typeof e&&e()}),GeoLeaf._UIFilterPanelRenderer._eventCleanups=[]),GeoLeaf._UIFilterPanelApplier&&GeoLeaf._UIFilterPanelApplier.destroy&&GeoLeaf._UIFilterPanelApplier.destroy()},GeoLeaf._UIFilterPanelRenderer._loadAccordionContentIfNeeded=function(e){const t=o(),n=GeoLeaf._UIFilterPanelLazyLoader;if(!n)return void t.warn("[FilterPanel] LazyLoader non disponible");if("true"===e.dataset.lazyLoaded)return void t.debug("[FilterPanel] Accord\xe9on d\xe9j\xe0 charg\xe9 pour ce th\xe8me, skip");const r=e.querySelector("[data-lazy-type]");if(!r)return void t.debug("[FilterPanel] Pas de zone lazy dans cet accord\xe9on");const i=r.dataset.lazyType;t.info(`[FilterPanel] Chargement lazy du contenu: ${i}`);let a=GeoLeaf.ThemeSelector?.getCurrentTheme();if(!a){const e=GeoLeaf.Config&&"function"==typeof GeoLeaf.Config.getActiveProfile?GeoLeaf.Config.getActiveProfile():null;e&&e.themes&&e.themes.config&&e.themes.config.defautTheme&&(a=e.themes.config.defautTheme,t.info("[FilterPanel] Fallback sur le th\xe8me par d\xe9faut:",a))}a||(a="defaut",t.warn("[FilterPanel] Th\xe8me actif introuvable, utilisation de 'defaut'")),r.innerHTML='<div class="gl-filter-panel__loading">Chargement...</div>',setTimeout(()=>{try{if("categories"===i){const t=n.loadCategories(a);if(!t.usedIds||0===t.usedIds.size)return r.innerHTML='<div class="gl-filter-panel__empty">Aucune cat\xe9gorie disponible sur les couches visibles</div>',void(e.dataset.lazyLoaded="true");if("function"==typeof window._buildCategoryTreeContent){const e=window._buildCategoryTreeContent(t);r.innerHTML=e,"function"==typeof window._attachCategoryTreeListeners&&window._attachCategoryTreeListeners(r)}else r.innerHTML='<div class="gl-filter-panel__error">Erreur: fonction de construction introuvable</div>';n.markAccordionOpen("categories",e)}else if("tags"===i){const t=n.loadTags(a);if(!t||0===t.length)return r.innerHTML='<div class="gl-filter-panel__empty">Aucun tag disponible sur les couches visibles</div>',void(e.dataset.lazyLoaded="true");if("function"==typeof window._buildTagsListContent){const e=window._buildTagsListContent(t);r.innerHTML=e,"function"==typeof window._attachTagsListeners&&window._attachTagsListeners(r)}else r.innerHTML='<div class="gl-filter-panel__error">Erreur: fonction de construction introuvable</div>';n.markAccordionOpen("tags",e)}e.dataset.lazyLoaded="true"}catch(e){for(t.error("[FilterPanel] Erreur durant le chargement lazy:",e);r.firstChild;)r.removeChild(r.firstChild);const o=document.createElement("div");o.className="gl-filter-panel__error",o.textContent="Erreur: "+e.message,r.appendChild(o)}},10)}}(window)),U||(U=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=()=>GeoLeaf.Log||console;GeoLeaf._UIFilterPanelProximity=GeoLeaf._UIFilterPanelProximity||{},GeoLeaf._UIFilterPanelProximity._eventCleanups=[],GeoLeaf._UIFilterPanelProximity.initProximityFilter=function(e){const o=t();if(!e)return void o.warn("[GeoLeaf.UI.FilterPanel] Carte non disponible pour le filtre de proximit\xe9");GeoLeaf.UI._proximityMode=0,GeoLeaf.UI._proximityCircle=null,GeoLeaf.UI._proximityMarker=null,GeoLeaf.UI._proximityMap=e,GeoLeaf.UI._proximityClickHandler=null;const n=GeoLeaf.Utils?.events;if(n){const t=function(e){const t=e.target.closest("[data-filter-proximity-radius]");if(!t)return;const o=t.closest(".gl-filter-panel__proximity");if(!o)return;const n=o.closest("[data-gl-filter-id='proximity']");if(!n)return;const r=parseFloat(t.value);if(n.setAttribute("data-proximity-radius",r),GeoLeaf.UI._proximityCircle){const e=1e3*r;GeoLeaf.UI._proximityCircle.setRadius(e)}},o=function(t){const o=t.target.closest("[data-filter-proximity-btn]");o&&(t.preventDefault(),GeoLeaf._UIFilterPanelProximity.toggleProximityMode(o,e))};GeoLeaf._UIFilterPanelProximity._eventCleanups.push(n.on(document,"input",t,0,"ProximityFilter.radiusInput")),GeoLeaf._UIFilterPanelProximity._eventCleanups.push(n.on(document,"click",o,0,"ProximityFilter.buttonClick"))}else o.warn("[ProximityFilter] EventListenerManager not available - listeners will not be cleaned up"),document.addEventListener("input",function(e){const t=e.target.closest("[data-filter-proximity-radius]");if(!t)return;const o=t.closest(".gl-filter-panel__proximity");if(!o)return;const n=o.closest("[data-gl-filter-id='proximity']");if(!n)return;const r=parseFloat(t.value);if(n.setAttribute("data-proximity-radius",r),GeoLeaf.UI._proximityCircle){const e=1e3*r;GeoLeaf.UI._proximityCircle.setRadius(e)}}),document.addEventListener("click",function(t){const o=t.target.closest("[data-filter-proximity-btn]");o&&(t.preventDefault(),GeoLeaf._UIFilterPanelProximity.toggleProximityMode(o,e))});o.info("[GeoLeaf.UI.FilterPanel] Filtre de proximit\xe9 initialis\xe9")},GeoLeaf._UIFilterPanelProximity.destroy=function(){const e=t();GeoLeaf._UIFilterPanelProximity._eventCleanups&&GeoLeaf._UIFilterPanelProximity._eventCleanups.length>0&&(GeoLeaf._UIFilterPanelProximity._eventCleanups.forEach(e=>{"function"==typeof e&&e()}),GeoLeaf._UIFilterPanelProximity._eventCleanups=[],e.info("[ProximityFilter] Event listeners cleaned up")),GeoLeaf.UI._proximityCircle&&(GeoLeaf.UI._proximityMap.removeLayer(GeoLeaf.UI._proximityCircle),GeoLeaf.UI._proximityCircle=null),GeoLeaf.UI._proximityMarker&&(GeoLeaf.UI._proximityMap.removeLayer(GeoLeaf.UI._proximityMarker),GeoLeaf.UI._proximityMarker=null),GeoLeaf.UI._proximityMap=null,GeoLeaf.UI._proximityMode=0},GeoLeaf._UIFilterPanelProximity.toggleProximityMode=function(e,t){GeoLeaf.UI._proximityMode=!GeoLeaf.UI._proximityMode;const o=e.closest(".gl-filter-panel__proximity"),n=o.querySelector(".gl-filter-panel__proximity-range"),r=o.querySelector(".gl-filter-panel__proximity-instruction");GeoLeaf.UI._proximityMode?(e.textContent="D\xe9sactiver",e.classList.add("is-active"),n&&(n.style.display="block"),r&&(r.style.display="block"),GeoLeaf.UI._userPosition&&Date.now()-GeoLeaf.UI._userPosition.timestamp<3e5?GeoLeaf._UIFilterPanelProximity.activateGPSMode(o,t):GeoLeaf._UIFilterPanelProximity.activateManualMode(o,t)):GeoLeaf._UIFilterPanelProximity.deactivateProximityMode(e,o,t)},GeoLeaf._UIFilterPanelProximity.activateGPSMode=function(o,n){const r=t();r.info("[GeoLeaf.UI.FilterPanel] Utilisation de la position GPS pour la recherche par proximit\xe9");const i=o.querySelector("[data-filter-proximity-radius]"),a=i?parseFloat(i.value):10,l=1e3*a,s=o.closest("[data-gl-filter-id='proximity']");if(!s)return void r.warn("[GeoLeaf.UI.FilterPanel] Wrapper proximity non trouv\xe9");GeoLeaf.UI._proximityCircle&&n.removeLayer(GeoLeaf.UI._proximityCircle),GeoLeaf.UI._proximityMarker&&n.removeLayer(GeoLeaf.UI._proximityMarker);const c=e.L.latLng(GeoLeaf.UI._userPosition.lat,GeoLeaf.UI._userPosition.lng),u=GeoLeaf.Config.get("ui.interactiveShapes",0);GeoLeaf.UI._proximityCircle=e.L.circle(c,{radius:l,color:"#c2410c",fillColor:"#c2410c",fillOpacity:.2,weight:2,interactive:u}).addTo(n),GeoLeaf.UI._geolocationActive?(GeoLeaf.UI._proximityMarker=null,r.info("[GeoLeaf.UI.FilterPanel] Cercle de proximit\xe9 affich\xe9 autour du marqueur GPS")):(GeoLeaf.UI._proximityMarker=e.L.marker(c,{draggable:1,icon:e.L.divIcon({className:"gl-proximity-gps-marker",html:'<div style="width: 20px; height: 20px; background: #2563eb; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',iconSize:[20,20],iconAnchor:[10,10]})}).addTo(n),GeoLeaf.UI._proximityMarker.on("dragend",function(){const e=GeoLeaf.UI._proximityMarker.getLatLng();GeoLeaf.UI._proximityCircle&&GeoLeaf.UI._proximityCircle.setLatLng(e),s.setAttribute("data-proximity-lat",e.lat),s.setAttribute("data-proximity-lng",e.lng),r.info("[GeoLeaf.UI.FilterPanel] Point de proximit\xe9 GPS d\xe9plac\xe9:",{lat:e.lat,lng:e.lng,radius:a})})),s.setAttribute("data-proximity-lat",c.lat),s.setAttribute("data-proximity-lng",c.lng),s.setAttribute("data-proximity-radius",a),s.setAttribute("data-proximity-active","true"),n.setView(c,Math.max(n.getZoom(),14),{animate:1,duration:.5}),r.info("[GeoLeaf.UI.FilterPanel] Point de proximit\xe9 GPS d\xe9fini:",{lat:c.lat,lng:c.lng,radius:a}),GeoLeaf.UI._proximityClickHandler=null},GeoLeaf._UIFilterPanelProximity.activateManualMode=function(o,n){const r=t();r.info("[GeoLeaf.UI.FilterPanel] Mode manuel : cliquez sur la carte pour d\xe9finir le point de recherche"),n.getContainer().style.cursor="crosshair",GeoLeaf.UI._proximityClickHandler=function(t){const i=o.querySelector("[data-filter-proximity-radius]"),a=i?parseFloat(i.value):10,l=1e3*a,s=o.closest("[data-gl-filter-id='proximity']");if(!s)return void r.warn("[GeoLeaf.UI.FilterPanel] Wrapper proximity non trouv\xe9");GeoLeaf.UI._proximityCircle&&n.removeLayer(GeoLeaf.UI._proximityCircle),GeoLeaf.UI._proximityMarker&&n.removeLayer(GeoLeaf.UI._proximityMarker);const c=GeoLeaf.Config.get("ui.interactiveShapes",0);GeoLeaf.UI._proximityCircle=e.L.circle(t.latlng,{radius:l,color:"#c2410c",fillColor:"#c2410c",fillOpacity:.2,weight:2,interactive:c}).addTo(n),GeoLeaf.UI._proximityMarker=e.L.marker(t.latlng,{draggable:1}).addTo(n),GeoLeaf.UI._proximityMarker.on("dragend",function(){const e=GeoLeaf.UI._proximityMarker.getLatLng();GeoLeaf.UI._proximityCircle&&GeoLeaf.UI._proximityCircle.setLatLng(e),s.setAttribute("data-proximity-lat",e.lat),s.setAttribute("data-proximity-lng",e.lng),r.info("[GeoLeaf.UI.FilterPanel] Point de proximit\xe9 d\xe9plac\xe9:",{lat:e.lat,lng:e.lng,radius:a})}),s.setAttribute("data-proximity-lat",t.latlng.lat),s.setAttribute("data-proximity-lng",t.latlng.lng),s.setAttribute("data-proximity-radius",a),s.setAttribute("data-proximity-active","true"),n.getContainer().style.cursor="",r.info("[GeoLeaf.UI.FilterPanel] Point de proximit\xe9 d\xe9fini:",{lat:t.latlng.lat,lng:t.latlng.lng,radius:a}),n.off("click",GeoLeaf.UI._proximityClickHandler),GeoLeaf.UI._proximityClickHandler=null},n.on("click",GeoLeaf.UI._proximityClickHandler)},GeoLeaf._UIFilterPanelProximity.deactivateProximityMode=function(e,o,n){const r=t();e.textContent="Activer",e.classList.remove("is-active");const i=o.querySelector(".gl-filter-panel__proximity-range"),a=o.querySelector(".gl-filter-panel__proximity-instruction");i&&(i.style.display="none"),a&&(a.style.display="none"),n.getContainer().style.cursor="",GeoLeaf.UI._proximityClickHandler&&(n.off("click",GeoLeaf.UI._proximityClickHandler),GeoLeaf.UI._proximityClickHandler=null),GeoLeaf.UI._proximityCircle&&(n.removeLayer(GeoLeaf.UI._proximityCircle),GeoLeaf.UI._proximityCircle=null),GeoLeaf.UI._proximityMarker&&(n.removeLayer(GeoLeaf.UI._proximityMarker),GeoLeaf.UI._proximityMarker=null);const l=o.closest("[data-gl-filter-id='proximity']");l&&(l.removeAttribute("data-proximity-active"),l.removeAttribute("data-proximity-lat"),l.removeAttribute("data-proximity-lng")),r.info("[GeoLeaf.UI.FilterPanel] Mode proximit\xe9 d\xe9sactiv\xe9")}}(window)),k||(k=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=()=>GeoLeaf._UIFilterPanelShared,o=()=>GeoLeaf._UIFilterPanelApplier,n=()=>GeoLeaf._UIFilterPanelRenderer;GeoLeaf._UIFilterPanel=GeoLeaf._UIFilterPanel||{},GeoLeaf._UIFilterPanel.buildFilterPanelFromActiveProfile=function(e){const t=n();if(t&&t.buildFilterPanelFromActiveProfile)return t.buildFilterPanelFromActiveProfile(e);(GeoLeaf.Log||console).error("[GeoLeaf.UI.FilterPanel] Module Renderer non charg\xe9")},GeoLeaf._UIFilterPanel.toggleFilterPanelVisibility=function(e){const t=n();if(t&&t.toggleFilterPanelVisibility)return t.toggleFilterPanelVisibility(e)},GeoLeaf._UIFilterPanel.initFilterToggle=function(){const e=n();if(e&&e.initFilterToggle)return e.initFilterToggle()},GeoLeaf._UIFilterPanel.refreshFilterTags=function(){const e=n();if(e&&e.refreshFilterTags)return e.refreshFilterTags()},GeoLeaf._UIFilterPanel.applyFiltersInitial=function(){const e=o();if(e&&e.applyFiltersInitial)return e.applyFiltersInitial()},GeoLeaf._UIFilterPanel.initProximityFilter=function(e){const t=GeoLeaf._UIFilterPanelProximity;if(t&&t.initProximityFilter)return t.initProximityFilter(e)},GeoLeaf._UIFilterPanel._getFilterPanelElement=function(){const e=t();return e&&e.getFilterPanelElement?e.getFilterPanelElement():null},GeoLeaf._UIFilterPanel._getBasePois=function(){const e=t();return e&&e.getBasePois?e.getBasePois():[]},GeoLeaf._UIFilterPanel._getBaseRoutes=function(){const e=t();return e&&e.getBaseRoutes?e.getBaseRoutes():[]},GeoLeaf._UIFilterPanel._readFiltersFromPanel=function(e){const t=GeoLeaf._UIFilterPanelStateReader;return t&&t.readFiltersFromPanel?t.readFiltersFromPanel(e):{}},GeoLeaf._UIFilterPanel._filterPoiList=function(e,t){const n=o();return n&&n.filterPoiList?n.filterPoiList(e,t):e||[]},GeoLeaf._UIFilterPanel._filterRouteList=function(e,t){const n=o();return n&&n.filterRouteList?n.filterRouteList(e,t):e||[]},GeoLeaf._UIFilterPanel._refreshPoiLayer=function(e){const t=o();if(t&&t.refreshPoiLayer)return t.refreshPoiLayer(e)}}(window)),R||(R=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=["_UIFilterPanelShared","_UIFilterPanelStateReader","_UIFilterPanelApplier","_UIFilterPanelRenderer","_UIFilterPanelProximity","_UIFilterPanel"].filter(e=>!GeoLeaf[e]);if(t.length>0){const e=GeoLeaf.Log||console;e.error("[GeoLeaf.UI.FilterPanel] Sous-modules manquants:",t.join(", ")),e.error("[GeoLeaf.UI.FilterPanel] Assurez-vous de charger les modules filter-panel/*.js avant filter-panel.js")}}(window)),D||(D=1,function(e){const GeoLeaf=e.GeoLeaf||(e.GeoLeaf={}),t=GeoLeaf.Log;GeoLeaf.UI=GeoLeaf.UI||{};const o=(e,t,...o)=>{if(GeoLeaf.Utils&&GeoLeaf.Utils.createElement)return GeoLeaf.Utils.createElement(e,t,...o);const n=document.createElement(e);return t&&(t.className&&(n.className=t.className),t.textContent&&(n.textContent=t.textContent)),n};function n(){const e={theme:!!GeoLeaf._UITheme,controls:!!GeoLeaf._UIControls,panelBuilder:!(!GeoLeaf._UIPanelBuilder&&!GeoLeaf.UI.PanelBuilder),filterPanel:!!GeoLeaf._UIFilterPanel,notifications:!!GeoLeaf._UINotifications,eventDelegation:!!GeoLeaf._UIEventDelegation,filterStateManager:!!GeoLeaf._UIFilterStateManager},o=Object.entries(e).filter(([e,t])=>!t).map(([e])=>e);return o.length>0&&t&&t.warn("[UI.Orchestrator] Modules manquants:",o.join(", ")),{modules:e,missing:o,allAvailable:0===o.length}}GeoLeaf._UITheme&&(GeoLeaf.UI.initThemeToggle=GeoLeaf._UITheme.initThemeToggle,GeoLeaf.UI.toggleTheme=GeoLeaf._UITheme.toggleTheme,GeoLeaf.UI.applyTheme=GeoLeaf._UITheme.applyTheme,GeoLeaf.UI.getCurrentTheme=GeoLeaf._UITheme.getCurrentTheme,GeoLeaf.UI.setTheme=GeoLeaf._UITheme.applyTheme),GeoLeaf._UIControls&&(GeoLeaf.UI.initFullscreenControl=GeoLeaf._UIControls.initFullscreenControl,GeoLeaf.UI.initGeolocationControl=GeoLeaf._UIControls.initGeolocationControl,GeoLeaf.UI.initPoiAddControl=GeoLeaf._UIControls.initPoiAddControl,GeoLeaf.UI.initScaleControl=GeoLeaf._UIControls.initScaleControl,GeoLeaf.UI._userPosition=null,GeoLeaf.UI._geolocationActive=0,GeoLeaf.UI._geolocationWatchId=null),(GeoLeaf._UIPanelBuilder||GeoLeaf.UI.PanelBuilder)&&(GeoLeaf.UI.buildSidePanel=GeoLeaf._UIPanelBuilder&&GeoLeaf._UIPanelBuilder.buildSidePanel||GeoLeaf.UI.PanelBuilder&&GeoLeaf.UI.PanelBuilder.buildSidePanel,GeoLeaf.UI.renderPoiSidePanel=GeoLeaf._UIPanelBuilder&&GeoLeaf._UIPanelBuilder.renderPoiSidePanel||GeoLeaf.UI.PanelBuilder&&GeoLeaf.UI.PanelBuilder.renderPoiSidePanel,GeoLeaf.UI.renderPoiPanelWithLayout=function(e,o,n){if(GeoLeaf.UI.renderPoiSidePanel)return GeoLeaf.UI.renderPoiSidePanel(e,o,n);t&&t.warn("[UI.Orchestrator] renderPoiPanelWithLayout: PanelBuilder non disponible")},GeoLeaf.UI._resolveField=function(e,t){return GeoLeaf._UIDomUtils&&GeoLeaf._UIDomUtils.resolveField?GeoLeaf._UIDomUtils.resolveField(e,t):null},GeoLeaf.UI._createPlainSection=function(e,t,n){return GeoLeaf.UI.PanelBuilder&&GeoLeaf.UI.PanelBuilder.createPlainSection?GeoLeaf.UI.PanelBuilder.createPlainSection(e,t,n):o("section",{className:"gl-poi-panel__section "+(n||"")})},GeoLeaf.UI._createAccordionSection=function(e,t,n){return GeoLeaf.UI.PanelBuilder&&GeoLeaf.UI.PanelBuilder.createAccordionSection?GeoLeaf.UI.PanelBuilder.createAccordionSection(e,t,n):o("section",{className:"gl-poi-panel__section--accordion"})}),GeoLeaf._UIFilterPanel&&(GeoLeaf.UI.buildFilterPanelFromActiveProfile=GeoLeaf._UIFilterPanel.buildFilterPanelFromActiveProfile,GeoLeaf.UI.refreshFilterTags=GeoLeaf._UIFilterPanel.refreshFilterTags,GeoLeaf.UI.initFilterToggle=GeoLeaf._UIFilterPanel.initFilterToggle,GeoLeaf.UI.initProximityFilter=GeoLeaf._UIFilterPanel.initProximityFilter,GeoLeaf.UI._getBasePois=GeoLeaf._UIFilterPanel.getBasePois,GeoLeaf.UI._getBaseRoutes=GeoLeaf._UIFilterPanel.getBaseRoutes,GeoLeaf._UIFilterStateManager&&(GeoLeaf.UI.resetAllFilters=function(){GeoLeaf._UIFilterStateManager.resetAllFilters(),GeoLeaf._UIFilterPanel.refreshFilterTags&&GeoLeaf._UIFilterPanel.refreshFilterTags()},GeoLeaf.UI.getActiveFilters=GeoLeaf._UIFilterStateManager.getActiveFiltersSummary,GeoLeaf.UI.hasActiveFilters=GeoLeaf._UIFilterStateManager.hasActiveFilters)),GeoLeaf._UINotifications&&(GeoLeaf.UI.Notifications={show:GeoLeaf._UINotifications.show.bind(GeoLeaf._UINotifications),success:GeoLeaf._UINotifications.success.bind(GeoLeaf._UINotifications),error:GeoLeaf._UINotifications.error.bind(GeoLeaf._UINotifications),warning:GeoLeaf._UINotifications.warning.bind(GeoLeaf._UINotifications),info:GeoLeaf._UINotifications.info.bind(GeoLeaf._UINotifications),clearAll:GeoLeaf._UINotifications.clearAll.bind(GeoLeaf._UINotifications),enable:GeoLeaf._UINotifications.enable.bind(GeoLeaf._UINotifications),disable:GeoLeaf._UINotifications.disable.bind(GeoLeaf._UINotifications),getStatus:GeoLeaf._UINotifications.getStatus.bind(GeoLeaf._UINotifications)},GeoLeaf.UI.showNotification=GeoLeaf._UINotifications.show.bind(GeoLeaf._UINotifications),GeoLeaf.UI.showSuccess=GeoLeaf._UINotifications.success.bind(GeoLeaf._UINotifications),GeoLeaf.UI.showError=GeoLeaf._UINotifications.error.bind(GeoLeaf._UINotifications),GeoLeaf.UI.showWarning=GeoLeaf._UINotifications.warning.bind(GeoLeaf._UINotifications),GeoLeaf.UI.showInfo=GeoLeaf._UINotifications.info.bind(GeoLeaf._UINotifications),GeoLeaf.UI.clearNotifications=GeoLeaf._UINotifications.clearAll.bind(GeoLeaf._UINotifications));let r=0;GeoLeaf.UI.init=function(e={}){const o={buttonSelector:e.buttonSelector||'[data-gl-role="theme-toggle"]',autoInitOnDomReady:!!e.autoInitOnDomReady,enableEventDelegation:0!=e.enableEventDelegation},{missing:i,allAvailable:a}=n();if(!a&&t&&t.warn("[UI.Orchestrator] Initialisation avec modules manquants:",i),GeoLeaf.UI.initThemeToggle)try{GeoLeaf.UI.initThemeToggle(o)}catch(e){t&&t.error("[UI.Orchestrator] Erreur init th\xe8me:",e)}if(e.map&&e.mapContainer){if(GeoLeaf.UI.initFullscreenControl)try{GeoLeaf.UI.initFullscreenControl(e.map,e.mapContainer)}catch(e){t&&t.error("[UI.Orchestrator] Erreur fullscreen control:",e)}if(GeoLeaf.UI.initGeolocationControl)try{GeoLeaf.UI.initGeolocationControl(e.map,e.config)}catch(e){t&&t.error("[UI.Orchestrator] Erreur geolocation control:",e)}if(GeoLeaf.UI.initPoiAddControl)try{GeoLeaf.UI.initPoiAddControl(e.map,e.config)}catch(e){t&&t.error("[UI.Orchestrator] Erreur POI add control:",e)}if(GeoLeaf.UI.initScaleControl)try{GeoLeaf.UI.initScaleControl(e.map)}catch(e){t&&t.error("[UI.Orchestrator] Erreur scale control:",e)}}if(o.enableEventDelegation&&function(e={}){if(r||!GeoLeaf._UIEventDelegation)return;const{filterContainer:o}=e;o&&GeoLeaf._UIFilterStateManager&&GeoLeaf._UIEventDelegation.attachFilterInputEvents(o,()=>{GeoLeaf._UIFilterPanel&&GeoLeaf._UIFilterPanel.refreshFilterTags&&GeoLeaf._UIFilterPanel.refreshFilterTags()}),document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".gl-poi-panel, .gl-filter-panel").forEach(e=>{GeoLeaf._UIEventDelegation.attachAccordionEvents(e)})}),r=1,t&&t.info("[UI.Orchestrator] Event delegation initialis\xe9e")}({filterContainer:e.filterContainer}),GeoLeaf._UIFilterStateManager&&GeoLeaf.Config){const e=GeoLeaf.Config.getActiveProfile?.()||null;if(e&&e.filters)try{GeoLeaf._UIFilterStateManager.initializeFromProfile(e)}catch(e){t&&t.error("[UI.Orchestrator] Erreur init filter state:",e)}}t&&t.info(`[UI.Orchestrator] Initialisation termin\xe9e (modules: ${Object.keys(n().modules).length})`)},GeoLeaf.UI.getModuleStatus=function(){return n()},GeoLeaf.UI.cleanup=function(){if(GeoLeaf._UIEventDelegation&&GeoLeaf._UIEventDelegation.cleanupAllListeners){const e=GeoLeaf._UIEventDelegation.cleanupAllListeners();t&&e>0&&t.info(`[UI.Orchestrator] ${e} event listeners nettoy\xe9s`)}r=0,t&&t.info("[UI.Orchestrator] Nettoyage termin\xe9")},GeoLeaf.UI._attachAccordionBehavior=function(e){if(GeoLeaf._UIEventDelegation&&GeoLeaf._UIEventDelegation.attachAccordionEvents)return GeoLeaf._UIEventDelegation.attachAccordionEvents(e);t&&t.warn("[UI.Orchestrator] _attachAccordionBehavior: EventDelegation module manquant")},GeoLeaf.UI._getActiveProfileConfig=function(){return GeoLeaf._UIDomUtils&&GeoLeaf._UIDomUtils.getActiveProfileConfig?GeoLeaf._UIDomUtils.getActiveProfileConfig():GeoLeaf.Config?.getActiveProfile?.()||null},GeoLeaf.UI.VERSION="4.4.0",GeoLeaf.UI.BUILD="Sprint-4.4-Modular",t&&t.info(`[UI.Orchestrator] Module initialis\xe9 v${GeoLeaf.UI.VERSION}`)}(window)),B||(B=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{};GeoLeaf._Normalizer=GeoLeaf._Normalizer||{};const t={JSON:"json",GEOJSON:"geojson",GPX:"gpx",ROUTE:"route"};function o(){return GeoLeaf.Log||console}function n(){return"poi_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}function r(e){if(!e)return"Unknown";if("function"==typeof e.getLatLng)return"Point";if("function"==typeof e.getLatLngs){const t=e.getLatLngs();if(Array.isArray(t)&&t.length>0)return Array.isArray(t[0])&&Array.isArray(t[0][0])||Array.isArray(t[0])?"Polygon":"LineString"}return"Unknown"}function i(e){if(!e)return null;if("function"==typeof e.getLatLng){const t=e.getLatLng();return t?[t.lat,t.lng]:null}if("function"==typeof e.getCenter){const t=e.getCenter();return t?[t.lat,t.lng]:null}if("function"==typeof e.getBounds)try{const t=e.getBounds();if(t&&t.isValid()){const e=t.getCenter();return e?[e.lat,e.lng]:null}}catch(e){}return null}function a(e,o={}){if(!e)return null;const r=e.id||e.uid||e.guid||n(),i=o.dataMapping||{},a=e[i.title||"title"]||e.title||e.name||e.label||e.nom||"Sans titre",l=e[i.description||"description"]||e.description||e.shortDescription||"",s=i.lat||"lat",c=i.lng||"lng";let u=e[s],d=e[c];void 0===u&&(u=e.latitude||e.y),void 0===d&&(d=e.longitude||e.lng||e.x);const f=i.categoryId||"categoryId",p=i.subCategoryId||"subCategoryId",g=e[f]||e.categoryId||e.category||null,y=e[p]||e.subCategoryId||e.subcategory||null,h={...e};return{id:String(r),sourceType:t.JSON,geometryType:"Point",title:String(a),description:String(l||""),lat:void 0!==u?parseFloat(u):null,lng:void 0!==d?parseFloat(d):null,categoryId:g,subCategoryId:y,attributes:h,rawData:e}}function l(e,o={},a=null){if(!e)return null;const l=e.properties||{},s=e.geometry||{},c=o.dataMapping||{},u=e.id||l.id||l.uid||l.guid||n();let d=s.type||"Unknown";a&&"Unknown"===d&&(d=r(a));const f=c.title||"title",p=l[f.includes(".")?f.split(".").pop():f]||l.name||l.nom||l.title||l.label||"Sans titre",g=c.description||"description",y=l[g.includes(".")?g.split(".").pop():g]||l.description||l.shortDescription||"";let h=null,m=null;if(s.coordinates){if("Point"===d)m=s.coordinates[0],h=s.coordinates[1];else if(a){const e=i(a);e&&(h=e[0],m=e[1])}else if(s.coordinates.length>0){const e=function(e,t){if(!e||!Array.isArray(e))return[];switch(t){case"Point":return[e];case"MultiPoint":case"LineString":return e;case"MultiLineString":case"Polygon":return e.flat();case"MultiPolygon":return e.flat(2);default:const t=[],o=e=>{Array.isArray(e)&&("number"==typeof e[0]?t.push(e):e.forEach(o))};return o(e),t}}(s.coordinates,s.type);if(e.length>0){let t=0,o=0;e.forEach(e=>{o+=e[0],t+=e[1]}),m=o/e.length,h=t/e.length}}}else if(a){const e=i(a);e&&(h=e[0],m=e[1])}const b=c.categoryId||"categoryId",_=b.includes(".")?b.split(".").pop():b,v=c.subCategoryId||"subCategoryId",C=v.includes(".")?v.split(".").pop():v,S=l[_]||l.categoryId||l.category||null,I=l[C]||l.subCategoryId||l.subcategory||null,P={...l};return{id:String(u),sourceType:t.GEOJSON,geometryType:d,title:String(p),description:String(y||""),lat:null!==h?parseFloat(h):null,lng:null!==m?parseFloat(m):null,categoryId:S,subCategoryId:I,attributes:P,properties:l,rawData:e}}function s(e){if(!e)return null;o().info("[Normalizer] GPX normalization - placeholder for future implementation");const r=e.name||e.sym||n(),i=e.name||e.cmt||"Point GPX",a=e.desc||e.cmt||"";return{id:String(r),sourceType:t.GPX,geometryType:"Point",title:String(i),description:String(a),lat:void 0!==e.lat?parseFloat(e.lat):null,lng:void 0!==e.lon?parseFloat(e.lon):null,categoryId:e.type||null,subCategoryId:null,attributes:{...e},rawData:e}}function c(e){if(!e)return null;const o=e.id||e.placeId||n(),r=e.name||e.title||e.address||"Point de route",i=e.description||e.comment||"";let a=null,l=null;return e.latLng?(a=e.latLng.lat,l=e.latLng.lng):void 0!==e.lat&&void 0!==e.lng&&(a=e.lat,l=e.lng),{id:String(o),sourceType:t.ROUTE,geometryType:"Point",title:String(r),description:String(i),lat:null!==a?parseFloat(a):null,lng:null!==l?parseFloat(l):null,categoryId:e.type||"route-point",subCategoryId:void 0!==e.order?`stop-${e.order}`:null,order:e.order,address:e.address,attributes:{...e},rawData:e}}function u(e,n,r={},i={}){if(!n)return o().warn("[Normalizer] Donn\xe9es nulles pour normalisation"),null;switch(e){case t.JSON:return a(n,r);case t.GEOJSON:return l(n,r,i.layer);case t.GPX:return s(n);case t.ROUTE:return c(n);default:return o().warn("[Normalizer] Type de source non reconnu:",e),d(n,r,i)}}function d(e,t={},o={}){return"Feature"===e.type&&e.geometry?l(e,t,o.layer):void 0!==e.lat&&void 0!==e.lon&&(e.name||e.sym)?s(e):e.latLng||void 0!==e.order&&e.address?c(e):a(e,t)}GeoLeaf._Normalizer={SOURCE_TYPES:t,normalizeFromJSON:a,normalizeFromGeoJSON:l,normalizeFromGPX:s,normalizeFromRoute:c,normalizeFeature:u,autoDetectAndNormalize:d,normalizeCollection:function(e,t,n={},r={}){return Array.isArray(t)?t.map(t=>u(e,t,n,r)).filter(e=>null!==e):(o().warn("[Normalizer] normalizeCollection attend un tableau"),[])},detectGeometryType:r,extractCoordinates:i,generateUniqueId:n},o().info("[GeoLeaf._Normalizer] Module Normalizer charg\xe9")}("undefined"!=typeof window?window:gt)),$||($=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=new Map;let o={debug:0,throwOnValidationError:1};async function n(e,n,i,a,l){const s=`${e}:${n}:${i}`;if(!o.debug&&t.has(s))return t.get(s);try{const c=`${function(){const e=GeoLeaf.Config;if(e&&"function"==typeof e.get){const t=e.get("data.profilesBasePath","profiles");if("string"==typeof t&&t.trim().length>0)return t.endsWith("/")?t.slice(0,-1):t}return"profiles"}()}/${e}/${l}/styles/${a}`,u=await fetch(c);if(!u.ok)throw new Error(`Impossible de charger le fichier de style: ${c}\nHTTP ${u.status}: ${u.statusText}`);let d;try{d=await u.json()}catch(t){const o={profileId:e,layerId:n,styleId:i,stylePath:c,httpStatus:u.status,parseError:t.message};throw console.error("\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550"),console.error("\u274c ERREUR DE PARSING JSON - FICHIER STYLE MALFORM\xc9"),console.error("\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550"),console.error(`Fichier: ${c}`),console.error(`Erreur: ${t.message}`),console.error("Contexte:",JSON.stringify(o,null,2)),console.error("Stack trace:",t.stack),console.error("\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550"),new Error(`Le fichier de style contient du JSON malform\xe9: ${c}\nErreur de parsing: ${t.message}\nVeuillez v\xe9rifier la syntaxe JSON du fichier.`)}d.label&&1==d.label.enabled&&void 0===d.label.visibleByDefault&&(d.label.visibleByDefault=0,console.warn(`[StyleLoader] \u26a0\ufe0f Param\xe8tre "visibleByDefault" manquant dans le style: ${c}\nLe style a "label.enabled: true" mais pas de "visibleByDefault".\nFallback appliqu\xe9: visibleByDefault = false\nAjoutez explicitement "visibleByDefault": false ou true dans le fichier de style.`));{const t=GeoLeaf._StyleValidator;t||console.warn("[StyleLoader] GeoLeaf._StyleValidator non disponible, validation ignor\xe9e");const r=t?t.validateStyle(d,{profileId:e,layerId:n,styleId:i,stylePath:c}):{valid:1,errors:[],warnings:[]};if(!r.valid){const e=t?t.formatValidationErrors(r,c):"Erreurs de validation";if(console.error(e),o.throwOnValidationError)throw new Error(`Le fichier de style ne respecte pas le sch\xe9ma GeoLeaf: ${c}\nConsultez la console pour les d\xe9tails des erreurs.`)}r.warnings.length>0&&(console.warn(`[StyleLoader] ${r.warnings.length} avertissement(s) pour ${c}:`),r.warnings.forEach(e=>{console.warn(`  - ${e.field}: ${e.message}`)}))}const f=r(d),p={styleData:d,labelConfig:f,metadata:{profileId:e,layerId:n,styleId:i,stylePath:c,hasIntegratedLabels:null!==f,loadedAt:(new Date).toISOString()}};return o.debug||t.set(s,p),p}catch(t){if(t.message.includes("JSON malform\xe9")||t.message.includes("sch\xe9ma GeoLeaf"))throw t;const o={profileId:e,layerId:n,styleId:i,styleFileName:a,layerDirectory:l,originalError:t.message};throw console.error("\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550"),console.error("\u274c ERREUR DE CHARGEMENT DE STYLE"),console.error("\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550"),console.error("Contexte:",JSON.stringify(o,null,2)),console.error("Stack trace:",t.stack),console.error("\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550"),t}}function r(e){return e&&"object"==typeof e&&e.label&&"object"==typeof e.label&&null!==e.label&&1==e.label.enabled?{...e.label,isIntegrated:1}:null}const i={initStyleLoader:function(e={}){o.debug=1==e.debug,o.debug},loadAndValidateStyle:n,extractLabelConfig:r,loadStyleLenient:async function(e,t,r,i,a){const l=o.throwOnValidationError;o.throwOnValidationError=0;try{return await n(e,t,r,i,a)}finally{o.throwOnValidationError=l}},preloadStyles:async function(e){e.length;const t=e.map(e=>n(e.profileId,e.layerId,e.styleId,e.styleFileName,e.layerDirectory).catch(t=>({error:1,message:t.message,config:e}))),o=await Promise.all(t);return o.filter(e=>!e.error).length,o.filter(e=>e.error).length,o},clearStyleCache:function(e=null){e?t.delete(e):(t.size,t.clear())},getCacheStats:function(){return{size:t.size,keys:Array.from(t.keys()),debug:o.debug,cacheEnabled:!o.debug}},loadStyleFromLayerConfig:async function(e,t,o){const r=t.id,i=t._layerDirectory||`layers/${r}`;if(t.labels&&t.labels.styleFile){const o=`\u274c CONFIGURATION OBSOL\xc8TE D\xc9TECT\xc9E\n\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nLa couche "${r}" utilise une r\xe9f\xe9rence obsol\xe8te \xe0 un fichier\nde labels s\xe9par\xe9 via "labels.styleFile".\n\nGeoLeaf ne supporte plus les fichiers de labels s\xe9par\xe9s (styleLabel.json).\nLes labels doivent \xeatre int\xe9gr\xe9s dans les fichiers de style.\n\nValeur d\xe9tect\xe9e: ${t.labels.styleFile}\nProfil: ${e}\nCouche: ${r}\n\nAction requise:\n1. Supprimez la propri\xe9t\xe9 "labels.styleFile" de la configuration\n2. Int\xe9grez les labels dans les fichiers de style (propri\xe9t\xe9 "label")\n3. Consultez docs/STYLE_FORMAT_SPEC.md pour la syntaxe\n\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550`;throw console.error(o),new Error(`Configuration obsol\xe8te: labels.styleFile d\xe9tect\xe9 dans la couche ${r}`)}let a=o,l=o;if(t.styles&&t.styles.available){const e=t.styles.available.find(e=>e.id===o||e.file===o);e&&(a=e.file,l=e.id)}return n(e,r,l,a,i)},getStylePath:function(e,t,o){return`profiles/${e}/${t}/styles/${o}`},styleCache:t};GeoLeaf._StyleLoader=i}(window)),j||(j=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log,o={loadUrl(e,o={}){if(!e)return t.warn("[GeoLeaf.Config.Loader] URL JSON manquante dans loadUrl()."),Promise.resolve({});const{headers:n={},strictContentType:r=1}=o,i=void 0!==GeoLeaf&&GeoLeaf.Security?GeoLeaf.Security:null;if(!/^\.{0,2}\//.test(e)&&!/^\/[^/]/.test(e))if(i&&"function"==typeof i.validateUrl)try{e=i.validateUrl(e)}catch(e){const o="[GeoLeaf.Config.Loader] "+e.message;return t.error(o),Promise.reject(new Error(o))}else if(!/^https?:\/\//i.test(e)){const e="[GeoLeaf.Config.Loader] URL doit \xeatre relative ou commencer par http:// ou https://";return t.error(e),Promise.reject(new Error(e))}const a={method:"GET",headers:{Accept:"application/json",...n}};return fetch(e,a).then(o=>{if(!o.ok)throw new Error("HTTP "+o.status+" pour "+e);const n=o.headers.get("content-type");if(r){if(!n||!n.includes("application/json"))throw new Error("[GeoLeaf.Config.Loader] Content-Type invalide: attendu 'application/json', re\xe7u '"+(n||"null")+"'. Cela peut indiquer une attaque XSS ou un serveur mal configur\xe9.")}else n&&!n.includes("application/json")&&t.warn("[GeoLeaf.Config.Loader] Content-Type inattendu:",n);return o.json().catch(o=>{const n="[GeoLeaf.Config.Loader] Erreur de parsing JSON pour "+e+": "+o.message;throw t.error(n),new Error(n)})}).then(e=>{if("object"!=typeof e||null===e)throw new Error("Le JSON de configuration n'est pas un objet valide.");return e}).catch(e=>{throw t.error("[GeoLeaf.Config.Loader] Erreur lors du chargement JSON :",e),e})},fetchJson(e,o={}){if(!e)return t.warn("[GeoLeaf.Config.Loader] fetchJson() appel\xe9 sans URL."),Promise.resolve(null);const{headers:n={},strictContentType:r=1}=o,i=void 0!==GeoLeaf&&GeoLeaf.Security?GeoLeaf.Security:null;if(!/^\.{0,2}\//.test(e)&&!/^\/[^/]/.test(e))if(i&&"function"==typeof i.validateUrl)try{e=i.validateUrl(e)}catch(e){const o="[GeoLeaf.Config.Loader] "+e.message;return t.error(o),Promise.reject(new Error(o))}else if(!/^https?:\/\//i.test(e)){const e="[GeoLeaf.Config.Loader] URL doit \xeatre relative ou commencer par http:// ou https://";return t.error(e),Promise.reject(new Error(e))}const a={method:"GET",headers:{Accept:"application/json",...n}};return fetch(e,a).then(o=>{if(!o.ok)throw new Error("HTTP "+o.status+" pour "+e);const n=o.headers.get("content-type");if(r){if(!n||!n.includes("application/json"))throw new Error("[GeoLeaf.Config.Loader] Content-Type invalide dans fetchJson: attendu 'application/json', re\xe7u '"+(n||"null")+"'.")}else n&&!n.includes("application/json")&&t.warn("[GeoLeaf.Config.Loader] fetchJson() Content-Type inattendu:",n);return o.json().catch(o=>{const n="[GeoLeaf.Config.Loader] Erreur de parsing JSON dans fetchJson pour "+e+": "+o.message;throw t.error(n),new Error(n)})}).then(o=>("object"==typeof o&&null!==o||t.warn("[GeoLeaf.Config.Loader] fetchJson() a re\xe7u un JSON non-objet pour l'URL :",e),o)).catch(o=>{throw t.error("[GeoLeaf.Config.Loader] Erreur fetchJson() pour "+e+" :",o),o})}};GeoLeaf._ConfigLoader=o}(window)),J||(J=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log,o={_config:null,init(e){this._config=e},getAll(){return this._config||{}},get(e,t){if(!this._config)return void 0===t?void 0:t;if(!e||"string"!=typeof e)return void 0===t?void 0:t;const o=e.split(".");let n=this._config;for(let e=0;e<o.length;e++){const r=o[e];if(!n||!Object.prototype.hasOwnProperty.call(n,r))return void 0===t?void 0:t;n=n[r]}return n},set(e,o){if(!this._config)return void t.warn("[GeoLeaf.Config.Storage] Configuration non initialis\xe9e.");if(!e||"string"!=typeof e)return void t.warn("[GeoLeaf.Config.Storage] set() requiert un chemin string.");const n=e.split(".");let r=this._config;for(let e=0;e<n.length;e++){const t=n[e];e===n.length-1?r[t]=o:(Object.prototype.hasOwnProperty.call(r,t)&&"object"==typeof r[t]&&null!==r[t]||(r[t]={}),r=r[t])}},getSection(e,t){if(!e)return void 0===t?void 0:t;const o=this.get(e);return void 0===o?void 0===t?void 0:t:o},deepMerge(e,t){const o=Object.assign({},e||{});return t&&"object"==typeof t?(Object.keys(t).forEach(e=>{const n=t[e],r=o[e];n&&"object"==typeof n&&!Array.isArray(n)&&r&&"object"==typeof r&&!Array.isArray(r)?o[e]=this.deepMerge(r,n):o[e]=n}),o):o},getValueByPath(e,t){if(!e||!t)return;const o=t.split(".");let n=e;for(let e=0;e<o.length;e+=1){if(null==n)return;n=n[o[e]]}return n},setValueByPath(e,t,o){if(!e||!t)return;const n=t.split(".");let r=e;for(let e=0;e<n.length-1;e+=1){const t=n[e];Object.prototype.hasOwnProperty.call(r,t)&&null!=r[t]||(r[t]={}),r=r[t]}r[n[n.length-1]]=o}};GeoLeaf._ConfigStorage=o}(window)),z||(z=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log,o={_safeAssign(e,o){const n=["__proto__","constructor","prototype"];for(const r in o)o.hasOwnProperty(r)&&(n.includes(r)?t.warn("[GeoLeaf.Config.Normalization] Tentative de pollution de prototype bloqu\xe9e",{key:r}):e[r]=o[r]);return e},isPoiStructNormalized(e){if(!e||"object"!=typeof e)return 0;if("string"!=typeof e.id||""===e.id.trim())return 0;const t="string"==typeof e.title&&""!==e.title.trim(),o="string"==typeof e.label&&""!==e.label.trim();if(!t&&!o)return 0;if(Array.isArray(e.latlng)&&e.latlng.length>=2){const t=e.latlng[0],o=e.latlng[1];if("number"==typeof t&&!Number.isNaN(t)&&"number"==typeof o&&!Number.isNaN(o))return 1}if(e.location&&"object"==typeof e.location){const t=e.location.lat,o=e.location.lng;if("number"==typeof t&&!Number.isNaN(t)&&"number"==typeof o&&!Number.isNaN(o))return 1}return 0},mapRawPoiToNormalized(e,o){if(!e||!o||"object"!=typeof o)return null;const n=GeoLeaf._ConfigStorage;if(!n)return t.error("[GeoLeaf.Config.Normalization] Module Storage non disponible."),null;const r={id:"",title:"",location:{lat:0,lng:0},attributes:{}};return Object.keys(o).forEach(t=>{const i=o[t];if(!i)return;const a=n.getValueByPath(e,i);void 0!==a&&n.setValueByPath(r,t,a)}),r.attributes&&"object"==typeof r.attributes&&!Array.isArray(r.attributes)||(r.attributes={}),r},normalizePoiWithMapping(e,o){if(!Array.isArray(e))return[];if(!o||"object"!=typeof o||!o.mapping||"object"!=typeof o.mapping)return t.debug("[GeoLeaf.Config.Normalization] Aucun mapping.json fourni ; les POI sont utilis\xe9s tels quels (aucune normalisation structurelle)."),e;const n=o.mapping,r=[];return e.forEach((e,o)=>{if(this.isPoiStructNormalized(e))return void r.push(e);const i=this.mapRawPoiToNormalized(e,n);i&&this.isPoiStructNormalized(i)?r.push(i):t.warn("[GeoLeaf.Config.Normalization] POI non normalis\xe9 m\xeame apr\xe8s application du mapping ; POI ignor\xe9.",{poiIndex:o,poiId:e&&e.id})}),r},normalizePoiArray(e){return Array.isArray(e)?e.map((e,o)=>{if(!e||"object"!=typeof e)return e;const n=this._safeAssign({},e),r=n.attributes&&"object"==typeof n.attributes&&!Array.isArray(n.attributes)?n.attributes:{},i=this._safeAssign({},r);return i.reviews&&"object"==typeof i.reviews&&!Array.isArray(i.reviews)&&Array.isArray(i.reviews.recent)?i.reviews={...i.reviews,recent:i.reviews.recent.slice(0,5)}:n.reviews&&"object"==typeof n.reviews&&!Array.isArray(n.reviews)&&Array.isArray(n.reviews.recent)?i.reviews={...n.reviews,recent:n.reviews.recent.slice(0,5)}:Array.isArray(i.reviews)?i.reviews=i.reviews.slice(0,5):Array.isArray(n.reviews)?i.reviews=n.reviews.slice(0,5):void 0!==n.reviews||void 0!==i.reviews?(t.warn("[GeoLeaf.Config.Normalization] Format de `reviews` inattendu pour le POI :",{poiIndex:o,poiId:n.id,reviewsType:typeof n.reviews,attributesReviewsType:typeof i.reviews}),i.reviews=[]):i.reviews=[],n.attributes=i,n}):e}};GeoLeaf._ConfigNormalization=o}(window)),V||(V=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log,o={_config:null,init(e){this._config=e},loadTaxonomy(e=null,o={}){const n=GeoLeaf._ConfigLoader;return n?e?n.loadUrl(e,o).then(e=>(e&&"object"==typeof e&&e.categories&&"object"==typeof e.categories&&!Array.isArray(e.categories)?(this._config.categories&&"object"==typeof this._config.categories||(this._config.categories={}),Object.assign(this._config.categories,e.categories),t.info("[GeoLeaf.Config.Taxonomy] Mapping cat\xe9gories fusionn\xe9 avec succ\xe8s.")):t.warn("[GeoLeaf.Config.Taxonomy] Fichier de mapping cat\xe9gories charg\xe9 mais aucune propri\xe9t\xe9 'categories' valide trouv\xe9e (attendu: { \"categories\": { ... } })."),this.getCategories())).catch(e=>(t.error("[GeoLeaf.Config.Taxonomy] Erreur lors du chargement de la taxonomie :",e),{})):(t.info("[GeoLeaf.Config.Taxonomy] Aucune URL de mapping fournie \u2014 skip."),Promise.resolve({})):(t.error("[GeoLeaf.Config.Taxonomy] Module Loader non disponible."),Promise.reject(new Error("Loader module not available")))},getCategories(){if(!this._config)return{};const e=this._config.categories;return e&&"object"==typeof e&&!Array.isArray(e)?e:{}},getCategory(e){if(!e||"string"!=typeof e)return;const t=this.getCategories();return Object.prototype.hasOwnProperty.call(t,e)?t[e]:void 0},getSubcategory(e,t){if(!e||"string"!=typeof e||!t||"string"!=typeof t)return;const o=this.getCategory(e);if(!o||!o.subcategories||"object"!=typeof o.subcategories||Array.isArray(o.subcategories))return;const n=o.subcategories;return Object.prototype.hasOwnProperty.call(n,t)?n[t]:void 0}};GeoLeaf._ConfigTaxonomy=o}(window)),q||(q=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log,o={async loadV3Profile(e,o,n,r=Date.now(),i={}){if(!GeoLeaf._ConfigLoader)throw new Error("GeoLeaf._ConfigLoader non disponible");t.info(`[ProfileV3Loader] Chargement profil V3.0: ${n}`);try{const[a,l,s]=await Promise.all([this._loadTaxonomy(e,o,r,i),this._loadThemes(e,o,r,i),this._loadLayersFile(e,o,r,i)]),c=s||e.layers||[],u=await this._loadLayerConfigs(c,o,r,i),d=this._buildEnrichedProfile({profile:e,baseUrl:o,profileId:n,taxonomy:a,themes:l,layersSource:c,layersConfigs:u});return t.info("[ProfileV3Loader] Profil V3.0 charg\xe9 avec succ\xe8s",{profileId:n,hasTaxonomy:!!d.taxonomy,hasThemes:!!d.themes,layersCount:d.layers?d.layers.length:0}),d}catch(e){throw t.error("[ProfileV3Loader] Erreur chargement profil V3.0:",e),e}},_shouldLoadTaxonomy:()=>1,async _loadTaxonomy(e,o,n,r){const i=GeoLeaf._ConfigLoader,a=e.Files?.taxonomyFile||e.taxonomyFile;if(!a&&!e.taxonomy)return null;if(!this._shouldLoadTaxonomy())return t.info("[ProfileV3Loader] Taxonomy.json non charg\xe9 (aucune cat\xe9gorie d\xe9tect\xe9e dans les donn\xe9es)"),null;if(a)try{const e=await i.fetchJson(`${o}/${a}?t=${n}`,r);return t.info("[ProfileV3Loader] Taxonomy.json charg\xe9 avec succ\xe8s"),e}catch(e){return t.warn("[ProfileV3Loader] Erreur chargement taxonomy.json:",e),null}return e.taxonomy||null},async _loadThemes(e,o,n,r){const i=GeoLeaf._ConfigLoader,a=e.Files?.themesFile||e.themesFile;if(a)try{return await i.fetchJson(`${o}/${a}?t=${n}`,r)}catch(e){return t.warn("[ProfileV3Loader] Erreur chargement themes.json:",e),null}return e.themes||null},async _loadLayersFile(e,o,n,r){const i=GeoLeaf._ConfigLoader,a=e.Files?.layersFile;if(a)try{return await i.fetchJson(`${o}/${a}?t=${n}`,r)}catch(e){return t.warn("[ProfileV3Loader] Erreur chargement layers.json:",e),null}return null},async _loadLayerConfigs(e,o,n,r){const i=GeoLeaf._ConfigLoader;if(!Array.isArray(e)||0===e.length)return[];const a=e.map(async e=>{if(!e.configFile)return{id:e.id,config:null,layerDirectory:null,layerManagerId:e.layerManagerId||null};const a=e.configFile.replace(/\/[^\/]+$/,"");try{const t=await i.fetchJson(`${o}/${e.configFile}?t=${n}`,r);return{id:e.id,config:t,layerDirectory:a,layerManagerId:e.layerManagerId||null}}catch(o){return t.error(`[ProfileV3Loader] Erreur chargement ${e.configFile}:`,o),{id:e.id,config:null,layerDirectory:a,layerManagerId:e.layerManagerId||null}}});return Promise.all(a)},_buildEnrichedProfile(e){const{profile:t,baseUrl:o,profileId:n,taxonomy:r,themes:i,layersSource:a,layersConfigs:l}=e,s={...t};return s.basePath=o,s._profileId=n,r&&(s.taxonomy=r),i&&(s.themes=i),l&&l.length>0&&(s.layers=l.map(e=>{if(e.config){const t={...e.config,_layerDirectory:e.layerDirectory,_profileId:n,layerManagerId:e.layerManagerId||e.config.layerManagerId||"geojson-default"};if(t.data&&t.data.file&&!t.dataFile){const e=t.data.directory||"data";t.dataFile=`${e}/${t.data.file}`}return t}return a.find(t=>t.id===e.id)||{id:e.id,error:"Failed to load config"}})),s},isV3Profile(e){if(!e||"object"!=typeof e)return 0;if(e.Files&&"object"==typeof e.Files)return 1;if(e.version){const t=e.version.match(/^(\d+)\.(\d+)/);if(t)return parseInt(t[1],10)>=3}return 0}};GeoLeaf._ProfileV3Loader=o}(window)),H||(H=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log,o={_config:null,_activeProfileId:null,_activeProfile:null,_activeProfileData:{poi:[],routes:[],mapping:null},init(e){this._config=e},isProfilePoiMappingEnabled(){const e=this._config&&this._config.data;return e&&"object"==typeof e?"boolean"==typeof e.enableProfilePoiMapping?e.enableProfilePoiMapping:"boolean"==typeof e.useProfilePoiMapping?e.useProfilePoiMapping:"boolean"==typeof e.useMapping?e.useMapping:1:1},loadActiveProfileResources(e={}){const o=this._config&&this._config.data;if(!o||!o.activeProfile)return t.info("[GeoLeaf.Config.Profile] Aucun profil actif d\xe9fini dans config.data.activeProfile ; aucun chargement de profil effectu\xe9."),Promise.resolve(this._config);const n="boolean"==typeof o.useLegacyProfileData?o.useLegacyProfileData:0,r=o.activeProfile,i=`${o.profilesBasePath||"data/profiles"}/${r}`;t.info("[GeoLeaf.Config.Profile] D\xe9but du chargement du profil :",{profileId:r,baseUrl:i,configData:o});const a={headers:e.headers||{},strictContentType:"boolean"==typeof e.strictContentType?e.strictContentType:1},l=GeoLeaf._ConfigLoader,s=GeoLeaf._ConfigNormalization;if(!l||!s)return t.error("[GeoLeaf.Config.Profile] Modules Loader ou Normalization non disponibles."),Promise.reject(new Error("Required modules not available"));const c=this.isProfilePoiMappingEnabled();c||t.info("[GeoLeaf.Config.Profile] Mapping de POI d\xe9sactiv\xe9 via configuration globale ; les POI du profil seront consid\xe9r\xe9s comme d\xe9j\xe0 normalis\xe9s."),t.info("[GeoLeaf.Config.Profile] Chargement des ressources du profil actif :",{profileId:r,baseUrl:i});const u=Date.now();if(n){const e=c?l.fetchJson(`${i}/mapping.json?t=${u}`,a):Promise.resolve(null),o=l.fetchJson(`${i}/routes.json?t=${u}`,a).catch(()=>(t.info("[GeoLeaf.Config.Profile] routes.json non disponible ou invalide, utilisation d'un tableau vide."),[]));return Promise.all([l.fetchJson(`${i}/profile.json?t=${u}`,a),l.fetchJson(`${i}/poi.json?t=${u}`,a),e,o]).then(([e,t,o,n])=>this._finalizeProfileLoad({profile:e,poi:t,routes:n,mapping:o,mappingEnabled:c})).catch(e=>(t.error("[GeoLeaf.Config.Profile] Erreur lors du chargement des ressources du profil actif :",e),this._config))}return l.fetchJson(`${i}/profile.json?t=${u}`,a).then(e=>{if(GeoLeaf._ProfileV3Loader&&GeoLeaf._ProfileV3Loader.isV3Profile(e))return t.info("[GeoLeaf.Config.Profile] Profil v3.0 d\xe9tect\xe9 - Chargement modulaire"),this._loadV3Profile(e,i,u,a);let o=0;e&&Array.isArray(e.layers)&&(o=e.layers.some(e=>0==e.normalized));const n=c&&o?l.fetchJson(`${i}/mapping.json?t=${u}`,a).catch(e=>(t.error("[GeoLeaf.Config.Profile] mapping.json requis (normalized:false) mais non trouv\xe9 ou invalide.",e),null)):Promise.resolve(null);return Promise.all([Promise.resolve(e),n])}).then(e=>{if(e&&!Array.isArray(e))return e;const[o,n]=e;return this._activeProfileId=r,this._activeProfile=o||null,t.info("[GeoLeaf.Config.Profile] Profil charg\xe9 (layers-only)",{profileId:r,profileLoaded:!!o,profileKeys:o?Object.keys(o):[]}),this._activeProfileData={poi:[],routes:[],mapping:n&&"object"==typeof n?n:null},o&&"object"==typeof o&&o.taxonomy&&o.taxonomy.categories&&"object"==typeof o.taxonomy.categories&&!Array.isArray(o.taxonomy.categories)&&(this._config.categories=o.taxonomy.categories,t.info("[GeoLeaf.Config.Profile] Taxonomie des cat\xe9gories charg\xe9e (layers-only).",{profileId:r,categoriesCount:Object.keys(o.taxonomy.categories||{}).length})),this._config.profiles&&"object"==typeof this._config.profiles&&!Array.isArray(this._config.profiles)||(this._config.profiles={}),this._config.profiles[r]={profile:this._activeProfile,poi:this._activeProfileData.poi,routes:this._activeProfileData.routes,mapping:this._activeProfileData.mapping},this._fireProfileLoadedEvent(r,{profile:this._activeProfile,poi:this._activeProfileData.poi,routes:this._activeProfileData.routes,mapping:this._activeProfileData.mapping}),this._config}).catch(e=>(t.error("[GeoLeaf.Config.Profile] Erreur lors du chargement des ressources du profil actif :",e),this._config))},_loadV3Profile(e,o,n,r){const i=this._config.data.activeProfile;return GeoLeaf._ProfileV3Loader?GeoLeaf._ProfileV3Loader.loadV3Profile(e,o,i,n,r).then(e=>(this._activeProfileId=i,this._activeProfile=e,t.info("[GeoLeaf.Config.Profile] Profil v3.0 charg\xe9 avec succ\xe8s",{profileId:i,hasTaxonomy:!!e.taxonomy,hasThemes:!!e.themes,layersCount:e.layers?e.layers.length:0}),this._activeProfileData={poi:[],routes:[],mapping:null},e.taxonomy&&e.taxonomy.categories&&(this._config.categories=e.taxonomy.categories,t.info("[GeoLeaf.Config.Profile] Taxonomie charg\xe9e depuis v3.0",{categoriesCount:Object.keys(e.taxonomy.categories||{}).length})),Object.keys(e).forEach(t=>{"layers"!==t&&"taxonomy"!==t&&"themes"!==t&&(this._config[t]=e[t])}),this._config.profiles&&"object"==typeof this._config.profiles||(this._config.profiles={}),this._config.profiles[i]={profile:this._activeProfile,poi:[],routes:[],mapping:null},this._fireProfileLoadedEvent(i,{profile:this._activeProfile,poi:[],routes:[],mapping:null}),e)):(t.error("[GeoLeaf.Config.Profile] ProfileV3Loader non disponible"),Promise.reject(new Error("ProfileV3Loader non disponible")))},_finalizeProfileLoad({profile:e,poi:o,routes:n,mapping:r,mappingEnabled:i}){const a=GeoLeaf._ConfigNormalization;this._activeProfile=e||null,t.info("[GeoLeaf.Config.Profile] Profil charg\xe9 depuis profile.json :",{profileId:this._activeProfileId,profileLoaded:null!=e,profileKeys:e?Object.keys(e):[]});const l=i&&r&&"object"==typeof r?r:null,s=Array.isArray(o)?a.normalizePoiWithMapping(o,l):[],c=a.normalizePoiArray(s),u=l,d=Array.isArray(n)?n:[];return this._activeProfileData={poi:c,mapping:u,routes:d},c.length&&(this._config.poi=c),d.length&&(this._config.routes=d),e&&"object"==typeof e&&e.taxonomy&&e.taxonomy.categories&&"object"==typeof e.taxonomy.categories&&!Array.isArray(e.taxonomy.categories)&&(this._config.categories=e.taxonomy.categories,t.info("[GeoLeaf.Config.Profile] Taxonomie des cat\xe9gories charg\xe9e depuis le profil actif.",{profileId:this._activeProfileId,categoriesCount:Object.keys(e.taxonomy.categories||{}).length})),this._config.profiles&&"object"==typeof this._config.profiles&&!Array.isArray(this._config.profiles)||(this._config.profiles={}),this._config.profiles[this._activeProfileId]={profile:this._activeProfile,poi:this._activeProfileData.poi,routes:this._activeProfileData.routes,mapping:this._activeProfileData.mapping},this._fireProfileLoadedEvent(this._activeProfileId,{profile:this._activeProfile,poi:this._activeProfileData.poi,routes:this._activeProfileData.routes,mapping:this._activeProfileData.mapping}),this._config},getActiveProfileId(){return this._activeProfileId},getActiveProfile(){return this._activeProfile},getActiveProfilePoi(){return this._activeProfileData&&Array.isArray(this._activeProfileData.poi)?this._activeProfileData.poi:[]},getActiveProfileRoutes(){return this._activeProfileData&&Array.isArray(this._activeProfileData.routes)?this._activeProfileData.routes:[]},getActiveProfileMapping(){return this._activeProfileData&&this._activeProfileData.mapping?this._activeProfileData.mapping:null},getIconsConfig(){return this._activeProfile&&this._activeProfile.taxonomy&&this._activeProfile.taxonomy.icons?this._activeProfile.taxonomy.icons:null},getActiveProfileLayersConfig(){return this._activeProfile&&this._activeProfile.layers?this._activeProfile.layers:null},_fireProfileLoadedEvent(e,o){if("undefined"!=typeof document&&"function"==typeof document.dispatchEvent)try{const t=new CustomEvent("geoleaf:profile:loaded",{detail:{profileId:e,data:o}});document.dispatchEvent(t)}catch(n){try{const t=document.createEvent("CustomEvent");t.initCustomEvent("geoleaf:profile:loaded",0,0,{profileId:e,data:o}),document.dispatchEvent(t)}catch(e){t.warn("[GeoLeaf.Config.Profile] Impossible d'\xe9mettre l'\xe9v\xe9nement geoleaf:profile:loaded.")}}}};GeoLeaf._ConfigProfile=o}(window)),Z||(Z=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log,o={convertPoiArrayToGeoJSON(e){if(!Array.isArray(e))return t.warn("[DataConverter.convertPoiArrayToGeoJSON] Input n'est pas un array, retour FeatureCollection vide"),{type:"FeatureCollection",features:[]};const o=e.map(e=>{if(!e||"object"!=typeof e)return null;if(!e.id)return t.warn("[DataConverter.convertPoiArrayToGeoJSON] POI sans ID, ignor\xe9",e),null;let o=null;if(Array.isArray(e.latlng)&&2===e.latlng.length)o=[e.latlng[1],e.latlng[0]];else{if(!e.location||"number"!=typeof e.location.lat||"number"!=typeof e.location.lng)return t.warn("[DataConverter.convertPoiArrayToGeoJSON] POI sans coordonn\xe9es valides, ignor\xe9",{id:e.id}),null;o=[e.location.lng,e.location.lat]}return{type:"Feature",id:e.id,geometry:{type:"Point",coordinates:o},properties:{id:e.id,title:e.title||"Sans titre",description:e.description||"",...e.attributes}}}).filter(e=>null!==e);return t.debug("[DataConverter.convertPoiArrayToGeoJSON] Converti",{input:e.length,output:o.length}),{type:"FeatureCollection",features:o}},convertRouteArrayToGeoJSON(e){if(!Array.isArray(e))return t.warn("[DataConverter.convertRouteArrayToGeoJSON] Input n'est pas un array, retour FeatureCollection vide"),{type:"FeatureCollection",features:[]};const o=e.map(e=>e&&"object"==typeof e?e.id?e.geometry&&"LineString"===e.geometry.type&&Array.isArray(e.geometry.coordinates)?{type:"Feature",id:e.id,geometry:{type:"LineString",coordinates:e.geometry.coordinates},properties:{id:e.id,title:e.title||"Sans titre",description:e.description||"",categoryId:e.categoryId,subCategoryId:e.subCategoryId,...e.attributes}}:(t.warn("[DataConverter.convertRouteArrayToGeoJSON] Route sans g\xe9om\xe9trie LineString valide, ignor\xe9e",{id:e.id}),null):(t.warn("[DataConverter.convertRouteArrayToGeoJSON] Route sans ID, ignor\xe9e",e),null):null).filter(e=>null!==e);return t.debug("[DataConverter.convertRouteArrayToGeoJSON] Converti",{input:e.length,output:o.length}),{type:"FeatureCollection",features:o}},convertZoneArrayToGeoJSON(e){if(!Array.isArray(e))return t.warn("[DataConverter.convertZoneArrayToGeoJSON] Input n'est pas un array, retour FeatureCollection vide"),{type:"FeatureCollection",features:[]};const o=e.map(e=>e&&"object"==typeof e?e.id?e.geometry&&"Polygon"===e.geometry.type&&Array.isArray(e.geometry.coordinates)?{type:"Feature",id:e.id,geometry:{type:"Polygon",coordinates:e.geometry.coordinates},properties:{id:e.id,title:e.title||e.siteName||"Sans titre",description:e.description||"",...e.attributes}}:(t.warn("[DataConverter.convertZoneArrayToGeoJSON] Zone sans g\xe9om\xe9trie Polygon valide, ignor\xe9e",{id:e.id}),null):(t.warn("[DataConverter.convertZoneArrayToGeoJSON] Zone sans ID, ignor\xe9e",e),null):null).filter(e=>null!==e);return t.debug("[DataConverter.convertZoneArrayToGeoJSON] Converti",{input:e.length,output:o.length}),{type:"FeatureCollection",features:o}},convertGpxToGeoJSON(e){if(!e||"string"!=typeof e)return t.warn("[DataConverter.convertGpxToGeoJSON] GPX string invalide"),{type:"FeatureCollection",features:[]};try{const o=(new DOMParser).parseFromString(e,"text/xml"),n=o.getElementsByTagName("parsererror");if(n.length>0)return t.error("[DataConverter.convertGpxToGeoJSON] Erreur parsing XML:",n[0].textContent),{type:"FeatureCollection",features:[]};const r=[],i=o.getElementsByTagName("wpt");for(let e=0;e<i.length;e++){const t=i[e],o=parseFloat(t.getAttribute("lat")),n=parseFloat(t.getAttribute("lon"));if(!isNaN(o)&&!isNaN(n)){const i=t.getElementsByTagName("name")[0],a=t.getElementsByTagName("desc")[0],l=t.getElementsByTagName("sym")[0],s={},c=[],u=t.getElementsByTagName("extensions");if(u.length>0){const e=u[0];for(let t=0;t<e.childNodes.length;t++){const o=e.childNodes[t];if(1!==o.nodeType)continue;const n=o.tagName||o.nodeName||"",r=o.localName||n.split(":").pop();if(n.toLowerCase().startsWith("geoleaf:")||o.namespaceURI&&o.namespaceURI.includes("geoleaf")||n.includes(":")){const e=r||n.replace(/^[^:]+:/,""),t=o.textContent||"";"tag"===e||"tags"===e?t&&c.push(t):s[e]=t}}}c.length>0&&(s.tags=c);const d={type:"Feature",id:s.id||(i?i.textContent:`wpt-${e}`),geometry:{type:"Point",coordinates:[n,o]},properties:{id:s.id||(i?i.textContent:`wpt-${e}`),title:i?i.textContent:`Waypoint ${e+1}`,description:a?a.textContent:"",symbol:l?l.textContent:"",...s}};r.push(d)}}const a=o.getElementsByTagName("trk");for(let e=0;e<a.length;e++){const t=a[e],o=t.getElementsByTagName("name")[0],n=t.getElementsByTagName("desc")[0],i={},l=[],s=t.getElementsByTagName("extensions");if(s.length>0){const e=s[0];for(let t=0;t<e.childNodes.length;t++){const o=e.childNodes[t];if(1!==o.nodeType)continue;const n=o.tagName||o.nodeName||"",r=o.localName||n.split(":").pop();if(n.toLowerCase().startsWith("geoleaf:")||o.namespaceURI&&o.namespaceURI.includes("geoleaf")||n.includes(":")){const e=r||n.replace(/^[^:]+:/,""),t=o.textContent||"";"tag"===e||"tags"===e?t&&l.push(t):i[e]=t}}}l.length>0&&(i.tags=l);const c=t.getElementsByTagName("trkseg");for(let t=0;t<c.length;t++){const a=c[t].getElementsByTagName("trkpt"),l=[];for(let e=0;e<a.length;e++){const t=a[e],o=parseFloat(t.getAttribute("lat")),n=parseFloat(t.getAttribute("lon"));isNaN(o)||isNaN(n)||l.push([n,o])}if(l.length>0){const a={type:"Feature",id:o?`${o.textContent}-${t}`:`trk-${e}-${t}`,geometry:{type:"LineString",coordinates:l},properties:{id:o?`${o.textContent}-${t}`:`trk-${e}-${t}`,title:o?o.textContent:`Track ${e+1}`,description:n?n.textContent:"",segmentIndex:t,pointCount:l.length,...i}};r.push(a)}}}return t.debug("[DataConverter.convertGpxToGeoJSON] Converti",{waypoints:i.length,tracks:a.length,features:r.length}),{type:"FeatureCollection",features:r}}catch(e){return t.error("[DataConverter.convertGpxToGeoJSON] Erreur lors du parsing GPX:",e),{type:"FeatureCollection",features:[]}}},autoConvert(e){if(!e)return t.warn("[DataConverter.autoConvert] Donn\xe9es nulles, retour FeatureCollection vide"),{type:"FeatureCollection",features:[]};if("FeatureCollection"===e.type&&Array.isArray(e.features))return t.debug("[DataConverter.autoConvert] Donn\xe9es d\xe9j\xe0 en GeoJSON, passage direct"),e;if("Feature"===e.type&&e.geometry)return t.debug("[DataConverter.autoConvert] Feature unique, conversion en FeatureCollection"),{type:"FeatureCollection",features:[e]};if(!Array.isArray(e)||0===e.length)return t.warn("[DataConverter.autoConvert] Donn\xe9es ne sont pas un array ou array vide"),{type:"FeatureCollection",features:[]};const o=e[0];return o&&"object"==typeof o?o.latlng||o.location&&"number"==typeof o.location.lat?(t.debug("[DataConverter.autoConvert] D\xe9tect\xe9 comme array de POI"),this.convertPoiArrayToGeoJSON(e)):o.geometry&&"LineString"===o.geometry.type&&Array.isArray(o.geometry.coordinates)?(t.debug("[DataConverter.autoConvert] D\xe9tect\xe9 comme array de routes"),this.convertRouteArrayToGeoJSON(e)):o.geometry&&"Polygon"===o.geometry.type&&Array.isArray(o.geometry.coordinates)?(t.debug("[DataConverter.autoConvert] D\xe9tect\xe9 comme array de zones"),this.convertZoneArrayToGeoJSON(e)):(t.warn("[DataConverter.autoConvert] Type de donn\xe9es non reconnu"),{type:"FeatureCollection",features:[]}):(t.warn("[DataConverter.autoConvert] Premier \xe9l\xe9ment invalide"),{type:"FeatureCollection",features:[]})}};GeoLeaf._DataConverter=o}("undefined"!=typeof window?window:gt)),W||(W=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log,o=GeoLeaf.Config=GeoLeaf.Config||{};o._config={},o._isLoaded=0,o._source=null,o._options={autoEvent:1},o.init=function(e={}){if(this._options=Object.assign({},this._options,{autoEvent:"boolean"==typeof e.autoEvent?e.autoEvent:this._options.autoEvent}),e.config&&"object"==typeof e.config){if(this._applyConfig(e.config,"inline"),"string"==typeof e.profileId&&e.profileId.length>0&&(this._config.data||(this._config.data={}),this._config.data.activeProfile=e.profileId,t.info("[GeoLeaf.Config] Profil actif chang\xe9 vers:",e.profileId)),this._maybeFireLoadedEvent(),"function"==typeof e.onLoaded)try{e.onLoaded(this._config)}catch(e){t.error("[GeoLeaf.Config] Erreur dans onLoaded (inline) :",e)}return Promise.resolve(this._config)}if("string"==typeof e.url&&e.url.length>0){const o={headers:e.headers,strictContentType:"boolean"==typeof e.strictContentType?e.strictContentType:1},n="string"==typeof e.mappingUrl&&e.mappingUrl.length>0?e.mappingUrl:null,r={headers:e.mappingHeaders||e.headers,strictContentType:"boolean"==typeof e.mappingStrictContentType?e.mappingStrictContentType:o.strictContentType};return this.loadUrl(e.url,o).then(o=>("string"==typeof e.profileId&&e.profileId.length>0&&(o.data||(o.data={}),o.data.activeProfile=e.profileId,this._config.data.activeProfile=e.profileId,t.info("[GeoLeaf.Config] Profil actif chang\xe9 vers:",e.profileId)),o)).then(e=>n?this.loadTaxonomy(n,r).then(()=>e).catch(o=>(t.warn("[GeoLeaf.Config] \xc9chec du chargement du mapping cat\xe9gories depuis "+n+" (GeoLeaf continuera sans mapping d\xe9di\xe9) :",o),e)):e).then(o=>{if("function"==typeof e.onLoaded)try{e.onLoaded(o)}catch(e){t.error("[GeoLeaf.Config] Erreur dans onLoaded (url+mapping) :",e)}return o}).catch(o=>{if(t.error("[GeoLeaf.Config] Erreur init() avec url :",o),"function"==typeof e.onError)try{e.onError(o)}catch(e){t.error("[GeoLeaf.Config] Erreur dans onError :",e)}throw o})}if(this._applyConfig({},"inline"),"string"==typeof e.profileId&&e.profileId.length>0&&(this._config.data||(this._config.data={}),this._config.data.activeProfile=e.profileId,t.info("[GeoLeaf.Config] Profil actif chang\xe9 vers:",e.profileId)),this._maybeFireLoadedEvent(),"function"==typeof e.onLoaded)try{e.onLoaded(this._config)}catch(e){t.error("[GeoLeaf.Config] Erreur dans onLoaded (vide) :",e)}return Promise.resolve(this._config)},o._initSubModules=function(){const e=GeoLeaf._ConfigStorage,t=GeoLeaf._ConfigTaxonomy,o=GeoLeaf._ConfigProfile;e&&"function"==typeof e.init&&e.init(this._config),t&&"function"==typeof t.init&&t.init(this._config),o&&"function"==typeof o.init&&o.init(this._config)},o._applyConfig=function(e,o){"object"==typeof e&&null!==e||(e={}),this._validateConfig(e);const n=GeoLeaf._ConfigStorage;n&&"function"==typeof n.deepMerge?this._config=n.deepMerge(this._config,e):this._config=Object.assign({},this._config,e);const r=GeoLeaf._ConfigNormalization;Array.isArray(this._config.poi)&&r&&(this._config.poi=r.normalizePoiArray(this._config.poi)),this._isLoaded=1,this._source=o||"inline",this._initSubModules();try{const o=e&&"object"==typeof e&&e.logging?e.logging:this._config&&this._config.logging?this._config.logging:null;let n=o&&o.level,r=0;e&&void 0!==e.debug?r=!!e.debug:this._config&&void 0!==this._config.debug&&(r=!!this._config.debug),n||(n=r?"debug":"info"),n&&GeoLeaf.Log&&"function"==typeof GeoLeaf.Log.setLevel&&(GeoLeaf.Log.setLevel(n),t.info("[GeoLeaf.Config] Niveau de log appliqu\xe9 depuis la configuration :",n,"(debug:",r,")"))}catch(e){t.warn("[GeoLeaf.Config] Impossible d'appliquer le niveau de log depuis la configuration :",e)}},o.isLoaded=function(){return this._isLoaded},o.getSource=function(){return this._source},o._maybeFireLoadedEvent=function(){if(this._options.autoEvent&&"undefined"!=typeof document&&"function"==typeof document.dispatchEvent)try{const e=new CustomEvent("geoleaf:config:loaded",{detail:{config:this._config,source:this._source}});document.dispatchEvent(e)}catch(e){try{const e=document.createEvent("CustomEvent");e.initCustomEvent("geoleaf:config:loaded",0,0,{config:this._config,source:this._source}),document.dispatchEvent(e)}catch(e){t.warn("[GeoLeaf.Config] Impossible d'\xe9mettre l'\xe9v\xe9nement geoleaf:config:loaded.")}}}}(window)),X||(X=1,function(){const GeoLeaf=window.GeoLeaf,e=GeoLeaf.Log;GeoLeaf.Config._validateConfig=function(t){if(t&&"object"==typeof t){if(t.map&&void 0!==t.map.center&&(!Array.isArray(t.map.center)||2!==t.map.center.length||"number"!=typeof t.map.center[0]||"number"!=typeof t.map.center[1]))throw new Error("[GeoLeaf.Config] map.center doit \xeatre un tableau de 2 nombres [lat, lng].");if(t.map&&void 0!==t.map.zoom&&("number"!=typeof t.map.zoom||t.map.zoom<0||t.map.zoom>20))throw new Error("[GeoLeaf.Config] map.zoom doit \xeatre un nombre entre 0 et 20.");if(void 0!==t.basemaps&&("object"!=typeof t.basemaps||null===t.basemaps))throw new Error("[GeoLeaf.Config] basemaps doit \xeatre un objet.");if(void 0!==t.poi&&!Array.isArray(t.poi))throw new Error("[GeoLeaf.Config] poi doit \xeatre un tableau.");if(void 0!==t.geojson&&!Array.isArray(t.geojson))throw new Error("[GeoLeaf.Config] geojson doit \xeatre un tableau.");if(void 0!==t.categories){if("object"!=typeof t.categories||null===t.categories||Array.isArray(t.categories))throw new Error("[GeoLeaf.Config] categories doit \xeatre un objet.");Object.entries(t.categories).forEach(([t,o])=>{if(!o||"object"!=typeof o)return void e.warn(`[GeoLeaf.Config] Cat\xe9gorie '${t}' invalide (doit \xeatre un objet).`);o.label&&"string"==typeof o.label||e.warn(`[GeoLeaf.Config] Cat\xe9gorie '${t}' : le champ 'label' est manquant ou invalide.`);const n=o.color&&"string"==typeof o.color,r=o.colorFill&&"string"==typeof o.colorFill||o.colorStroke&&"string"==typeof o.colorStroke;if(n||r||e.warn(`[GeoLeaf.Config] Cat\xe9gorie '${t}' : aucune couleur d\xe9finie (ni 'color', ni 'colorFill'/'colorStroke').`),void 0!==o.subcategories){if("object"!=typeof o.subcategories||null===o.subcategories||Array.isArray(o.subcategories))return void e.warn(`[GeoLeaf.Config] Cat\xe9gorie '${t}' : subcategories doit \xeatre un objet.`);Object.entries(o.subcategories).forEach(([o,n])=>{if(!n||"object"!=typeof n)return void e.warn(`[GeoLeaf.Config] Sous-cat\xe9gorie '${o}' dans '${t}' invalide (doit \xeatre un objet).`);n.label&&"string"==typeof n.label||e.warn(`[GeoLeaf.Config] Sous-cat\xe9gorie '${o}' dans '${t}' : le champ 'label' est manquant ou invalide.`);const r=n.color&&"string"==typeof n.color,i=n.colorFill&&"string"==typeof n.colorFill||n.colorStroke&&"string"==typeof n.colorStroke;r||i||e.warn(`[GeoLeaf.Config] Sous-cat\xe9gorie '${o}' dans '${t}' : aucune couleur d\xe9finie (ni 'color', ni 'colorFill'/'colorStroke').`)})}})}e.debug("[GeoLeaf.Config] Validation de la structure r\xe9ussie.")}}}()),Y||(Y=1,function(){const GeoLeaf=window.GeoLeaf,e=GeoLeaf.Log,t=GeoLeaf.Config;t.loadUrl=function(t,o={}){const n=GeoLeaf._ConfigLoader;return n?n.loadUrl(t,o).then(e=>{this._validateConfig(e);const t=GeoLeaf._ConfigStorage;t&&"function"==typeof t.deepMerge?this._config=t.deepMerge(this._config,e):this._config=Object.assign({},this._config,e);const o=GeoLeaf._ConfigNormalization;return Array.isArray(this._config.poi)&&o&&(this._config.poi=o.normalizePoiArray(this._config.poi)),this._isLoaded=1,this._source="url",this._initSubModules(),this._maybeFireLoadedEvent(),this._config}).catch(t=>(e.error("[GeoLeaf.Config] Erreur lors du chargement JSON :",t),this._config)):(e.error("[GeoLeaf.Config] Module Loader non disponible."),Promise.reject(new Error("Loader module not available")))},t.loadTaxonomy=function(t=null,o={}){const n=GeoLeaf._ConfigTaxonomy;return n?n.loadTaxonomy(t,o):(e.error("[GeoLeaf.Config] Module Taxonomy non disponible."),Promise.reject(new Error("Taxonomy module not available")))},t.loadActiveProfileResources=function(t={}){const o=GeoLeaf._ConfigProfile;return o?o.loadActiveProfileResources(t):(e.error("[GeoLeaf.Config] Module Profile non disponible."),Promise.reject(new Error("Profile module not available")))}}()),Q||(Q=1,function(){const GeoLeaf=window.GeoLeaf,e=GeoLeaf.Log,t=GeoLeaf.Config;t.getAll=function(){this._isLoaded||this._initSubModules();const e=GeoLeaf._ConfigStorage;return e&&"function"==typeof e.getAll?e.getAll():this._config},t.get=function(e,t){this._isLoaded||this._initSubModules();const o=GeoLeaf._ConfigStorage;return o&&"function"==typeof o.get?o.get(e,t):t},t.set=function(t,o){const n=GeoLeaf._ConfigStorage;n&&"function"==typeof n.set?n.set(t,o):e.warn("[GeoLeaf.Config] Module Storage non disponible pour set().")},t.getSection=function(e,t){const o=GeoLeaf._ConfigStorage;return o&&"function"==typeof o.getSection?o.getSection(e,t):t},t.getCategories=function(){this._isLoaded||this._initSubModules();const e=GeoLeaf._ConfigTaxonomy;return e&&"function"==typeof e.getCategories?e.getCategories():{}},t.getCategory=function(e){const t=GeoLeaf._ConfigTaxonomy;return t&&"function"==typeof t.getCategory?t.getCategory(e):void 0},t.getSubcategory=function(e,t){const o=GeoLeaf._ConfigTaxonomy;return o&&"function"==typeof o.getSubcategory?o.getSubcategory(e,t):void 0},t.getActiveProfileId=function(){const e=GeoLeaf._ConfigProfile;return e&&"function"==typeof e.getActiveProfileId?e.getActiveProfileId():null},t.getActiveProfile=function(){const e=GeoLeaf._ConfigProfile;return e&&"function"==typeof e.getActiveProfile?e.getActiveProfile():null},t.getActiveProfilePoi=function(){const e=GeoLeaf._ConfigProfile;return e&&"function"==typeof e.getActiveProfilePoi?e.getActiveProfilePoi():[]},t.getActiveProfileRoutes=function(){const e=GeoLeaf._ConfigProfile;return e&&"function"==typeof e.getActiveProfileRoutes?e.getActiveProfileRoutes():[]},t.getActiveProfileMapping=function(){const e=GeoLeaf._ConfigProfile;return e&&"function"==typeof e.getActiveProfileMapping?e.getActiveProfileMapping():null},t.getIconsConfig=function(){const e=GeoLeaf._ConfigProfile;return e&&"function"==typeof e.getIconsConfig?e.getIconsConfig():null},t.isProfilePoiMappingEnabled=function(){const e=GeoLeaf._ConfigProfile;return e&&"function"==typeof e.isProfilePoiMappingEnabled?e.isProfilePoiMappingEnabled():1}}()),K||(K=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log;if(!e.L)return void t.error("[GeoLeaf.Baselayers] Leaflet (L) est introuvable. Charge d'abord Leaflet 1.9.");const L=e.L,o=function(){let o=null,n=null,r=0;const i=Object.create(null),a={street:{label:"Street",url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",options:{maxZoom:19,attribution:"&copy; OpenStreetMap contributors"}},topo:{label:"Topo",url:"https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",options:{maxZoom:17,attribution:"Map data: &copy; OpenStreetMap contributors, SRTM | Map style: &copy; OpenTopoMap"}},satellite:{label:"Satellite",url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",options:{maxZoom:19,attribution:"Tiles &copy; Esri \u2014 Source: Esri, Earthstar Geographics, and the GIS user community"}}};function l(){if(o&&"function"==typeof o.setView)return;const n=e.GeoLeaf||{};if(n.Core&&"function"==typeof n.Core.getMap){const e=n.Core.getMap();e&&"function"==typeof e.setView&&(o=e,t.info("[GeoLeaf.Baselayers] _ensureMap: acquired map from GeoLeaf.Core.getMap()",o))}}function s(e,o){if(!e)return void t.warn("[GeoLeaf.Baselayers] registerBaseLayer appel\xe9 sans cl\xe9.");if(!o)return void t.warn("[GeoLeaf.Baselayers] D\xe9finition manquante pour la couche :",e);const n=o.id||e;let r=null;const a=o.label||n;if(o instanceof L.TileLayer)r=o;else if(o.layer&&o.layer instanceof L.TileLayer)r=o.layer;else{if(!o.url)return void t.warn("[GeoLeaf.Baselayers] D\xe9finition invalide pour la couche :",n,"(aucune url / aucun layer fourni)");{const e=function(e){const t=Object.assign({},e.options||{});return"number"!=typeof t.minZoom&&"number"==typeof e.minZoom&&(t.minZoom=e.minZoom),"number"!=typeof t.maxZoom&&(t.maxZoom="number"==typeof e.maxZoom?e.maxZoom:19),!t.attribution&&e.attribution&&(t.attribution=e.attribution),t}(o);r=L.tileLayer(o.url,e)}}i[n]={key:n,label:a,layer:r}}function c(e){e&&"object"==typeof e?Object.keys(e).forEach(function(t){s(t,e[t])}):t.warn("[GeoLeaf.Baselayers] registerBaseLayers attend un objet de d\xe9finitions.")}function u(){if(!e.document)return;const t=e.document.querySelectorAll("[data-gl-baselayer]"),o=e.document.getElementById("gl-left-panel");let r=null;t.forEach(function(e){const t=e.getAttribute("data-gl-baselayer");t&&(t===n?(e.classList.add("gl-baselayer-active","is-active"),e.setAttribute("aria-pressed","true"),r=e):(e.classList.remove("gl-baselayer-active","is-active"),e.setAttribute("aria-pressed","false")))}),o&&r&&function(e,t){if(!e||!t)return;const o=e.getBoundingClientRect(),n=t.getBoundingClientRect(),r=n.left-o.left,i=n.width;e.style.setProperty("--indicator-left",r+"px"),e.style.setProperty("--indicator-width",i+"px")}(o,r)}function d(e,r){if(r=r||{},!e)return void t.warn("[GeoLeaf.Baselayers] setBaseLayer appel\xe9 sans cl\xe9.");const a=n;if(l(),t.info("[GeoLeaf.Baselayers] setBaseLayer called: key=",e,"_map=",o?1:0),!o)return void t.warn("[GeoLeaf.Baselayers] Aucun L.Map disponible. Assure-toi que GeoLeaf.Core est initialis\xe9.");if(!i[e]){t.warn("[GeoLeaf.Baselayers] Couche inconnue :",e);const o=Object.keys(i);if(!a&&o.length>0){const e=o[0];r.silent||t.warn("[GeoLeaf.Baselayers] Bascule vers la premi\xe8re couche disponible :",e),d(e,{silent:1})}return}if(n===e)return void u();if(a&&i[a]){const e=i[a].layer;try{e&&o&&"function"==typeof o.hasLayer&&o.hasLayer(e)&&o.removeLayer(e)}catch(e){t.warn("[GeoLeaf.Baselayers] Impossible de retirer la couche pr\xe9c\xe9dente:",e)}}const s=i[e].layer;if(s&&"function"==typeof s.addTo){try{s.addTo(o)}catch(e){return void t.error("[GeoLeaf.Baselayers] Impossible d'ajouter la couche au L.Map:",e)}if(n=e,u(),t.info("[GeoLeaf.Baselayers] Activated base layer:",e),!r.silent){if("undefined"!=typeof document&&"function"==typeof document.dispatchEvent){const n={key:e,previousKey:a,map:o,layer:s,source:"geoleaf.baselayers"};try{if("function"==typeof CustomEvent){const e=new CustomEvent("geoleaf:basemap:change",{detail:n});document.dispatchEvent(e)}else{const e=document.createEvent("CustomEvent");e.initCustomEvent("geoleaf:basemap:change",1,1,n),document.dispatchEvent(e)}}catch(e){t.warn("[GeoLeaf.Baselayers] Impossible d'\xe9mettre l'\xe9v\xe9nement geoleaf:basemap:change.",e)}}t.info("[GeoLeaf.Baselayers] Couche de fond active :",e)}}else t.error("[GeoLeaf.Baselayers] Couche invalide pour la cl\xe9:",e)}function f(){return Object.assign({},i)}function p(){return n}return{init:function(g){if((g=g||{}).map?o=g.map:l(),Object.keys(a).forEach(function(e){i[e]||(s(e,a[e]),t.info("[GeoLeaf.Baselayers] _registerDefaultBaseLayers: registered",e))}),g.baselayers&&"object"==typeof g.baselayers&&c(g.baselayers),g.activeKey&&d(g.activeKey,{silent:1}),!n){const e=Object.keys(i);if(e.length>0){const o=e[0];t.info("[GeoLeaf.Baselayers] init: aucune couche active, bascule sur",o),d(o,{silent:1})}}return function(o){if(!e.document)return;!o&&e.GeoLeaf&&e.GeoLeaf.Config&&"function"==typeof e.GeoLeaf.Config.get&&(o={ui:e.GeoLeaf.Config.get("ui"),basemaps:e.GeoLeaf.Config.get("basemaps")||{}});const n=o&&o.ui&&0!=o.ui.showBaseLayerControls;let r=e.document.getElementById("gl-left-panel");if(n){if(!r){r=e.document.createElement("div"),r.id="gl-left-panel",r.className="gl-left-panel";const t=e.document.getElementById("geoleaf-map")||e.document.querySelector(".gl-map");t?t.appendChild(r):e.document.body.appendChild(r)}GeoLeaf.DOMSecurity.clearElementFast(r),Object.keys(i).forEach(function(t){const o=i[t],n=e.document.createElement("button");n.className="gl-baselayer-btn",n.setAttribute("data-gl-baselayer",t),n.setAttribute("aria-label",o.label||t),n.textContent=o.label||t,r.appendChild(n)}),r.style.display="flex",t.info("[GeoLeaf.Baselayers] Contr\xf4les de fond de carte cr\xe9\xe9s avec",Object.keys(i).length,"boutons"),setTimeout(function(){u()},50)}else r&&(r.style.display="none")}(g),function(){if(r||!e.document)return;let t;r=1,e.document.addEventListener("click",function(e){const t=e.target.closest("[data-gl-baselayer]");if(!t)return;const o=t.getAttribute("data-gl-baselayer");o&&(e.preventDefault(),d(o))}),e.addEventListener("resize",function(){clearTimeout(t),t=setTimeout(function(){u()},100)})}(),{map:o,activeKey:p(),layers:f()}},registerBaseLayer:s,registerBaseLayers:c,setBaseLayer:d,setActive:d,getBaseLayers:f,getActiveKey:p,getActiveLayer:function(){return n&&i[n]?i[n].layer:null}}}();GeoLeaf.Baselayers=o,GeoLeaf.BaseLayers=o}(window)),ee||(ee=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log,o=GeoLeaf.Utils;function n(e,t){return t.split(".").reduce((e,t)=>e&&void 0!==e[t]?e[t]:null,e)}function r(){try{if(GeoLeaf.Config&&"function"==typeof GeoLeaf.Config.getActiveProfile){const e=GeoLeaf.Config.getActiveProfile(),o=new Set;if(e&&e.panels&&e.panels.detail&&Array.isArray(e.panels.detail.layout)&&e.panels.detail.layout.filter(e=>1==e.search&&e.field).forEach(e=>o.add(e.field)),e&&e.panels&&e.panels.route&&Array.isArray(e.panels.route.layout)&&e.panels.route.layout.filter(e=>1==e.search&&e.field).forEach(e=>o.add(e.field)),o.size>0){const e=Array.from(o);return t&&t.debug("[Filters] Champs de recherche depuis layouts (search:true):",e),e}if(e&&e.panels&&e.panels.search&&Array.isArray(e.panels.search.filters)){const o=e.panels.search.filters.find(e=>"search"===e.type);if(o&&Array.isArray(o.searchFields)&&o.searchFields.length>0)return t&&t.debug("[Filters] Champs de recherche depuis searchFields (fallback):",o.searchFields),o.searchFields}}}catch(e){t&&t.warn("[Filters] Erreur extraction searchFields du profil:",e)}const e=["title","label","name"];return t&&t.debug("[Filters] Utilisation des champs de recherche par d\xe9faut:",e),e}GeoLeaf.Filters={filterPoiList:function(e,i){const a=i.categoriesTree||[],l=i.subCategoriesTree||[],s=a.length>0,c=l.length>0,u=!!i.hasMinRating,d=i.minRating,f=i.selectedTags||[],p=i.hasTags,g=i.dataTypes||{poi:1,routes:1},y=i.searchText||"",h=i.hasSearchText||0,m=i.proximity||{active:0};if(t&&t.debug("[Filters] D\xe9but filtrage POI:",{totalPOI:e.length,hasCats:s,hasSubs:c,hasSearchText:h,proximityActive:m.active}),!Array.isArray(e)||0===e.length)return t&&t.debug("[Filters] Aucun POI \xe0 filtrer"),[];const b=o?o.getDistance:null;return e.filter(function(e){const t=e.attributes||{},o=e.properties||{},i=e.type||t.type||o.type||"poi";if("route"===i||"routes"===i){if(!g.routes)return 0}else if(!g.poi)return 0;if(h){const t=r();let o=0;for(let r=0;r<t.length;r++){const i=n(e,t[r]);if(i&&String(i).toLowerCase().includes(y)){o=1;break}}if(!o)return 0}if(m.active&&m.center&&b){let n,r;if(e.latlng&&Array.isArray(e.latlng)&&2===e.latlng.length?(n=e.latlng[0],r=e.latlng[1]):(n=e.lat||e.latitude||t.latitude||o.latitude||e.coordinates&&e.coordinates[1]||e.geometry&&e.geometry.coordinates&&e.geometry.coordinates[1],r=e.lng||e.longitude||t.longitude||o.longitude||e.coordinates&&e.coordinates[0]||e.geometry&&e.geometry.coordinates&&e.geometry.coordinates[0]),!n||!r)return 0;if(b(m.center.lat,m.center.lng,n,r)>m.radius)return 0}const _=t.categoryId||e.categoryId||e.category||o.categoryId||o.category||null,v=t.subCategoryId||e.subCategoryId||e.subCategory||e.sub_category||o.subCategoryId||o.sub_category||null;if(s||c)if(c){if(!v||!l.includes(String(v)))return s&&_&&a.includes(String(_)),0}else if(s&&(!_||!a.includes(String(_))))return 0;if(u){let n=0,r=0,i=t.reviews||e.reviews||o.reviews;if(i&&"object"==typeof i&&!Array.isArray(i)?"number"==typeof i.rating&&(n=i.rating,r=1):Array.isArray(i)&&i.length>0?(n=i.reduce((e,t)=>e+(Number(t.rating)||0),0)/i.length,r=n>0):"number"==typeof t.rating?(n=t.rating,r=1):"number"==typeof e.rating?(n=e.rating,r=1):"number"==typeof o.rating&&(n=o.rating,r=1),!r||n<d)return 0}if(p){let n=t.tags||e.tags||o.tags||[];if(Array.isArray(n)||(n="string"==typeof n?n.split(/[,;]+/):[]),n=n.map(e=>String(e).trim()).filter(Boolean),!f.some(e=>n.includes(e)))return 0}return 1})},filterRouteList:function(e,i){const a=i.categoriesTree||[],l=i.subCategoriesTree||[],s=a.length>0,c=l.length>0,u=i.selectedTags||[],d=i.hasTags,f=!!i.hasMinRating,p=i.minRating,g=i.searchText||"",y=i.hasSearchText||0,h=i.proximity||{active:0};if(t&&t.debug("[Filters] D\xe9but filtrage routes:",{totalRoutes:e.length,hasCats:s,hasSubs:c,hasMinRating:f,minRating:p,hasSearchText:y,proximityActive:h.active}),!Array.isArray(e)||0===e.length)return t&&t.debug("[Filters] Aucune route \xe0 filtrer"),[];const m=o?o.getDistance:null;return e.filter(function(e){const t=e.attributes||{},o=e.properties||{};if(y){const t=r();let o=0;for(let r=0;r<t.length;r++){const i=n(e,t[r]);if(i&&String(i).toLowerCase().includes(g)){o=1;break}}if(!o)return 0}const i=t.categoryId||e.categoryId||e.category||o.categoryId||o.category||null,b=t.subCategoryId||e.subCategoryId||e.subCategory||e.sub_category||o.subCategoryId||o.sub_category||null;if(s||c)if(c){if(!b||!l.includes(String(b)))return s&&i&&a.includes(String(i)),0}else if(s&&(!i||!a.includes(String(i))))return 0;if(d){let n=t.tags||e.tags||o.tags||[];if(Array.isArray(n)||(n="string"==typeof n?n.split(/[,;]+/):[]),n=n.map(e=>String(e).trim()).filter(Boolean),!u.some(e=>n.includes(e)))return 0}if(f){let n=0,r=0,i=t.reviews||e.reviews||o.reviews;if(i&&"object"==typeof i&&!Array.isArray(i)?"number"==typeof i.rating&&(n=i.rating,r=1):Array.isArray(i)&&i.length>0?(n=i.reduce((e,t)=>e+(Number(t.rating)||0),0)/i.length,r=n>0):"number"==typeof t.rating?(n=t.rating,r=1):"number"==typeof e.rating?(n=e.rating,r=1):"number"==typeof o.rating&&(n=o.rating,r=1),!r||n<p)return 0}if(h.active&&h.center&&m){const t=function(e){if(Array.isArray(e.geometry)&&e.geometry.length>0){if(Array.isArray(e.geometry[0])&&"number"==typeof e.geometry[0][0]&&"number"==typeof e.geometry[0][1])return e.geometry.map(e=>[e[0],e[1]]);if(e.geometry[0]&&"object"==typeof e.geometry[0]&&"LineString"===e.geometry[0].type&&Array.isArray(e.geometry[0].coordinates))return e.geometry[0].coordinates.map(e=>[e[1],e[0]])}return e.geometry&&"object"==typeof e.geometry&&"LineString"===e.geometry.type&&Array.isArray(e.geometry.coordinates)?e.geometry.coordinates.map(e=>[e[1],e[0]]):[]}(e);if(0===t.length)return 0;let o=0;for(let e=0;e<t.length;e++){const n=t[e][0],r=t[e][1];if(m(h.center.lat,h.center.lng,n,r)<=h.radius){o=1;break}}if(!o)return 0}return 1})}}}("undefined"!=typeof window?window:gt)),te||(te=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{};GeoLeaf._POIShared=GeoLeaf._POIShared||{};const t=GeoLeaf.Constants?.POI_MARKER_SIZE||16,o=GeoLeaf.Constants?.POI_MAX_ZOOM||18,n={poiLayerGroup:null,poiClusterGroup:null,allPois:[],poiMarkers:new Map,poiConfig:{},mapInstance:null,isLoading:0,sidePanelElement:null,currentPoiInPanel:null,sidePanelOverlay:null,currentGalleryIndex:0};GeoLeaf._POIShared={constants:Object.freeze({POI_MARKER_SIZE:t,POI_MAX_ZOOM:o,defaultIconUrl:"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSI4IiBmaWxsPSIjNGE5MGU1IiBzdHJva2U9IiNmZmYiIHN0cm9rZS13aWR0aD0iMiIvPjwvc3ZnPg=="}),state:n,ensureMapMaxZoom:function(e,t=18){e&&e.options&&("number"!=typeof e.options.maxZoom||isNaN(e.options.maxZoom))&&(e.options.maxZoom=t)}}}("undefined"!=typeof window?window:gt)),oe||(oe=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log,o=GeoLeaf.Security||{},n=GeoLeaf.Utils||{};GeoLeaf._POINormalizers=GeoLeaf._POINormalizers||{},GeoLeaf._POINormalizers={normalizePoi:function(e){if(!e)return null;const t=e,r=t&&"object"==typeof t.attributes&&t.attributes?t.attributes:{},i=t.properties||{},a=e=>{if(!e||"string"!=typeof e)return null;const t=e.trim();return t.match(/^(https?:\/\/|data:image\/)/i)?t:null},l=o.escapeHtml||(e=>{if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}),s=n.resolveField||((e,...t)=>{for(const o of t){const t=o.split(".");let n=e;for(const e of t){if(!n||"object"!=typeof n||!(e in n)){n=null;break}n=n[e]}if(n&&"string"==typeof n&&n.trim())return n}return""}),c={id:t.id||null,latlng:t.latlng||null,title:l(s(t,"title","label","name","attributes.title","properties.label","properties.name")||"Sans nom"),label:l(s(t,"label","name","title")),name:l(s(t,"name","label","title")),description:l(s(t,"description","attributes.description")),properties:t.properties||{},attributes:{...r,shortDescription:l(s(t,"description","attributes.shortDescription","properties.description")),longDescription:l(s(t,"attributes.description_long","description_long","properties.description_long","attributes.longDescription")),categoryId:r.categoryId||t.categoryId||t.category||i.category||null,subCategoryId:r.subCategoryId||t.subCategoryId||t.sub_category||i.sub_category||null,mainImage:a(r.photo||r.mainImage||i.photo||r.gallery&&r.gallery[0]||t.gallery&&t.gallery[0]||null),gallery:(r.gallery||t.gallery||i.gallery||t.images||i.images||[]).map(e=>"string"==typeof e?a(e):e&&e.url?a(e.url):null).filter(Boolean),price:r.price||t.price||i.price||null,openingHours:r.opening_hours||r.openingHours||t.opening_hours||i.opening_hours||t.openingHours||i.openingHours||null,openingHoursTable:null,reviews:r.reviews||t.reviews||i.reviews||null,tags:(r.tags||t.tags||i.tags||[]).map(e=>l(String(e))),website:a(r.link||r.website||t.link||i.link||t.website||i.website||null),address:l(s(t,"attributes.address","address","properties.address")),phone:l(s(t,"attributes.phone","phone","properties.phone")),email:l(s(t,"attributes.email","email","properties.email")),services:(r.services||t.services||i.services||[]).map(e=>l(String(e)))}};return c.attributes.openingHours&&Array.isArray(c.attributes.openingHours)&&(c.attributes.openingHoursTable=c.attributes.openingHours.map(e=>{if(null==e)return null;const t=String(e).trim();if(!t)return null;const o=t.split(":");if(o.length>1){const e=o.shift().trim(),t=o.join(":").trim();let n="",r="";const i=t.split(/[\u2013-]/);return i.length>1?(n=i[0].trim(),r=i.slice(1).join("\u2013").trim()):n=t,{day:e,open:n,close:r}}return{day:t,open:"",close:""}}).filter(Boolean)),e._sidepanelConfig&&(c._sidepanelConfig=e._sidepanelConfig),e._layerConfig&&(c._layerConfig=e._layerConfig),c},getFieldValue:function(e,o){if(!e||!o)return null;e.id,e.properties,e.attributes,e.properties&&Object.keys(e.properties),e.attributes&&Object.keys(e.attributes),t&&"function"==typeof t.debug&&t.debug("[POI.getFieldValue] Recherche fieldPath:",o,"| POI:",e.id);const n=o.split(".");let r=e;for(const e of n){if(null==r||"object"!=typeof r)return t&&"function"==typeof t.debug&&t.debug("[POI.getFieldValue] Chemin interrompu \xe0 la partie:",e,"| value actuelle:",r),null;r=r[e]}return t&&"function"==typeof t.debug&&t.debug("[POI.getFieldValue] Valeur trouv\xe9e pour",o,":",r),void 0===r||""===r||Array.isArray(r)&&0===r.length?(t&&"function"==typeof t.debug&&t.debug("[POI.getFieldValue] Valeur vide ou tableau vide, retourne null"),null):r},extractCoordinates:function(e){if(!e)return null;let t,o;return Array.isArray(e.latlng)&&e.latlng.length>=2?(t=e.latlng[0],o=e.latlng[1]):e.latlng&&"object"==typeof e.latlng?(t=e.latlng.lat,o=e.latlng.lng||e.latlng.lon):"number"==typeof e.lat&&"number"==typeof e.lng?(t=e.lat,o=e.lng):"number"==typeof e.latitude&&"number"==typeof e.longitude?(t=e.latitude,o=e.longitude):e.geometry&&Array.isArray(e.geometry.coordinates)&&(o=e.geometry.coordinates[0],t=e.geometry.coordinates[1]),"number"!=typeof t||"number"!=typeof o||isNaN(t)||isNaN(o)||t<-90||t>90||o<-180||o>180?null:[t,o]},generatePoiId:function(e){const t=Date.now(),o=Math.floor(1e4*Math.random());return`poi-${(e.title||e.label||e.name||"poi").toLowerCase().replace(/[^a-z0-9]/g,"-").substring(0,20)}-${t}-${o}`}}}("undefined"!=typeof window?window:gt)),ne||(ne=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log||console,o=GeoLeaf.Security||{},n=GeoLeaf.Utils||{};function r(){return GeoLeaf._ContentBuilder||null}function i(e,t){if(!e||!t)return null;if(n.resolveField)return n.resolveField(e,t);const o=t.split(".");let r=e;for(const e of o){if(!r||"object"!=typeof r||!(e in r))return null;r=r[e]}return r}function a(e){if(!e)return"";if(o.escapeHtml)return o.escapeHtml(e);const t=document.createElement("div");return t.textContent=e,t.innerHTML}function l(e){if(e._layerConfig?.popup?.detailPopup)return t.info&&t.info("[POI Popup] Config popup depuis layerConfig"),e._layerConfig.popup.detailPopup;const o=GeoLeaf.Config;if(o&&"function"==typeof o.getActiveProfile){const e=o.getActiveProfile();if(e?.popup?.detailPopup)return t.info&&t.info("[POI Popup] Config popup depuis profil actif (profile.popup.detailPopup)"),e.popup.detailPopup;if(e?.panels?.poi?.popup?.detailPopup)return t.info&&t.info("[POI Popup] Config popup depuis profil actif (profile.panels.poi.popup.detailPopup - ancienne structure)"),e.panels.poi.popup.detailPopup}return t.warn&&t.warn("[POI Popup] Aucune configuration detailPopup trouv\xe9e pour POI:",e.id||"unknown"),null}function s(e){if(e._layerConfig?.popup?.detailTooltip)return e._layerConfig.popup.detailTooltip;if(e._layerConfig?.tooltip?.detailTooltip)return e._layerConfig.tooltip.detailTooltip;if(e._layerConfig?.detailTooltip)return e._layerConfig.detailTooltip;const t=GeoLeaf.Config;if(t&&"function"==typeof t.getActiveProfile){const e=t.getActiveProfile();if(e?.popup?.detailTooltip)return e.popup.detailTooltip}return null}function c(e,o){if(!e)return t.warn&&t.warn("[POI Tooltip] POI invalide"),"";const n=s(e),l=r();return l&&"function"==typeof l.buildTooltipHTML?l.buildTooltipHTML(e,n,{resolveCategoryDisplay:o}):a(i(e,"title")||i(e,"label")||i(e,"name")||"POI")}function u(e,o,n){if(!e||"function"!=typeof e.bindTooltip)return void(t.warn&&t.warn("[POI Popup] Marker invalide pour attachTooltip"));const r=Object.assign({},{direction:"top",offset:[0,-10],opacity:.9,className:"gl-poi-tooltip"},n||{});e.bindTooltip(o,r)}GeoLeaf._POIPopup=GeoLeaf._POIPopup||{},GeoLeaf._POIPopup={buildQuickPopupContent:function(e,o){if(!e)return t.warn&&t.warn("[POI Popup] POI invalide"),"";const n=l(e),s=r();return s&&"function"==typeof s.buildPopupHTML?s.buildPopupHTML(e,n,{resolveCategoryDisplay:o}):(t.warn&&t.warn("[POI Popup] ContentBuilder non disponible, fallback basique"),function(e){const t=a(i(e,"title")||i(e,"label")||i(e,"name")||"POI"),o=i(e,"attributes.description")||i(e,"description")||"";let n='<div class="gl-poi-popup">';return n+='<div class="gl-poi-popup__body">',n+='<h3 class="gl-poi-popup__title"><span class="gl-poi-popup__title-text">'+t+"</span></h3>",o&&(n+='<p class="gl-poi-popup__desc">'+a(o)+"</p>"),n+='<a href="#" class="gl-poi-popup__link" data-poi-id="'+(e.id||"")+'">Voir plus >>></a>',n+="</div></div>",n}(e))},buildTooltipContent:c,attachTooltip:u,manageTooltip:function(e,t,o,n){if(!e||!t)return;const r=o?.tooltipMode||"hover";if("none"===r)return;const i=c(t,n);"permanent"===r?u(e,i,{permanent:1}):u(e,i)},attachPopup:function(e,o,n){if(!e||"function"!=typeof e.bindPopup)return void(t.error&&t.error("[POI Popup] Marker invalide ou pas de bindPopup"));const r=Object.assign({},{maxWidth:300,minWidth:200,className:"gl-poi-popup-leaflet",closeButton:1,autoPan:1},n||{});e.bindPopup(o,r)},getPopupConfig:l,getTooltipConfig:s},t.info&&t.info("[GeoLeaf._POIPopup] Module POI Popup/Tooltip charg\xe9 (v2.0.0)")}("undefined"!=typeof window?window:gt)),re||(re=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log;GeoLeaf._POIMarkers=GeoLeaf._POIMarkers||{};const o=()=>GeoLeaf._POIShared;function n(){const e={radius:6,weight:1.5,colorFill:"#4a90e5",colorStroke:"#ffffff",fillOpacity:.8,opacity:.9,showIconsOnMap:1};try{if(GeoLeaf.Config&&"function"==typeof GeoLeaf.Config.getActiveProfile){const t=GeoLeaf.Config.getActiveProfile(),o=t&&t.appearance&&t.appearance.poi;o&&("number"==typeof o.radius&&(e.radius=o.radius),"number"==typeof o.weight&&(e.weight=o.weight),"number"==typeof o.fillOpacity&&(e.fillOpacity=o.fillOpacity),"number"==typeof o.opacity&&(e.opacity=o.opacity),"boolean"==typeof o.showIconsOnMap&&(e.showIconsOnMap=o.showIconsOnMap),"string"==typeof o.colorFill&&(e.colorFill=o.colorFill),"string"==typeof o.colorStroke&&(e.colorStroke=o.colorStroke))}if("undefined"!=typeof document&&"undefined"!=typeof window&&window.getComputedStyle){const t=getComputedStyle(document.documentElement),o=t.getPropertyValue("--gl-color-poi-fill-default").trim(),n=t.getPropertyValue("--gl-color-poi-stroke-default").trim();o&&!e.colorFill&&(e.colorFill=o),n&&!e.colorStroke&&(e.colorStroke=n)}}catch(e){t&&t.warn("[POI] getPoiBaseConfig() : Erreur lecture config :",e)}return e}function r(e){const r=GeoLeaf.Config&&"function"==typeof GeoLeaf.Config.getCategories?GeoLeaf.Config.getCategories():{},i=o(),a=0!=(i?i.state.poiConfig:{}).showIconsOnMap,l=function(e,t){let o={colorFill:t.colorFill,colorStroke:t.colorStroke,colorRoute:null,weight:t.weight,radius:t.radius,fillOpacity:void 0!==t.fillOpacity?t.fillOpacity:null,opacity:void 0!==t.opacity?t.opacity:null};if(e._layerConfig&&e._layerConfig.style){const t=e._layerConfig.style;t.fillColor&&(o.colorFill=t.fillColor),t.color&&(o.colorStroke=t.color),"number"==typeof t.weight&&(o.weight=t.weight),"number"==typeof t.radius&&(o.radius=t.radius),"number"==typeof t.fillOpacity&&(o.fillOpacity=t.fillOpacity),"number"==typeof t.opacity&&(o.opacity=t.opacity)}if(GeoLeaf.Helpers&&GeoLeaf.Helpers.StyleResolver){const t=GeoLeaf.Helpers.StyleResolver.resolvePoiColors(e);t.colorFill&&(o.colorFill=t.colorFill),t.colorStroke&&(o.colorStroke=t.colorStroke),t.colorRoute&&(o.colorRoute=t.colorRoute)}return o}(e,n());let s={useIcon:0,iconId:null,colorFill:l.colorFill,colorStroke:l.colorStroke,colorRoute:l.colorRoute,weight:l.weight,radius:l.radius,fillOpacity:l.fillOpacity,opacity:l.opacity};if(a)try{const e=GeoLeaf.Config&&"function"==typeof GeoLeaf.Config.getIconsConfig?GeoLeaf.Config.getIconsConfig():null;e&&0!=e.showOnMap&&(s.useIcon=1)}catch(e){}const c=e.categoryId||e.category||e.attributes&&e.attributes.categoryId||e.properties&&e.properties.categoryId||e.properties&&e.properties.category,u=e.subCategoryId||e.subCategory||e.sub_category||e.attributes&&e.attributes.subCategoryId||e.properties&&e.properties.subCategoryId||e.properties&&e.properties.sub_category;if(u&&c&&r[c]?.subcategories){const e=r[c].subcategories[u],t=r[c];s.iconId=e?e.icon||e.iconId||t.icon||t.iconId||null:t.icon||t.iconId||null}else if(c&&r[c]){const e=r[c];s.iconId=e.icon||e.iconId||null}else c&&"undefined"!==c&&"null"!==c&&t&&t.warn(`[POI] resolveCategoryDisplay() : Cat\xe9gorie '${c}' non trouv\xe9e dans la taxonomie.`);return s}function i(e){if(!e)return t&&t.warn("[POI] extractMarkerCoordinates() : POI invalide.",e),null;const o=GeoLeaf._POINormalizers;return o?o.extractCoordinates(e)||(t&&t.warn("[POI] extractMarkerCoordinates() : POI sans coordonn\xe9es valides.",e),null):(t&&t.error("[POI] extractMarkerCoordinates() : Module Normalizers non charg\xe9."),null)}function a(e){const t=n(),o=void 0!==e.radius?e.radius:t.radius,r=void 0!==e.weight?e.weight:t.weight,i=e.fillOpacity,a=e.opacity,l=Math.max(Math.round(2*o+2*r),8),s=Math.max(Math.round(2*o+2*r),16);let c=e.colorFill;if(null!==i&&"number"==typeof i&&c&&c.startsWith("#")){const e=parseInt(c.slice(1,3),16),t=parseInt(c.slice(3,5),16),o=parseInt(c.slice(5,7),16);c="rgba("+e+", "+t+", "+o+", "+i+")"}let u=e.colorStroke;if(null!==a&&"number"==typeof a&&u&&u.startsWith("#")){const e=parseInt(u.slice(1,3),16),t=parseInt(u.slice(3,5),16),o=parseInt(u.slice(5,7),16);u="rgba("+e+", "+t+", "+o+", "+a+")"}if(e.useIcon&&e.iconId){const t=GeoLeaf.Config&&"function"==typeof GeoLeaf.Config.getIconsConfig?GeoLeaf.Config.getIconsConfig():null,o=['<div class="gl-poi-marker" style="',"--gl-poi-fill:",c,";","--gl-poi-stroke:",u,";","width:",s,"px;","height:",s,"px;",'">','<svg class="gl-poi-marker__icon" aria-hidden="true" focusable="false" viewBox="0 0 24 24" style="overflow: visible;">','<circle cx="12" cy="12" r="10" fill="',c,'" stroke="',u,'" stroke-width="',r,'"/>','<svg x="2" y="2" width="20" height="20" viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" overflow="visible">','<use href="#',(t&&t.symbolPrefix||"gl-poi-cat-")+String(e.iconId).trim().toLowerCase().replace(/\s+/g,"-"),'" style="color: #ffffff"/>',"</svg>","</svg>","</div>"].join("");return L.divIcon({html:o,className:"gl-poi-divicon",iconSize:[s,s],iconAnchor:[s/2,s/2],popupAnchor:[0,-s/2]})}{const e=['<div class="gl-poi-marker" style="',"--gl-poi-fill:",c,";","--gl-poi-stroke:",u,";","width:",l,"px;","height:",l,"px;",'">','<svg class="gl-poi-marker__circle" aria-hidden="true" focusable="false">','<circle cx="50%" cy="50%" r="',o,'"',' fill="',c,'"',' stroke="',u,'"',' stroke-width="',r,'" />',"</svg>","</div>"].join("");return L.divIcon({html:e,className:"gl-poi-divicon",iconSize:[l,l],iconAnchor:[l/2,l/2],popupAnchor:[0,-l/2]})}}function l(e,n){e._geoleafPoiData=n;const i=o(),a=i?i.state.poiConfig:{},l=GeoLeaf._POIPopup;if(l&&"function"==typeof l.manageTooltip&&l.manageTooltip(e,n,a,r),0!=a.showPopup){if(l&&"function"==typeof l.buildQuickPopupContent){const o=l.buildQuickPopupContent(n,r);o?l.attachPopup?l.attachPopup(e,o):e.bindPopup(o):t.error("[markers] Popup content vide pour POI:",n.id),e._geoleafPopupActive=0,e.on("tooltipopen",function(){e._geoleafPopupActive&&e.closeTooltip()}),e.on("popupopen",function(){e._geoleafPopupActive=1,e.closeTooltip(),setTimeout(function(){const o=document.querySelector('.gl-poi-popup__link[data-poi-id="'+n.id+'"]');if(o){t&&t.info('[POI] Lien "Voir plus" trouv\xe9 pour POI:',n.id);const r=o.cloneNode(1);o.parentNode.replaceChild(r,o),r.addEventListener("click",function(o){o.preventDefault(),o.stopPropagation(),t&&t.info('[POI] Clic sur "Voir plus" pour POI:',n.id),e&&e.closePopup&&e.closePopup(),setTimeout(function(){t&&t.info("[POI] Appel de showPoiDetails pour:",n.id),GeoLeaf.POI&&"function"==typeof GeoLeaf.POI.showPoiDetails?GeoLeaf.POI.showPoiDetails(n):t&&t.error("[POI] GeoLeaf.POI.showPoiDetails non disponible")},100)})}else t&&t.warn('[POI] Lien "Voir plus" non trouv\xe9 pour POI:',n.id)},50)}),e.on("popupclose",function(){e._geoleafPopupActive=0,e.getTooltip()&&e.getTooltip().options.permanent&&setTimeout(function(){e.openTooltip&&!e._geoleafPopupActive&&e.openTooltip()},50)})}}else e.on("click",function(e){e.originalEvent.stopPropagation(),t&&t.info("[POI] Clic direct sur marker (sans popup) pour POI:",n.id),GeoLeaf.POI&&"function"==typeof GeoLeaf.POI.showPoiDetails?GeoLeaf.POI.showPoiDetails(n):t&&t.error("[POI] GeoLeaf.POI.showPoiDetails non disponible")})}GeoLeaf._POIMarkers={getPoiBaseConfig:n,resolveCategoryDisplay:r,ensureProfileSpriteInjectedSync:async function e(){try{if(void 0===GeoLeaf.Config||"function"!=typeof GeoLeaf.Config.getIconsConfig)return void(t&&t.warn("[POI] GeoLeaf.Config.getIconsConfig non disponible"));const o=GeoLeaf.Config.getIconsConfig();if(e._lastConfig&&JSON.stringify(o)===JSON.stringify(e._lastConfig)||(t&&t.debug("[POI] IconsConfig r\xe9cup\xe9r\xe9:",o),e._lastConfig=o),!o)return void(t&&t.warn("[POI] Aucune configuration d'ic\xf4nes trouv\xe9e"));const n=o.spriteUrl;if(!n||"string"!=typeof n)return void(t&&t.warn("[POI] spriteUrl manquant ou invalide:",n));if(document.querySelector('svg[data-geoleaf-sprite="profile"]'))return void(t&&t.debug("[POI] Sprite SVG d\xe9j\xe0 inject\xe9"));t&&t.info("[POI] Chargement sprite depuis:",n);try{const e=await fetch(n);if(e.ok){const o=await e.text(),n=(new DOMParser).parseFromString(o,"image/svg+xml"),r=n.querySelector("parsererror");if(r)return void(t&&t.warn("[POI] Erreur parsing SVG sprite :",r.textContent));const i=n.documentElement;if(i&&"svg"===i.tagName.toLowerCase()){i.setAttribute("data-geoleaf-sprite","profile"),i.style.position="absolute",i.style.width="0",i.style.height="0",i.style.overflow="hidden",i.setAttribute("aria-hidden","true"),document.body.firstChild?document.body.insertBefore(i,document.body.firstChild):document.body.appendChild(i);const e=i.querySelectorAll("symbol").length;t&&t.info("[POI] Sprite SVG profil inject\xe9 dans le DOM (async).",e,"symboles charg\xe9s.")}}else t&&t.warn("[POI] Erreur chargement sprite profil: HTTP",e.status)}catch(e){t&&t.warn("[POI] Erreur chargement sprite profil (async):",e)}}catch(e){t&&t.warn("[POI] Erreur chargement sprite profil :",e)}},extractMarkerCoordinates:i,buildMarkerIcon:a,attachMarkerEvents:l,createMarker:function(e,o={}){if(!e)return t&&t.warn("[POI] createMarker() : POI invalide.",e),null;const{attachEvents:n=1,pane:s}=o,c=i(e);if(!c)return null;const[u,d]=c,f={icon:a(r(e))};s&&(f.pane=s);const p=L.marker([u,d],f);return n&&l(p,e),p}}}("undefined"!=typeof window?window:gt)),ie||(ie=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{};GeoLeaf._Renderers||(GeoLeaf._Renderers={}),GeoLeaf._Renderers.AbstractRenderer=class AbstractRenderer{constructor(e={}){this._name=e.name||"Renderer",this._config=e.config||{},this._debug=e.debug||0,this._eventListeners=[],this._initialized=0,this._stateMap=new WeakMap}getLog(){return GeoLeaf.Log||console}getSecurity(){return GeoLeaf.Security&&"function"==typeof GeoLeaf.Security.escapeHtml?GeoLeaf.Security:{escapeHtml:e=>{if(null==e)return"";const t=document.createElement("div");return t.textContent=String(e),t.innerHTML},setSafeHTML:(e,t)=>{e&&(GeoLeaf.DOMSecurity&&"function"==typeof GeoLeaf.DOMSecurity.setSafeHTML?GeoLeaf.DOMSecurity.setSafeHTML(e,t):e.textContent=t)}}}getUtils(){return GeoLeaf.Utils&&"function"==typeof GeoLeaf.Utils.resolveField?GeoLeaf.Utils:{resolveField:(e,...t)=>{if(!e)return null;for(const o of t){if(!o)continue;const t=String(o).split(".");let n=e,r=1;for(const e of t){if(!n||"object"!=typeof n||!(e in n)){r=0;break}n=n[e]}if(r&&null!=n)return n}return null}}}getActiveProfile(){return GeoLeaf.Config&&"function"==typeof GeoLeaf.Config.getActiveProfile&&GeoLeaf.Config.getActiveProfile()||null}log(e,t,...o){if("debug"===e&&!this._debug)return;const n=this.getLog(),r=`[${this._name}]`;switch(e){case"debug":case"info":default:n.info(r,t,...o);break;case"warn":n.warn(r,t,...o);break;case"error":n.error(r,t,...o)}}debug(e,...t){this.log("debug",e,...t)}info(e,...t){this.log("info",e,...t)}warn(e,...t){this.log("warn",e,...t)}error(e,...t){this.log("error",e,...t)}createElement(e,t,o={}){const n=document.createElement(e);return t&&(Array.isArray(t)?n.classList.add(...t):n.className=t),Object.keys(o).forEach(e=>{n.setAttribute(e,o[e])}),n}createTextNode(e){return document.createTextNode(e||"")}createTextElement(e,t,o){const n=this.createElement(e,o);return n.textContent=t||"",n}createHTMLElement(e,t,o){const n=this.createElement(e,o);return this.getSecurity().setSafeHTML(n,t),n}appendChildren(e,...t){return t.forEach(t=>{t&&e.appendChild(t)}),e}addEventListener(e,t,o,n){if(!e||!t||!o)return this.warn("addEventListener: invalid parameters"),()=>{};const r=o.bind(this);e.addEventListener(t,r,n);const i=()=>{e.removeEventListener(t,r,n)};return this._eventListeners.push(i),i}removeAllEventListeners(){this._eventListeners.forEach(e=>e()),this._eventListeners=[]}setState(e,t){e&&this._stateMap.set(e,{...t})}getState(e){return e&&this._stateMap.get(e)||null}updateState(e,t){if(e){const o=this.getState(e)||{};this.setState(e,{...o,...t})}}deleteState(e){e&&this._stateMap.delete(e)}init(){this._initialized?this.warn("Renderer already initialized"):(this.debug("Initializing renderer"),this._initialized=1)}isInitialized(){return this._initialized}destroy(){this.debug("Destroying renderer"),this.removeAllEventListeners(),this._stateMap=new WeakMap,this._initialized=0}render(e,t){throw new Error(`${this._name}.render() must be implemented by subclass`)}},GeoLeaf.Log&&GeoLeaf.Log.info("[GeoLeaf._Renderers.AbstractRenderer] Base class loaded")}(window)),ae||(ae=1,(()=>{const GeoLeaf=window.GeoLeaf||{};if(!GeoLeaf._Renderers||!GeoLeaf._Renderers.AbstractRenderer)return void(GeoLeaf.Log&&GeoLeaf.Log.error("[FieldRenderers] AbstractRenderer not loaded! Load abstract-renderer.js first."));const e=GeoLeaf._Renderers.AbstractRenderer;class FieldRenderers extends e{constructor(e={}){super({name:"FieldRenderers",debug:e.debug||0,config:e.config||{}}),this.init()}render(e){const{section:t,poi:o,value:n,type:r}=e;switch(r){case"text":return this.renderText(t,o,n);case"badge":return this.renderBadge(t,n,o);case"link":return this.renderLink(t,n);case"tags":return this.renderTags(t,n);default:return this.warn("Unknown render type:",r),null}}async renderText(e,t,o){if(this.getSecurity(),"title"===e.style||"title"===e.variant)return await this._renderTitleWithIcon(t,o);if(!o)return this.warn("renderText: no value provided"),null;const n=this.createElement("multiline"===e.variant?"div":"p","gl-poi-sidepanel__desc");return"multiline"===e.variant&&(n.style.whiteSpace="pre-wrap",n.style.lineHeight="1.6"),n.textContent=o,this.info("renderText: element created, variant:",e.variant||"normal"),n}async _renderTitleWithIcon(e,t){const o=this.createElement("h2","gl-poi-sidepanel__title"),n=this._getMarkers();if(n&&n.resolveCategoryDisplay&&n.ensureProfileSpriteInjectedSync){const t=n.resolveCategoryDisplay(e);if(this.debug("_renderTitleWithIcon: displayInfo =",t),t.iconId){await n.ensureProfileSpriteInjectedSync();const e=this._createCategoryIcon(t);e?(this.debug("_renderTitleWithIcon: SVG icon created successfully"),o.appendChild(e)):this.warn("_renderTitleWithIcon: SVG icon creation failed")}else this.debug("_renderTitleWithIcon: No iconId in displayInfo")}else this.warn("_renderTitleWithIcon: Markers or required methods not available");const r=this.createTextElement("span",t||e.title||e.label||e.name||"POI","gl-poi-sidepanel__title-text");return o.appendChild(r),this.info("renderText: title element created with icon"),o}_createCategoryIcon(e){const t=GeoLeaf.Config&&"function"==typeof GeoLeaf.Config.getIconsConfig?GeoLeaf.Config.getIconsConfig():null,o=t&&t.symbolPrefix||"gl-poi-cat-",n=o+String(e.iconId).trim().toLowerCase().replace(/\s+/g,"-");this.debug("_createCategoryIcon: symbolId =",n,", colors =",e.colorFill,e.colorStroke),this.debug("_createCategoryIcon: iconPrefix from config =",o);const r=document.querySelector('svg[data-geoleaf-sprite="profile"]');r?this.debug("_createCategoryIcon: Sprite trouv\xe9, nombre de symboles:",r.querySelectorAll("symbol").length):this.warn("_createCategoryIcon: Sprite SVG non trouv\xe9 dans le DOM! Le sprite doit \xeatre charg\xe9 avant.");const i=r?r.querySelector(`#${n}`):null;if(!i&&(this.warn("_createCategoryIcon: Symbole non trouv\xe9 dans le sprite:",n),r)){const e=Array.from(r.querySelectorAll("symbol")).map(e=>e.id).slice(0,5);this.debug("_createCategoryIcon: Premiers symboles disponibles:",e)}const a=document.createElementNS("http://www.w3.org/2000/svg","svg");a.setAttribute("width","32"),a.setAttribute("height","32"),a.setAttribute("viewBox","0 0 24 24"),a.setAttribute("class","gl-poi-sidepanel__icon"),a.style.marginRight="10px",a.style.flexShrink="0";const l=document.createElementNS("http://www.w3.org/2000/svg","circle");if(l.setAttribute("cx","12"),l.setAttribute("cy","12"),l.setAttribute("r","10"),l.setAttribute("fill",e.colorFill||"#3388ff"),l.setAttribute("stroke",e.colorStroke||"#fff"),l.setAttribute("stroke-width","1.5"),a.appendChild(l),i){const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("x","4"),e.setAttribute("y","4"),e.setAttribute("width","16"),e.setAttribute("height","16"),e.setAttribute("viewBox","0 0 32 32");const t=document.createElementNS("http://www.w3.org/2000/svg","use");t.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href","#"+n),t.setAttribute("href","#"+n),t.style.color="#ffffff",e.appendChild(t),a.appendChild(e)}return this.debug("_createCategoryIcon: SVG structure created"),a}renderBadge(e,t,o){if(!t)return null;const n=this.createElement("div","gl-poi-badge-container"),r=this.createTextElement("span",t,"gl-poi-badge"),i=this._getMarkers();if(i&&i.resolveCategoryDisplay){const e=i.resolveCategoryDisplay(o);e.colorFill&&(r.style.background=e.colorFill,r.style.color="#fff")}return n.appendChild(r),n}renderLink(e,t){if(!t)return null;const o=this.createElement("p","gl-poi-sidepanel__link"),n=this.createElement("a",null,{href:t,target:"_blank",rel:"noopener noreferrer"});return n.textContent=e.linkText||t,o.appendChild(n),o}renderTags(e,t){if(!t||!Array.isArray(t)||0===t.length)return null;const o=this.createElement("div","gl-poi-sidepanel__tags");return t.forEach(e=>{if(e){const t=this.createTextElement("span",e,"gl-poi-tag");o.appendChild(t)}}),o}_getMarkers(){return GeoLeaf._POIMarkers||null}}GeoLeaf.POI||(GeoLeaf.POI={}),GeoLeaf.POI.Renderers||(GeoLeaf.POI.Renderers={}),GeoLeaf.POI.Renderers.FieldRenderers=FieldRenderers;let t=null;const o=()=>(t||(t=new FieldRenderers),t);GeoLeaf.POI.Renderers.renderText=(e,t,n)=>o().renderText(e,t,n),GeoLeaf.POI.Renderers.renderBadge=(e,t,n)=>o().renderBadge(e,t,n),GeoLeaf.POI.Renderers.renderLink=(e,t)=>o().renderLink(e,t),GeoLeaf.POI.Renderers.renderTags=(e,t)=>o().renderTags(e,t),GeoLeaf.Log&&GeoLeaf.Log.info("[POI.Renderers.FieldRenderers] Loaded (v2.0 - AbstractRenderer)")})()),le||(le=1,(()=>{const GeoLeaf=window.GeoLeaf||{};if(!GeoLeaf._Renderers||!GeoLeaf._Renderers.AbstractRenderer)return void console.error("[MediaRenderers] AbstractRenderer not loaded! Load abstract-renderer.js first.");const e=GeoLeaf._Renderers.AbstractRenderer;class MediaRenderers extends e{constructor(e={}){super({name:"MediaRenderers",debug:e.debug||0,config:e.config||{}}),this.init()}render(e){const{section:t,value:o,type:n}=e;switch(n){case"image":return this.renderImage(t,o);case"gallery":return this.renderGallery(t,o);default:return this.warn("Unknown media render type:",n),null}}renderImage(e,t){if(!t)return null;const o="hero"===e.variant?"gl-poi-sidepanel__photo gl-poi-sidepanel__photo--hero":"gl-poi-sidepanel__photo",n=this.createElement("div",o),r=this.createElement("img",null,{src:t,alt:e.label||"Photo",loading:"lazy"});return n.appendChild(r),n}renderGallery(e,t){if(!t||!Array.isArray(t)||0===t.length)return this.warn("renderGallery: invalid gallery data",t),null;this.info("renderGallery: rendering",t.length,"images");const o=this.createElement("div","gl-poi-gallery"),n=this._createMainImage(t[0]);if(o.appendChild(n),t.length>1){const e=this._createThumbnails(t,n);o.appendChild(e)}return o}_createMainImage(e){const t=this.createElement("div","gl-poi-gallery__main",{"data-gallery-index":"0"}),o=this.createElement("img",null,{src:e,alt:"Image 1",loading:"lazy"});return t.appendChild(o),t}_createThumbnails(e,t){const o=this.createElement("div","gl-poi-gallery__thumbnails"),n=t.querySelector("img");return e.forEach((e,r)=>{const i=this._createThumbnail(e,r,n,t,o);o.appendChild(i)}),o}_createThumbnail(e,t,o,n,r){const i=this.createElement("div",0===t?"gl-poi-gallery__thumb active":"gl-poi-gallery__thumb",{"data-index":t.toString()}),a=this.createElement("img",null,{src:e,alt:`Image ${t+1}`,loading:"lazy"});return i.appendChild(a),this.addEventListener(i,"click",a=>{a.preventDefault(),a.stopPropagation(),r.querySelectorAll(".gl-poi-gallery__thumb").forEach(e=>e.classList.remove("active")),i.classList.add("active"),o.src=e,o.alt=`Image ${t+1}`,n.setAttribute("data-gallery-index",t.toString()),this.info("Gallery: Switched to image",t+1)},1),i}destroy(){this.debug("Destroying MediaRenderers"),super.destroy()}}GeoLeaf.POI||(GeoLeaf.POI={}),GeoLeaf.POI.Renderers||(GeoLeaf.POI.Renderers={}),GeoLeaf.POI.Renderers.MediaRenderers=MediaRenderers;let t=null;const o=()=>(t||(t=new MediaRenderers),t);GeoLeaf.POI.Renderers.renderImage=(e,t)=>o().renderImage(e,t),GeoLeaf.POI.Renderers.renderGallery=(e,t)=>o().renderGallery(e,t),GeoLeaf.Log&&GeoLeaf.Log.info("[POI.Renderers.MediaRenderers] Loaded (v2.0 - AbstractRenderer)")})()),se||(se=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{};class LightboxManager{constructor(){this.currentLightbox=null,this.closeHandler=null}open(e){this.close();const t=document.createElement("div");t.className="gl-poi-lightbox",t.style.cssText="\n                position: fixed;\n                top: 0;\n                left: 0;\n                right: 0;\n                bottom: 0;\n                background: rgba(0,0,0,0.95);\n                z-index: 10000;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                cursor: pointer;\n            ";const o=document.createElement("img");o.src=e,o.style.cssText="\n                max-width: 90%;\n                max-height: 90%;\n                object-fit: contain;\n            ",t.appendChild(o),document.body.appendChild(t),this.currentLightbox=t,t.addEventListener("click",()=>{this.close()}),this.closeHandler=e=>{"Escape"===e.key&&this.close()},document.addEventListener("keydown",this.closeHandler)}close(){this.currentLightbox&&document.body.contains(this.currentLightbox)&&document.body.removeChild(this.currentLightbox),this.closeHandler&&(document.removeEventListener("keydown",this.closeHandler),this.closeHandler=null),this.currentLightbox=null}isOpen(){return null!==this.currentLightbox&&document.body.contains(this.currentLightbox)}}GeoLeaf.LightboxManager=LightboxManager,GeoLeaf._lightboxManager=new LightboxManager}("undefined"!=typeof window?window:gt)),ce||(ce=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log,o={attachSingleAccordionBehavior(e){const o=e.querySelectorAll("details.gl-accordion");0!==o.length&&(o.forEach(e=>{e.addEventListener("toggle",e=>{e.target.open&&o.forEach(t=>{t!==e.target&&t.open&&t.removeAttribute("open")})})}),t&&t.info("[POI] Comportement singleAccordion activ\xe9:",o.length,"accord\xe9ons"))},attachGalleryEvents(e,t){if(!e)return;const o=e.querySelectorAll(".gl-poi-gallery__thumb"),n=e.querySelector(".gl-poi-gallery__main img");n&&0!==o.length&&(o.forEach(e=>{e.addEventListener("click",()=>{const t=parseInt(e.getAttribute("data-index"),10),r=e.querySelector("img").src;n.src=r,n.alt=`Image ${t+1}`,o.forEach(e=>e.classList.remove("active")),e.classList.add("active")})}),n.addEventListener("click",()=>{t&&t.open(n.src)}))},setupAll(e,t){this.attachSingleAccordionBehavior(e),this.attachGalleryEvents(e,t)}};GeoLeaf._POIUIBehaviors=o}("undefined"!=typeof window?window:gt)),ue||(ue=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log;GeoLeaf.ComponentRenderers=class ComponentRenderers{constructor(){this.getMarkers=()=>GeoLeaf._POIMarkers}renderBadge(e,t,o){if(!t)return null;const n=document.createElement("div");n.className="gl-poi-badge-container";const r=document.createElement("span");r.className="gl-poi-badge",r.textContent=t;const i=this.getMarkers();if(i&&i.resolveCategoryDisplay){const e=i.resolveCategoryDisplay(o);e.colorFill&&(r.style.background=e.colorFill,r.style.color="#fff")}return n.appendChild(r),n}renderLink(e,t){if(!t)return null;const o=document.createElement("div");o.className="gl-poi-link-container";const n=document.createElement("a");return n.className="gl-poi-website-link",n.href=t,n.target="_blank",n.rel="noopener noreferrer",n.textContent=e.label||"Visiter le site web \u2192",o.appendChild(n),o}renderList(e,o){if(!o)return t&&t.warn("[POI] renderList: data is null/undefined"),null;const n=document.createElement("div");if(n.className="gl-poi-section","object"==typeof o&&!Array.isArray(o)){if(t&&t.info("[POI] renderList: price object:",o),o.from||o.to){const e=document.createElement("p"),t=document.createElement("strong"),r=Number.isFinite(Number(o.from))?Number(o.from):null,i=Number.isFinite(Number(o.to))?Number(o.to):null,a=o.currency||"USD";null!==r&&null!==i?t.textContent=`De ${r} \xe0 ${i} ${a}`:null!==r?t.textContent=`\xc0 partir de ${r} ${a}`:null!==i&&(t.textContent=`Jusqu'\xe0 ${i} ${a}`),t.textContent&&(e.appendChild(t),n.appendChild(e))}if(o.description){const e=document.createElement("p");e.textContent=o.description,e.style.fontSize="0.85rem",e.style.color="var(--gl-color-text-muted)",n.appendChild(e)}return 0===n.children.length?(t&&t.warn("[POI] renderList: price object has no displayable content"),null):n}if(Array.isArray(o)){const t=e.variant||"disc",r=document.createElement("ul");r.className="gl-poi-list-unordered",r.style.listStyleType="disc"===t||"circle"===t||"square"===t?t:"disc",o.forEach(e=>{const t=document.createElement("li");t.textContent=e,r.appendChild(t)}),n.appendChild(r)}return n}renderTable(e,o){if(!o||!Array.isArray(o))return t&&t.warn("[POI] renderTable: data is",o?"not an array":"null/undefined","- type:",typeof o),null;t&&t.info("[POI] renderTable: rendering",o.length,"rows");let n=o;o.length>0&&"string"==typeof o[0]&&e.columns&&2===e.columns.length&&(n=o.map(t=>{const o=[" : ",": "," \u2013 ","\u2013"," - ","-"];for(const n of o){const o=t.split(n);if(o.length>=2)return{[e.columns[0].key]:o[0].trim(),[e.columns[1].key]:o.slice(1).join(n).trim()}}return{[e.columns[0].key]:t,[e.columns[1].key]:""}}),t&&t.info("[POI] renderTable: transformed string array to object array"));const r=document.createElement("table");r.className="gl-poi-table";const i=e.borders||{};if(0!=i.outer&&(r.style.border=`1px solid ${i.color||"var(--gl-color-border-soft)"}`),e.columns){const t=document.createElement("thead"),o=document.createElement("tr");e.columns.forEach((e,t)=>{const n=document.createElement("th");n.textContent=e.label,n.style.padding="8px",n.style.textAlign="left",n.style.fontWeight="600",n.style.backgroundColor="var(--gl-color-bg-subtle)",0!=i.row&&(n.style.borderBottom=`1px solid ${i.color||"var(--gl-color-border-soft)"}`),i.column&&t>0&&(n.style.borderLeft=`1px solid ${i.color||"var(--gl-color-border-soft)"}`),o.appendChild(n)}),t.appendChild(o),r.appendChild(t)}const a=document.createElement("tbody");return n.forEach((t,o)=>{const r=document.createElement("tr");e.columns&&e.columns.forEach((e,a)=>{const l=document.createElement("td");l.textContent=t[e.key]||"",l.style.padding="8px",0!=i.row&&o<n.length-1&&(l.style.borderBottom=`1px solid ${i.color||"var(--gl-color-border-soft)"}`),i.column&&a>0&&(l.style.borderLeft=`1px solid ${i.color||"var(--gl-color-border-soft)"}`),r.appendChild(l)}),a.appendChild(r)}),r.appendChild(a),r}renderTags(e,o){if(!o||!Array.isArray(o))return t&&t.warn("[POI] renderTags: tags is",o?"not an array":"null/undefined","- type:",typeof o,"- value:",o),null;if(0===o.length)return t&&t.warn("[POI] renderTags: tags array is empty"),null;t&&t.info("[POI] renderTags: rendering",o.length,"tags");const n=document.createElement("div");return n.className="gl-poi-sidepanel__tags",n.style.display="flex",n.style.flexWrap="wrap",n.style.gap="6px",o.forEach(e=>{const t=document.createElement("span");t.className="gl-poi-tag",t.textContent=e,n.appendChild(t)}),n}renderReviews(e,o){if(!o||!Array.isArray(o))return t&&t.warn("[POI] renderReviews: reviews is",o?"not an array":"null/undefined","- type:",typeof o),null;t&&t.info("[POI] renderReviews: rendering",o.length,"reviews");const n=document.createElement("div");n.className="gl-poi-reviews";const r=e.maxCount||5;return o.slice(0,r).forEach(e=>{const t=document.createElement("div");t.className="gl-poi-review",t.style.borderLeft="3px solid var(--gl-color-accent-soft)",t.style.paddingLeft="12px",t.style.marginBottom="12px";const o=document.createElement("p");o.style.fontSize="0.875rem",o.style.fontWeight="600",o.style.marginBottom="4px";const r=e.authorName||"Anonyme",i=Number.isFinite(e.rating)?e.rating:0,a=e.verified?" \u2713":"";if(o.textContent=`${r} - \u2b50${i}/5${a}`,t.appendChild(o),e.comment){const o=document.createElement("p");o.textContent=e.comment,o.style.fontSize="0.85rem",o.style.marginBottom="4px",t.appendChild(o)}if(e.createdAt){const o=document.createElement("p");o.style.fontSize="0.75rem",o.style.color="var(--gl-color-text-muted)",o.textContent=e.createdAt,t.appendChild(o)}n.appendChild(t)}),n}}}("undefined"!=typeof window?window:gt)),de||(de=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log,o=GeoLeaf.Utils||{};GeoLeaf.SectionOrchestrator=class SectionOrchestrator{constructor(){this.componentRenderers=null,this.fieldRenderers=null,this.mediaRenderers=null}_initRenderers(){this.componentRenderers||(this.componentRenderers=new GeoLeaf.ComponentRenderers),!this.fieldRenderers&&GeoLeaf.POI&&GeoLeaf.POI.Renderers&&GeoLeaf.POI.Renderers.FieldRenderers&&(this.fieldRenderers=new GeoLeaf.POI.Renderers.FieldRenderers({debug:1})),!this.mediaRenderers&&GeoLeaf.POI&&GeoLeaf.POI.Renderers&&GeoLeaf.POI.Renderers.MediaRenderers&&(this.mediaRenderers=new GeoLeaf.POI.Renderers.MediaRenderers({debug:1}))}getFieldValue(e,n){if(!n)return null;const r=(o.resolveField||function(e,t){const o=t.split(".");let n=e;for(const e of o){if(!n||"object"!=typeof n||!(e in n))return null;n=n[e]}return n})(e,n);return t&&t.info&&t.info("[POI] getFieldValue:",n,"\u2192",void 0===r?"undefined":null===r?"null":""===r?'""(empty string)':Array.isArray(r)?`Array(${r.length})`:r&&"object"==typeof r?`Object(${Object.keys(r).length} keys)`:r),r}wrapInAccordion(e,t,o=0){const n=document.createElement("details");n.className="gl-accordion",o&&n.setAttribute("open","");const r=document.createElement("summary");r.className="gl-accordion__header",r.textContent=e.label||"Section";const i=document.createElement("span");i.className="gl-accordion__arrow",i.textContent="\u25bc",r.appendChild(i);const a=document.createElement("div");a.className="gl-accordion__panel";const l=document.createElement("div");return l.className="gl-accordion__panel-content",l.appendChild(t),a.appendChild(l),n.appendChild(r),n.appendChild(a),n}async renderSection(e,o,n){if(!e||!e.type)return null;this._initRenderers();const r=this.getFieldValue(o,e.field);if(t){const o=Array.isArray(r)?`Array(${r.length})`:r&&"object"==typeof r?`Object(${Object.keys(r).length} keys)`:typeof r;t.debug("[POI] Section:",e.label||e.type,"- Field:",e.field,"- ValueType:",o,"- Value:",r)}const i="text"===e.type&&"title"===e.style||"badge"===e.type,a=null==r||""===r||Array.isArray(r)&&0===r.length||"object"==typeof r&&!Array.isArray(r)&&0===Object.keys(r).length;if(t&&t.info("[POI] Check isEmpty for:",e.label,"- fieldValue:",r,"- isArray:",Array.isArray(r),"- arrayLength:",Array.isArray(r)?r.length:"N/A","- isEmpty:",a),a&&!i)return t&&t.warn("[POI] Section ignor\xe9e (valeur vide):",e.label||e.type),null;t&&t.info("[POI] \u2192 Appel render pour:",e.label,"- Type:",e.type,"- Value:",Array.isArray(r)?`Array(${r.length})`:r&&"object"==typeof r?"Object":r);let l=null;switch(e.type){case"text":case"longtext":this.fieldRenderers&&(l=await this.fieldRenderers.renderText(e,o,r));break;case"number":this.fieldRenderers&&(l=await this.fieldRenderers.renderText(e,o,String(r)));break;case"metric":const n=e.suffix||"",i=e.prefix||"";this.fieldRenderers&&(l=await this.fieldRenderers.renderText(e,o,i+String(r)+n));break;case"image":this.mediaRenderers&&(l=this.mediaRenderers.renderImage(e,r));break;case"gallery":this.mediaRenderers&&(l=this.mediaRenderers.renderGallery(e,r));break;case"badge":l=this.componentRenderers.renderBadge(e,r,o);break;case"link":l=this.componentRenderers.renderLink(e,r);break;case"list":l=this.componentRenderers.renderList(e,r);break;case"table":l=this.componentRenderers.renderTable(e,r);break;case"tags":l=this.componentRenderers.renderTags(e,r);break;case"reviews":l=this.componentRenderers.renderReviews(e,r);break;default:return t&&t.warn("[POI] Type de section inconnu:",e.type),null}return l?(t&&t.debug("[POI] Contenu g\xe9n\xe9r\xe9 pour:",e.label||e.type,"- Accordion:",e.accordion),e.accordion?this.wrapInAccordion(e,l,e.defaultOpen):l):(t&&t.debug("[POI] Aucun contenu g\xe9n\xe9r\xe9 pour:",e.label||e.type),null)}}}("undefined"!=typeof window?window:gt)),fe||(fe=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t={renderLink(e,t){if(!t)return null;const o=document.createElement("div");o.className="gl-poi-link-container";const n=document.createElement("a");return n.className="gl-poi-website-link",n.href=t,n.target="_blank",n.rel="noopener noreferrer",n.textContent=e.label||t,o.appendChild(n),o}};GeoLeaf._POIRendererLinks=t}(window)),pe||(pe=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log;GeoLeaf._POIRenderers=GeoLeaf._POIRenderers||{};let o=null,n=null,r=null;GeoLeaf._POIRenderersCore={populateSidePanel:async function(e,i){!o&&GeoLeaf.SectionOrchestrator&&(o=new GeoLeaf.SectionOrchestrator),n||(n=GeoLeaf._lightboxManager||(GeoLeaf.LightboxManager?new GeoLeaf.LightboxManager:null)),r||(r=GeoLeaf._POIUIBehaviors);const a=GeoLeaf._POIShared;if(!a)return;const l=a.state;if(!l.sidePanelElement)return;const s=l.sidePanelElement.querySelector(".gl-poi-sidepanel__content");if(!s)return;GeoLeaf.DOMSecurity.clearElementFast(s);const c=GeoLeaf._POINormalizers,u=c?c.normalizePoi(e):e;t&&(t.debug("[POI] POI normalis\xe9:",u.title||u.label),t.debug("[POI] Champs attributes disponibles:",Object.keys(u.attributes||{})));let d=i;if(!d&&u._sidepanelConfig&&u._sidepanelConfig.detailLayout&&(d=u._sidepanelConfig.detailLayout,t&&t.info("[POI] Layout r\xe9cup\xe9r\xe9 depuis la configuration de couche attach\xe9e au POI")),!d){const e=GeoLeaf.Config;if(e&&"function"==typeof e.getActiveProfile){const o=e.getActiveProfile();o&&o.panels&&o.panels.detail&&(d=o.panels.detail.layout,t&&t.info("[POI] Layout r\xe9cup\xe9r\xe9 depuis le profil actif:",o.id||"unknown"))}}!d&&l.poiConfig?.panels?.detail?.layout&&(d=l.poiConfig.panels.detail.layout),d&&0!==d.length||(t&&t.warn("[POI] Aucun layout trouv\xe9, utilisation du layout par d\xe9faut"),d=[{type:"text",field:"title",style:"title",accordion:0},{type:"image",field:"attributes.mainImage",variant:"hero",accordion:0},{type:"text",field:"attributes.shortDescription",variant:"short",accordion:0},{type:"text",label:"Informations",field:"attributes.longDescription",variant:"multiline",accordion:1,defaultOpen:1},{type:"text",label:"Description",field:"attributes.description_long",variant:"multiline",accordion:1,defaultOpen:1},{type:"gallery",label:"Galerie photos",field:"attributes.gallery",accordion:1,defaultOpen:1},{type:"list",label:"Prix",field:"attributes.price",accordion:1,defaultOpen:0},{type:"reviews",label:"Avis r\xe9cents",field:"attributes.reviews.recent",maxCount:5,accordion:1,defaultOpen:0},{type:"tags",label:"Tags",field:"attributes.tags",accordion:0},{type:"link",label:"Visiter le site web \u2192",field:"attributes.website",accordion:0}]);const f=[...d].sort((e,t)=>("number"==typeof e.order?e.order:999)-("number"==typeof t.order?t.order:999));t&&t.info("[POI] G\xe9n\xe9ration du side panel avec",f.length,"sections");const p=document.createElement("div");p.className="gl-poi-sidepanel__body",f.length;for(const e of f)try{const n=o?await o.renderSection(e,u,l):null;n?(p.appendChild(n),e.label||e.type,t&&t.info("[POI] \u2713 Section ajout\xe9e:",e.label||e.type)):(e.label||e.type,e.field,t&&t.warn("[POI] \u2717 Section ignor\xe9e (element null):",e.label||e.type,"- field:",e.field))}catch(o){console.error("[SIDEPANEL] ERROR rendering section:",e.label,o),t&&t.error("[POI] Erreur lors du rendu de la section:",e.label,o)}p.children.length,s.appendChild(p),s.children.length;const g=u._sidepanelConfig?.singleAccordion;1==g&&r&&r.attachSingleAccordionBehavior(p),r&&r.attachGalleryEvents(l.sidePanelElement,n)}}}("undefined"!=typeof window?window:gt)),ge||(ge=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t={renderContent:(e,t)=>GeoLeaf._POIRenderersCore&&"function"==typeof GeoLeaf._POIRenderersCore.renderContent?GeoLeaf._POIRenderersCore.renderContent(e,t):(GeoLeaf.Log&&GeoLeaf.Log.error("[POI] Module _POIRenderersCore non disponible"),document.createDocumentFragment()),renderText:(e,t,o)=>GeoLeaf._POIRendererFields?GeoLeaf._POIRendererFields.renderText(e,t,o):(GeoLeaf.Log&&GeoLeaf.Log.error("[POI] Module _POIRendererFields non disponible pour renderText"),null),renderBadge:(e,t,o)=>GeoLeaf._POIRendererFields?GeoLeaf._POIRendererFields.renderBadge(e,t,o):(GeoLeaf.Log&&GeoLeaf.Log.error("[POI] Module _POIRendererFields non disponible pour renderBadge"),null),renderImage:(e,t)=>GeoLeaf._POIRendererMedia?GeoLeaf._POIRendererMedia.renderImage(e,t):(GeoLeaf.Log&&GeoLeaf.Log.error("[POI] Module _POIRendererMedia non disponible pour renderImage"),null),renderGallery:(e,t)=>GeoLeaf._POIRendererMedia?GeoLeaf._POIRendererMedia.renderGallery(e,t):null,renderLink:(e,t)=>GeoLeaf._POIRendererLinks?GeoLeaf._POIRendererLinks.renderLink(e,t):(GeoLeaf.Log&&GeoLeaf.Log.error("[POI] Module _POIRendererLinks non disponible pour renderLink"),null),async populateSidePanel(e,t){if(GeoLeaf._POIRenderersCore&&"function"==typeof GeoLeaf._POIRenderersCore.populateSidePanel)return await GeoLeaf._POIRenderersCore.populateSidePanel(e,t);GeoLeaf.Log&&GeoLeaf.Log.error("[POI] Module _POIRenderersCore non disponible pour populateSidePanel")}};GeoLeaf._POIRenderers=t}(window)),ye||(ye=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log,o=(e,t,...o)=>GeoLeaf.Utils&&GeoLeaf.Utils.createElement?GeoLeaf.Utils.createElement(e,t,...o):document.createElement(e);GeoLeaf._POISidePanel=GeoLeaf._POISidePanel||{};const n=()=>GeoLeaf._POIShared;function r(){const e=n();if(!e)return;const r=e.state;if(r.sidePanelElement)return;const a=o("div",{className:"gl-poi-sidepanel-overlay",attributes:{"aria-hidden":"true"}}),l=document.querySelector(".gl-main");l?l.appendChild(a):document.body.appendChild(a),r.sidePanelOverlay=a;const s=o("aside",{className:"gl-poi-sidepanel",attributes:{"aria-hidden":"true",role:"complementary"}}),c=o("div",{className:"gl-poi-sidepanel__header"}),u=o("button",{className:"gl-poi-sidepanel__close",attributes:{"aria-label":"Fermer"},textContent:"\xd7",onClick:i});c.appendChild(u);const d=o("div",{className:"gl-poi-sidepanel__content"});s.appendChild(c),s.appendChild(d),l?l.appendChild(s):document.body.appendChild(s),r.sidePanelElement=s,r.sidePanelContent=d,a.addEventListener("click",i),t&&t.info("[POI] Side panel cr\xe9\xe9.")}function i(){const e=n();if(!e)return;const o=e.state;if(!o.sidePanelElement)return;o.sidePanelElement.classList.remove("open"),o.sidePanelElement.setAttribute("aria-hidden","true"),o.sidePanelOverlay&&o.sidePanelOverlay.classList.remove("open"),document.body.classList.remove("gl-poi-sidepanel-open");const r=document.querySelector(".gl-poi-lightbox-global");r&&r.remove(),o.currentPoiInPanel=null,t&&t.info("[POI] Panneau lat\xe9ral ferm\xe9.")}GeoLeaf._POISidePanel={createSidePanel:r,openSidePanel:async function(e,o){if(!e)return void(t&&t.warn("[POI] openSidePanel() : POI invalide."));t&&t.debug("[POI] openSidePanel:",e.id||e.name);const i=n();if(!i)return;const a=i.state;if(a.sidePanelElement||r(),!a.sidePanelElement)return void(t&&t.error("[POI] openSidePanel() : Impossible de cr\xe9er le panneau lat\xe9ral."));a.currentPoiInPanel=e,a.currentGalleryIndex=0;const l=GeoLeaf._POIRenderers;l&&"function"==typeof l.populateSidePanel&&await l.populateSidePanel(e,o),a.sidePanelOverlay&&a.sidePanelOverlay.classList.add("open"),a.sidePanelElement.classList.add("open"),a.sidePanelElement.setAttribute("aria-hidden","false"),document.body.classList.add("gl-poi-sidepanel-open"),t&&t.info("[POI] Panneau lat\xe9ral ouvert pour :",e.title||e.name||e.label)},closeSidePanel:i,hideSidePanel:function(){i()}}}("undefined"!=typeof window?window:gt)),he||(he=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log;GeoLeaf._POICore=GeoLeaf._POICore||{};const o=()=>GeoLeaf._POIShared,n=()=>GeoLeaf._POIMarkers,r=()=>GeoLeaf._POINormalizers;function i(e,o){if("function"!=typeof o)return void(t&&t.error("[POI] loadAndMergeStoredPois: callback requis"));const n=()=>{const e=void 0!==GeoLeaf&&GeoLeaf.Storage&&GeoLeaf.Storage.DB&&"function"==typeof GeoLeaf.Storage.DB.getAllFromSyncQueue;return t&&(e||(t.info("[POI] Debug Storage - GeoLeaf:",void 0!==GeoLeaf),t.info("[POI] Debug Storage - GeoLeaf.Storage:",!(!GeoLeaf||!GeoLeaf.Storage)),t.info("[POI] Debug Storage - GeoLeaf.Storage.DB:",!!(GeoLeaf&&GeoLeaf.Storage&&GeoLeaf.Storage.DB)),t.info("[POI] Debug Storage - getAllFromSyncQueue:",!!(GeoLeaf&&GeoLeaf.Storage&&GeoLeaf.Storage.DB&&"function"==typeof GeoLeaf.Storage.DB.getAllFromSyncQueue)))),e};if(!n())return t&&t.warn("[POI] Module Storage pas encore pr\xeat, retry dans 1000ms..."),void setTimeout(()=>{n()?(t&&t.info("[POI] Module Storage maintenant disponible, retry..."),i(e,o)):(t&&t.error("[POI] Module Storage toujours non disponible apr\xe8s retry, abandon."),o(e))},1e3);t&&t.info("[POI] Module Storage disponible, r\xe9cup\xe9ration des POI..."),GeoLeaf.Storage.DB.getAllFromSyncQueue().then(n=>{if(t&&t.info(`[POI] R\xe9cup\xe9ration cache: ${n.length} items trouv\xe9s`),!Array.isArray(n)||0===n.length)return t&&t.info("[POI] Aucun POI trouv\xe9 dans la file de synchronisation."),void o(e);if(t){const e=n.map(e=>`${e.action}:${e.data?.type||"no-type"}`);t.info(`[POI] Types d'items dans le cache: [${e.join(", ")}]`),n.slice(0,2).forEach((e,o)=>{t.info(`[POI] DEBUG Item ${o}:`,{action:e.action,type:e.type,data_type:e.data?.type,keys:Object.keys(e),data_keys:e.data?Object.keys(e.data):"no data"})})}const i=[],a=r();if(!a)return t&&t.error("[POI] Module Normalizers non disponible pour les POI du cache."),void o(e);if(n.forEach(e=>{let o=0,n=null,r=null;if(e.data&&"poi"===e.data.type&&e.action&&(e.action.includes("add")||e.action.includes("update"))?(o=1,n=e.data,r=e.action):"poi"===e.type?(o=1,n=e,r=e.action||"add"):e.data&&(e.data.id||e.data.latlng||e.data.latitude)?(o=1,n=e.data,r=e.action||"add",t&&t.info(`[POI] D\xe9tection heuristique POI: ${e.data.id||"no-id"}`)):e.id&&(e.latlng||e.latitude)&&(o=1,n=e,r="add",t&&t.info(`[POI] D\xe9tection POI direct: ${e.id}`)),o&&n){const e=a.normalizePoi(n);e?(i.push(e),t&&t.info(`[POI] POI du cache normalis\xe9: ${e.id||"Sans ID"} (action: ${r})`)):t&&t.warn("[POI] \xc9chec normalisation POI du cache:",n)}else t&&t.debug(`[POI] Item ignor\xe9 - action: ${e.action}, type: ${e.type||e.data?.type}, keys: ${Object.keys(e).join(",")}`)}),i.length>0){t&&t.info(`[POI] ${i.length} POI(s) r\xe9cup\xe9r\xe9(s) du cache local.`);const n=[...e];i.forEach(e=>{n.find(t=>t.id===e.id)||n.push(e)}),o(n)}else o(e)}).catch(n=>{t&&t.error("[POI] Erreur lors de la r\xe9cup\xe9ration des POI du cache :",n),o(e)})}function a(){const e=o();if(!e)return;const n=e.state;if(n.isLoading)t&&t.warn("[POI] Chargement d\xe9j\xe0 en cours...");else{try{if(GeoLeaf.Config&&"function"==typeof GeoLeaf.Config.getActiveProfilePoi){const e=GeoLeaf.Config.getActiveProfilePoi();if(Array.isArray(e)&&e.length>0)return n.allPois=e,t&&t.info(`[POI] ${n.allPois.length} POI(s) provenant du profil actif.`),void i(n.allPois,function(e){n.allPois=e,l(n.allPois)})}}catch(e){t&&t.error("[POI] Erreur lors de la r\xe9cup\xe9ration des POI du profil actif :",e)}i([],function(e){if(e.length>0)return n.allPois=e,t&&t.info(`[POI] ${e.length} POI(s) charg\xe9(s) depuis le cache local.`),void l(e);const o=n.poiConfig.dataUrl;o?(n.isLoading=1,t&&t.info("[POI] Chargement des donn\xe9es POI depuis :",o),fetch(o).then(e=>{if(!e.ok)throw new Error(`Erreur HTTP ${e.status} lors du chargement de ${o}`);return e.json()}).then(e=>{Array.isArray(e)?n.allPois=e:e&&Array.isArray(e.pois)?n.allPois=e.pois:n.allPois=[],t&&t.info(`[POI] ${n.allPois.length} POI(s) charg\xe9(s) depuis dataUrl.`),l(n.allPois)}).catch(e=>{t&&t.error("[POI] Erreur lors du chargement des POIs :",e)}).finally(()=>{n.isLoading=0})):t&&t.info("[POI] Aucune dataUrl sp\xe9cifi\xe9e et aucun POI en cache. Mode ajout manuel.")})}}function l(e){if(!e||!Array.isArray(e))return void(t&&t.warn("[POI] displayPois() : Aucune donn\xe9e POI valide \xe0 afficher."));const r=o();if(!r)return;const i=r.state;i.poiLayerGroup&&i.poiLayerGroup.clearLayers(),i.poiClusterGroup&&i.poiClusterGroup.clearLayers();const a=0!=i.poiConfig.clustering,l=n();l&&"function"==typeof l.createMarker?a&&i.poiClusterGroup?(e.forEach(e=>{const t=l.createMarker(e);t&&(i.poiClusterGroup.addLayer(t),i.poiMarkers.set(e.id||e.title||e.label,t))}),i.mapInstance.hasLayer(i.poiClusterGroup)||i.mapInstance.addLayer(i.poiClusterGroup),t&&t.info("[POI] Affichage avec clustering.")):(e.forEach(e=>{const t=l.createMarker(e);t&&(i.poiLayerGroup.addLayer(t),i.poiMarkers.set(e.id||e.title||e.label,t))}),i.mapInstance.hasLayer(i.poiLayerGroup)||i.mapInstance.addLayer(i.poiLayerGroup),t&&t.info("[POI] Affichage sans clustering.")):t&&t.error("[POI] Module Markers non charg\xe9.")}GeoLeaf._POICore={init:async function(e,r){let i,l;if(e&&"object"==typeof e&&e.map?(i=e.map,l=e.config||e):(i=e,l=r),!i||"function"!=typeof i.addLayer)return void(t&&t.error("[POI] Aucune carte Leaflet valide fournie. Impossible d'initialiser le module POI."));const s=o();if(!s)return void(t&&t.error("[POI] Module shared non charg\xe9."));const c=s.state,u=s.constants;c.mapInstance=i,c.poiConfig=l||{},t&&t.info("[POI] Initialisation du module POI..."),s.ensureMapMaxZoom&&s.ensureMapMaxZoom(i,u.POI_MAX_ZOOM),c.poiLayerGroup=L.layerGroup().addTo(i),0!=c.poiConfig.clustering&&"undefined"!=typeof L&&"function"==typeof L.markerClusterGroup&&(c.poiClusterGroup=L.markerClusterGroup({maxClusterRadius:c.poiConfig.clusterRadius||80,disableClusteringAtZoom:c.poiConfig.disableClusteringAtZoom||u.POI_MAX_ZOOM,animate:0,showCoverageOnHover:0}),c.mapInstance.addLayer(c.poiClusterGroup),t&&t.info("[POI] Clustering activ\xe9 (MarkerClusterGroup cr\xe9\xe9)."));const d=GeoLeaf._POISidePanel;d&&"function"==typeof d.createSidePanel&&d.createSidePanel();const f=n();f&&"function"==typeof f.ensureProfileSpriteInjectedSync&&await f.ensureProfileSpriteInjectedSync(),0!=c.poiConfig.enabled&&setTimeout(()=>{t&&t.info("[POI] Chargement des POI apr\xe8s d\xe9lai d'initialisation"),a()},1e3)},loadAndDisplay:a,displayPois:l,addPoi:function(e){if(!e)return t&&t.warn("[POI] addPoi() : POI invalide."),null;const i=o();if(!i)return null;const a=i.state,l=r(),s=n();if(!l||!s)return t&&t.error("[POI] Modules Normalizers ou Markers non charg\xe9s."),null;const c=l.normalizePoi(e);if(!c)return t&&t.warn("[POI] addPoi() : \xc9chec de la normalisation du POI.",e),null;c.id||(c.id=l.generatePoiId(c)),t&&(t.info("[POI] Adding normalized POI:",c.id),t.info("[POI] - Has _layerConfig:",!!c._layerConfig),t.info("[POI] - Has _sidepanelConfig:",!!c._sidepanelConfig),t.info("[POI] - Has _popupConfig:",!!c._popupConfig),t.info("[POI] - Attributes keys:",Object.keys(c.attributes||{})));const u=s.createMarker(c);return u?(0!=a.poiConfig.clustering&&a.poiClusterGroup?a.poiClusterGroup.addLayer(u):a.poiLayerGroup.addLayer(u),a.allPois.push(c),a.poiMarkers.set(c.id,u),t&&t.info("[POI] \u2705 POI normalis\xe9 ajout\xe9 avec succ\xe8s :",c.id),u):(t&&t.warn("[POI] addPoi() : Impossible de cr\xe9er le marqueur pour ce POI normalis\xe9.",c),null)},getAllPois:function(){const e=o();return e?e.state.allPois:[]},getPoiById:function(e){const t=o();return t&&t.state.allPois.find(t=>t.id===e)||null},reload:function(e){const n=o();if(!n)return;const r=n.state;e&&Array.isArray(e)&&(r.allPois=e),l(r.allPois),t&&t.info("[POI] POI recharg\xe9s.")},getDisplayedPoisCount:function(){const e=o();return e&&e.state?(e.state.allPois||[]).length:0}}}("undefined"!=typeof window?window:gt)),me||(me=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log,o=()=>GeoLeaf._POICore,n=()=>GeoLeaf._POISidePanel,r=()=>GeoLeaf._POIShared,i=GeoLeaf.POI&&GeoLeaf.POI.Renderers;GeoLeaf.POI={Renderers:i||{},init:function(e,n){const r=o();r?r.init(e,n):t&&t.error("[POI] Module Core non charg\xe9.")},loadAndDisplay:function(){const e=o();e?e.loadAndDisplay():t&&t.error("[POI] Module Core non charg\xe9.")},displayPois:function(e){const n=o();n?n.displayPois(e):t&&t.error("[POI] Module Core non charg\xe9.")},addPoi:function(e){const n=o();return n?n.addPoi(e):(t&&t.error("[POI] Module Core non charg\xe9."),null)},add:function(e){const n=o();return n?n.addPoi(e):(t&&t.error("[POI] Module Core non charg\xe9."),0)},addPoi:function(e){return this.add(e)},getAllPois:function(){const e=o();return e?e.getAllPois():[]},getPoiById:function(e){const t=o();return t?t.getPoiById(e):null},reload:function(e){const n=o();n?n.reload(e):t&&t.error("[POI] Module Core non charg\xe9.")},showPoiDetails:async function(e,o){const r=n();r?await r.openSidePanel(e,o):t&&t.error("[POI] Module SidePanel non charg\xe9.")},hideSidePanel:function(){const e=n();e?e.closeSidePanel():t&&t.error("[POI] Module SidePanel non charg\xe9.")},openSidePanelWithLayout:function(e,t){this.showPoiDetails(e,t)},getLayer:function(){const e=r();if(!e)return null;const t=e.state;return t.poiClusterGroup||t.poiLayerGroup},getDisplayedPoisCount:function(){const e=o();return e?e.getDisplayedPoisCount():(t&&t.error("[POI] Module Core non charg\xe9."),0)},_clearAllForTests:function(){const e=r();if(!e)return;const o=e.state;t&&t.info("[POI] _clearAllForTests: Suppression de",o.allPois.length,"POI(s) et",o.poiMarkers.size,"marqueur(s)"),o.allPois=[],o.poiMarkers.clear(),o.poiClusterGroup&&o.poiClusterGroup.clearLayers(),o.poiLayerGroup&&o.poiLayerGroup.clearLayers()}}}("undefined"!=typeof window?window:gt)),be||(be=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{};GeoLeaf._GeoJSONShared=GeoLeaf._GeoJSONShared||{},GeoLeaf._GeoJSONShared.state={map:null,layerGroup:null,geoJsonLayer:null,layers:new Map,layerIdCounter:0,featureCache:new Map,options:{defaultStyle:{color:"#2E7D32",weight:2,opacity:.9,fillColor:"#66BB6A",fillOpacity:.4},defaultPointStyle:{radius:6,color:"#1B5E20",weight:2,fillColor:"#66BB6A",fillOpacity:.9},onEachFeature:null,pointToLayer:null,fitBoundsOnLoad:1,maxZoomOnFit:GeoLeaf.CONSTANTS?GeoLeaf.CONSTANTS.GEOJSON_MAX_ZOOM_ON_FIT:18}},GeoLeaf._GeoJSONShared.PANE_CONFIG={BASEMAP_NAME:"geoleaf-basemap",BASEMAP_ZINDEX:200,LAYER_PREFIX:"geoleaf-layer-",LAYER_BASE_ZINDEX:400,MIN_LAYER_ZINDEX:0,MAX_LAYER_ZINDEX:99},GeoLeaf._GeoJSONShared.PaneHelpers={getPaneName:e=>`${GeoLeaf._GeoJSONShared.PANE_CONFIG.LAYER_PREFIX}${e||0}`,validateZIndex(e){const t=GeoLeaf._GeoJSONShared.PANE_CONFIG;return Math.max(t.MIN_LAYER_ZINDEX,Math.min(t.MAX_LAYER_ZINDEX,Math.floor(e)))},applyPaneToLayer(e,t){e&&e.options&&(e.options.pane=this.getPaneName(t))}},GeoLeaf._GeoJSONShared.STYLE_OPERATORS={">":(e,t)=>Number(e)>Number(t),">=":(e,t)=>Number(e)>=Number(t),"<":(e,t)=>Number(e)<Number(t),"<=":(e,t)=>Number(e)<=Number(t),"==":(e,t)=>e==t,"===":(e,t)=>e===t,eq:(e,t)=>e==t,"!=":(e,t)=>e!=t,"!==":(e,t)=>e!==t,neq:(e,t)=>e!=t,contains:(e,t)=>String(e).toLowerCase().includes(String(t).toLowerCase()),startsWith:(e,t)=>String(e).toLowerCase().startsWith(String(t).toLowerCase()),endsWith:(e,t)=>String(e).toLowerCase().endsWith(String(t).toLowerCase()),in:(e,t)=>Array.isArray(t)&&t.includes(e),notIn:(e,t)=>Array.isArray(t)&&!t.includes(e),between:(e,t)=>{if(!Array.isArray(t)||2!==t.length)return 0;const o=Number(e),n=Number(t[0]),r=Number(t[1]);return o>=n&&o<=r}},GeoLeaf._GeoJSONShared.reset=function(){const e=GeoLeaf._GeoJSONShared.state;e.map=null,e.layerGroup=null,e.geoJsonLayer=null,e.layers=new Map,e.layerIdCounter=0,e.featureCache=new Map,e.options={defaultStyle:{color:"#2E7D32",weight:2,opacity:.9,fillColor:"#66BB6A",fillOpacity:.4},defaultPointStyle:{radius:6,color:"#1B5E20",weight:2,fillColor:"#66BB6A",fillOpacity:.9},onEachFeature:null,pointToLayer:null,fitBoundsOnLoad:1,maxZoomOnFit:GeoLeaf.CONSTANTS?GeoLeaf.CONSTANTS.GEOJSON_MAX_ZOOM_ON_FIT:18}},GeoLeaf._GeoJSONShared.getLog=function(){return GeoLeaf.Log||console}}(window)),_e||(_e=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{};GeoLeaf._GeoJSONStyleResolver=GeoLeaf._GeoJSONStyleResolver||{},GeoLeaf._GeoJSONStyleResolver.getNestedValue=function(e,t){return e&&t?t.split(".").reduce((e,t)=>e&&void 0!==e[t]?e[t]:null,e):null},GeoLeaf._GeoJSONStyleResolver.evaluateCondition=function(e,t,o,n){const{field:r,operator:i,value:a}=t;if(!r||!i)return 0;const l=GeoLeaf._GeoJSONStyleResolver.getNestedValue(e,r);if(null==l)return 0;const s=o[i];if(!s)return n.warn&&n.warn("[GeoJSON] Op\xe9rateur styleRules inconnu:",i),0;try{return s(l,a)}catch(e){return n.warn&&n.warn("[GeoJSON] Erreur \xe9valuation condition:",e.message),0}},GeoLeaf._GeoJSONStyleResolver.evaluateStyleRules=function(e,t){if(!Array.isArray(t)||0===t.length)return null;const o=GeoLeaf._GeoJSONShared,n=GeoLeaf.Log||console,r=o.STYLE_OPERATORS;for(const o of t)if(o&&o.when&&o.style)if(o.when.all&&Array.isArray(o.when.all)){if(o.when.all.every(t=>GeoLeaf._GeoJSONStyleResolver.evaluateCondition(e,t,r,n)))return o.style}else if(o.when.field&&o.when.operator&&GeoLeaf._GeoJSONStyleResolver.evaluateCondition(e,o.when,r,n))return o.style;return null},GeoLeaf._GeoJSONStyleResolver.buildLeafletOptions=function(t){const o=GeoLeaf._GeoJSONStyleResolver.evaluateStyleRules,n=e=>{if(!e||"object"!=typeof e)return{};const t={};return e.fill||e.stroke?(e.fill&&(e.fill.color&&(t.fillColor=e.fill.color),"number"==typeof e.fill.opacity?t.fillOpacity=e.fill.opacity:t.fillOpacity=1),e.stroke&&(e.stroke.color&&(t.color=e.stroke.color),"number"==typeof e.stroke.opacity&&(t.opacity=e.stroke.opacity),"number"==typeof e.stroke.widthPx&&(t.weight=e.stroke.widthPx),e.stroke.dashArray&&(t.dashArray=e.stroke.dashArray),e.stroke.lineCap&&(t.lineCap=e.stroke.lineCap),e.stroke.lineJoin&&(t.lineJoin=e.stroke.lineJoin)),e.shape&&(t.shape=e.shape),"number"==typeof e.sizePx&&(t.radius=e.sizePx,t.sizePx=e.sizePx)):(Object.assign(t,e),"number"!=typeof t.fillOpacity&&(t.fillOpacity=1)),t};return{style(e){let r=Object.assign({},n(t.defaultStyle));if(t.styleRules&&Array.isArray(t.styleRules)){const i=o(e,t.styleRules);i&&(r=Object.assign({},r,n(i)))}const i="boolean"==typeof t.interactiveShape?t.interactiveShape:GeoLeaf.Config&&GeoLeaf.Config.get?GeoLeaf.Config.get("ui.interactiveShapes",0):0;return r.interactive=i,r},pointToLayer:t.pointToLayer?function(e,o){return t.pointToLayer(e,o)}:function(o,n){const r="boolean"==typeof t.interactiveShape?t.interactiveShape:GeoLeaf.Config&&GeoLeaf.Config.get?GeoLeaf.Config.get("ui.interactiveShapes",0):0,i=GeoLeaf.Utils&&GeoLeaf.Utils.mergeOptions?GeoLeaf.Utils.mergeOptions(t.defaultPointStyle,{interactive:r}):Object.assign({},t.defaultPointStyle,{interactive:r});return e.L.circleMarker(n,i)},onEachFeature:function(e,o){e&&e.properties&&"string"==typeof e.properties.popupContent&&o.bindPopup(e.properties.popupContent),"function"==typeof t.onEachFeature&&t.onEachFeature(e,o)}}},GeoLeaf._StyleRules={evaluate:GeoLeaf._GeoJSONStyleResolver.evaluateStyleRules,operators:GeoLeaf._GeoJSONShared?GeoLeaf._GeoJSONShared.STYLE_OPERATORS:{},getNestedValue:GeoLeaf._GeoJSONStyleResolver.getNestedValue}}(window)),Le||(Le=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=()=>GeoLeaf._GeoJSONShared.state,o=()=>GeoLeaf.Log||console;GeoLeaf._LayerVisibilityManager=GeoLeaf._LayerVisibilityManager||{};const n={USER:"user",THEME:"theme",ZOOM:"zoom",SYSTEM:"system"};function r(e){e._visibility||(e._visibility={current:0,logicalState:0,source:n.SYSTEM,userOverride:0,themeOverride:0,themeDesired:null,zoomConstrained:0})}GeoLeaf._LayerVisibilityManager.setVisibility=function(e,n,i){const a=t(),l=o(),s=a.layers.get(e);if(!s)return l.warn("[VisibilityManager] Couche introuvable:",e),0;r(s);const c=s._visibility,u=c.current,d=c.source;if(!this._canChangeVisibility(c,i,n))return l.debug(`[VisibilityManager] Changement refus\xe9 pour ${e}: source=${i}, userOverride=${c.userOverride}, themeOverride=${c.themeOverride}`),0;this._updateVisibilityFlags(c,i,n);const f=this._applyVisibilityChange(e,s,n);return f&&(c.current=n,c.source=i,l.debug(`[VisibilityManager] ${e}: ${u} \u2192 ${n} (source: ${d} \u2192 ${i})`),s.visible=n,s.userDisabled=c.userOverride&&!n,s.themeHidden=c.themeOverride&&!n,this._notifyLegend(e,n),this._fireVisibilityEvent(e,n,i)),f},GeoLeaf._LayerVisibilityManager._canChangeVisibility=function(e,t,o){return t===n.USER||t===n.ZOOM?1:e.userOverride||t===n.ZOOM&&e.themeOverride&&0==e.themeDesired&&1==o?0:1},GeoLeaf._LayerVisibilityManager._updateVisibilityFlags=function(e,t,o){switch(t){case n.USER:e.userOverride=1,e.themeOverride=0,e.zoomConstrained=0,e.logicalState=o;break;case n.THEME:e.userOverride||(e.themeOverride=1,e.themeDesired=o,e.zoomConstrained=0,e.logicalState=o);break;case n.ZOOM:e.userOverride||(e.zoomConstrained=1);break;case n.SYSTEM:e.userOverride=0,e.themeOverride=0,e.themeDesired=null,e.zoomConstrained=0,e.logicalState=o}},GeoLeaf._LayerVisibilityManager._applyVisibilityChange=function(e,n,r){const i=t(),a=o();if(!n.layer)return a.warn("[VisibilityManager] Layer Leaflet manquant pour:",e),0;const l=n.clusterGroup||n.layer,s=i.map&&i.map.hasLayer(l);if(r&&s)return 0;if(!r&&!s)return 0;try{return r?n.useSharedCluster&&n.clusterGroup?n.clusterGroup.addLayer(n.layer):n.clusterGroup?(i.map.addLayer(n.clusterGroup),n.clusterGroup.refreshClusters&&n.clusterGroup.refreshClusters()):i.map.addLayer(n.layer):n.useSharedCluster&&n.clusterGroup?n.clusterGroup.removeLayer(n.layer):n.clusterGroup?i.map.removeLayer(n.clusterGroup):i.map.removeLayer(n.layer),GeoLeaf.LayerManager&&"function"==typeof GeoLeaf.LayerManager.refresh&&GeoLeaf.LayerManager.refresh(),GeoLeaf._LabelButtonManager&&"function"==typeof GeoLeaf._LabelButtonManager.syncImmediate&&GeoLeaf._LabelButtonManager.syncImmediate(e),1}catch(t){return a.error(`[VisibilityManager] Erreur lors du changement de visibilit\xe9 de ${e}:`,t),0}},GeoLeaf._LayerVisibilityManager._notifyLegend=function(e,t){GeoLeaf.Legend&&"function"==typeof GeoLeaf.Legend.setLayerVisibility&&GeoLeaf.Legend.setLayerVisibility(e,t),GeoLeaf.Labels&&(t?"function"==typeof GeoLeaf.Labels.refreshLabels&&GeoLeaf.Labels.refreshLabels(e):"function"==typeof GeoLeaf.Labels._hideLabelsForLayer&&GeoLeaf.Labels._hideLabelsForLayer(e)),GeoLeaf._LabelButtonManager&&"function"==typeof GeoLeaf._LabelButtonManager.syncImmediate&&GeoLeaf._LabelButtonManager.syncImmediate(e)},GeoLeaf._LayerVisibilityManager._fireVisibilityEvent=function(e,o,n){const r=t();if(r.map)try{r.map.fire("geoleaf:geojson:visibility-changed",{layerId:e,visible:o,source:n})}catch(e){}},GeoLeaf._LayerVisibilityManager.resetUserOverride=function(e){const n=t().layers.get(e);n&&n._visibility&&(n._visibility.userOverride=0,o().debug(`[VisibilityManager] User override r\xe9initialis\xe9 pour ${e}`))},GeoLeaf._LayerVisibilityManager.resetAllUserOverrides=function(){const e=t();let n=0;e.layers.forEach(e=>{e._visibility&&e._visibility.userOverride&&(e._visibility.userOverride=0,n++)}),n>0&&o().debug(`[VisibilityManager] ${n} user override(s) r\xe9initialis\xe9(s)`)},GeoLeaf._LayerVisibilityManager.getVisibilityState=function(e){const o=t().layers.get(e);return o?(r(o),{current:o._visibility.current,source:o._visibility.source,userOverride:o._visibility.userOverride,themeOverride:o._visibility.themeOverride,zoomConstrained:o._visibility.zoomConstrained}):null},GeoLeaf._LayerVisibilityManager.VisibilitySource=n,o().info("[GeoLeaf._LayerVisibilityManager] Module charg\xe9")}(window)),ve||(ve=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=()=>GeoLeaf._GeoJSONShared.state,o=()=>GeoLeaf.Log||console,n=GeoLeaf._GeoJSONLayerManager=GeoLeaf._GeoJSONLayerManager||{};n.getLayerById=function(e){return t().layers.get(e)||null},n.getLayerData=function(e){const o=t().layers.get(e);return o?{geojson:o.geojson||null,features:o.features||[],geometryType:o.geometryType||"unknown",config:o.config||{},layer:o.layer}:null},n.getAllLayers=function(){const e=t(),r=o(),i=[];return e.layers.forEach((e,t)=>{const o=e._visibility,a=o&&"boolean"==typeof o.logicalState?o.logicalState:e.visible||0;r&&"hebergements"===t&&r.info(`[getAllLayers] ${t}: logicalState=${o?.logicalState}, current=${o?.current}, visible=${e.visible}, userOverride=${o?.userOverride}, themeOverride=${o?.themeOverride}`),i.push({id:t,label:e.label,visible:a,type:n.detectLayerType(e.layer),featureCount:e.layer?e.layer.getLayers().length:0})}),i},n.detectLayerType=function(e){if(!e||"function"!=typeof e.eachLayer)return"mixed";const t={Point:0,LineString:0,Polygon:0};e.eachLayer(e=>{if(e.feature&&e.feature.geometry){const o=e.feature.geometry.type;o.includes("Point")?t.Point++:o.includes("LineString")?t.LineString++:o.includes("Polygon")&&t.Polygon++}});const o=Math.max(t.Point,t.LineString,t.Polygon);return 0===o?"mixed":t.Point===o?"poi":t.LineString===o?"route":t.Polygon===o?"area":"mixed"},n.removeLayer=function(e){const r=t(),i=o(),a=r.layers.get(e);a?(a.visible&&n.hideLayer(e),a.clusterGroup&&a.clusterGroup.clearLayers(),a.layer&&a.layer.clearLayers(),r.layers.delete(e),r.featureCache.delete(e),i.debug("[GeoLeaf.GeoJSON] Couche supprim\xe9e :",e)):i.warn("[GeoLeaf.GeoJSON] removeLayer: couche introuvable :",e)},n.updateLayerZIndex=function(e,n){const r=t(),i=o(),a=r.layers.get(e);if(!a)return i.warn("[GeoLeaf.GeoJSON] updateLayerZIndex: couche introuvable :",e),0;const l=GeoLeaf._GeoJSONShared.PaneHelpers;n=l.validateZIndex(n);const s=a.config.zIndex||0;if(s===n)return i.debug("[GeoLeaf.GeoJSON] updateLayerZIndex: zIndex identique, aucun changement :",e),1;i.info(`[GeoLeaf.GeoJSON] Changement zIndex pour ${e}: ${s} \u2192 ${n}`),a.config.zIndex=n;const c=GeoLeaf._LayerVisibilityManager,u=c?c.getVisibilityState(e):null;if(!(u?u.current:a.visible))return i.debug("[GeoLeaf.GeoJSON] Couche non visible, zIndex mis \xe0 jour dans config uniquement"),1;const d=l.getPaneName(n);if(!r.map.getPane(d))return i.error(`[GeoLeaf.GeoJSON] Pane ${d} introuvable`),0;try{return a.clusterGroup?r.map.removeLayer(a.clusterGroup):r.map.removeLayer(a.layer),a.layer&&a.layer.options&&(a.layer.options.pane=d,a.layer.eachLayer(function(e){if(e.options&&(e.options.pane=d),e._path&&e._path.parentNode){const t=r.map.getPane(d);t&&t.appendChild(e._path)}})),a.clusterGroup&&a.clusterGroup.options&&(a.clusterGroup.options.pane=d),a.clusterGroup?r.map.addLayer(a.clusterGroup):r.map.addLayer(a.layer),i.debug(`[GeoLeaf.GeoJSON] Couche ${e} d\xe9plac\xe9e vers pane ${d}`),r.map&&r.map.fire("geoleaf:geojson:zindex-changed",{layerId:e,oldZIndex:s,newZIndex:n}),1}catch(t){return i.error(`[GeoLeaf.GeoJSON] Erreur lors du changement de zIndex pour ${e}:`,t),0}}}(window)),Ce||(Ce=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=()=>GeoLeaf._GeoJSONShared.state,o=()=>GeoLeaf.Log||console,n=GeoLeaf.Utils&&GeoLeaf.Utils.ScaleUtils,r=GeoLeaf._GeoJSONLayerManager=GeoLeaf._GeoJSONLayerManager||{};r.showLayer=function(e){const n=t(),i=o(),a=n.layers.get(e);if(!a)return void i.warn("[GeoLeaf.GeoJSON] showLayer: couche introuvable :",e);const l=GeoLeaf._LayerVisibilityManager;if(!l)return void i.error("[GeoLeaf.GeoJSON] LayerVisibilityManager non disponible");const s=l.setVisibility(e,1,l.VisibilitySource.USER);r.updateLayerVisibilityByZoom(),s&&(r._loadLayerLegend(e,a),GeoLeaf.Labels&&GeoLeaf.Labels.hasLabelConfig(e)&&(1==a.currentStyle?.label?.visibleByDefault?GeoLeaf.Labels.enableLabels(e,{},1):GeoLeaf.Labels.areLabelsEnabled(e)&&GeoLeaf.Labels.refreshLabels(e)),GeoLeaf._LabelButtonManager&&GeoLeaf._LabelButtonManager.syncImmediate(e),i.debug("[GeoLeaf.GeoJSON] Couche affich\xe9e :",e))},r.hideLayer=function(e){const n=t(),i=o();if(!n.layers.get(e))return void i.warn("[GeoLeaf.GeoJSON] hideLayer: couche introuvable :",e);const a=GeoLeaf._LayerVisibilityManager;if(!a)return void i.error("[GeoLeaf.GeoJSON] LayerVisibilityManager non disponible");const l=a.setVisibility(e,0,a.VisibilitySource.USER);r.updateLayerVisibilityByZoom(),l&&(GeoLeaf.Labels&&GeoLeaf.Labels.disableLabels(e),GeoLeaf._LabelButtonManager&&GeoLeaf._LabelButtonManager.syncImmediate(e),i.debug("[GeoLeaf.GeoJSON] Couche masqu\xe9e :",e))},r.toggleLayer=function(e){const n=t(),i=o(),a=n.layers.get(e);if(!a)return void i.warn("[GeoLeaf.GeoJSON] toggleLayer: couche introuvable :",e);const l=GeoLeaf._LayerVisibilityManager;if(!l)return void i.error("[GeoLeaf.GeoJSON] LayerVisibilityManager non disponible");const s=l.getVisibilityState(e);(s?s.current:a.visible)?r.hideLayer(e):r.showLayer(e)},r._showLayerInternal=function(e){o().warn("[GeoLeaf.GeoJSON] _showLayerInternal() est d\xe9pr\xe9ci\xe9, utiliser LayerVisibilityManager");const t=GeoLeaf._LayerVisibilityManager;t&&t.setVisibility(e,1,t.VisibilitySource.SYSTEM)},r._hideLayerInternal=function(e){o().warn("[GeoLeaf.GeoJSON] _hideLayerInternal() est d\xe9pr\xe9ci\xe9, utiliser LayerVisibilityManager");const t=GeoLeaf._LayerVisibilityManager;t&&t.setVisibility(e,0,t.VisibilitySource.SYSTEM)},r.updateLayerVisibilityByZoom=function(){const e=t(),r=o();if(!e.map)return;const i=GeoLeaf._LayerVisibilityManager;if(!i)return void r.error("[GeoLeaf.GeoJSON] LayerVisibilityManager non disponible");const a=n&&"function"==typeof n.calculateMapScale?n.calculateMapScale(e.map,{logger:r}):0,l=e=>"number"!=typeof e||e<=0?null:e;e.layers.forEach((e,t)=>{if(!e.config)return;const o=!!e.currentStyle,s=o?e.currentStyle.layerScale:null;!s&&o&&r&&"function"==typeof r.warn&&r.warn(`[GeoLeaf.GeoJSON] layerScale manquant pour ${t}, couche laiss\xe9e visible par d\xe9faut`);const c=l(s&&s.minScale),u=l(s&&s.maxScale),d=n&&"function"==typeof n.isScaleInRange?n.isScaleInRange(a,c,u,r):1,f=e._visibility;let p;p=f&&f.userOverride?f.logicalState:f&&f.themeOverride?f.themeDesired:1;const g=p&&d;i.setVisibility(t,g,i.VisibilitySource.ZOOM)})},r._fireLayerVisibilityEvent=function(e,o){const n=t();if(n.map)try{n.map.fire("geoleaf:geojson:visibility-changed",{layerId:e,visible:o})}catch(e){}}}(window)),Se||(Se=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{};function t(e,o,n){if(!e||!o)return;let r=document.querySelector(".leaflet-overlay-pane svg");if(!r){const i=5,a=100;let l=0;const s=()=>{r=document.querySelector(".leaflet-overlay-pane svg"),r?t(e,o,n):(l++,l<i&&setTimeout(s,a))};return void setTimeout(s,a)}let i=r.querySelector(`#${o}`);if(!i&&n){const e=n.spacingPx||10,t=n.type||"diagonal",a=n.angleDeg,l=n.stroke?.color||"#000000",s=n.stroke?.widthPx||1,c=n.stroke?.opacity||1,u=l.startsWith("#")?l:`#${l}`;if(i=document.createElementNS("http://www.w3.org/2000/svg","pattern"),i.setAttribute("id",o),i.setAttribute("patternUnits","userSpaceOnUse"),i.setAttribute("width",e),i.setAttribute("height",e),"dot"===t){const t=document.createElementNS("http://www.w3.org/2000/svg","circle");t.setAttribute("cx",e/2),t.setAttribute("cy",e/2),t.setAttribute("r",Math.max(.3,.07*e)),t.setAttribute("fill",u),t.setAttribute("fill-opacity",c),i.appendChild(t)}else if("diagonal"===t){const t=document.createElementNS("http://www.w3.org/2000/svg","line");if(t.setAttribute("x1","0"),t.setAttribute("y1","0"),t.setAttribute("x2",e),t.setAttribute("y2",e),t.setAttribute("stroke",u),t.setAttribute("stroke-width",s),t.setAttribute("stroke-opacity",c),null!=a&&45!==a){const t=e/2,o=e/2;i.setAttribute("patternTransform",`rotate(${a} ${t} ${o})`)}i.appendChild(t)}else if("cross"===t){const t=document.createElementNS("http://www.w3.org/2000/svg","line");t.setAttribute("x1","0"),t.setAttribute("y1",e/2),t.setAttribute("x2",e),t.setAttribute("y2",e/2),t.setAttribute("stroke",u),t.setAttribute("stroke-width",s),t.setAttribute("stroke-opacity",c),i.appendChild(t);const o=document.createElementNS("http://www.w3.org/2000/svg","line");o.setAttribute("x1",e/2),o.setAttribute("y1","0"),o.setAttribute("x2",e/2),o.setAttribute("y2",e),o.setAttribute("stroke",u),o.setAttribute("stroke-width",s),o.setAttribute("stroke-opacity",c),i.appendChild(o)}else if("x"===t){const t=document.createElementNS("http://www.w3.org/2000/svg","line");t.setAttribute("x1","0"),t.setAttribute("y1","0"),t.setAttribute("x2",e),t.setAttribute("y2",e),t.setAttribute("stroke",u),t.setAttribute("stroke-width",s),t.setAttribute("stroke-opacity",c),i.appendChild(t);const o=document.createElementNS("http://www.w3.org/2000/svg","line");o.setAttribute("x1",e),o.setAttribute("y1","0"),o.setAttribute("x2","0"),o.setAttribute("y2",e),o.setAttribute("stroke",u),o.setAttribute("stroke-width",s),o.setAttribute("stroke-opacity",c),i.appendChild(o)}else if("horizontal"===t){const t=document.createElementNS("http://www.w3.org/2000/svg","line");t.setAttribute("x1","0"),t.setAttribute("y1",e/2),t.setAttribute("x2",e),t.setAttribute("y2",e/2),t.setAttribute("stroke",u),t.setAttribute("stroke-width",s),t.setAttribute("stroke-opacity",c),i.appendChild(t)}else if("vertical"===t){const t=document.createElementNS("http://www.w3.org/2000/svg","line");t.setAttribute("x1",e/2),t.setAttribute("y1","0"),t.setAttribute("x2",e/2),t.setAttribute("y2",e),t.setAttribute("stroke",u),t.setAttribute("stroke-width",s),t.setAttribute("stroke-opacity",c),i.appendChild(t)}let d=r.querySelector("defs");d||(d=document.createElementNS("http://www.w3.org/2000/svg","defs"),r.insertBefore(d,r.firstChild)),d.appendChild(i)}const a=e=>{if(e&&e.setAttribute){const t=`url(#${o})`;if(e.getAttribute("fill")!==t&&e.setAttribute("fill",t),n&&"pattern_only"===n.renderMode){const t=e.getAttribute("fill-opacity");(null==t||Number(t)<=0)&&e.setAttribute("fill-opacity","1")}if(!e._hatchObserver){const n=new MutationObserver(n=>{n.forEach(n=>{if("attributes"===n.type&&"fill"===n.attributeName){const n=e.getAttribute("fill");n===t||n.includes(o)||e.setAttribute("fill",t)}})});n.observe(e,{attributes:1,attributeFilter:["fill"]}),e._hatchObserver=n}}};e._path&&a(e._path),"function"==typeof e.eachLayer&&e.eachLayer(e=>{e._path&&a(e._path)})}function o(e,t){if(!e||"object"!=typeof e)return{};const o={};if(e.fill||e.stroke){if(e.fill&&(e.fill.color&&(o.fillColor=e.fill.color),"number"==typeof e.fill.opacity&&(o.fillOpacity=e.fill.opacity),e.fill.pattern&&(o.fillPattern=e.fill.pattern)),e.hatch&&e.hatch.enabled&&"pattern_only"===e.hatch.renderMode&&(o.fillColor||(o.fillColor="#ffffff"),o.fillOpacity=1),e.stroke&&(e.stroke.color&&(o.color=e.stroke.color),"number"==typeof e.stroke.opacity&&(o.opacity=e.stroke.opacity),"number"==typeof e.stroke.widthPx&&(o.weight=e.stroke.widthPx),e.stroke.dashArray&&(o.dashArray=e.stroke.dashArray),e.stroke.lineCap&&(o.lineCap=e.stroke.lineCap),e.stroke.lineJoin&&(o.lineJoin=e.stroke.lineJoin)),e.casing&&e.casing.enabled&&(o._casing={enabled:1,color:e.casing.color||"#000000",opacity:"number"==typeof e.casing.opacity?e.casing.opacity:1,weight:"number"==typeof e.casing.widthPx?e.casing.widthPx:1,dashArray:e.casing.dashArray||null,lineCap:e.casing.lineCap||null,lineJoin:e.casing.lineJoin||null}),e.shape&&(o.shape=e.shape),"number"==typeof e.sizePx&&(o.radius=e.sizePx,o.sizePx=e.sizePx),e.hatch){if(o.hatch={...e.hatch},e.hatch.stroke){const t={};e.hatch.stroke.color&&(t.color=e.hatch.stroke.color),"number"==typeof e.hatch.stroke.opacity&&(t.opacity=e.hatch.stroke.opacity),"number"==typeof e.hatch.stroke.widthPx&&(t.widthPx=e.hatch.stroke.widthPx),o.hatch.stroke=t}if(e.hatch.enabled&&t){const n=function(e,t){if(!t||!t.enabled)return null;const o=t.type||"diagonal",n=t.angleDeg||0,r=t.spacingPx||10,i=(t.stroke?.color||"#000000").replace("#",""),a=t.stroke?.widthPx||1,l=t.stroke?.opacity||1,s=`hatch-${e}-${o}-${n}-${r}-${i}-${a}-${l}`;if(document.getElementById(s))return s;const c=document.createElementNS("http://www.w3.org/2000/svg","pattern");if(c.setAttribute("id",s),c.setAttribute("patternUnits","userSpaceOnUse"),c.setAttribute("width",r),c.setAttribute("height",r),"dot"===o){const e=document.createElementNS("http://www.w3.org/2000/svg","circle");e.setAttribute("cx",r/2),e.setAttribute("cy",r/2),e.setAttribute("r",Math.max(.5,a/2)),e.setAttribute("fill",`#${i}`),e.setAttribute("fill-opacity",l),c.appendChild(e)}else if("cross"===o){const e=document.createElementNS("http://www.w3.org/2000/svg","line");e.setAttribute("x1","0"),e.setAttribute("y1",r/2),e.setAttribute("x2",r),e.setAttribute("y2",r/2),e.setAttribute("stroke",`#${i}`),e.setAttribute("stroke-width",a),e.setAttribute("stroke-opacity",l),c.appendChild(e);const t=document.createElementNS("http://www.w3.org/2000/svg","line");t.setAttribute("x1",r/2),t.setAttribute("y1","0"),t.setAttribute("x2",r/2),t.setAttribute("y2",r),t.setAttribute("stroke",`#${i}`),t.setAttribute("stroke-width",a),t.setAttribute("stroke-opacity",l),c.appendChild(t)}else if("x"===o){const e=document.createElementNS("http://www.w3.org/2000/svg","line");e.setAttribute("x1","0"),e.setAttribute("y1","0"),e.setAttribute("x2",r),e.setAttribute("y2",r),e.setAttribute("stroke",`#${i}`),e.setAttribute("stroke-width",a),e.setAttribute("stroke-opacity",l),c.appendChild(e);const t=document.createElementNS("http://www.w3.org/2000/svg","line");t.setAttribute("x1",r),t.setAttribute("y1","0"),t.setAttribute("x2","0"),t.setAttribute("y2",r),t.setAttribute("stroke",`#${i}`),t.setAttribute("stroke-width",a),t.setAttribute("stroke-opacity",l),c.appendChild(t)}else{const e=document.createElementNS("http://www.w3.org/2000/svg","line");if("horizontal"===o||0===n)e.setAttribute("x1","0"),e.setAttribute("y1",r/2),e.setAttribute("x2",r),e.setAttribute("y2",r/2);else if("vertical"===o||90===n)e.setAttribute("x1",r/2),e.setAttribute("y1","0"),e.setAttribute("x2",r/2),e.setAttribute("y2",r);else if(e.setAttribute("x1","0"),e.setAttribute("y1","0"),e.setAttribute("x2",r),e.setAttribute("y2",r),null!=n&&45!==n){const e=r/2,t=r/2;c.setAttribute("patternTransform",`rotate(${n} ${e} ${t})`)}e.setAttribute("stroke",`#${i}`),e.setAttribute("stroke-width",a),e.setAttribute("stroke-opacity",l),c.appendChild(e)}return s}(t,e.hatch);n&&(o._hatchPatternId=n,"pattern_only"===e.hatch.renderMode&&(o.fillColor=o.fillColor||"#ffffff",o.fillOpacity=1))}}}else Object.assign(o,e);return o}(GeoLeaf._GeoJSONLayerManager=GeoLeaf._GeoJSONLayerManager||{}).setLayerStyle=function(n,r){const i=GeoLeaf._GeoJSONShared.state,a=GeoLeaf.Log||console,l=i.layers.get(n);if(!l)return a.warn("[GeoLeaf.GeoJSON] setLayerStyle: couche introuvable :",n),0;const s=l.layer;if(!s||"function"!=typeof s.setStyle)return a.warn("[GeoLeaf.GeoJSON] setLayerStyle: couche sans m\xe9thode setStyle :",n),0;const c=o(r.defaultStyle||r.style||{},n),u=Object.assign({},{color:"#3388ff",weight:3,opacity:.65,fillColor:"#3388ff",fillOpacity:.2},c),d=Array.isArray(r.styleRules)?r.styleRules:[];try{let i=0,c=0;const f=[];if(s.eachLayer(function(r){if(!r.feature)return;const a=(e=>{let t=Object.assign({},u);if(d.length>0&&GeoLeaf._GeoJSONStyleResolver){const r=GeoLeaf._GeoJSONStyleResolver.evaluateStyleRules(e,d);if(r){const e=o(r,n);t=Object.assign({},t,e)}}return t})(r.feature);if(r.setStyle&&"function"==typeof r.setStyle){if(r.setStyle(a),i++,a._casing&&a._casing.enabled&&r instanceof e.L.Polyline&&!(r instanceof e.L.Polygon)){const t=a._casing;if(r._casingLayer)r._casingLayer.setStyle({color:t.color,opacity:t.opacity,weight:t.weight,dashArray:t.dashArray,lineCap:t.lineCap||"butt",lineJoin:t.lineJoin||"miter"});else{const o={color:t.color,opacity:t.opacity,weight:t.weight,dashArray:t.dashArray,lineCap:t.lineCap||"butt",lineJoin:t.lineJoin||"miter",fill:0};r._casingLayer=e.L.polyline(r.getLatLngs(),o),s&&s.addLayer?s.addLayer(r._casingLayer):r._map&&r._map.addLayer(r._casingLayer),r._casingLayer.setZIndex&&r._casingLayer.setZIndex((r.options.zIndex||0)-1)}}else a._casing&&a._casing.enabled||r._casingLayer&&s&&s.removeLayer&&(s.removeLayer(r._casingLayer),r._casingLayer=null);if(a._hatchPatternId&&a.hatch){const e=a._hatchPatternId,o=a.hatch;r._path&&setTimeout(()=>{t(r,e,o)},0),r._hatchPatternId&&r._hatchPatternId===e||(r._hatchPatternId=e,r._hatchListener&&r.off("add",r._hatchListener),r._hatchListener=function(){this._path&&t(this,e,o)},r.on("add",r._hatchListener))}}else e.L&&r instanceof e.L.Marker&&f.push({layer:r,feature:r.feature,style:a})}),f.length>0){const t=e.GeoLeaf&&e.GeoLeaf._POIMarkers;f.forEach(({layer:o,feature:n,style:r})=>{const i=o.getLatLng();if(t&&"function"==typeof t.buildMarkerIcon){const e={...n.properties,latlng:[i.lat,i.lng],attributes:n.properties.attributes||{},_layerConfig:{style:r}};let a={};"function"==typeof t.resolveCategoryDisplay&&(a=t.resolveCategoryDisplay(e)),r.fillColor&&(a.colorFill=r.fillColor),r.color&&(a.colorStroke=r.color),"number"==typeof r.radius&&(a.radius=r.radius),"number"==typeof r.weight&&(a.weight=r.weight),"number"==typeof r.fillOpacity&&(a.fillOpacity=r.fillOpacity),"number"==typeof r.opacity&&(a.opacity=r.opacity);const l=t.buildMarkerIcon(a);o.setIcon(l),c++}else{const t=e.L.circleMarker(i,r);t.feature=n,s.removeLayer(o),s.addLayer(t),c++}})}a.debug(`[GeoLeaf.GeoJSON] Style appliqu\xe9: ${i+c} features (${i} setStyle, ${c} markers)`);const p=d.some(e=>e.style?.hatch?.enabled);if(u._hatchPatternId&&!p){const o=u._hatchPatternId;t(s,o),a.debug(`[GeoLeaf.GeoJSON] Hachures appliqu\xe9es: pattern=${o}, features=${i}`),l._hatchListeners&&(s.off("add",l._hatchListeners.onAdd),e.L&&e.L.DomEvent&&s.eachLayer(e=>{e._path&&e.off("add",l._hatchListeners.onLayerAdd)}));const n=()=>{setTimeout(()=>t(s,o),0)},r=function(){this._path&&this._path.setAttribute("fill",`url(#${o})`)};s.on("add",n),s.eachLayer(e=>{e._path&&e.on("add",r)}),l._hatchListeners={onAdd:n,onLayerAdd:r},l._hatchPatternId=o}return l.config=Object.assign({},l.config,{style:r.defaultStyle||r.style,styleRules:d}),l.currentStyle=r,GeoLeaf._LabelButtonManager&&GeoLeaf._LabelButtonManager.syncImmediate(n),GeoLeaf._GeoJSONLayerManager&&"function"==typeof GeoLeaf._GeoJSONLayerManager.updateLayerVisibilityByZoom&&GeoLeaf._GeoJSONLayerManager.updateLayerVisibilityByZoom(),a.debug("[GeoLeaf.GeoJSON] Style appliqu\xe9 avec succ\xe8s :",n),1}catch(e){return a.error("[GeoLeaf.GeoJSON] Erreur setLayerStyle :",n,e.message),0}}}(window)),Ie||(Ie=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=()=>GeoLeaf.Log||console,o=GeoLeaf._GeoJSONLayerManager=GeoLeaf._GeoJSONLayerManager||{};o.registerWithLayerManager=function(){const e=GeoLeaf._GeoJSONShared.state,n=t(),r=GeoLeaf.LayerManager;if(n.info(`[GeoLeaf.GeoJSON] registerWithLayerManager() appel\xe9 avec ${e.layers.size} couche(s)`),!r||"function"!=typeof r._registerGeoJsonLayer)return void n.warn("[GeoLeaf.GeoJSON] Module LayerManager non disponible, pas d'int\xe9gration gestionnaire de couches");const i=new Map;e.layers.forEach((e,t)=>{const r=e.config.layerManagerId||"geojson-default";i.has(r)||i.set(r,{id:r,order:99,items:[]});const a=o.detectLayerType(e.layer);let l="fill";"poi"===a?l="circle":"route"===a?l="line":"area"===a&&(l="fill");let s="#3388ff";e.config.style?s=e.config.style.fillColor||e.config.style.color||s:e.config.pointStyle&&(s=e.config.pointStyle.fillColor||s);let c=0,u=null;e.config.labels&&e.config.labels.enabled&&(c=1,u=e.config.labels),!c&&e.currentStyle&&e.currentStyle.label&&e.currentStyle.label.enabled&&(c=1,u={enabled:1}),n&&n.info(`[GeoJSON LayerManager] \u{1f50d} Pr\xe9paration item ${t}:`,{hasConfig:!!e.config,hasStyles:!(!e.config||!e.config.styles),styles:e.config?e.config.styles:"NO CONFIG",configKeys:e.config?Object.keys(e.config).sort():[]}),i.get(r).items.push({id:t,label:e.label,type:l,color:s,visible:e.visible,toggleable:1,order:0,zIndex:e.config.zIndex||0,themes:e.config.themes||null,labels:c?u:null,styles:e.config.styles||null})}),i.forEach(e=>{e.items.sort((e,t)=>(t.zIndex||0)-(e.zIndex||0)),e.items.forEach(t=>{n.debug(`[GeoLeaf.GeoJSON] Enregistrement couche "${t.id}" dans section "${e.id}"`),r._registerGeoJsonLayer(t.id,{layerManagerId:e.id,label:t.label,themes:t.themes,styles:t.styles,labels:t.labels})}),n.debug("[GeoLeaf.GeoJSON] Section couche '"+e.id+"' cr\xe9\xe9e avec "+e.items.length+" couche(s)")})},o._loadLayerLegend=function(e,o){const n=t(),r=o.config||{};if(GeoLeaf.Legend&&"function"==typeof GeoLeaf.Legend.loadLayerLegend){const t=GeoLeaf._LayerManagerStyleSelector;let n=null;if(t&&"function"==typeof t.getCurrentStyle&&(n=t.getCurrentStyle(e)||null),!n&&o.currentStyleMetadata&&o.currentStyleMetadata.id&&(n=o.currentStyleMetadata.id),!n&&r.styles&&Array.isArray(r.styles.available)){const e=r.styles.available,t=r.styles.default,o=t?e.find(e=>e.file===t):null;n=o&&o.id||e[0]&&e[0].id||"default"}return n||(n="default"),void GeoLeaf.Legend.loadLayerLegend(e,n,r)}if(!GeoLeaf.Legend||"function"!=typeof GeoLeaf.Legend.addLayerLegend)return;if(!r.legends||!Array.isArray(r.legends.available))return;let i=o.activeStyle;if(!i&&r.styles&&Array.isArray(r.styles.available)){const e=r.styles.available.find(e=>"default"===e.id);i=e?e.id:r.styles.available[0]?r.styles.available[0].id:"default"}i||(i="default");const a=r.legends.available.find(e=>e.id===i);if(!a||!a.file)return void n.warn(`[GeoLeaf.GeoJSON] Pas de l\xe9gende trouv\xe9e pour le style ${i} de la couche ${e}`);const l=r._profileId,s=r._layerDirectory,c=r.legends.directory||"legends";if(!l||!s)return void n.warn("[GeoLeaf.GeoJSON] M\xe9tadonn\xe9es manquantes (profileId ou layerDirectory) pour charger la l\xe9gende");const u=GeoLeaf.Config,d=u&&u.get?u.get("data"):null,f=`${d&&d.profilesBasePath||"profiles"}/${l}/${s}/${c}/${a.file}`;fetch(f).then(e=>{if(!e.ok)throw new Error(`HTTP ${e.status}`);return e.json()}).then(t=>{GeoLeaf.Legend.addLayerLegend(e,i,t),n.debug(`[GeoLeaf.GeoJSON] L\xe9gende charg\xe9e pour ${e} (${i})`)}).catch(t=>{n.warn(`[GeoLeaf.GeoJSON] Erreur chargement l\xe9gende pour ${e}:`,t.message)})},o.populateLayerManagerWithAllConfigs=function(e){const o=t(),n=GeoLeaf.LayerManager;if(!n||"function"!=typeof n._registerGeoJsonLayer)return void o.warn("[GeoLeaf.GeoJSON] populateLayerManagerWithAllConfigs: Module LayerManager non disponible");if(!GeoLeaf._allLayerConfigs||!Array.isArray(GeoLeaf._allLayerConfigs))return void o.warn("[GeoLeaf.GeoJSON] populateLayerManagerWithAllConfigs: GeoLeaf._allLayerConfigs non disponible");o.info(`[GeoLeaf.GeoJSON] Peuplement LayerManager avec ${GeoLeaf._allLayerConfigs.length} configs de couches...`);let r=[];e&&Array.isArray(e.layers)&&(r=e.layers.map(e=>e.id||e)),o.debug(`[GeoLeaf.GeoJSON] Couches actives du th\xe8me: ${r.join(", ")}`);const i=new Map;GeoLeaf._allLayerConfigs.forEach(e=>{const t=e.layerManagerId||"geojson-default";i.has(t)||i.set(t,{id:t,items:[]});const o=r.includes(e.id);i.get(t).items.push({id:e.id,label:e.label,layerManagerId:t,themes:e.themes||null,isActive:o,zIndex:e.zIndex||0,styles:e.styles||null,labels:e.labels||null})}),i.forEach(e=>{e.items.sort((e,t)=>(t.zIndex||0)-(e.zIndex||0)),e.items.forEach(t=>{o.debug(`[GeoLeaf.GeoJSON] Enregistrement couche "${t.id}" dans section "${e.id}" (actif: ${t.isActive})`),n._registerGeoJsonLayer(t.id,{layerManagerId:e.id,label:t.label,themes:t.themes,checked:t.isActive,styles:t.styles,labels:t.labels})}),o.debug(`[GeoLeaf.GeoJSON] Section "${e.id}" peupl\xe9e avec ${e.items.length} couche(s)`)}),o.info("[GeoLeaf.GeoJSON] LayerManager peupl\xe9 avec succ\xe8s"),n._updateUI&&"function"==typeof n._updateUI&&(o.debug("[GeoLeaf.GeoJSON] Appel LayerManager._updateUI()"),n._updateUI())}}(window)),Pe||(Pe=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{};GeoLeaf._GeoJSONPopupTooltip=GeoLeaf._GeoJSONPopupTooltip||{},GeoLeaf._GeoJSONPopupTooltip.convertFeatureToPOI=function(e,t){let o;const n=GeoLeaf._Normalizer;if(n&&"function"==typeof n.normalizeFromGeoJSON)o=n.normalizeFromGeoJSON(e,t);else{const n=e.properties||{};o={id:n.id||"geojson-feature-"+Math.random().toString(36).substr(2,9),title:n.NAME||n.Name||n.name||n.TITLE||n.Title||n.title||n.LABEL||n.Label||n.label||"Sans titre",description:n.description||n.desc||"",properties:{...n},attributes:{source:"geojson",layerId:t.id,layerLabel:t.label,...n}},e.geometry&&e.geometry.coordinates&&(o.latlng=[e.geometry.coordinates[1],e.geometry.coordinates[0]],o.geometry=e.geometry,o.location={lat:e.geometry.coordinates[1],lng:e.geometry.coordinates[0]})}if(o){o.attributes=o.attributes||{},o.attributes.source="geojson",o.attributes.layerId=t.id,o.attributes.layerLabel=t.label,o._layerConfig=t;const e=GeoLeaf._GeoJSONLoader,n=e&&e.getSidepanelConfig?e.getSidepanelConfig(t):null;n&&(o._sidepanelConfig={detailLayout:n})}return o},GeoLeaf._GeoJSONPopupTooltip.bindUnifiedPopup=function(e,t,o){const n=GeoLeaf.Log||console;if(!e.properties)return;if(0==o.interactiveShape)return;if("boolean"==typeof o.showPopup&&!o.showPopup)return void t.on("click",n=>{if(n&&n.originalEvent&&n.originalEvent.stopPropagation(),t.getTooltip&&t.getTooltip())try{"function"==typeof t.closeTooltip?t.closeTooltip():t.unbindTooltip()}catch(e){}if(GeoLeaf.POI&&"function"==typeof GeoLeaf.POI.showPoiDetails){const t=GeoLeaf._GeoJSONPopupTooltip.convertFeatureToPOI(e,o),n=GeoLeaf._POIShared&&GeoLeaf._POIShared.state,r=n?n.currentPoiInPanel:null;r&&t&&r.id&&t.id&&r.id===t.id?GeoLeaf.POI&&"function"==typeof GeoLeaf.POI.hideSidePanel&&GeoLeaf.POI.hideSidePanel():GeoLeaf.POI.showPoiDetails(t)}});if(t.getPopup())return;const r=GeoLeaf._GeoJSONPopupTooltip.convertFeatureToPOI(e,o),i=GeoLeaf._ContentBuilder,a=GeoLeaf._GeoJSONLoader;let l=null;try{l=a&&a.getPopupConfig?a.getPopupConfig(o):null}catch(e){}if(i&&"function"==typeof i.buildPopupHTML){const e=GeoLeaf._POIMarkers,o=e&&"function"==typeof e.resolveCategoryDisplay?e.resolveCategoryDisplay:null,n=i.buildPopupHTML(r,l,{resolveCategoryDisplay:o});n&&t.bindPopup(n)}else{const n=GeoLeaf._POIPopup;if(n&&"function"==typeof n.buildQuickPopupContent){const e=GeoLeaf._POIMarkers,o=e&&"function"==typeof e.resolveCategoryDisplay?e.resolveCategoryDisplay:null,i=n.buildQuickPopupContent(r,o);i&&t.bindPopup(i)}else{const n=GeoLeaf.Security||{escapeHtml:e=>{if(!e)return"";const t=document.createElement("div");return t.textContent=String(e),t.innerHTML}},r=e.properties,i=r.name||r.label||r.title||"Sans titre",a=r.description||r.desc||"";let l='<div class="gl-geojson-popup">';l+='<h3 class="gl-popup-title">'+n.escapeHtml(i)+"</h3>",a&&(l+='<p class="gl-popup-description">'+n.escapeHtml(a)+"</p>"),GeoLeaf.POI&&"function"==typeof GeoLeaf.POI.showPoiDetails&&(l+='<a href="#" class="gl-poi-popup__link" data-layer-id="'+o.id+'" data-feature-id="'+(r.id||"")+'">Voir d\xe9tails \u2192</a>'),l+="</div>",t.bindPopup(l)}}t._geoleafPopupActive=0,t.on("popupopen",()=>{if(t._geoleafPopupActive=1,t.getTooltip&&t.getTooltip())try{"function"==typeof t.closeTooltip&&t.closeTooltip()}catch(e){n.warn("[GeoJSON] Erreur fermeture tooltip:",e)}const r=t.getPopup();if(!r)return;const i=r.getElement();if(!i)return;const a=i.querySelector(".gl-poi-popup__link");a&&a.addEventListener("click",t=>{if(t.preventDefault(),GeoLeaf.POI&&"function"==typeof GeoLeaf.POI.showPoiDetails){const t=GeoLeaf._GeoJSONPopupTooltip.convertFeatureToPOI(e,o);GeoLeaf.POI.showPoiDetails(t)}})}),t.on("popupclose",()=>{t._geoleafPopupActive=0,t.getTooltip()&&t.getTooltip().options.permanent&&setTimeout(()=>{t.openTooltip&&!t._geoleafPopupActive&&t.openTooltip()},50)})},GeoLeaf._GeoJSONPopupTooltip.bindUnifiedTooltip=function(e,t,o){const n=GeoLeaf._GeoJSONShared.state;if(!e.properties||!t)return;const r=o.tooltipMode||"hover",i="number"==typeof o.tooltipMinZoom?o.tooltipMinZoom:0;if("never"===r)return;const a=e.properties,l=a.name||a.label||a.title||a.id||"Sans titre",s=GeoLeaf._GeoJSONLoader,c=s&&s.getTooltipConfig?s.getTooltipConfig(o):null,u=GeoLeaf._GeoJSONPopupTooltip.convertFeatureToPOI(e,o),d=()=>{if(!n.map)return;if(t._geoleafPopupActive)return;const e=n.map.getZoom()>=i,o=(()=>{const e=GeoLeaf._ContentBuilder;if(e&&"function"==typeof e.buildTooltipHTML)return e.buildTooltipHTML(u,c)||l;const t=GeoLeaf._POIPopup;return t&&"function"==typeof t.buildTooltipContent&&t.buildTooltipContent(u)||l})();if(e)if(t.getTooltip()){const e=t.getTooltip();e&&e.setContent&&e.setContent(o)}else{const e={direction:"top",offset:[0,-10],opacity:.9,className:"gl-geojson-tooltip",permanent:"always"===r};t.bindTooltip(o,e),"always"===r&&t.openTooltip&&t.openTooltip()}else if(t.getTooltip())try{"function"==typeof t.closeTooltip?t.closeTooltip():t.unbindTooltip()}catch(e){}};t._geoleafTooltipUpdate=d,t.on("tooltipopen",()=>{t._geoleafPopupActive&&t.closeTooltip()}),t.on("add",()=>{d(),n.map&&n.map.on("zoomend",d)}),t.on("remove",()=>{n.map&&t._geoleafTooltipUpdate&&n.map.off("zoomend",t._geoleafTooltipUpdate)})}}(window)),we||(we=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=()=>GeoLeaf.Log||console;GeoLeaf._GeoJSONClustering=GeoLeaf._GeoJSONClustering||{},GeoLeaf._GeoJSONClustering.getPoiConfig=function(){const e=GeoLeaf.Config;return e&&"function"==typeof e.get&&e.get("poiConfig")||{}},GeoLeaf._GeoJSONClustering.getSharedPOICluster=function(){const e=t();try{const t=GeoLeaf.POI;if(!t||"function"!=typeof t.getLayer)return e.info("[GeoLeaf.GeoJSON] \u274c Module POI non disponible ou getLayer() manquant"),null;const o=t.getLayer();if(!o)return e.info("[GeoLeaf.GeoJSON] \u274c POI.getLayer() retourne null/undefined"),null;if(e.info("[GeoLeaf.GeoJSON] \u{1f50d} POI.getLayer() retourn\xe9:",{hasAddLayer:"function"==typeof o.addLayer,hasRemoveLayer:"function"==typeof o.removeLayer,hasFeatureGroup:void 0!==o._featureGroup,hasGroup:void 0!==o._group,hasClusterGroup:void 0!==o._markerCluster,isMarkerClusterGroup:o.constructor&&"MarkerClusterGroup"===o.constructor.name,constructor:o.constructor?o.constructor.name:"unknown"}),o&&"function"==typeof o.addLayer&&"function"==typeof o.removeLayer)return e.info("[GeoLeaf.GeoJSON] \u2705 Cluster/Layer POI r\xe9cup\xe9r\xe9 avec succ\xe8s"),o;e.warn("[GeoLeaf.GeoJSON] \u274c POI.getLayer() ne retourne pas un layer valide (checks failed)")}catch(t){e.error("[GeoLeaf.GeoJSON] \u274c Impossible de r\xe9cup\xe9rer le cluster POI :",t)}return null},GeoLeaf._GeoJSONClustering.getClusteringStrategy=function(e,o){const n=t(),r=GeoLeaf._GeoJSONClustering.getPoiConfig(),i="object"==typeof e.clustering?e.clustering:{enabled:e.clustering},a=1==i.enabled;if(0==i.enabled)return{shouldCluster:0,useSharedCluster:0};if(!r.clustering&&!a)return{shouldCluster:0,useSharedCluster:0};if(!o.features||!o.features.some(e=>e.geometry&&e.geometry.type&&e.geometry.type.includes("Point")))return{shouldCluster:0,useSharedCluster:0};if(a){const t=i.maxClusterRadius||("number"==typeof e.clusterRadius?e.clusterRadius:null),o=i.disableClusteringAtZoom||("number"==typeof e.disableClusteringAtZoom?e.disableClusteringAtZoom:null);return null!==t&&t!==(r.clusterRadius||80)||null!==o&&o!==(r.disableClusteringAtZoom||18)?{shouldCluster:1,useSharedCluster:0}:{shouldCluster:1,useSharedCluster:"unified"===(r.clusterStrategy||"unified")}}const l=r.clusterStrategy||"unified";switch(l){case"unified":return{shouldCluster:1,useSharedCluster:1};case"by-layer":return{shouldCluster:a,useSharedCluster:0};case"by-source":return{shouldCluster:0!=(r.clusterStrategies?.["by-source"]?.sources||{}).geojson,useSharedCluster:0};case"json-only":return{shouldCluster:1==(r.clusterStrategies?.["json-only"]||{}).geojsonClustering,useSharedCluster:0};default:return n.warn("[GeoLeaf.GeoJSON] Strat\xe9gie de clustering inconnue: "+l+". Utilisation de 'unified'."),{shouldCluster:1,useSharedCluster:1}}},GeoLeaf._GeoJSONClustering.createIndependentCluster=function(t={}){return e.L&&e.L.markerClusterGroup?e.L.markerClusterGroup({maxClusterRadius:t.clusterRadius||80,disableClusteringAtZoom:t.disableClusteringAtZoom||18,animate:void 0!==t.animate?t.animate:0,spiderfyOnMaxZoom:void 0!==t.spiderfyOnMaxZoom?t.spiderfyOnMaxZoom:0,showCoverageOnHover:void 0!==t.showCoverageOnHover?t.showCoverageOnHover:0,zoomToBoundsOnClick:void 0!==t.zoomToBoundsOnClick?t.zoomToBoundsOnClick:1}):null}}(window)),Ae||(Ae=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=()=>GeoLeaf.Log||console;GeoLeaf._GeoJSONLayerConfig=GeoLeaf._GeoJSONLayerConfig||{},GeoLeaf._GeoJSONLayerConfig.resolveDataFilePath=function(e,t,o){const n=GeoLeaf.Config,r=n&&n.get?n.get("data"):null,i=r&&r.profilesBasePath||"profiles",a=r&&r.activeProfile||t.id;return e.startsWith("../")?`${i}/${a}/${e.replace("../","")}`:e.startsWith("/")?e:o?`${i}/${a}/${o}/${e}`:`${i}/${a}/${e}`},GeoLeaf._GeoJSONLayerConfig.inferGeometryType=function(e,t){if(e&&"string"==typeof e.geometryType)return e.geometryType;const o=(t&&Array.isArray(t.features)?t.features:[]).find(e=>e&&e.geometry&&e.geometry.type);if(!o)return"unknown";const n=o.geometry.type.toLowerCase();return n.includes("point")?"point":n.includes("line")?"line":n.includes("polygon")?"polygon":"unknown"},GeoLeaf._GeoJSONLayerConfig.buildLayerOptions=function(t,o){const n=GeoLeaf._GeoJSONShared.state,r=Object.assign({},n.options,o);t.style&&"object"==typeof t.style&&(r.defaultStyle=Object.assign({},r.defaultStyle,t.style)),Array.isArray(t.styleRules)&&t.styleRules.length>0&&(r.styleRules=t.styleRules),r.interactiveShape="boolean"==typeof t.interactiveShape?t.interactiveShape:GeoLeaf.Config&&GeoLeaf.Config.get?GeoLeaf.Config.get("ui.interactiveShapes",0):0;const i="boolean"==typeof t.showIconsOnMap?t.showIconsOnMap:0,a=GeoLeaf._GeoJSONShared.PaneHelpers.getPaneName(t.zIndex);if(i)r.pointToLayer=function(o,n){const i=GeoLeaf._GeoJSONPopupTooltip,l=i?i.convertFeatureToPOI(o,t):null;if(l){const e=t.popup||{},o={enabled:e.enabled,detailPopup:e.detailPopup||e.fields||[],detailTooltip:e.detailTooltip||e.tooltip&&e.tooltip.fields||[]};l._layerConfig={style:r.defaultStyle||{},popup:o,tooltip:t.tooltip||{},sidepanelConfig:t.sidepanelConfig||{}}}const s=GeoLeaf._POIMarkers;if(s&&"function"==typeof s.createMarker&&l){const e=0!=r.interactiveShape,t=s.createMarker(l,{attachEvents:e,pane:a});return t&&t.options&&(t.options.pane=a),t}const c=Object.assign({},r.defaultPointStyle,t.pointStyle,{interactive:r.interactiveShape,pane:a});return e.L.circleMarker(n,c)};else if(t.pointStyle&&"object"==typeof t.pointStyle){const o=Object.assign({},r.defaultPointStyle,t.pointStyle,{interactive:r.interactiveShape,pane:a});r.pointToLayer=function(t,n){return e.L.circleMarker(n,o)}}const l="function"==typeof t.onEachFeature?t.onEachFeature:null;return r.onEachFeature=function(e,o){const n=GeoLeaf._GeoJSONPopupTooltip;n&&(n.bindUnifiedPopup(e,o,t),n.bindUnifiedTooltip(e,o,t)),l&&l(e,o)},r.defaultPointStyle?r.defaultPointStyle=Object.assign({},r.defaultPointStyle,{pane:a}):r.defaultPointStyle={pane:a},GeoLeaf._GeoJSONStyleResolver&&GeoLeaf._GeoJSONStyleResolver.buildLeafletOptions?GeoLeaf._GeoJSONStyleResolver.buildLeafletOptions(r):r},GeoLeaf._GeoJSONLayerConfig.loadLayerLegend=function(e,o){const n=t();if(!o)return void(n&&n.debug("[GeoLeaf.GeoJSON] Pas de d\xe9finition de couche"));const r=o.legends?o:null;if(!r||!r.legends)return void(n&&n.debug("[GeoLeaf.GeoJSON] Pas de config legends pour cette couche"));const i=r.legends,a=i.directory||"legends",l=o.style||"default";let s;s="default"===l&&i.default?i.default:`${l}.legend.json`;const c=`${e.basePath||"./profiles/"+e.id}/${o._layerDirectory||"layers/"+o.id}/${a}/${s}`;n&&n.debug(`[GeoLeaf.GeoJSON] Chargement l\xe9gende pour style "${l}": ${c}`),GeoLeaf.Legend&&"function"==typeof GeoLeaf.Legend.loadLegend?GeoLeaf.Legend.loadLegend(c).then(e=>{e&&n&&n.info(`[GeoLeaf.GeoJSON] L\xe9gende affich\xe9e pour ${o.id} (style: ${l})`)}).catch(e=>{n&&n.warn(`[GeoLeaf.GeoJSON] Erreur chargement l\xe9gende: ${e.message}`)}):n&&n.warn("[GeoLeaf.GeoJSON] Module Legend non disponible")},GeoLeaf._GeoJSONLayerConfig.loadDefaultStyle=async function(o,n){const r=t();if(!n.styles||!n.styles.default)throw new Error("Pas de style par d\xe9faut d\xe9fini");const i=n._profileId,a=n._layerDirectory;if(!i||!a)throw new Error("M\xe9tadonn\xe9es manquantes (profileId ou layerDirectory)");const l=e.GeoLeaf.Config,s=l&&l.get?l.get("data"):null,c=`${s&&s.profilesBasePath||"profiles"}/${i}/${a}/${n.styles.directory||"styles"}/${n.styles.default}`;r.debug("[GeoLeaf.GeoJSON] Chargement style par d\xe9faut:",c);const u=await fetch(c);if(!u.ok)throw new Error(`HTTP ${u.status}`);const d=await u.json();return r.debug("[GeoLeaf.GeoJSON] Style charg\xe9:",d),d}}(window)),Ge||(Ge=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=()=>GeoLeaf.Log||console;GeoLeaf._GeoJSONFeatureValidator=GeoLeaf._GeoJSONFeatureValidator||{},GeoLeaf._GeoJSONFeatureValidator.validateFeatureCollection=function(e){const o=t(),n=[],r=[];if(!e||"object"!=typeof e)return o.warn("[GeoLeaf.GeoJSON.Validator] Collection non valide : type invalide"),{validFeatures:[],errors:[{message:"Collection non valide"}]};const i="FeatureCollection"===e.type?e.features:Array.isArray(e)?e:[e];return Array.isArray(i)?(i.forEach((e,t)=>{const o=GeoLeaf._GeoJSONFeatureValidator.validateFeature(e,t);o.valid?r.push(e):n.push(...o.errors)}),{validFeatures:r,errors:n}):(o.warn("[GeoLeaf.GeoJSON.Validator] Pas de features \xe0 valider"),{validFeatures:[],errors:[]})},GeoLeaf._GeoJSONFeatureValidator.validateFeature=function(e,o){const n=t(),r=[],i=e?.properties?.id||e?.id||o||"unknown";if(!e||"Feature"!==e.type)return r.push({featureId:i,field:"type",message:"Feature doit avoir type='Feature'",severity:"error"}),n.warn(`[GeoLeaf.GeoJSON.Validator] Feature ${i}: type invalide`),{valid:0,errors:r};const a=GeoLeaf._GeoJSONFeatureValidator.validateGeometry(e.geometry,i);a.valid||r.push(...a.errors);const l=GeoLeaf._GeoJSONFeatureValidator.validateProperties(e.properties,i);return l.valid||r.push(...l.errors),r.length>0?(n.warn(`[GeoLeaf.GeoJSON.Validator] Feature ${i} rejet\xe9e : ${r.map(e=>e.message).join("; ")}`),{valid:0,errors:r}):{valid:1,errors:[]}},GeoLeaf._GeoJSONFeatureValidator.validateGeometry=function(e,t){const o=[],n=["Point","LineString","MultiLineString","Polygon","MultiPolygon"];return e&&"object"==typeof e?e.type?n.includes(e.type)?Array.isArray(e.coordinates)&&0!==e.coordinates.length?{valid:0===o.length,errors:o}:(o.push({featureId:t,field:"geometry.coordinates",message:"geometry.coordinates doit \xeatre un array non-vide",severity:"error"}),{valid:0,errors:o}):(o.push({featureId:t,field:"geometry.type",message:`Type de g\xe9om\xe9trie invalide '${e.type}'. Doit \xeatre : ${n.join(", ")}`,severity:"error"}),{valid:0,errors:o}):(o.push({featureId:t,field:"geometry.type",message:"geometry.type requis",severity:"error"}),{valid:0,errors:o}):(o.push({featureId:t,field:"geometry",message:"geometry requis et doit \xeatre un objet",severity:"error"}),{valid:0,errors:o})},GeoLeaf._GeoJSONFeatureValidator.validateProperties=function(e,t){const o=[];return e&&"object"==typeof e?(e.name||e.title||e.label||o.push({featureId:t,field:"properties.name",message:"properties doit contenir au moins name, title ou label",severity:"error"}),void 0!==e.distance_km&&"number"!=typeof e.distance_km&&o.push({featureId:t,field:"properties.distance_km",message:"distance_km doit \xeatre un nombre",severity:"warning"}),"number"==typeof e.distance_km&&e.distance_km<0&&o.push({featureId:t,field:"properties.distance_km",message:"distance_km doit \xeatre >= 0",severity:"warning"}),void 0!==e.duration_min&&"number"!=typeof e.duration_min&&o.push({featureId:t,field:"properties.duration_min",message:"duration_min doit \xeatre un nombre",severity:"warning"}),"number"==typeof e.duration_min&&e.duration_min<0&&o.push({featureId:t,field:"properties.duration_min",message:"duration_min doit \xeatre >= 0",severity:"warning"}),void 0!==e.rating&&("number"!=typeof e.rating?o.push({featureId:t,field:"properties.rating",message:"rating doit \xeatre un nombre",severity:"warning"}):(e.rating<0||e.rating>5)&&o.push({featureId:t,field:"properties.rating",message:"rating doit \xeatre entre 0 et 5",severity:"warning"})),void 0!==e.color&&"string"==typeof e.color&&(/^#([0-9a-fA-F]{6}|[0-9a-fA-F]{3})$/.test(e.color)||o.push({featureId:t,field:"properties.color",message:`color invalide '${e.color}'. Format: #RGB ou #RRGGBB`,severity:"warning"})),void 0!==e.opacity&&("number"!=typeof e.opacity?o.push({featureId:t,field:"properties.opacity",message:"opacity doit \xeatre un nombre",severity:"warning"}):(e.opacity<0||e.opacity>1)&&o.push({featureId:t,field:"properties.opacity",message:"opacity doit \xeatre entre 0 et 1",severity:"warning"})),void 0!==e.weight&&("number"!=typeof e.weight?o.push({featureId:t,field:"properties.weight",message:"weight doit \xeatre un nombre",severity:"warning"}):e.weight<0&&o.push({featureId:t,field:"properties.weight",message:"weight doit \xeatre >= 0",severity:"warning"})),["link","photo","url"].forEach(n=>{void 0!==e[n]&&"string"==typeof e[n]&&(GeoLeaf._GeoJSONFeatureValidator.isValidUrl(e[n])||o.push({featureId:t,field:`properties.${n}`,message:`${n} n'est pas une URL valide`,severity:"warning"}))}),void 0!==e.email&&"string"==typeof e.email&&(GeoLeaf._GeoJSONFeatureValidator.isValidEmail(e.email)||o.push({featureId:t,field:"properties.email",message:"email invalide",severity:"warning"})),void 0!==e.tags&&(Array.isArray(e.tags)?e.tags.forEach((e,n)=>{"string"!=typeof e&&o.push({featureId:t,field:`properties.tags[${n}]`,message:"tag doit \xeatre une string",severity:"warning"})}):o.push({featureId:t,field:"properties.tags",message:"tags doit \xeatre un array",severity:"warning"})),Object.entries(e).forEach(([e,n])=>{null===n||"object"!=typeof n||Array.isArray(n)||o.push({featureId:t,field:`properties.${e}`,message:`Propri\xe9t\xe9 imbriqu\xe9e d\xe9tect\xe9e. Les propri\xe9t\xe9s doivent \xeatre plates (strings, nombres, arrays). Objet trouv\xe9: ${JSON.stringify(n)}`,severity:"error"})}),{valid:!o.some(e=>"error"===e.severity),errors:o}):(o.push({featureId:t,field:"properties",message:"properties requis et doit \xeatre un objet",severity:"error"}),{valid:0,errors:o})},GeoLeaf._GeoJSONFeatureValidator.isValidUrl=function(e){if("string"!=typeof e)return 0;try{return new URL(e),1}catch{return/^(https?:\/\/|\/|\.\.?\/)/.test(e)}},GeoLeaf._GeoJSONFeatureValidator.isValidEmail=function(e){return"string"!=typeof e?0:/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}}("undefined"!=typeof window?window:gt)),Ee||(Ee=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{};GeoLeaf._GeoJSONLoader=GeoLeaf._GeoJSONLoader||{},GeoLeaf._GeoJSONLoader.getPopupConfig=function(e){return e?e.popupFields&&Array.isArray(e.popupFields)?e.popupFields:e.popup&&e.popup.fields&&Array.isArray(e.popup.fields)?e.popup.fields:null:null},GeoLeaf._GeoJSONLoader.getTooltipConfig=function(e){return e?e.tooltipFields&&Array.isArray(e.tooltipFields)?e.tooltipFields:e.tooltip&&e.tooltip.fields&&Array.isArray(e.tooltip.fields)?e.tooltip.fields:null:null},GeoLeaf._GeoJSONLoader.getSidepanelConfig=function(e){return e?e.sidepanelFields&&Array.isArray(e.sidepanelFields)?e.sidepanelFields:e.sidepanel&&e.sidepanel.detailLayout&&Array.isArray(e.sidepanel.detailLayout)?e.sidepanel.detailLayout:null:null},GeoLeaf._GeoJSONLoader._resolveDataFilePath=function(e,t,o){return GeoLeaf._GeoJSONLayerConfig.resolveDataFilePath(e,t,o)},GeoLeaf._GeoJSONLoader._inferGeometryType=function(e,t){return GeoLeaf._GeoJSONLayerConfig.inferGeometryType(e,t)},GeoLeaf._GeoJSONLoader._buildLayerOptions=function(e,t){return GeoLeaf._GeoJSONLayerConfig.buildLayerOptions(e,t)},GeoLeaf._GeoJSONLoader._loadLayerLegend=function(e,t){return GeoLeaf._GeoJSONLayerConfig.loadLayerLegend(e,t)},GeoLeaf._GeoJSONLoader._loadDefaultStyle=function(e,t){return GeoLeaf._GeoJSONLayerConfig.loadDefaultStyle(e,t)}}(window)),Oe||(Oe=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=()=>GeoLeaf._GeoJSONShared.state,o=()=>GeoLeaf.Log||console;GeoLeaf._GeoJSONLoader=GeoLeaf._GeoJSONLoader||{},GeoLeaf._GeoJSONLoader.loadUrl=async function(e,n={}){const r=t(),i=o();if(!e)return i.warn("[GeoLeaf.GeoJSON] URL GeoJSON manquante."),r.geoJsonLayer;if(!r.map)return i.error("[GeoLeaf.GeoJSON] Module non initialis\xe9. Appelle GeoLeaf.GeoJSON.init() avant loadUrl()."),null;const a=GeoLeaf.Utils&&GeoLeaf.Utils.mergeOptions?GeoLeaf.Utils.mergeOptions(r.options,n):Object.assign({},r.options,n);try{const t=GeoLeaf.Utils?.FetchHelper;let o;if(t)o=await t.get(e,{timeout:2e4,retries:2});else{const t=await fetch(e);if(!t.ok)throw new Error("HTTP "+t.status+" pour "+e);o=await t.json()}return GeoLeaf._GeoJSONLoader.addData(o,a),r.geoJsonLayer}catch(e){return i.error("[GeoLeaf.GeoJSON] Erreur lors du chargement GeoJSON :",e),r.geoJsonLayer}},GeoLeaf._GeoJSONLoader.addData=function(e,n={}){const r=t(),i=o();if(!e)return void i.warn("[GeoLeaf.GeoJSON] Aucune donn\xe9e GeoJSON fournie \xe0 addData().");if(!r.map||!r.geoJsonLayer)return void i.error("[GeoLeaf.GeoJSON] Module non initialis\xe9. Appelle GeoLeaf.GeoJSON.init() avant addData().");const a=GeoLeaf.Utils&&GeoLeaf.Utils.mergeOptions?GeoLeaf.Utils.mergeOptions(r.options,n):Object.assign({},r.options,n);GeoLeaf._GeoJSONStyleResolver&&GeoLeaf._GeoJSONStyleResolver.buildLeafletOptions&&(r.geoJsonLayer.options=GeoLeaf._GeoJSONStyleResolver.buildLeafletOptions(a));let l=e;if(GeoLeaf._GeoJSONFeatureValidator&&"function"==typeof GeoLeaf._GeoJSONFeatureValidator.validateFeatureCollection){const t=GeoLeaf._GeoJSONFeatureValidator.validateFeatureCollection(e);if(t.errors.length>0&&i.warn(`[GeoLeaf.GeoJSON] Validation: ${t.errors.length} feature(s) rejet\xe9e(s), ${t.validFeatures.length} accept\xe9e(s)`),!(t.validFeatures.length>0))return void i.warn("[GeoLeaf.GeoJSON] Aucune feature valide \xe0 ajouter apr\xe8s validation");l="FeatureCollection"===e.type?{type:"FeatureCollection",features:t.validFeatures}:1===t.validFeatures.length?t.validFeatures[0]:{type:"FeatureCollection",features:t.validFeatures}}if(r.geoJsonLayer.addData(l),a.fitBoundsOnLoad&&r.layerGroup){const e=r.layerGroup.getBounds();if(e.isValid()){const t={};"number"==typeof a.maxZoomOnFit&&(t.maxZoom=a.maxZoomOnFit),r.map.fitBounds(e,t)}}try{r.map.fire("geoleaf:geojson:loaded",{data:e,layer:r.geoJsonLayer})}catch(e){}}}(window)),Te||(Te=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{};GeoLeaf._GeoJSONLoader=GeoLeaf._GeoJSONLoader||{},GeoLeaf._GeoJSONLoader._loadSingleLayer=function(t,o,n,r){const i=GeoLeaf._GeoJSONShared.state,a=GeoLeaf.Log||console,l=!!n._cachedData;return(l?Promise.resolve(n._cachedData):fetch(n.url).then(e=>{if(!e.ok)throw new Error("HTTP "+e.status+" pour "+n.url);return"gpx"===n.type||n.url.endsWith(".gpx")?e.text():e.json()})).then(s=>{l&&delete n._cachedData;const c=GeoLeaf._DataConverter;let u;"gpx"===n.type||n.url.endsWith(".gpx")?"string"==typeof s?u=c&&"function"==typeof c.convertGpxToGeoJSON?c.convertGpxToGeoJSON(s):{type:"FeatureCollection",features:[]}:(a.warn("[GeoLeaf.GeoJSON._loadSingleLayer] GPX n'est pas un string",t),u={type:"FeatureCollection",features:[]}):u=c?c.autoConvert(s):s,a.debug("[GeoLeaf.GeoJSON._loadSingleLayer] Donn\xe9es converties",{layerId:t,type:n.type,features:u.features?u.features.length:0,source:l?"cache":"network"});const d=GeoLeaf._GeoJSONShared.PaneHelpers,f=GeoLeaf._GeoJSONShared.PANE_CONFIG,p=GeoLeaf._GeoJSONLoader._buildLayerOptions(n,r);p.pane=d.getPaneName(n.zIndex);const g=e.L.geoJSON(u,p),y=GeoLeaf._GeoJSONClustering,h=y?y.getClusteringStrategy(n,u):{shouldCluster:0,useSharedCluster:0};let m=null,b=0;if(h.shouldCluster)if(h.useSharedCluster){a.info("[GeoLeaf.GeoJSON] \u{1f504} Tentative r\xe9cup\xe9ration cluster POI partag\xe9 pour:",t);let r=y?y.getSharedPOICluster():null;if(!r){a.debug("[GeoLeaf.GeoJSON] Cluster POI non disponible imm\xe9diatement, tentative apr\xe8s d\xe9lai :",t);const l={id:t,label:o,layer:g,visible:1,config:n,clusterGroup:null,useSharedCluster:0,pendingSharedCluster:1};return i.layers.set(t,l),setTimeout(()=>{if(r=y?y.getSharedPOICluster():null,r)r.addLayer(g),l.clusterGroup=r,l.useSharedCluster=1,l.pendingSharedCluster=0,a.debug("[GeoLeaf.GeoJSON] Couche ajout\xe9e au cluster POI partag\xe9 (apr\xe8s d\xe9lai) :",t);else if(a.warn("[GeoLeaf.GeoJSON] Cluster POI toujours non disponible, cr\xe9ation cluster ind\xe9pendant :",t),e.L.markerClusterGroup){const t=e.L.markerClusterGroup({maxClusterRadius:n.clusterRadius||80,disableClusteringAtZoom:n.disableClusteringAtZoom||18,animate:0,showCoverageOnHover:0});t.on("layeradd",function(e){d.applyPaneToLayer(e.layer,n.zIndex||0)}),t.addLayer(g),l.clusterGroup=t,l.useSharedCluster=0,l.pendingSharedCluster=0,l.visible&&i.map.addLayer(t)}},500),{id:t,label:o,featureCount:g.getLayers().length}}m=r,m.addLayer(g),b=1,a.info("[GeoLeaf.GeoJSON] \u2705 Couche ajout\xe9e au cluster POI partag\xe9 (strat\xe9gie: unified) :",t)}else e.L.markerClusterGroup&&(m=e.L.markerClusterGroup({maxClusterRadius:n.clusterRadius||80,disableClusteringAtZoom:n.disableClusteringAtZoom||18,animate:0,spiderfyOnMaxZoom:0,showCoverageOnHover:0,zoomToBoundsOnClick:1}),d.getPaneName(n.zIndex),m.on("layeradd",function(e){d.applyPaneToLayer(e.layer,n.zIndex||0)}),m.addLayer(g),a.debug("[GeoLeaf.GeoJSON] Couche avec cluster ind\xe9pendant (strat\xe9gie: by-source) :",t));else a.debug("[GeoLeaf.GeoJSON] Couche sans clustering :",t);const _=GeoLeaf._GeoJSONLoader._inferGeometryType(n,u);let v=n.zIndex;if("number"!=typeof v){const e=Array.from(i.layers.keys());v=Math.max(f.MIN_LAYER_ZINDEX,f.MAX_LAYER_ZINDEX-e.length),a.debug(`[GeoLeaf.GeoJSON] zIndex auto-assign\xe9 pour ${t}: ${v}`)}else{const e=d.validateZIndex(v);e!==n.zIndex&&a.warn(`[GeoLeaf.GeoJSON] zIndex ${n.zIndex} clamped to ${e} pour ${t}`),v=e}n.zIndex=v;const C=GeoLeaf.Config,S=C&&C.get?C.get("data"):null,I=`${S&&S.profilesBasePath||"profiles"}/${n._profileId}/${n._layerDirectory}`,P={id:t,label:o,layer:g,visible:1,config:n,clusterGroup:m,legendsConfig:n.legends,basePath:I,useSharedCluster:b,geojson:u,features:Array.isArray(u.features)?u.features:[],geometryType:n.geometryType||_,_visibility:{current:0,logicalState:0,source:"system",userOverride:0,themeOverride:0,themeDesired:null,zoomConstrained:0}};if(i.layers.set(t,P),i.featureCache.set(t,{features:P.features,geometryType:P.geometryType}),GeoLeaf.ThemeCache&&"function"==typeof GeoLeaf.ThemeCache.store){const e=n._profileId||(GeoLeaf.Config&&GeoLeaf.Config.getActiveProfileId?GeoLeaf.Config.getActiveProfileId():null);GeoLeaf.ThemeCache.store(t,e,u,{contentLength:n.contentLength})}if(GeoLeaf._GeoJSONLayerManager&&GeoLeaf._GeoJSONLayerManager.updateLayerVisibilityByZoom(),P.visible=0,n.fitBoundsOnLoad&&!GeoLeaf.ThemeSelector&&g.getBounds().isValid()){const e={};"number"==typeof n.maxZoomOnFit&&(e.maxZoom=n.maxZoomOnFit),i.map.fitBounds(g.getBounds(),e)}return n.styles&&n.styles.default?GeoLeaf._GeoJSONLoader._loadDefaultStyle(t,n).then(e=>{if(e&&GeoLeaf._GeoJSONLayerManager){a.debug("[GeoLeaf.GeoJSON] Application du style par d\xe9faut pour:",t);const o=i.layers.get(t);o&&(o.currentStyle=e,a.debug("[GeoLeaf.GeoJSON] currentStyle stock\xe9 pour:",t)),GeoLeaf._GeoJSONLayerManager.setLayerStyle(t,e),GeoLeaf.Labels&&"function"==typeof GeoLeaf.Labels.initializeLayerLabels&&GeoLeaf.Labels.initializeLayerLabels(t),GeoLeaf._LabelButtonManager&&GeoLeaf._LabelButtonManager.syncImmediate(t)}}).catch(e=>{a.warn("[GeoLeaf.GeoJSON] Erreur chargement style par d\xe9faut:",t,e.message)}):(n.labels&&n.labels.enabled&&GeoLeaf.Labels&&"function"==typeof GeoLeaf.Labels.initializeLayerLabels&&GeoLeaf.Labels.initializeLayerLabels(t),GeoLeaf._LabelButtonManager&&GeoLeaf._LabelButtonManager.syncImmediate(t)),a.debug("[GeoLeaf.GeoJSON] Couche charg\xe9e avec succ\xe8s :",t,"("+g.getLayers().length+" features)"),{id:t,label:o,featureCount:g.getLayers().length}})}}(window)),Me||(Me=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=()=>GeoLeaf.Log||console;GeoLeaf._GeoJSONLoader=GeoLeaf._GeoJSONLoader||{},GeoLeaf._GeoJSONLoader.loadFromActiveProfile=function(e={}){const o=GeoLeaf._GeoJSONShared.state,n=t(),r=GeoLeaf.Config;if(!r||"function"!=typeof r.getActiveProfile)return n.warn("[GeoLeaf.GeoJSON] Module Config ou Config.getActiveProfile() non disponible ; chargement GeoJSON par profil impossible."),Promise.resolve([]);const i=r.getActiveProfile();if(!i||"object"!=typeof i)return n.warn("[GeoLeaf.GeoJSON] Aucun profil actif ou profil invalide ; aucun GeoJSON charg\xe9."),Promise.resolve([]);let a=[];if(Array.isArray(i.geojsonLayers))a=i.geojsonLayers;else if(i.geojson&&Array.isArray(i.geojson.layers))a=i.geojson.layers;else if(Array.isArray(i.layers))a=i.layers;else if(r.Profile&&"function"==typeof r.Profile.getActiveProfileLayersConfig){const e=r.Profile.getActiveProfileLayersConfig();Array.isArray(e)&&(a=e,n.info("[GeoLeaf.GeoJSON] Utilisation du syst\xe8me v3.0 - "+e.length+" couches d\xe9tect\xe9es"))}if(!a.length)return n.info("[GeoLeaf.GeoJSON] Aucun bloc geojsonLayers / geojson.layers / layers d\xe9fini dans le profil actif ; rien \xe0 charger."),Promise.resolve([]);a.length>50?n.warn("[GeoLeaf.GeoJSON] Beaucoup de couches GeoJSON d\xe9tect\xe9es ("+a.length+"). Cela peut affecter les performances."):a.length>20&&n.info("[GeoLeaf.GeoJSON] "+a.length+" couches GeoJSON d\xe9tect\xe9es. Profil riche d\xe9tect\xe9.");const l=e||{},s=this,c=a.map((e,t)=>async()=>{if(!e||"object"!=typeof e)return n.warn("[GeoLeaf.GeoJSON] Descripteur GeoJSON de profil invalide, ignor\xe9 :",{index:t,def:e}),null;if("boolean"==typeof e.active&&0==e.active)return n.debug("[GeoLeaf.GeoJSON] Couche d\xe9sactiv\xe9e (active: false), ignor\xe9e :",e.id||"(sans ID)"),null;const r=e._layerDirectory||null,a=e.url||(e.dataFile?s._resolveDataFilePath(e.dataFile,i,r):null);if(!a)return n.warn("[GeoLeaf.GeoJSON] Descripteur GeoJSON sans URL ou dataFile, ignor\xe9 :",{index:t,id:e.id,label:e.label}),null;const c={...e,url:a};c._profileId=i.id,c._layerDirectory=r,e.popup&&"object"==typeof e.popup&&(c.showPopup=0!=e.popup.enabled,e.popup.fields&&Array.isArray(e.popup.fields)&&(c.popupFields=e.popup.fields),c.popup=e.popup),e.tooltip&&"object"==typeof e.tooltip&&(c.showTooltip=0!=e.tooltip.enabled,e.tooltip.fields&&Array.isArray(e.tooltip.fields)&&(c.tooltipFields=e.tooltip.fields),e.tooltip.mode&&(c.tooltipMode=e.tooltip.mode),c.tooltip=e.tooltip),e.sidepanel&&"object"==typeof e.sidepanel&&(e.sidepanel.detailLayout&&Array.isArray(e.sidepanel.detailLayout)&&(c.sidepanelFields=e.sidepanel.detailLayout),c.sidepanel=e.sidepanel),e.clustering&&"object"==typeof e.clustering&&(c.clustering=0!=e.clustering.enabled,"number"==typeof e.clustering.maxClusterRadius&&(c.maxClusterRadius=e.clustering.maxClusterRadius,c.clusterRadius=e.clustering.maxClusterRadius),"number"==typeof e.clustering.disableClusteringAtZoom&&(c.disableClusteringAtZoom=e.clustering.disableClusteringAtZoom)),e.search&&"object"==typeof e.search&&(c.search=e.search),e.table&&"object"==typeof e.table&&(c.table=e.table);const u=e.id||"geojson-layer-"+o.layerIdCounter++,d=e.label||u;n.debug("[GeoLeaf.GeoJSON] Chargement couche GeoJSON :",{profileId:i.id||"(inconnu)",layerId:u,url:a});try{return await GeoLeaf._GeoJSONLoader._loadSingleLayer(u,d,c,l)}catch(e){return n.error("[GeoLeaf.GeoJSON] \xc9chec chargement couche :",{layerId:u,url:a,error:e}),null}});return this._loadLayersByBatch(c,3,200).then(e=>{const t=e.filter(Boolean);if(n.info("[GeoLeaf.GeoJSON] "+t.length+" couche(s) GeoJSON charg\xe9e(s)"),n.info(`[GeoLeaf.GeoJSON] Avant v\xe9rif LayerManager - loadedLayers: ${t.length}, _GeoJSONLayerManager existe: ${!!GeoLeaf._GeoJSONLayerManager}`),t.length>0&&GeoLeaf._GeoJSONLayerManager&&GeoLeaf._GeoJSONLayerManager.registerWithLayerManager(),0!=l.fitBoundsOnLoad&&o.map&&o.layerGroup){const e=o.layerGroup.getBounds();if(e.isValid()){const t={};"number"==typeof l.maxZoomOnFit&&(t.maxZoom=l.maxZoomOnFit),o.map.fitBounds(e,t),n.debug("[GeoLeaf.GeoJSON] Carte ajust\xe9e sur l'emprise des couches GeoJSON");const r=function(){o.map.off("moveend",r);try{const t=new CustomEvent("geoleaf:fitbounds:complete",{detail:{bounds:e}});document.dispatchEvent(t)}catch(e){}};o.map.on("moveend",r)}}try{o.map.fire("geoleaf:geojson:layers-loaded",{count:t.length,layers:t.map(e=>({id:e.id,label:e.label}))})}catch(e){}return t})},GeoLeaf._GeoJSONLoader._loadLayersByBatch=async function(e,o=3){const n=[];for(let r=0;r<e.length;r+=o){const i=e.slice(r,r+o),a=Date.now(),l=await Promise.all(i.map(e=>e()));n.push(...l);const s=Date.now()-a;t().info(`[GeoLeaf.GeoJSON] Lot ${Math.floor(r/o)+1}/${Math.ceil(e.length/o)} charg\xe9 en ${s} ms`)}return n},GeoLeaf._GeoJSONLoader.loadAllLayersConfigsForLayerManager=async function(e){const o=t();if(!e||!e.layers||!Array.isArray(e.layers))return o.warn("[GeoLeaf.GeoJSON] loadAllLayersConfigsForLayerManager: Pas de couches dans le profil"),[];o.info(`[GeoLeaf.GeoJSON] Pr\xe9paration de ${e.layers.length} configurations de couches pour LayerManager...`);const n=e.layers.map(e=>{let t=null,o=null;return e.config&&e.config.styles?t=e.config.styles:e.styles&&(t=e.styles),e.config&&e.config.labels?o=e.config.labels:e.labels&&(o=e.labels),{id:e.id,label:e.label,layerManagerId:e.layerManagerId||"geojson-default",configFile:e.configFile,zIndex:e.config&&e.config.zIndex||0,themes:e.config&&e.config.themes||null,styles:t,labels:o}});return o.info(`[GeoLeaf.GeoJSON] ${n.length} configurations pr\xeates pour LayerManager`),GeoLeaf._allLayerConfigs=n,n}}(window)),xe||(xe=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log||console,o=()=>GeoLeaf._GeoJSONShared,n=()=>GeoLeaf._GeoJSONShared&&GeoLeaf._GeoJSONShared.state,r=()=>GeoLeaf._GeoJSONStyleResolver,i=()=>GeoLeaf._GeoJSONLayerManager,a=()=>GeoLeaf._GeoJSONLoader,l=()=>GeoLeaf._GeoJSONClustering,s={get _map(){return n()?n().map:null},get _layerGroup(){return n()?n().layerGroup:null},get _geoJsonLayer(){return n()?n().geoJsonLayer:null},get _layers(){return n()?n().layers:new Map},get _featureCache(){return n()?n().featureCache:new Map},get _options(){return n()?n().options:{}},_validateOptions:e=>(e.map&&"function"!=typeof e.map.addLayer&&t.warn("[GeoLeaf.GeoJSON] options.map ne semble pas \xeatre une carte Leaflet valide."),e.defaultStyle&&"object"!=typeof e.defaultStyle&&(t.warn("[GeoLeaf.GeoJSON] options.defaultStyle doit \xeatre un objet."),delete e.defaultStyle),e.onEachFeature&&"function"!=typeof e.onEachFeature&&(t.warn("[GeoLeaf.GeoJSON] options.onEachFeature doit \xeatre une fonction."),delete e.onEachFeature),e.pointToLayer&&"function"!=typeof e.pointToLayer&&(t.warn("[GeoLeaf.GeoJSON] options.pointToLayer doit \xeatre une fonction."),delete e.pointToLayer),void 0!==e.maxZoomOnFit&&("number"!=typeof e.maxZoomOnFit||e.maxZoomOnFit<1||e.maxZoomOnFit>20)&&(t.warn("[GeoLeaf.GeoJSON] options.maxZoomOnFit doit \xeatre un nombre entre 1 et 20."),e.maxZoomOnFit=GeoLeaf.CONSTANTS?GeoLeaf.CONSTANTS.GEOJSON_MAX_ZOOM_ON_FIT:18),e),init(a={}){const l=n();if(!l)return t.error("[GeoLeaf.GeoJSON] Module shared.js non charg\xe9."),null;if(a=this._validateOptions(a),void 0===e.L||!e.L||"function"!=typeof e.L.geoJSON)return t.error("[GeoLeaf.GeoJSON] Leaflet (L) est requis mais introuvable."),null;const s=GeoLeaf.Utils?GeoLeaf.Utils.ensureMap(a.map):a.map||null;if(!s)return t.error("[GeoLeaf.GeoJSON] Aucune carte Leaflet disponible. Passe une instance de carte dans init({ map })."),null;l.map=s,l.options=GeoLeaf.Utils&&GeoLeaf.Utils.mergeOptions?GeoLeaf.Utils.mergeOptions(l.options,a):Object.assign({},l.options,a);const c=o().PANE_CONFIG,u=o().PaneHelpers;l.map.createPane(c.BASEMAP_NAME).style.zIndex=c.BASEMAP_ZINDEX;for(let e=c.MIN_LAYER_ZINDEX;e<=c.MAX_LAYER_ZINDEX;e++)l.map.createPane(u.getPaneName(e)).style.zIndex=c.LAYER_BASE_ZINDEX+e;t.info(`[GeoLeaf.GeoJSON] Panes cr\xe9\xe9s : ${c.BASEMAP_NAME} (z:${c.BASEMAP_ZINDEX}), ${c.LAYER_PREFIX}0 \xe0 ${c.LAYER_PREFIX}${c.MAX_LAYER_ZINDEX} (z:${c.LAYER_BASE_ZINDEX}-${c.LAYER_BASE_ZINDEX+c.MAX_LAYER_ZINDEX})`),l.layerGroup=e.L.featureGroup().addTo(l.map),l.layers=new Map;const d=i();d&&l.map.on("zoomend",()=>{d.updateLayerVisibilityByZoom()});const f=r(),p=f?f.buildLeafletOptions(l.options):{};return l.geoJsonLayer=e.L.geoJSON(null,p),l.geoJsonLayer.addTo(l.layerGroup),t.info("[GeoLeaf.GeoJSON] Module initialis\xe9 en mode multi-couches"),l.geoJsonLayer},getLayer(){const e=n();return e?e.geoJsonLayer:null},getLayerById(e){const t=i();return t?t.getLayerById(e):null},getLayerData(e){const t=i();return t?t.getLayerData(e):null},getAllLayers(){const e=i();return e?e.getAllLayers():[]},showLayer(e){const t=i();t&&t.showLayer(e)},hideLayer(e){const t=i();t&&t.hideLayer(e)},toggleLayer(e){const t=i();t&&t.toggleLayer(e)},removeLayer(e){const t=i();t&&t.removeLayer(e)},updateLayerZIndex(e,t){const o=i();return o?o.updateLayerZIndex(e,t):0},setLayerStyle(e,t){const o=i();return o?o.setLayerStyle(e,t):0},loadUrl(e,t={}){const o=a();return o?o.loadUrl(e,t):Promise.resolve(null)},addData(e,t={}){const o=a();o&&o.addData(e,t)},loadFromActiveProfile(e={}){const t=a();return t?t.loadFromActiveProfile(e):Promise.resolve([])},filterFeatures(e,o={}){const r=n();if("function"!=typeof e)return t.warn("[GeoLeaf.GeoJSON] filterFeatures: filterFn doit \xeatre une fonction"),{filtered:0,total:0,visible:0};const i={filtered:0,total:0,visible:0};let a=[];if(a=o.layerIds?Array.isArray(o.layerIds)?o.layerIds:[o.layerIds]:Array.from(r.layers.keys()),o.geometryType){const e=o.geometryType.toLowerCase(),t={poi:"point",route:"line",linestring:"line",area:"polygon"},n=t[e]||e;a=a.filter(e=>{const o=r.layers.get(e);if(!o)return 0;const i=(o.geometryType||"").toLowerCase();return(t[i]||i)===n})}return a.forEach(t=>{const o=r.layers.get(t);if(!o||!o.layer)return;const n=0==o.config?.search?.enabled;o._filteredOutLayers||(o._filteredOutLayers=new Set);const a=[],l=[];o.layer.eachLayer(o=>{o.feature&&(i.total++,n||e(o.feature,t)?(a.push(o),i.visible++):(l.push(o),i.filtered++))});const s=o.clusterGroup;l.forEach(e=>{if(e._geoleafFiltered=1,s)o._filteredOutLayers.has(e)||(s.removeLayer(e),o._filteredOutLayers.add(e));else if(e.getElement){const t=e.getElement();t&&(t.style.display="none")}else e.setStyle&&(void 0===e.options._originalOpacity&&(e.options._originalOpacity=e.options.opacity,e.options._originalFillOpacity=e.options.fillOpacity),e.setStyle({opacity:0,fillOpacity:0}))}),a.forEach(e=>{if(e._geoleafFiltered=0,s)o._filteredOutLayers.has(e)&&(s.addLayer(e),o._filteredOutLayers.delete(e));else if(e.getElement){const t=e.getElement();t&&(t.style.display="")}else e.setStyle&&e.setStyle({opacity:void 0!==e.options._originalOpacity?e.options._originalOpacity:1,fillOpacity:void 0!==e.options._originalFillOpacity?e.options._originalFillOpacity:.4})})}),t.debug(`[GeoLeaf.GeoJSON] filterFeatures: ${i.visible}/${i.total} features visibles`),i},clearFeatureFilter(e={}){return this.filterFeatures(()=>1,e)},getFeatures(e={}){const t=n();if(!t)return[];const o=Array.isArray(e.geometryTypes)?new Set(e.geometryTypes.map(e=>e.toLowerCase())):null,r=Array.isArray(e.layerIds)?new Set(e.layerIds):null,i=[];return t.featureCache.forEach((e,t)=>{if(r&&!r.has(t))return;const n=(e.geometryType||"").toLowerCase();o&&!o.has(n)||(e.features||[]).forEach(e=>{if(e&&"object"==typeof e){const o=Object.assign({},e,{_layerId:t});i.push(o)}})}),i},clear(){const e=n();e&&e.geoJsonLayer&&e.geoJsonLayer.clearLayers()},_updateLayerVisibilityByZoom(){const e=i();e&&e.updateLayerVisibilityByZoom()},_registerWithLayerManager(){const e=i();e&&e.registerWithLayerManager()},_convertFeatureToPOI(e,t){const o=GeoLeaf._GeoJSONPopupTooltip;return o?o.convertFeatureToPOI(e,t):null},_getClusteringStrategy(e,t){const o=l();return o?o.getClusteringStrategy(e,t):{shouldCluster:0,useSharedCluster:0}},_getSharedPOICluster(){const e=l();return e?e.getSharedPOICluster():null},_getPoiConfig(){const e=l();return e?e.getPoiConfig():{}},_detectLayerType(e){const t=i();return t?t.detectLayerType(e):"mixed"},_buildLeafletOptions(e){const t=r();return t?t.buildLeafletOptions(e):{}}};!GeoLeaf._StyleRules&&r()&&(GeoLeaf._StyleRules={evaluate:r().evaluateStyleRules,operators:o()?o().STYLE_OPERATORS:{},getNestedValue:r().getNestedValue}),GeoLeaf.GeoJSON=s}(window)),Ne||(Ne=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log||console;GeoLeaf._GeoJSONShared&&GeoLeaf.GeoJSON?t.debug("[GeoLeaf.GeoJSON] Sous-modules d\xe9j\xe0 charg\xe9s, agr\xe9gateur legacy ignor\xe9."):(t.warn("[GeoLeaf.GeoJSON] Les sous-modules geojson/*.js ne sont pas charg\xe9s. Veuillez mettre \xe0 jour demo/index.html pour charger les nouveaux modules."),GeoLeaf.GeoJSON||(GeoLeaf.GeoJSON={init:()=>(t.error("[GeoLeaf.GeoJSON] Module non initialis\xe9. Chargez les sous-modules geojson/*.js avant d'appeler init()."),null),loadUrl:()=>(t.error("[GeoLeaf.GeoJSON] Module non initialis\xe9."),Promise.resolve(null)),loadFromActiveProfile:()=>(t.error("[GeoLeaf.GeoJSON] Module non initialis\xe9."),Promise.resolve([])),addData(){t.error("[GeoLeaf.GeoJSON] Module non initialis\xe9.")},getLayer:()=>null,getAllLayers:()=>[],getFeatures:()=>[],filterFeatures:()=>({filtered:0,total:0,visible:0}),clear(){}}))}(window)),Fe||(Fe=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{};GeoLeaf._RouteStyleResolver=GeoLeaf._RouteStyleResolver||{};const t=GeoLeaf.Log||console;GeoLeaf._RouteStyleResolver.getRouteColor=function(e,t,o){if(!e||!e.attributes)return o?.color||null;const n=e.attributes,r=n.categoryId,i=n.subCategoryId,a=t?.taxonomy?.categories||{};if(r&&i){const e=a[r];if(e&&e.subcategories){const t=e.subcategories[i];if(t&&t.colorRoute)return t.colorRoute}}if(r){const e=a[r];if(e&&e.colorRoute)return e.colorRoute}return o?.color||null},GeoLeaf._RouteStyleResolver.resolveRouteStyle=function(e,t,o,n){const r=Object.assign({},n||{});o&&"object"==typeof o&&Object.assign(r,o);const i=GeoLeaf._RouteStyleResolver.getRouteColor(e,t,o);if(i&&(r.color=i),e.properties&&"object"==typeof e.properties){const t=e.properties;"string"==typeof t.color&&""!==t.color.trim()&&(r.color=t.color.trim()),"number"==typeof t.weight&&(r.weight=t.weight),"number"==typeof t.opacity&&(r.opacity=t.opacity),"string"==typeof t.dashArray&&""!==t.dashArray.trim()&&(r.dashArray=t.dashArray.trim())}return r},GeoLeaf._RouteStyleResolver.resolveEndpointConfig=function(e,t,o){const n=o||{},r=n.startWaypointStyle||n.waypointStyle||{radius:6,color:"#ffffff",fillColor:"#2b7cff",fillOpacity:1,weight:2},i=n.endWaypointStyle||n.waypointStyle||{radius:6,color:"#ffffff",fillColor:"#ff7b32",fillOpacity:1,weight:2},a={showStart:"boolean"==typeof n.showStart?n.showStart:1,showEnd:"boolean"==typeof n.showEnd?n.showEnd:1,startStyle:Object.assign({},r),endStyle:Object.assign({},i)};if(t&&"object"==typeof t&&("boolean"==typeof t.showStart&&(a.showStart=t.showStart),"boolean"==typeof t.showEnd&&(a.showEnd=t.showEnd),t.start&&"object"==typeof t.start&&Object.assign(a.startStyle,t.start),t.end&&"object"==typeof t.end&&Object.assign(a.endStyle,t.end)),e&&e.properties&&"object"==typeof e.properties){const t=e.properties;"boolean"==typeof t.showStart&&(a.showStart=t.showStart),"boolean"==typeof t.showEnd&&(a.showEnd=t.showEnd),t.startStyle&&"object"==typeof t.startStyle&&Object.assign(a.startStyle,t.startStyle),t.endStyle&&"object"==typeof t.endStyle&&Object.assign(a.endStyle,t.endStyle)}return a},t.info("[GeoLeaf._RouteStyleResolver] Module Style Resolver charg\xe9")}(window)),Ue||(Ue=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{};GeoLeaf._RoutePopupBuilder=GeoLeaf._RoutePopupBuilder||{};const t=GeoLeaf.Log||console;function o(e){if(GeoLeaf.Security&&"function"==typeof GeoLeaf.Security.escapeHtml)return GeoLeaf.Security.escapeHtml(e);if(null==e)return"";const t=document.createElement("div");return t.textContent=String(e),t.innerHTML}GeoLeaf._RoutePopupBuilder.addRouteTooltip=function(e,t){const n=t.label||t.name||"Itin\xe9raire";e.bindTooltip(o(n),{sticky:1,className:"gl-route-tooltip"})},GeoLeaf._RoutePopupBuilder.addRoutePopup=function(e,o){const n=GeoLeaf._RoutePopupBuilder.buildRoutePopupContent(o);e.bindPopup(n,{maxWidth:300}),e.on("popupopen",()=>{t.info&&t.info("[Route Popup] Popup opened for route:",o.id),setTimeout(()=>{const e='.gl-poi-popup__link[data-route-id="'+o.id+'"]',t=document.querySelector(e);t&&t.addEventListener("click",e=>{e.preventDefault(),GeoLeaf._RoutePopupBuilder.openRouteSidePanel(o)})},50)})},GeoLeaf._RoutePopupBuilder.buildRoutePopupContent=function(e){const t=GeoLeaf._ContentBuilder||null,n=function(){const e=GeoLeaf.Config;if(e&&"function"==typeof e.getActiveProfile){const t=e.getActiveProfile();if(t?.panels?.route?.popup?.detailPopup)return t.panels.route.popup.detailPopup}return null}(),r=function(e){const t=GeoLeaf._Normalizer||null;if(t&&"function"==typeof t.normalizeFromRoute)return t.normalizeFromRoute(e);const o=e.attributes||{};return{id:e.id,sourceType:"route",geometryType:"LineString",title:e.label||e.name||"Itin\xe9raire",description:o.description||e.description||"",lat:null,lng:null,categoryId:o.categoryId||null,subCategoryId:o.subCategoryId||null,attributes:{...o,label:e.label||e.name,photo:o.photo,distance_km:o.distance_km,duration_min:o.duration_min,difficulty:o.difficulty,tags:o.tags},rawData:e}}(e);return t&&"function"==typeof t.buildPopupHTML&&n?t.buildPopupHTML(r,n,{resolveCategoryDisplay:null}):function(e){const t=e.attributes||{},n=o(e.label||e.name||"Itin\xe9raire"),r=o(t.description||e.description||""),i=t.photo||e.photo||null,a=o(String(e.id||"")),l=t.categoryId||null,s=t.subCategoryId||null,c=GeoLeaf.Config&&"function"==typeof GeoLeaf.Config.getActiveProfile&&GeoLeaf.Config.getActiveProfile()||{},u=l?(c?.taxonomy?.categories||{})[l]:null,d=u&&s?u.subcategories?.[s]:null,f=d?.icon||u?.icon||c?.icons?.defaultIcon||"activity-generic";let p="";p='<svg class="gl-poi-popup__icon" aria-hidden="true" focusable="false" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="'+(d?.colorFill||u?.colorFill||"#666666")+'" stroke="'+(d?.colorStroke||u?.colorStroke||"#222222")+'" stroke-width="1.5"/><svg x="4" y="4" width="16" height="16"><use href="#'+((c?.icons?.symbolPrefix||"gl-poi-cat-")+String(f).trim().toLowerCase().replace(/\s+/g,"-"))+'" style="color: #ffffff"/></svg></svg>';let g="";const y=[];if(t.distance_km&&y.push("\u{1f4cf} "+t.distance_km+" km"),t.duration_min&&y.push("\u23f1\ufe0f "+t.duration_min+" min"),t.difficulty){const e={easy:"Facile",medium:"Moyen",hard:"Difficile"};y.push("\u26a1 "+(e[t.difficulty]||t.difficulty))}y.length>0&&(g='<p class="gl-poi-popup__meta-text">'+y.join(" \u2022 ")+"</p>");const h=[];return Array.isArray(t.tags)&&t.tags.forEach(e=>{e&&"string"==typeof e&&h.push('<span class="gl-poi-badge gl-poi-badge--tag">'+o(e)+"</span>")}),'<div class="gl-poi-popup">'+(i?'<div class="gl-poi-popup__photo"><img src="'+i+'" alt="'+n+'" /></div>':"")+'<div class="gl-poi-popup__body"><div class="gl-poi-popup__title-wrapper"><h3 class="gl-poi-popup__title">'+p+'<span class="gl-poi-popup__title-text">'+n+"</span></h3></div>"+(r?'<p class="gl-poi-popup__desc">'+r+"</p>":"")+g+(h.length?'<div class="gl-poi-popup__badges">'+h.join("")+"</div>":"")+'<a class="gl-poi-popup__link" href="#" data-route-id="'+a+'">Voir plus >>></a></div></div>'}(e)},GeoLeaf._RoutePopupBuilder.openRouteSidePanel=function(e){if(!GeoLeaf.POI||"function"!=typeof GeoLeaf.POI.openSidePanelWithLayout)return void(t.warn&&t.warn("[Route Popup] Cannot open side panel: POI.openSidePanelWithLayout not available"));const o=e.attributes||{},n=function(){const e=GeoLeaf.Config;if(e&&"function"==typeof e.getActiveProfile){const t=e.getActiveProfile();if(t?.panels?.route?.layout)return t.panels.route.layout}return null}(),r=[];if(o.distance_km&&r.push("\u{1f4cf} Distance : "+o.distance_km+" km"),o.duration_min&&r.push("\u23f1\ufe0f Dur\xe9e : "+o.duration_min+" minutes"),o.difficulty){const e={easy:"Facile",medium:"Moyen",hard:"Difficile"};r.push("\u26a1 Difficult\xe9 : "+(e[o.difficulty]||o.difficulty))}const i={id:e.id,label:e.label||e.name,title:e.label||e.name,name:e.label||e.name,description:o.description||e.description,attributes:{...o,metadata:r.length>0?r:null,photo:o.photo,mainImage:o.photo,description:o.description,shortDescription:o.description,description_long:o.description_long,longDescription:o.description_long,categoryId:o.categoryId,subCategoryId:o.subCategoryId,difficulty:o.difficulty,distance_km:o.distance_km,duration_min:o.duration_min,tags:o.tags,link:o.link}};GeoLeaf.POI.openSidePanelWithLayout(i,n)},t.info&&t.info("[GeoLeaf._RoutePopupBuilder] Module Popup Builder charg\xe9 (v2.0.0)")}("undefined"!=typeof window?window:gt)),ke||(ke=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{};GeoLeaf._RouteLoaders=GeoLeaf._RouteLoaders||{};const t=GeoLeaf.Log||console;GeoLeaf._RouteLoaders.loadGPX=async function(e,o){if(e)try{const t=await fetch(e),n=await t.text(),r=(new DOMParser).parseFromString(n,"application/xml"),i=Array.from(r.getElementsByTagName("trkpt")).map(e=>[parseFloat(e.getAttribute("lat")||"0"),parseFloat(e.getAttribute("lon")||"0")]);"function"==typeof o&&o(i)}catch(e){t.error("[GeoLeaf.Route] Erreur GPX :",e)}else t.warn("[GeoLeaf.Route] URL GPX manquante.")},GeoLeaf._RouteLoaders.loadGeoJSON=function(e,o){if(!e||!e.type)return void t.error("[GeoLeaf.Route] GeoJSON invalide.");let n=[];"Feature"===e.type&&"LineString"===e.geometry.type?n=e.geometry.coordinates.map(e=>[e[1],e[0]]):"LineString"===e.type?n=e.coordinates.map(e=>[e[1],e[0]]):t.warn("[GeoLeaf.Route] Format GeoJSON non g\xe9r\xe9."),"function"==typeof o&&o(n)},GeoLeaf._RouteLoaders.extractCoordsFromRouteItem=function(e){if(Array.isArray(e.geometry)&&e.geometry.length>0){if(Array.isArray(e.geometry[0])&&"number"==typeof e.geometry[0][0]&&"number"==typeof e.geometry[0][1])return e.geometry.map(e=>[e[0],e[1]]);if(e.geometry[0]&&"object"==typeof e.geometry[0]&&"LineString"===e.geometry[0].type&&Array.isArray(e.geometry[0].coordinates))return e.geometry[0].coordinates.map(e=>[e[1],e[0]])}if(e.geometry&&"object"==typeof e.geometry&&"LineString"===e.geometry.type&&Array.isArray(e.geometry.coordinates)&&e.geometry.coordinates.length>0)return e.geometry.coordinates.map(e=>[e[1],e[0]]);if(e.geometry&&"object"==typeof e.geometry&&"MultiLineString"===e.geometry.type&&Array.isArray(e.geometry.coordinates)&&e.geometry.coordinates.length>0){const t=e.geometry.coordinates.reduce((e,t)=>Array.isArray(t)&&t.length>0?e.concat(t.map(e=>[e[1],e[0]])):e,[]);if(t.length>0)return t}return[]},t.info("[GeoLeaf._RouteLoaders] Module Loaders charg\xe9")}(window)),Re||(Re=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{};GeoLeaf._RouteLayerManager=GeoLeaf._RouteLayerManager||{};const t=GeoLeaf.Log||console;GeoLeaf._RouteLayerManager.applyRoute=function(t,o,n,r){if(Array.isArray(o)||(o=[]),"function"==typeof n&&n(),!t.routeLayer&&t.layerGroup&&t.map){const o=GeoLeaf.Config.get("ui.interactiveShapes",0),n=Object.assign({},t.options.lineStyle,{interactive:o});t.routeLayer=e.L.polyline([],n).addTo(t.layerGroup)}if(t.routeLayer&&t.routeLayer.setLatLngs(o),t.options.fitBoundsOnLoad&&o.length>1&&t.map){const e=t.routeLayer.getBounds(),o={};t.options.maxZoomOnFit&&(o.maxZoom=t.options.maxZoomOnFit),t.map.fitBounds(e,o)}"function"==typeof r&&r(o)},GeoLeaf._RouteLayerManager.addWaypoint=function(t,o,n){if(!t)return;const r=GeoLeaf.Config.get("ui.interactiveShapes",0),i=Object.assign({},n,{interactive:r});e.L.circleMarker(o,i).addTo(t)},GeoLeaf._RouteLayerManager.addSegment=function(e,t){if(!e)return;const o=e.getLatLngs();e.setLatLngs([...o,...t])},GeoLeaf._RouteLayerManager.fireRouteLoadedEvents=function(e,o,n){try{e&&"function"==typeof e.fire&&e.fire("geoleaf:route:loaded",{coords:n,layer:o,source:"geoleaf.route"})}catch(e){t.warn("[GeoLeaf.Route] Impossible d'\xe9mettre l'\xe9v\xe9nement Leaflet geoleaf:route:loaded.",e)}if("undefined"!=typeof document&&"function"==typeof document.dispatchEvent){const r={coords:Array.isArray(n)?n.slice():[],map:e,layer:o,source:"geoleaf.route"};try{if("function"==typeof CustomEvent){const e=new CustomEvent("geoleaf:route:loaded",{detail:r});document.dispatchEvent(e)}else{const e=document.createEvent("CustomEvent");e.initCustomEvent("geoleaf:route:loaded",1,1,r),document.dispatchEvent(e)}}catch(e){t.warn("[GeoLeaf.Route] Impossible d'\xe9mettre le CustomEvent geoleaf:route:loaded.",e)}}},t.info("[GeoLeaf._RouteLayerManager] Module Layer Manager charg\xe9")}(window)),De||(De=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log||console,o={_map:null,_layerGroup:null,_routeLayer:null,_initialized:0,_visible:1,_options:{lineStyle:{color:"#1E88E5",weight:4,opacity:.9,interactive:0},waypointStyle:{radius:5,color:"#0D47A1",fillColor:"#42A5F5",fillOpacity:.9,weight:2},showStart:1,showEnd:1,startWaypointStyle:null,endWaypointStyle:null,fitBoundsOnLoad:1,maxZoomOnFit:14},_validateOptions:e=>(e.map&&"function"!=typeof e.map.addLayer&&t.warn("[GeoLeaf.Route] options.map ne semble pas \xeatre une carte Leaflet valide."),e.lineStyle&&"object"!=typeof e.lineStyle&&(t.warn("[GeoLeaf.Route] options.lineStyle doit \xeatre un objet."),delete e.lineStyle),e.waypointStyle&&"object"!=typeof e.waypointStyle&&(t.warn("[GeoLeaf.Route] options.waypointStyle doit \xeatre un objet."),delete e.waypointStyle),void 0!==e.maxZoomOnFit&&("number"!=typeof e.maxZoomOnFit||e.maxZoomOnFit<1||e.maxZoomOnFit>20)&&(t.warn("[GeoLeaf.Route] options.maxZoomOnFit doit \xeatre entre 1 et 20."),e.maxZoomOnFit=14),e),getLayer(){return this._layerGroup||null},init(o={}){if(o=this._validateOptions(o),void 0===e.L)return t.error("[GeoLeaf.Route] Leaflet introuvable."),null;let n=o.map||null;if(!n&&GeoLeaf.Core&&"function"==typeof GeoLeaf.Core.getMap&&(n=GeoLeaf.Core.getMap()),GeoLeaf.Utils&&"function"==typeof GeoLeaf.Utils.ensureMap&&(n=GeoLeaf.Utils.ensureMap(n)),!n)return t.error("[GeoLeaf.Route] Aucune carte disponible pour init()."),null;this._map=n,GeoLeaf.Utils&&"function"==typeof GeoLeaf.Utils.mergeOptions?this._options=GeoLeaf.Utils.mergeOptions(this._options,o):this._options=Object.assign({},this._options,o);const r=GeoLeaf.Config.get("ui.interactiveShapes",0);return this._options.lineStyle&&(this._options.lineStyle.interactive=r),this._layerGroup=e.L.layerGroup().addTo(this._map),this._routeLayer=e.L.polyline([],this._options.lineStyle).addTo(this._layerGroup),this._initialized=1,this._visible=1,this._layerGroup},isInitialized(){return 1==this._initialized&&!!this._map&&!!this._layerGroup},isVisible(){return 1==this._visible},show(){this._map&&this._layerGroup&&(this._map.hasLayer(this._layerGroup)||this._layerGroup.addTo(this._map),this._visible=1)},hide(){this._map&&this._layerGroup&&(this._map.hasLayer(this._layerGroup)&&this._map.removeLayer(this._layerGroup),this._visible=0)},toggleVisibility(){this.isInitialized()?this.isVisible()?this.hide():this.show():t.warn("[GeoLeaf.Route] toggleVisibility() appel\xe9 sans init().")},clear(){this._layerGroup&&this._layerGroup.clearLayers(),this._map&&this._layerGroup?this._routeLayer=e.L.polyline([],this._options.lineStyle).addTo(this._layerGroup):this._routeLayer=null},loadGPX(e){if(!e)return t.warn("[GeoLeaf.Route] URL GPX manquante."),Promise.resolve();const o=GeoLeaf.Utils?.FetchHelper;return o?o.fetch(e,{timeout:15e3,retries:2,parseResponse:0}).then(e=>e.text()).then(e=>(new DOMParser).parseFromString(e,"application/xml")).then(e=>{const t=Array.from(e.getElementsByTagName("trkpt")).map(e=>[parseFloat(e.getAttribute("lat")||"0"),parseFloat(e.getAttribute("lon")||"0")]);this._applyRoute(t)}).catch(e=>t.error("[GeoLeaf.Route] Erreur GPX :",e)):fetch(e).then(e=>e.text()).then(e=>(new DOMParser).parseFromString(e,"application/xml")).then(e=>{const t=Array.from(e.getElementsByTagName("trkpt")).map(e=>[parseFloat(e.getAttribute("lat")||"0"),parseFloat(e.getAttribute("lon")||"0")]);this._applyRoute(t)}).catch(e=>t.error("[GeoLeaf.Route] Erreur GPX :",e))},loadGeoJSON(e){GeoLeaf._RouteLoaders&&"function"==typeof GeoLeaf._RouteLoaders.loadGeoJSON?GeoLeaf._RouteLoaders.loadGeoJSON(e,this._applyRoute.bind(this)):t.error("[GeoLeaf.Route.loadGeoJSON] GeoLeaf._RouteLoaders.loadGeoJSON() non disponible.")},loadFromConfig(o){if(!this.isInitialized())return void t.warn("[GeoLeaf.Route] loadFromConfig() appel\xe9 alors que le module n'est pas initialis\xe9.");if(!Array.isArray(o)||0===o.length)return this.clear(),void t.info("[GeoLeaf.Route] Aucun itin\xe9raire dans cfg.routes ; couche vid\xe9e.");this.clear();const n=[],r=this._options.lineStyle||{};let i=null,a=null,l=null;try{GeoLeaf.Config&&"function"==typeof GeoLeaf.Config.getActiveProfile&&(i=GeoLeaf.Config.getActiveProfile(),i&&i.defaultSettings&&i.defaultSettings.routeConfig&&(i.defaultSettings.routeConfig.default&&"object"==typeof i.defaultSettings.routeConfig.default&&!Array.isArray(i.defaultSettings.routeConfig.default)&&(a=i.defaultSettings.routeConfig.default),i.defaultSettings.routeConfig.endpoints&&"object"==typeof i.defaultSettings.routeConfig.endpoints&&!Array.isArray(i.defaultSettings.routeConfig.endpoints)&&(l=i.defaultSettings.routeConfig.endpoints)))}catch(e){t.warn("[GeoLeaf.Route] Impossible de lire la config/endpoints depuis le profil actif.",e)}if(o.forEach(t=>{if(!t||"object"!=typeof t)return;const o=this._extractCoordsFromRouteItem(t);if(!o||0===o.length)return;const s=this._resolveRouteStyle(t,i,a,r),c=GeoLeaf.Config.get("ui.interactiveShapes",0);s.interactive=c;const u=e.L.polyline(o,s).addTo(this._layerGroup);u._geoleafRouteData=t,this._addRouteTooltip(u,t),this._addRoutePopup(u,t),this._routeLayer||(this._routeLayer=u),n.push(...o);const d=this._resolveEndpointConfig(t,l,this._options);if(o.length>0){const t=o[0],n=o[o.length-1];if(d.showStart){const o=Object.assign({},d.startStyle,{interactive:c});e.L.circleMarker(t,o).addTo(this._layerGroup)}if(d.showEnd&&n&&(n[0]!==t[0]||n[1]!==t[1])){const t=Object.assign({},d.endStyle,{interactive:c});e.L.circleMarker(n,t).addTo(this._layerGroup)}}}),0!==n.length){if(this._options.fitBoundsOnLoad)try{const e=this._layerGroup.getBounds(),t={};this._options.maxZoomOnFit&&(t.maxZoom=this._options.maxZoomOnFit),this._map.fitBounds(e,t)}catch(e){t.warn("[GeoLeaf.Route] Erreur lors du fitBounds sur les itin\xe9raires :",e)}this._fireRouteLoadedEvents(n)}else t.warn("[GeoLeaf.Route] loadFromConfig() n'a trouv\xe9 aucun itin\xe9raire valide dans cfg.routes.")},filterVisibility:function(e){if(!this._initialized)return void t.warn("[GeoLeaf.Route] Module non initialis\xe9 - filterVisibility ignor\xe9.");if(!Array.isArray(e))return void t.warn("[GeoLeaf.Route] filterVisibility : filteredRoutes doit \xeatre un tableau.");const o=new Set(e.map(e=>e.id));this._layerGroup.eachLayer(function(e){const t=e.options&&e.options.routeId;void 0!==t&&(o.has(t)?this._map.hasLayer(e)||this._map.addLayer(e):this._map.hasLayer(e)&&this._map.removeLayer(e))}.bind(this)),t.info("[GeoLeaf.Route] Visibilit\xe9 filtr\xe9e : "+e.length+" routes visibles.")},_extractCoordsFromRouteItem:e=>GeoLeaf._RouteLoaders&&"function"==typeof GeoLeaf._RouteLoaders.extractCoordsFromRouteItem?GeoLeaf._RouteLoaders.extractCoordsFromRouteItem(e):(t.error("[GeoLeaf.Route._extractCoordsFromRouteItem] GeoLeaf._RouteLoaders.extractCoordsFromRouteItem() non disponible."),[]),_getRouteColor:(e,o,n)=>GeoLeaf._RouteStyleResolver&&"function"==typeof GeoLeaf._RouteStyleResolver.getRouteColor?GeoLeaf._RouteStyleResolver.getRouteColor(e,o,n):(t.error("[GeoLeaf.Route._getRouteColor] GeoLeaf._RouteStyleResolver.getRouteColor() non disponible."),n?.color||null),_resolveRouteStyle:(e,o,n,r)=>GeoLeaf._RouteStyleResolver&&"function"==typeof GeoLeaf._RouteStyleResolver.resolveRouteStyle?GeoLeaf._RouteStyleResolver.resolveRouteStyle(e,o,n,r):(t.error("[GeoLeaf.Route._resolveRouteStyle] GeoLeaf._RouteStyleResolver.resolveRouteStyle() non disponible."),Object.assign({},r||{})),_resolveEndpointConfig:(e,o,n)=>GeoLeaf._RouteStyleResolver&&"function"==typeof GeoLeaf._RouteStyleResolver.resolveEndpointConfig?GeoLeaf._RouteStyleResolver.resolveEndpointConfig(e,o,n):(t.error("[GeoLeaf.Route._resolveEndpointConfig] GeoLeaf._RouteStyleResolver.resolveEndpointConfig() non disponible."),{showStart:1,showEnd:1,startStyle:{radius:6,color:"#ffffff",fillColor:"#2b7cff",fillOpacity:1,weight:2},endStyle:{radius:6,color:"#ffffff",fillColor:"#ff7b32",fillOpacity:1,weight:2}}),addWaypoint(e){GeoLeaf._RouteLayerManager&&"function"==typeof GeoLeaf._RouteLayerManager.addWaypoint?GeoLeaf._RouteLayerManager.addWaypoint(this._layerGroup,e,this._options.waypointStyle):t.error("[GeoLeaf.Route.addWaypoint] GeoLeaf._RouteLayerManager.addWaypoint() non disponible.")},addSegment(e){if(!this._routeLayer)return;const t=this._routeLayer.getLatLngs();this._routeLayer.setLatLngs([...t,...e])},_applyRoute(e){if(!GeoLeaf._RouteLayerManager||"function"!=typeof GeoLeaf._RouteLayerManager.applyRoute)return void t.error("[GeoLeaf.Route._applyRoute] GeoLeaf._RouteLayerManager.applyRoute() non disponible.");const o={map:this._map,layerGroup:this._layerGroup,routeLayer:this._routeLayer,options:this._options};GeoLeaf._RouteLayerManager.applyRoute(o,e,this.clear.bind(this),this._fireRouteLoadedEvents.bind(this)),this._routeLayer=o.routeLayer},_addRouteTooltip(e,o){GeoLeaf._RoutePopupBuilder&&"function"==typeof GeoLeaf._RoutePopupBuilder.addRouteTooltip?GeoLeaf._RoutePopupBuilder.addRouteTooltip(e,o):t.error("[GeoLeaf.Route._addRouteTooltip] GeoLeaf._RoutePopupBuilder.addRouteTooltip() non disponible.")},_addRoutePopup(e,o){GeoLeaf._RoutePopupBuilder&&"function"==typeof GeoLeaf._RoutePopupBuilder.addRoutePopup?GeoLeaf._RoutePopupBuilder.addRoutePopup(e,o,this):t.error("[GeoLeaf.Route._addRoutePopup] GeoLeaf._RoutePopupBuilder.addRoutePopup() non disponible.")},_buildRoutePopupContent:e=>GeoLeaf._RoutePopupBuilder&&"function"==typeof GeoLeaf._RoutePopupBuilder.buildRoutePopupContent?GeoLeaf._RoutePopupBuilder.buildRoutePopupContent(e):(t.error("[GeoLeaf.Route._buildRoutePopupContent] GeoLeaf._RoutePopupBuilder.buildRoutePopupContent() non disponible."),"<div>Route popup non disponible</div>"),_openRouteSidePanel(e){GeoLeaf._RoutePopupBuilder&&"function"==typeof GeoLeaf._RoutePopupBuilder.openRouteSidePanel?GeoLeaf._RoutePopupBuilder.openRouteSidePanel(e):t.error("[GeoLeaf.Route._openRouteSidePanel] GeoLeaf._RoutePopupBuilder.openRouteSidePanel() non disponible.")},_fireRouteLoadedEvents(e){try{this._map&&"function"==typeof this._map.fire&&this._map.fire("geoleaf:route:loaded",{coords:e,layer:this._routeLayer,source:"geoleaf.route"})}catch(e){t.warn("[GeoLeaf.Route] Impossible d'\xe9mettre l'\xe9v\xe9nement Leaflet geoleaf:route:loaded.",e)}if("undefined"!=typeof document&&"function"==typeof document.dispatchEvent){const o={coords:Array.isArray(e)?e.slice():[],map:this._map,layer:this._routeLayer,source:"geoleaf.route"};try{if("function"==typeof CustomEvent){const e=new CustomEvent("geoleaf:route:loaded",{detail:o});document.dispatchEvent(e)}else{const e=document.createEvent("CustomEvent");e.initCustomEvent("geoleaf:route:loaded",1,1,o),document.dispatchEvent(e)}}catch(e){t.warn("[GeoLeaf.Route] Impossible d'\xe9mettre le CustomEvent geoleaf:route:loaded.",e)}}}};GeoLeaf.Route=o}(window)),Be||(Be=1,function(e){(e.GeoLeaf=e.GeoLeaf||{})._LayerManagerShared={map:null,control:null,options:{position:"bottomright",title:"L\xe9gende",collapsible:1,collapsed:0,sections:[]}}}(window)),$e||($e=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log,o={renderSections(o,n){if(o){if(GeoLeaf._UIComponents&&"function"==typeof GeoLeaf._UIComponents.clearElement)GeoLeaf._UIComponents.clearElement(o);else for(;o.firstChild;)o.removeChild(o.firstChild);Array.isArray(n)&&0!==n.length?(n.filter(e=>"poi"!==e.id&&"route"!==e.id).forEach(n=>{const r="boolean"==typeof n.collapsedByDefault,i=1==n.collapsedByDefault,a=e.L.DomUtil.create("div",r?"gl-layer-manager__section gl-layer-manager__section--accordion":"gl-layer-manager__section",o);if(i&&a.classList.add("gl-layer-manager__section--collapsed"),n.label)if(r){const o=e.L.DomUtil.create("div","gl-layer-manager__accordion-header",a);e.L.DomUtil.create("div","gl-layer-manager__section-title",o).textContent=n.label;const r=e.L.DomUtil.create("span","gl-layer-manager__accordion-arrow",o);r.textContent="\u25b6",e.L.DomEvent.on(o,"click",function(o){e.L.DomEvent.stopPropagation(o),e.L.DomEvent.preventDefault(o);const i=a.classList.contains("gl-layer-manager__section--collapsed");a.classList.toggle("gl-layer-manager__section--collapsed"),r.textContent=i?"\u25bc":"\u25b6",n._isExpanded=i,t&&t.debug("[LayerManager] Accord\xe9on",n.id,i?"ouvert":"ferm\xe9")})}else e.L.DomUtil.create("div","gl-layer-manager__section-title",a).textContent=n.label;if(!Array.isArray(n.items)||0===n.items.length)return;const l=r?e.L.DomUtil.create("div","gl-layer-manager__accordion-body",a):a;"basemap"===n.id?GeoLeaf._LayerManagerBasemapSelector&&GeoLeaf._LayerManagerBasemapSelector.render(n,l):this._renderItems(n,l)}),GeoLeaf._LabelButtonManager&&GeoLeaf._GeoJSONLayerManager&&(GeoLeaf._GeoJSONLayerManager._layers||new Map).forEach((e,t)=>{e.currentStyle&&GeoLeaf._LabelButtonManager.syncImmediate(t)})):GeoLeaf._UIComponents&&"function"==typeof GeoLeaf._UIComponents.createEmptyMessage?GeoLeaf._UIComponents.createEmptyMessage(o,"Aucune couche \xe0 afficher.","gl-layer-manager__empty"):e.L.DomUtil.create("div","gl-layer-manager__empty",o).textContent="Aucune couche \xe0 afficher."}},syncToggles(){const o=document.querySelectorAll("[data-layer-id]");t&&t.debug(`[LayerManager Renderer] Synchronisation de ${o.length} toggles`),o.forEach(o=>{const n=o.getAttribute("data-layer-id");if(!n)return;const r=e.GeoLeaf?.GeoJSON?.getLayerById(n),i=this._checkLayerVisibility(n);t&&t.debug(`[LayerManager Renderer] Couche ${n}:`,{isVisible:i,hasLayerData:!!r,hasVisibility:!(!r||!r._visibility),currentValue:r?._visibility?.current,onMap:r?.layer?e.GeoLeaf._GeoJSONShared?.state?.map?.hasLayer(r.layer):0}),i?o.classList.remove("gl-layer--hidden"):o.classList.add("gl-layer--hidden");const a=o.querySelector(".gl-layer-manager__item-toggle");if(a){a.setAttribute("aria-pressed",i?"true":"false");const e="gl-layer-manager__item-toggle--on";i?a.classList.add(e):a.classList.remove(e)}}),t&&t.debug("[LayerManager Renderer] \xc9tats des toggles synchronis\xe9s")},_renderItems(t,o){const n=e.L.DomUtil.create("div","gl-layer-manager__items",o);t.items.forEach(t=>{const o=e.L.DomUtil.create("div","gl-layer-manager__item",n);t.id&&(o.setAttribute("data-layer-id",t.id),this._checkLayerVisibility(t.id)||o.classList.add("gl-layer--hidden"));const r=e.L.DomUtil.create("div","gl-layer-manager__item-row",o);if(e.L.DomUtil.create("span","gl-layer-manager__label",r).textContent=t.label||"",t.toggleable&&t.id)this._renderToggleControls(t,r,o);else if(t.id){const o=e.L.DomUtil.create("div","gl-layer-manager__item-controls",r);e.GeoLeaf&&e.GeoLeaf._LabelButtonManager&&(e.GeoLeaf._LabelButtonManager.createButton(t.id,o),e.GeoLeaf._LabelButtonManager.syncImmediate(t.id))}else void 0!==t.value&&(e.L.DomUtil.create("span","gl-layer-manager__value",o).textContent=String(t.value))})},_renderToggleControls(t,o,n){const r=e.L.DomUtil.create("div","gl-layer-manager__item-controls",o);e.GeoLeaf&&e.GeoLeaf._LabelButtonManager&&(e.GeoLeaf._LabelButtonManager.createButton(t.id,r),e.GeoLeaf._LabelButtonManager.syncImmediate(t.id));const i=this._checkLayerVisibility(t.id),a=GeoLeaf._UIComponents&&"function"==typeof GeoLeaf._UIComponents.createToggleButton?GeoLeaf._UIComponents.createToggleButton(r,{isActive:i,className:"gl-layer-manager__item-toggle",title:"Afficher / masquer la couche"}):this._createToggleFallback(r,i);if(this._attachToggleHandler(a,t.id),t.styles&&GeoLeaf._LayerManagerStyleSelector){const e=GeoLeaf._LayerManagerStyleSelector.renderDOM(t);e&&(n.appendChild(e),GeoLeaf._LayerManagerStyleSelector.bindEvents(e,t))}},_checkLayerVisibility(o){try{if(o&&e.GeoLeaf&&e.GeoLeaf.GeoJSON&&"function"==typeof e.GeoLeaf.GeoJSON.getLayerById){const n=e.GeoLeaf.GeoJSON.getLayerById(o),r=n&&n._visibility&&"boolean"==typeof n._visibility.logicalState?n._visibility.logicalState:n&&1==n.visible,i=r;return t&&t.debug(`[LayerManager Renderer] _checkLayerVisibility(${o}): logicalState=${r}`),i}}catch(e){t&&t.error("[LayerManager Renderer] Erreur dans _checkLayerVisibility:",e)}return 0},_attachToggleHandler(o,n){if(o._toggleHandlerAttached)return;o._toggleHandlerAttached=1;const r=this,i=function(i){if(o._isToggling)return t&&t.warn("[LayerManager] \u23f8\ufe0f Toggle D\xc9J\xc0 en cours, BLOQU\xc9:",n),void(e.L&&e.L.DomEvent&&(e.L.DomEvent.stopPropagation(i),e.L.DomEvent.preventDefault(i)));o._isToggling=1,e.L&&e.L.DomEvent&&(e.L.DomEvent.stopPropagation(i),e.L.DomEvent.preventDefault(i)),setTimeout(()=>{o._isToggling=0},100);try{if(n&&e.GeoLeaf&&e.GeoLeaf.GeoJSON){if(!e.GeoLeaf.GeoJSON.getLayerById(n)){t&&t.info("[LayerManager] \u23f3 Couche non charg\xe9e, chargement \xe0 la demande:",n),o.classList.add("gl-layer-manager__item-toggle--loading"),o.disabled=1;const r=e.GeoLeaf._ThemeApplier;return void(r&&"function"==typeof r._loadLayerFromProfile?r._loadLayerFromProfile(n).then(function(r){if(o.classList.remove("gl-layer-manager__item-toggle--loading"),o.disabled=0,r){t&&t.info("[LayerManager] \u2705 Couche charg\xe9e avec succ\xe8s:",n),e.GeoLeaf.GeoJSON.showLayer(n),o.setAttribute("aria-pressed","true"),o.classList.add("gl-layer-manager__item-toggle--on");const r=document.querySelector('[data-layer-id="'+n+'"]');r&&r.classList.remove("gl-layer--hidden");let i=null;if(r&&(i=r.querySelector(".gl-layer-manager__label-toggle")),!i&&o.parentElement&&(i=o.parentElement.querySelector(".gl-layer-manager__label-toggle")),i){const t=e.GeoLeaf?.GeoJSON?.getLayerById?.(n);1==t?.currentStyle?.label?.enabled&&(i.disabled=0,i.classList.remove("gl-layer-manager__label-toggle--disabled"))}}else t&&t.warn("[LayerManager] \u274c \xc9chec du chargement de la couche:",n)}).catch(function(e){o.classList.remove("gl-layer-manager__item-toggle--loading"),o.disabled=0,t&&t.error("[LayerManager] Erreur lors du chargement de la couche:",n,e)}):(o.classList.remove("gl-layer-manager__item-toggle--loading"),o.disabled=0,t&&t.warn("[LayerManager] ThemeApplier non disponible pour charger:",n)))}const i=r._checkLayerVisibility(n),a=document.querySelector(`[data-layer-id="${n}"]`);if(i){e.GeoLeaf.GeoJSON.hideLayer(n),o.setAttribute("aria-pressed","false"),o.classList.remove("gl-layer-manager__item-toggle--on"),a&&a.classList.add("gl-layer--hidden");let r=null;a&&(r=a.querySelector(".gl-layer-manager__label-toggle")),!r&&o.parentElement&&(r=o.parentElement.querySelector(".gl-layer-manager__label-toggle")),r?(r.disabled=1,r.classList.add("gl-layer-manager__label-toggle--disabled"),r.classList.remove("gl-layer-manager__label-toggle--on"),r.setAttribute("aria-pressed","false")):t&&t.warn("[LayerManager] Bouton label NON TROUV\xc9 pour d\xe9sactivation:",n)}else{e.GeoLeaf.GeoJSON.showLayer(n),o.setAttribute("aria-pressed","true"),o.classList.add("gl-layer-manager__item-toggle--on"),a&&a.classList.remove("gl-layer--hidden");let t=null;if(a&&(t=a.querySelector(".gl-layer-manager__label-toggle")),!t&&o.parentElement&&(t=o.parentElement.querySelector(".gl-layer-manager__label-toggle")),t){const o=e.GeoLeaf?.GeoJSON?.getLayerById?.(n);1==o?.currentStyle?.label?.enabled&&(t.disabled=0,t.classList.remove("gl-layer-manager__label-toggle--disabled"))}}}}catch(e){t&&t.warn("Erreur toggle l\xe9gende :",e)}};e.L&&e.L.DomEvent?(e.L.DomEvent.on(o,"click",i),e.L.DomEvent.disableClickPropagation(o)):o.addEventListener("click",i)},_createToggleFallback(t,o){const n=e.L.DomUtil.create("button","gl-layer-manager__item-toggle",t);return n.type="button",n.setAttribute("aria-pressed",o?"true":"false"),n.title="Afficher / masquer la couche",o&&n.classList.add("gl-layer-manager__item-toggle--on"),n}};GeoLeaf._LayerManagerRenderer=o}(window)),je||(je=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log,o={generateSection(){return{id:"offline-cache",label:"\u{1f4e5} Cache Hors Ligne",order:98,collapsedByDefault:0,customContent:this._generateContent(),init:()=>this._attachEventListeners()}},_generateContent:()=>'\n                <div class="gl-cache-section">\n                    <div class="gl-cache-status">\n                        <div class="gl-cache-status__header">\n                            <span class="gl-cache-status__icon">\u{1f4be}</span>\n                            <span class="gl-cache-status__label">Statut</span>\n                        </div>\n                        <div class="gl-cache-status__info">\n                            <div class="gl-cache-status__row">\n                                <span class="gl-cache-status__key">Profil:</span>\n                                <span class="gl-cache-status__value" id="gl-cache-profile">-</span>\n                            </div>\n                            <div class="gl-cache-status__row">\n                                <span class="gl-cache-status__key">\xc9tat:</span>\n                                <span class="gl-cache-status__value" id="gl-cache-state">Non t\xe9l\xe9charg\xe9</span>\n                            </div>\n                            <div class="gl-cache-status__row">\n                                <span class="gl-cache-status__key">Taille:</span>\n                                <span class="gl-cache-status__value" id="gl-cache-size">0 MB</span>\n                            </div>\n                            <div class="gl-cache-status__row">\n                                <span class="gl-cache-status__key">Quota:</span>\n                                <span class="gl-cache-status__value" id="gl-cache-quota">0 MB disponible</span>\n                            </div>\n                        </div>\n                    </div>\n\n                    <div class="gl-cache-actions">\n                        <button\n                            id="gl-cache-download"\n                            class="gl-btn gl-btn--primary gl-cache-btn"\n                            title="T\xe9l\xe9charger le profil pour usage offline">\n                            <span class="gl-btn__icon">\u2b07\ufe0f</span>\n                            <span class="gl-btn__text">T\xe9l\xe9charger profil</span>\n                        </button>\n\n                        <button\n                            id="gl-cache-clear"\n                            class="gl-btn gl-btn--secondary gl-cache-btn"\n                            title="Effacer le cache du profil"\n                            disabled>\n                            <span class="gl-btn__icon">\u{1f5d1}\ufe0f</span>\n                            <span class="gl-btn__text">Vider cache</span>\n                        </button>\n                    </div>\n\n                    <div class="gl-cache-progress" id="gl-cache-progress" style="display: none;">\n                        <div class="gl-cache-progress__bar">\n                            <div class="gl-cache-progress__fill" id="gl-cache-progress-fill"></div>\n                        </div>\n                        <div class="gl-cache-progress__text" id="gl-cache-progress-text">\n                            T\xe9l\xe9chargement en cours...\n                        </div>\n                    </div>\n                </div>\n            ',_attachEventListeners(){const e=document.getElementById("gl-cache-download"),t=document.getElementById("gl-cache-clear");e&&e.addEventListener("click",()=>this._handleDownload()),t&&t.addEventListener("click",()=>this._handleClear()),this._updateStatus(),document.addEventListener("geoleaf:cache:completed",()=>this._updateStatus()),document.addEventListener("geoleaf:cache:cleared",()=>this._updateStatus()),document.addEventListener("geoleaf:profile:loaded",()=>this._updateStatus())},async _updateStatus(){if(GeoLeaf.Storage&&GeoLeaf.Storage.isAvailable())try{const e=GeoLeaf.Config.get("data.activeProfile",""),t=await GeoLeaf.Storage.CacheManager.getCacheStatus(e),o=await GeoLeaf.Storage.CacheManager.getStorageQuota(),n=document.getElementById("gl-cache-profile"),r=document.getElementById("gl-cache-state"),i=document.getElementById("gl-cache-size"),a=document.getElementById("gl-cache-quota"),l=document.getElementById("gl-cache-clear");n&&(n.textContent=e||"-"),t&&t.resourcesCount>0?(r&&(r.textContent="\u2705 T\xe9l\xe9charg\xe9",r.style.color="#22c55e"),i&&(i.textContent=`${(t.totalSize/1024/1024).toFixed(2)} MB`),l&&(l.disabled=0)):(r&&(r.textContent="\u274c Non t\xe9l\xe9charg\xe9",r.style.color="#ef4444"),i&&(i.textContent="0 MB"),l&&(l.disabled=1)),a&&(a.textContent=`${(o.available/1024/1024).toFixed(2)} MB disponible`)}catch(e){t.error(`[CacheSection] Failed to update status: ${e.message}`)}},async _handleDownload(){if(!GeoLeaf.Storage||!GeoLeaf.Storage.isAvailable())return void(GeoLeaf.UI&&GeoLeaf.UI.Notifications&&GeoLeaf.UI.Notifications.error("Stockage offline non disponible",5e3));const e=GeoLeaf.Config.get("data.activeProfile","");if(!e)return void(GeoLeaf.UI&&GeoLeaf.UI.Notifications&&GeoLeaf.UI.Notifications.error("Aucun profil actif",3e3));const o=document.getElementById("gl-cache-download"),n=document.getElementById("gl-cache-progress"),r=document.getElementById("gl-cache-progress-text");try{o&&(o.disabled=1,o.querySelector(".gl-btn__text").textContent="T\xe9l\xe9chargement..."),n&&(n.style.display="block"),r&&(r.textContent="Pr\xe9paration..."),t.info(`[CacheSection] Starting download for profile: ${e}`);const i=await GeoLeaf.Storage.downloadProfileForOffline(e);r&&(r.textContent=`\u2705 ${i.resourcesCount} ressources t\xe9l\xe9charg\xe9es`),GeoLeaf.UI&&GeoLeaf.UI.Notifications&&GeoLeaf.UI.Notifications.success(`Profil t\xe9l\xe9charg\xe9 : ${(i.totalSize/1024/1024).toFixed(2)} MB`,4e3),setTimeout(()=>{n&&(n.style.display="none")},2e3),await this._updateStatus()}catch(e){t.error(`[CacheSection] Download failed: ${e.message}`),r&&(r.textContent=`\u274c Erreur: ${e.message}`),GeoLeaf.UI&&GeoLeaf.UI.Notifications&&GeoLeaf.UI.Notifications.error(`Erreur t\xe9l\xe9chargement: ${e.message}`,5e3),setTimeout(()=>{n&&(n.style.display="none")},3e3)}finally{o&&(o.disabled=0,o.querySelector(".gl-btn__text").textContent="T\xe9l\xe9charger profil")}},async _handleClear(){if(!GeoLeaf.Storage||!GeoLeaf.Storage.isAvailable())return;const e=GeoLeaf.Config.get("data.activeProfile","");if(!e)return;if(!confirm(`Voulez-vous vraiment effacer le cache du profil "${e}" ?`))return;const o=document.getElementById("gl-cache-clear");try{o&&(o.disabled=1,o.querySelector(".gl-btn__text").textContent="Effacement..."),t.info(`[CacheSection] Clearing cache for profile: ${e}`);const n=await GeoLeaf.Storage.CacheManager.clearCache(e);GeoLeaf.UI&&GeoLeaf.UI.Notifications&&GeoLeaf.UI.Notifications.success(`Cache effac\xe9 : ${n} ressources supprim\xe9es`,3e3),await this._updateStatus()}catch(e){t.error(`[CacheSection] Clear failed: ${e.message}`),GeoLeaf.UI&&GeoLeaf.UI.Notifications&&GeoLeaf.UI.Notifications.error(`Erreur effacement: ${e.message}`,5e3)}finally{o&&(o.querySelector(".gl-btn__text").textContent="Vider cache")}}};GeoLeaf._LayerManagerCacheSection=o}(window)),Je||(Je=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log,o={render(t,o){if(!t||!o)return;const n=e.L.DomUtil.create("div","gl-layer-manager__items gl-layer-manager__basemap-select",o),r=e.L.DomUtil.create("select","gl-layer-manager__basemap-select__select",n);Array.isArray(t.items)&&t.items.forEach(function(e){if(!e||!e.id)return;const t=document.createElement("option");t.value=e.id,t.textContent=e.label||e.id,r.appendChild(t)});try{const t=e.GeoLeaf&&e.GeoLeaf.Baselayers&&"function"==typeof e.GeoLeaf.Baselayers.getActiveId?e.GeoLeaf.Baselayers.getActiveId():null;t&&(r.value=t)}catch(e){}this._attachChangeHandler(r),this._attachExternalListener(r)},_attachChangeHandler(o){const n=function(n){e.L&&e.L.DomEvent&&e.L.DomEvent.stopPropagation(n);try{const t=o.value;e.GeoLeaf&&e.GeoLeaf.Baselayers&&"function"==typeof e.GeoLeaf.Baselayers.setBaseLayer&&e.GeoLeaf.Baselayers.setBaseLayer(t)}catch(e){t&&t.warn("Erreur lors du changement de basemap depuis la l\xe9gende:",e)}};e.L&&e.L.DomEvent?e.L.DomEvent.on(o,"change",n):o.addEventListener("change",n)},_attachExternalListener(e){"undefined"!=typeof document&&document.addEventListener("geoleaf:basemap-changed",function(t){try{t&&t.detail&&t.detail.id&&(e.value=t.detail.id)}catch(e){}})}};GeoLeaf._LayerManagerBasemapSelector=o}(window)),ze||(ze=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t={currentStyles:new Map};GeoLeaf._LayerManagerStyleSelector={getCurrentStyle:function(e){return t.currentStyles.get(e)||null},setCurrentStyle:function(e,o){t.currentStyles.set(e,o)},render:function(e){if(!e.styles||!Array.isArray(e.styles.available)||e.styles.available.length<=1)return"";const t=this.getCurrentStyle(e.id)||e.styles.default||e.styles.available[0].id,o="style-selector-"+e.id;let n='<div class="gl-layer-manager__style-selector">';return n+='<select id="'+o+'" class="gl-layer-manager__style-select" data-layer-id="'+e.id+'">',e.styles.available.forEach(function(e){const o=e.id===t?" selected":"";n+='<option value="'+e.id+'"'+o+">"+e.label+"</option>"}),n+="</select>",n+="</div>",n},renderDOM:function(e){if(!e.styles||!Array.isArray(e.styles.available)||e.styles.available.length<=1)return null;const t=this.getCurrentStyle(e.id)||e.styles.default||e.styles.available[0].id,o="style-selector-"+e.id,n=document.createElement("div");n.className="gl-layer-manager__style-selector";const r=document.createElement("select");return r.id=o,r.className="gl-layer-manager__style-select",r.setAttribute("data-layer-id",e.id),e.styles.available.forEach(function(e){const o=document.createElement("option");o.value=e.id,o.textContent=e.label,e.id===t&&(o.selected=1),r.appendChild(o)}),n.appendChild(r),n},bindEvents:function(e,t){if(!t.styles||!Array.isArray(t.styles.available)||t.styles.available.length<=1)return;const o="style-selector-"+t.id,n=e.querySelector("#"+o);if(!n)return;const r=this;n.addEventListener("change",function(){const e=this.value,t=this.getAttribute("data-layer-id");r.setCurrentStyle(t,e),r.applyStyle(t,e)})},applyStyle:async function(t,o){if(!e.GeoLeaf._GeoJSONLayerManager)return;const n=e.GeoLeaf._GeoJSONLayerManager,r=n.getLayerData(t);if(!r)return;if(!r.config.styles||!Array.isArray(r.config.styles.available))return;const i=r.config.styles.available.find(function(e){return e.id===o});if(i)try{const a=e.GeoLeaf._StyleLoader;if(!a)return void this._applyStyleLegacy(t,o,r,i);const l=r.config._profileId,s=r.config._layerDirectory;if(!l||!s)return;const c=await a.loadAndValidateStyle(l,t,o,i.file,s);r.currentStyle=c.styleData,r.currentStyleMetadata=c.metadata,"function"==typeof n.setLayerStyle&&n.setLayerStyle(t,c.styleData),e.GeoLeaf.Labels&&"function"==typeof e.GeoLeaf.Labels.initializeLayerLabels&&e.GeoLeaf.Labels.initializeLayerLabels(t),e.GeoLeaf._LabelButtonManager&&e.GeoLeaf._LabelButtonManager.syncImmediate(t),e.GeoLeaf.Legend&&"function"==typeof e.GeoLeaf.Legend.loadLayerLegend&&e.GeoLeaf.Legend.loadLayerLegend(r.config.id,o,r.config)}catch(e){}},_applyStyleLegacy:function(t,o,n,r){const i=e.GeoLeaf._GeoJSONLayerManager,a=n.config._profileId,l=n.config._layerDirectory;if(!a||!l)return;const s=e.GeoLeaf.Config,c=s&&s.get?s.get("data"):null,u=(c&&c.profilesBasePath||"profiles")+"/"+a+"/"+l+"/"+(n.config.styles.directory||"styles")+"/"+r.file;fetch(u).then(function(e){if(!e.ok)throw new Error("Erreur HTTP "+e.status);return e.json()}).then(function(r){"function"==typeof i.setLayerStyle&&i.setLayerStyle(t,r),e.GeoLeaf.Legend&&"function"==typeof e.GeoLeaf.Legend.loadLayerLegend&&e.GeoLeaf.Legend.loadLayerLegend(n.config.id,o,n.config)}).catch(function(){})}}}(window)),Ve||(Ve=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log;GeoLeaf._LayerManagerControl={create:function(o){return e.L&&e.L.Control?new(e.L.Control.extend({options:{position:o.position||"bottomright"},initialize:function(t){e.L.setOptions(this,t||{}),this._glOptions=t._glOptions},onAdd:function(t){return this._map=t,this._container=e.L.DomUtil.create("div","gl-layer-manager"),e.L.DomEvent&&(e.L.DomEvent.disableClickPropagation(this._container),e.L.DomEvent.disableScrollPropagation(this._container)),this._buildStructure(),this._container},onRemove:function(){this._map=null,this._container=null},_buildStructure:function(){const t=this._glOptions,o=e.L.DomUtil.create("div","gl-layer-manager__main-wrapper",this._container),n=e.L.DomUtil.create("div","gl-layer-manager__header-wrapper",o),r=e.L.DomUtil.create("div","gl-layer-manager__header",n);e.L.DomUtil.create("div","gl-layer-manager__title",r).textContent=t.title||"L\xe9gende";let i=null;if(t.collapsible){i=e.L.DomUtil.create("button","gl-layer-manager__toggle",r),i.type="button",i.setAttribute("aria-label","Basculer la l\xe9gende"),i.textContent="\u27f1";const t=this;e.L.DomEvent.on(i,"click",function(o){e.L.DomEvent.stopPropagation(o),t._toggleCollapsed()})}const a=e.L.DomUtil.create("div","gl-layer-manager__body-wrapper",o);this._bodyEl=e.L.DomUtil.create("div","gl-layer-manager__body",a),(t.collapsed||t.collapsedByDefault)&&(this._container.classList.add("gl-layer-manager--collapsed"),t.collapsed=1),this._renderSections(t.sections||[])},_renderSections:function(e){GeoLeaf._LayerManagerRenderer?GeoLeaf._LayerManagerRenderer.renderSections(this._bodyEl,e):t&&t.error("[LayerManager] _LayerManagerRenderer non disponible")},updateSections:function(e){this._glOptions.sections=Array.isArray(e)?e:[],this._renderSections(this._glOptions.sections)},refresh:function(){GeoLeaf._LayerManagerRenderer&&"function"==typeof GeoLeaf._LayerManagerRenderer.syncToggles?GeoLeaf._LayerManagerRenderer.syncToggles():this._glOptions&&this._glOptions.sections&&this._renderSections(this._glOptions.sections)},_toggleCollapsed:function(){const e=this._container.classList.toggle("gl-layer-manager--collapsed");this._glOptions.collapsed=e}}))({position:o.position,_glOptions:o}):(t&&t.error("[LayerManager] Leaflet L.Control non disponible"),null)}}}(window)),qe||(qe=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log,o={_map:null,_control:null,_refreshTimeout:null,_options:{position:"bottomright",title:"Gestionnaire de couches",collapsible:1,collapsed:0,sections:[]},init(o={}){if(void 0===e.L||!e.L||!e.L.Control)return t&&t.error("[GeoLeaf.LayerManager] Leaflet (L.Control) est requis mais introuvable."),null;let n=o.map||null;return!n&&GeoLeaf.Core&&"function"==typeof GeoLeaf.Core.getMap&&(n=GeoLeaf.Core.getMap()),n?(this._map=n,t&&t.info("[GeoLeaf.LayerManager] init: map assigned"),this._options=this._mergeOptions(this._options,o),this._loadConfigSections(),this._autoPopulateBasemap(),this._autoPopulateSections(),GeoLeaf._LayerManagerControl?(this._control=GeoLeaf._LayerManagerControl.create(this._options),this._control?(this._control.addTo(this._map),t&&t.info("[GeoLeaf.LayerManager] Contr\xf4le cr\xe9\xe9 et ajout\xe9 \xe0 la carte"),this._control):(t&&t.error("[GeoLeaf.LayerManager] \xc9chec cr\xe9ation contr\xf4le"),null)):(t&&t.error("[GeoLeaf.LayerManager] Module _LayerManagerControl non charg\xe9"),null)):(t&&t.error("[GeoLeaf.LayerManager] Aucune carte Leaflet disponible. Passe une instance dans init({ map })."),null)},_loadConfigSections(){if(GeoLeaf.Config&&"function"==typeof GeoLeaf.Config.get){const e=GeoLeaf.Config.get("layerManagerConfig");if(GeoLeaf.Log&&GeoLeaf.Log.debug("[LayerManager] Configuration charg\xe9e:",{title:e?.title,collapsed:e?.collapsedByDefault,sectionsCount:e?.sections?.length||0}),e&&(e.title&&(this._options.title=e.title),"boolean"==typeof e.collapsedByDefault&&(this._options.collapsed=e.collapsedByDefault),Array.isArray(e.sections)&&e.sections.length>0)){const o=e.sections.slice().sort((e,t)=>(e.order||0)-(t.order||0)).map(e=>({id:e.id,label:e.label,order:e.order,collapsedByDefault:e.collapsedByDefault,items:[]}));Array.isArray(this._options.sections)||(this._options.sections=[]),o.forEach(e=>{const t=this._options.sections.find(t=>t.id===e.id);t?e.label&&!t.label&&(t.label=e.label):this._options.sections.push(e)}),this._options.sections.sort((e,t)=>(e.order||0)-(t.order||0)),t&&t.info("[GeoLeaf.LayerManager] Sections fusionn\xe9es avec layerManagerConfig")}}},_autoPopulateBasemap(){if(!Array.isArray(this._options.sections))return;const o=this._options.sections.find(e=>"basemap"===e.id);if(o&&(!o.items||0===o.items.length))try{let n=null;e.GeoLeaf&&e.GeoLeaf.Baselayers&&"function"==typeof e.GeoLeaf.Baselayers.getBaseLayers?n=e.GeoLeaf.Baselayers.getBaseLayers()||{}:GeoLeaf.Config&&"function"==typeof GeoLeaf.Config.get&&(n=GeoLeaf.Config.get("basemaps")||{}),n&&Object.keys(n).length>0&&(o.items=Object.keys(n).map(e=>{const t=n[e]||{};return{id:t.id||e,label:t.label||e}}),t&&t.info("[GeoLeaf.LayerManager] Section basemap remplie automatiquement"))}catch(e){t&&t.warn("[GeoLeaf.LayerManager] Erreur lors du remplissage automatique des basemaps:",e)}},_autoPopulateSections(){if(Array.isArray(this._options.sections)&&this._options.sections.length>0)return;const o=[];try{if(e.GeoLeaf&&e.GeoLeaf.Baselayers&&"function"==typeof e.GeoLeaf.Baselayers.getBaseLayers){const t=e.GeoLeaf.Baselayers.getBaseLayers()||{},n=Object.keys(t).map(e=>({id:e,label:(t[e]||{}).label||e}));n.length&&o.push({id:"basemap",label:"Fond de carte",items:n})}}catch(e){}o.length?(this._options.sections=o,t&&t.info("[GeoLeaf.LayerManager] auto-populated sections from Baselayers")):t&&t.warn("[GeoLeaf.LayerManager] Aucune section fournie et autoremplissage impossible.")},_registerGeoJsonLayer(e,o={}){this._options.sections||(this._options.sections=[]);const n=o.layerManagerId||o.legendSection||"geojson-default";let r=this._options.sections.find(e=>e.id===n);r||(r={id:n,label:o.legendSectionLabel||"Couches GeoJSON",order:10,items:[]},this._options.sections.push(r),this._options.sections.sort((e,t)=>(e.order||0)-(t.order||0))),r.items.find(t=>t.id===e)||(r.items.push({id:e,label:o.label||e,toggleable:1,themes:o.themes||null,styles:o.styles||null,labels:o.labels||null}),this._updateContent(),t&&t.debug(`[LayerManager] Couche "${e}" enregistr\xe9e dans section "${n}"`))},_unregisterGeoJsonLayer(e){Array.isArray(this._options.sections)&&(this._options.sections.forEach(t=>{Array.isArray(t.items)&&(t.items=t.items.filter(t=>t.id!==e))}),this._options.sections=this._options.sections.filter(e=>"basemap"===e.id||Array.isArray(e.items)&&e.items.length>0),this._updateContent(),t&&t.debug(`[LayerManager] Couche "${e}" d\xe9senregistr\xe9e`))},updateSections(e){Array.isArray(e)?(this._options.sections=e,this._updateContent()):t&&t.warn("[GeoLeaf.LayerManager] updateSections: sections doit \xeatre un tableau")},addSection(e){if(!e||!e.id)return void(t&&t.warn("[GeoLeaf.LayerManager] addSection: section invalide (id manquant)"));Array.isArray(this._options.sections)||(this._options.sections=[]);const o=this._options.sections.findIndex(t=>t.id===e.id);if(-1!==o){const t=this._options.sections[o];Array.isArray(e.items)&&(Array.isArray(t.items)||(t.items=[]),e.items.forEach(e=>{const o=t.items.findIndex(t=>t.id===e.id);-1!==o?t.items[o]=Object.assign({},t.items[o],e):t.items.push(e)}),t.items.sort((e,t)=>(e.order||0)-(t.order||0))),e.label&&(t.label=e.label),void 0!==e.order&&(t.order=e.order),void 0!==e.collapsedByDefault&&(t.collapsedByDefault=e.collapsedByDefault)}else this._options.sections.push({id:e.id,label:e.label||e.id,order:e.order||99,collapsedByDefault:e.collapsedByDefault||0,items:e.items||[]}),this._options.sections.sort((e,t)=>(e.order||0)-(t.order||0));this._updateContent(),t&&t.debug(`[LayerManager] Section "${e.id}" ajout\xe9e/mise \xe0 jour`)},toggleCollapse(){this._options.collapsed=!this._options.collapsed,this._control&&(this._options.collapsed?this._control._container.classList.add("gl-layer-manager--collapsed"):this._control._container.classList.remove("gl-layer-manager--collapsed"))},isCollapsed(){return!!this._options.collapsed},_updateContent(){this._control&&"function"==typeof this._control.updateSections&&this._control.updateSections(this._options.sections||[])},refresh(e=0){if(this._control&&"function"==typeof this._control.refresh){if(e)return this._refreshTimeout&&(clearTimeout(this._refreshTimeout),this._refreshTimeout=null),this._control.refresh(),void(t&&t.debug("[LayerManager] Affichage rafra\xeechi (imm\xe9diat)"));this._refreshTimeout&&clearTimeout(this._refreshTimeout),this._refreshTimeout=setTimeout(()=>{this._refreshTimeout=null,this._control.refresh(),t&&t.debug("[LayerManager] Affichage rafra\xeechi (debounced)")},250)}else t&&t.warn("[LayerManager] refresh(): contr\xf4le non disponible ou m\xe9thode refresh manquante")},_mergeOptions(e,t){const o=Object.assign({},e||{});return t?(Object.keys(t).forEach(n=>{const r=t[n];r&&"object"==typeof r&&!Array.isArray(r)&&e&&"object"==typeof e[n]&&!Array.isArray(e[n])?o[n]=Object.assign({},e[n],r):o[n]=r}),o):o}};GeoLeaf.LayerManager=o}(window)),He||(He=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log;function o(){try{const e=GeoLeaf&&GeoLeaf._POIShared?GeoLeaf._POIShared:null;if(0!=(e?e.state.poiConfig:{}).showIconsOnMap){const e=GeoLeaf.Config&&"function"==typeof GeoLeaf.Config.getIconsConfig?GeoLeaf.Config.getIconsConfig():null;if(e&&0!=e.showOnMap)return 1}}catch(e){}return 0}function n(e,o,n,i,a,l,s){if(!e||!o)return null;const c=i?Object.assign({},i,e):e,u={label:o.label||"Sans label",order:o.order||999};switch(o.description&&(u.description=o.description),n){case"point":u.symbol=r(c,a,l,s);break;case"line":u.symbol=function(e){const t=e.stroke||{},o=e.casing||{},n={type:"line",color:t.color||e.color||"#3388ff",width:t.widthPx||e.weight||3,style:"solid"};o.enabled&&o.color&&(n.outlineColor=o.color,n.outlineWidth=Math.max(.5,.4*(o.widthPx||1)),n.outlineOpacity=o.opacity||1),void 0!==t.opacity&&(n.opacity=t.opacity);const r=e.dashArray||t.dashArray;return r&&(n.dashArray=r,"5, 5"===r||"10, 10"===r?n.style="dashed":"1, 3"!==r&&"2, 4"!==r||(n.style="dotted")),n}(c);break;case"polygon":u.symbol=function(e){const t=e.fill||{},o=e.stroke||{},n={type:"polygon",fillColor:e.fillColor||e.color||t.color||"#3388ff",color:e.color||o.color||"#333",weight:e.weight||o.widthPx||1};(function(e,t){["fillOpacity"].forEach(o=>{void 0!==t[o]&&(e[o]=t[o])})})(n,e),void 0!==t.opacity&&(n.opacity=t.opacity),void 0!==e.opacity&&(n.opacity=e.opacity);const r=e.dashArray||o.dashArray;return r&&(n.dashArray=r),e.fillPattern&&(n.fillPattern=e.fillPattern),e.hatch&&(n.hatch=e.hatch),n}(c);break;default:t&&t.warn("[LegendGenerator] Type de g\xe9om\xe9trie non reconnu:",n),u.symbol=r(c,a,l,s)}return u}function r(e,n,r,i){const a=e.fill||{},l=e.stroke||{},s={type:"circle",radius:e.radius||e.size||(e.sizePx?e.sizePx/2:void 0)||24,fillColor:e.fillColor||e.color||a.color||"#3388ff",fillOpacity:void 0!==e.fillOpacity?e.fillOpacity:void 0!==a.opacity?a.opacity:1,color:e.color||l.color||"#ffffff",weight:e.weight||l.widthPx||2,opacity:void 0!==e.opacity?e.opacity:void 0!==l.opacity?l.opacity:1};if(e.useIcon&&e.iconId)s.icon=e.iconId,s.iconColor="#ffffff",t&&t.debug(`[LegendGenerator] Ic\xf4ne trouv\xe9e dans le style: ${e.iconId}`);else if(n&&o()){const e=function(e){if(!o())return{useIcon:0,iconId:null};const t=GeoLeaf.Config&&"function"==typeof GeoLeaf.Config.getCategories?GeoLeaf.Config.getCategories():{};if(!t||0===Object.keys(t).length)return{useIcon:0,iconId:null};const n={archaeological:{categoryId:"CULTURES",subCategoryId:"SITE ARCHEOLOGIQUE"},museum:{categoryId:"CULTURES",subCategoryId:"MUSEE"},camp_site:{categoryId:"HEBERGEMENT",subCategoryId:"CAMPING"},hotel:{categoryId:"HEBERGEMENT",subCategoryId:"HOTEL"}};let r=null,i=null;if(e.when&&e.when.field&&void 0!==e.when.value)if("properties.fclass"===e.when.field||"fclass"===e.when.field){const t=n[e.when.value];t&&(r=t.categoryId,i=t.subCategoryId)}else"properties.categoryId"===e.when.field||"categoryId"===e.when.field?r=e.when.value:"properties.subCategoryId"===e.when.field||"subCategoryId"===e.when.field?i=e.when.value:"properties.category"===e.when.field||"category"===e.when.field?r=e.when.value:"properties.subCategory"!==e.when.field&&"subCategory"!==e.when.field||(i=e.when.value);else e.condition&&(void 0!==e.condition.categoryId&&(r=e.condition.categoryId),void 0!==e.condition.subCategoryId&&(i=e.condition.subCategoryId),void 0!==e.condition.category&&(r=e.condition.category),void 0!==e.condition.subCategory&&(i=e.condition.subCategory));if(i&&!r&&Object.keys(t).forEach(e=>{const o=t[e];o.subcategories&&o.subcategories[i]&&(r=e)}),!r&&!i)return{useIcon:0,iconId:null};let a=null;if(i&&t[r]?.subcategories){const e=t[r].subcategories[i],o=t[r];a=e?e.icon||e.iconId||o.icon||o.iconId||null:o.icon||o.iconId||null}else if(t[r]){const e=t[r];a=e.icon||e.iconId||null}return{useIcon:null!==a,iconId:a}}(n);if(e.useIcon&&e.iconId){const o=e.iconId.startsWith("#")?e.iconId:i?i+e.iconId:"#sprite-"+e.iconId;s.icon=o,s.iconColor="#ffffff",t&&t.debug(`[LegendGenerator] Ic\xf4ne r\xe9solue depuis la config: ${o}`)}}if(!s.icon&&n&&r&&o()){const e=function(e,o,n){if(!e.when||!o||!o.categories)return t&&t.debug("[LegendGenerator] Donn\xe9es insuffisantes pour r\xe9cup\xe9rer ic\xf4ne:",{hasRule:!!e.when,hasTaxonomy:!!o,hasCategories:!(!o||!o.categories)}),null;const r=e.when.field,i=e.when.value,a=o.categories;t&&t.debug(`[LegendGenerator] Recherche ic\xf4ne pour ${r}=${i}`);const l="properties.categoryId"===r||"attributes.categoryId"===r;if("properties.subCategoryId"===r||"attributes.subCategoryId"===r)for(const e in a){const o=a[e].subcategories;if(o&&o[i]&&o[i].icon){const e=n+o[i].icon;return t&&t.debug(`[LegendGenerator] Ic\xf4ne trouv\xe9e (subcat): ${e}`),e}}if(l&&a[i]&&a[i].icon){const e=n+a[i].icon;return t&&t.debug(`[LegendGenerator] Ic\xf4ne trouv\xe9e (cat): ${e}`),e}return t&&t.warn(`[LegendGenerator] Aucune ic\xf4ne trouv\xe9e pour ${r}=${i}`),null}(n,r,i);e&&(s.icon=e,s.iconColor="#ffffff",t&&t.debug("[LegendGenerator] Ic\xf4ne taxonomy ajout\xe9e:",e))}return s}GeoLeaf._LegendGenerator={generateLegendFromStyle:function(e,o,r){if(!e)return t&&t.warn("[LegendGenerator] Style data manquant"),null;const i={version:"3.0",id:e.id,title:e.label||"Sans titre",description:e.description||"",sections:[]},a=[],l=r?.icons?.symbolPrefix||"tourism-poi-cat-";if(Array.isArray(e.styleRules)&&e.styleRules.length>0&&(e.styleRules.forEach(i=>{if(!i.legend)return void(t&&t.warn("[LegendGenerator] R\xe8gle sans propri\xe9t\xe9 legend:",i));const s=n(i.style,i.legend,o,e.style,i,r,l);s&&a.push(s)}),a.sort((e,t)=>(e.order||999)-(t.order||999))),0===a.length&&e.style&&e.legend){const t=n(e.style,e.legend,o,null,null,r,l);t&&a.push(t)}return a.length>0&&i.sections.push({title:"",items:a}),i},generateLegendItem:n}}(window)),Ze||(Ze=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log;function o(t,o){const r=e.L.DomUtil.create("div","gl-legend__section",t);o.title&&(e.L.DomUtil.create("h3","gl-legend__section-title",r).textContent=o.title);const i=e.L.DomUtil.create("div","gl-legend__items",r);return Array.isArray(o.items)&&o.items.forEach(e=>n(i,e)),r}function n(t,o){const n=e.L.DomUtil.create("div","gl-legend__item",t);r(e.L.DomUtil.create("div","gl-legend__symbol",n),o);const i=e.L.DomUtil.create("div","gl-legend__text",n);return e.L.DomUtil.create("span","gl-legend__label",i).textContent=o.label||"",o.description&&(e.L.DomUtil.create("span","gl-legend__description",i).textContent=o.description),n}function r(e,o){GeoLeaf._UIComponents&&"function"==typeof GeoLeaf._UIComponents.renderSymbol?GeoLeaf._UIComponents.renderSymbol(e,o):t&&t.error("[LegendRenderer] Module _UIComponents non disponible")}GeoLeaf._LegendRenderer={renderSection:o,renderItem:n,renderSymbol:r,renderFooter:function(t,o){if(!o||!o.text)return;const n=e.L.DomUtil.create("div","gl-legend__footer",t);n.textContent=o.text,"italic"===o.style&&(n.style.fontStyle="italic")},renderAccordion:function(n,r){if(!GeoLeaf._UIComponents)return void(t&&t.error("[LegendRenderer] Module _UIComponents non disponible"));const{bodyEl:i}=GeoLeaf._UIComponents.createAccordion(n,{layerId:r.layerId,label:r.label,collapsed:0!=r.collapsed,visible:r.visible,onToggle:t=>{e.GeoLeaf&&e.GeoLeaf.Legend&&"function"==typeof e.GeoLeaf.Legend.toggleAccordion&&e.GeoLeaf.Legend.toggleAccordion(t)}});Array.isArray(r.sections)&&r.sections.forEach(e=>{o(i,e)})}}}(window)),We||(We=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log;async function o(e){if(GeoLeaf._POIMarkers&&"function"==typeof GeoLeaf._POIMarkers.ensureProfileSpriteInjectedSync){o._alreadyLogged||(t&&t.debug("[Legend] Chargement du sprite SVG pour les ic\xf4nes..."),o._alreadyLogged=1),await GeoLeaf._POIMarkers.ensureProfileSpriteInjectedSync();let n=0;const r=20,i=100;function a(){const l=document.querySelector('svg[data-geoleaf-sprite="profile"]');n++,l?(o._spriteDetected||(t&&t.info("[Legend] Sprite SVG d\xe9tect\xe9 et pr\xeat pour utilisation"),o._spriteDetected=1),"function"==typeof e&&e(1)):n<r?setTimeout(a,i):(t&&t.warn("[Legend] Sprite SVG non trouv\xe9 apr\xe8s",r*i,"ms"),"function"==typeof e&&e(0))}a()}else t&&t.debug("[Legend] GeoLeaf._POIMarkers.ensureProfileSpriteInjectedSync non disponible"),"function"==typeof e&&e(0)}GeoLeaf._LegendControl={create:function(n){return e.L&&e.L.Control?new(e.L.Control.extend({options:{position:n.position||"bottomleft"},initialize:function(t){e.L.setOptions(this,t||{}),this._glOptions=t._glOptions},onAdd:function(t){return this._map=t,this._container=e.L.DomUtil.create("div","gl-map-legend"),e.L.DomEvent&&(e.L.DomEvent.disableClickPropagation(this._container),e.L.DomEvent.disableScrollPropagation(this._container)),this._buildStructure(),this._container},onRemove:function(){this._map=null,this._container=null},_buildStructure:function(){const t=this._glOptions,o=e.L.DomUtil.create("div","gl-map-legend__wrapper",this._container);if(t.title){const n=e.L.DomUtil.create("div","gl-map-legend__header",o);if(e.L.DomUtil.create("h2","gl-map-legend__title",n).textContent=t.title,t.collapsible){const t=e.L.DomUtil.create("button","gl-map-legend__toggle",n);t.type="button",t.setAttribute("aria-label","Basculer la l\xe9gende"),t.textContent="\u27f1";const o=this;e.L.DomEvent.on(t,"click",function(t){e.L.DomEvent.stopPropagation(t),o._toggleCollapsed()})}}this._bodyEl=e.L.DomUtil.create("div","gl-map-legend__body",o),t.collapsed&&this._container.classList.add("gl-map-legend--collapsed"),this._renderContent()},_renderContent:function(){if(!this._bodyEl)return;GeoLeaf._UIComponents&&"function"==typeof GeoLeaf._UIComponents.clearElement?GeoLeaf._UIComponents.clearElement(this._bodyEl):GeoLeaf.DOMSecurity.clearElementFast(this._bodyEl);const e=this._glOptions,n=GeoLeaf._LegendRenderer;n?(o(),Array.isArray(e.sections)&&e.sections.forEach(e=>{n.renderSection(this._bodyEl,e)}),e.footer&&n.renderFooter(this._bodyEl,e.footer)):t&&t.error("[Legend] _LegendRenderer non disponible")},updateMultiLayerContent:function(e){if(!this._bodyEl)return;GeoLeaf._UIComponents&&"function"==typeof GeoLeaf._UIComponents.clearElement?GeoLeaf._UIComponents.clearElement(this._bodyEl):GeoLeaf.DOMSecurity.clearElementFast(this._bodyEl);const n=GeoLeaf._LegendRenderer;if(!n||"function"!=typeof n.renderAccordion)return void(t&&t.error("[Legend] Renderer.renderAccordion non disponible"));const r=this;o(function(o){t&&t.debug("[Legend] Sprite charg\xe9:",o,"- Rendu des accord\xe9ons"),Array.isArray(e)&&e.forEach(e=>{n.renderAccordion(r._bodyEl,e)}),o||setTimeout(function(){document.querySelector('svg[data-geoleaf-sprite="profile"]')&&t&&(t.info("[Legend] Sprite charg\xe9 tardivement - Re-rendu des accord\xe9ons"),r.updateMultiLayerContent(e))},1e3)})},updateContent:function(e){e.title&&(this._glOptions.title=e.title),e.sections&&(this._glOptions.sections=e.sections),e.footer&&(this._glOptions.footer=e.footer),this._renderContent()},_toggleCollapsed:function(){const e=this._container.classList.toggle("gl-map-legend--collapsed");this._glOptions.collapsed=e},show:function(){this._container&&(this._container.style.display="block")},hide:function(){this._container&&(this._container.style.display="none")}}))({position:n.position,_glOptions:n}):(t&&t.error("[Legend] Leaflet L.Control non disponible"),null)}}}(window)),Xe||(Xe=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log;let o=null,n=null,r={},i=null,a=null,l=null,s=null,c=null;const u=new Map;function d(){l&&clearTimeout(l),l=setTimeout(()=>{l=null,g._rebuildDisplay()},150)}function f(){c&&(clearTimeout(c),c=null)}function p(){f(),s&&s.parentElement&&s.parentElement.removeChild(s),n&&n._container&&(n._container.removeAttribute("aria-busy"),n._container.removeAttribute("aria-live"))}const g={init:function(e,n){if(!e)return t&&t.error("[Legend] Carte Leaflet requise pour initialiser Legend"),0;if(o=e,GeoLeaf.Config&&"function"==typeof GeoLeaf.Config.get){const e=GeoLeaf.Config.get("legendConfig");if(r=Object.assign({position:e&&e.position||"bottomleft",collapsible:1,collapsed:e&&e.collapsedByDefault||0,title:e&&e.title||"L\xe9gende"},n||{}),"function"==typeof GeoLeaf.Config.getActiveProfile)i=GeoLeaf.Config.getActiveProfile();else{const e=GeoLeaf.Config.getAll();i={id:e.id||GeoLeaf.Config.get("id"),layers:e.layers||GeoLeaf.Config.get("layers")||[]}}}else r=Object.assign({position:"bottomleft",collapsible:1,collapsed:0,title:"L\xe9gende"},n||{});return this._loadTaxonomy(),this._initializeAllLayers(),t&&t.info("[Legend] Module Legend initialis\xe9 avec g\xe9n\xe9ration automatique depuis styles"),1},_loadTaxonomy:function(){if(!i)return;const e=GeoLeaf.Config,o=e&&e.get?e.get("data"):null,n=o&&o.profilesBasePath||"profiles",r=i.id;r?fetch(`${n}/${r}/taxonomy.json`).then(e=>{if(!e.ok)throw new Error(`HTTP ${e.status}`);return e.json()}).then(e=>{a=e,t&&t.debug("[Legend] Taxonomy charg\xe9e")}).catch(e=>{t&&t.warn(`[Legend] Erreur chargement taxonomy: ${e.message}`)}):t&&t.warn("[Legend] Impossible de charger taxonomy sans profileId")},_initializeAllLayers:function(){i&&Array.isArray(i.layers)?(i.layers.forEach((e,t)=>{u.set(e.id,{label:e.id,styleId:null,legendData:null,visible:0,order:t+1,geometryType:null,configFile:e.configFile})}),t&&t.debug(`[Legend] ${u.size} couche(s) initialis\xe9e(s)`)):t&&t.warn("[Legend] Aucune couche d\xe9finie dans le profil")},loadLayerLegend:function(e,n,r){if(!o)return void(t&&t.warn("[Legend] Module non initialis\xe9"));const l=u.get(e);if(!l)return void(t&&t.warn(`[Legend] Couche ${e} non trouv\xe9e dans le profil`));GeoLeaf._POIMarkers&&"function"==typeof GeoLeaf._POIMarkers.ensureProfileSpriteInjectedSync&&(GeoLeaf._POIMarkers.ensureProfileSpriteInjectedSync(),t&&t.debug(`[Legend] Sprite SVG demand\xe9 pour couche ${e}`)),l.label=r.label||e,l.geometryType=function(e){const t=e.toLowerCase();return"polyline"===t||"line"===t?"line":"polygon"===t?"polygon":"point"}(r.geometryType||r.geometry||l.geometryType||"point"),l.styleId=n;const s=GeoLeaf.Config,c=s&&s.get?s.get("data"):null,f=c&&c.profilesBasePath||"profiles",p=r._profileId||i.id,g=r._layerDirectory;if(!r.styles||!r.styles.directory)return void(t&&t.warn(`[Legend] Configuration styles manquante pour ${e}`));const y=`${f}/${p}/${g}/${r.styles.directory}/${r.styles.available?.find(e=>e.id===n)?.file||r.styles.default}`;t&&t.debug(`[Legend] Chargement style: ${y}`),fetch(y).then(e=>{if(!e.ok)throw new Error(`HTTP ${e.status}`);return e.json()}).then(o=>{if(!GeoLeaf._LegendGenerator)return void(t&&t.error("[Legend] LegendGenerator non disponible"));const n=GeoLeaf._POIShared;void 0!==r.showIconsOnMap&&(GeoLeaf._POIShared={state:{poiConfig:{showIconsOnMap:r.showIconsOnMap}}});const i=GeoLeaf._LegendGenerator.generateLegendFromStyle(o,l.geometryType,a);void 0!==r.showIconsOnMap&&(GeoLeaf._POIShared=n),i&&(l.legendData=i,u.set(e,l),t&&t.debug(`[Legend] L\xe9gende g\xe9n\xe9r\xe9e pour ${e}`),d())}).catch(e=>{t&&t.warn(`[Legend] Erreur chargement style: ${e.message}`)})},setLayerVisibility:function(e,o){const n=u.get(e);n&&(n.visible=o,u.set(e,n),d(),t&&t.debug(`[Legend] Visibilit\xe9 de ${e}: ${o}`))},_rebuildDisplay:function(){if(o)if(0!==u.size){if(n||(n=GeoLeaf._LegendControl.create(r),n&&o.addControl(n)),n&&"function"==typeof n.updateMultiLayerContent){const e=GeoLeaf._LayerVisibilityManager,o=[];u.forEach((t,n)=>{if(!t.legendData)return;const r=e&&"function"==typeof e.getVisibilityState?e.getVisibilityState(n):null;(r?r.current:t.visible)&&o.push({layerId:n,label:t.label,collapsed:1,order:t.order,visible:1,sections:t.legendData.sections||[]})}),o.sort((e,t)=>e.order-t.order),n.updateMultiLayerContent(o),o.some(e=>e.sections.some(e=>e.items&&e.items.some(e=>e.icon)))&&(document.querySelector('svg[data-geoleaf-sprite="profile"]')||(t&&t.info("[Legend] Ic\xf4nes d\xe9tect\xe9es mais sprite manquant - programmation retry"),setTimeout(()=>{document.querySelector('svg[data-geoleaf-sprite="profile"]')&&t&&(t.info("[Legend] Sprite disponible - nouveau rendu de la l\xe9gende"),this._rebuildDisplay())},2e3)))}}else n&&o&&(o.removeControl(n),n=null)},toggleAccordion:function(){},getAllLayers:function(){return u},addLayerLegend:function(e,o,n){t&&t.warn("[Legend] addLayerLegend() est d\xe9pr\xe9ci\xe9 avec donn\xe9es JSON, utiliser loadLayerLegend avec style");const r=u.get(e);r&&(r.legendData=n,r.styleId=o,u.set(e,r),this._rebuildDisplay())},removeLayerLegend:function(e){t&&t.warn("[Legend] removeLayerLegend() est d\xe9pr\xe9ci\xe9, utiliser setLayerVisibility(id, false)"),this.setLayerVisibility(e,0)},updateLayerLegend:function(e,o,n){t&&t.warn("[Legend] updateLayerLegend() avec JSON est d\xe9pr\xe9ci\xe9, utiliser loadLayerLegend"),this.addLayerLegend(e,o,n)},loadLegend:function(){return t&&t.warn("[Legend] loadLegend() est d\xe9pr\xe9ci\xe9"),Promise.resolve(0)},showLegend:function(){t&&t.warn("[Legend] showLegend() est d\xe9pr\xe9ci\xe9")},hideLegend:function(){n&&n.hide()},removeLegend:function(){u.forEach(e=>{e.legendData=null,e.visible=0}),n&&o&&(o.removeControl(n),n=null,t&&t.debug("[Legend] Toutes les l\xe9gendes supprim\xe9es"))},isLegendVisible:function(){return null!==n&&u.size>0},showLoadingOverlay:function(){!function(){if(!n||!n._container)return;!function(){if(document.getElementById("gl-legend-spinner-style"))return;const e=document.createElement("style");e.id="gl-legend-spinner-style",e.textContent="@keyframes gl-legend-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }",document.head.appendChild(e)}(),f();const e=n._container;if(e.style.position||(e.style.position="relative"),!s){const e=document.createElement("div");e.className="gl-map-legend__loading-overlay",e.style.position="absolute",e.style.inset="0",e.style.background="rgba(255,255,255,0.6)",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.pointerEvents="auto",e.style.zIndex="2",e.setAttribute("aria-hidden","false");const t=document.createElement("div");t.className="gl-map-legend__spinner",t.style.width="34px",t.style.height="34px",t.style.border="3px solid rgba(0,0,0,0.12)",t.style.borderTop="3px solid rgba(0,0,0,0.55)",t.style.borderRadius="50%",t.style.animation="gl-legend-spin 1s linear infinite",e.appendChild(t),s=e}s.parentElement||e.appendChild(s),e.setAttribute("aria-busy","true"),e.setAttribute("aria-live","polite"),c=setTimeout(()=>{c=null,p()},12e3)}()},hideLoadingOverlay:function(){p()}};GeoLeaf.Legend=g}(window)),Ye||(Ye=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log,o={createTooltipsForLayer(e,o,n,r,i){if(!o||!n||!n.labelId)return void(t&&t.warn("[LabelRenderer] Param\xe8tres invalides pour createTooltipsForLayer",{layerId:e,hasLeafletLayer:!!o,hasLabelConfig:!!n,labelId:n?.labelId,labelConfigKeys:n?Object.keys(n):null}));const a=n.labelId;t&&t.debug(`[LabelRenderer] Cr\xe9ation tooltips pour ${e}, champ: ${a}`);let l=0;o.eachLayer(e=>{l++;try{this._createTooltipForFeature(e,a,r,i)}catch(e){t&&t.warn("[LabelRenderer] Erreur cr\xe9ation tooltip:",e)}}),t&&t.debug(`[LabelRenderer] ${i.size} tooltips cr\xe9\xe9s pour ${e} (${l} features parcourues)`)},_createTooltipForFeature(o,n,r,i){const a=o.feature;if(!a||!a.properties)return void(t&&t.debug("[LabelRenderer] Feature ou properties manquant"));const l=this._extractFieldValue(a.properties,n);if(!l)return;let s=null;if("function"==typeof o.getLatLng)s=o.getLatLng();else if("function"==typeof o.getBounds){const e=o.getBounds();e&&"function"==typeof e.getCenter?(s=e.getCenter(),t&&t.info("[LabelRenderer] Position polygone calcul\xe9e:",{labelValue:l,position:s,positionType:typeof s,hasLat:"lat"in s,hasLng:"lng"in s,latType:typeof s.lat,lngType:typeof s.lng,positionKeys:Object.keys(s)})):t&&t.warn("[LabelRenderer] getBounds ne retourne pas getCenter pour:",l)}else if("function"==typeof o.getLatLngs){const e=o.getLatLngs();if(e&&e.length>0){const t=Array.isArray(e[0])?e[0]:e;t&&t.length>0&&(s=t[Math.floor(t.length/2)])}}if(!s)return void(t&&t.debug("[LabelRenderer] Position null pour feature, skipping label. Label:",l));const c="function"==typeof s.lat?s.lat():s.lat,u="function"==typeof s.lng?s.lng():s.lng;if(!c||!u||isNaN(c)||isNaN(u))return;const d=this._formatLabelContent(l,r),f=e.L.divIcon({html:d,className:this._buildClassName(r),iconSize:null,iconAnchor:[0,0]}),p=e.L.marker([c,u],{icon:f,interactive:0,keyboard:0}),g=GeoLeaf.Core&&GeoLeaf.Core.getMap?GeoLeaf.Core.getMap():null;if(g){p.addTo(g);const e=a.id||a.properties.id||`feature_${Date.now()}_${Math.random()}`;i.set(e,p)}else t&&t.warn("[LabelRenderer] Carte non disponible pour",l)},_extractFieldValue(e,t){if(!e||!t)return null;if(!t.includes("."))return e[t];const o=t.split(".");let n=e;for(const e of o){if(!n||"object"!=typeof n||!(e in n))return null;n=n[e]}return n},_parseOffset:e=>e&&Array.isArray(e)&&2===e.length?["number"==typeof e[0]?e[0]:0,"number"==typeof e[1]?e[1]:0]:[0,0],_buildClassName(e){const t=["gl-label"];return e&&(e.className&&t.push(e.className),e.variant&&t.push(`gl-label--${e.variant}`)),t.join(" ")},_formatLabelContent(t,o){if(!t)return"";let n=String(t);o&&(o.prefix&&(n=o.prefix+n),o.suffix&&(n+=o.suffix));const r=e.document.createElement("div");return r.className="gl-label__content",r.textContent=n,o&&this._applyInlineStyles(r,o),r.outerHTML},_applyInlineStyles(e,t){if(e&&t){if(t.font){if(t.font.family){const o=`"${t.font.family}", -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif`;e.style.setProperty("font-family",o,"important")}if(t.font.sizePt&&e.style.setProperty("font-size",`${t.font.sizePt}pt`,"important"),t.font.bold)e.style.setProperty("font-weight","bold","important");else if(t.font.weight){const o=t.font.weight<400?500:t.font.weight;e.style.setProperty("font-weight",o,"important")}t.font.italic&&e.style.setProperty("font-style","italic","important")}if(t.color&&e.style.setProperty("color",t.color,"important"),void 0!==t.opacity&&e.style.setProperty("opacity",t.opacity,"important"),t.buffer&&t.buffer.enabled){const o=t.buffer.color||"#ffffff",n=void 0!==t.buffer.opacity?t.buffer.opacity:1,r=t.buffer.sizePx||2,i=this._hexToRgba(o,n),a=[];for(let e=0;e<360;e+=30){const t=e*Math.PI/180,o=Math.cos(t)*r,n=Math.sin(t)*r;a.push(`${o.toFixed(2)}px ${n.toFixed(2)}px 0 ${i}`)}for(let e=15;e<360;e+=30){const t=e*Math.PI/180,o=Math.cos(t)*r*.7,n=Math.sin(t)*r*.7;a.push(`${o.toFixed(2)}px ${n.toFixed(2)}px 0 ${i}`)}a.push(`0 0 ${.8*r}px ${i}`),a.push(`0 0 ${1.5*r}px ${i}`),e.style.setProperty("text-shadow",a.join(", "),"important")}t.textTransform&&e.style.setProperty("text-transform",t.textTransform,"important")}},_hexToRgba:(e,t)=>e?(3===(e=e.replace("#","")).length&&(e=e.split("").map(e=>e+e).join("")),`rgba(${parseInt(e.substring(0,2),16)}, ${parseInt(e.substring(2,4),16)}, ${parseInt(e.substring(4,6),16)}, ${t})`):`rgba(0, 0, 0, ${t})`};GeoLeaf._LabelRenderer=o}(window)),Qe||(Qe=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log,o={createButton(o,n){if(!o||!n)return t&&t.warn("[LabelButtonManager] createButton: param\xe8tres manquants",{layerId:o,hasContainer:!!n}),null;const r=n.querySelector(".gl-layer-manager__label-toggle");if(r)return t&&t.debug("[LabelButtonManager] Bouton d\xe9j\xe0 existant pour:",o),r;t&&t.debug("[LabelButtonManager] Cr\xe9ation du bouton pour:",o);const i=e.L.DomUtil.create("button","gl-layer-manager__label-toggle");i.type="button",i.setAttribute("aria-label","Afficher/masquer les \xe9tiquettes"),i.disabled=1,i.classList.add("gl-layer-manager__label-toggle--disabled");const a=document.createElement("span");a.className="gl-layer-manager__label-toggle-icon",a.textContent="\u{1f3f7}\ufe0f",i.appendChild(a),i.title="Afficher/masquer les \xe9tiquettes";const l=function(n){if(e.L&&e.L.DomEvent&&e.L.DomEvent.stopPropagation(n),n.preventDefault(),!i.disabled)try{const n=e.GeoLeaf?.GeoJSON?.getLayerById?.(o);if(1!=n?.currentStyle?.label?.enabled)return void(t&&t.warn("[LabelButtonManager] Impossible d'afficher les labels: le style actuel a label.enabled=false"));e.GeoLeaf?.Labels?.toggleLabels&&(e.GeoLeaf.Labels.toggleLabels(o)?(i.classList.add("gl-layer-manager__label-toggle--on"),i.setAttribute("aria-pressed","true")):(i.classList.remove("gl-layer-manager__label-toggle--on"),i.setAttribute("aria-pressed","false")))}catch(e){t&&t.warn("[LabelButtonManager] Erreur lors du toggle des labels:",e)}};GeoLeaf._UIComponents&&"function"==typeof GeoLeaf._UIComponents.attachEventHandler?GeoLeaf._UIComponents.attachEventHandler(i,"click",l):e.L&&e.L.DomEvent?(e.L.DomEvent.on(i,"click",l),e.L.DomEvent.disableClickPropagation(i)):i.addEventListener("click",l);const s=n.querySelector(".gl-layer-manager__item-toggle");return s?n.insertBefore(i,s):n.appendChild(i),t&&t.debug("[LabelButtonManager] Bouton cr\xe9\xe9 avec succ\xe8s:",o),i},sync(e){if(!e)return;this._syncTimeouts&&this._syncTimeouts.has(e)&&clearTimeout(this._syncTimeouts.get(e)),this._syncTimeouts||(this._syncTimeouts=new Map);const t=setTimeout(()=>{this._syncTimeouts.delete(e),this._doSync(e)},300);this._syncTimeouts.set(e,t)},_doSync(e){if(!e)return;let o=document.querySelector(`[data-layer-id="${e}"] .gl-layer-manager__label-toggle`);if(!o){const n=document.querySelector(`[data-layer-id="${e}"]`);if(!n)return void(t&&t.debug("[LabelButtonManager] LayerItem non trouv\xe9 (pas encore rendu):",e));const r=n.querySelector(".gl-layer-manager__item-controls");if(!r)return void(t&&t.debug("[LabelButtonManager] Bouton et controlsContainer non trouv\xe9s pour:",e));o=r.querySelector(".gl-layer-manager__label-toggle"),o||(t&&t.debug("[LabelButtonManager] Bouton manquant dans controls, cr\xe9ation \xe0 la vol\xe9e pour:",e),o=this.createButton(e,r))}if(!o)return void(t&&t.debug("[LabelButtonManager] Bouton non trouv\xe9 apr\xe8s toutes tentatives:",e));const n=this._getState(e);this._applyState(o,n)},_getState(t){const o=e.GeoLeaf?.GeoJSON?.getLayerById?.(t);return{layerId:t,layerExists:!!o,layerVisible:1==o?._visibility?.current,labelEnabled:1==o?.currentStyle?.label?.enabled,areLabelsActive:e.GeoLeaf?.Labels?.areLabelsEnabled?.(t)||0}},_applyState(e,t){t.labelEnabled&&t.layerVisible?(e.disabled=0,e.classList.remove("gl-layer-manager__label-toggle--disabled"),t.areLabelsActive&&t.layerVisible?(e.classList.add("gl-layer-manager__label-toggle--on"),e.setAttribute("aria-pressed","true")):(e.classList.remove("gl-layer-manager__label-toggle--on"),e.setAttribute("aria-pressed","false"))):(e.disabled=1,e.classList.add("gl-layer-manager__label-toggle--disabled"),e.classList.remove("gl-layer-manager__label-toggle--on"),e.setAttribute("aria-pressed","false"))},syncImmediate(e){e&&(this._syncTimeouts&&this._syncTimeouts.has(e)&&(clearTimeout(this._syncTimeouts.get(e)),this._syncTimeouts.delete(e)),this._doSync(e))}};GeoLeaf._LabelButtonManager=o,t&&t.debug("[LabelButtonManager] Module initialis\xe9")}(window)),Ke||(Ke=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log,o=GeoLeaf.Utils&&GeoLeaf.Utils.ScaleUtils,n={layers:new Map,zoomListenerAttached:0},r={init(e={}){t&&t.debug("[Labels] Initialisation du module Labels"),this._attachLayerEvents(),t&&t.debug("[Labels] Module Labels initialis\xe9")},initializeLayerLabels(e){if(!e)return;const o=this._getLayerData(e);if(o){if(this._hideLabelsForLayer(e),n.layers.delete(e),1==o.currentStyle?.label?.enabled)return 1!=o.currentStyle.label.visibleByDefault?(t&&t.debug("[Labels.initialize] Labels d\xe9sactiv\xe9s par d\xe9faut pour",e),this.enableLabels(e,{},0)):1==o._visibility?.current?(t&&t.debug("[Labels.initialize] Initialisation labels visibles pour",e),this.enableLabels(e,{},1)):(t&&t.debug("[Labels.initialize] Labels configur\xe9s mais couche invisible pour",e),this.enableLabels(e,{},0));t&&t.debug("[Labels.initialize] Style sans labels ou labels d\xe9sactiv\xe9s pour",e)}},async enableLabels(e,o={},r=1){if(e){if(o&&o.styleFile){const t=`\u274c CONFIGURATION OBSOL\xc8TE D\xc9TECT\xc9E\n\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\nLa couche "${e}" utilise une r\xe9f\xe9rence obsol\xe8te \xe0 un fichier\nde labels s\xe9par\xe9 via "labelConfig.styleFile".\n\nGeoLeaf ne supporte plus les fichiers de labels s\xe9par\xe9s (styleLabel.json).\nLes labels doivent \xeatre int\xe9gr\xe9s dans les fichiers de style.\n\nValeur d\xe9tect\xe9e: ${o.styleFile}\nCouche: ${e}\n\nAction requise:\n1. Supprimez la propri\xe9t\xe9 "labels.styleFile" de la configuration\n2. Les labels sont maintenant extraits depuis layerData.currentStyle.label\n3. Consultez docs/STYLE_FORMAT_SPEC.md pour la syntaxe\n\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550`;throw console.error(t),new Error(`Configuration obsol\xe8te: labels.styleFile d\xe9tect\xe9 dans la couche ${e}`)}t&&t.debug("[Labels] Pr\xe9paration labels pour",e,"showImmediately:",r);try{const i=this._getLayerData(e);let a=null;if(i&&i.currentStyle&&i.currentStyle.label){const o=i.currentStyle.label;if(1!=o.enabled)return void(t&&t.debug("[Labels] Labels int\xe9gr\xe9s d\xe9sactiv\xe9s (enabled=false) pour",e));a=o,i.currentStyle.labelScale&&(a.labelScale=i.currentStyle.labelScale),t&&(t.debug("[Labels] Labels int\xe9gr\xe9s d\xe9tect\xe9s pour",e),t.debug("[Labels] labelScale:",a.labelScale))}else{if(!(o&&o.enabled&&o.labelId))return void(t&&t.debug("[Labels] Aucun label configur\xe9 pour",e));a={enabled:1,field:o.labelId,font:o.font||{family:"Arial",sizePt:10,weight:50,bold:0,italic:0},color:o.color||"#000000",opacity:o.opacity||1,buffer:o.buffer||{enabled:0},background:o.background||{enabled:0},offset:o.offset||{distancePx:0}},t&&t.debug("[Labels] Utilisation config legacy pour",e)}const l=void 0!==a.visibleByDefault?a.visibleByDefault:r;n.layers.set(e,{enabled:l,config:o,labelStyle:a,tooltips:new Map});let s=l;if(i){const o=i._visibility&&1==i._visibility.current;s=l&&o,l&&!o&&t&&t.debug("[Labels] Labels configur\xe9s pour affichage mais couche invisible:",e)}s&&await this._createLabelsForLayer(e),this._ensureZoomListener(),t&&t.debug("[Labels] Config labels pr\xe9par\xe9e pour",e,"visible:",r)}catch(e){t&&t.error("[Labels] Erreur pr\xe9paration labels:",e),console.error("[Labels] Stack trace:",e.stack)}}else t&&t.warn("[Labels] enableLabels: layerId manquant")},disableLabels(e){if(!e)return;const o=n.layers.get(e);o&&(t&&t.debug("[Labels] D\xe9sactivation des labels pour",e),o.tooltips&&(o.tooltips.forEach(e=>{try{e&&e.remove&&e.remove()}catch(e){}}),o.tooltips.clear()),o.enabled=0,t&&t.debug("[Labels] Labels d\xe9sactiv\xe9s pour",e))},_hideLabelsForLayer(e){if(!e)return;const o=n.layers.get(e);o&&(t&&t.debug("[Labels] Masquage temporaire des labels pour",e),o.tooltips&&(o.tooltips.forEach(e=>{try{e&&e.remove&&e.remove()}catch(e){}}),o.tooltips.clear()),t&&t.debug("[Labels] Labels masqu\xe9s (enabled reste:",o.enabled,")"))},toggleLabels(e){if(!e)return 0;const t=n.layers.get(e);if(!t)return 0;const o=this._getLayerData(e);return 1==o?.currentStyle?.label?.enabled?t.enabled?(this._hideLabelsForLayer(e),t.enabled=0,0):(t.enabled=1,this.refreshLabels(e),1):0},hasLabelConfig:e=>n.layers.has(e),areLabelsEnabled(e){const t=n.layers.get(e);return t?t.enabled:0},refreshLabels(e){if(!e)return;const o=n.layers.get(e);if(!o||!o.enabled)return;const r=this._getLayerData(e);r&&r._visibility&&r._visibility.current?(t&&t.debug("[Labels] Rafra\xeechissement des labels pour",e),o.tooltips&&(o.tooltips.forEach(e=>{try{e&&e.remove&&e.remove()}catch(e){}}),o.tooltips.clear()),this._createLabelsForLayer(e)):t&&t.debug("[Labels] Couche invisible, skip refresh pour",e)},async _createLabelsForLayer(e){const o=n.layers.get(e);if(!o||!o.enabled)return void(t&&t.debug("[Labels] _createLabelsForLayer: layerState non trouv\xe9 ou d\xe9sactiv\xe9 pour",e));const r=this._getLayerData(e);if(!r||!r._visibility||!r._visibility.current)return void(t&&t.debug("[Labels] Couche invisible, abandon cr\xe9ation labels pour",e));if(!r.layer)return void(t&&t.warn("[Labels] Couche GeoJSON non trouv\xe9e:",e));const{config:i,labelStyle:a}=o;t&&t.debug("[Labels] Cr\xe9ation labels pour",e,"labelStyle:",a);const l=GeoLeaf.Core&&GeoLeaf.Core.getMap?GeoLeaf.Core.getMap():null;if(l&&a.labelScale){const{minScale:o,maxScale:n}=a.labelScale;if(null!==o||null!==n){const r=this._calculateMapScale(l);if(t&&t.debug("[Labels] V\xe9rification \xe9chelle:",{currentScale:r,minScale:o,maxScale:n,visible:this._isScaleInRange(r,o,n)}),!this._isScaleInRange(r,o,n))return void(t&&t.debug("[Labels] \xc9chelle hors limites pour",e,`(\xe9chelle: 1:${r})`))}}else if(l&&void 0!==i.minZoom&&void 0!==i.maxZoom){const o=l.getZoom();if(o<i.minZoom||o>i.maxZoom)return void(t&&t.debug("[Labels] Zoom hors limites pour",e))}if(GeoLeaf._LabelRenderer){const n={labelId:a.field||i.labelId,minZoom:i.minZoom,maxZoom:i.maxZoom};t&&t.debug("[Labels] Appel renderer avec:",{layerId:e,labelId:n.labelId,hasLayer:!!r.layer,hasStyle:!!a}),GeoLeaf._LabelRenderer.createTooltipsForLayer(e,r.layer,n,a,o.tooltips),t&&t.debug("[Labels] Renderer termin\xe9, tooltips cr\xe9\xe9s:",o.tooltips.size)}else t&&t.error("[Labels] GeoLeaf._LabelRenderer non disponible!")},_getLayerData:e=>GeoLeaf.GeoJSON&&"function"==typeof GeoLeaf.GeoJSON.getLayerById?GeoLeaf.GeoJSON.getLayerById(e):(t&&t.warn("[Labels] GeoLeaf.GeoJSON non disponible"),null),_ensureZoomListener(){if(n.zoomListenerAttached)return;const e=GeoLeaf.Core&&GeoLeaf.Core.getMap?GeoLeaf.Core.getMap():null;e?(e.on("zoomend",()=>{const o=e.getZoom();t&&t.debug("[Labels] Zoom chang\xe9:",o),this._handleZoomChange({zoom:o})}),n.zoomListenerAttached=1,t&&t.debug("[Labels] \xc9couteur zoom attach\xe9 \xe0 la carte")):t&&t.warn("[Labels] Carte non disponible pour attacher l'\xe9couteur de zoom")},_attachLayerEvents(){"function"==typeof e.addEventListener&&e.addEventListener("geoleaf:layer-loaded",e=>{e.detail&&e.detail.layerId&&this._handleLayerLoaded(e.detail.layerId)})},_handleZoomChange(e){if(!e)return;const t=GeoLeaf.Core&&GeoLeaf.Core.getMap?GeoLeaf.Core.getMap():null;if(!t)return;const o=this._calculateMapScale(t);n.layers.forEach((n,r)=>{if(!n.enabled)return;const i=this._getLayerData(r);if(!i||!i._visibility||!i._visibility.current)return void(n.tooltips&&n.tooltips.size>0&&(n.tooltips.forEach(e=>{e&&e.remove&&e.remove()}),n.tooltips.clear()));const{labelStyle:a,config:l}=n;let s=1;if(a&&a.labelScale){const{minScale:e,maxScale:t}=a.labelScale;s=this._isScaleInRange(o,e,t)}else if(void 0!==l.minZoom&&void 0!==l.maxZoom){const o=void 0!==e.zoom?e.zoom:t.getZoom(),n=l.minZoom,r=l.maxZoom;s=o>=n&&o<=r}const c=n.tooltips&&n.tooltips.size>0;s&&!c?this._createLabelsForLayer(r):!s&&c&&(n.tooltips.forEach(e=>{e&&e.remove&&e.remove()}),n.tooltips.clear())})},async _handleLayerLoaded(e){const t=n.layers.get(e);t&&t.enabled&&await this._createLabelsForLayer(e)},_getProfileId:()=>GeoLeaf.Config&&"function"==typeof GeoLeaf.Config.get&&GeoLeaf.Config.get("id")||"default",_calculateMapScale(e){if(o&&"function"==typeof o.calculateMapScale)return o.calculateMapScale(e,{logger:t});if(!e)return 0;const n=e.getCenter(),r=e.getZoom(),i=156543.04*Math.cos(n.lat*Math.PI/180)/Math.pow(2,r)*96,a=Math.round(i/.0254);return t&&t.debug(`[Labels] Calcul \xe9chelle (fallback): zoom=${r}, lat=${n.lat.toFixed(2)}, \xe9chelle=1:${a.toLocaleString()}`),a},_isScaleInRange:(e,n,r)=>o&&"function"==typeof o.isScaleInRange?o.isScaleInRange(e,n,r,t):"number"==typeof n&&e>n?(t&&t.debug(`[Labels] Test \xe9chelle (fallback): ${e} > minScale ${n} \u2192 \u2717 CACH\xc9 (trop d\xe9zoom\xe9)`),0):"number"==typeof r&&e<r?(t&&t.debug(`[Labels] Test \xe9chelle (fallback): ${e} < maxScale ${r} \u2192 \u2717 CACH\xc9 (trop zoom\xe9)`),0):(t&&t.debug(`[Labels] Test \xe9chelle (fallback): ${e} dans [${r} - ${n}] \u2192 \u2713 VISIBLE`),1),destroy(){t&&t.debug("[Labels] Destruction du module Labels"),n.layers.forEach((e,t)=>{this.disableLabels(t)}),n.layers.clear()}};GeoLeaf.Labels=r}(window)),et||(et=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log,o=new Map,n=new Map,r={loadThemesConfig(e){if(t&&t.debug("[ThemeLoader] loadThemesConfig appel\xe9 pour:",e),o.has(e))return t&&t.debug("[ThemeLoader] Config en cache pour:",e),Promise.resolve(o.get(e));if(n.has(e))return t&&t.debug("[ThemeLoader] Chargement d\xe9j\xe0 en cours pour:",e),n.get(e);const r=`${window.location.pathname.includes("/demo/")?"../":""}profiles/${e}/themes.json`,i=GeoLeaf.Utils?.FetchHelper;let a;return a=i?i.get(r,{timeout:8e3,retries:1,parseResponse:1}).then(i=>{t&&t.debug("[ThemeLoader] Fichier charg\xe9:",r);const a=this._validateConfig(i);return o.set(e,a),n.delete(e),a}).catch(o=>{throw t&&t.warn("[ThemeLoader] Erreur chargement themes.json:",o.message),n.delete(e),o}):fetch(r).then(e=>{if(!e.ok)throw new Error(`Erreur HTTP ${e.status} lors du chargement de ${r}`);return e.json()}).then(i=>{t&&t.debug("[ThemeLoader] Fichier charg\xe9:",r);const a=this._validateConfig(i);return o.set(e,a),n.delete(e),a}).catch(o=>{throw t&&t.warn("[ThemeLoader] Erreur chargement themes.json:",o.message),n.delete(e),o}),n.set(e,a),a},_validateConfig(e){if(!e||"object"!=typeof e)throw new Error("Configuration de th\xe8mes invalide");const o={config:{primaryThemes:{enabled:1,position:"top-map",...e.config?.primaryThemes||{}},secondaryThemes:{enabled:1,placeholder:"S\xe9lectionner un th\xe8me...",showNavigationButtons:1,position:"top-layermanager",...e.config?.secondaryThemes||{}}},themes:[],defaultTheme:e.defaultTheme||null};if(!Array.isArray(e.themes))return t&&t.warn("[ThemeLoader] Aucun th\xe8me d\xe9fini dans la configuration"),o;if(o.themes=e.themes.map(e=>e.id?{id:e.id,label:e.label||e.id,type:e.type||"secondary",description:e.description||"",icon:e.icon||"",layers:Array.isArray(e.layers)?e.layers:[]}:(t&&t.warn("[ThemeLoader] Th\xe8me sans ID ignor\xe9"),null)).filter(Boolean),0===o.themes.length)throw new Error("Aucun th\xe8me valide trouv\xe9 dans la configuration");return o.defaultTheme?o.themes.some(e=>e.id===o.defaultTheme)||(t&&t.warn("[ThemeLoader] defaultTheme introuvable, utilisation du premier th\xe8me"),o.defaultTheme=o.themes[0].id):o.defaultTheme=o.themes[0].id,t&&t.debug("[ThemeLoader] Configuration valid\xe9e:",o.themes.length,"th\xe8mes"),o},clearCache(e){e?(o.delete(e),n.delete(e),t&&t.debug("[ThemeLoader] Cache vid\xe9 pour:",e)):(o.clear(),n.clear(),t&&t.debug("[ThemeLoader] Cache complet vid\xe9"))}};GeoLeaf._ThemeLoader=r}(window)),tt||(tt=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t={_currentThemeId:null,_isFirstLoad:1,_init(){this._pendingLayerConfigs=new Map,this._pendingCheckTimer=null},_cleanup(){this._pendingCheckTimer&&(clearTimeout(this._pendingCheckTimer),this._pendingCheckTimer=null),this._pendingLayerConfigs&&this._pendingLayerConfigs.clear()},applyTheme(e,t={}){if(this._pendingLayerConfigs||this._init(),GeoLeaf.Legend&&"function"==typeof GeoLeaf.Legend.showLoadingOverlay&&GeoLeaf.Legend.showLoadingOverlay(),!e||!e.id)return Promise.reject(new Error("Th\xe8me invalide"));if(!GeoLeaf.GeoJSON||!GeoLeaf.LayerManager)return Promise.reject(new Error("Modules GeoJSON ou LayerManager non disponibles"));try{document.dispatchEvent(new CustomEvent("geoleaf:theme:applying",{detail:{themeId:e.id,themeName:e.name||e.label||e.id}}))}catch(e){}this._hideAllLayers();const o=e.layers||[],n=GeoLeaf.Config?.Profile?.getActiveProfileConfig(),r=n?.performance||{},i=o.filter(e=>0!=e.visible);o.filter(e=>0==e.visible);const a=r.themeBatchSize||3,l=e=>{try{"undefined"!=typeof window&&window._glLoadingScreen&&"function"==typeof window._glLoadingScreen.updateProgress&&window._glLoadingScreen.updateProgress(e)}catch(e){}},s=this;return(async e=>{for(let t=0;t<e.length;t+=a){const o=e.slice(t,t+a);await Promise.all(o.map(e=>this._applyLayerConfig(e))),0===t&&l(98)}})(i).then(()=>(l(98),Promise.resolve())).then(()=>{l(99),s._currentThemeId=e.id,GeoLeaf.LayerManager&&GeoLeaf.LayerManager.refresh&&GeoLeaf.LayerManager.refresh(),s._syncLegendVisibility();try{const t=new CustomEvent("geoleaf:theme:applied",{detail:{themeId:e.id,themeName:e.name||e.label||e.id,layerCount:i.length,totalLayersInTheme:o.length,timestamp:(new Date).toISOString()}});document.dispatchEvent(t)}catch(e){}(1==t.fitBounds||(s._isFirstLoad,0))&&(setTimeout(()=>{s._fitBoundsOnAllLayers()},1e3),s._isFirstLoad=0)}).catch(e=>{throw e}).finally(()=>{GeoLeaf.Legend&&"function"==typeof GeoLeaf.Legend.hideLoadingOverlay&&GeoLeaf.Legend.hideLoadingOverlay()})},getCurrentThemeId(){return this._currentThemeId}};GeoLeaf._ThemeApplier=t}(window)),ot||(ot=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log,o=GeoLeaf._ThemeApplier;o._hideAllLayers=function(){if(!GeoLeaf._GeoJSONShared?.state?.layers)return;const e=GeoLeaf._LayerVisibilityManager;e&&(e.resetAllUserOverrides(),GeoLeaf._GeoJSONShared.state.layers.forEach((t,o)=>{e.setVisibility(o,0,e.VisibilitySource.THEME)}))},o._applyLayerConfig=function(e){if(!e?.id)return Promise.resolve();const t=e.id,n=0!=e.visible,r=e.style?String(e.style).trim():void 0;let i=GeoLeaf._GeoJSONShared?.state?.layers?.get(t);return i?o._setLayerVisibilityAndStyle(t,n,r):o._loadLayerFromProfile(t).then(e=>e?o._setLayerVisibilityAndStyle(t,n,r):o._scheduleLayerConfig(t,n,r))},o._setLayerVisibilityAndStyle=function(e,n,r){const i=GeoLeaf._GeoJSONShared?.state?.layers?.get(e);if(!i)return Promise.resolve();const a=GeoLeaf._LayerVisibilityManager;if(!a)return Promise.resolve();if(n){if(a.setVisibility(e,1,a.VisibilitySource.THEME),r&&GeoLeaf._GeoJSONLayerManager?.setLayerStyle){const n=i.config?.styles?.available||[];let a=r,l=n.some(e=>e.id===r);if(!l){const e={default:"d\xe9faut",d\u00e9faut:"default"}[r];e&&n.some(t=>t.id===e)&&(a=e,l=1)}if(l){const l=n.find(e=>e.id===a)?.file;if(l){let n="default";if(GeoLeaf.Config&&"function"==typeof GeoLeaf.Config.getActiveProfile){const e=GeoLeaf.Config.getActiveProfile();n=e?.id||"default"}const s=i._layerDirectory||e,c=GeoLeaf._StyleLoader;return c?c.loadAndValidateStyle(n,e,a,l,`layers/${s}`).then(t=>{const n=t.styleData;GeoLeaf._GeoJSONLayerManager.setLayerStyle(e,n);const i=GeoLeaf._GeoJSONShared?.state?.layers?.get(e);return i&&(i.currentStyle=n),GeoLeaf.Labels&&"function"==typeof GeoLeaf.Labels.initializeLayerLabels&&GeoLeaf.Labels.initializeLayerLabels(e),GeoLeaf._LabelButtonManager&&GeoLeaf._LabelButtonManager.syncImmediate(e),GeoLeaf.LayerManager&&"function"==typeof GeoLeaf.LayerManager.refresh&&GeoLeaf.LayerManager.refresh(),GeoLeaf._LayerManagerStyleSelector&&GeoLeaf._LayerManagerStyleSelector.setCurrentStyle(e,r),o._updateStyleSelector(e,r),o._loadLegendForStyle(e,r),t}).catch(()=>{}):(t&&t.error("[ThemeApplier] GeoLeaf._StyleLoader non disponible"),Promise.resolve())}}}}else a.setVisibility(e,0,a.VisibilitySource.THEME),GeoLeaf.Labels&&GeoLeaf.Labels.disableLabels(e),GeoLeaf._LabelButtonManager&&GeoLeaf._LabelButtonManager.syncImmediate(e);return Promise.resolve()}}(window)),nt||(nt=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf._ThemeApplier;t._scheduleLayerConfig=function(e,o,n){return t._pendingLayerConfigs||(t._pendingLayerConfigs=new Map),t._pendingLayerConfigs.set(e,{visible:o,styleId:n}),t._schedulePendingCheck(),Promise.resolve()},t._schedulePendingCheck=function(){t._pendingCheckTimer||(t._pendingCheckTimer=setTimeout(()=>{t._checkPendingLayerConfigs(),t._pendingCheckTimer=null},1e3))},t._checkPendingLayerConfigs=function(){if(!t._pendingLayerConfigs||0===t._pendingLayerConfigs.size)return;const e=[];for(const[o,n]of t._pendingLayerConfigs){const r=GeoLeaf._GeoJSONShared?.state?.layers?.get(o);r&&(t._setLayerVisibilityAndStyle(o,n.visible,n.styleId),e.push(o))}e.forEach(e=>{t._pendingLayerConfigs.delete(e)}),t._pendingLayerConfigs.size>0&&t._schedulePendingCheck()},t._loadLayerFromProfile=async function(e){const o=GeoLeaf.Config;if(!o||"function"!=typeof o.getActiveProfile)return null;try{const n=o.getActiveProfile();if(!n||"object"!=typeof n)return null;const r=n.id||null;let i=[];if(Array.isArray(n.geojsonLayers)?i=n.geojsonLayers:n.geojson&&Array.isArray(n.geojson.layers)?i=n.geojson.layers:Array.isArray(n.layers)?i=n.layers:Array.isArray(n.Layers)&&(i=n.Layers),!Array.isArray(i)||0===i.length)return null;const a=i.find(t=>t.id===e);if(!a)return null;const l=t._resolveDataFilePath(a);if(!l)return null;const s=a.label||e,c={},u=GeoLeaf._GeoJSONLoader?._loadSingleLayer;if(!u)return null;let d=null;GeoLeaf.ThemeCache?.get&&(d=await GeoLeaf.ThemeCache.get(e,r));const f={...a,url:l,type:a.geometryType||a.type||"geojson",_profileId:r,_layerDirectory:a._layerDirectory},p={...f};f.popup&&f.popup.fields&&(p.popupFields=f.popup.fields),f.tooltip&&f.tooltip.fields&&(p.tooltipFields=f.tooltip.fields),f.sidepanel&&f.sidepanel.detailLayout&&(p.sidepanelFields=f.sidepanel.detailLayout),d&&(p._cachedData=d);try{const t=await u.call(GeoLeaf._GeoJSONLoader,e,s,p,c);return d&&GeoLeaf.ThemeCache?.store&&GeoLeaf.ThemeCache.store(e,r,d),t}catch(e){return null}}catch(e){return null}},t._resolveDataFilePath=function(e){if(!e.dataFile||!e._layerDirectory)return null;const o=GeoLeaf.Config;if(!o||!o.getActiveProfile)return null;const n=o.getActiveProfile();if(!n)return null;const r=n.id;return`${t._getProfilesBasePath(n)}/${r}/${e._layerDirectory}/${e.dataFile}`},t._getProfilesBasePath=function(e){const o=GeoLeaf.Config,n=o?.get?.("data.profilesBasePath");return"string"==typeof n&&n.trim().length>0?t._normalizeBasePath(n):e&&"string"==typeof e.profilesBasePath?t._normalizeBasePath(e.profilesBasePath):"profiles"},t._normalizeBasePath=function(e){const t=e.trim();return t.endsWith("/")?t.slice(0,-1):t}}(window)),rt||(rt=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf._ThemeApplier;t._updateStyleSelector=function(e,t){const o="style-selector-"+e,n=document.getElementById(o);n&&(n.value=t)},t._loadLegendForStyle=function(e,t){if(!GeoLeaf.Legend||"function"!=typeof GeoLeaf.Legend.loadLayerLegend)return;const o=GeoLeaf._GeoJSONShared?.state?.layers,n=o instanceof Map?o.get(e):o?.[e];n&&n.config&&GeoLeaf.Legend.loadLayerLegend(e,t,n.config)},t._fitBoundsOnAllLayers=function(){const t=GeoLeaf.Core?.getMap();if(!t)return;window._glLoadingScreen&&"function"==typeof window._glLoadingScreen.updateProgress&&window._glLoadingScreen.updateProgress(99);const o=e.L.featureGroup();let n=0;if(GeoLeaf._GeoJSONShared?.state?.layers&&GeoLeaf._GeoJSONShared.state.layers.forEach(e=>{if(e.layer)try{o.addLayer(e.layer),n++}catch(e){}}),GeoLeaf._POIShared?.state?.markerLayer)try{o.addLayer(GeoLeaf._POIShared.state.markerLayer),n++}catch(e){}if(GeoLeaf.Route?.getLayerGroup)try{const e=GeoLeaf.Route.getLayerGroup();e&&(o.addLayer(e),n++)}catch(e){}if(n>0){const e=o.getBounds();if(e.isValid()){const o=document.getElementById("geoleaf-map")||document.querySelector(".leaflet-container")?.parentElement;o&&(o.style.opacity="1"),t.fitBounds(e,{maxZoom:12,padding:[50,50],animate:0}),setTimeout(()=>{try{const e=new CustomEvent("geoleaf:map:ready",{detail:{time:Date.now()}});document.dispatchEvent(e)}catch(e){}},800)}}},t._syncLegendVisibility=function(){if(!GeoLeaf.Legend||"function"!=typeof GeoLeaf.Legend.setLayerVisibility)return;if(!GeoLeaf._GeoJSONShared?.state?.layers)return;const e=GeoLeaf._LayerVisibilityManager;e&&GeoLeaf._GeoJSONShared.state.layers.forEach((t,o)=>{const n=e.getVisibilityState(o),r=n?n.current:t.visible;GeoLeaf.Legend.setLayerVisibility(o,r)})}}(window)),it||(it=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log,o=(e,t,...o)=>GeoLeaf.Utils&&GeoLeaf.Utils.createElement?GeoLeaf.Utils.createElement(e,t,...o):document.createElement(e),n={initialized:0,profileId:null,config:null,themes:[],primaryThemes:[],secondaryThemes:[],currentTheme:null,primaryContainer:null,secondaryContainer:null,dropdown:null,_eventCleanups:[]},r={init(e){return e&&e.profileId?(t&&t.debug("[ThemeSelector] Initialisation pour profil:",e.profileId),n.profileId=e.profileId,n.primaryContainer=e.primaryContainer||null,n.secondaryContainer=e.secondaryContainer||null,GeoLeaf._ThemeLoader?GeoLeaf._ThemeLoader.loadThemesConfig(e.profileId).then(e=>(n.config=e.config,n.themes=e.themes,n.primaryThemes=e.themes.filter(e=>"primary"===e.type),n.secondaryThemes=e.themes.filter(e=>"secondary"===e.type),n.currentTheme=e.defaultTheme,t&&t.debug("[ThemeSelector] Configuration charg\xe9e:",{total:n.themes.length,primary:n.primaryThemes.length,secondary:n.secondaryThemes.length}),this._createUI(),n.initialized=1,this.setTheme(n.currentTheme))).then(()=>{t&&t.debug("[ThemeSelector] Initialisation termin\xe9e");const e=new CustomEvent("geoleaf:themes:ready",{detail:{time:Date.now()}});document.dispatchEvent(e)}).catch(e=>{t&&t.warn("[ThemeSelector] Erreur initialisation:",e.message);const o=new CustomEvent("geoleaf:themes:ready",{detail:{time:Date.now(),error:e.message}});throw document.dispatchEvent(o),e}):Promise.reject(new Error("Module _ThemeLoader non disponible"))):Promise.reject(new Error("profileId requis pour ThemeSelector.init"))},_createUI(){const e=GeoLeaf.Config&&GeoLeaf.Config.get?GeoLeaf.Config.get("ui"):null;e&&1==e.showThemeSelector?(n.config.primaryThemes.enabled&&n.primaryContainer&&this._createPrimaryUI(),n.config.secondaryThemes.enabled&&n.secondaryContainer&&this._createSecondaryUI()):t&&t.debug("[ThemeSelector] showThemeSelector est false, UI non cr\xe9\xe9e")},_createPrimaryUI(){n.primaryContainer&&(GeoLeaf.DOMSecurity.clearElementFast(n.primaryContainer),n.primaryContainer.classList.add("gl-theme-selector-primary"),n.primaryThemes.forEach(t=>{const o=e.L.DomUtil.create("button","gl-theme-btn",n.primaryContainer);o.type="button",o.dataset.themeId=t.id,o.title=t.description||t.label,e.L.DomUtil.create("span","gl-theme-btn__icon",o).textContent=t.icon||"\u{1f4cd}",e.L.DomUtil.create("span","gl-theme-btn__label",o).textContent=t.label,t.id===n.currentTheme&&o.classList.add("gl-theme-btn--active"),this._attachPrimaryButtonHandler(o,t)}),t&&t.debug("[ThemeSelector] UI primaire cr\xe9\xe9e:",n.primaryThemes.length,"boutons"))},_attachPrimaryButtonHandler(t,o){const r=t=>{e.L&&e.L.DomEvent&&e.L.DomEvent.stopPropagation(t),t.preventDefault(),this.setTheme(o.id)},i=GeoLeaf.Utils?.events;e.L&&e.L.DomEvent?(e.L.DomEvent.on(t,"click",r),e.L.DomEvent.disableClickPropagation(t),n._eventCleanups.push(()=>{e.L&&e.L.DomEvent&&e.L.DomEvent.off(t,"click",r)})):i?n._eventCleanups.push(i.on(t,"click",r,0,"ThemeSelector.primaryButton")):t.addEventListener("click",r)},_createSecondaryUI(){if(!n.secondaryContainer)return void(t&&t.warn("[ThemeSelector] Conteneur secondaire introuvable"));t&&t.debug("[ThemeSelector] Cr\xe9ation UI secondaire:",n.secondaryThemes.length,"th\xe8mes"),t&&t.debug("[ThemeSelector] IDs des th\xe8mes secondaires:",n.secondaryThemes.map(e=>e.id)),GeoLeaf.DOMSecurity.clearElementFast(n.secondaryContainer),n.secondaryContainer.classList.add("gl-theme-selector-secondary");const r=e.L.DomUtil.create("div","gl-theme-selector-secondary__wrapper",n.secondaryContainer);if(n.config.secondaryThemes.showNavigationButtons){const t=e.L.DomUtil.create("button","gl-theme-nav gl-theme-nav--prev",r);t.type="button",t.textContent="\u25c0",t.title="Th\xe8me pr\xe9c\xe9dent",this._attachNavButtonHandler(t,"prev")}const i=e.L.DomUtil.create("select","gl-theme-dropdown",r);n.dropdown=i;const a=o("option",{value:"",textContent:n.config.secondaryThemes.placeholder,disabled:1});i.appendChild(a),n.secondaryThemes.forEach(e=>{const t=o("option",{value:e.id,textContent:e.label});i.appendChild(t)});const l=n.secondaryThemes.some(e=>e.id===n.currentTheme);if(i.value=l?n.currentTheme:"",this._attachDropdownHandler(i),n.config.secondaryThemes.showNavigationButtons){const t=e.L.DomUtil.create("button","gl-theme-nav gl-theme-nav--next",r);t.type="button",t.textContent="\u25b6",t.title="Th\xe8me suivant",this._attachNavButtonHandler(t,"next")}t&&t.debug("[ThemeSelector] UI secondaire cr\xe9\xe9e:",n.secondaryThemes.length,"th\xe8mes")},_attachDropdownHandler(o){const r=n=>{e.L&&e.L.DomEvent&&e.L.DomEvent.stopPropagation(n);const r=o.value;t&&t.info(`[ThemeSelector] Dropdown chang\xe9: ${r}`),r?this.setTheme(r):t&&t.warn("[ThemeSelector] Dropdown: themeId vide")},i=GeoLeaf.Utils?.events;e.L&&e.L.DomEvent?(e.L.DomEvent.on(o,"change",r),e.L.DomEvent.disableClickPropagation(o),n._eventCleanups.push(()=>{e.L&&e.L.DomEvent&&e.L.DomEvent.off(o,"change",r)})):i?n._eventCleanups.push(i.on(o,"change",r,0,"ThemeSelector.dropdown")):o.addEventListener("change",r),t&&t.debug("[ThemeSelector] Gestionnaire dropdown attach\xe9")},_attachNavButtonHandler(t,o){const r=t=>{e.L&&e.L.DomEvent&&e.L.DomEvent.stopPropagation(t),t.preventDefault(),"next"===o?this.nextTheme():this.previousTheme()},i=GeoLeaf.Utils?.events;e.L&&e.L.DomEvent?(e.L.DomEvent.on(t,"click",r),e.L.DomEvent.disableClickPropagation(t),n._eventCleanups.push(()=>{e.L&&e.L.DomEvent&&e.L.DomEvent.off(t,"click",r)})):i?n._eventCleanups.push(i.on(t,"click",r,0,"ThemeSelector.navButton")):t.addEventListener("click",r)},setTheme(e){if(!n.initialized)return Promise.reject(new Error("ThemeSelector non initialis\xe9"));const o=n.themes.find(t=>t.id===e);return o?(t&&t.debug("[ThemeSelector] setTheme:",e),GeoLeaf._ThemeApplier?GeoLeaf._ThemeApplier.applyTheme(o).then(()=>{n.currentTheme=e,this._updateUIState(e),t&&t.debug("[ThemeSelector] Th\xe8me activ\xe9:",e)}).catch(e=>{throw t&&t.warn("[ThemeSelector] Erreur activation th\xe8me:",e.message),e}):Promise.reject(new Error("Module _ThemeApplier non disponible"))):Promise.reject(new Error(`Th\xe8me introuvable: ${e}`))},_updateUIState(e){if(n.primaryContainer&&n.primaryContainer.querySelectorAll(".gl-theme-btn").forEach(t=>{t.dataset.themeId===e?t.classList.add("gl-theme-btn--active"):t.classList.remove("gl-theme-btn--active")}),n.dropdown){const t=n.secondaryThemes.some(t=>t.id===e);n.dropdown.value=t?e:""}},nextTheme(){if(!n.initialized||0===n.secondaryThemes.length)return;let e=0;n.secondaryThemes.some(e=>e.id===n.currentTheme)&&(e=(n.secondaryThemes.findIndex(e=>e.id===n.currentTheme)+1)%n.secondaryThemes.length);const t=n.secondaryThemes[e];t&&this.setTheme(t.id)},previousTheme(){if(!n.initialized||0===n.secondaryThemes.length)return;const e=n.secondaryThemes.some(e=>e.id===n.currentTheme);let t=n.secondaryThemes.length-1;e&&(t=(n.secondaryThemes.findIndex(e=>e.id===n.currentTheme)-1+n.secondaryThemes.length)%n.secondaryThemes.length);const o=n.secondaryThemes[t];o&&this.setTheme(o.id)},getCurrentTheme:()=>n.currentTheme,getThemes:()=>n.themes,getPrimaryThemes:()=>n.primaryThemes,getSecondaryThemes:()=>n.secondaryThemes,isInitialized:()=>n.initialized,destroy(){t&&t.debug("[ThemeSelector] Cleaning up event listeners"),n._eventCleanups&&(n._eventCleanups.forEach(e=>{"function"==typeof e&&e()}),n._eventCleanups=[]),n.initialized=0}};GeoLeaf.ThemeSelector=r}(window)),at||(at=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log;function o(e,t){if("number"==typeof e)return e;if("string"!=typeof e)return 300;if(e.endsWith("%"))return t*parseFloat(e)/100;if(e.endsWith("px"))return parseFloat(e);if(e.endsWith("vh")){const t=parseFloat(e);return window.innerHeight*t/100}return 300}function n(e){if(t.debug("[TablePanel] populateLayerSelector appel\xe9"),!GeoLeaf.GeoJSON||"function"!=typeof GeoLeaf.GeoJSON.getAllLayers)return void t.warn("[TablePanel] Module GeoJSON non disponible");const o=GeoLeaf.GeoJSON.getAllLayers();if(t.debug("[TablePanel] getAllLayers retourne:",o.length,"couches"),0===o.length)return void t.debug("[TablePanel] Aucune couche charg\xe9e, le s\xe9lecteur sera rafra\xeechi par l'\xe9v\xe9nement layers-loaded");const n=GeoLeaf._LayerVisibilityManager,r=new Set;for(let t=1;t<e.options.length;t++)r.add(e.options[t].value);let i=0;o.forEach(o=>{const a=GeoLeaf.GeoJSON.getLayerData(o.id);if(t.debug("[TablePanel] V\xe9rification couche:",o.id,"table enabled:",a?.config?.table?.enabled),a&&a.config&&a.config.table&&a.config.table.enabled){let l=1;if(n&&"function"==typeof n.getVisibilityState){const e=n.getVisibilityState(o.id);l=e&&1==e.current}else a._visibility&&(l=1==a._visibility.current);if(!l)return void t.debug("[TablePanel] Couche",o.id,"masqu\xe9e, ignor\xe9e dans le s\xe9lecteur");if(!r.has(o.id)){const t=document.createElement("option");t.value=o.id,t.textContent=o.label||o.id,e.appendChild(t),i++}}}),i>0&&t.info("[TablePanel] S\xe9lecteur de couche peupl\xe9:",i,"couches ajout\xe9es")}function r(e,t,o){const n=document.createElement("button");if(n.className="gl-table-panel__btn",n.textContent=e,t&&n.classList.add("gl-table-panel__btn--"+t),o){const e=GeoLeaf.Utils?.events;e?GeoLeaf._TablePanel._eventCleanups.push(e.on(n,"click",o,0,"TablePanel.button")):n.addEventListener("click",o)}return n}GeoLeaf._TablePanel=GeoLeaf._TablePanel||{},GeoLeaf._TablePanel._eventCleanups=[],GeoLeaf._TablePanel.create=function(e,i){let a=document.querySelector(".gl-table-panel");if(a)return t.debug("[TablePanel] Conteneur existant r\xe9utilis\xe9"),a;if(a=document.createElement("div"),a.className="gl-table-panel",a.style.height=i.defaultHeight||"40%",i.resizable){const e=function(e,t){const n=document.createElement("div");n.className="gl-table-panel__resize-handle";const r=document.createElement("div");r.className="gl-table-panel__resize-bar",n.appendChild(r);let i=0,a=0,l=0;const s=GeoLeaf.Utils?.events,c=t=>{i=1,a=t.clientY,l=e.offsetHeight,document.body.style.cursor="ns-resize",document.body.style.userSelect="none",t.preventDefault()},u=n=>{if(!i)return;const r=a-n.clientY;let s=l+r;const c=window.innerHeight,u=o(t.minHeight||"20%",c),d=o(t.maxHeight||"80%",c);s=Math.max(u,Math.min(d,s)),e.style.height=s+"px"},d=()=>{i&&(i=0,document.body.style.cursor="",document.body.style.userSelect="")};return s?(GeoLeaf._TablePanel._eventCleanups.push(s.on(n,"mousedown",c,0,"TablePanel.resizeMouseDown")),GeoLeaf._TablePanel._eventCleanups.push(s.on(document,"mousemove",u,0,"TablePanel.resizeMouseMove")),GeoLeaf._TablePanel._eventCleanups.push(s.on(document,"mouseup",d,0,"TablePanel.resizeMouseUp"))):(n.addEventListener("mousedown",c),document.addEventListener("mousemove",u),document.addEventListener("mouseup",d)),n}(a,i);a.appendChild(e)}const l=function(e,o){const i=document.createElement("div");i.className="gl-table-panel__toolbar";const a=function(){const e=document.createElement("div");e.className="gl-table-panel__layer-selector";const o=document.createElement("select");o.id="geoleaf-table-layer-selector",o.name="geoleaf-table-layer-selector",o.className="gl-table-panel__select",o.setAttribute("data-table-layer-select","");const r=document.createElement("option");r.value="",r.textContent="S\xe9lectionner une couche...",o.appendChild(r),n(o);const i=e=>{const o=e.target.value;t.debug("[TablePanel] S\xe9lecteur chang\xe9, layerId:",o),t.debug("[TablePanel] GeoLeaf.Table existe:",!!GeoLeaf.Table),t.debug("[TablePanel] setLayer existe:",typeof GeoLeaf.Table?.setLayer),GeoLeaf.Table&&"function"==typeof GeoLeaf.Table.setLayer?GeoLeaf.Table.setLayer(o):t.error("[TablePanel] GeoLeaf.Table.setLayer non disponible!")},a=GeoLeaf.Utils?.events;return a?GeoLeaf._TablePanel._eventCleanups.push(a.on(o,"change",i,0,"TablePanel.layerSelect")):o.addEventListener("change",i),t.debug("[TablePanel] \xc9v\xe9nement 'change' attach\xe9 au s\xe9lecteur"),e.appendChild(o),e}();i.appendChild(a);const l=function(){const e=document.createElement("div");e.className="gl-table-panel__search";const t=document.createElement("input");return t.type="text",t.id="geoleaf-table-search-input",t.name="geoleaf-table-search-input",t.placeholder="Rechercher...",t.className="gl-table-panel__search-input",t.setAttribute("data-table-search",""),e.appendChild(t),e}();i.appendChild(l);const s=r("Zoom sur s\xe9lection","zoom",()=>{GeoLeaf.Table&&"function"==typeof GeoLeaf.Table.zoomToSelection&&GeoLeaf.Table.zoomToSelection()});s.disabled=1,s.setAttribute("data-table-btn","zoom"),i.appendChild(s);const c=r("Surbrillance","highlight",()=>{const e=c.classList.toggle("is-active");GeoLeaf.Table&&"function"==typeof GeoLeaf.Table.highlightSelection&&GeoLeaf.Table.highlightSelection(e)});if(c.disabled=1,c.setAttribute("data-table-btn","highlight"),i.appendChild(c),o.enableExportButton){const e=r("Exporter","export",()=>{GeoLeaf.Table&&"function"==typeof GeoLeaf.Table.exportSelection&&GeoLeaf.Table.exportSelection()});e.disabled=1,e.setAttribute("data-table-btn","export"),i.appendChild(e)}const u=document.createElement("div");u.style.flex="1",i.appendChild(u);const d=function(){const e=document.createElement("button");e.className="gl-table-panel__toggle-btn",e.title="Masquer le tableau",e.setAttribute("aria-label","Masquer tableau");const t=document.createElement("span");t.className="gl-table-panel__toggle-btn__icon";const o=GeoLeaf.DOMSecurity.createSVGIcon(16,16,"M6 9l6 6 6-6",{stroke:"currentColor",strokeWidth:"6",fill:"none"});t.appendChild(o),e.appendChild(t);const n=()=>{GeoLeaf.Table&&"function"==typeof GeoLeaf.Table.toggle&&GeoLeaf.Table.toggle()},r=GeoLeaf.Utils?.events;return r?GeoLeaf._TablePanel._eventCleanups.push(r.on(e,"click",n,0,"TablePanel.toggleBtn")):e.addEventListener("click",n),e}();return i.appendChild(d),i}(0,i);a.appendChild(l);const s=document.createElement("div");s.className="gl-table-panel__wrapper",a.appendChild(s);const c=document.createElement("table");return c.className="gl-table-panel__table",s.appendChild(c),document.body.appendChild(a),function(){const e=document.createElement("button");e.className="gl-table-panel__floating-show-btn",e.title="Afficher le tableau",e.setAttribute("aria-label","Afficher tableau");const o=document.createElement("span");o.className="gl-table-panel__toggle-btn__icon";const n=GeoLeaf.DOMSecurity.createSVGIcon(16,16,"M18 15l-6-6-6 6",{stroke:"currentColor",strokeWidth:"6",fill:"none"});o.appendChild(n),e.appendChild(o);const r=()=>{GeoLeaf.Table&&"function"==typeof GeoLeaf.Table.show&&GeoLeaf.Table.show()},i=GeoLeaf.Utils?.events;i?GeoLeaf._TablePanel._eventCleanups.push(i.on(e,"click",r,0,"TablePanel.floatingShowBtn")):e.addEventListener("click",r),document.body.appendChild(e),t.debug("[TablePanel] Bouton flottant cr\xe9\xe9")}(),t.info("[TablePanel] Panneau cr\xe9\xe9 avec succ\xe8s"),a},GeoLeaf._TablePanel.updateToolbarButtons=function(e){const o=e>0,n=document.querySelector("[data-table-btn='zoom']"),r=document.querySelector("[data-table-btn='highlight']"),i=document.querySelector("[data-table-btn='export']");n&&(n.disabled=!o),r&&(r.disabled=!o,!o&&r.classList.contains("is-active")&&(r.classList.remove("is-active"),GeoLeaf.Table&&"function"==typeof GeoLeaf.Table.highlightSelection&&GeoLeaf.Table.highlightSelection(0))),i&&(i.disabled=!o),t.debug("[TablePanel] Boutons mis \xe0 jour. S\xe9lection:",e)},GeoLeaf._TablePanel.refreshLayerSelector=function(){const e=document.querySelector("[data-table-layer-select]");if(!e)return;const o=e.value;for(;e.options.length>1;)e.remove(1);n(e);const r=Array.from(e.options).map(e=>e.value);o&&r.includes(o)?e.value=o:o&&!r.includes(o)&&(e.options.length>1?(e.value=e.options[1].value,GeoLeaf.Table&&"function"==typeof GeoLeaf.Table.setLayer&&GeoLeaf.Table.setLayer(e.options[1].value)):(e.value="",GeoLeaf.Table&&"function"==typeof GeoLeaf.Table.setLayer&&GeoLeaf.Table.setLayer("")));const i=e.options[0];i&&(i.textContent=e.options.length>1?"S\xe9lectionner une couche...":"Aucune couche visible"),t.debug("[TablePanel] S\xe9lecteur de couche rafra\xeechi,",e.options.length-1,"couches disponibles")},GeoLeaf._TablePanel.destroy=function(){GeoLeaf._TablePanel._eventCleanups&&GeoLeaf._TablePanel._eventCleanups.length>0&&(GeoLeaf._TablePanel._eventCleanups.forEach(e=>{"function"==typeof e&&e()}),GeoLeaf._TablePanel._eventCleanups=[],t.info("[TablePanel] Event listeners cleaned up"))}}("undefined"!=typeof window?window:gt)),lt||(lt=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log,o=(e,t,...o)=>GeoLeaf.Utils&&GeoLeaf.Utils.createElement?GeoLeaf.Utils.createElement(e,t,...o):document.createElement(e);function n(e,o,n,i,a=0){if(t.debug("[TableRenderer] handleRowSelection - featureId:",e,"selected:",o),!GeoLeaf.Table)return void t.error("[TableRenderer] GeoLeaf.Table non disponible");const l=GeoLeaf.Table.getSelectedIds();if(n&&l.length>0)t.debug("[TableRenderer] Mode SHIFT - S\xe9lection par plage"),function(e){const t=document.querySelector(".gl-table-panel__table tbody");if(!t)return;const o=Array.from(t.querySelectorAll("tr")),n=GeoLeaf.Table.getSelectedIds(),i=n[n.length-1],a=o.findIndex(t=>t.getAttribute("data-feature-id")===e),l=o.findIndex(e=>e.getAttribute("data-feature-id")===i);if(-1===a||-1===l)return;const s=Math.min(a,l),c=Math.max(a,l),u=[];for(let e=s;e<=c;e++){const t=o[e].getAttribute("data-feature-id");t&&u.push(t)}GeoLeaf.Table.setSelection(u,0),r()}(e);else if(i||a)if(t.debug("[TableRenderer] Mode MULTI - Multi-s\xe9lection"+(a?" (checkbox)":" (Ctrl)")),o){const t=[...l,e];GeoLeaf.Table.setSelection(t,0)}else{const t=l.filter(t=>t!==e);GeoLeaf.Table.setSelection(t,0)}else t.debug("[TableRenderer] Mode SIMPLE - S\xe9lection unique"),o?GeoLeaf.Table.setSelection([e],0):GeoLeaf.Table.clearSelection();r()}function r(){if(!GeoLeaf.Table)return;const e=GeoLeaf.Table.getSelectedIds().length;GeoLeaf._TablePanel&&"function"==typeof GeoLeaf._TablePanel.updateToolbarButtons&&GeoLeaf._TablePanel.updateToolbarButtons(e)}GeoLeaf._TableRenderer=GeoLeaf._TableRenderer||{},GeoLeaf._TableRenderer._eventCleanups=[],GeoLeaf._TableRenderer.render=function(e,a){if(t.debug("[TableRenderer] render() - D\xe9but, options:",a),!e)return void t.error("[TableRenderer] Conteneur invalide");i=0;const{layerId:l,features:s,selectedIds:c,sortState:u,config:d}=a;t.debug("[TableRenderer] render() - layerId:",l,"features:",s?s.length:0);const f=e.querySelector(".gl-table-panel__table");if(!f)return void t.error("[TableRenderer] \xc9l\xe9ment table introuvable");if(!l)return GeoLeaf.DOMSecurity.clearElementFast(f),void t.debug("[TableRenderer] Tableau vid\xe9 (aucune couche s\xe9lectionn\xe9e)");const p=GeoLeaf.GeoJSON?GeoLeaf.GeoJSON.getLayerData(l):null,g=p&&p.config&&p.config.table?p.config.table:null;if(!g||!g.columns)return t.warn("[TableRenderer] Aucune configuration de colonne pour",l),void GeoLeaf.DOMSecurity.clearElementFast(f);t.debug("[TableRenderer] Colonnes:",g.columns),GeoLeaf.DOMSecurity.clearElementFast(f);const y=function(e,t){const n=o("thead"),i=o("tr"),a=o("th",{className:"gl-table-panel__th gl-table-panel__th--checkbox"}),l=o("input",{type:"checkbox",className:"gl-table-panel__checkbox-all",title:"Tout s\xe9lectionner / Tout d\xe9s\xe9lectionner"}),s=e=>{!function(e){const t=document.querySelector(".gl-table-panel__table tbody");if(!t)return;const o=t.querySelectorAll("tr"),n=[];o.forEach(t=>{const o=t.getAttribute("data-feature-id");if(o){n.push(o),t.classList.toggle("is-selected",e);const r=t.querySelector(".gl-table-panel__checkbox");r&&(r.checked=e)}}),e?GeoLeaf.Table.setSelection(n,0):GeoLeaf.Table.clearSelection(),r()}(e.target.checked)},c=GeoLeaf.Utils?.events;return c?GeoLeaf._TableRenderer._eventCleanups.push(c.on(l,"change",s,0,"TableRenderer.checkboxAll")):l.addEventListener("change",s),a.appendChild(l),i.appendChild(a),e.forEach(e=>{const n=o("th",{className:"gl-table-panel__th"});if(n.textContent=e.label||e.field,e.width&&(n.style.width=e.width),0!=e.sortable){n.classList.add("gl-table-panel__th--sortable"),n.setAttribute("data-field",e.field);const r=o("span",{className:"gl-table-panel__sort-icon"});t.field===e.field?"asc"===t.direction?(r.textContent=" \u25b2",n.classList.add("is-sorted-asc")):"desc"===t.direction&&(r.textContent=" \u25bc",n.classList.add("is-sorted-desc")):r.textContent=" \u21c5",n.appendChild(r);const i=()=>{GeoLeaf.Table&&"function"==typeof GeoLeaf.Table.sortByField&&GeoLeaf.Table.sortByField(e.field)},a=GeoLeaf.Utils?.events;a?GeoLeaf._TableRenderer._eventCleanups.push(a.on(n,"click",i,0,"TableRenderer.sort")):n.addEventListener("click",i)}i.appendChild(n)}),n.appendChild(i),n}(g.columns,u);f.appendChild(y);const h=function(e,r,a){t.debug("[TableRenderer] createTableBody() - features:",e.length);const l=o("tbody"),s=document.createDocumentFragment();return e.forEach(e=>{const t=function(e,t,r){const a=o("tr"),l=function(e){if(null!=e.id&&""!==e.id)return String(e.id);const t=e.properties;return t?null!=t.id&&""!==t.id?String(t.id):null!=t.fid&&""!==t.fid?String(t.fid):null!=t.osm_id&&""!==t.osm_id?String(t.osm_id):null!=t.OBJECTID&&""!==t.OBJECTID?String(t.OBJECTID):null!=t.SITE_ID&&""!==t.SITE_ID?String(t.SITE_ID):null!=t.code&&""!==t.code?String(t.code):null!=t.IN1&&""!==t.IN1?String(t.IN1):"__gl_row_"+i++:"__gl_row_"+i++}(e);a.setAttribute("data-feature-id",l);const s=r.has(String(l));s&&a.classList.add("is-selected");const c=o("td",{className:"gl-table-panel__td gl-table-panel__td--checkbox"}),u=o("input",{type:"checkbox",className:"gl-table-panel__checkbox",checked:s}),d=e=>{n(l,e.target.checked,0,1,1)},f=GeoLeaf.Utils?.events;f?GeoLeaf._TableRenderer._eventCleanups.push(f.on(u,"change",d,0,"TableRenderer.checkbox")):u.addEventListener("change",d),c.appendChild(u),a.appendChild(c),t.forEach(t=>{const n=o("td",{className:"gl-table-panel__td"});var r,i;const l=function(e,t){if(null==e||""===e)return"\u2013";if("number"===t){const t=Number(e);return isNaN(t)?String(e):t.toLocaleString("fr-FR")}if("date"===t){const t=new Date(e);return isNaN(t.getTime())?String(e):t.toLocaleDateString("fr-FR")}return String(e)}((r=e,i=t.field,r&&i?i.split(".").reduce((e,t)=>e&&void 0!==e[t]?e[t]:null,r):null),t.type);n.textContent=l,"number"===t.type&&n.classList.add("gl-table-panel__td--number"),a.appendChild(n)});const p=e=>{if("checkbox"===e.target.type)return;const t=a.classList.contains("is-selected");n(l,!t,e.shiftKey,e.ctrlKey||e.metaKey)};return f?GeoLeaf._TableRenderer._eventCleanups.push(f.on(a,"click",p,0,"TableRenderer.rowClick")):a.addEventListener("click",p),a}(e,r,a);s.appendChild(t)}),l.appendChild(s),t.debug("[TableRenderer] tbody cr\xe9\xe9 avec",l.children.length,"lignes"),l}(s,g.columns,c);f.appendChild(h),d.virtualScrolling&&s.length>d.pageSize&&function(e,o){t.debug("[TableRenderer] Virtual scrolling activ\xe9 pour",o.length,"entit\xe9s")}(0,s),t.debug("[TableRenderer] Tableau rendu:",s.length,"lignes")},GeoLeaf._TableRenderer.updateSelection=function(e,t){const o=e.querySelector(".gl-table-panel__table tbody");if(!o)return;const n=o.querySelectorAll("tr");n.forEach(e=>{const o=e.getAttribute("data-feature-id"),n=t.has(String(o));e.classList.toggle("is-selected",n);const r=e.querySelector(".gl-table-panel__checkbox");r&&(r.checked=n)});const i=e.querySelector(".gl-table-panel__checkbox-all");if(i){const e=n.length,o=t.size;i.checked=e>0&&o===e,i.indeterminate=o>0&&o<e}r()};let i=0}("undefined"!=typeof window?window:gt)),st||(st=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log,o={_map:null,_config:null,_currentLayerId:null,_selectedIds:new Set,_cachedData:[],_featureIdMap:new Map,_highlightLayers:[],_highlightActive:0,_sortState:{field:null,direction:null},_container:null,_isVisible:0,init(e){if(!e||!e.map)return void t.error("[Table] init() n\xe9cessite une instance de carte Leaflet");this._map=e.map;const o=GeoLeaf.Config?GeoLeaf.Config.get("tableConfig"):null;this._config=Object.assign({enabled:1,defaultVisible:0,pageSize:50,maxRowsPerLayer:1e3,enableExportButton:1,virtualScrolling:1,defaultHeight:"40%",minHeight:"20%",maxHeight:"60%",resizable:0},o,e.config),this._config.enabled?(t.info("[Table] Initialisation du module Table",this._config),GeoLeaf._TablePanel&&"function"==typeof GeoLeaf._TablePanel.create?(this._container=GeoLeaf._TablePanel.create(this._map,this._config),this._config.defaultVisible&&this.show(),this._attachMapEvents(),t.info("[Table] Module Table initialis\xe9 avec succ\xe8s")):t.error("[Table] Module table/panel.js non charg\xe9")):t.info("[Table] Module d\xe9sactiv\xe9 via configuration")},_attachMapEvents(){if(!this._map)return;let e=null;const o=()=>{e&&clearTimeout(e),e=setTimeout(()=>{GeoLeaf._TablePanel&&"function"==typeof GeoLeaf._TablePanel.refreshLayerSelector&&GeoLeaf._TablePanel.refreshLayerSelector()},150)};this._map.on("geoleaf:filters:changed",()=>{this._isVisible&&this._currentLayerId&&this.refresh()}),this._map.on("geoleaf:geojson:layers-loaded",()=>{t.debug("[Table] \xc9v\xe9nement layers-loaded re\xe7u, rafra\xeechissement du s\xe9lecteur"),o()}),document.addEventListener("geoleaf:theme:applied",()=>{t.debug("[Table] \xc9v\xe9nement theme:applied re\xe7u, rafra\xeechissement du s\xe9lecteur"),o()}),this._map.on("geoleaf:geojson:visibility-changed",e=>{o(),this._currentLayerId===e.layerId&&(e.visible?this.refresh():setTimeout(()=>{const e=this._getAvailableVisibleLayers();if(e.length>0){this.setLayer(e[0].id);const t=document.querySelector("[data-table-layer-select]");t&&(t.value=e[0].id)}else this.setLayer("")},200))})},show(){this._container?(this._container.classList.add("is-visible"),this._isVisible=1,this._fireEvent("table:opened",{}),t.debug("[Table] Tableau affich\xe9")):t.warn("[Table] Conteneur non initialis\xe9")},hide(){this._container&&(this._clearHighlightLayers(),this._highlightActive=0,this._container.classList.remove("is-visible"),this._isVisible=0,this._fireEvent("table:closed",{}),t.debug("[Table] Tableau masqu\xe9"))},toggle(){this._isVisible?this.hide():this.show()},setLayer(e){if(t.debug("[Table] setLayer appel\xe9 avec:",e),!e)return this._currentLayerId=null,this._selectedIds.clear(),this._clearHighlightLayers(),this._highlightActive=0,this._featureIdMap.clear(),this._sortState={field:null,direction:null},this._cachedData=[],GeoLeaf._TableRenderer&&this._container&&GeoLeaf._TableRenderer.render(this._container,{layerId:null,features:[],selectedIds:this._selectedIds,sortState:this._sortState,config:this._config}),this._fireEvent("table:layerChanged",{layerId:null}),void t.debug("[Table] Tableau vid\xe9 (aucune couche s\xe9lectionn\xe9e)");if(!this._getAvailableLayers().find(t=>t.id===e))return void t.warn("[Table] Couche introuvable ou non activ\xe9e pour le tableau:",e);this._currentLayerId=e,this._selectedIds.clear(),this._clearHighlightLayers(),this._highlightActive=0,this._sortState={field:null,direction:null};const o=GeoLeaf.GeoJSON?GeoLeaf.GeoJSON.getLayerData(e):null;o&&o.config&&o.config.table&&o.config.table.defaultSort&&(this._sortState.field=o.config.table.defaultSort.field,this._sortState.direction=o.config.table.defaultSort.direction||o.config.table.defaultSort.order||"asc"),this.refresh(),this._fireEvent("table:layerChanged",{layerId:e}),t.debug("[Table] Couche chang\xe9e:",e)},refresh(){if(!this._currentLayerId)return void t.debug("[Table] Aucune couche s\xe9lectionn\xe9e, impossible de rafra\xeechir");const e=this._getLayerFeatures(this._currentLayerId);this._cachedData=e,this._featureIdMap.clear();let o=0;e.forEach((e,t)=>{const n=this._resolveFeatureId(e,o);n.startsWith("__gl_row_")&&o++,this._featureIdMap.set(n,t)}),t.debug("[Table] Features r\xe9cup\xe9r\xe9es:",e.length),this._sortState.field&&this._sortState.direction&&this._applySorting(),GeoLeaf._TableRenderer&&"function"==typeof GeoLeaf._TableRenderer.render?GeoLeaf._TableRenderer.render(this._container,{layerId:this._currentLayerId,features:this._cachedData,selectedIds:this._selectedIds,sortState:this._sortState,config:this._config}):t.error("[Table] Renderer non disponible"),t.debug("[Table] Donn\xe9es rafra\xeechies:",e.length,"entit\xe9s")},_getLayerFeatures(e){if(!GeoLeaf.GeoJSON||"function"!=typeof GeoLeaf.GeoJSON.getLayerData)return t.warn("[Table] Module GeoJSON non disponible"),[];const o=GeoLeaf.GeoJSON.getLayerData(e);if(!o||!o.features)return t.warn("[Table] Aucune donn\xe9e pour la couche:",e),[];t.debug("[Table] _getLayerFeatures - Nombre de features:",o.features.length);const n=this._config.maxRowsPerLayer||1e3;return o.features.length>n?(t.warn("[Table] Donn\xe9es volumineuses ("+o.features.length+" entit\xe9s). Limit\xe9 \xe0 "+n),o.features.slice(0,n)):o.features||[]},_getAvailableLayers(){if(!GeoLeaf.GeoJSON||"function"!=typeof GeoLeaf.GeoJSON.getAllLayers)return[];const e=GeoLeaf.GeoJSON.getAllLayers(),t=[];return e.forEach(e=>{const o=GeoLeaf.GeoJSON.getLayerData(e.id);o&&o.config&&o.config.table&&o.config.table.enabled&&t.push({id:e.id,label:e.label||e.id,config:o.config.table})}),t},_getAvailableVisibleLayers(){const e=this._getAvailableLayers(),t=GeoLeaf._LayerVisibilityManager;return e.filter(e=>{if(t&&"function"==typeof t.getVisibilityState){const o=t.getVisibilityState(e.id);return o&&1==o.current}const o=GeoLeaf.GeoJSON.getLayerData(e.id);return o&&o._visibility&&1==o._visibility.current})},_applySorting(){if(!this._sortState.field||!this._sortState.direction)return;const e=this._sortState.field,o=this._sortState.direction;this._cachedData.sort((t,n)=>{const r=this._getNestedValue(t,e),i=this._getNestedValue(n,e);if(null==r&&null==i)return 0;if(null==r)return"asc"===o?1:-1;if(null==i)return"asc"===o?-1:1;let a=0;return a="number"==typeof r&&"number"==typeof i?r-i:String(r).localeCompare(String(i)),"asc"===o?a:-a}),t.debug("[Table] Tri appliqu\xe9:",e,o)},sortByField(e){this._sortState.field===e?"asc"===this._sortState.direction?this._sortState.direction="desc":"desc"===this._sortState.direction?(this._sortState.field=null,this._sortState.direction=null):this._sortState.direction="asc":(this._sortState.field=e,this._sortState.direction="asc"),this.refresh(),this._fireEvent("table:sortChanged",this._sortState)},setSelection(e,o=0){o||this._selectedIds.clear(),e.forEach(e=>this._selectedIds.add(String(e))),this._fireEvent("table:selectionChanged",{layerId:this._currentLayerId,selectedIds:Array.from(this._selectedIds)}),GeoLeaf._TableRenderer&&"function"==typeof GeoLeaf._TableRenderer.updateSelection&&GeoLeaf._TableRenderer.updateSelection(this._container,this._selectedIds),t.debug("[Table] S\xe9lection mise \xe0 jour:",this._selectedIds.size,"entit\xe9s")},getSelectedIds(){return Array.from(this._selectedIds)},clearSelection(){this._selectedIds.clear(),this._fireEvent("table:selectionChanged",{layerId:this._currentLayerId,selectedIds:[]}),GeoLeaf._TableRenderer&&"function"==typeof GeoLeaf._TableRenderer.updateSelection&&GeoLeaf._TableRenderer.updateSelection(this._container,this._selectedIds),t.debug("[Table] S\xe9lection effac\xe9e")},zoomToSelection(){if(0===this._selectedIds.size)return void t.warn("[Table] Aucune entit\xe9 s\xe9lectionn\xe9e pour le zoom");const e=this._getSelectedFeatures();if(0===e.length)return void t.warn("[Table] Aucune feature trouv\xe9e pour les IDs s\xe9lectionn\xe9s");const o=L.latLngBounds([]);e.forEach(e=>{e.geometry&&e.geometry.coordinates&&this._extendBoundsFromGeometry(o,e.geometry)}),o.isValid()?(this._map.fitBounds(o,{padding:[50,50],maxZoom:16}),this._fireEvent("table:zoomToSelection",{layerId:this._currentLayerId,selectedIds:Array.from(this._selectedIds)}),t.debug("[Table] Zoom sur la s\xe9lection (",e.length,"entit\xe9s)")):t.warn("[Table] Bounds invalides pour la s\xe9lection")},highlightSelection(e){if(this._clearHighlightLayers(),this._highlightActive=e,!e)return t.debug("[Table] Surbrillance d\xe9sactiv\xe9e"),void this._fireEvent("table:highlightSelection",{layerId:this._currentLayerId,selectedIds:Array.from(this._selectedIds),active:0});if(0===this._selectedIds.size)return void t.warn("[Table] Aucune entit\xe9 s\xe9lectionn\xe9e pour la surbrillance");const o=this._getSelectedFeatures();if(0===o.length)return void t.warn("[Table] Aucune feature trouv\xe9e pour la surbrillance");const n={color:"#FFD600",weight:4,opacity:1,fillOpacity:.15,fillColor:"#FFD600",dashArray:"",interactive:0};o.forEach(e=>{try{if(e.geometry)if("Point"===e.geometry.type){const t=e.geometry.coordinates,o=L.circleMarker([t[1],t[0]],{radius:14,color:"#FFD600",weight:4,opacity:1,fillOpacity:.25,fillColor:"#FFD600",interactive:0});o.addTo(this._map),this._highlightLayers.push(o)}else{const t=L.geoJSON(e,{style:function(){return n},interactive:0,pointToLayer:function(e,t){return L.circleMarker(t,n)}});t.addTo(this._map),this._highlightLayers.push(t)}}catch(e){t.warn("[Table] Erreur surbrillance feature:",e)}}),this._fireEvent("table:highlightSelection",{layerId:this._currentLayerId,selectedIds:Array.from(this._selectedIds),active:1}),t.debug("[Table] Surbrillance activ\xe9e pour",o.length,"entit\xe9s")},_clearHighlightLayers(){this._highlightLayers.forEach(e=>{try{this._map&&this._map.hasLayer(e)&&this._map.removeLayer(e)}catch(e){}}),this._highlightLayers=[]},exportSelection(){if(0===this._selectedIds.size)return void t.warn("[Table] Aucune entit\xe9 s\xe9lectionn\xe9e pour l'export");const e=this._getSelectedFeatures();if(0===e.length)return void t.warn("[Table] Aucune feature trouv\xe9e pour l'export");const o={type:"FeatureCollection",features:e.map(e=>({type:"Feature",properties:e.properties||{},geometry:e.geometry||null}))};try{const n=JSON.stringify(o,null,2),r=new Blob([n],{type:"application/geo+json"}),i=URL.createObjectURL(r),a=document.createElement("a");a.href=i,a.download=(this._currentLayerId||"export")+"_selection.geojson",document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(i),t.info("[Table] Export GeoJSON:",e.length,"entit\xe9s export\xe9es")}catch(e){t.error("[Table] Erreur lors de l'export:",e)}this._fireEvent("table:exportSelection",{layerId:this._currentLayerId,selectedIds:Array.from(this._selectedIds),rows:e})},_getSelectedFeatures(){const e=[];return this._selectedIds.forEach(t=>{const o=this._featureIdMap.get(t);null!=o&&this._cachedData[o]&&e.push(this._cachedData[o])}),e},_resolveFeatureId(e,t){if(null!=e.id&&""!==e.id)return String(e.id);const o=e.properties;return o?null!=o.id&&""!==o.id?String(o.id):null!=o.fid&&""!==o.fid?String(o.fid):null!=o.osm_id&&""!==o.osm_id?String(o.osm_id):null!=o.OBJECTID&&""!==o.OBJECTID?String(o.OBJECTID):null!=o.SITE_ID&&""!==o.SITE_ID?String(o.SITE_ID):null!=o.code&&""!==o.code?String(o.code):null!=o.IN1&&""!==o.IN1?String(o.IN1):"__gl_row_"+t:"__gl_row_"+t},_extendBoundsFromGeometry(e,t){const o=t.coordinates,n=t.type;"Point"===n?e.extend([o[1],o[0]]):"LineString"===n?o.forEach(t=>e.extend([t[1],t[0]])):"MultiLineString"===n?o.forEach(t=>t.forEach(t=>e.extend([t[1],t[0]]))):"Polygon"===n?o[0].forEach(t=>e.extend([t[1],t[0]])):"MultiPolygon"===n?o.forEach(t=>{t[0].forEach(t=>e.extend([t[1],t[0]]))}):"MultiPoint"===n&&o.forEach(t=>e.extend([t[1],t[0]]))},_getNestedValue:(e,t)=>e&&t?t.split(".").reduce((e,t)=>e&&void 0!==e[t]?e[t]:null,e):null,_fireEvent(e,t){this._map&&"function"==typeof this._map.fire&&this._map.fire("geoleaf:"+e,t),"undefined"!=typeof document&&document.dispatchEvent&&document.dispatchEvent(new CustomEvent("geoleaf:"+e,{detail:t}))}};GeoLeaf.Table=o}("undefined"!=typeof window?window:gt)),ct||(ct=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log||console;class APIModuleManager{constructor(){this.modules=new Map,this.aliases=new Map,this.isInitialized=0,this.stats={totalModules:0,accessCount:0,errors:0}}init(){try{return this.isInitialized?(t&&t.debug("[APIModuleManager] Already initialized"),1):(t&&t.info("[APIModuleManager] Initializing module manager"),this._scanExistingModules(),this._setupAliases(),this.isInitialized=1,t&&t.info(`[APIModuleManager] Initialized with ${this.stats.totalModules} modules`),1)}catch(e){return this.stats.errors++,t&&t.error("[APIModuleManager] Initialization failed:",e),0}}_scanExistingModules(){e.GeoLeaf&&(["Core","UI","Config","Baselayers","BaseLayers","POI","GeoJSON","Route","Legend","LayerManager","Storage","Filters","Log","Security","Utils","Constants","Validators","Errors"].forEach(t=>{e.GeoLeaf[t]&&(this.modules.set(t,e.GeoLeaf[t]),this.stats.totalModules++)}),Object.keys(e.GeoLeaf).forEach(t=>{t.startsWith("_")&&!this.modules.has(t)&&(this.modules.set(t,e.GeoLeaf[t]),this.stats.totalModules++)}))}_setupAliases(){Object.entries({Baselayers:"BaseLayers",BaseLayers:"Baselayers",Logger:"Log",Log:"Logger"}).forEach(([e,t])=>{this.modules.has(t)&&this.aliases.set(e,t)})}getModule(o){try{if(this.stats.accessCount++,!o||"string"!=typeof o)return t&&t.warn("[APIModuleManager] Invalid module name:",o),this.stats.errors++,null;if(this.modules.has(o))return this.modules.get(o);if(this.aliases.has(o)){const e=this.aliases.get(o);return this.modules.get(e)}return e.GeoLeaf&&e.GeoLeaf[o]?(this.modules.set(o,e.GeoLeaf[o]),this.stats.totalModules++,e.GeoLeaf[o]):(t&&t.debug(`[APIModuleManager] Module '${o}' not found`),null)}catch(e){return this.stats.errors++,t&&t.error(`[APIModuleManager] Error accessing module '${o}':`,e),null}}registerModule(e,o){try{if(!e||"string"!=typeof e)throw new Error("Module name must be a non-empty string");if(!o)throw new Error("Module cannot be null or undefined");return this.modules.set(e,o),this.stats.totalModules++,t&&t.debug(`[APIModuleManager] Module '${e}' registered`),1}catch(o){return this.stats.errors++,t&&t.error(`[APIModuleManager] Failed to register module '${e}':`,o),0}}hasModule(o){try{return this.modules.has(o)||this.aliases.has(o)||!(!e.GeoLeaf||!e.GeoLeaf[o])}catch(e){return t&&t.error(`[APIModuleManager] Error checking module '${o}':`,e),0}}getModuleList(){const t=Array.from(this.modules.keys());return e.GeoLeaf&&Object.keys(e.GeoLeaf).forEach(e=>{t.includes(e)||t.push(e)}),t.sort()}getStats(){return{...this.stats,cachedModules:this.modules.size,aliases:this.aliases.size,isInitialized:this.isInitialized}}refresh(){t&&t.info("[APIModuleManager] Refreshing module cache"),this.modules.clear(),this.aliases.clear(),this.stats.totalModules=0,this._scanExistingModules(),this._setupAliases()}reset(){this.modules.clear(),this.aliases.clear(),this.isInitialized=0,this.stats={totalModules:0,accessCount:0,errors:0},t&&t.info("[APIModuleManager] Manager reset")}}GeoLeaf.API=GeoLeaf.API||{},GeoLeaf.API.APIModuleManager=APIModuleManager,GeoLeaf.API.ModuleManager=APIModuleManager,t&&t.info("[APIModuleManager] Module manager loaded (Sprint 4.3 - Robust)")}(window)),ut||(ut=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log||console;class APIInitializationManager{constructor(){this.isReady=1,this.pendingPromise=null,this.cancelled=0,this.stats={initCalls:0,configLoads:0,errors:0}}init(e,o){try{this.stats.initCalls++,t&&t.info("[APIInitializationManager] Initializing GeoLeaf");const n=this._validateInitParams(e,o);if(!n.valid)throw new Error(n.error);const r=o("Core");if(!r||"function"!=typeof r.init)throw new Error("[GeoLeaf.init] GeoLeaf.Core.init() is not available. Core module must be loaded before API.");const i=this._normalizeInitOptions(e);t&&t.info("[APIInitializationManager] Initializing with options:",i);const a=r.init(i);return t&&t.info("[APIInitializationManager] Initialization completed successfully"),a}catch(e){throw this.stats.errors++,t&&t.error("[APIInitializationManager] Initialization failed:",e),e}}async loadConfig(e,o){try{if(this.stats.configLoads++,t&&t.info("[APIInitializationManager] Loading configuration"),!e)throw new Error("Configuration input is required");if(!o||"function"!=typeof o)throw new Error("getModule function is required");const n=o("Config");if(!n||"function"!=typeof n.init)throw new Error("[GeoLeaf.loadConfig] GeoLeaf.Config.init() is not available. Config module must be loaded.");const r=this._normalizeConfigOptions(e);this.pendingPromise&&(this.cancelled=1,t&&t.info("[APIInitializationManager] Cancelling previous config load request")),this.cancelled=0,this.pendingPromise=n.init(r);const i=await this.pendingPromise;return this.pendingPromise=null,this.cancelled?(t&&t.info("[APIInitializationManager] Config load was cancelled"),null):(t&&t.info("[APIInitializationManager] Configuration loaded successfully"),i)}catch(e){throw this.stats.errors++,this.pendingPromise=null,t&&t.error("[APIInitializationManager] Config loading failed:",e),e}}setTheme(e,o){try{if(t&&t.info(`[APIInitializationManager] Setting theme: ${e}`),!e||"string"!=typeof e)throw new Error("Theme name must be a non-empty string");if(!o||"function"!=typeof o)throw new Error("getModule function is required");const n=o("UI");if(!n)throw new Error("[GeoLeaf.setTheme] GeoLeaf.UI is not available. UI module must be loaded.");let r=0;if("function"==typeof n.applyTheme)r=n.applyTheme(e);else if("function"==typeof n.setTheme)r=n.setTheme(e);else{if("function"!=typeof n.theme)throw new Error("UI module does not provide applyTheme, setTheme or theme method");r=n.theme(e)}return t&&t.info(`[APIInitializationManager] Theme '${e}' applied successfully`),r}catch(o){return this.stats.errors++,t&&t.error(`[APIInitializationManager] Failed to set theme '${e}':`,o),0}}_validateInitParams(e,t){return e&&"object"==typeof e?t&&"function"==typeof t?{valid:1}:{valid:0,error:"getModule function is required"}:{valid:0,error:"[GeoLeaf.init] An options object is required."}}_normalizeInitOptions(t){let o=t.map||{},n=t.ui||{};t.map||(o={target:t.target||t.mapId,center:t.center,zoom:t.zoom},n={theme:t.theme});const r=o.target||o.mapId;if(!r)throw new Error("[GeoLeaf.init] The 'map.target' (or 'target'/'mapId') option is required.");const i=e.GeoLeaf.CONSTANTS||{},a=Array.isArray(o.center)?o.center:i.DEFAULT_CENTER||[0,0],l=Number.isFinite(o.zoom)?o.zoom:i.DEFAULT_ZOOM||12,s=n.theme||o.theme||"light";return{mapId:String(r),center:a,zoom:l,theme:s}}_normalizeConfigOptions(e){if("string"==typeof e)return{source:"url",url:e,autoEvent:1};if(e&&"object"==typeof e)return{source:e.url?"url":"data",url:e.url,data:e.data,profileId:e.profileId,autoEvent:0!=e.autoEvent,...e};throw new Error("Configuration input must be a URL string or options object")}getStats(){return{...this.stats,isReady:this.isReady,hasPendingRequest:!!this.pendingPromise}}reset(){this.pendingPromise&&(this.cancelled=1),this.pendingPromise=null,this.cancelled=0,this.stats={initCalls:0,configLoads:0,errors:0},t&&t.info("[APIInitializationManager] Manager reset")}}GeoLeaf.API=GeoLeaf.API||{},GeoLeaf.API.APIInitializationManager=APIInitializationManager,GeoLeaf.API.InitializationManager=APIInitializationManager,t&&t.info("[APIInitializationManager] Initialization manager loaded (Sprint 4.3 - Robust)")}(window)),dt||(dt=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log||console;class APINamespaceManager{constructor(){this.isReady=1,this.stats={operations:0,errors:0}}init(e){try{if(!e||"function"!=typeof e)throw new Error("getModule function is required");return this.getModule=e,t&&t.info("[APINamespaceManager] Namespace manager initialized"),1}catch(e){return this.stats.errors++,t&&t.error("[APINamespaceManager] Initialization failed:",e),0}}getStats(){return{...this.stats,isReady:this.isReady}}reset(){this.getModule=null,this.stats={operations:0,errors:0},t&&t.info("[APINamespaceManager] Manager reset")}}GeoLeaf.API=GeoLeaf.API||{},GeoLeaf.API.APINamespaceManager=APINamespaceManager,GeoLeaf.API.NamespaceManager=APINamespaceManager,t&&t.info("[APINamespaceManager] Namespace manager loaded (Sprint 4.3 - Robust)")}(window)),ft||(ft=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log||console;class APIFactoryManager{constructor(){this.isReady=1,this.mapInstances=new Map,this.stats={mapsCreated:0,errors:0}}init(e){try{if(!e||"function"!=typeof e)throw new Error("getModule function is required");return this.getModule=e,t&&t.info("[APIFactoryManager] Factory manager initialized"),1}catch(e){return this.stats.errors++,t&&t.error("[APIFactoryManager] Initialization failed:",e),0}}createMap(e,o,n){try{if(this.stats.mapsCreated++,!e)throw new Error("Target ID is required");const r=n("Core");if(!r||"function"!=typeof r.init)throw new Error("Core module not available for map creation");const i={target:e,...o},a=r.init(i);return a&&(this.mapInstances.set(e,a),t&&t.info(`[APIFactoryManager] Map created for target: ${e}`)),a}catch(o){return this.stats.errors++,t&&t.error(`[APIFactoryManager] Failed to create map for ${e}:`,o),null}}getMapInstance(e){return this.mapInstances.get(e)||null}getAllMapInstances(){return Array.from(this.mapInstances.values())}getStats(){return{...this.stats,activeInstances:this.mapInstances.size,isReady:this.isReady}}reset(){this.mapInstances.clear(),this.getModule=null,this.stats={mapsCreated:0,errors:0},t&&t.info("[APIFactoryManager] Manager reset")}}GeoLeaf.API=GeoLeaf.API||{},GeoLeaf.API.APIFactoryManager=APIFactoryManager,GeoLeaf.API.FactoryManager=APIFactoryManager,t&&t.info("[APIFactoryManager] Factory manager loaded (Sprint 4.3 - Robust)")}(window)),pt||(pt=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf.Log||console;class APIController{constructor(){this.isInitialized=0,this.managers={},this.moduleAccessFn=null,this.healthStatus={managers:0,errors:[],lastUpdate:null}}init(){try{if(this.isInitialized)return t&&t.debug("[APIController] Already initialized"),1;if(t&&t.info("[APIController] Initializing API controller (Sprint 4.3 - Robust)"),this._initializeManagers(),!this._setupModuleAccess())throw new Error("Module access setup failed");return this._validateInitialization(),this.isInitialized=1,this.healthStatus.lastUpdate=(new Date).toISOString(),t&&t.info("[APIController] API controller initialized successfully"),1}catch(e){return this.healthStatus.errors.push({message:e.message,timestamp:(new Date).toISOString(),stack:e.stack}),t&&t.error("[APIController] Initialization failed:",e),0}}_initializeManagers(){["module","initialization","namespace","factory"].forEach(e=>{const o=this._getManagerClass(e);if(o)try{this.managers[e]=new o,this.healthStatus.managers++,t&&t.debug(`[APIController] ${e} manager loaded`)}catch(o){t&&t.warn(`[APIController] Failed to load ${e} manager:`,o),this.healthStatus.errors.push({manager:e,error:o.message})}}),t&&t.info(`[APIController] Loaded ${this.healthStatus.managers} managers`)}_getManagerClass(e){const t={module:"APIModuleManager",initialization:"APIInitializationManager",namespace:"APINamespaceManager",factory:"APIFactoryManager"}[e];return GeoLeaf.API&&GeoLeaf.API[t]?GeoLeaf.API[t]:null}_setupModuleAccess(){return this.managers.module?!this.managers.module.init||this.managers.module.init()?(this.moduleAccessFn=o=>{try{return o&&"string"==typeof o?this.managers.module&&"function"==typeof this.managers.module.getModule?this.managers.module.getModule(o):e.GeoLeaf&&e.GeoLeaf[o]?e.GeoLeaf[o]:null:(t&&t.warn("[APIController] Invalid module name:",o),null)}catch(e){return t&&t.warn(`[APIController] Error accessing module ${o}:`,e),null}},t&&t.info("[APIController] Module access configured"),1):(t&&t.error("[APIController] Module manager initialization failed"),0):(t&&t.error("[APIController] Module manager not available"),0)}_validateInitialization(){const e=[{name:"moduleAccessFn",value:this.moduleAccessFn,type:"function"},{name:"managers",value:this.managers,type:"object"},{name:"moduleManager",value:this.managers.module,type:"object"}].filter(e=>!e.value||typeof e.value!==e.type);if(e.length>0){const t=e.map(e=>e.name).join(", ");throw new Error(`Validation failed for: ${t}`)}t&&t.debug("[APIController] Validation passed")}geoleafInit(e){if(!this._ensureInitialized())return null;try{if(!this.managers.initialization)throw new Error("Initialization manager not available");return this.managers.initialization.init(e,this.moduleAccessFn)}catch(e){return t&&t.error("[APIController] geoleafInit failed:",e),null}}geoleafLoadConfig(e){if(!this._ensureInitialized())return Promise.resolve(null);try{if(!this.managers.initialization)throw new Error("Initialization manager not available");return this.managers.initialization.loadConfig(e,this.moduleAccessFn)}catch(e){return t&&t.error("[APIController] geoleafLoadConfig failed:",e),Promise.resolve(null)}}geoleafSetTheme(e){if(!this._ensureInitialized())return 0;try{if(!this.managers.initialization)throw new Error("Initialization manager not available");return this.managers.initialization.setTheme(e,this.moduleAccessFn)}catch(e){return t&&t.error("[APIController] geoleafSetTheme failed:",e),0}}geoleafCreateMap(e,o){if(!this._ensureInitialized())return null;try{if(!this.managers.factory)throw new Error("Factory manager not available");return this.managers.factory.createMap(e,o,this.moduleAccessFn)}catch(e){return t&&t.error("[APIController] geoleafCreateMap failed:",e),null}}_ensureInitialized(){return this.isInitialized?1:(t&&t.error("[APIController] Controller not initialized"),0)}getHealthStatus(){return{...this.healthStatus,isInitialized:this.isInitialized,managersCount:Object.keys(this.managers).length,hasModuleAccess:!!this.moduleAccessFn}}reset(){this.isInitialized=0,this.managers={},this.moduleAccessFn=null,this.healthStatus={managers:0,errors:[],lastUpdate:null},t&&t.info("[APIController] Controller reset")}}if(GeoLeaf.API=GeoLeaf.API||{},GeoLeaf.API.Controller=APIController,!GeoLeaf._APIController){const e=new APIController;e.init()?(GeoLeaf._APIController=e,t&&t.info("[APIController] Global instance created and initialized successfully")):(t&&t.warn("[APIController] Failed to auto-initialize - will try manual init later"),GeoLeaf._APIController=e)}t&&t.info("[APIController] Controller class loaded (Sprint 4.3 - Robust)")}(window));var yt,ht,mt,bt,_t={exports:{}},Lt=_t.exports;yt||(yt=1,function(e){var t,o;t="undefined"!=typeof self?self:Lt,o=function(e){const t=e.GeoLeaf||{},o=t.Log,n=t._APIController;if(!n)throw o.error("[GeoLeaf.API] APIController non disponible. Les modules API Controller doivent \xeatre charg\xe9s avant geoleaf.api.js"),new Error("APIController manquant - v\xe9rifiez que les modules API sont charg\xe9s");if(!n.isInitialized)throw o.error("[GeoLeaf.API] APIController en \xe9tat d\xe9faillant. V\xe9rification de l'\xe9tat :",n.getHealthStatus()),new Error("APIController en \xe9tat d\xe9faillant");const r={VERSION:"4.3.0-robust",DEFAULT_CENTER:[0,0],DEFAULT_ZOOM:3,THEMES:["light","dark","satellite","custom"]},GeoLeaf=Object.assign(t,{init:function(e){try{return n.geoleafInit(e)}catch(e){throw o.error("[GeoLeaf.init] Erreur lors de l'initialisation :",e),e}},setTheme:function(e){try{return n.geoleafSetTheme(e)}catch(e){throw o.error("[GeoLeaf.setTheme] Erreur lors de l'application du th\xe8me :",e),e}},loadConfig:function(e){try{return n.geoleafLoadConfig(e)}catch(e){throw o.error("[GeoLeaf.loadConfig] Erreur lors du chargement de configuration :",e),e}},CONSTANTS:r,getModule:function(e){return n.moduleAccessFn?n.moduleAccessFn(e):null},hasModule:function(e){return!(!n.moduleAccessFn||!n.moduleAccessFn(e))},getNamespace:function(e){return n.managers&&n.managers.namespace?n.managers.namespace.get(e):null},createMap:function(e,t){return n.geoleafCreateMap?n.geoleafCreateMap(e,t):null},getMap:function(e){return n.managers&&n.managers.factory?n.managers.factory.get(e):null},getAllMaps:function(){return n.managers&&n.managers.factory?n.managers.factory.getAll():{}},removeMap:function(e){return n.managers&&n.managers.factory?n.managers.factory.remove(e):0},getHealth:function(){return n.getHealthStatus?n.getHealthStatus():null},getMetrics:function(){return n.getHealthStatus?n.getHealthStatus():null},_APIController:n});return o&&(o.info(`[GeoLeaf.API] API publique v${r.VERSION} initialis\xe9e avec succ\xe8s`),o.info("[GeoLeaf.API] Sant\xe9 APIController :",n.getHealthStatus())),GeoLeaf},e.exports?e.exports=o(t):t.GeoLeaf=o(t)}(_t)),ht||(ht=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf._app=GeoLeaf._app||{};t.AppLog={log(...e){location.search.includes("debug=true")},info(...e){console.info("[GeoLeaf]",...e)},error(...e){console.error("[GeoLeaf]",...e)},warn(...e){console.warn("[GeoLeaf]",...e)}},t.getProfilesBasePath=function(){return e.location.pathname.includes("/demo/")?"../profiles/":"./profiles/"},t.checkPlugins=function(e){const o=t.AppLog;e&&e.ui&&1==e.ui.showAddPoi&&(GeoLeaf.POI&&GeoLeaf.POI.AddForm||o.warn("\u26a0\ufe0f Config has showAddPoi=true but AddPOI plugin is not loaded. Load geoleaf-addpoi.plugin.js before calling GeoLeaf.boot().")),e&&e.storage&&(GeoLeaf.Storage||o.warn("\u26a0\ufe0f Config references storage but Storage plugin is not loaded. Load geoleaf-storage.plugin.js before calling GeoLeaf.boot()."),e.storage.enableServiceWorker&&!GeoLeaf._SWRegister&&o.warn("\u26a0\ufe0f Config has enableServiceWorker=true but SW Register module is not available. Ensure sw-register.js is included in the Storage plugin bundle.")),GeoLeaf.POI&&GeoLeaf.POI.SyncHandler&&!GeoLeaf.Storage&&o.warn("\u26a0\ufe0f SyncHandler loaded without Storage plugin \u2014 sync operations will be disabled. POI add/edit/delete will work in online-only mode.")},t.showNotification=function(e,o){if(o=o||3500,GeoLeaf.UI&&GeoLeaf.UI.Notifications&&"function"==typeof GeoLeaf.UI.Notifications.success)try{return GeoLeaf.UI.Notifications.success(e,o),1}catch(e){}if(GeoLeaf._UINotifications&&"function"==typeof GeoLeaf._UINotifications.success)try{return GeoLeaf._UINotifications.success(e,o),1}catch(e){}return t.AppLog.log(e+" (notifications indisponibles)"),0}}(window)),mt||(mt=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf._app=GeoLeaf._app||{};t.initApp=function(e){e=e||{};const o=t.AppLog;o.log("Initialisation avec config:",e),t.checkPlugins(e);const n=e.map&&(e.map.target||e.map.id)||"geoleaf-map",r=e.ui&&e.ui.theme||"light";if(!e.map||!Array.isArray(e.map.bounds)||2!==e.map.bounds.length)return void o.error('[GeoLeaf] Le profil actif ne d\xe9finit pas de map.bounds valide. L\'emprise (map.bounds) est obligatoire dans le fichier profile.json. Exemple : "bounds": [[43.0, 1.0], [44.0, 2.0]]');const i=e.map.bounds,a=e.map.maxZoom||12,l=e.map.padding||[50,50],s=[(i[0][0]+i[1][0])/2,(i[0][1]+i[1][1])/2];let c=null;try{c=GeoLeaf.init({map:{target:n,center:s,zoom:a},ui:{theme:r}})}catch(e){return void o.error("GeoLeaf.init() a lev\xe9 une erreur :",e)}if(!c)return void o.error("GeoLeaf.init() n'a pas renvoy\xe9 de carte valide.");try{c.fitBounds(i,{maxZoom:a,padding:l,animate:0}),o.log("Carte positionn\xe9e via map.bounds du profil.")}catch(e){o.warn("Erreur fitBounds depuis profile.map.bounds :",e)}if(GeoLeaf.Storage&&"function"==typeof GeoLeaf.Storage.init)try{const t=e.storage||{};o.log("Initialisation du Storage avec config:",t),GeoLeaf.Storage.init({indexedDB:{name:"geoleaf-db",version:2},cache:t.cache||{enableProfileCache:1,enableTileCache:1},offline:{},enableOfflineDetector:!!t.enableOfflineDetector,enableServiceWorker:!!t.enableServiceWorker}).then(()=>{o.log("Storage initialis\xe9 avec succ\xe8s")}).catch(e=>{o.warn("Erreur initialisation Storage:",e)})}catch(e){o.warn("Erreur lors de l'initialisation du Storage:",e)}else o.log("Plugin Storage non charg\xe9 \u2014 fonctionnement en mode cache navigateur standard.");if(GeoLeaf._UINotifications&&"function"==typeof GeoLeaf._UINotifications.init)try{let e=document.getElementById("gl-notifications");e||(e=document.createElement("div"),e.id="gl-notifications",e.className="gl-notifications gl-notifications--bottom-center",document.body.appendChild(e)),GeoLeaf._UINotifications.init({container:"#gl-notifications",position:"bottom-center",maxVisible:3,animations:1}),o.log("Syst\xe8me de notifications initialis\xe9")}catch(e){o.warn("Erreur lors de l'initialisation des notifications:",e)}let u=null;document.addEventListener("geoleaf:theme:applying",function(){GeoLeaf._UINotifications&&GeoLeaf._UINotifications.container&&(u=GeoLeaf._UINotifications.info("Chargement des donn\xe9es en cours, patientez\u2026",{persistent:1,dismissible:0}))});let d=null;function f(e){if(!e||!e.data)return 0;const o=e.data.profile||{},n=(o.label||o.name||o.title||e.profileId||"Profil")+" charg\xe9";if(!function(){try{if(GeoLeaf.UI&&GeoLeaf.UI.Notifications&&"function"==typeof GeoLeaf.UI.Notifications.getStatus)return!!GeoLeaf.UI.Notifications.getStatus().initialized;if(GeoLeaf._UINotifications&&GeoLeaf._UINotifications.container)return 1}catch(e){}return 0}())return d=e,0;const r=t.showNotification(n);return d=r?null:e,r}document.addEventListener("geoleaf:profile:loaded",function(e){e&&e.detail&&(d=e.detail,f(e.detail))}),document.addEventListener("geoleaf:theme:applied",function(e){if(u&&GeoLeaf._UINotifications&&"function"==typeof GeoLeaf._UINotifications.dismiss&&(GeoLeaf._UINotifications.dismiss(u),u=null),e&&e.detail){const o=e.detail;t.showNotification(`Th\xe8me "${o.themeName}" charg\xe9 (${o.layerCount} couches visibles)`,3500)}}),document.addEventListener("geoleaf:map:ready",function(){d&&f(d)});try{"function"==typeof GeoLeaf.setTheme&&GeoLeaf.setTheme(r)}catch(e){o.warn("Erreur lors de l'appel \xe0 GeoLeaf.setTheme :",e)}if(GeoLeaf.UI&&"function"==typeof GeoLeaf.UI.init)try{const t=document.querySelector(".gl-main")||document.getElementById(n);GeoLeaf.UI.init({buttonSelector:'[data-gl-role="theme-toggle"]',map:c,mapContainer:t,config:e})}catch(e){o.warn("GeoLeaf.UI.init() a lev\xe9 une erreur :",e)}if(GeoLeaf.UI&&"function"==typeof GeoLeaf.UI.buildFilterPanelFromActiveProfile)try{let e=document.getElementById("gl-filter-panel");if(!e){e=document.createElement("div"),e.id="gl-filter-panel",e.setAttribute("data-gl-role","filter-panel");const t=document.querySelector(".gl-main");t?t.appendChild(e):document.body.appendChild(e)}GeoLeaf.UI.buildFilterPanelFromActiveProfile({container:e}),"function"==typeof GeoLeaf.UI.initFilterToggle&&GeoLeaf.UI.initFilterToggle(),"function"==typeof GeoLeaf.UI.initProximityFilter&&GeoLeaf.UI.initProximityFilter(c)}catch(e){o.warn("Erreur lors de la construction du panneau de filtres :",e)}if(GeoLeaf.Table&&"function"==typeof GeoLeaf.Table.init&&e.tableConfig&&e.tableConfig.enabled)try{GeoLeaf.Table.init({map:c,config:e.tableConfig}),o.log("Module Table initialis\xe9.")}catch(e){o.warn("Erreur lors de l'initialisation du module Table :",e)}if(GeoLeaf.UI&&GeoLeaf.UI.CacheButton&&"function"==typeof GeoLeaf.UI.CacheButton.init)try{GeoLeaf.UI.CacheButton.init(c,e),o.log("Bouton de cache initialis\xe9.")}catch(e){o.warn("Erreur lors de l'initialisation du bouton de cache :",e)}if(function(){const t=GeoLeaf.BaseLayers||GeoLeaf.Baselayers;if(!t||"function"!=typeof t.init)return void o.warn("Module BaseLayers introuvable.");let n="street";const r={};e.basemaps&&"object"==typeof e.basemaps&&Object.keys(e.basemaps).forEach(function(t){const o=e.basemaps[t];1==o.defaultBasemap&&(n=o.id||t),r[t]={id:o.id||t,label:o.label||t,url:o.url,options:{minZoom:o.minZoom||0,maxZoom:o.maxZoom||19,attribution:o.attribution||""}}});try{t.init({map:c,baselayers:r,activeKey:n,ui:e.ui,basemaps:e.basemaps})}catch(e){o.warn("BaseLayers.init a lev\xe9 une exception :",e)}}(),function(){const t=GeoLeaf.POI;if(!t||"function"!=typeof t.add)return void o.warn("GeoLeaf.POI.add() indisponible, aucun POI ne sera affich\xe9.");try{"function"==typeof t.init&&(t.init({map:c,config:e.poiConfig||{}}),GeoLeaf.Legend&&"function"==typeof GeoLeaf.Legend.loadLayerLegend&&e.layers&&Array.isArray(e.layers)&&e.layers.forEach(function(e){e.id&&e.id.includes("poi")&&e.configFile&&fetch(e.configFile).then(e=>e.json()).then(t=>{let o="default";t.styles&&t.styles.available&&t.styles.available.length>0&&(o=t.styles.available[0].id||"default"),GeoLeaf.Legend.loadLayerLegend(e.id,o,t),"function"==typeof GeoLeaf.Legend.setLayerVisibility&&GeoLeaf.Legend.setLayerVisibility(e.id,1)}).catch(t=>o.warn(`Erreur chargement config couche ${e.id}:`,t))}))}catch(e){o.warn("GeoLeaf.POI.init() a lev\xe9 une erreur :",e)}if(e.ui&&1==e.ui.showFilterPanel)return o.info("Panneau de filtres activ\xe9 : les POI seront charg\xe9s via le syst\xe8me de filtres."),void(GeoLeaf.UI&&"function"==typeof GeoLeaf.UI.applyFiltersInitial&&GeoLeaf.UI.applyFiltersInitial());if(!Array.isArray(e.poi)||0===e.poi.length)return;const n=[];if(e.poi.forEach(function(e){let t=null;e.latlng&&Array.isArray(e.latlng)&&2===e.latlng.length?t=e.latlng:e.location&&"number"==typeof e.location.lat&&"number"==typeof e.location.lng&&(t=[e.location.lat,e.location.lng]),t&&n.push(t)}),n.length>0){const t=e.map&&Array.isArray(e.map.bounds)&&2===e.map.bounds.length,r=e.layers&&Array.isArray(e.layers)&&e.layers.length>0;if(!t&&!r)try{c.fitBounds(L.latLngBounds(n),{padding:[80,80],maxZoom:12,animate:0})}catch(e){o.warn("Erreur lors de fitBounds :",e)}GeoLeaf.UI&&"function"==typeof GeoLeaf.UI.refreshFilterTags&&GeoLeaf.UI.refreshFilterTags()}}(),function(){const t=GeoLeaf.Route;if(t&&"function"==typeof t.init&&"function"==typeof t.loadFromConfig){try{t.init({map:c,fitBoundsOnLoad:0,maxZoomOnFit:12})}catch(e){return void o.warn("GeoLeaf.Route.init() a lev\xe9 une erreur :",e)}if(Array.isArray(e.routes)&&e.routes.length>0)try{t.loadFromConfig(e.routes),o.log("Itin\xe9raires charg\xe9s.")}catch(e){o.warn("GeoLeaf.Route.loadFromConfig() a lev\xe9 une erreur :",e)}}}(),function(){const e=GeoLeaf.GeoJSON;if(e&&"function"==typeof e.init){try{e.init({map:c,fitBoundsOnLoad:0,maxZoomOnFit:12})}catch(e){return void o.warn("GeoLeaf.GeoJSON.init() a lev\xe9 une erreur :",e)}c&&"function"==typeof c.on&&c.on("geoleaf:geojson:layers-loaded",function(e){if(e&&e.detail&&"number"==typeof e.detail.count){const o=e.detail.count,n=1===o?"1 couche GeoJSON charg\xe9e":o+" couches GeoJSON charg\xe9es";t.showNotification(n,3e3)}}),function(){if(GeoLeaf._GeoJSONLoader&&"function"==typeof GeoLeaf._GeoJSONLoader.loadAllLayersConfigsForLayerManager){const e=GeoLeaf.Config&&"function"==typeof GeoLeaf.Config.getActiveProfile?GeoLeaf.Config.getActiveProfile():null;if(e)return GeoLeaf._GeoJSONLoader.loadAllLayersConfigsForLayerManager(e).catch(e=>(o.warn("Erreur chargement configs couches:",e),[]))}return Promise.resolve()}().then(function(){if(!GeoLeaf.ThemeSelector||"function"!=typeof GeoLeaf.ThemeSelector.init)return void o.warn("ThemeSelector non disponible");let e=null;GeoLeaf.Config&&"function"==typeof GeoLeaf.Config.getActiveProfileId&&(e=GeoLeaf.Config.getActiveProfileId());const t=document.getElementById("gl-theme-primary-container"),n=document.getElementById("gl-theme-secondary-container");e&&t&&n?GeoLeaf.ThemeSelector.init({profileId:e,primaryContainer:t,secondaryContainer:n}).then(function(){if(o.log("ThemeSelector initialis\xe9 et th\xe8me appliqu\xe9"),GeoLeaf._GeoJSONLayerManager&&"function"==typeof GeoLeaf._GeoJSONLayerManager.populateLayerManagerWithAllConfigs){const e=GeoLeaf.ThemeSelector.getActiveTheme?GeoLeaf.ThemeSelector.getActiveTheme():null;GeoLeaf._GeoJSONLayerManager.populateLayerManagerWithAllConfigs(e)}document.addEventListener("geoleaf:theme:applied",function(){if(GeoLeaf._GeoJSONLayerManager&&"function"==typeof GeoLeaf._GeoJSONLayerManager.populateLayerManagerWithAllConfigs){const e=GeoLeaf.ThemeSelector.getActiveTheme?GeoLeaf.ThemeSelector.getActiveTheme():null;GeoLeaf._GeoJSONLayerManager.populateLayerManagerWithAllConfigs(e)}})}).catch(function(e){o.warn("Erreur initialisation ThemeSelector:",e)}):o.warn("ThemeSelector : conteneurs ou profil manquants")})}else o.log("GeoLeaf.GeoJSON.init() indisponible \u2014 pas de couches GeoJSON.")}(),GeoLeaf.UI&&GeoLeaf.UI.Branding&&"function"==typeof GeoLeaf.UI.Branding.init)try{GeoLeaf.UI.Branding.init(c)}catch(e){o.warn("GeoLeaf.UI.Branding.init() a lev\xe9 une erreur :",e)}if(e.ui&&0!=e.ui.showLegend&&GeoLeaf.Legend&&"function"==typeof GeoLeaf.Legend.init)try{GeoLeaf.Legend.init(c,{position:"bottomleft",collapsible:1,collapsed:0,title:"L\xe9gende"})}catch(e){o.warn("Erreur lors de l'initialisation du module Legend:",e)}if(e.ui&&0!=e.ui.showLayerManager&&GeoLeaf.LayerManager&&"function"==typeof GeoLeaf.LayerManager.init)try{GeoLeaf.LayerManager.init({map:c,position:"bottomright"})}catch(e){o.warn("GeoLeaf.LayerManager.init() a lev\xe9 une erreur :",e)}if(GeoLeaf.initScaleControl&&"function"==typeof GeoLeaf.initScaleControl)try{GeoLeaf.initScaleControl(c)}catch(e){o.warn("GeoLeaf.initScaleControl() a lev\xe9 une erreur :",e)}if(GeoLeaf.Labels&&"function"==typeof GeoLeaf.Labels.init)try{GeoLeaf.Labels.init({map:c})}catch(e){o.warn("GeoLeaf.Labels.init() a lev\xe9 une erreur :",e)}if(e.ui&&0!=e.ui.showCoordinates&&GeoLeaf.UI&&GeoLeaf.UI.CoordinatesDisplay&&"function"==typeof GeoLeaf.UI.CoordinatesDisplay.init)try{GeoLeaf.UI.CoordinatesDisplay.init(c,{position:"bottomleft",decimals:6})}catch(e){o.warn("GeoLeaf.UI.CoordinatesDisplay.init() a lev\xe9 une erreur :",e)}let p=0;function g(e){if(p)return;p=1;const t=document.getElementById("gl-loader");t&&(t.classList.add("gl-loader--fade"),t.addEventListener("transitionend",function(){t.style.display="none"},{once:1}),setTimeout(function(){t.style.display="none"},500)),c&&(c.invalidateSize({pan:0}),setTimeout(function(){try{c.fitBounds(i,{maxZoom:a,padding:l,animate:1,duration:.6})}catch(e){o.warn("[GeoLeaf] Correctif fitBounds au reveal :",e)}},120)),document.dispatchEvent(new CustomEvent("geoleaf:map:ready")),o.info("Application pr\xeate \u2014 "+e)}document.addEventListener("geoleaf:theme:applied",function(){g("th\xe8me appliqu\xe9, couches charg\xe9es")},{once:1}),setTimeout(function(){g("timeout s\xe9curit\xe9 15s")},15e3),o.info("Application initialis\xe9e, chargement des couches en arri\xe8re-plan\u2026")}}(window)),bt||(bt=1,function(e){const GeoLeaf=e.GeoLeaf=e.GeoLeaf||{},t=GeoLeaf._app=GeoLeaf._app||{};t.startApp=function(){const e=t.AppLog;if(!GeoLeaf)return void e.error("GeoLeaf global introuvable. Le bundle core doit \xeatre charg\xe9 avant GeoLeaf.boot().");if("function"!=typeof GeoLeaf.loadConfig)return void e.error("GeoLeaf.loadConfig() est introuvable. V\xe9rifiez que le bundle core est complet.");e.info("D\xe9marrage de l'application...");let o=null;try{o=sessionStorage.getItem("gl-selected-profile"),o&&(e.log("Profil s\xe9lectionn\xe9 depuis sessionStorage:",o),sessionStorage.removeItem("gl-selected-profile"))}catch(t){e.warn("Impossible de lire sessionStorage:",t)}const n=t.getProfilesBasePath();GeoLeaf.loadConfig({url:n+"geoleaf.config.json",profileId:o,autoEvent:1,onLoaded:function(o){if(e.log("Configuration charg\xe9e via GeoLeaf.loadConfig :",o||{}),GeoLeaf.Config&&"function"==typeof GeoLeaf.Config.getCategories)try{GeoLeaf.Config.getCategories()}catch(t){e.warn("Erreur lors de la lecture du mapping cat\xe9gories :",t)}const n=o||{};GeoLeaf.Config&&"function"==typeof GeoLeaf.Config.loadActiveProfileResources?GeoLeaf.Config.loadActiveProfileResources().then(function(o){e.info("Ressources du profil actif charg\xe9es."),t.initApp(o||n)}).catch(function(o){e.warn("Erreur lors du chargement des ressources de profil :",o),t.initApp(n)}):t.initApp(n)},onError:function(t){e.error("Erreur chargement config via GeoLeaf.loadConfig :",t)}})},GeoLeaf.boot=function(){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",t.startApp):t.startApp()}}(window));var vt="undefined"!=typeof window?window.GeoLeaf:{};e.default=vt,Object.defineProperty(e,"__esModule",{value:1})});//# sourceMappingURL=geoleaf.min.js.map
